angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/jingdong-accounts",{controller:"JdAccountController",templateUrl:"app/src/app/jingdong/account/account.html"})}]);
angular.module("IOne-Production").controller("JdAccountController",function($scope,$q,JdAccountService,$mdDialog,Constant,$timeout,Upload){$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value,release:Constant.RELEASE[0].value};$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.menuDisplayOption={"401-confirm":{display:true,name:"审核",uuid:"D8D7F4CB-FEFA-4058-8C6D-2B963EEE0CAB"},
"402-confirmRevert":{display:true,name:"取消审核",uuid:"71A76BDD-5228-4195-ADCD-49E002CFA050"},"403-status":{display:true,name:"启用",uuid:"00E6B823-61D4-48C7-BACD-E9F873BE03CD"},"404-statusRevert":{display:true,name:"取消启用",uuid:"76410D25-995F-4E35-930C-66A1647411D7"},"405-delete":{display:true,name:"删除",uuid:"F689543A-1187-47E6-9793-6EF930C1EF4A"},"406-query":{display:true,name:"查询",uuid:"589FDC07-6890-4C9A-AD6B-BFB4890C61C6"},"411-confirmAll":{display:true,name:"批量审核",uuid:"52A72E73-6B3E-484C-925B-60ADF9AF62E3"},
"412-confirmRevertAll":{display:true,name:"批量取消审核",uuid:"27441051-7289-4BF2-8DF0-61FB7F650DCC"},"413-statusAll":{display:true,name:"批量启用",uuid:"58A509E5-BBBF-4986-A500-D30A102FD631"},"414-statusRevertAll":{display:true,name:"批量取消启用",uuid:"915D42A0-418E-4C0E-8797-0F1316D19CA0"},"415-deleteAll":{display:true,name:"批量删除",uuid:"5DBE6F45-5BFD-44A1-832C-AEC40C138480"},"416-import":{display:true,name:"批量导入",uuid:"5DBE6F45-5BFD-44A1-832C-AEC40C138480"}};$scope.refreshList=function(){JdAccountService.getAll($scope.pageOption.sizePerPage,
$scope.pageOption.currentPage,$scope.listFilterOption.confirm,$scope.listFilterOption.status,$scope.theMax,$scope.RES_UUID_MAP.EPS.JINGDONG_ACCOUNTS.RES_UUID).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;$scope.resetButtonDisabled();$scope.selectAllFlag=false;$scope.selected=[]})};$scope.getMenuAuthData($scope.RES_UUID_MAP.EPS.JINGDONG_ACCOUNTS.RES_UUID).success(function(data){$scope.menuAuthDataMap=
$scope.menuDataMap(data)});$scope.$watch("listFilterOption",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.selectAllFlag=false;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;item.detailList=$scope.subItemList;$scope.changeButtonStatusSingle(item)};$scope.returnToListAction=function(event,item){$scope.stopEventPropagation(event);$scope.selectedItem=null;$scope.changeButtonStatusAll()};
$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;$scope.selectedItem=null};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel)item.detailList=item};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS)};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);
$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.status=="add"){if($scope.domain=="EPS_JD_ACCOUNT")JdAccountService.add($scope.source).success(function(data){$scope.showInfo("新增数据成功。")}).error(function(){$scope.showError("新增失败。")})}else if($scope.status==
"edit")if($scope.domain=="EPS_JD_ACCOUNT")JdAccountService.modify($scope.source.uuid,$scope.source).success(function(data){$scope.showInfo("修改数据成功。")}).error(function(){$scope.showError("修改失败。")})};$scope.confirmClickAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认审核吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};JdAccountService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.selectedItem.confirm=
Constant.CONFIRM[2].value;$scope.changeButtonStatusSingle($scope.selectedItem);$scope.showInfo("修改数据成功。")}).error(function(response){$scope.showError(response.message)})})};$scope.confirmRevertClickAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认取消审核吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};JdAccountService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.selectedItem.confirm=Constant.CONFIRM[1].value;
$scope.changeButtonStatusSingle($scope.selectedItem);$scope.showInfo("修改数据成功。")}).error(function(response){$scope.showError(response.message)})})};$scope.confirmSwitchAction=function(event,item){$scope.stopEventPropagation(event);if(item.confirm==2)$scope.showConfirm("确认取消审核吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};JdAccountService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.changeButtonStatusAll();$scope.showInfo("修改数据成功。")}).error(function(response){$scope.showError(response.message)})},
function(){item.confirm=Constant.CONFIRM[2].value});else if(item.confirm==1)$scope.showConfirm("确认审核吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};JdAccountService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.changeButtonStatusAll();$scope.showInfo("修改数据成功。")}).error(function(response){$scope.showError(response.message)})},function(){item.confirm=Constant.CONFIRM[1].value})};$scope.statusClickAction=function(event,item){$scope.stopEventPropagation(event);
$scope.showConfirm("确认修改启用状态为有效吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};JdAccountService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.selectedItem.status=Constant.STATUS[1].value;$scope.changeButtonStatusSingle($scope.selectedItem);$scope.showInfo("修改数据成功。")}).error(function(response){$scope.showError(response.message)})})};$scope.statusRevertClickAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认修改启用状态为无效吗？",
"",function(){var EmployeeUpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value};JdAccountService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.selectedItem.status=Constant.STATUS[2].value;$scope.changeButtonStatusSingle($scope.selectedItem);$scope.showInfo("修改数据成功。")}).error(function(response){$scope.showError(response.message)})})};$scope.statusSwithAction=function(event,item){$scope.stopEventPropagation(event);if(item.status==2)$scope.showConfirm("确认修改启用状态为有效吗？",
"",function(){var EmployeeUpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};JdAccountService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.changeButtonStatusAll();$scope.showInfo("修改数据成功。")}).error(function(response){$scope.showError(response.message)})},function(){item.status=Constant.STATUS[2].value});else if(item.status==1)$scope.showConfirm("确认修改启用状态为无效吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value};JdAccountService.modify(EmployeeUpdateInput.uuid,
EmployeeUpdateInput).success(function(){$scope.changeButtonStatusAll();$scope.showInfo("修改数据成功。")}).error(function(response){$scope.showError(response.message)})},function(){item.status=Constant.STATUS[1].value})};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){JdAccountService.delete(item.uuid).success(function(){$scope.selectedItem=null;$scope.refreshList();$scope.showInfo("删除数据成功。")})})};$scope.confirmAllClickAction=
function(event){$scope.stopEventPropagation(event);if($scope.selected.length>0)$scope.showConfirm("确认批量审核吗？","",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(item){var EmployeeUpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};var response=JdAccountService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.refreshList()})}})};
$scope.confirmRevertAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selected.length>0)$scope.showConfirm("确认批量取消审核吗？","",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(item){var EmployeeUpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};var response=JdAccountService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");
$scope.refreshList()})}})};$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selected.length>0)$scope.showConfirm("确认批量修改启用状态为有效吗？","",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(item){var EmployeeUpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};var response=JdAccountService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");
$scope.refreshList()})}})};$scope.statusRevertAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selected.length>0)$scope.showConfirm("确认批量修改启用状态为无效吗？","",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(item){var EmployeeUpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value};var response=JdAccountService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");
$scope.refreshList()})}})};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selected.length>0)$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(item){var response=JdAccountService.delete(item.uuid).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("删除数据成功。");$scope.refreshList()})}})};$scope.selectAllAction=function(){if($scope.selectAllFlag==
true)angular.forEach($scope.itemList,function(item){var idx=$scope.selected.indexOf(item);if(idx<0)$scope.selected.push(item)});else if($scope.selectAllFlag==false)$scope.selected=[];$scope.selectItemCount=$scope.selected.length;$scope.changeButtonStatusAll()};$scope.selectItemAction=function(event,item,selected){$scope.stopEventPropagation(event);var idx=selected.indexOf(item);if(idx>-1)selected.splice(idx,1);else selected.push(item);$scope.selectItemCount=$scope.selected.length;$scope.changeButtonStatusAll()};
$scope.exists=function(item,selected){return selected.indexOf(item)>-1};$scope.selected=[];$scope.resetButtonDisabled=function(){$scope.confirmClick=0;$scope.confirmRevertClick=0;$scope.statusClick=0;$scope.statusRevertClick=0;$scope.deleteClick=0};$scope.resetButtonDisabledAll=function(){$scope.deleteAllClick=0;$scope.statusRevertAllClick=0;$scope.statusAllClick=0;$scope.confirmRevertAllClick=0;$scope.confirmAllClick=0};$scope.changeButtonStatusAll=function(){$scope.resetButtonDisabledAll();angular.forEach($scope.selected,
function(employee){$scope.processChangeButtonStatusAll(employee)})};$scope.changeButtonStatusSingle=function(employee){$scope.resetButtonDisabled();$scope.processChangeButtonStatus(employee)};$scope.processChangeButtonStatus=function(employee){if(employee.confirm==1||employee.item==4)$scope.confirmRevertClick=1;if(employee.confirm==2||employee.item==3){$scope.confirmClick=1;$scope.statusRevertClick=1}if(employee.status==1)$scope.statusClick=1;if(employee.status==2){$scope.statusRevertClick=1;$scope.confirmClick=
1}};$scope.processChangeButtonStatusAll=function(employee){if(employee.confirm==1||employee.item==4)$scope.confirmRevertAllClick=1;if(employee.confirm==2||employee.item==3){$scope.confirmAllClick=1;$scope.statusRevertAllClick=1}if(employee.status==1)$scope.statusAllClick=1;if(employee.status==2){$scope.statusRevertAllClick=1;$scope.confirmAllClick=1}};$scope.showUserRoles=function(user){if(user.baseUser==undefined)UserService.getUser(user.uuid,3).success(function(data){user.baseUser=data.content[0];
UserRoleService.get(user.baseUser.uuid).success(function(data){user.userRoleList=data})})};$scope.addUserRole=function(){$mdDialog.show({controller:"RoleListController",templateUrl:"app/src/app/auth/user/addRoleDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{}}).then(function(data){UserRoleService.add($scope.selectedItem.user.uuid,data.selectedRole.uuid).success(function(data){$scope.selectedItem.user.userRoleList=$scope.selectedItem.user.userRoleList||[];$scope.selectedItem.user.userRoleList.push(data)}).error(function(){$scope.showError("新增角色失败，该角色可能已存在。")})})};
$scope.deleteUserRole=function(userRole){UserRoleService.delete(userRole.uuid).success(function(){$scope.selectedItem.user.userRoleList.splice($scope.selectedItem.user.userRoleList.indexOf(userRole),1)})};$scope.getEmployeeImageFullPath=function(path,sex){if(path==null||path==undefined)if(sex==1)return Constant.BACKEND_BASE+"/app/img/male.png";else if(sex==2)return Constant.BACKEND_BASE+"/app/img/female.png";else return Constant.BACKEND_BASE+"/app/img/unknown.png";if(path&&path.indexOf("IMAGE")==
0)return Constant.BACKEND_BASE+"/app/assets/"+path;else return Constant.BACKEND_BASE+"/app/assets/IMAGE/"+path};$scope.uploadImage=function(files){$scope.progress={value:0};if(files&&files.length)for(var i=0;i<files.length;i++){var file=files[i];Upload.upload({url:Constant.BACKEND_BASE+"/files",fields:{},file:file}).progress(function(evt){$scope.progress.value=Math.min(100,parseInt(99*evt.loaded/evt.total))}).success(function(data){$timeout(function(){if($scope.selectedItem&&$scope.selectedItem.uuid)JdAccountService.addImage($scope.selectedItem.uuid,
data.uuid).success(function(response){$scope.showInfo("上传成功");$scope.selectedItem.employeeImg=$scope.getEmployeeImageFullPath(response.picPath,response.sex)+"?time\x3d"+(new Date).getTime()})})})}};$scope.upload=function(files){$scope.progress={value:0};if(files&&files.length)for(var i=0;i<files.length;i++){var file=files[i];Upload.upload({url:Constant.BACKEND_BASE+"/files",fields:{},file:file}).progress(function(evt){$scope.progress.value=Math.min(100,parseInt(99*evt.loaded/evt.total))}).success(function(data){$timeout(function(){JdAccountService.importFile(data.uuid).success(function(response){$scope.showInfo("导入成功")}).error(function(data){$scope.showError("导入失败。"+
data.message)})})})}}});
angular.module("IOne-Production").service("JdAccountService",function($http,Constant){this.getAll=function(sizePerPage,page,confirm,status,theMax,resUuid){confirm=confirm==0?"":confirm;status=status==0?"":status;var url="/jdAccounts?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26confirm\x3d"+confirm+"\x26status\x3d"+status;if(theMax!==undefined&&theMax!==null)url=url+"\x26globalQuery\x3d"+theMax;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)};
this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+"/jdAccounts/"+uuid)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/jdAccounts/"+uuid)};this.modify=function(uuid,UpdateInput){return $http.patch(Constant.BACKEND_BASE+"/jdAccounts/"+uuid,UpdateInput)};this.add=function(Input){return $http.post(Constant.BACKEND_BASE+"/jdAccounts/",Input)};this.importFile=function(fileName){return $http.post(Constant.BACKEND_BASE+"/jdAccounts/"+"files/"+fileName+"/")}});
angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/eps/alipay",{controller:"AliPayController",templateUrl:"app/src/app/taobao_data/alipay/alipay.html"})}]);
angular.module("IOne-Production").controller("AliPayController",function($scope,AliPayService,Constant,$mdDialog){$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.TAOBAO_STATUS=Constant.TAOBAO_STATUS;$scope.listFilterOption={orderStatus:Constant.TAOBAO_STATUS[0].value,confirm:Constant.CONFIRM[0].value};$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.refreshList=function(){AliPayService.getAll($scope.pageOption.sizePerPage,
$scope.pageOption.currentPage,$scope.listFilterOption).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;$scope.disableBatchMenuButtons()})};$scope.$watch("listFilterOption",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.selectAllFlag=false;$scope.selectedItemSize=0;$scope.selectedItemAmount=0;$scope.showDetailPanelAction=
function(item){$scope.selectedItem=item;$scope.displayAdvancedSearPanel=false};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel);};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS)};$scope.hideItemDetailsAction=
function(event){$scope.stopEventPropagation(event);$scope.selectedItem=null;$scope.refreshList()};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=
function(){if($scope.status=="add")if($scope.domain=="PSO_ORDER_MST")console.info("add order mst...");else{if($scope.domain=="PSO_ORDER_DTL")console.info("add order dtl...")}else if($scope.status=="edit")if($scope.domain=="PSO_ORDER_MST")console.info("edit order mst...");else if($scope.domain=="PSO_ORDER_DTL")console.info("edit order dtl...")};$scope.deleteDetailAction=function(detail){};$scope.selectItemAction=function(event,item){$scope.stopEventPropagation(event);item.selectedRef=!item.selected;
if(item.selected==false||item.selected==undefined||item.selected==null){$scope.selectedItemSize+=1;if(item.totalAmount!=null)$scope.selectedItemAmount+=item.totalAmount}else{$scope.selectedItemSize-=1;if(item.totalAmount!=null)$scope.selectedItemAmount-=item.totalAmount;$scope.selectAllFlag=false}$scope.disableBatchMenuButtons()};$scope.confirmClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("confirm...");if(item.confirm==Constant.CONFIRM[2].value){$scope.showError("已成功审核并抛转的支付宝账款单不能再次审核，支付宝账款单号："+
item.tid);return false}$scope.showConfirm("确认审核吗？","",function(){AliPayService.confirm(item.uuid).success(function(response){var failItemsTid="";var success=false;angular.forEach(response,function(succeedItem){if(succeedItem.uuid==item.uuid)success=true});if(success===true)item.confirm=Constant.CONFIRM[2].value;else failItemsTid+=item.tid+", ";if(failItemsTid==="")$scope.showInfo("支付宝账款单审核成功！");else $scope.showError("如下支付宝账款单审核失败："+failItemsTid.substr(0,failItemsTid.length-2));$scope.disableBatchMenuButtons()}).error(function(response){$scope.showError(response.message)})})};
$scope.cancelConfirmClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("confirm...");$scope.showConfirm("确认取消审核吗？","",function(){AliPayService.cancelConfirm(item.uuid).success(function(data){item.confirm=Constant.CONFIRM[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("支付宝账款单取消审核成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.statusClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("status...")};
$scope.releaseClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("release...")};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("delete...")};$scope.confirmAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("confirm all...");var uuids="";var count=0;var failUuids="";angular.forEach($scope.itemList,function(item){if(item.selected===true){uuids+=item.uuid+",";count++;if(item.confirm==Constant.CONFIRM[2].value)failUuids+=
item.orderId+", "}});if(count===0){$scope.showError("没有选择任何支付宝账款单，请先选择支付宝账款单！");return}if(failUuids!==""){$scope.showError("已成功审核的支付宝账款单不能再次审核，支付宝账款单号："+failUuids.substring(0,failUuids.length-2));return false}$scope.showConfirm("确认审核吗？","",function(){AliPayService.confirm(uuids).success(function(response){var failItemsTid="";angular.forEach($scope.itemList,function(item){if(item.selected===true){var success=false;angular.forEach(response,function(succeedItem){if(succeedItem.uuid==item.uuid)success=
true});if(success===true)item.confirm=Constant.CONFIRM[2].value;else failItemsTid+=item.tid+", "}});if(failItemsTid==="")$scope.showInfo("支付宝账款单审核成功！");else $scope.showError("如下支付宝账款单审核失败："+failItemsTid.substr(0,failItemsTid.length-2));$scope.disableBatchMenuButtons()}).error(function(response){$scope.showError(response.message)})})};$scope.cancelConfirmAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("cancel confirm all...");var uuids="";var count=0;var failUuids="";
angular.forEach($scope.itemList,function(item){if(item.selected===true){uuids+=item.uuid+",";count++}});if(count===0){$scope.showError("没有选择任何支付宝账款单，请先选择支付宝账款单！");return}$scope.showConfirm("确认取消审核吗？","",function(){AliPayService.cancelConfirm(uuids).success(function(data){angular.forEach(data,function(canceledItem){angular.forEach($scope.itemList,function(item){if(item.uuid==canceledItem.uuid)item.confirm=Constant.CONFIRM[1].value})});$scope.disableBatchMenuButtons();$scope.showInfo("支付宝账款单取消审核成功！")}).error(function(response){$scope.showError(response.message)})})};
$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("status all...")};$scope.releaseAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("release all...")};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("delete all...")};$scope.selectAllAction=function(){angular.forEach($scope.itemList,function(item){if($scope.selectAllFlag)item.selected=true;else item.selected=false;item.selectedRef=item.selected});
$scope.selectedItemSize=0;$scope.selectedItemAmount=0;if($scope.selectAllFlag)angular.forEach($scope.itemList,function(item){$scope.selectedItemSize++;if(item.totalAmount!=null)$scope.selectedItemAmount+=item.totalAmount});$scope.disableBatchMenuButtons()};$scope.disableBatchMenuButtons=function(){var selectedCount=0;var confirm="";var diffConfirm=false;angular.forEach($scope.itemList,function(item,index){if(item.selectedRef){selectedCount++;if(confirm=="")confirm=item.confirm;else if(confirm!=item.confirm)diffConfirm=
true}});if(selectedCount==0){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true}else if(diffConfirm==true){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true}else if(confirm=="2"){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=false}else{$scope.disabledBatchConfirm=false;$scope.disabledBatchCancelConfirm=true}}});
angular.module("IOne-Production").service("AliPayService",function($http,Constant){this.getAll=function(sizePerPage,page,filter){var confirm=filter.confirm==0?"":filter.confirm;var orderStatus=filter.orderStatus==0?"":filter.orderStatus;var url="aliPays?size\x3d"+sizePerPage+"\x26page\x3d"+page;if(confirm!=="")url=url+"\x26confirm\x3d"+confirm;if(orderStatus!=="")url=url+"\x26orderStatus\x3d"+orderStatus;if(filter.tid!=null)url=url+"\x26tid\x3d"+filter.tid;if(filter.startModifiedTime!=null){var startModifiedTime=
new Date(filter.startModifiedTime);startModifiedTime=moment(startModifiedTime).format("YYYY-MM-DD 00:00:00");url=url+"\x26startModifiedTime\x3d"+startModifiedTime}if(filter.endModifiedTime!=null){var endModifiedTime=new Date(filter.endModifiedTime);endModifiedTime=moment(endModifiedTime).format("YYYY-MM-DD 23:59:59");url=url+"\x26endModifiedTime\x3d"+endModifiedTime}console.info(Constant.BACKEND_BASE+url);return $http.get(Constant.BACKEND_BASE+url)};this.confirm=function(uuids){return $http.post(Constant.BACKEND_BASE+
"/aliPays/"+uuids+"?confirm\x3dtrue",{})};this.cancelConfirm=function(uuids){return $http.post(Constant.BACKEND_BASE+"/aliPays/"+uuids+"?cancelConfirm\x3dtrue",{})}});
(function(){angular.module("angular-flexslider",[]).directive("flexSlider",["$parse","$timeout",function($parse,$timeout){return{restrict:"AE",scope:false,replace:true,transclude:true,template:'\x3cdiv class\x3d"flexslider-container"\x3e\x3c/div\x3e',compile:function(element,attr,linker){return function($scope,$element){var addSlide,collectionString,flexsliderDiv,getTrackFromItem,indexString,match,removeSlide,slidesItems,trackBy;match=(attr.slide||attr.flexSlide).match(/^\s*(.+)\s+in\s+(.*?)(?:\s+track\s+by\s+(.+?))?\s*$/);
indexString=match[1];collectionString=match[2];trackBy=angular.isDefined(match[3])?$parse(match[3]):$parse(""+indexString);flexsliderDiv=null;slidesItems={};getTrackFromItem=function(collectionItem,index){var locals;locals={};locals[indexString]=collectionItem;locals["$index"]=index;return trackBy($scope,locals)};addSlide=function(collectionItem,index,callback){var childScope,track;track=getTrackFromItem(collectionItem,index);if(slidesItems[track]!=null)throw"Duplicates in a repeater are not allowed. Use 'track by' expression to specify unique keys.";
childScope=$scope.$new();childScope[indexString]=collectionItem;childScope["$index"]=index;return linker(childScope,function(clone){var slideItem;slideItem={collectionItem:collectionItem,childScope:childScope,element:clone};slidesItems[track]=slideItem;return typeof callback==="function"?callback(slideItem):void 0})};removeSlide=function(collectionItem,index){var slideItem,track;track=getTrackFromItem(collectionItem,index);slideItem=slidesItems[track];if(slideItem==null)return;delete slidesItems[track];
slideItem.childScope.$destroy();return slideItem};return $scope.$watchCollection(collectionString,function(collection,oldCollection){var attrKey,attrVal,c,currentSlidesLength,e,i,idx,n,options,slider,slides,t,toAdd,toRemove,trackCollection,_i,_j,_k,_l,_len,_len1,_len2,_len3;if(!(collection!=null?collection.length:void 0)&&!(oldCollection!=null?oldCollection.length:void 0))return;if(flexsliderDiv!=null){slider=flexsliderDiv.data("flexslider");currentSlidesLength=Object.keys(slidesItems).length;if(collection==
null)collection=[];trackCollection={};for(i=_i=0,_len=collection.length;_i<_len;i=++_i){c=collection[i];trackCollection[getTrackFromItem(c,i)]=c}toAdd=function(){var _j,_len1,_results;_results=[];for(i=_j=0,_len1=collection.length;_j<_len1;i=++_j){c=collection[i];if(slidesItems[getTrackFromItem(c,i)]==null)_results.push({value:c,index:i})}return _results}();toRemove=function(){var _results;_results=[];for(t in slidesItems){i=slidesItems[t];if(trackCollection[t]==null)_results.push(i.collectionItem)}return _results}();
if(toAdd.length===1&&toRemove.length===0||toAdd.length===0){for(_j=0,_len1=toRemove.length;_j<_len1;_j++){e=toRemove[_j];e=removeSlide(e,collection.indexOf(e));slider.removeSlide(e.element)}for(_k=0,_len2=toAdd.length;_k<_len2;_k++){e=toAdd[_k];idx=e.index;addSlide(e.value,idx,function(item){if(idx===currentSlidesLength)idx=void 0;return $scope.$evalAsync(function(){return slider.addSlide(item.element,idx)})})}return}}slidesItems={};if(flexsliderDiv!=null)flexsliderDiv.remove();slides=angular.element('\x3cul class\x3d"slides"\x3e\x3c/ul\x3e');
flexsliderDiv=angular.element('\x3cdiv class\x3d"flexslider"\x3e\x3c/div\x3e');flexsliderDiv.append(slides);$element.append(flexsliderDiv);for(i=_l=0,_len3=collection.length;_l<_len3;i=++_l){c=collection[i];addSlide(c,i,function(item){return slides.append(item.element)})}options={};for(attrKey in attr){attrVal=attr[attrKey];if(attrKey.indexOf("$")===0)continue;if(!isNaN(n=parseInt(attrVal))){options[attrKey]=n;continue}if(attrVal==="false"||attrVal==="true"){options[attrKey]=attrVal==="true";continue}if(attrKey===
"start"||attrKey==="before"||attrKey==="after"||attrKey==="end"||attrKey==="added"||attrKey==="removed"){options[attrKey]=function(attrVal){var f;f=$parse(attrVal);return function(slider){return $scope.$apply(function(){return f($scope,{"$slider":{element:slider}})})}}(attrVal);continue}if(attrKey==="startAt"){options[attrKey]=$parse(attrVal)($scope);continue}options[attrKey]=attrVal}if(!options.sliderId&&attr.id)options.sliderId=""+attr.id+"-slider";if(options.sliderId)flexsliderDiv.attr("id",options.sliderId);
return $timeout(function(){return flexsliderDiv.flexslider(options)},0)})}}}}])}).call(this);angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/api-config",{controller:"ApiConfigController",templateUrl:"app/src/app/taobao_data/api_config/apiConfig.html"})}]);
angular.module("IOne-Production").controller("ApiConfigController",function($scope,Constant,$mdDialog,$timeout){$scope.listTabSelected=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS,0)}});angular.module("IOne",["ngRoute","ngResource","ngMaterial","ngCookies","IOne-directives","IOne-Production","IOne-Constant","ngFileUpload","IOne-Auth","ui.tree","ngMdIcons","ngMessages"]);
toastr.options={"closeButton":true,"debug":false,"newestOnTop":false,"progressBar":false,"positionClass":"toast-bottom-right","preventDuplicates":false,"onclick":null,"showDuration":"300","hideDuration":"1000","timeOut":"5000","extendedTimeOut":"1000","showEasing":"swing","hideEasing":"linear","showMethod":"fadeIn","hideMethod":"fadeOut"};
angular.module("IOne").config(function($mdThemingProvider,$mdIconProvider){$mdThemingProvider.theme("default").primaryPalette("grey");$mdThemingProvider.theme("docs-dark","default").dark();$mdIconProvider.iconSet("social","../bower_components/angular-materialimg/demos/icon/demoSvgIconSets/assets/social-icons.svg",24).defaultIconSet("../bower_components/angular-material/demos/icon/demoSvgIconSets/assets/core-icons.svg",24)});
angular.module("IOne").factory("AuthInterceptor",function($rootScope,$q,$cookieStore){return{request:function(config){$rootScope.globals=$cookieStore.get("globals")||{};if($rootScope.globals.currentUser||config.url=="/auth/login"||config.url=="/auth/logout")return config;else return $q.reject("Unauthorized access.")},responseError:function(error){if(error.status===401||error.status===403)$rootScope.$broadcast("IONE_LOGOUT_EVENT");return $q.reject(error)}}});
angular.module("IOne").config(["$httpProvider",function($httpProvider){$httpProvider.interceptors.push("AuthInterceptor")}]);angular.module("IOne").run(function($rootScope,$cookieStore,$window,$http){$rootScope.globals=$cookieStore.get("globals")||{};$rootScope.autoLogin=$cookieStore.get("autoLogin")||0;if($rootScope.globals.currentUser)$http.defaults.headers.common["Authorization"]="Basic "+$rootScope.globals.currentUser.authdata;else $window.location.href="/login"});
angular.module("IOne").controller("MainController",function($rootScope,$scope,$mdUtil,$mdSidenav,$location,$timeout,$cookieStore,Constant,$mdToast,$mdDialog,$window,AuthenticationService,MenuService,ResService,OrderMaster,SalesOrderMaster,UserService,PsoOrderChangeMaster,SalesOrderChangeMaster,PsoOrderReturnMaster,PSOReturnSalesOrdersMasterService,Receipts,Receipt2s){$scope.currentUser=$scope.globals.currentUser.username;$scope.displayName=$cookieStore.get("displayName");$scope.displayType=$cookieStore.get("displayType");
$scope.menuAction=function(mainMenu,menu){$scope.path(menu.link);$scope.selectedMenuId=menu.id;$scope.selectedMainMenu=mainMenu;$scope.selectedMenu=menu;$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS,0)};$scope.menuList=Constant.MENU_LIST;$scope.selectedMenuId=$location.path();if($(window).innerWidth()<=960){$scope.lockMenuFlag=false;$mdSidenav("leftMenu").close()}else $scope.lockMenuFlag=true;$scope.lockMenu=function(lock){if($(window).innerWidth()<=960){$scope.lockMenuFlag=false;$mdSidenav("leftMenu").toggle()}else $scope.lockMenuFlag=
lock};$scope.path=function(url){$location.path(url)};$scope.showInfo=function(info){toastr["success"](info)};$scope.showError=function(info){toastr["error"](info)};$scope.showWarn=function(info){toastr["warning"](info)};$scope.showConfirm=function(title,content,success_fn,fail_fn){var confirm=$mdDialog.confirm().parent(angular.element(document.body)).title(title).content(content).ok("确认").cancel("取消");$mdDialog.show(confirm).then(success_fn,fail_fn)};$scope.DEFAULT_IMAGE_PATH=Constant.BACKEND_BASE+
"/app/img/item.jpeg";$scope.getImageFullPath=function(path){if(path==null)return $scope.DEFAULT_IMAGE_PATH;if(path&&path.indexOf("IMAGE")==0)return Constant.BACKEND_BASE+"/app/assets/"+path;else return Constant.BACKEND_BASE+"/app/assets/IMAGE/"+path};$scope.isDefaultImage=function(path){if(path==$scope.DEFAULT_IMAGE_PATH)return true;else return false};$scope.logout=function(){AuthenticationService.Logout().success(function(){$window.location.href="/login"})};$rootScope.$on("IONE_LOGOUT_EVENT",function(){});
$scope.UI_STATUS=Constant.UI_STATUS;$scope.ui_status=$scope.UI_STATUS.VIEW_UI_STATUS;$scope.selectedTabIndex=0;$scope.selectedSubTab={index:0};$scope.listTabName="清单";$scope.formTabName="表单(预览模式)";$scope.changeViewStatus=function(status,index){$scope.ui_status=status;$scope.selectedTabIndex=index;if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS||$scope.ui_status==Constant.UI_STATUS.EDIT_UI_STATUS_DELETE||$scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS){$scope.formTabName="表单(预览模式)";
$scope.isEditing=false}else if($scope.ui_status==Constant.UI_STATUS.EDIT_UI_STATUS_ADD||$scope.ui_status==Constant.UI_STATUS.EDIT_UI_STATUS_COPY||$scope.ui_status==Constant.UI_STATUS.EDIT_UI_STATUS_MODIFY){$scope.formTabName="表单(编辑模式)";$scope.isEditing=true}};$scope.changeSubTabIndexs=function(index){$scope.selectedSubTab.index=index};$scope.STATUS=Constant.STATUS;$scope.CONFIRM=Constant.CONFIRM;$scope.RELEASE=Constant.RELEASE;$scope.PROD_TYPE=Constant.PROD_TYPE;$scope.STOP_PRODUCTION=Constant.STOP_PRODUCTION;
$scope.AUDIT=Constant.AUDIT;$scope.DELIVERY_MODE=Constant.DELIVERY_MODE;$scope.TRANSFER_PSO_FLAG=Constant.TRANSFER_PSO_FLAG;$scope.TRANSFER_FLAG=Constant.TRANSFER_FLAG;$scope.CUSTOMIZE_FLAG=Constant.CUSTOMIZE_FLAG;$scope.SALE_TYPE=Constant.SALE_TYPE;$scope.USER_TYPE=Constant.USER_TYPE;$scope.FUNCTION_TYPE=Constant.FUNCTION_TYPE;$scope.ROLE_TYPE=Constant.ROLE_TYPE;$scope.SELLER_FLAG=Constant.SELLER_FLAG;$scope.TAOBAO_STATUS=Constant.TAOBAO_STATUS;$scope.REFUND_STATUS=Constant.REFUND_STATUS;$scope.NUM_IID=
Constant.NUM_IID;$scope.ORDER_FLAG=Constant.ORDER_FLAG;$scope.RETURN_FLAG=Constant.RETURN_FLAG;$scope.GENDER_FLAG=Constant.GENDER_FLAG;$scope.PAY_PARTY=Constant.PAY_PARTY;$scope.EMPLOYEE_STATUS=Constant.EMPLOYEE_STATUS;$scope.PAID_TYPE=Constant.PAID_TYPE;$scope.PERFORM_FLAG=Constant.PERFORM_FLAG;$scope.PAY_TYPE=Constant.PAY_TYPE;$scope.APPORTION_TYPE=Constant.APPORTION_TYPE;$scope.CHANNEL_FLAG=Constant.CHANNEL_FLAG;$scope.MALL_FLAG=Constant.MALL_FLAG;$scope.ORDER_CHANGE_FLAG=Constant.ORDER_CHANGE_FLAG;
$scope.PURCHASE_TYPE=Constant.PURCHASE_TYPE;$scope.CARD_TYPE=Constant.CARD_TYPE;$scope.COST_TYPE=Constant.COST_TYPE;$scope.SUPPLY_TYPE=Constant.SUPPLY_TYPE;$scope.ITEM_CUSTOM_TYPE=Constant.ITEM_CUSTOM_TYPE;$scope.ITEM_CUSTOM_STYLE=Constant.ITEM_CUSTOM_STYLE;$scope.ITEM_CUSTOM_ASTRICT=Constant.ITEM_CUSTOM_ASTRICT;$scope.ITEM_CUSTOM_APP_DISPLAY=Constant.ITEM_CUSTOM_APP_DISPLAY;$scope.ITEM_CUSTOM_APP_CHOOSE=Constant.ITEM_CUSTOM_APP_CHOOSE;$scope.ITEM_CUSTOM_CUSTOM_FLAG=Constant.ITEM_CUSTOM_CUSTOM_FLAG;
$scope.REFERENCE_FLAG=Constant.REFERENCE_FLAG;$scope.getError=function(response){if(response&&response.content)return response.content;else return""};$scope.getAllError=function(response){if(response&&response.content&&response.content.fieldErrors){var result=[];if(response.content.fieldErrors)angular.forEach(response.content.fieldErrors,function(error){result.push(error.field+": "+error.message+"; ")});if(response.content.globalErrors)angular.forEach(response.content.globalErrors,function(error){result.push(error.message)});
return result}else return""};$scope.isNotValid=function(data){if(data==null||data==undefined)return true;return false};$scope.isValid=function(data){return!$scope.isNotValid(data)};$scope.RES_UUID_MAP=RES_UUID_MAP;$scope.INVALID_VALUE=Constant.INVALID_VALUE;$scope.getMenuAuthData=function(sysResUuid){return MenuService.getAll("","","",sysResUuid,true)};$scope.menuAuthDataMap={};$scope.menuDataMap=function(menuDataList){var map={};angular.forEach(menuDataList,function(value,index){map[value.sysMenu.uuid]=
value});return map};ResService.getAll("","",true).success(function(data){$scope.resDataMap={};angular.forEach(data,function(value,index){$scope.resDataMap[value.sysRes.uuid]=value})});$scope.isAdmin=function(){return $scope.currentUser=="admin"};OrderMaster.getOrderMasterCount(Constant.AUDIT[1].value,Constant.STATUS[1].value,Constant.TRANSFER_PSO_FLAG[2].value,RES_UUID_MAP.PSO.ORDER.LIST_PAGE.RES_UUID).success(function(data){$scope.menuList[1].subList[1].suffix=data});SalesOrderMaster.getOrderMasterCount(Constant.AUDIT[1].value,
Constant.STATUS[1].value,Constant.TRANSFER_PSO_FLAG[2].value,RES_UUID_MAP.PSO.SO.LIST_PAGE.RES_UUID).success(function(data){$scope.menuList[1].subList[2].suffix=data});PsoOrderChangeMaster.getOrderMasterCount(Constant.CONFIRM[1].value,Constant.STATUS[1].value,Constant.TRANSFER_PSO_FLAG[2].value,RES_UUID_MAP.PSO.ORDER_CHANGE.RES_UUID).success(function(data){$scope.menuList[1].subList[4].suffix=data});SalesOrderChangeMaster.getOrderMasterCount(Constant.CONFIRM[1].value,Constant.STATUS[1].value,Constant.TRANSFER_PSO_FLAG[2].value,
RES_UUID_MAP.PSO.SO_CHANGE.RES_UUID).success(function(data){$scope.menuList[1].subList[6].suffix=data});PsoOrderReturnMaster.getReturnOrderMasterCount(Constant.CONFIRM[1].value,Constant.STATUS[1].value,Constant.TRANSFER_PSO_FLAG[2].value,RES_UUID_MAP.PSO.ORDER_RETURN.RES_UUID).success(function(data){$scope.menuList[1].subList[7].suffix=data});PSOReturnSalesOrdersMasterService.getReturnOrderMasterCount(Constant.AUDIT[1].value,Constant.STATUS[1].value,Constant.TRANSFER_PSO_FLAG[2].value,RES_UUID_MAP.PSO.SO_RETURN.RES_UUID).success(function(data){$scope.menuList[1].subList[8].suffix=
data});Receipts.getReceiptOrderMasterCount(Constant.CONFIRM[1].value,RES_UUID_MAP.PSO.ORDER_RECEIPT.RES_UUID).success(function(data){$scope.menuList[1].subList[9].suffix=data});Receipt2s.getReceiptOrderMasterCount(Constant.CONFIRM[1].value,RES_UUID_MAP.PSO.SO_RECEIPT.RES_UUID).success(function(data){$scope.menuList[1].subList[10].suffix=data});$scope.stopEventPropagation=function(event){event.stopPropagation()};$scope.changeCurrentUserPw=function(){$mdDialog.show({controller:"ChangeCurrentUserPwController",
templateUrl:"app/src/app/auth/user/changePassword.html",parent:angular.element(document.body),targetEvent:event}).then(function(data){$scope.userPassword=data;UserService.modifyPassword($scope.userPassword).success(function(){$scope.showInfo("修改密码成功。")}).error(function(data){$scope.showError(data.message)})})}});angular.module("IOne").controller("HeaderController",function($scope){});angular.module("IOne").controller("FooterController",function($scope){});angular.module("IOne-Test",["ngMaterial"]);
angular.module("IOne-Test").controller("RuleSQLController",function($http,$scope){$scope.search=function(){$http.get("/rules/sql/"+$scope.ruleUUID).success(function(data){$scope.sqlList=data})};$scope.run=function(){$http.get("/rules/run/",{params:{ruleUuid:$scope.ruleUUID,uuid:$scope.mainUUID,insertOrUpdate:!$scope.insertOrUpdate}}).success(function(data){$scope.sqlList=data})};$scope.runSql=function(sql){$http.get("/rules/data/",{params:{sql:sql}}).success(function(data){$scope.data=data;if(data.length>
0)$scope.keys=Object.keys($scope.data[0])})}});
angular.module("IOne").controller("ChangeCurrentUserPwController",function($scope,$mdDialog){$scope.user=null;$scope.hideDlg=function(){if($scope.user==null)toastr["error"]("请输入原始密码以及新密码");else if($scope.user.password==null)toastr["error"]("原始密码为空");else if($scope.user.newPassword==null)toastr["error"]("新密码为空");else if($scope.user.newPassword==$scope.user.newPasswordConfirm)$mdDialog.hide($scope.user);else toastr["error"]("新密码不一致")};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/cbi/area",{controller:"AreaController",templateUrl:"app/src/app/cbi/area/area.html"})}]);
angular.module("IOne-Production").controller("AreaController",function($scope,Area,Constant,$mdDialog){$scope.editNodeDisabled=false;$scope.saveNodeDisabled=true;$scope.cancelModifyDisabled=true;$scope.quitDisabled=true;$scope.formMenuDisplayOption={"102-edit":{display:true,name:"编辑",uuid:"D7C5647E-6604-41563-8CC2-DF5B3EAB5F70"},"302-save":{display:true,name:"保存",uuid:"56F359CF-3FR4-5T4D-B321-D45816621291"},"303-cancel":{display:true,name:"取消修改",uuid:"4B958029-E637-4B22-B30F-94AAE55EA680"},"304-quit":{display:true,
name:"退出编辑",uuid:"D7BAA884-3F9C-4165-BF58-C22C2C69259A"}};$scope.initData=function(){$scope.headers=[{"grade":1,"name":"1级"},{"grade":2,"name":"2级"},{"grade":3,"name":"3级"},{"grade":4,"name":"4级"},{"grade":5,"name":"5级"},{"grade":6,"name":"6级"}];$scope.selectedTemplateData={}};$scope.initData();$scope.nodeDataClickHandler=function(selectedGrade,selectedItem){angular.forEach($scope.selectedTemplateData[selectedGrade],function(node){node.selected=false});selectedItem.selected=true;$scope.selectedItem=
selectedItem;$scope.backupSelectedItem=$scope.backup($scope.selectedItem);$scope.clearChildren(selectedItem);Area.getForParent(selectedItem.uuid).success(function(data){if(data&&data.content&&data.content.length>0)$scope.selectedTemplateData[selectedGrade+1]=data.content;$scope.isRefreshing=false}).error(function(){$scope.isRefreshing=false});$scope.refreshAddNodeButtonDisplay()};$scope.refreshTemplateData=function(template,node){if(template&&template.length>0){var dataHandler=function(template,node,
data){var content=$scope.selectedTemplateData[template.uuid];if(content==undefined||content==null){content=[data];$scope.selectedTemplateData[template.uuid]=content}};Area.getForGrade(node.grade).success(function(data){dataHandler(template,node,data.content)})}};$scope.refreshAllTemplate=function(){Area.getForGrade($scope.headers[0].grade).success(function(data){var setFirstOpen=false;if(data&&data.content){$scope.selectedTemplateData[$scope.headers[0].grade]=data.content;$scope.refreshAddNodeButtonDisplay()}});
$scope.selectedItem=null};$scope.refreshAllTemplate();$scope.backup=function(area){return{uuid:area.uuid,no:area.no,name:area.name,grade:area.grade,parentUuid:area.parentUuid,fullPath:area.fullPath}};$scope.changeToEditMode=function(){$scope.backupSelectedItem=$scope.backup($scope.selectedItem);$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS,0)};$scope.quitEditMode=function(){$scope.showConfirm("修改尚未保存，确认退出编辑吗？","",function(){$scope.selectedItem=$scope.backupSelectedItem;$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS,
0)})};$scope.cancelModification=function(){$scope.selectedItem=$scope.backupSelectedItem};$scope.updateNodeData=function(){$scope.showConfirm("确认修改该节点数据吗？","",function(){if($scope.selectedItem)Area.modify($scope.selectedItem).success(function(){$scope.showInfo("修改节点数据成功。");$scope.backupSelectedItem=$scope.backup($scope.selectedItem)}).error(function(){$scope.showError("修改节点数据失败: ");$scope.selectedItem.no=$scope.backupSelectedItem.no;$scope.selectedItem.name=$scope.backupSelectedItem.name})})};$scope.refreshAddNodeButtonDisplay=
function(){angular.forEach($scope.headers,function(header){var showAddButton=$scope.selectedTemplateData[header.grade-1]!=null&&$scope.selectedTemplateData[header.grade-1].length>0||header.grade==1;if($scope.selectedTemplateData[header.grade-1]!=null)angular.forEach($scope.selectedTemplateData[header.grade-1],function(node){if(node.selected)showAddButton=true});header.showAddButton=showAddButton})};$scope.addNodeData=function(grade){var parentUuid=null;var parentNodes=$scope.selectedTemplateData[grade-
1];angular.forEach(parentNodes,function(parentNode){if(parentNode.selected)parentUuid=parentNode.uuid});$mdDialog.show({controller:"DialogController",templateUrl:"app/src/app/cbi/area/addArea.html",parent:angular.element(document.body),targetEvent:event}).then(function(data){var areaInput={no:data.no,name:data.name,grade:grade,parentUuid:parentUuid};Area.add(areaInput).success(function(data){data.selected=true;if($scope.selectedTemplateData[grade]==null)$scope.selectedTemplateData[grade]=[data];else $scope.selectedTemplateData[grade].push(data);
var addItem;angular.forEach($scope.selectedTemplateData[grade],function(v){if(v.uuid==data.uuid)addItem=v});if(addItem!=null)$scope.nodeDataClickHandler(grade,addItem);$scope.showInfo("新增数据成功。")}).error(function(response){$scope.showError("新增数据失败: "+response.message)})})};$scope.deleteNodeData=function($event,item){$scope.showConfirm("确认清除该节点数据吗？","节点数据删除后不可恢复。",function(){Area.delete(item.uuid).success(function(){var indexToDelete=-1;angular.forEach($scope.selectedTemplateData[item.grade],function(v,
index){if(v.uuid==item.uuid)indexToDelete=index});$scope.selectedTemplateData[item.grade].splice(indexToDelete,1);if(item.selected)$scope.clearChildren(item);$scope.showInfo("删除节点数据成功。")}).error(function(response){$scope.showError("删除节点数据失败: "+response.message)})});$event.stopPropagation();$event.preventDefault()};$scope.clearChildren=function(item){for(var i=Number(item.grade)+1;i<=$scope.headers[$scope.headers.length-1].grade;i++)if($scope.selectedTemplateData[i]!=null)$scope.selectedTemplateData[i].splice(0)}});
angular.module("IOne-Production").service("Area",function($http,Constant){this.getAll=function(){return $http.get(Constant.BACKEND_BASE+"/areas")};this.getForParent=function(parentUuid){return $http.get(Constant.BACKEND_BASE+"/areas?parentUuid\x3d"+parentUuid)};this.getForGrade=function(grade){var url="/areas?grade\x3d"+grade;return $http.get(Constant.BACKEND_BASE+url)};this.add=function(areaInput){return $http.post(Constant.BACKEND_BASE+"/areas",areaInput)};this.modify=function(areaInput){return $http.patch(Constant.BACKEND_BASE+
"/areas/"+areaInput.uuid,areaInput)};this.delete=function(areaUuid){return $http.delete(Constant.BACKEND_BASE+"/areas/"+areaUuid)}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/ass/assform",{controller:"AssFormController",templateUrl:"app/src/app/ass/assform/assform.html"})}]);
angular.module("IOne-Production").controller("AssFormController",function($scope,AssFormMasterService,AssFormDetailService,AssFormFlowService,OCMSupplierService,ChannelService,RoleService,CBIEmployeeService,GroupFunctionService,FunctionService,WorkflowService,Constant,$mdDialog,$q,$timeout,Upload){$scope.ASSFORM_SERVICE_TYPE=Constant.ASSFORM_SERVICE_TYPE;$scope.WORKFLOW_TRANSFER_TYPE=Constant.WORKFLOW_TRANSFER_TYPE;$scope.selected=[];$scope.detailSelected=[];$scope.pageOption={sizePerPage:10,currentPage:0,
totalPage:100,totalElements:100};$scope.formMenuDisplayOption={"100-add":{display:true,name:"新增",uuid:"36880486-CE68-40CC-8DFA-357E366301AA"},"101-save":{display:true,name:"保存",uuid:"32B78CF6-4E7F-4741-B52F-607B50FF4745"},"102-edit":{display:true,name:"修改",uuid:"D9EB9ED1-E3CB-4DC1-9538-DE1A70AB0C36"},"103-delete":{display:true,name:"删除",uuid:"CDC8E10B-DE05-4965-993C-81981924477B"},"104-batchDelete":{display:true,name:"批量删除",uuid:"E5B9CC3A-D7DB-4CC5-9F39-49374B4BF87E"},"105-subBatchDelete":{display:true,
name:"批量删除",uuid:"8DC65F11-7B9B-44DE-B51B-5DDB53ACA735"}};$scope.listFilterOption={status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value,release:Constant.RELEASE[0].value};$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()}};$scope.refreshList=function(){AssFormMasterService.getAll($scope.pageOption.sizePerPage,
$scope.pageOption.currentPage,$scope.listFilterOption,"","","","","","","").success(function(data){$scope.assFormMstList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements})};$scope.$watch("listFilterOption",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.refreshDetailList=function(item){AssFormDetailService.get(item.uuid).success(function(data){item.detailList=
data.content})};$scope.refreshFlowDetailList=function(item){AssFormFlowService.get(item.uuid).success(function(data){item.flowDetailList=data.content;angular.forEach(item.flowDetailList,function(item){if(item.transferRole!=""&&item.transferRole!=null)RoleService.get(item.transferRole).success(function(role){item.transferRoleName=role.name});if(item.transferSource=="1")FunctionService.get(item.transferData).success(function(tran){item.transferDataName=tran.name});else if(item.transferSource=="2")ChannelService.get(item.transferData).success(function(tran){item.transferDataName=
tran.name});else if(item.transferSource=="3")CBIEmployeeService.get(item.transferData).success(function(tran){item.transferDataName=tran.name});if(item.currentEmplUuid!=null)CBIEmployeeService.get(item.currentEmplUuid).success(function(data){item.currentEmplName=data.name});if(item.currentEmplUuid!=null&&item.flowStatus=="1"&&item.confirm!="2")item.bgColor={"background-color":"#76EEC6"};else item.bgColor={"background-color":"lightgray"}});if(item.flowDetailList.length>0)if(item.flowDetailList[0].confirm==
"2")item.isProgress=true;$scope.currentStage=""})};$scope.selectAllFlag=false;$scope.selectDetailAllFlag=false;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;$scope.selectedItem.salesOrderMasterNo=$scope.selectedItem.salesOrderMaster.no;$scope.selectedItem.salesOrderMasterUuid=$scope.selectedItem.salesOrderMaster.uuid;$scope.selectedItem.logisticsServiceProviderUuid=$scope.selectedItem.logisticsServiceProvider;$scope.selectedItem.installationServiceProviderUuid=$scope.selectedItem.installationServiceProvider;
if($scope.selectedItem.logisticsServiceProvider!=""&&$scope.selectedItem.logisticsServiceProvider!=null)OCMSupplierService.get($scope.selectedItem.logisticsServiceProvider,"2").success(function(data){if(data.totalElements>0)$scope.selectedItem.logisticsServiceProviderName=data.content[0].name});if($scope.selectedItem.installationServiceProvider!=""&&$scope.selectedItem.installationServiceProvider!=null)OCMSupplierService.get($scope.selectedItem.installationServiceProvider,"3").success(function(data){if(data.totalElements>
0)$scope.selectedItem.installationServiceProviderName=data.content[0].name});$scope.refreshDetailList(item);$scope.refreshFlowDetailList(item);$scope.showPictureImage(item)};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;$scope.selectedItem=null};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel){$scope.refreshDetailList(item);$scope.refreshFlowDetailList(item)}};$scope.toggleDetailMorePanelAction=
function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=function(){if($scope.ui_status==Constant.UI_STATUS.EDIT_UI_STATUS_ADD)$scope.selectedItem=null;$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS)};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain;$scope.selectedItemPics=[];$scope.showPictureImage($scope.selectedItem)};
$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.selectedItem={salesOrderMasterUuid:"",serviceType:"",logisticsServiceProvider:"",installationServiceProvider:"",refundAmount:"",description:""};$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain;$scope.pics=[];$scope.selectedItemPics=[];$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_ADD)};$scope.saveItemAction=function(){if($scope.status=="add")WorkflowService.getByCurrentUser().success(function(result){if(result.totalElements>
0)AssFormMasterService.add($scope.selectedItem).success(function(data){$scope.showInfo("新增数据成功。");$scope.refreshList()}).error(function(){$scope.showError("新增失败。")});else $scope.showError("该用户无工作流可使用!")});else if($scope.status=="edit")AssFormMasterService.modify($scope.selectedItem.uuid,$scope.selectedItem).success(function(data){$scope.showInfo("修改数据成功。");$scope.refreshList()}).error(function(){$scope.showError("修改失败。")})};$scope.deleteDetailAction=function(detail){$scope.showConfirm("确认删除吗？","删除后不可恢复。",
function(){AssFormDetailService.delete($scope.selectedItem.uuid,detail.uuid).success(function(){$scope.refreshDetailList($scope.selectedItem);$scope.showInfo("删除数据成功。")})})};$scope.deleteDetailAllAction=function(detailSelected){var promises=[];$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){angular.forEach(detailSelected,function(item){var response=AssFormDetailService.delete(item.assForm.uuid,item.uuid).success(function(){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("删除数据成功。");
$scope.refreshDetailList($scope.selectedItem);$scope.detailSelected=[]})})};$scope.selectItemAction=function(event,item,selected){$scope.stopEventPropagation(event);var idx=$scope.selected.indexOf(item);if(idx>-1)$scope.selected.splice(idx,1);else $scope.selected.push(item);$scope.selectItemCount=$scope.selected.length};$scope.confirmClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("confirm...")};$scope.statusClickAction=function(event,item){$scope.stopEventPropagation(event);
console.info("status...")};$scope.releaseClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("release...")};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);if($scope.selectedItem.flowDetailList.length>0)if($scope.selectedItem.flowDetailList[0].confirm=="2"){$scope.showError("流程己审批，无法删除!");return}$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){AssFormMasterService.delete(item.uuid).success(function(){$scope.selectedItem=null;$scope.refreshList();
$scope.showInfo("删除数据成功。")})})};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);var mainProcess=[];if($scope.selected.length>0){var errorInfo=[];angular.forEach($scope.selected,function(item){var response=AssFormFlowService.get(item.uuid).success(function(data){item.flowDetailList=data.content;if(item.flowDetailList.length>0)if(item.flowDetailList[0].confirm=="2"){$scope.showError("预订单号："+item.flowDetailList[0].assForm.salesOrderMaster.no+"流程己审批，无法删除!");errorInfo.push("error")}});
mainProcess.push(response)});$q.all(mainProcess).then(function(){if(errorInfo.length==0)$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(item){var response=AssFormMasterService.delete(item.uuid).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("删除数据成功。");$scope.refreshList();$scope.selectItemCount=0;$scope.selected=[]})}})})}};$scope.selectAllAction=function(){console.log($scope.selectAllFlag);
if($scope.selectAllFlag==true)angular.forEach($scope.assFormMstList,function(item){var idx=$scope.selected.indexOf(item);if(idx<0)$scope.selected.push(item)});else if($scope.selectAllFlag==false)$scope.selected=[];$scope.selectItemCount=$scope.selected.length};$scope.exists=function(item,selected){return selected.indexOf(item)>-1};$scope.selectDetailItemAction=function(event,item,detailSelected){$scope.stopEventPropagation(event);var idx=detailSelected.indexOf(item);if(idx>-1)detailSelected.splice(idx,
1);else detailSelected.push(item);$scope.selectDetailItemCount=$scope.detailSelected.length};$scope.selectDetailAllAction=function(){if($scope.selectDetailAllFlag==true)angular.forEach($scope.selectedItem.detailList,function(item){var idx=$scope.detailSelected.indexOf(item);if(idx<0)$scope.detailSelected.push(item)});else if($scope.selectDetailAllFlag==false)$scope.detailSelected=[];$scope.selectDetailItemCount=$scope.detailSelected.length};$scope.getSupplierName=function(field,uuid,salesType){OCMSupplierService.get(uuid).success(function(data){if(data.totalElements>
0)field=data.content[0].name})};$scope.currentSmallImageIndex={value:0};$scope.uploadImage=function(files,type){$scope.progress={value:0};if(files&&files.length)for(var i=0;i<files.length;i++){var file=files[i];Upload.upload({url:Constant.BACKEND_BASE+"/files",fields:{},file:file}).progress(function(evt){$scope.progress.value=Math.min(100,parseInt(99*evt.loaded/evt.total))}).success(function(data){$timeout(function(){if($scope.selectedItem&&$scope.selectedItem.uuid)AssFormMasterService.addImage($scope.selectedItem.uuid,
data.uuid).success(function(response){$scope.showPictureImage(response)})})})}};$scope.deleteItemImage=function(){AssFormMasterService.deleteImage($scope.selectedItem.uuid,$scope.pics[$scope.currentSmallImageIndex.value]).success(function(data){$scope.showPictureImage(data)})};$scope.showPictureImage=function(item){$scope.pics=[];$scope.selectedItemPics=[];for(var i=1;i<=5;i++)if(item["picture"+i]!=""&&item["picture"+i]!=null){$scope.pics.push("picture"+i);$scope.selectedItemPics.push($scope.getImageFullPath(item["picture"+
i]))}$scope.selectedItem=item};$scope.getImageFullPath=function(path){return Constant.BACKEND_BASE+"/app/assets/IMAGE/"+path};$scope.openDlg=function(table,title){var source=[];source.table=table;source.title=title;$mdDialog.show({controller:"AssFormSelectController",templateUrl:"app/src/app/ass/assform/assformSelectList.html",parent:angular.element(document.body),targetEvent:event,locals:{source:source}}).then(function(data){if(table=="LOGISTICS_SERVICE_PROVIDER"){$scope.selectedItem["logisticsServiceProviderName"]=
data.name;$scope.selectedItem.logisticsServiceProvider=data.uuid}else if(table=="INSTALLATION_SERVICE_PROVIDER"){$scope.selectedItem["installationServiceProviderName"]=data.name;$scope.selectedItem["installationServiceProvider"]=data.uuid}else if(table=="PSO_SO_MST"){$scope.selectedItem["salesOrderMasterNo"]=data.no;$scope.selectedItem["salesOrderMasterUuid"]=data.uuid}})}});
angular.module("IOne-Production").controller("AssFormSelectController",function($scope,$http,SalesOrderMaster,OCMSupplierService,$mdDialog,Constant,source){$scope.datasource=source.table;$scope.title=source.title;$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.refreshData=function(no){if($scope.datasource=="PSO_SO_MST")SalesOrderMaster.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,"2","","1",no,"","","","","","","","","","","").success(function(data){if(data.content){$scope.dataList=
data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements}else $scope.dataList=data});else if($scope.datasource=="LOGISTICS_SERVICE_PROVIDER")OCMSupplierService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,"","","","","2","","").success(function(data){if(data.content){$scope.dataList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements}else $scope.dataList=data});else if($scope.datasource==
"INSTALLATION_SERVICE_PROVIDER")OCMSupplierService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,"","","","","3").success(function(data){if(data.content){$scope.dataList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements}else $scope.dataList=data})};$scope.refreshData();$scope.queryAction=function(no){$scope.refreshData(no)};$scope.select=function(selectedObject){$scope.selectedObject=selectedObject;$mdDialog.hide($scope.selectedObject)};
$scope.hideDlg=function(){$mdDialog.hide()};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").service("AssFormMasterService",function($http,Constant){this.getAll=function(sizePerPage,page,filter){var confirm=filter.confirm==0?"":filter.confirm;var status=filter.status==0?"":filter.status;var no=filter.no==0?"":filter.no;var url="assForms?size\x3d"+sizePerPage+"\x26page\x3d"+page;if(no!=""&&no!=undefined)url=url+"\x26salesOrderMasterNo\x3d"+no;return $http.get(Constant.BACKEND_BASE+url)};this.confirm=function(uuids){return $http.patch(Constant.BACKEND_BASE+
"/assForms/"+uuids,{"action":"2","confirm":"2"})};this.modify=function(uuid,updateInput){return $http.patch(Constant.BACKEND_BASE+"/assForms/"+uuid,updateInput)};this.add=function(addInput){console.log(addInput);return $http.post(Constant.BACKEND_BASE+"/assForms",addInput)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/assForms/"+uuid)};this.addImage=function(uuid,imageUuid){return $http.post(Constant.BACKEND_BASE+"/assForms/"+uuid+"/images",{pictureUuid:imageUuid})};this.deleteImage=
function(uuid,picture){return $http.delete(Constant.BACKEND_BASE+"/assForms/"+uuid+"/images?pictureNo\x3d"+picture)}});
angular.module("IOne-Production").service("AssFormDetailService",function($http,Constant){this.getAll=function(sizePerPage,page,filter){var confirm=filter.confirm==0?"":filter.confirm;var status=filter.status==0?"":filter.status;var transferFlag=filter.transferFlag==0?"":filter.transferFlag;var url="assForms/{assFormUuid}/details?size\x3d"+sizePerPage+"\x26page\x3d"+page;console.info(Constant.BACKEND_BASE+url);return $http.get(Constant.BACKEND_BASE+url)};this.get=function(masterUuid){var url="assForms/"+
masterUuid+"/details";return $http.get(Constant.BACKEND_BASE+url)};this.delete=function(materUuid,uuid){return $http.delete(Constant.BACKEND_BASE+"/assForms/"+materUuid+"/details/"+uuid)}});
angular.module("IOne-Production").service("AssFormFlowService",function($http,Constant){this.getAll=function(sizePerPage,page,isShowCurrentEmpl,flowStatus,filter){var confirm=filter.confirm==0?"":filter.confirm;var status=filter.status==0?"":filter.status;var no=filter.no;var url="/assFormFlows?size\x3d"+sizePerPage+"\x26page\x3d"+page;if(no!=undefined&&no!="")url=url+"\x26salesOrderMasterNo\x3d"+no;if(isShowCurrentEmpl!="")url=url+"\x26isShowCurrentEmpl\x3dY";if(flowStatus!="")url=url+"\x26flowStatus\x3d"+
flowStatus;console.info(Constant.BACKEND_BASE+url);return $http.get(Constant.BACKEND_BASE+url)};this.get=function(assFormUuid){var url="/assFormFlows";if(assFormUuid!=="")url=url+"?assFormUuid\x3d"+assFormUuid;url=url+"\x26sort\x3dflwo";return $http.get(Constant.BACKEND_BASE+url)};this.modify=function(uuid,updateInput){return $http.patch(Constant.BACKEND_BASE+"/assFormFlows/"+uuid,updateInput)}});
angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/ass/assformFlow",{controller:"AssFormFlowController",templateUrl:"app/src/app/ass/assformFlow/assformFlow.html"})}]);
angular.module("IOne-Production").controller("AssFormFlowController",function($scope,AssFormFlowService,AssFormDetailService,OCMSupplierService,Constant,$mdDialog){$scope.ASSFORM_SERVICE_TYPE=Constant.ASSFORM_SERVICE_TYPE;$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value,release:Constant.RELEASE[0].value};$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=
""};$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()}};$scope.refreshList=function(){AssFormFlowService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,"Y","1",$scope.listFilterOption).success(function(data){$scope.assFormFlowList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements})};$scope.$watch("listFilterOption",
function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.refreshDetailList=function(item){AssFormDetailService.get(item.assForm.uuid).success(function(data){item.detailList=data.content})};$scope.showPictureImage=function(item){$scope.pics=[];$scope.selectedItemPics=[];for(var i=1;i<=5;i++)if(item.assForm["picture"+i]!=""&&item.assForm["picture"+i]!=null){$scope.pics.push("picture"+i);$scope.selectedItemPics.push($scope.getImageFullPath(item.assForm["picture"+
i]))}};$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;if($scope.selectedItem.assForm.logisticsServiceProvider!=""&&$scope.selectedItem.assForm.logisticsServiceProvider!=null)OCMSupplierService.get($scope.selectedItem.assForm.logisticsServiceProvider,"2").success(function(data){if(data.totalElements>0)$scope.selectedItem.assForm.logisticsServiceProviderName=data.content[0].name});if($scope.selectedItem.assForm.installationServiceProvider!=""&&$scope.selectedItem.assForm.installationServiceProvider!=
null)OCMSupplierService.get($scope.selectedItem.assForm.installationServiceProvider,"3").success(function(data){if(data.totalElements>0)$scope.selectedItem.assForm.installationServiceProviderName=data.content[0].name});$scope.refreshDetailList(item);$scope.showPictureImage(item)};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;$scope.selectedItem=null};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel)$scope.refreshDetailList(item)};
$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS)};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.status=="add");else if($scope.status=="edit");};$scope.deleteDetailAction=function(detail){};
$scope.selectItemAction=function(event,item){$scope.stopEventPropagation(event)};$scope.confirmClickAction=function(event,item){$scope.stopEventPropagation(event);var source=[];$mdDialog.show({controller:"AssFormFlowConfirmController",templateUrl:"app/src/app/ass/assformFlow/assformFlowConfirm.html",parent:angular.element(document.body),targetEvent:event,locals:{source:source}}).then(function(data){console.log(data);if(data.action=="cancel")item.confirm="1";else if(data.action=="save"){item.confirm=
"2";item.flowStatus="2";item.followUpContent=data.followUpContent;AssFormFlowService.modify(item.uuid,item).success(function(data){if(item.transferType=="1")$scope.showInfo("审批成功!");else $scope.showInfo("結案成功!");$scope.refreshList()}).error(function(){$scope.showError("审批失败。")})}})};$scope.statusClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("status...")};$scope.releaseClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("release...")};
$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("delete...")};$scope.confirmAllClickAction=function(event){};$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("status all...")};$scope.releaseAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("release all...")};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("delete all...")};$scope.selectAllAction=
function(){angular.forEach($scope.itemList,function(item){if($scope.selectAllFlag)item.selected=true;else item.selected=false})}});angular.module("IOne-Production").controller("AssFormFlowConfirmController",function($scope,$http,SalesOrderMaster,OCMSupplierService,$mdDialog,Constant,source){$scope.hideDlg=function(action){var data={followUpContent:$scope.followUpContent,action:action};console.log(data);$mdDialog.hide(data)};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").service("DataBanService",function(Constant,$http){this.getAll=function(type,ctrlSourceUuid,cptUuid){if(type==undefined)type=3;if(ctrlSourceUuid==undefined)ctrlSourceUuid="";if(cptUuid==undefined)cptUuid="";return $http.get(Constant.BACKEND_BASE+"/dataBans?type\x3d"+type+"\x26ctrlSourceUuid\x3d"+ctrlSourceUuid+"\x26sysCptUuid\x3d"+cptUuid)};this.getAllValues=function(type,uuid,sysCptUuid,sysResUuid){if(type==undefined)type=0;if(uuid==undefined)uuid="";if(sysCptUuid==
undefined)sysCptUuid="";if(sysResUuid==undefined)sysResUuid="";return $http.get(Constant.BACKEND_BASE+"/dataBans/data?type\x3d"+type+"\x26uuid\x3d"+uuid+"\x26sysCptUuid\x3d"+sysCptUuid+"\x26sysResUuid\x3d"+sysResUuid)};this.add=function(type,ctrlSourceUuid,value,sysCptUuid){return $http.post(Constant.BACKEND_BASE+"/dataBans",{type:type,ctrlSourceUuid:ctrlSourceUuid,no:Math.random().toString(36).substring(10),valueUuid:value,sysCptUuid:sysCptUuid})};this.delete=function(uuid,type,ctrlSourceUuid,value,
sysCptUuid){if(uuid)return $http.delete(Constant.BACKEND_BASE+"/dataBans/"+uuid);else return $http.delete(Constant.BACKEND_BASE+"/dataBans?type\x3d"+type+"\x26ctrlSourceUuid\x3d"+ctrlSourceUuid+"\x26value\x3d"+value+"\x26sysCptUuid\x3d"+sysCptUuid)}});
angular.module("IOne-Production").service("DataPermitService",function(Constant,$http){this.getAll=function(type,ctrlSourceUuid,cptUuid){if(type==undefined)type=3;if(ctrlSourceUuid==undefined)ctrlSourceUuid="";if(cptUuid==undefined)cptUuid="";return $http.get(Constant.BACKEND_BASE+"/dataPermits?type\x3d"+type+"\x26ctrlSourceUuid\x3d"+ctrlSourceUuid+"\x26sysCptUuid\x3d"+cptUuid)};this.getAllValues=function(type,uuid,sysCptUuid,sysResUuid){if(type==undefined)type=0;if(uuid==undefined)uuid="";if(sysCptUuid==
undefined)sysCptUuid="";if(sysResUuid==undefined)sysResUuid="";return $http.get(Constant.BACKEND_BASE+"/dataPermits/data?type\x3d"+type+"\x26uuid\x3d"+uuid+"\x26sysCptUuid\x3d"+sysCptUuid+"\x26sysResUuid\x3d"+sysResUuid)};this.add=function(type,ctrlSourceUuid,value,sysCptUuid){return $http.post(Constant.BACKEND_BASE+"/dataPermits",{type:type,ctrlSourceUuid:ctrlSourceUuid,no:Math.random().toString(36).substring(10),valueUuid:value,sysCptUuid:sysCptUuid})};this.delete=function(uuid,type,ctrlSourceUuid,
value,sysCptUuid){if(uuid)return $http.delete(Constant.BACKEND_BASE+"/dataPermits/"+uuid);else return $http.delete(Constant.BACKEND_BASE+"/dataPermits?type\x3d"+type+"\x26ctrlSourceUuid\x3d"+ctrlSourceUuid+"\x26value\x3d"+value+"\x26sysCptUuid\x3d"+sysCptUuid)}});
angular.module("IOne-Production").service("SysCptService",function(Constant,$http){this.getAll=function(sysResUuid){if(sysResUuid==undefined)sysResUuid="";return $http.get(Constant.BACKEND_BASE+"/sysCpts?sysResUuid\x3d"+sysResUuid)};this.getAllAvailableNames=function(){return $http.get(Constant.BACKEND_BASE+"/sysCpts/data")};this.add=function(name,value,sysResUuid,objectFlag){return $http.post(Constant.BACKEND_BASE+"/sysCpts",{no:Math.random().toString(36).substring(10),name:name,value:value,sysResUuid:sysResUuid,
objectFlag:objectFlag})};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/sysCpts/"+uuid)}});
angular.module("IOne-Production").service("CptService",function(Constant,$http){this.getAll=function(type,ctrlSourceUuid,sysCptUuid,sysResUuid){if(type==undefined)type=3;if(ctrlSourceUuid==undefined)ctrlSourceUuid="";if(sysCptUuid==undefined)sysCptUuid="";if(sysResUuid==undefined)sysResUuid="";return $http.get(Constant.BACKEND_BASE+"/cpts?type\x3d"+type+"\x26ctrlSourceUuid\x3d"+ctrlSourceUuid+"\x26sysCptUuid\x3d"+sysCptUuid+"\x26syResUuid\x3d"+sysResUuid)};this.add=function(type,ctrlSourceUuid,sysCptUuid,
displayFlag){return $http.post(Constant.BACKEND_BASE+"/cpts",{type:type,ctrlSourceUuid:ctrlSourceUuid,sysCptUuid:sysCptUuid,displayFlag:displayFlag})};this.modify=function(cpt){return $http.patch(Constant.BACKEND_BASE+"/cpts/"+cpt.uuid,cpt)};this.delete=function(cptUuid){return $http.delete(Constant.BACKEND_BASE+"/cpts/"+cptUuid)}});
angular.module("IOne-Production").service("SysMenusService",function(Constant,$http){this.getAll=function(sysResUuid){if(sysResUuid==undefined)sysResUuid="";return $http.get(Constant.BACKEND_BASE+"/sysMenus?sysResUuid\x3d"+sysResUuid)}});
angular.module("IOne-Production").service("MenuService",function(Constant,$http){this.getAll=function(type,ctrlSourceUuid,sysBaseMenuFileUuid,sysResUuid,includingAll){if(type==undefined)type=3;if(ctrlSourceUuid==undefined)ctrlSourceUuid="";if(sysBaseMenuFileUuid==undefined)sysBaseMenuFileUuid="";if(sysResUuid==undefined)sysResUuid="";if(includingAll==undefined)includingAll=false;return $http.get(Constant.BACKEND_BASE+"/menus?type\x3d"+type+"\x26ctrlSourceUuid\x3d"+ctrlSourceUuid+"\x26sysBaseMenuFileUuid\x3d"+
sysBaseMenuFileUuid+"\x26menuResUuid\x3d"+sysResUuid+"\x26allMenu\x3d"+includingAll)};this.add=function(type,ctrlSourceUuid,sysMenuUuid){return $http.post(Constant.BACKEND_BASE+"/menus",{type:type,ctrlSourceUuid:ctrlSourceUuid,sysBaseMenuFileUuid:sysMenuUuid})};this.delete=function(menuUuid){return $http.delete(Constant.BACKEND_BASE+"/menus/"+menuUuid)}});
angular.module("IOne-Production").service("ResService",function(Constant,$http){this.getAll=function(type,ctrlSourceUuid,includingAll){if(type==undefined)type=3;if(ctrlSourceUuid==undefined)ctrlSourceUuid="";if(includingAll==undefined)includingAll=false;return $http.get(Constant.BACKEND_BASE+"/ress?type\x3d"+type+"\x26ctrlSourceUuid\x3d"+ctrlSourceUuid+"\x26allRes\x3d"+includingAll)};this.add=function(type,ctrlSourceUuid,sysResUuid){return $http.post(Constant.BACKEND_BASE+"/ress",{type:type,ctrlSourceUuid:ctrlSourceUuid,
sysResUuid:sysResUuid})};this.delete=function(resUuid){return $http.delete(Constant.BACKEND_BASE+"/ress/"+resUuid)}});
angular.module("IOne-Production").service("UserService",function(Constant,$http){this.getAll=function(size,page,status,type,userUuid,keyword){if(status==undefined||status==0)status="";if(type==undefined)type="1";if(userUuid==undefined)userUuid="";if(keyword==undefined)keyword="";return $http.get(Constant.BACKEND_BASE+"/users?page\x3d"+page+"\x26size\x3d"+size+"\x26status\x3d"+status+"\x26userUuid\x3d"+userUuid+"\x26type\x3d"+type+"\x26keyword\x3d"+keyword)};this.getUser=function(userUuid,type){return $http.get(Constant.BACKEND_BASE+
"/users?status\x3d\x26userUuid\x3d"+userUuid+"\x26type\x3d"+type)};this.add=function(user){return $http.post(Constant.BACKEND_BASE+"/users",user)};this.modify=function(user){return $http.patch(Constant.BACKEND_BASE+"/users/"+user.uuid,user)};this.modifyPassword=function(userPassword){return $http.patch(Constant.BACKEND_BASE+"/users/resetPassword/",userPassword)};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+"/users/"+uuid)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+
"/users/"+uuid)}});
angular.module("IOne-Production").service("RoleService",function(Constant,$http){this.getAll=function(size,page,status,keyword){if(status==0||status==undefined)status="";if(keyword==undefined)keyword="";return $http.get(Constant.BACKEND_BASE+"/roles?page\x3d"+page+"\x26size\x3d"+size+"\x26status\x3d"+status+"\x26keyword\x3d"+keyword)};this.add=function(role){return $http.post(Constant.BACKEND_BASE+"/roles",role)};this.modify=function(role){return $http.patch(Constant.BACKEND_BASE+"/roles/"+role.uuid,
role)};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+"/roles/"+uuid)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/roles/"+uuid)}});
angular.module("IOne-Production").service("FunctionService",function(Constant,$http){this.getAll=function(size,page,status,keyword){if(status==0||status==undefined)status="";if(keyword==undefined)keyword="";return $http.get(Constant.BACKEND_BASE+"/functions?page\x3d"+page+"\x26size\x3d"+size+"\x26status\x3d"+status+"\x26keyword\x3d"+keyword)};this.add=function(func){return $http.post(Constant.BACKEND_BASE+"/functions",func)};this.modify=function(func){return $http.patch(Constant.BACKEND_BASE+"/functions/"+
func.uuid,func)};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+"/functions/"+uuid)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/functions/"+uuid)}});
angular.module("IOne-Production").service("GroupService",function(Constant,$http){this.getAll=function(size,page,status,keyword){if(status==0||status==undefined)status="";if(keyword==undefined)keyword="";return $http.get(Constant.BACKEND_BASE+"/groups?page\x3d"+page+"\x26size\x3d"+size+"\x26status\x3d"+status+"\x26keyword\x3d"+keyword)};this.add=function(group){return $http.post(Constant.BACKEND_BASE+"/groups",group)};this.modify=function(group){return $http.patch(Constant.BACKEND_BASE+"/groups/"+
group.uuid,group)};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+"/groups/"+uuid)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/groups/"+uuid)}});
angular.module("IOne-Production").service("UserRoleService",function(Constant,$http){this.get=function(userUuid,roleUuid){if(userUuid==undefined)userUuid="";if(roleUuid==undefined)roleUuid="";return $http.get(Constant.BACKEND_BASE+"/userRoles?userUuid\x3d"+userUuid+"\x26roleUuid\x3d"+roleUuid)};this.delete=function(userRoleUuid){return $http.delete(Constant.BACKEND_BASE+"/userRoles/"+userRoleUuid)};this.add=function(userUuid,roleUuid){return $http.post(Constant.BACKEND_BASE+"/userRoles",{userUuid:userUuid,
roleUuid:roleUuid})}});
angular.module("IOne-Production").service("FunctionRoleService",function(Constant,$http){this.get=function(roleUuid,functionUuid){if(functionUuid==undefined)functionUuid="";if(roleUuid==undefined)roleUuid="";return $http.get(Constant.BACKEND_BASE+"/functionRoles?roleUuid\x3d"+roleUuid+"\x26functionUuid\x3d"+functionUuid)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/functionRoles/"+uuid)};this.add=function(roleUuid,functionUuid){return $http.post(Constant.BACKEND_BASE+"/functionRoles",
{functionUuid:functionUuid,roleUuid:roleUuid})}});
angular.module("IOne-Production").service("GroupFunctionService",function(Constant,$http){this.get=function(functionfUuid,groupUuid){if(functionUuid==undefined)functionUuid="";if(groupUuid==undefined)groupUuid="";return $http.get(Constant.BACKEND_BASE+"/groupFunctions?groupUuid\x3d"+groupUuid+"\x26functionUuid\x3d"+functionUuid)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/groupFunctions/"+uuid)};this.add=function(functionUuid,groupUuid){return $http.post(Constant.BACKEND_BASE+
"/groupFunctions",{functionUuid:functionUuid,groupUuid:groupUuid})};this.getByStatus=function(){return $http.get(Constant.BACKEND_BASE+"/groupFunctions?status\x3d1\x26groupStatus\x3d1\x26functionStatus\x3d1")};this.getByUuid=function(uuid){return $http.get(Constant.BACKEND_BASE+"/groupFunctions/"+uuid)}});
angular.module("IOne-Production").service("GroupUserService",function(Constant,$http){this.promise=null;this.query=function(size,page,status,keyword){if(this.promise)return this.promise;if(status==undefined||status==0)status="";if(keyword==undefined)keyword="";var that=this;return this.promise=$http.get(Constant.BACKEND_BASE+"/groupUsers?page\x3d"+page+"\x26size\x3d"+size+"\x26status\x3d"+status+"\x26keyword\x3d"+keyword).success(function(){that.promise=null})};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+
"/groupUsers/"+uuid)};this.add=function(groupUser){return $http.post(Constant.BACKEND_BASE+"/groupUsers",groupUser)};this.modify=function(groupUser){return $http.patch(Constant.BACKEND_BASE+"/groupUsers/"+groupUser.uuid,groupUser)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/groupUsers/"+uuid)}});
angular.module("IOne-Auth").service("AuthenticationService",function(Base64,$http,$cookieStore,$rootScope){this.Login=function(username,password){return $http.post("/auth/login",{userName:username,password:password})};this.Logout=function(username,password){this.ClearCredentials();return $http.post("/auth/logout",{userName:username,password:password})};this.SetCredentials=function(username,password,loginResponse){var authdata=Base64.encode(username+":"+password);$rootScope.globals={currentUser:{username:username,
authdata:authdata}};$http.defaults.headers.common["Authorization"]="Basic "+authdata;$cookieStore.put("globals",$rootScope.globals);$cookieStore.put("displayName",loginResponse.userName);$cookieStore.put("displayType",loginResponse.type)};this.ClearCredentials=function(){$rootScope.globals={};$cookieStore.remove("globals");$cookieStore.remove("displayName");$cookieStore.remove("displayType");$http.defaults.headers.common.Authorization="Basic"}});
angular.module("IOne-Auth").service("Base64",function(){var keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/\x3d";this.encode=function(input){var output="";var chr1,chr2,chr3="";var enc1,enc2,enc3,enc4="";var i=0;do{chr1=input.charCodeAt(i++);chr2=input.charCodeAt(i++);chr3=input.charCodeAt(i++);enc1=chr1>>2;enc2=(chr1&3)<<4|chr2>>4;enc3=(chr2&15)<<2|chr3>>6;enc4=chr3&63;if(isNaN(chr2))enc3=enc4=64;else if(isNaN(chr3))enc4=64;output=output+keyStr.charAt(enc1)+keyStr.charAt(enc2)+
keyStr.charAt(enc3)+keyStr.charAt(enc4);chr1=chr2=chr3="";enc1=enc2=enc3=enc4=""}while(i<input.length);return output};this.decode=function(input){var output="";var chr1,chr2,chr3="";var enc1,enc2,enc3,enc4="";var i=0;var base64test=/[^A-Za-z0-9\+\/\=]/g;if(base64test.exec(input))window.alert("There were invalid base64 characters in the input text.\n"+"Valid base64 characters are A-Z, a-z, 0-9, '+', '/',and '\x3d'\n"+"Expect errors in decoding.");input=input.replace(/[^A-Za-z0-9\+\/\=]/g,"");do{enc1=
keyStr.indexOf(input.charAt(i++));enc2=keyStr.indexOf(input.charAt(i++));enc3=keyStr.indexOf(input.charAt(i++));enc4=keyStr.indexOf(input.charAt(i++));chr1=enc1<<2|enc2>>4;chr2=(enc2&15)<<4|enc3>>2;chr3=(enc3&3)<<6|enc4;output=output+String.fromCharCode(chr1);if(enc3!=64)output=output+String.fromCharCode(chr2);if(enc4!=64)output=output+String.fromCharCode(chr3);chr1=chr2=chr3="";enc1=enc2=enc3=enc4=""}while(i<input.length);return output}});
angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/fam/bank",{controller:"FAMBankConfigController",templateUrl:"app/src/app/fam/bank/bank.html"})}]);
angular.module("IOne-Production").controller("FAMBankConfigController",function($scope,FAMBankService,Constant,$mdDialog,$q){$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={select:{status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value},no:"",name:"",keyWord:""};$scope.menuDisplayOption={"switchConfirm":{display:true,name:"审核/取消审核",uuid:"146c53c8-c1aa-4797-92e1-1f2d72669c8e"},"switchStatus":{display:true,name:"启用/禁用",uuid:"eb389d3f-3e24-463f-8caf-0aca81a4613c"},
"batchConfirm":{display:true,name:"批量审核",uuid:"c74babb4-effd-4ab1-bde0-b288bcdefa33"},"batchRevertConfirm":{display:true,name:"批量取审",uuid:"2b5254f8-6d89-4645-b108-4dbc617a204c"},"batchStatus":{display:true,name:"批量启用",uuid:"32a38bbe-1a60-4232-99e0-40a872434989"},"batchRevertStatus":{display:true,name:"批量禁用",uuid:"a909235f-729d-456f-933a-1e5553c893a4"},"batchDelete":{display:true,name:"批量删除",uuid:"ece38745-577a-4b0f-b0dd-b35c8544bbfe"},"detailConfirm":{display:true,name:"审核",uuid:"11ab07d6-81a1-4591-b6b1-3a1c3b678367"},
"detailRevertConfirm":{display:true,name:"取审",uuid:"5dcae7eb-dd36-4eb4-b002-af65610b0ff1"},"detailStatus":{display:true,name:"启用",uuid:"e22ca984-0517-44be-8373-98650dc79b19"},"detailRevertStatus":{display:true,name:"禁用",uuid:"dacd23c4-0207-4b3b-83da-242712b6fd28"},"detailDelete":{display:true,name:"删除",uuid:"f8c196fb-98bc-4d1f-a534-ae0b53e10c6f"}};$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=
true;$scope.sortByField="no";$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.refreshList=function(){FAMBankService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.no,$scope.listFilterOption.name,$scope.listFilterOption.keyWord,$scope.RES_UUID_MAP.CBI.BANK.RES_UUID).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;$scope.selectAllFlag=
false;$scope.selectedItemSize=0})};$scope.getMenuAuthData($scope.RES_UUID_MAP.CBI.BANK.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)});$scope.$watch("listFilterOption.select",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()}};
$scope.selectAllFlag=false;$scope.selectedItemSize=0;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;item.detailList=$scope.subItemList;$scope.displayAdvancedSearPanel=false};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;$scope.selectedItem=null};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel)item.detailList=item};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=
!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);$scope.refreshList()};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status=
"add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.status=="add"){if($scope.domain=="FAM_BASE_BANK")FAMBankService.add($scope.source).success(function(data){$scope.showInfo("新增数据成功。")}).error(function(data){$scope.showError("新增失败:"+"\x3cbr\x3e"+data.message)})}else if($scope.status=="edit")if($scope.domain=="FAM_BASE_BANK")FAMBankService.modify($scope.source.uuid,$scope.source).success(function(data){$scope.showInfo("修改数据成功。");$scope.source=
data;$scope.selectedItem=data;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)}).error(function(data){$scope.showError("修改失败:"+"\x3cbr\x3e"+data.message);$scope.source=angular.copy($scope.selectedItemBackUp);$scope.selectedItem=angular.copy($scope.selectedItemBackUp)})};$scope.deleteDetailAction=function(detail){};$scope.selectItemAction=function(event,item){$scope.stopEventPropagation(event);item.selectedRef=!item.selected;if(item.selected==false||item.selected==undefined||item.selected==
null)$scope.selectedItemSize+=1;else{$scope.selectedItemSize-=1;$scope.selectAllFlag=false}$scope.disableBatchMenuButtons()};$scope.confirmClickAction=function(event,item){$scope.stopEventPropagation(event);if(item.confirm==Constant.CONFIRM[2].value)$scope.showConfirm("确认取消审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};FAMBankService.modify(item.uuid,UpdateInput).success(function(){item.confirm=Constant.CONFIRM[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("取消审核成功！")}).error(function(response){$scope.showError(response.message)})});
else $scope.showConfirm("确认审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};FAMBankService.modify(item.uuid,UpdateInput).success(function(){item.confirm=Constant.CONFIRM[2].value;$scope.disableBatchMenuButtons();$scope.showInfo("审核成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.confirmSwitchAction=function(event,item){$scope.stopEventPropagation(event);if(item.confirm==Constant.CONFIRM[2].value)$scope.showConfirm("确认取消审核吗？","",
function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};FAMBankService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("修改数据成功。")})},function(){item.confirm=Constant.CONFIRM[2].value});else $scope.showConfirm("确认审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};FAMBankService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("修改数据成功。")})},
function(){item.confirm=Constant.CONFIRM[1].value})};$scope.statusClickAction=function(event,item){$scope.stopEventPropagation(event);if(item.status==Constant.STATUS[1].value)$scope.showConfirm("确认改为失效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value};FAMBankService.modify(item.uuid,UpdateInput).success(function(){item.status=Constant.STATUS[2].value;$scope.disableBatchMenuButtons();$scope.showInfo("修改为失效成功！")}).error(function(response){$scope.showError(response.message)})});
else $scope.showConfirm("确认改为生效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};FAMBankService.modify(item.uuid,UpdateInput).success(function(){item.status=Constant.STATUS[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("修改为生效成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.statusSwitchAction=function(event,item){$scope.stopEventPropagation(event);if(item.status==Constant.STATUS[2].value)$scope.showConfirm("确认修改启用状态为有效吗？",
"",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};FAMBankService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("修改数据成功。")})},function(){item.status=Constant.STATUS[2].value});else $scope.showConfirm("确认修改启用状态为无效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value};FAMBankService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("修改数据成功。")})},
function(){item.status=Constant.STATUS[1].value})};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){FAMBankService.delete(item.uuid).success(function(){$scope.selectedItem=null;$scope.refreshList();$scope.showInfo("删除数据成功。")})})};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var noDeleteNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===
true){var response=FAMBankService.delete(item.uuid).success(function(){});promises.push(response);count++}});if(count==0){$scope.showWarn("没有选择任何可删除项目，请选择！");return}$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){if(noDeleteNos!=="")$scope.showWarn("以下状态是失效或已审核的的项目将不会删除："+"\x3cbr\x3e"+noDeleteNos);$q.all(promises).then(function(){$scope.refreshList();$scope.showInfo("删除成功！")},function(data){$scope.showError(data.message);$scope.showError(data.data.message)})})};$scope.confirmAllClickAction=function(event){$scope.stopEventPropagation(event);
var promises=[];var confirmedNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.confirm!=Constant.CONFIRM[2].value){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};var response=FAMBankService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else confirmedNos=confirmedNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任何未审核的项目，请先选择！");return}if(confirmedNos!=="")$scope.showWarn("以下已审核过的项目将不再次审核："+
"\x3cbr\x3e"+confirmedNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.disableBatchMenuButtons();$scope.showInfo("审核成功！")},function(data){$scope.showError(data.message);$scope.showError(data.data.message)})};$scope.revertConfirmAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var unConfirmedNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.confirm==Constant.CONFIRM[2].value){var UpdateInput={uuid:item.uuid,
confirm:Constant.CONFIRM[1].value};var response=FAMBankService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else unConfirmedNos=unConfirmedNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任已审核的项目，请先选择！");return}if(unConfirmedNos!=="")$scope.showWarn("以下未审核过的项目将不执行取消审核："+unConfirmedNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("取消审核成功！")},function(data){$scope.showError(data.data.message);$scope.showError(data.message)})};
$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var effectiveNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.status!=Constant.STATUS[1].value){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};var response=FAMBankService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else effectiveNos=effectiveNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任何失效的项目，请先选择！");
return}if(effectiveNos!=="")$scope.showWarn("以下已生效的项目将不再次修改："+"\x3cbr\x3e"+effectiveNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("生效成功！")},function(data){$scope.showError(data.message);$scope.showError(data.data.message)})};$scope.revertStatusAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var uneffectiveNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.status==Constant.STATUS[1].value){var UpdateInput=
{uuid:item.uuid,status:Constant.STATUS[2].value};var response=FAMBankService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else uneffectiveNos=uneffectiveNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择生效的项目，请先选择！");return}if(uneffectiveNos!=="")$scope.showWarn("以下失效的项目将不再次修改："+uneffectiveNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("失效成功！")},function(data){$scope.showError(data.data.message);$scope.showError(data.message)})};
$scope.selectAllAction=function(){angular.forEach($scope.itemList,function(item){if($scope.selectAllFlag)item.selected=true;else item.selected=false;item.selectedRef=item.selected});$scope.selectedItemSize=0;$scope.selectedItemAmount=0;if($scope.selectAllFlag)angular.forEach($scope.itemList,function(){$scope.selectedItemSize++});$scope.disableBatchMenuButtons()};$scope.disableBatchMenuButtons=function(){var selectedCount=0;var confirm="";var status="";var diffConfirm=false;var diffStatus=false;angular.forEach($scope.itemList,
function(item,index){if(item.selectedRef){selectedCount++;if(confirm=="")confirm=item.confirm;else if(confirm!=item.confirm)diffConfirm=true;if(status=="")status=item.status;else if(status!=item.status)diffStatus=true}});if(selectedCount==0){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}else{if(diffConfirm==true){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=
true;$scope.disabledBatchDelete=true}else if(confirm=="2"){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=false;$scope.disabledBatchDelete=true}else{$scope.disabledBatchConfirm=false;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchDelete=false}if(diffStatus==true){$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}else if(status=="1"){$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=false;$scope.disabledBatchDelete=
false}else{$scope.disabledBatchStatus=false;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}}}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/fam/bankCard",{controller:"FAMBankCardConfigController",templateUrl:"app/src/app/fam/bank_card/bankCard.html"})}]);
angular.module("IOne-Production").controller("FAMBankCardConfigController",function($scope,FAMBankCardService,Constant,$mdDialog,$q){$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={select:{status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value},no:"",name:"",keyWord:""};$scope.menuDisplayOption={"switchConfirm":{display:true,name:"审核/取消审核",uuid:"c168f8e3-aa2e-4847-b79f-2345569893f8"},"switchStatus":{display:true,name:"启用/禁用",uuid:"b3356d4f-0c5c-4075-8182-509ee3428f63"},
"batchConfirm":{display:true,name:"批量审核",uuid:"43e5fe2b-34dd-4994-a510-4d00bc1ef86e"},"batchRevertConfirm":{display:true,name:"批量取审",uuid:"f7727f32-ddc3-4808-8961-8a72273d6e49"},"batchStatus":{display:true,name:"批量启用",uuid:"981a4b7e-ad49-41bf-99c4-7366a743b86f"},"batchRevertStatus":{display:true,name:"批量禁用",uuid:"b7cb7c3c-b0e2-47c4-b3d2-0a1a04981def"},"batchDelete":{display:true,name:"批量删除",uuid:"742cf274-d612-418a-8953-11b63a730aa6"},"detailConfirm":{display:true,name:"审核",uuid:"79601337-f801-4b94-bb2a-20236f54c3cf"},
"detailRevertConfirm":{display:true,name:"取审",uuid:"e52557e1-8842-4e65-9a78-8edd9c7e60ed"},"detailStatus":{display:true,name:"启用",uuid:"23ba064c-6863-4f64-9a21-ed38b5ee668d"},"detailRevertStatus":{display:true,name:"禁用",uuid:"3c843e71-2012-4541-a5f3-0b912e2d09b9"},"detailDelete":{display:true,name:"删除",uuid:"a27be24c-4630-440e-afac-3f846847be8b"}};$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=
true;$scope.sortByField="no";$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.refreshList=function(){FAMBankCardService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.no,$scope.listFilterOption.name,$scope.listFilterOption.keyWord,$scope.RES_UUID_MAP.CBI.BANK_CARD.RES_UUID).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;
$scope.selectAllFlag=false;$scope.selectedItemSize=0})};$scope.getMenuAuthData($scope.RES_UUID_MAP.CBI.BANK_CARD.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)});$scope.$watch("listFilterOption.select",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=
0;$scope.refreshList()}};$scope.selectAllFlag=false;$scope.selectedItemSize=0;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;item.detailList=$scope.subItemList;$scope.displayAdvancedSearPanel=false};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;$scope.selectedItem=null};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel)item.detailList=item};$scope.toggleDetailMorePanelAction=
function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);$scope.refreshList()};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);
$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.status=="add"){if($scope.domain=="FAM_BASE_BANK_CARD")FAMBankCardService.add($scope.source).success(function(data){$scope.showInfo("新增数据成功。")}).error(function(data){$scope.showError("新增失败:"+"\x3cbr\x3e"+data.message)})}else if($scope.status=="edit")if($scope.domain=="FAM_BASE_BANK_CARD")FAMBankCardService.modify($scope.source.uuid,$scope.source).success(function(data){$scope.showInfo("修改数据成功。");
$scope.source=data;$scope.selectedItem=data;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)}).error(function(data){$scope.showError("修改失败:"+"\x3cbr\x3e"+data.message);$scope.source=angular.copy($scope.selectedItemBackUp);$scope.selectedItem=angular.copy($scope.selectedItemBackUp)})};$scope.deleteDetailAction=function(detail){};$scope.selectItemAction=function(event,item){$scope.stopEventPropagation(event);item.selectedRef=!item.selected;if(item.selected==false||item.selected==undefined||
item.selected==null)$scope.selectedItemSize+=1;else{$scope.selectedItemSize-=1;$scope.selectAllFlag=false}$scope.disableBatchMenuButtons()};$scope.confirmClickAction=function(event,item){$scope.stopEventPropagation(event);if(item.confirm==Constant.CONFIRM[2].value)$scope.showConfirm("确认取消审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};FAMBankCardService.modify(item.uuid,UpdateInput).success(function(){item.confirm=Constant.CONFIRM[1].value;$scope.disableBatchMenuButtons();
$scope.showInfo("取消审核成功！")}).error(function(response){$scope.showError(response.message)})});else $scope.showConfirm("确认审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};FAMBankCardService.modify(item.uuid,UpdateInput).success(function(){item.confirm=Constant.CONFIRM[2].value;$scope.disableBatchMenuButtons();$scope.showInfo("审核成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.confirmSwitchAction=function(event,item){$scope.stopEventPropagation(event);
if(item.confirm==Constant.CONFIRM[2].value)$scope.showConfirm("确认取消审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};FAMBankCardService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("修改数据成功。")})},function(){item.confirm=Constant.CONFIRM[2].value});else $scope.showConfirm("确认审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};FAMBankCardService.modify(UpdateInput.uuid,
UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("修改数据成功。")})},function(){item.confirm=Constant.CONFIRM[1].value})};$scope.statusClickAction=function(event,item){$scope.stopEventPropagation(event);if(item.status==Constant.STATUS[1].value)$scope.showConfirm("确认改为失效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value};FAMBankCardService.modify(item.uuid,UpdateInput).success(function(){item.status=Constant.STATUS[2].value;$scope.disableBatchMenuButtons();
$scope.showInfo("修改为失效成功！")}).error(function(response){$scope.showError(response.message)})});else $scope.showConfirm("确认改为生效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};FAMBankCardService.modify(item.uuid,UpdateInput).success(function(){item.status=Constant.STATUS[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("修改为生效成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.statusSwitchAction=function(event,item){$scope.stopEventPropagation(event);
if(item.status==Constant.STATUS[2].value)$scope.showConfirm("确认修改启用状态为有效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};FAMBankCardService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("修改数据成功。")})},function(){item.status=Constant.STATUS[2].value});else $scope.showConfirm("确认修改启用状态为无效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value};FAMBankCardService.modify(UpdateInput.uuid,
UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("修改数据成功。")})},function(){item.status=Constant.STATUS[1].value})};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){FAMBankCardService.delete(item.uuid).success(function(){$scope.selectedItem=null;$scope.refreshList();$scope.showInfo("删除数据成功。")})})};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=
[];var noDeleteNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true){var response=FAMBankCardService.delete(item.uuid).success(function(){});promises.push(response);count++}});if(count==0){$scope.showWarn("没有选择任何可删除项目，请选择！");return}$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){if(noDeleteNos!=="")$scope.showWarn("以下状态是失效或已审核的的项目将不会删除："+"\x3cbr\x3e"+noDeleteNos);$q.all(promises).then(function(){$scope.refreshList();$scope.showInfo("删除成功！")},function(data){$scope.showError(data.message);
$scope.showError(data.data.message)})})};$scope.confirmAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var confirmedNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.confirm!=Constant.CONFIRM[2].value){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};var response=FAMBankCardService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else confirmedNos=confirmedNos+item.no+
"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任何未审核的项目，请先选择！");return}if(confirmedNos!=="")$scope.showWarn("以下已审核过的项目将不再次审核："+"\x3cbr\x3e"+confirmedNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.disableBatchMenuButtons();$scope.showInfo("审核成功！")},function(data){$scope.showError(data.message);$scope.showError(data.data.message)})};$scope.revertConfirmAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var unConfirmedNos="";var count=0;angular.forEach($scope.itemList,
function(item){if(item.selected===true)if(item.confirm==Constant.CONFIRM[2].value){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};var response=FAMBankCardService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else unConfirmedNos=unConfirmedNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任已审核的项目，请先选择！");return}if(unConfirmedNos!=="")$scope.showWarn("以下未审核过的项目将不执行取消审核："+unConfirmedNos);$q.all(promises).then(function(data){$scope.refreshList();
$scope.showInfo("取消审核成功！")},function(data){$scope.showError(data.data.message);$scope.showError(data.message)})};$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var effectiveNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.status!=Constant.STATUS[1].value){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};var response=FAMBankCardService.modify(item.uuid,UpdateInput).success(function(){});
promises.push(response);count++}else effectiveNos=effectiveNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任何失效的项目，请先选择！");return}if(effectiveNos!=="")$scope.showWarn("以下已生效的项目将不再次修改："+"\x3cbr\x3e"+effectiveNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("生效成功！")},function(data){$scope.showError(data.message);$scope.showError(data.data.message)})};$scope.revertStatusAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var uneffectiveNos=
"";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.status==Constant.STATUS[1].value){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value};var response=FAMBankCardService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else uneffectiveNos=uneffectiveNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择生效的项目，请先选择！");return}if(uneffectiveNos!=="")$scope.showWarn("以下失效的项目将不再次修改："+uneffectiveNos);$q.all(promises).then(function(data){$scope.refreshList();
$scope.showInfo("失效成功！")},function(data){$scope.showError(data.data.message);$scope.showError(data.message)})};$scope.selectAllAction=function(){angular.forEach($scope.itemList,function(item){if($scope.selectAllFlag)item.selected=true;else item.selected=false;item.selectedRef=item.selected});$scope.selectedItemSize=0;$scope.selectedItemAmount=0;if($scope.selectAllFlag)angular.forEach($scope.itemList,function(){$scope.selectedItemSize++});$scope.disableBatchMenuButtons()};$scope.disableBatchMenuButtons=
function(){var selectedCount=0;var confirm="";var status="";var diffConfirm=false;var diffStatus=false;angular.forEach($scope.itemList,function(item,index){if(item.selectedRef){selectedCount++;if(confirm=="")confirm=item.confirm;else if(confirm!=item.confirm)diffConfirm=true;if(status=="")status=item.status;else if(status!=item.status)diffStatus=true}});if(selectedCount==0){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=
true;$scope.disabledBatchDelete=true}else{if(diffConfirm==true){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchDelete=true}else if(confirm=="2"){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=false;$scope.disabledBatchDelete=true}else{$scope.disabledBatchConfirm=false;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchDelete=false}if(diffStatus==true){$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=
true}else if(status=="1"){$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=false;$scope.disabledBatchDelete=false}else{$scope.disabledBatchStatus=false;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}}}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/salesOrder",{controller:"bookingSlipAgencyController",templateUrl:"app/src/app/order/booking_slip_agency/bookingSlip.html"})}]);
angular.module("IOne-Production").controller("bookingSlipAgencyController",function($scope,$q,PSOdeliverWays,SalesOrderMaster,SalesOrderDetail,SalesOrderExtendDetail,SalesOrderExtendDetail2,OrderItemCustomDetail,OrderCustomScope,OrderChannelCurrency,OrderChannelTax,SaleTypes,$mdDialog,$timeout,Constant){$scope.orderListMenu={select:{confirm:Constant.AUDIT[1].value,status:Constant.STATUS[1].value,transferPsoFlag:Constant.TRANSFER_PSO_FLAG[2].value,startDate:null,endDate:null},selectAll:false,effectiveType:"2",
showQueryBar:true,showEmployee:false,showTransferPso:false,"orderMasterNo":{display:true,name:"预订单单号"},showPsoOrderMstNo:true};$scope.formMenuDisplayOption={"100-add":{display:false,name:"新增",uuid:"90011648-4AC7-40EB-A847-FAAD9117F838"},"101-delete":{display:true,name:"删除",uuid:"5C49B5A1-76EF-417B-9C54-238FB7148AEA"},"102-edit":{display:true,name:"编辑",uuid:"C913DB2D-2473-4807-9221-22AA37E14848"},"200-cancel":{display:true,name:"取消新增",uuid:"BF2D1976-E3AC-47BD-90D3-64AF175FC449"},"201-save":{display:true,
name:"保存",uuid:"64F8C22E-4AF6-4840-B50C-B47E5CDC45BE"},"302-save":{display:true,name:"保存",uuid:"B226ADDD-328C-44F2-93F3-B4443ADF8E45"},"303-cancel":{display:true,name:"取消修改",uuid:"07FF1596-1835-475C-8F80-1B732688C987"},"304-quit":{display:true,name:"退出编辑",uuid:"2799A0EB-6BF5-4962-9400-12FA06DD4C78"},"107-change":{display:true,name:"变更",uuid:"4D0309D3-16E0-4517-AA09-0F9246786101"},"108-changehistory":{display:true,name:"变更记录查询",uuid:"4D7273D6-970C-4825-93CD-73209782CBE8"},"410-selectAll":{display:false,
name:"全选",uuid:"F0051ECE-0DD8-41E4-ACA1-7D0FFF15D512"},"411-audit":{display:true,name:"审核",uuid:"3DB45A72-755E-4580-8F81-BDC80A06A7CC"},"412-return":{display:true,name:"退回",uuid:"43073BCFD-66D2-4E29-8930-ED3A09C698E0"},"413-throw":{display:true,name:"抛转后台",uuid:"938FFFD8-BCDD-424E-BF22-F90D6EB872BA"},"414-effective":{display:true,name:"失效作废",uuid:"443EF412-7E38-45EF-B6B4-E0A954D0BFD4"},"416-revertAudit":{display:true,name:"取消审核",uuid:"A7468800-9F3C-4116-9016-73CF1CA3F493"}};$scope.orderListMenuDisplayOption=
{"400-selectAll":{display:true,name:"全选",uuid:"B4951D9E-7F02-4330-ADFC-09150CDF992F"},"401-audit":{display:true,name:"审核",uuid:"0D7CA48A-B2DD-4BC2-8981-3D3575FD6DCA"},"402-return":{display:true,name:"退回",uuid:"4AC1D963-529A-4938-97BB-DF9DB2343DA2"},"403-throw":{display:true,name:"抛转后台",uuid:"B14A229A-6035-445D-9E93-10F99A0333F3"},"404-effective":{display:true,name:"失效作废",uuid:"B6D5104F-0DC9-47C8-843E-CC7677C5D059"},"405-query":{display:true,name:"查询",uuid:"4B848B3E-5A1A-4453-9356-6ADE97D93608"},"406-revertAudit":{display:true,
name:"取消审核",uuid:"E67D450A-8ABA-48A3-97AA-4FDD1937FA7A"},"408-add":{display:true,name:"新增",uuid:"90011648-4AC7-40EB-A847-FAAD9117F838"}};$scope.itemOperationMenuDisplayOption={"500-item-edit":{display:true,name:""},"501-item-delete":{display:true,name:""}};$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.editItem=function(orderMaster){$scope.selectedDetail=[];$scope.orderListMenu.selectAll=false;$scope.selectedItem=orderMaster;$scope.changeViewStatus(Constant.UI_STATUS.PRE_EDIT_UI_STATUS,
1);$scope.resetButtonDisabled();$scope.changeButtonStatus(orderMaster);$scope.orderListMenu.effectiveType=orderMaster.status;SalesOrderDetail.get(orderMaster.uuid).success(function(data){$scope.OrderDetailList=data;$scope.updateOrderDetaiListDate($scope.OrderDetailList);$scope.OrderExtendDetailList=[];angular.forEach($scope.OrderDetailList.content,function(orderDetail,index){SalesOrderExtendDetail.get(orderMaster.uuid,orderDetail.uuid).success(function(data){$scope.OrderExtendDetailList=$scope.OrderExtendDetailList.concat(data.content)})})});
OrderChannelCurrency.getAll().success(function(data){$scope.channelCurrencies=data.content});OrderChannelTax.getAll().success(function(data){$scope.channelTaxs=data.content});SaleTypes.getAll().success(function(data){$scope.saleTypes=data.content});PSOdeliverWays.getAll().success(function(data){$scope.deliverWays=data.content});if($scope.selectedItem.orderTransferNo!=undefined&&$scope.selectedItem.orderTransferNo!=null){$scope.formMenuDisplayOption["102-edit"].display=false;$scope.formMenuDisplayOption["101-delete"].display=
false}else{$scope.formMenuDisplayOption["102-edit"].display=true;$scope.formMenuDisplayOption["101-delete"].display=true}};$scope.listTabSelected=function(){$scope.orderListMenu.showQueryBar=true;$scope.orderListMenuDisplayOption["400-selectAll"].display=true;$scope.queryMenuActionWithPaging();$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS,0);$scope.allCustomsScopes=null;$scope.orderExtendDetail2List=null;$scope.selectedItemCustoms=null;$scope.changeSubTabIndexs(0);$scope.getMenuAuthData($scope.RES_UUID_MAP.PSO.SO.LIST_PAGE.RES_UUID).success(function(data){$scope.menuAuthDataMap=
$scope.menuDataMap(data)});$scope.selectedDetail=[];$scope.OrderDetailList=null};$scope.formTabSelected=function(){$scope.orderListMenu.showQueryBar=false;$scope.orderListMenuDisplayOption["400-selectAll"].display=false;$scope.getMenuAuthData($scope.RES_UUID_MAP.PSO.SO.FORM_PAGE.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)})};$scope.prodInfoTabSelected=function(){$scope.changeSubTabIndexs(0);$scope.allCustomsScopes=null;$scope.orderExtendDetail2List=null;$scope.selectedItemCustoms=
null};$scope.deliverInfoTabSelected=function(){$scope.changeSubTabIndexs(1);$scope.allCustomsScopes=null;$scope.orderExtendDetail2List=null;$scope.selectedItemCustoms=null};$scope.receiptInfoTabSelected=function(){$scope.changeSubTabIndexs(3);$scope.allCustomsScopes=null;$scope.orderExtendDetail2List=null;$scope.selectedItemCustoms=null;ReceiptDetail.get($scope.selectedItem.uuid).success(function(data){$scope.ReceiptOrderDetailList=data})};$scope.customTabSelected=function(){$scope.changeSubTabIndexs(2)};
$scope.selected=[];$scope.selectedItemsCount=0;$scope.selectedItemsTotalPrice=0;$scope.toggle=function(item,selected){var idx=selected.indexOf(item);if(idx>-1)selected.splice(idx,1);else selected.push(item);$scope.orderListMenu.effectiveType=item.status;$scope.resetInitialValue();$scope.changeButtonStatusAndCalTotalPrice();$scope.selectedItemsTotalPrice=$scope.selectedItemsTotalPrice.toFixed(2);$scope.selectedItemsCount=selected.length};$scope.changeButtonStatusAndCalTotalPrice=function(){var firstLoop=
true;angular.forEach($scope.selected,function(orderMaster){$scope.selectedItemsTotalPrice=$scope.selectedItemsTotalPrice+orderMaster.originalOrderAmount;if(firstLoop){firstLoop=false;$scope.orderListMenu.effectiveType=orderMaster.status;$scope.firstOrderMasterStatus=orderMaster.status}else if($scope.firstOrderMasterStatus!==orderMaster.status)$scope.effectiveType_disabled=1;$scope.changeButtonStatus(orderMaster)})};$scope.changeButtonStatus=function(orderMaster){if(orderMaster.confirm==2||orderMaster.confirm==
3)$scope.effectiveType_disabled=1;if(orderMaster.confirm==2||orderMaster.confirm==4)$scope.return_button_disabled=1;if(orderMaster.confirm==2||orderMaster.confirm==4)$scope.audit_button_disabled=1;if(!(orderMaster.confirm==2&&orderMaster.transferPsoFlag!=1))$scope.throw_button_disabled=1;if(!(orderMaster.confirm==2&&orderMaster.transferPsoFlag!=1))$scope.revert_audit_button_disabled=1};$scope.exists=function(item,list){return list.indexOf(item)>-1};$scope.selectedDetail=[];$scope.toggleDetail=function(item,
selectedDetail){var idx=selectedDetail.indexOf(item);if(idx>-1)selectedDetail.splice(idx,1);else selectedDetail.push(item);$scope.orderListMenu.effectiveType=item.status;$scope.resetButtonDisabled();$scope.changeButtonStatuOnly()};$scope.changeButtonStatuOnly=function(){var firstLoop=true;angular.forEach($scope.selectedDetail,function(orderDetail){if(firstLoop){firstLoop=false;$scope.orderListMenu.effectiveType=orderDetail.status;$scope.firstOrderDetailStatus=orderDetail.status}else if($scope.firstOrderDetailStatus!==
orderDetail.status)$scope.effectiveType_disabled=1;$scope.changeButtonStatus(orderDetail)})};$scope.selectAllMenuAction=function(){if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1)if($scope.orderListMenu.selectAll==true){angular.forEach($scope.OrderDetailList.content,function(item){var idx=$scope.selectedDetail.indexOf(item);if(idx<0)$scope.selectedDetail.push(item)});$scope.resetButtonDisabled();$scope.changeButtonStatuOnly()}else{if($scope.orderListMenu.selectAll==
false){$scope.selectedDetail=[];$scope.orderListMenu.effectiveType="1";$scope.resetButtonDisabled()}}else if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0)if($scope.orderListMenu.selectAll==true){angular.forEach($scope.OrderMasterList.content,function(item){var idx=$scope.selected.indexOf(item);if(idx<0)$scope.selected.push(item)});$scope.resetInitialValue();$scope.changeButtonStatusAndCalTotalPrice();$scope.selectedItemsTotalPrice=$scope.selectedItemsTotalPrice.toFixed(2);
$scope.selectedItemsCount=$scope.selected.length}else if($scope.orderListMenu.selectAll==false){$scope.selected=[];$scope.orderListMenu.effectiveType="1";$scope.resetInitialValue()}};$scope.refreshMasterAndDetail=function(){SalesOrderMaster.get($scope.selectedItem.uuid).success(function(data){$scope.selectedItem=data;$scope.updateOrderMasterDate($scope.selectedItem);$scope.selectedDetail=[];$scope.orderListMenu.selectAll=false;$scope.resetButtonDisabled();$scope.orderListMenu.effectiveType=data.status;
SalesOrderDetail.get($scope.selectedItem.uuid).success(function(data){$scope.OrderDetailList=data;$scope.updateOrderDetaiListDate($scope.OrderDetailList);$scope.showInfo("修改数据成功。")})})};$scope.effectiveMenuAction=function(){if($scope.selected.length>0||$scope.selectedTabIndex==1)$scope.showConfirm("确认修改启用状态吗？","",function(){if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){var OrderMasterUpdateInput={uuid:$scope.selectedItem.uuid,status:$scope.orderListMenu.effectiveType};
SalesOrderMaster.modify(OrderMasterUpdateInput).success(function(){$scope.selectedItem.status=$scope.orderListMenu.effectiveType;$scope.editItem($scope.selectedItem);SalesOrderMaster.getOrderMasterCount(Constant.AUDIT[1].value,Constant.STATUS[1].value,Constant.TRANSFER_PSO_FLAG[2].value,RES_UUID_MAP.PSO.SO.LIST_PAGE.RES_UUID).success(function(data){$scope.menuList[1].subList[2].suffix=data});$scope.showInfo("修改数据成功。")})}else if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==
0){var promises=[];angular.forEach($scope.selected,function(item){var OrderMasterUpdateInput={uuid:item.uuid,status:$scope.orderListMenu.effectiveType};var response=SalesOrderMaster.modify(OrderMasterUpdateInput).success(function(){});promises.push(response)});$q.all(promises).then(function(data){$scope.queryMenuActionWithPaging();$scope.showInfo("修改数据成功。")})}})};$scope.auditMenuAction=function(){if($scope.selected.length>0||$scope.selectedTabIndex==1)$scope.showConfirm("确认审核吗？","",function(){if($scope.ui_status==
Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){var OrderMasterUpdateInput={uuid:$scope.selectedItem.uuid,confirm:"2"};SalesOrderMaster.modify(OrderMasterUpdateInput).success(function(){$scope.selectedItem.confirm="2";$scope.editItem($scope.selectedItem);SalesOrderMaster.getOrderMasterCount(Constant.AUDIT[1].value,Constant.STATUS[1].value,Constant.TRANSFER_PSO_FLAG[2].value,RES_UUID_MAP.PSO.SO.LIST_PAGE.RES_UUID).success(function(data){$scope.menuList[1].subList[2].suffix=data});
$scope.showInfo("修改数据成功。")})}else if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){var promises=[];angular.forEach($scope.selected,function(item){var OrderMasterUpdateInput={uuid:item.uuid,confirm:"2"};var response=SalesOrderMaster.modify(OrderMasterUpdateInput).success(function(){});promises.push(response)});$q.all(promises).then(function(data){angular.forEach($scope.selected,function(item){item.confirm="2"});$scope.resetInitialValue();$scope.changeButtonStatusAndCalTotalPrice();
$scope.selectedItemsTotalPrice=$scope.selectedItemsTotalPrice.toFixed(2);$scope.selectedItemsCount=$scope.selected.length;$scope.showInfo("修改数据成功。")})}})};$scope.returnMenuAction=function(){if($scope.selected.length>0||$scope.selectedTabIndex==1)$scope.showConfirm("确认退回吗？","",function(){if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){var OrderMasterUpdateInput={uuid:$scope.selectedItem.uuid,confirm:"4"};SalesOrderMaster.modify(OrderMasterUpdateInput).success(function(){$scope.selectedItem.confirm=
"4";$scope.editItem($scope.selectedItem);SalesOrderMaster.getOrderMasterCount(Constant.AUDIT[1].value,Constant.STATUS[1].value,Constant.TRANSFER_PSO_FLAG[2].value,RES_UUID_MAP.PSO.SO.LIST_PAGE.RES_UUID).success(function(data){$scope.menuList[1].subList[2].suffix=data});$scope.showInfo("修改数据成功。")})}else if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){var promises=[];angular.forEach($scope.selected,function(item){var OrderMasterUpdateInput={uuid:item.uuid,confirm:"4"};
var response=SalesOrderMaster.modify(OrderMasterUpdateInput).success(function(){});promises.push(response)});$q.all(promises).then(function(data){$scope.queryMenuActionWithPaging();$scope.showInfo("修改数据成功。")})}})};$scope.throwMenuAction=function(){if($scope.selected.length>0||$scope.selectedTabIndex==1)$scope.showConfirm("确认抛转吗？","",function(){if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){var OrderMasterUpdateInput={uuid:$scope.selectedItem.uuid,transferPsoFlag:"1"};
SalesOrderMaster.modify(OrderMasterUpdateInput).success(function(){$scope.selectedItem.transferPsoFlag="1";$scope.editItem($scope.selectedItem);SalesOrderMaster.getOrderMasterCount(Constant.AUDIT[1].value,Constant.STATUS[1].value,Constant.TRANSFER_PSO_FLAG[2].value,RES_UUID_MAP.PSO.SO.LIST_PAGE.RES_UUID).success(function(data){$scope.menuList[1].subList[2].suffix=data});$scope.showInfo("修改数据成功。")})}else if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){var orderMasterUuids=
"";angular.forEach($scope.selected,function(item){orderMasterUuids=orderMasterUuids+item.uuid+","});var OrderMasterUpdateInput={uuid:orderMasterUuids,transferPsoFlag:"1"};var response=SalesOrderMaster.modify(OrderMasterUpdateInput).success(function(){$scope.queryMenuActionWithPaging();$scope.showInfo("修改数据成功。")}).error(function(data){$scope.showError(data.message)})}})};$scope.revertAuditMenuAction=function(){if($scope.selected.length>0||$scope.selectedTabIndex==1)$scope.showConfirm("确认取消审核吗？","",
function(){if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){var OrderMasterUpdateInput={uuid:$scope.selectedItem.uuid,confirm:"1"};SalesOrderMaster.modify(OrderMasterUpdateInput).success(function(){$scope.selectedItem.confirm="1";$scope.editItem($scope.selectedItem);SalesOrderMaster.getOrderMasterCount(Constant.AUDIT[1].value,Constant.STATUS[1].value,Constant.TRANSFER_PSO_FLAG[2].value,RES_UUID_MAP.PSO.SO.LIST_PAGE.RES_UUID).success(function(data){$scope.menuList[1].subList[2].suffix=
data});$scope.showInfo("修改数据成功。")})}else if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){var promises=[];angular.forEach($scope.selected,function(item){var OrderMasterUpdateInput={uuid:item.uuid,confirm:"1"};var response=SalesOrderMaster.modify(OrderMasterUpdateInput).success(function(){});promises.push(response)});$q.all(promises).then(function(data){angular.forEach($scope.selected,function(item){item.confirm="1"});$scope.resetInitialValue();$scope.changeButtonStatusAndCalTotalPrice();
$scope.selectedItemsTotalPrice=$scope.selectedItemsTotalPrice.toFixed(2);$scope.selectedItemsCount=$scope.selected.length;$scope.showInfo("修改数据成功。")})}})};$scope.resetInitialValue=function(){$scope.selectedItem=null;$scope.selectedItemsCount=0;$scope.selectedItemsTotalPrice=0;$scope.resetButtonDisabled()};$scope.resetButtonDisabled=function(){$scope.effectiveType_disabled=0;$scope.return_button_disabled=0;$scope.audit_button_disabled=0;$scope.throw_button_disabled=0;$scope.revert_audit_button_disabled=
0};$scope.queryMenuAction=function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=100;$scope.pageOption.totalElements=100;$scope.queryMenuActionWithPaging()};$scope.queryMenuActionWithPaging=function(){$scope.selectedItem=null;$scope.selected=[];$scope.selectedItemsCount=0;$scope.selectedItemsTotalPrice=0;$scope.orderListMenu.selectAll=false;$scope.orderListMenu.effectiveType="2";$scope.resetInitialValue();if($scope.orderListMenu.select.startDate!==undefined)if($scope.orderListMenu.select.startDate!==
null){orderDateBegin=new Date($scope.orderListMenu.select.startDate);orderDateBegin=moment(orderDateBegin).format("YYYY-MM-DD")}else orderDateBegin=null;else orderDateBegin=null;if($scope.orderListMenu.select.endDate!==undefined)if($scope.orderListMenu.select.endDate!==null){orderDateEnd=new Date($scope.orderListMenu.select.endDate);orderDateEnd=moment(orderDateEnd).format("YYYY-MM-DD")}else orderDateEnd=null;else orderDateEnd=null;if($scope.orderListMenu.orderId!==undefined)orderMasterNo=$scope.orderListMenu.orderId;
else orderMasterNo=null;if($scope.orderListMenu.psoOrderMstNo!==undefined)psoOrderMstNo=$scope.orderListMenu.psoOrderMstNo;else psoOrderMstNo=null;if($scope.orderListMenu.clientName!==undefined)customerName=$scope.orderListMenu.clientName;else customerName=null;if($scope.orderListMenu.employeeName!==undefined)employeeName=$scope.orderListMenu.employeeName;else employeeName=null;if($scope.orderListMenu.contractNo!==undefined)contractNo=$scope.orderListMenu.contractNo;else contractNo=null;confirm=$scope.orderListMenu.select.confirm;
status=$scope.orderListMenu.select.status;transferPsoFlag=$scope.orderListMenu.select.transferPsoFlag;SalesOrderMaster.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,confirm,status,transferPsoFlag,orderMasterNo,psoOrderMstNo,null,employeeName,orderDateBegin,orderDateEnd,RES_UUID_MAP.PSO.SO.LIST_PAGE.RES_UUID,null,customerName,null,contractNo).success(function(data){$scope.OrderMasterList=data;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;
$scope.getOrderDetailCountByMasterUuid();SalesOrderMaster.getOrderMasterCount(Constant.AUDIT[1].value,Constant.STATUS[1].value,Constant.TRANSFER_PSO_FLAG[2].value,RES_UUID_MAP.PSO.SO.LIST_PAGE.RES_UUID).success(function(data){$scope.menuList[1].subList[2].suffix=data})})};$scope.$watch("orderListMenu.select",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.queryMenuAction()},true);$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=
0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.queryMenuAction()}};$scope.getOrderDetailCountByMasterUuid=function(){var orderMasterUuids="";angular.forEach($scope.OrderMasterList.content,function(orderMaster){$scope.updateOrderMasterDate(orderMaster);orderMasterUuids=orderMasterUuids+orderMaster.uuid+","});SalesOrderDetail.getAllCountByMasterUuids(orderMasterUuids).success(function(data){var map=[];angular.forEach(data,function(orderMasterWithCount){map[orderMasterWithCount.uuid]=
orderMasterWithCount.detailCount});angular.forEach($scope.OrderMasterList.content,function(orderMaster){if(undefined!=map[orderMaster.uuid])orderMaster.orderDetailCount=map[orderMaster.uuid];else orderMaster.orderDetailCount=0})})};$scope.modifyMenuAction=function(){if($scope.selectedItem)SalesOrderMaster.modify($scope.selectedItem).success(function(){$scope.showInfo("修改数据成功。")}).error(function(){$scope.showError("修改数据失败。")})};$scope.cancelModifyMenuAction=function(){SalesOrderMaster.get($scope.selectedItem.uuid).success(function(data){$scope.selectedItem=
data;$scope.updateOrderMasterDate($scope.selectedItem);PSOdeliverWays.getAll().success(function(data){$scope.deliverWays=data.content})})};$scope.exitModifyMenuAction=function(){$scope.cancelModifyMenuAction();$scope.changeViewStatus($scope.UI_STATUS.PRE_EDIT_UI_STATUS,1)};$scope.preAddMenuAction=function(){$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_ADD,1);orderDate=new Date;deliverDate=new Date(orderDate.valueOf()+2*24*60*60*1E3);$scope.selectedItem={confirm:"1",status:"1",transferPsoFlag:"2",
orderDate:orderDate,deliverDate:deliverDate};$scope.OrderDetailList={}};$scope.addMenuAction=function(){if($scope.selectedItem)SalesOrderMaster.add($scope.selectedItem).success(function(data){$scope.selectedItem=data;var promises=[];angular.forEach($scope.OrderDetailList.content,function(orderDetail,index){var response=SalesOrderDetail.add($scope.selectedItem.uuid,orderDetail).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.changeViewStatus($scope.UI_STATUS.PRE_EDIT_UI_STATUS,
1);$scope.editItem($scope.selectedItem);$scope.showInfo("新增成功。")},function(){SalesOrderMaster.delete($scope.selectedItem.uuid).success(function(){});$scope.showInfo("新增失败。")})}).error(function(){$scope.showError("新增失败。")})};$scope.cancelAddMenuAction=function(){$scope.listTabSelected()};$scope.deleteMenuAction=function(){$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){if($scope.selectedItem)SalesOrderMaster.delete($scope.selectedItem.uuid).success(function(){$scope.showInfo("删除成功。");$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_DELETE,
0)})})};$scope.changeMenuAction=function(){};$scope.changeHistoryMenuAction=function(){};$scope.openOrderItemsDlg=function(){if($scope.selectedItem.channel==undefined||$scope.selectedItem.channel==null)$scope.showWarn("请选择经销商。");else $mdDialog.show({controller:"OrderItemsSearchController",templateUrl:"app/src/app/order/booking_slip_agency/selectItems.html",parent:angular.element(document.body),targetEvent:event,locals:{channelUuid:$scope.selectedItem.channel.uuid,saleTypes:$scope.saleTypes}}).then(function(data){if($scope.selectedItem.uuid!=
undefined&&$scope.selectedItem.uuid!=null)SalesOrderDetail.add($scope.selectedItem.uuid,data.addOrderDetail).success(function(data){$scope.editItem(data.salesOrderMaster);$scope.showInfo("新增产品成功。")});else{if($scope.OrderDetailList.content==undefined)$scope.OrderDetailList.content=[];$scope.OrderDetailList.content.push(data.addOrderDetail);$scope.updateOrderMasterPrice($scope.OrderDetailList.content)}})};$scope.orderDetailDeleteMenuAction=function(orderDetail){$scope.showConfirm("确认删除吗？","删除后不可恢复。",
function(){if($scope.selectedItem.uuid!=undefined&&$scope.selectedItem.uuid!=null)SalesOrderDetail.delete(orderDetail.salesOrderMaster.uuid,orderDetail.uuid).success(function(){$scope.editItem($scope.selectedItem);$scope.showInfo("删除成功。")});else{$scope.OrderDetailList.content.splice($scope.OrderDetailList.content.indexOf(orderDetail),1);$scope.updateOrderMasterPrice($scope.OrderDetailList.content)}})};$scope.updateOrderMasterPrice=function(orderDetailList){$scope.selectedItemsOriStandardAmt=0;$scope.selectedItemsOriDiscountAmt=
0;$scope.selectedItemsOriOrderAmt=0;$scope.selectedItemsDiscountRate=0;angular.forEach(orderDetailList,function(orderDetail){if(null!=orderDetail.originalStandardAmount&&null!=orderDetail.originalDiscountAmount&&null!=orderDetail.originalOrderAmount){$scope.selectedItemsOriStandardAmt=parseFloat(($scope.selectedItemsOriStandardAmt+orderDetail.originalStandardAmount*orderDetail.orderQuantity).toFixed(2));$scope.selectedItemsOriDiscountAmt=parseFloat(($scope.selectedItemsOriDiscountAmt+orderDetail.originalDiscountAmount*
orderDetail.orderQuantity).toFixed(2));$scope.selectedItemsOriOrderAmt=parseFloat(($scope.selectedItemsOriOrderAmt+orderDetail.originalOrderAmount*orderDetail.orderQuantity).toFixed(2))}});if($scope.selectedItemsOriStandardAmt!=0)$scope.selectedItemsDiscountRate=parseFloat(($scope.selectedItemsOriOrderAmt/$scope.selectedItemsOriStandardAmt).toFixed(4));$scope.selectedItem.originalStandardAmount=$scope.selectedItemsOriStandardAmt;$scope.selectedItem.originalDiscountAmount=$scope.selectedItemsOriDiscountAmt;
$scope.selectedItem.originalOrderAmount=$scope.selectedItemsOriOrderAmt;$scope.selectedItem.discountRate=$scope.selectedItemsDiscountRate};$scope.orderDetailEditMenuAction=function(orderDetail){$mdDialog.show({controller:"SalesOrderDetailController",templateUrl:"app/src/app/order/booking_slip_agency/orderDetailEditDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{selectedOrderDetail:orderDetail,saleTypes:$scope.saleTypes}}).then(function(data){SalesOrderDetail.modify(data.selectedOrderDetail.salesOrderMaster.uuid,
data.selectedOrderDetail.uuid,data.selectedOrderDetail).success(function(){SalesOrderDetail.get(data.selectedOrderDetail.salesOrderMaster.uuid).success(function(data){$scope.OrderDetailList=data;$scope.updateOrderDetaiListDate($scope.OrderDetailList)});$scope.showInfo("修改成功。")})})};$scope.updateOrderDetaiListDate=function(OrderDetailList){angular.forEach(OrderDetailList.content,function(orderDetail){$scope.updateOrderDetailDate(orderDetail)})};$scope.updateOrderDetailDate=function(orderDetail){if(null!=
orderDetail.deliverDate)orderDetail.deliverDate=new Date(orderDetail.deliverDate)};$scope.updateOrderMasterDate=function(orderMaster){if(null!=orderMaster.deliverDate)orderMaster.deliverDate=new Date(orderMaster.deliverDate);if(null!=orderMaster.orderDate)orderMaster.orderDate=new Date(orderMaster.orderDate);if(null!=orderMaster.transferDate)orderMaster.transferDate=new Date(orderMaster.transferDate);if(undefined!=orderMaster.psoOrderMstNo&&null!=orderMaster.psoOrderMstNo){var idx=orderMaster.psoOrderMstNo.indexOf(",");
if(idx>0)orderMaster.psoOrderMstNo=null}};$scope.orderExtendDetailEditMenuAction=function(orderExtendDetail){$mdDialog.show({controller:"SalesOrderExtendDetailController",templateUrl:"app/src/app/order/booking_slip_agency/orderExtendDetailEditDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{selectedOrderExtendDetail:orderExtendDetail}}).then(function(data){SalesOrderExtendDetail.modify(data.selectedOrderExtendDetail.salesOrderDetail.salesOrderMaster.uuid,data.selectedOrderExtendDetail.salesOrderDetail.uuid,
data.selectedOrderExtendDetail.uuid,data.selectedOrderExtendDetail).success(function(){SalesOrderDetail.get(data.selectedOrderExtendDetail.salesOrderDetail.salesOrderMaster.uuid,data.selectedOrderExtendDetail.salesOrderDetail.uuid).success(function(data){$scope.OrderDetailList=data;$scope.updateOrderDetaiListDate($scope.OrderDetailList);$scope.OrderExtendDetailList=[];angular.forEach($scope.OrderDetailList.content,function(orderDetail,index){SalesOrderExtendDetail.get(orderDetail.salesOrderMaster.uuid,
orderDetail.uuid).success(function(data){$scope.OrderExtendDetailList=$scope.OrderExtendDetailList.concat(data.content)})});$scope.showInfo("修改成功。")})})})};$scope.editItemCustom=function(orderExtendDetail){$scope.selectedOrderExtendDetail=orderExtendDetail;$scope.changeSubTabIndexs(2);OrderItemCustomDetail.getCustomDetail(orderExtendDetail.item.uuid).success(function(data){$scope.allCustomsScopes={};$scope.selectedItemCustoms=data;angular.forEach($scope.selectedItemCustoms.content,function(value){value.informationUuids=
JSON.parse(value.information)});angular.forEach($scope.selectedItemCustoms.content,function(itemCustomDetail){angular.forEach(itemCustomDetail.informationUuids,function(informationUuid){OrderCustomScope.getCustomScope(itemCustomDetail.itemCustom.uuid,informationUuid).success(function(data){if(data.brand!=null&&orderExtendDetail.item.brand!=null&&orderExtendDetail.item.brand.name!=data.brand.name);else if($scope.allCustomsScopes[itemCustomDetail.itemCustom.uuid]==undefined){var value={};value[data.uuid]=
data;$scope.allCustomsScopes[itemCustomDetail.itemCustom.uuid]=value}else{var value=$scope.allCustomsScopes[itemCustomDetail.itemCustom.uuid];value[data.uuid]=data;$scope.allCustomsScopes[itemCustomDetail.itemCustom.uuid]=value}})})})});var masterUuid=$scope.selectedOrderExtendDetail.salesOrderDetail.salesOrderMaster.uuid;var detailUuid=$scope.selectedOrderExtendDetail.salesOrderDetail.uuid;var orderExtendDetailUuid=$scope.selectedOrderExtendDetail.uuid;SalesOrderExtendDetail2.get(masterUuid,detailUuid,
orderExtendDetailUuid).success(function(data){$scope.orderExtendDetail2List=data;angular.forEach($scope.orderExtendDetail2List.content,function(value){value.informationUuids=JSON.parse(value.information)})})};$scope.openAddCustomDlg=function(){$mdDialog.show({controller:"SalesOrderExtendDetail2Controller",templateUrl:"app/src/app/order/booking_slip_agency/addCustomDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{allCustomsScopes:$scope.allCustomsScopes,custom:null,allCustoms:$scope.selectedItemCustoms,
op:"add"}}).then(function(data){var OrderExtendDetail2Input={salesOrderExtendDetailUuid:$scope.selectedOrderExtendDetail.uuid,no:Math.random().toString(36).substring(10),itemUuid:$scope.selectedOrderExtendDetail.item.uuid,itemCustomUuid:data.selectedCustom.itemCustom.uuid,information:data.selectedCustom.information};var masterUuid=$scope.selectedOrderExtendDetail.salesOrderDetail.salesOrderMaster.uuid;var detailUuid=$scope.selectedOrderExtendDetail.salesOrderDetail.uuid;var orderExtendDetailUuid=
$scope.selectedOrderExtendDetail.uuid;SalesOrderExtendDetail2.add(masterUuid,detailUuid,orderExtendDetailUuid,OrderExtendDetail2Input).success(function(response){response.informationUuids=data.selectedCustom.informationUuids;$scope.orderExtendDetail2List.content.push(response);$scope.OrderExtendDetailList=[];angular.forEach($scope.OrderDetailList.content,function(orderDetail,index){SalesOrderExtendDetail.get(orderDetail.salesOrderMaster.uuid,orderDetail.uuid).success(function(data){$scope.OrderExtendDetailList=
$scope.OrderExtendDetailList.concat(data.content)})});$scope.showInfo("新增自定义信息成功。")})})};$scope.openEditCustomDlg=function(custom){$mdDialog.show({controller:"SalesOrderExtendDetail2Controller",templateUrl:"app/src/app/order/booking_slip_agency/addCustomDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{allCustoms:$scope.selectedItemCustoms,allCustomsScopes:$scope.allCustomsScopes,custom:custom,op:"modify"}}).then(function(data){var masterUuid=$scope.selectedOrderExtendDetail.salesOrderDetail.salesOrderMaster.uuid;
var detailUuid=$scope.selectedOrderExtendDetail.salesOrderDetail.uuid;var orderExtendDetailUuid=$scope.selectedOrderExtendDetail.uuid;var OrderExtendDetail2UpdateInput={itemCustomUuid:data.selectedCustom.itemCustom.uuid,information:data.selectedCustom.information};SalesOrderExtendDetail2.modify(masterUuid,detailUuid,orderExtendDetailUuid,custom.uuid,OrderExtendDetail2UpdateInput).success(function(){$scope.OrderExtendDetailList=[];angular.forEach($scope.OrderDetailList.content,function(orderDetail,
index){SalesOrderExtendDetail.get(orderDetail.salesOrderMaster.uuid,orderDetail.uuid).success(function(data){$scope.OrderExtendDetailList=$scope.OrderExtendDetailList.concat(data.content)})});$scope.showInfo("修改自定义信息成功。")})})};$scope.deleteItemCustom=function(deletedOrderExtendDetail2){$scope.showConfirm("确认删除吗？","删除的自定义信息不可恢复。",function(){if(deletedOrderExtendDetail2){var masterUuid=$scope.selectedOrderExtendDetail.salesOrderDetail.salesOrderMaster.uuid;var detailUuid=$scope.selectedOrderExtendDetail.salesOrderDetail.uuid;
var orderExtendDetailUuid=$scope.selectedOrderExtendDetail.uuid;SalesOrderExtendDetail2.delete(masterUuid,detailUuid,orderExtendDetailUuid,deletedOrderExtendDetail2.uuid).success(function(){angular.forEach($scope.orderExtendDetail2List.content,function(item,index){if(deletedOrderExtendDetail2==item)$scope.orderExtendDetail2List.content.splice(index,1)});$scope.OrderExtendDetailList=[];angular.forEach($scope.OrderDetailList.content,function(orderDetail,index){SalesOrderExtendDetail.get(orderDetail.salesOrderMaster.uuid,
orderDetail.uuid).success(function(data){$scope.OrderExtendDetailList=$scope.OrderExtendDetailList.concat(data.content)})});$scope.showInfo("删除成功。")})}})};$scope.openOrderChannelDlg=function(){$mdDialog.show({controller:"OrderChannelSearchController",templateUrl:"app/src/app/order/booking_slip_agency/selectChannel.html",parent:angular.element(document.body),targetEvent:event}).then(function(data){$scope.selectedItem.channel=data;$scope.selectedItem.channelUuid=data.uuid})};$scope.openOrderCustomerDlg=
function(){$mdDialog.show({controller:"OrderCustomerSearchController",templateUrl:"app/src/app/order/booking_slip_agency/selectCustomer.html",parent:angular.element(document.body),targetEvent:event}).then(function(data){$scope.selectedItem.customer=data;$scope.selectedItem.customerUuid=data.uuid})}});
angular.module("IOne-Production").controller("OrderChannelSearchController",function($scope,$mdDialog,ChannelService){$scope.pageOption={sizePerPage:6,currentPage:0,totalPage:0,totalElements:0,displayModel:0};$scope.refreshChannel=function(){ChannelService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,0,0,$scope.searchKeyword).success(function(data){$scope.allChannel=data;$scope.pageOption.totalElements=data.totalElements;$scope.pageOption.totalPage=data.totalPages})};$scope.refreshChannel();
$scope.selectChannel=function(channel){$scope.channel=channel;$mdDialog.hide($scope.channel)};$scope.hideDlg=function(){$mdDialog.hide($scope.channel)};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").controller("OrderCustomerSearchController",function($scope,$mdDialog,OrderCustomers){$scope.pageOption={sizePerPage:6,currentPage:0,totalPage:0,totalElements:0,displayModel:0};$scope.refreshData=function(){OrderCustomers.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.searchKeyword).success(function(data){$scope.allData=data;$scope.pageOption.totalElements=data.totalElements;$scope.pageOption.totalPage=data.totalPages})};$scope.refreshData();
$scope.selectData=function(data){$scope.data=data;$mdDialog.hide($scope.data)};$scope.hideDlg=function(){$mdDialog.hide($scope.data)};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").controller("OrderItemsSearchController",function($scope,$q,$mdDialog,OrderItems,channelUuid,saleTypes){$scope.channelUuid=channelUuid;$scope.saleTypes=saleTypes;$scope.addOrderDetail={};$scope.pageOption={sizePerPage:6,currentPage:0,totalPage:0,totalElements:0,displayModel:0};$scope.refreshData=function(){OrderItems.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,channelUuid,$scope.searchNo,$scope.searchName).success(function(data){$scope.allData=
data;if($scope.allData.content.length<1)$scope.showError("当前经销商没有商品，请检查渠道定价是否设置。");$scope.pageOption.totalElements=data.totalElements;$scope.pageOption.totalPage=data.totalPages})};$scope.refreshData();$scope.selectData=function(data){$scope.addOrderDetail.item=data;$scope.addOrderDetail.itemUuid=data.uuid;$scope.addOrderDetail.standardPrice=data.standardPrice;$scope.addOrderDetail.saleDiscountRate=data.saleDiscountRate;$scope.addOrderDetail.salePrice=data.salePrice;$scope.addOrderDetail.orderQuantity=
1;angular.forEach($scope.saleTypes,function(saleType,index){if(saleType.name=="常规")$scope.addOrderDetail.saleTypeUuid=saleType.uuid});$scope.addOrderDetail.customizeFlag=2;$scope.addOrderDetail.originalStandardAmount=parseFloat(($scope.addOrderDetail.standardPrice*$scope.addOrderDetail.orderQuantity).toFixed(2));$scope.addOrderDetail.itemUuid=data.uuid};$scope.cancelDlg=function(){$mdDialog.cancel()};$scope.hideDlg=function(){if(null==$scope.addOrderDetail.item)$scope.showError("请选择商品");else if(null==
$scope.addOrderDetail.orderQuantity)$scope.showError("请输入数量");else if(null==$scope.addOrderDetail.originalOrderPrice)$scope.showError("请输入订单单价");else $mdDialog.hide({"addOrderDetail":$scope.addOrderDetail})};$scope.showError=function(info){toastr["error"](info)};$scope.refreshUI=function(saleTypeUuid){$scope.specialPriceDisplay=false;$scope.promotionDisplay=false;angular.forEach($scope.saleTypes,function(saleType,index){if(saleType.uuid==saleTypeUuid){if(saleType.no=="ST05")$scope.specialPriceDisplay=
true;if(saleType.no=="ST07")$scope.promotionDisplay=true}})};$scope.changeOrderPrice=function(){$scope.addOrderDetail.originalOrderAmount=parseFloat(($scope.addOrderDetail.originalOrderPrice*$scope.addOrderDetail.orderQuantity).toFixed(2));$scope.addOrderDetail.discountRate=parseFloat(($scope.addOrderDetail.originalOrderPrice/$scope.addOrderDetail.standardPrice).toFixed(4));$scope.addOrderDetail.originalDiscountAmount=parseFloat(($scope.addOrderDetail.originalStandardAmount-$scope.addOrderDetail.originalOrderAmount).toFixed(2))};
$scope.changeOrderQuantity=function(){$scope.addOrderDetail.originalOrderAmount=parseFloat(($scope.addOrderDetail.originalOrderPrice*$scope.addOrderDetail.orderQuantity).toFixed(2));$scope.addOrderDetail.originalStandardAmount=parseFloat(($scope.addOrderDetail.standardPrice*$scope.addOrderDetail.orderQuantity).toFixed(2));$scope.addOrderDetail.originalDiscountAmount=parseFloat(($scope.addOrderDetail.originalStandardAmount-$scope.addOrderDetail.originalOrderAmount).toFixed(2))};$scope.changeOrderAmout=
function(){$scope.addOrderDetail.originalOrderPrice=parseFloat(($scope.addOrderDetail.originalOrderAmount/$scope.addOrderDetail.orderQuantity).toFixed(2));$scope.addOrderDetail.originalDiscountAmount=parseFloat(($scope.addOrderDetail.originalStandardAmount-$scope.addOrderDetail.originalOrderAmount).toFixed(2))}});
angular.module("IOne-Production").controller("SalesOrderExtendDetail2Controller",function($scope,$mdDialog,allCustoms,allCustomsScopes,custom,op){$scope.allCustoms=allCustoms.content;$scope.allCustomsScopes=allCustomsScopes;$scope.selectedCustom=custom;$scope.op=op;if($scope.selectedCustom)angular.forEach($scope.selectedCustom.informationUuids,function(value,index){angular.forEach($scope.allCustomsScopes[$scope.selectedCustom.itemCustom.uuid],function(item){if(item.uuid==value)item.checked=true})});
else $scope.selectedCustom={informationUuids:[],itemCustom:{astrict:2}};$scope.customChangeHandler=function(customUuid){angular.forEach($scope.allCustoms,function(value,index){if(value.itemCustom.uuid==customUuid)$scope.selectedCustom.itemCustom=value.itemCustom});angular.forEach($scope.allCustomsScopes[$scope.selectedCustom.itemCustom.uuid],function(item){item.checked=false});angular.forEach($scope.selectedCustom.informationUuids,function(value,index){angular.forEach($scope.allCustomsScopes[$scope.selectedCustom.itemCustom.uuid],
function(item){if(item.uuid==value)item.checked=true})});if($scope.selectedCustom.itemCustom.scopeUuid!=undefined)$scope.selectedCustom.itemCustom.scopeUuid=null};$scope.checkBoxChangeHandler=function(data,selected){if(selected==true)$scope.selectedCustom.informationUuids.push(data.uuid);else angular.forEach($scope.selectedCustom.informationUuids,function(value,index){if(value==data.uuid)$scope.selectedCustom.informationUuids.splice(index,1)})};$scope.radioChangeHandler=function(){$scope.selectedCustom.informationUuids=
[];$scope.selectedCustom.informationUuids.push($scope.selectedCustom.itemCustom.scopeUuid)};$scope.hideDlg=function(){$scope.selectedCustom.information=JSON.stringify($scope.selectedCustom.informationUuids);$mdDialog.hide({"selectedCustom":$scope.selectedCustom})};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").controller("SalesOrderExtendDetailController",function($scope,$mdDialog,selectedOrderExtendDetail){$scope.selectedOrderExtendDetail=angular.copy(selectedOrderExtendDetail);$scope.hideDlg=function(){$mdDialog.hide({"selectedOrderExtendDetail":$scope.selectedOrderExtendDetail})};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").controller("SalesOrderDetailController",function($scope,$mdDialog,selectedOrderDetail,saleTypes){$scope.selectedOrderDetail=angular.copy(selectedOrderDetail);$scope.saleTypes=saleTypes;$scope.hideDlg=function(){$mdDialog.hide({"selectedOrderDetail":$scope.selectedOrderDetail})};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/booking-slip-group",{controller:"bookingSlipGroupController",templateUrl:"app/src/app/order/booking_slip_group/bookingSlip.html"})}]);
angular.module("IOne-Production").controller("bookingSlipGroupController",function($scope,bookingSlipGroup,ShoppingCartItemPic,$mdDialog,$timeout,Constant){$scope.listFilterOption={status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value,release:Constant.RELEASE[0].value,prodType:Constant.PROD_TYPE[0].value};$scope.orderListMenu={effectiveType:false,confirm:Constant.AUDIT[0].value,status:Constant.STATUS[0].value,showQueryBar:true};$scope.orderListMenuFilter={selectAll:false};$scope.$watch("orderListMenuFilter",
function(){$scope.selectAllMenuAction()},true);$scope.formMenuDisplayOption={"100-add":{display:true,name:"新增"},"101-delete":{display:true,name:"删除"},"102-edit":{display:true,name:"编辑"},"103-copy":{display:false,name:"复制"},"104-status":{display:false,name:"启用"},"105-confirm":{display:false,name:"审核"},"106-release":{display:false,name:"发布"},"200-cancel":{display:true,name:"取消新增"},"201-save":{display:true,name:"保存"},"300-add":{display:false,name:"新增节点"},"301-delete":{display:false,name:"删除节点"},"302-save":{display:true,
name:"保存"},"303-cancel":{display:true,name:"取消修改"},"304-quit":{display:true,name:"退出编辑"}};$scope.orderListMenuDisplayOption={"400-selectAll":{display:true,name:"全选"},"401-audit":{display:true,name:"审核"},"402-return":{display:true,name:"退回"},"403-throw":{display:true,name:"抛转预订单"},"404-effective":{display:true,name:"失效作废"},"405-query":{display:true,name:"查询"},"406-orderId-input":{display:true,name:"销售单号"},"407-client-input":{display:true,name:"客户"}};$scope.itemOperationMenuDisplayOption={"500-item-edit":{display:true,
name:""},"501-item-delete":{display:true,name:""}};$scope.pageOption={sizePerPage:14,currentPage:0,totalPage:100,totalElements:100};$scope.$watch("listFilterOption",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshAllTemplate()},true);$scope.refreshAllTemplate=function(){bookingSlipGroup.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.confirm,$scope.listFilterOption.status,$scope.listFilterOption.release,
$scope.listFilterOption.prodType).success(function(data){$scope.bookingSlipGroupList=data;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements})};$scope.editItem=function(bookingSlipGroupItem){$scope.selectedItem=bookingSlipGroupItem;$scope.changeViewStatus(Constant.UI_STATUS.PRE_EDIT_UI_STATUS,1)};$scope.listTabSelected=function(){$scope.orderListMenu.showQueryBar=true;$scope.orderListMenuDisplayOption["400-selectAll"].display=true;$scope.orderListMenuFilter.selectAll=
false;$scope.refreshAllTemplate();$scope.selectedItem=null;$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS,0)};$scope.formTabSelected=function(){$scope.orderListMenu.showQueryBar=false;$scope.orderListMenuDisplayOption["400-selectAll"].display=false;if($scope.selectedItem)ShoppingCartItemPic.get($scope.selectedItem.uuid).success(function(data){$scope.picsData=data;$scope.selectedItemPics=[];angular.forEach($scope.picsData.content,function(item){$scope.selectedItemPics.push(Constant.BACKEND_BASE+
"/app/assets/"+item.path)})})};$scope.prodInfoTabSelected=function(){};$scope.deliverInfoTabSelected=function(){};$scope.selected=[];$scope.selectedItemsCount=0;$scope.selectedItemsTotalPrice=0;$scope.toggle=function(item,selected){var idx=selected.indexOf(item);if(idx>-1)selected.splice(idx,1);else selected.push(item);$scope.selectedItemsTotalPrice=0;angular.forEach($scope.selected,function(item){$scope.selectedItemsTotalPrice=$scope.selectedItemsTotalPrice+item.marketPrice});$scope.selectedItemsTotalPrice=
$scope.selectedItemsTotalPrice.toFixed(2);$scope.selectedItemsCount=selected.length};$scope.exists=function(item,list){return list.indexOf(item)>-1};$scope.selectAllMenuAction=function(){if($scope.orderListMenuFilter.selectAll==true){angular.forEach($scope.bookingSlipGroupList.content,function(item){var idx=$scope.selected.indexOf(item);if(idx<0)$scope.selected.push(item)});$scope.selectedItemsTotalPrice=0;angular.forEach($scope.selected,function(item){$scope.selectedItemsTotalPrice=$scope.selectedItemsTotalPrice+
item.marketPrice});$scope.selectedItemsTotalPrice=$scope.selectedItemsTotalPrice.toFixed(2);$scope.selectedItemsCount=$scope.selected.length}else if($scope.orderListMenuFilter.selectAll==false){$scope.selected=[];$scope.selectedItemsCount=0;$scope.selectedItemsTotalPrice=0}};$scope.effectiveMenuAction=function(){if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&scope.selectedTabIndex==1);else if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&scope.selectedTabIndex==0);bookingSlipGroup.getAll($scope.pageOption.sizePerPage,
$scope.pageOption.currentPage,$scope.listFilterOption.confirm,$scope.listFilterOption.status,$scope.listFilterOption.release,$scope.listFilterOption.prodType).success(function(data){$scope.bookingSlipGroupList=data;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements})};$scope.auditMenuAction=function(){bookingSlipGroup.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.confirm,$scope.listFilterOption.status,$scope.listFilterOption.release,
$scope.listFilterOption.prodType).success(function(data){$scope.bookingSlipGroupList=data;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements})};$scope.returnMenuAction=function(){bookingSlipGroup.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.confirm,$scope.listFilterOption.status,$scope.listFilterOption.release,$scope.listFilterOption.prodType).success(function(data){$scope.bookingSlipGroupList=data;$scope.pageOption.totalPage=
data.totalPages;$scope.pageOption.totalElements=data.totalElements})};$scope.throwMenuAction=function(){bookingSlipGroup.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.confirm,$scope.listFilterOption.status,$scope.listFilterOption.release,$scope.listFilterOption.prodType).success(function(data){$scope.bookingSlipGroupList=data;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements})};$scope.queryMenuAction=function(){startDate=
$scope.orderListMenu.startDate;endDate=$scope.orderListMenu.endDate;orderId=$scope.orderListMenu.orderId;clientName=$scope.orderListMenu.clientName;confirm=$scope.orderListMenu.confirm;status=$scope.orderListMenu.status;bookingSlipGroup.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.confirm,$scope.listFilterOption.status,$scope.listFilterOption.release,$scope.listFilterOption.prodType).success(function(data){$scope.bookingSlipGroupList=data;$scope.pageOption.totalPage=
data.totalPages;$scope.pageOption.totalElements=data.totalElements})};$scope.modifyMenuAction=function(){if($scope.selectedItem)bookingSlipGroup.modify($scope.selectedItem).success(function(){$scope.showInfo("修改商品数据成功。")})};$scope.cancelModifyMenuAction=function(){bookingSlipGroup.get($scope.selectedItem.uuid).success(function(data){$scope.selectedItem=data})};$scope.exitModifyMenuAction=function(){$scope.cancelModifyMenuAction();$scope.changeViewStatus($scope.UI_STATUS.PRE_EDIT_UI_STATUS,1)};$scope.preAddMenuAction=
function(){$scope.selectedItem={stopProductionFlag:"N",type:"1"};$scope.selectedItemPics=[];$scope.selectedItemBoms={};$scope.selectedItemCustoms={};$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_ADD,1)};$scope.addMenuAction=function(){if($scope.selectedItem)bookingSlipGroup.add($scope.selectedItem).success(function(data){$scope.selectedItem=data;$scope.changeViewStatus($scope.UI_STATUS.PRE_EDIT_UI_STATUS,1);$scope.showInfo("新增商品成功。")})};$scope.cancelAddMenuAction=function(){$scope.listTabSelected()};
$scope.deleteMenuAction=function(){$scope.showConfirm("确认删除吗？","删除的商品不可恢复。",function(){if($scope.selectedItem)bookingSlipGroup.delete($scope.selectedItem.uuid).success(function(){$scope.showInfo("删除成功。");$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_DELETE,0)})})};$scope.$watchCollection("[selectedItem.status, selectedItem.confirm, selectedItem.release]",function(){if($scope.selectedItem){if($scope.selectedItem.status=="1")$scope.formMenuDisplayOption["104-status"].name="禁用";else if($scope.selectedItem.status==
"2")$scope.formMenuDisplayOption["104-status"].name="启用";if($scope.selectedItem.confirm=="1")$scope.formMenuDisplayOption["105-confirm"].name="审核";else if($scope.selectedItem.confirm=="2")$scope.formMenuDisplayOption["105-confirm"].name="反审核";if($scope.selectedItem.release=="1")$scope.formMenuDisplayOption["106-release"].name="发布";else if($scope.selectedItem.release=="2")$scope.formMenuDisplayOption["106-release"].name="反发布"}});$scope.handler=function(field,value){if($scope.selectedItem&&$scope.selectedItem[field]){$scope.selectedItem[field]=
value;$scope.modifyMenuAction()}};$scope.statusMenuAction=function(){$scope.selectedItem.status=="1"?$scope.handler("status","2"):$scope.handler("status","1")};$scope.confirmMenuAction=function(){if($scope.selectedItem.confirm=="2"&&$scope.selectedItem.release==2){$scope.showWarn("已发布的数据不能取消审核。");return}$scope.selectedItem.confirm=="1"?$scope.handler("confirm","2"):$scope.handler("confirm","1")};$scope.releaseMenuAction=function(){if($scope.selectedItem.release=="1"&&$scope.selectedItem.confirm==
1){$scope.showWarn("未审核的数据不能发布。");return}$scope.selectedItem.release=="1"?$scope.handler("release","2"):$scope.handler("release","1")}});
angular.module("IOne-Production").service("SalesOrderMaster",function($http,Constant){this.getAll=function(sizePerPage,page,confirm,status,transferPsoFlag,orderMasterNo,psoOrderMstNo,customerName,employeeName,orderDateBegin,orderDateEnd,resUuid,channelUuid,allNames,onlyReceipt,contractNo){confirm=confirm==0?"":confirm;status=status==0?"":status;transferPsoFlag=transferPsoFlag==0?"":transferPsoFlag;var url="/salesOrders?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26confirm\x3d"+confirm+"\x26status\x3d"+
status+"\x26transferPsoFlag\x3d"+transferPsoFlag;if(orderMasterNo!==null&&orderMasterNo!=undefined)url=url+"\x26no\x3d"+orderMasterNo;if(psoOrderMstNo!==null&&psoOrderMstNo!=undefined)url=url+"\x26psoOrderMstNo\x3d"+psoOrderMstNo;if(customerName!==null)url=url+"\x26customerName\x3d"+customerName;if(employeeName!==null)url=url+"\x26employeeName\x3d"+employeeName;if(orderDateBegin!==null)url=url+"\x26orderDateBegin\x3d"+orderDateBegin;if(orderDateEnd!==null)url=url+"\x26orderDateEnd\x3d"+orderDateEnd;
if(allNames!==null&&allNames!==undefined)url=url+"\x26allNames\x3d"+allNames;if(channelUuid!=null&&channelUuid!=undefined)url=url+"\x26channelUuid\x3d"+channelUuid;if(onlyReceipt!=null&&onlyReceipt!=undefined)url=url+"\x26onlyReceipt\x3d"+onlyReceipt;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;if(contractNo!==undefined&&contractNo!==null)url=url+"\x26contractNo\x3d"+contractNo;return $http.get(Constant.BACKEND_BASE+url)};this.getOrderMasterCount=function(confirm,status,
transferPsoFlag,resUuid){confirm=confirm==0?"":confirm;status=status==0?"":status;transferPsoFlag=transferPsoFlag==0?"":transferPsoFlag;var url="/salesOrders/count?confirm\x3d"+confirm+"\x26status\x3d"+status+"\x26transferPsoFlag\x3d"+transferPsoFlag;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+"/salesOrders/"+uuid)};this.modify=function(OrderMasterUpdateInput){return $http.patch(Constant.BACKEND_BASE+
"/salesOrders/"+OrderMasterUpdateInput.uuid,OrderMasterUpdateInput)};this.add=function(OrderMasterInput){return $http.post(Constant.BACKEND_BASE+"/salesOrders/",OrderMasterInput)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/salesOrders/"+uuid)}});
angular.module("IOne-Production").service("SalesOrderDetail",function($http,Constant){this.get=function(masterUuid){return $http.get(Constant.BACKEND_BASE+"/salesOrders/"+masterUuid+"/details")};this.modify=function(masterUuid,uuid,OrderDetailUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/salesOrders/"+masterUuid+"/details/"+uuid,OrderDetailUpdateInput)};this.getAllCountByMasterUuids=function(orderMasterUuids){var url="salesOrders/"+orderMasterUuids+"/count/";return $http.get(Constant.BACKEND_BASE+
url)};this.add=function(masterUuid,OrderDetailInput){return $http.post(Constant.BACKEND_BASE+"/salesOrders/"+masterUuid+"/details/",OrderDetailInput)};this.delete=function(masterUuid,detailUuid){return $http.delete(Constant.BACKEND_BASE+"/salesOrders/"+masterUuid+"/details/"+detailUuid)}});
angular.module("IOne-Production").service("SalesOrderExtendDetail",function($http,Constant){this.get=function(masterUuid,detailUuid){return $http.get(Constant.BACKEND_BASE+"/salesOrders/"+masterUuid+"/details/"+detailUuid+"/extends/")};this.modify=function(masterUuid,detailUuid,uuid,OrderExtendDetailUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/salesOrders/"+masterUuid+"/details/"+detailUuid+"/extends/"+uuid,OrderExtendDetailUpdateInput)}});
angular.module("IOne-Production").service("SalesOrderExtendDetail2",function($http,Constant){this.get=function(masterUuid,detailUuid,orderExtendDetailUuid){return $http.get(Constant.BACKEND_BASE+"/salesOrders/"+masterUuid+"/details/"+detailUuid+"/extends/"+orderExtendDetailUuid+"/extend2s/")};this.modify=function(masterUuid,detailUuid,orderExtendDetailUuid,uuid,OrderExtendDetail2UpdateInput){return $http.patch(Constant.BACKEND_BASE+"/salesOrders/"+masterUuid+"/details/"+detailUuid+"/extends/"+orderExtendDetailUuid+
"/extend2s/"+uuid,OrderExtendDetail2UpdateInput)};this.add=function(masterUuid,detailUuid,orderExtendDetailUuid,OrderExtendDetail2Input){return $http.post(Constant.BACKEND_BASE+"/salesOrders/"+masterUuid+"/details/"+detailUuid+"/extends/"+orderExtendDetailUuid+"/extend2s/",OrderExtendDetail2Input)};this.delete=function(masterUuid,detailUuid,orderExtendDetailUuid,uuid){return $http.delete(Constant.BACKEND_BASE+"/salesOrders/"+masterUuid+"/details/"+detailUuid+"/extends/"+orderExtendDetailUuid+"/extend2s/"+
uuid)}});angular.module("IOne-Production").service("OrderCustomers",function($http,Constant){this.getAll=function(sizePerPage,page,name){var url="/customers?size\x3d"+sizePerPage+"\x26page\x3d"+page;if(name!==undefined&&name!==null)url=url+"\x26name\x3d"+name;return $http.get(Constant.BACKEND_BASE+url)}});
angular.module("IOne-Production").service("OrderItems",function($http,Constant){this.getAll=function(sizePerPage,page,channelUuid,no,name){var url="/channelPrices/"+channelUuid+"/items?size\x3d"+sizePerPage+"\x26page\x3d"+page;if(no!==undefined&&no!==null)url=url+"\x26no\x3d"+no;if(name!==undefined&&name!==null)url=url+"\x26name\x3d"+name;return $http.get(Constant.BACKEND_BASE+url)}});
angular.module("IOne-Production").service("OrderChannelCurrency",function($http,Constant){this.getAll=function(){return $http.get(Constant.BACKEND_BASE+"/channelCurrencies/")}});angular.module("IOne-Production").service("OrderChannelTax",function($http,Constant){this.getAll=function(){return $http.get(Constant.BACKEND_BASE+"/channelTaxes/")}});angular.module("IOne-Production").service("PSOdeliverWays",function($http,Constant){this.getAll=function(){return $http.get(Constant.BACKEND_BASE+"/deliverWays/")}});
angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/salesOrder-change",{controller:"SalesOrderChangeController",templateUrl:"app/src/app/order/booking_slip_agency_change/bookingSlipChange.html"})}]);
angular.module("IOne-Production").controller("SalesOrderChangeController",function($q,$scope,SalesOrderChangeMaster,SalesOrderChangeDetail,SalesOrderChangeExtendDetail,SalesOrderChangeExtendDetail2,Constant){$scope.selectedItemSize=0;$scope.selectedItemAmount=0;$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={select:{status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value,transferPsoFlag:Constant.TRANSFER_PSO_FLAG[0].value},onlyLatest:"2"};
$scope.menuDisplayOption={"confirm":{display:true,name:"审核",uuid:"94b40025-f908-40e4-8237-26a816a837db"},"revertConfirm":{display:true,name:"取审",uuid:"f1c87d92-2979-482b-8577-4a94410bd369"},"transfer":{display:true,name:"抛转",uuid:"66586826-5f8d-4645-8db7-7d11c9559887"},"batchConfirm":{display:true,name:"批量审核",uuid:"9fea08e7-1428-48f0-9c5d-0f65de3dfbaa"},"batchRevertConfirm":{display:true,name:"批量取审",uuid:"07f4f819-ff6c-459b-9e9b-679a9491c30b"},"batchTransfer":{display:true,name:"批量拋转",uuid:"66d9553b-2ce6-4f5b-ba6a-78af9d613549"},
"detailConfirm":{display:true,name:"审核",uuid:"4c4f7396-a8bd-4b15-8c93-7491c40e25ad"},"detailRevertConfirm":{display:true,name:"取审",uuid:"15b5713e-9234-4a07-8ce7-2aae0b8929b5"},"detailTransfer":{display:true,name:"抛转",uuid:"d1da8e5d-504c-4dc5-95c8-b9e6834c17f4"}};$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.refreshList=function(){SalesOrderChangeMaster.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption).success(function(data){$scope.itemList=
data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;$scope.disableBatchMenuButtons()}).error(function(response){$scope.showError(response.message)})};$scope.getMenuAuthData($scope.RES_UUID_MAP.PSO.SO_CHANGE.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)});$scope.$watch("listFilterOption.select",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},
true);$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()}};$scope.queryClick=function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()};$scope.selectAllFlag=false;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;SalesOrderChangeDetail.get($scope.selectedItem.uuid).success(function(data){$scope.selectedItem.detailList=
data.content}).error(function(response){$scope.showError(response.message)})};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;$scope.selectedItem=null};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;SalesOrderChangeDetail.get(item.uuid).success(function(data){item.detailList=data.content}).error(function(response){$scope.showError(response.message)})};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=
!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS)};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=
function(){if($scope.status=="add")if($scope.domain=="PSO_ORDER_MST")console.info("add order mst...");else{if($scope.domain=="PSO_ORDER_DTL")console.info("add order dtl...")}else if($scope.status=="edit")if($scope.domain=="PSO_ORDER_MST")console.info("edit order mst...");else if($scope.domain=="PSO_ORDER_DTL")console.info("edit order dtl...")};$scope.deleteDetailAction=function(detail){};$scope.selectItemAction=function(event,item){$scope.stopEventPropagation(event);item.selectedRef=!item.selected;
if(item.selected==false||item.selected==undefined||item.selected==null){$scope.selectedItemSize+=1;$scope.selectedItemAmount+=item.originalOrderAmount}else{$scope.selectedItemSize-=1;$scope.selectedItemAmount-=item.originalOrderAmount;$scope.selectAllFlag=false}$scope.disableBatchMenuButtons()};$scope.confirmClickAction=function(event,item,confirmVal){$scope.stopEventPropagation(event);console.info("confirm...");var action="审核";var popMessage="审核后变更将会生效，确认审核吗？";if(confirmVal==Constant.CONFIRM[1].value){action=
"取消审核";popMessage="取消审核后预订单单将会回退到之前版本，确认取消审核吗？"}$scope.showConfirm(popMessage,"",function(){SalesOrderChangeMaster.confirm(item.uuid,confirmVal).success(function(){item.confirm=confirmVal;$scope.updateOrderChangeDetailsConfirm(item);$scope.showInfo("预订单变更单"+action+"成功！");$scope.disableBatchMenuButtons();$scope.getOrderMasterCount()}).error(function(response){$scope.showError(response.message)})})};$scope.statusClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("confirm...");
$scope.showConfirm("确认启用吗？","",function(){SalesOrderChangeMaster.modify(item.uuid,{"status":"1"}).success(function(){item.status=Constant.STATUS[1].value;$scope.showInfo("启用成功！");$scope.disableBatchMenuButtons();$scope.getOrderMasterCount()}).error(function(response){$scope.showError(response.message)})})};$scope.cancelStatusClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("confirm...");$scope.showConfirm("确认禁用吗？","",function(){SalesOrderChangeMaster.modify(item.uuid,
{"status":"2"}).success(function(){item.status=Constant.STATUS[2].value;$scope.showInfo("禁用成功！");$scope.disableBatchMenuButtons();$scope.getOrderMasterCount()}).error(function(response){$scope.showError(response.message)})})};$scope.transferClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("transfer...");$scope.showConfirm("确认抛转吗？","",function(){var uuids=[];uuids.push(item.uuid);SalesOrderChangeMaster.transfer(uuids).success(function(response){if(response&&response[0].code!=
0)$scope.showError("抛转失败："+response[0].msg);else{item.transferFlag=Constant.TRANSFER_PSO_FLAG[1].value;$scope.updateOrderChangeDetailsTransfer(item);$scope.showInfo("预订单变更抛转成功！");$scope.disableBatchMenuButtons();$scope.getOrderMasterCount()}}).error(function(response){$scope.showError(response.message)})})};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("delete...")};$scope.confirmAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==
0){$scope.showWarn("请先选择记录！");return}$scope.showConfirm("确认审核吗","",function(){var promises=[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected){var response=SalesOrderChangeMaster.confirm(item.uuid,"2").success(function(){item.confirm="2";$scope.updateOrderChangeDetailsConfirm(item)}).error(function(response){bError=true;$scope.showError(item.no+" 审核失败："+response.message)});promises.push(response)}});$q.all(promises).then(function(data){if(!bError){$scope.showInfo("审核成功！");
$scope.getOrderMasterCount()}$scope.disableBatchMenuButtons()})})};$scope.cancelConfirmAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");return}$scope.showConfirm("确认取消审核吗","",function(){var promises=[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected){var response=SalesOrderChangeMaster.confirm(item.uuid,"1").success(function(){item.confirm="1";$scope.updateOrderChangeDetailsConfirm(item)}).error(function(response){bError=
true;$scope.showError(item.no+" 取消审核失败："+response.message)});promises.push(response)}});$q.all(promises).then(function(data){if(!bError){$scope.showInfo("取消审核成功！");$scope.getOrderMasterCount()}$scope.disableBatchMenuButtons()})})};$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");return}$scope.showConfirm("确认启用吗","",function(){var promises=[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected){var response=
SalesOrderChangeMaster.modify(item.uuid,{"status":"1"}).success(function(){item.status=Constant.STATUS[1].value}).error(function(response){bError=true;$scope.showError(item.no+" 启用失败："+response.message)});promises.push(response)}});$q.all(promises).then(function(data){if(!bError){$scope.showInfo("启用成功！");$scope.getOrderMasterCount()}$scope.disableBatchMenuButtons()})})};$scope.cancelStatusAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");
return}$scope.showConfirm("确认禁用吗","",function(){var promises=[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected){var response=SalesOrderChangeMaster.modify(item.uuid,{"status":"2"}).success(function(){item.status=Constant.STATUS[2].value}).error(function(response){bError=true;$scope.showError(item.no+" 禁用失败："+response.message)});promises.push(response)}});$q.all(promises).then(function(data){if(!bError){$scope.showInfo("禁用成功！");$scope.getOrderMasterCount()}$scope.disableBatchMenuButtons()})})};
$scope.transferAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");return}$scope.showConfirm("确认抛转吗","",function(){var uuids=[];angular.forEach($scope.itemList,function(item){if(item.selected)uuids.push(item.uuid)});var response=SalesOrderChangeMaster.transfer(uuids).success(function(){angular.forEach($scope.itemList,function(item){if(item.selected){item.transferFlag=Constant.TRANSFER_PSO_FLAG[1].value;$scope.updateOrderChangeDetailsTransfer(item)}});
$scope.showInfo("抛转成功！");$scope.getOrderMasterCount()}).error(function(response){$scope.showError(item.no+" 抛转失败："+response.message)})})};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("delete all...")};$scope.selectAllAction=function(){angular.forEach($scope.itemList,function(item){if($scope.selectAllFlag)item.selected=true;else item.selected=false;item.selectedRef=item.selected});$scope.selectedItemSize=0;$scope.selectedItemAmount=0;if($scope.selectAllFlag)angular.forEach($scope.itemList,
function(item){$scope.selectedItemSize++;$scope.selectedItemAmount+=item.originalOrderAmount});$scope.disableBatchMenuButtons()};$scope.refreshExtendDetailTab=function(selectedItem){$scope.selectedItem.extendDetailList=[];angular.forEach($scope.selectedItem.detailList,function(orderDetail,index){SalesOrderChangeExtendDetail.get(selectedItem.uuid,orderDetail.uuid).success(function(data){if(data.totalElements>0)$scope.selectedItem.extendDetailList=$scope.selectedItem.extendDetailList.concat(data.content)}).error(function(response){$scope.showError(response.message)})})};
$scope.disableBatchMenuButtons=function(){var selectedCount=0;var confirm="";var status="";var transferFlag="";var diffConfirm=false;var diffStatus=false;var diffTransferFlag=false;angular.forEach($scope.itemList,function(item,index){if(item.selectedRef){selectedCount++;if(confirm=="")confirm=item.confirm;else if(confirm!=item.confirm)diffConfirm=true;if(status=="")status=item.status;else if(status!=item.status)diffStatus=true;if(transferFlag=="")transferFlag=item.transferFlag;else if(transferFlag!=
item.transferFlag)diffTransferFlag=true}});if(selectedCount==0){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchTransfer=true}else{if(diffConfirm==true){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true}else if(confirm=="2"){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=false}else{$scope.disabledBatchConfirm=false;$scope.disabledBatchCancelConfirm=
true}if(diffStatus==true){$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true}else if(status=="1"){$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=false}else{$scope.disabledBatchStatus=false;$scope.disabledBatchCancelStatus=true}if(diffTransferFlag==true)$scope.disabledBatchTransfer=true;else if(transferFlag=="1")$scope.disabledBatchTransfer=true;else $scope.disabledBatchTransfer=false}};$scope.updateOrderChangeDetailsConfirm=function(item){if(item.detailList!=null)angular.forEach(item.detailList,
function(detail){detail.confirm=item.confirm})};$scope.updateOrderChangeDetailsTransfer=function(item){if(item.detailList!=null)angular.forEach(item.detailList,function(detail){detail.transferFlag=item.transferFlag})};$scope.getOrderMasterCount=function(){SalesOrderChangeMaster.getOrderMasterCount(Constant.CONFIRM[1].value,Constant.STATUS[1].value,Constant.TRANSFER_PSO_FLAG[2].value,RES_UUID_MAP.PSO.SO_CHANGE.RES_UUID).success(function(data){$scope.menuList[1].subList[6].suffix=data})}});
angular.module("IOne-Production").service("SalesOrderChangeMaster",function($http,Constant){this.getAll=function(sizePerPage,page,filter){var confirm=filter.select.confirm==0?"":filter.select.confirm;var status=filter.select.status==0?"":filter.select.status;var transferPsoFlag=filter.select.transferPsoFlag==0?"":filter.select.transferPsoFlag;var url="/salesOrderChanges?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26confirm\x3d"+confirm+"\x26status\x3d"+status+"\x26transferFlag\x3d"+transferPsoFlag;
if(filter.no!=null)url=url+"\x26no\x3d"+filter.no;if(filter.psoOrderMstNo!=null)url=url+"\x26psoOrderMstNo\x3d"+filter.psoOrderMstNo;if(filter.customerName!=null)url=url+"\x26customerName\x3d"+filter.customerName;if(filter.onlyLatest!=null)url=url+"\x26onlyLatest\x3d"+filter.onlyLatest;if(filter.startOrderDate!=null){var startOrderDate=new Date(filter.select.startOrderDate);startOrderDate=moment(startOrderDate).format("YYYY-MM-DD 00:00:00");url=url+"\x26orderDateBegin\x3d"+startOrderDate}if(filter.endOrderDate!=
null){var endOrderDate=new Date(filter.select.endOrderDate);endOrderDate=moment(endOrderDate).format("YYYY-MM-DD 23:59:59");url=url+"\x26orderDateEnd\x3d"+endOrderDate}return $http.get(Constant.BACKEND_BASE+url)};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+"/salesOrderChanges/"+uuid)};this.modify=function(uuid,OrderMasterUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/salesOrderChanges/"+uuid,OrderMasterUpdateInput)};this.add=function(OrderMasterInput){return $http.post(Constant.BACKEND_BASE+
"/salesOrderChanges/",OrderMasterInput)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/salesOrderChanges/"+uuid)};this.confirm=function(uuids,confirmVal){return $http.patch(Constant.BACKEND_BASE+"/salesOrderChanges/"+uuids,{"modifyOnly":"1","confirm":confirmVal})};this.transfer=function(arrayUuids){return $http.patch(Constant.BACKEND_BASE+"/salesOrderChanges?action\x3dsync",arrayUuids.join(","))};this.getOrderMasterCount=function(confirm,status,transferFlag,resUuid){confirm=
confirm==0?"":confirm;status=status==0?"":status;transferFlag=transferFlag==0?"":transferFlag;var url="/salesOrderChanges/count?confirm\x3d"+confirm+"\x26status\x3d"+status+"\x26transferFlag\x3d"+transferFlag+"\x26onlyLatest\x3d2";if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)}});
angular.module("IOne-Production").service("SalesOrderChangeDetail",function($http,Constant){this.get=function(salesOrderChangeMasterUuid){return $http.get(Constant.BACKEND_BASE+"/salesOrderChanges/"+salesOrderChangeMasterUuid+"/details")};this.modify=function(salesOrderChangeMasterUuid,uuid,salesOrderChangeDetailUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/salesOrderChanges/"+salesOrderChangeMasterUuid+"/details/"+uuid,salesOrderChangeDetailUpdateInput)};this.add=function(salesOrderChangeMasterUuid,
salesOrderChangeDetailInput){return $http.post(Constant.BACKEND_BASE+"/salesOrderChanges/"+salesOrderChangeMasterUuid+"/details/",salesOrderChangeDetailInput)};this.delete=function(salesOrderChangeMasterUuid,salesOrderChangeDetailsUuid){return $http.delete(Constant.BACKEND_BASE+"/salesOrderChanges/"+salesOrderChangeMasterUuid+"/details/"+salesOrderChangeDetailsUuid)}});
angular.module("IOne-Production").service("SalesOrderChangeExtendDetail",function($http,Constant){this.get=function(salesOrderChangeMasterUuid,salesOrderChangeDetailsUuid){return $http.get(Constant.BACKEND_BASE+"/salesOrderChanges/"+salesOrderChangeMasterUuid+"/details/"+salesOrderChangeDetailsUuid+"/extends")};this.modify=function(salesOrderChangeMasterUuid,salesOrderChangeDetailsUuid,uuid,salesOrderChangeExtendDetailUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/salesOrderChanges/"+salesOrderChangeMasterUuid+
"/details/"+salesOrderChangeDetailsUuid+"/extends/"+uuid,salesOrderChangeExtendDetailUpdateInput)}});
angular.module("IOne-Production").service("SalesOrderChangeExtendDetail2",function($http,Constant){this.get=function(salesOrderChangeMasterUuid,salesOrderChangeDetailsUuid,salesOrderChangeExtendDetailUuid){return $http.get(Constant.BACKEND_BASE+"/salesOrderChanges/"+salesOrderChangeMasterUuid+"/details/"+salesOrderChangeDetailsUuid+"/extends/"+salesOrderChangeExtendDetailUuid+"/extend2s/")};this.modify=function(salesOrderChangeMasterUuid,salesOrderChangeDetailsUuid,salesOrderChangeExtendDetailUuid,
uuid,salesOrderChangeExtendDetail2UpdateInput){return $http.patch(Constant.BACKEND_BASE+"/salesOrderChanges/"+salesOrderChangeMasterUuid+"/details/"+salesOrderChangeDetailsUuid+"/extends/"+salesOrderChangeExtendDetailUuid+"/extend2s/"+uuid,salesOrderChangeExtendDetail2UpdateInput)};this.add=function(salesOrderChangeMasterUuid,salesOrderChangeDetailsUuid,salesOrderChangeExtendDetailUuid,salesOrderChangeExtendDetail2Input){return $http.post(Constant.BACKEND_BASE+"/salesOrderChanges/"+salesOrderChangeMasterUuid+
"/details/"+salesOrderChangeDetailsUuid+"/extends/"+salesOrderChangeExtendDetailUuid+"/extend2s/",salesOrderChangeExtendDetail2Input)};this.delete=function(salesOrderChangeMasterUuid,salesOrderChangeDetailsUuid,salesOrderChangeExtendDetailUuid,uuid){return $http.delete(Constant.BACKEND_BASE+"/salesOrderChanges/"+salesOrderChangeMasterUuid+"/details/"+salesOrderChangeDetailsUuid+"/extends/"+salesOrderChangeExtendDetailUuid+"/extend2s/"+uuid)}});
angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/plm/brand_file",{controller:"BrandController",templateUrl:"app/src/app/plm/brand_file/brand.html"})}]);
angular.module("IOne-Production").controller("BrandController",function($scope,BrandFile,BrandPic,Constant,$mdDialog,$timeout,$q,Upload){$scope.BRAND_TYPE=Constant.BRAND_TYPE;$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={select:{status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value,prodType:Constant.PROD_TYPE[0].value},no:"",name:"",keyWord:""};$scope.menuDisplayOption={"batchDelete":{display:true,name:"批量删除",uuid:"f08c9c62-b96e-4a1d-afa9-0f2d17f3ad70"},
"detailDelete":{display:true,name:"删除",uuid:"624e0daa-036a-466a-b829-7967335910c7"}};$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true;$scope.sortByField="no";$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.refreshList=function(){BrandFile.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.no,$scope.listFilterOption.name,
$scope.listFilterOption.keyWord,$scope.RES_UUID_MAP.CBI.BRAND_FILE.RES_UUID).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;$scope.selectAllFlag=false;$scope.selectedItemSize=0;angular.element($('img[ng-src\x3d""]')).prop("src","")})};$scope.getMenuAuthData($scope.RES_UUID_MAP.CBI.BRAND_FILE.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)});$scope.$watch("listFilterOption.select",
function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()}};$scope.selectAllFlag=false;$scope.selectedItemSize=0;$scope.selected=[];$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;$scope.selectedItem.discountRatePercentage=(Math.round($scope.selectedItem.discountRate*
1E4)/100).toFixed(2)+"%";item.detailList=$scope.subItemList;$scope.displayAdvancedSearPanel=false;$scope.selectedItem.brandImagePath=jQuery.isEmptyObject(item.path)||item.path==null?"":item.path.indexOf("IMAGE")==0?item.path:Constant.BACKEND_BASE+"/app/assets/IMAGE/"+item.path;angular.element($('img[ng-src\x3d""]')).prop("src","");$scope.refreshList()};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;$scope.selectedItem=null};$scope.toggleMorePanelAction=
function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel)item.detailList=item};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);$scope.refreshList();if($scope.status=="edit")$scope.selectedItem.discountRatePercentage=(Math.round($scope.selectedItem.discountRate*1E4)/100).toFixed(2)+"%"};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);
$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain;$scope.selectedItemBackUp=angular.copy($scope.selectedItem);$scope.selectedItem.brandImagePath=jQuery.isEmptyObject($scope.source.path)||$scope.source.path==null?"":$scope.source.path.indexOf("IMAGE")==0?$scope.source.path:Constant.BACKEND_BASE+"/app/assets/IMAGE/"+$scope.source.path};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=
desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.status=="add"){if($scope.domain=="PLM_BASE_BRAND_FILE")BrandFile.add($scope.source).success(function(data){if("undefined"!=$scope.source.itemPathsUuid&&$scope.source.itemPathsUuid!=null)BrandPic.addImage(data.uuid,$scope.source.itemPathsUuid).success(function(response){$scope.source.path=$scope.getImageFullPath(response.path)+"?time\x3d"+(new Date).getTime();$("md-input-container input[ng-model\x3dsource\\[key\\]]:gt(0)").prop("disabled",
true);$scope.source.brandImagePath=$scope.source.path;$scope.showInfo("新增数据成功。");$scope.refreshList()}).error(function(data){$scope.showError("新增失败:"+"\x3cbr\x3e"+data.message);$scope.refreshList()});else{$scope.showInfo("新增数据成功。");$scope.refreshList()}}).error(function(data){$scope.showError("新增失败:"+"\x3cbr\x3e"+data.message);$scope.refreshList()})}else if($scope.status=="edit")if($scope.domain=="PLM_BASE_BRAND_FILE")BrandFile.modify($scope.source.uuid,$scope.source).success(function(data){$scope.showInfo("修改数据成功。");
$scope.source=data;$scope.selectedItem=data;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)}).error(function(data){$scope.showError("修改失败:"+"\x3cbr\x3e"+data.message);$scope.source=angular.copy($scope.selectedItemBackUp);$scope.selectedItem=angular.copy($scope.selectedItemBackUp)})};$scope.selectItemAction=function(event,item){$scope.stopEventPropagation(event);item.selectedRef=!item.selected;if(item.selected==false||item.selected==undefined||item.selected==null){$scope.selectedItemSize+=
1;$scope.selected.push(item)}else{$scope.selectedItemSize-=1;$scope.selectAllFlag=false;$scope.selected.pop(item)}$scope.disableBatchMenuButtons()};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){BrandFile.delete(item.uuid).success(function(){$scope.selectedItem=null;$scope.refreshList();$scope.showInfo("删除数据成功。");$scope.refreshList()})})};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);
if($scope.selectedItemSize>0)$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(item){var response=BrandFile.delete(item.uuid).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("删除数据成功。");$scope.refreshList();$scope.selectItemCount=0})}})};$scope.selectAllAction=function(){angular.forEach($scope.itemList,function(item){if($scope.selectAllFlag)item.selected=true;else item.selected=
false;item.selectedRef=item.selected});$scope.selectedItemSize=0;$scope.selectedItemAmount=0;$scope.selected.length=0;if($scope.selectAllFlag)angular.forEach($scope.itemList,function(item){$scope.selectedItemSize++;$scope.selected.push(item)});$scope.disableBatchMenuButtons()};$scope.cleanImage=function(){$scope.showConfirm("确认移除吗？","移除后不可恢复。",function(){if($scope.selectedItem&&$scope.selectedItem.uuid)BrandPic.deleteImage($scope.selectedItem.uuid).success(function(response){$scope.selectedItem.path=
"";$scope.selectedItem.brandImagePath="";$scope.refreshList()})})};$scope.uploadImage=function(files){$scope.progress={value:0};if(files&&files.length)for(var i=0;i<files.length;i++){var file=files[i];Upload.upload({url:Constant.BACKEND_BASE+"/files",fields:{},file:file}).progress(function(evt){$scope.progress.value=Math.min(100,parseInt(99*evt.loaded/evt.total))}).success(function(data){$timeout(function(){if($scope.status=="add"){$scope.source.path=$scope.getImageFullPath(data.path)+"?time\x3d"+
(new Date).getTime();$("md-input-container input[ng-model\x3dsource\\[key\\]]:gt(0)").prop("disabled",true);$scope.source.itemPathsUuid=data.uuid;$scope.source.brandImagePath=$scope.source.path}else if($scope.selectedItem&&$scope.selectedItem.uuid)BrandPic.addImage($scope.selectedItem.uuid,data.uuid).success(function(response){$scope.source.path=$scope.getImageFullPath(response.path)+"?time\x3d"+(new Date).getTime();$("md-input-container input[ng-model\x3dsource\\[key\\]]:gt(0)").prop("disabled",
true);$scope.selectedItem.brandImagePath=$scope.source.path})})}).error(function(data){$scope.source.path=$scope.getImageFullPath("test")+"?time\x3d"+(new Date).getTime();$("md-input-container input[ng-model\x3dsource\\[key\\]]:gt(0)").prop("disabled",true);$scope.showError(data.code)})}};$scope.disableBatchMenuButtons=function(){var selectedCount=0;var confirm="";var status="";var diffConfirm=false;var diffStatus=false;angular.forEach($scope.itemList,function(item,index){if(item.selectedRef){selectedCount++;
if(confirm=="")confirm=item.confirm;else if(confirm!=item.confirm)diffConfirm=true;if(status=="")status=item.status;else if(status!=item.status)diffStatus=true}});if(selectedCount==0){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}else{if(diffConfirm==true){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchDelete=false}else if(confirm==
"2"){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=false;$scope.disabledBatchDelete=false}else{$scope.disabledBatchConfirm=false;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchDelete=false}if(diffStatus==true){$scope.disabledBatchConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=false}else if(status=="1"){$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=false}else{$scope.disabledBatchConfirm=
true;$scope.disabledBatchStatus=false;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=false}}}});
angular.module("IOne-Production").service("BrandFile",function($http,Constant){this.getAll=function(sizePerPage,page,brandNo,brandName){var url="/brands?size\x3d"+sizePerPage+"\x26page\x3d"+page;if(brandNo!==undefined&&brandNo!==null)url=url+"\x26no\x3d"+brandNo;if(brandName!==undefined&&brandName!==null)url=url+"\x26name\x3d"+brandName;return $http.get(Constant.BACKEND_BASE+url)};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+"/brands/"+uuid)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+
"/brands/"+uuid)};this.modify=function(uuid,UpdateInput){return $http.patch(Constant.BACKEND_BASE+"/brands/"+uuid,UpdateInput)};this.add=function(AddInput){return $http.post(Constant.BACKEND_BASE+"/brands/",AddInput)}});
angular.module("IOne-Production").service("BrandPic",function($http,Constant){this.addImage=function(brandUuid,itemPathsUuid){return $http.post(Constant.BACKEND_BASE+"/brands/"+brandUuid+"/images",{imageFileUuid:itemPathsUuid})};this.deleteImage=function(brandUuid){return $http.delete(Constant.BACKEND_BASE+"/brands/"+brandUuid+"/images")}});
angular.module("IOne-Production").service("CatalogueTemplate",function($http,Constant){this.getAll=function(sizePerPage,page,status,confirm,release,includeEmpty){confirm=confirm==0?"":confirm;release=release==0?"":release;status=status==0?"":status;if(includeEmpty==undefined)includeEmpty=true;return $http.get(Constant.BACKEND_BASE+"/catalogueTemplates?status\x3d"+status+"\x26confirm\x3d"+confirm+"\x26release\x3d"+release+"\x26page\x3d"+page+"\x26size\x3d"+sizePerPage+"\x26includeEmpty\x3d"+includeEmpty)};
this.getAll2=function(){return $http.get(Constant.BACKEND_BASE+"/catalogueTemplates?status\x3d\x26confirm\x3d\x26release\x3d")};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+"/catalogueTemplates/"+uuid)};this.add=function(template){return $http.post(Constant.BACKEND_BASE+"/catalogueTemplates/",template)};this.copy=function(template,body){return $http.post(Constant.BACKEND_BASE+"/catalogueTemplates?from\x3d"+template.uuid,body)};this.modify=function(template){return $http.patch(Constant.BACKEND_BASE+
"/catalogueTemplates/"+template.uuid,template)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/catalogueTemplates/"+uuid)};this.addNode=function(uuid,node){return $http.post(Constant.BACKEND_BASE+"/catalogueTemplates/"+uuid+"/details",node)};this.modifyNode=function(uuid,node){return $http.patch(Constant.BACKEND_BASE+"/catalogueTemplates/"+uuid+"/details/"+node.uuid,node)};this.deleteNode=function(templateUuid,uuid){return $http.delete(Constant.BACKEND_BASE+"/catalogueTemplates/"+
templateUuid+"/details/"+uuid)};this.clearData=function(templateUuid){return $http.delete(Constant.BACKEND_BASE+"/catalogueTemplates/"+templateUuid+"?catalogueOnly")};this.createDefault=function(){return template={"terminalType":null,"terminalMac":null,"terminalIp":null,"createUserUuid":null,"createDate":null,"modiUserUuid":null,"modiDate":null,"release":"1","status":"1","confirm":"1","no":"","name":"","dataStatus":null,"dataConfirm":null,"dataRelease":null,"details":[]}};this.createDefaultTemplateNode=
function(){return{"terminalType":null,"terminalMac":null,"terminalIp":null,"createUserUuid":null,"createDate":null,"modiUserUuid":null,"modiDate":null,"no":null,"name":null,"parentUuid":null,"defaultFlag":"Y","type":"1"}}});
angular.module("IOne-Production").service("Catalogue",function($http,Constant){this.getForRoot=function(templateDetailUuid){return $http.get(Constant.BACKEND_BASE+"/catalogues?templateDetailUuid\x3d"+templateDetailUuid)};this.getForRootWithFilter=function(templateDetailUuid,resUuid){var url="/catalogues?templateDetailUuid\x3d"+templateDetailUuid;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)};this.getWithFilter=function(templateDetailUuid,
parentUuid,resUuid){var url="/catalogues?templateDetailUuid\x3d"+templateDetailUuid+"\x26parentUuid\x3d"+parentUuid;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)};this.get=function(templateDetailUuid,parentUuid,resUuid){if(resUuid==undefined)resUuid="";return $http.get(Constant.BACKEND_BASE+"/catalogues?templateDetailUuid\x3d"+templateDetailUuid+"\x26parentUuid\x3d"+parentUuid+"\x26resUuid\x3d"+resUuid)};this.add=function(templateNodeData){return $http.post(Constant.BACKEND_BASE+
"/catalogues",templateNodeData)};this.modify=function(templateNodeData){return $http.patch(Constant.BACKEND_BASE+"/catalogues/"+templateNodeData.uuid,templateNodeData)};this.delete=function(templateNodeUuid){return $http.delete(Constant.BACKEND_BASE+"/catalogues/"+templateNodeUuid)};this.backup=function(templateNodeData){return{no:templateNodeData.no,name:templateNodeData.name,confirm:templateNodeData.confirm,release:templateNodeData.release,status:templateNodeData.status}};this.recover=function(templateNodeData,
backup){if(templateNodeData&&backup){templateNodeData.no=backup.no;templateNodeData.name=backup.name;templateNodeData.confirm=backup.confirm;templateNodeData.release=backup.release;templateNodeData.status=backup.status}return templateNodeData};this.addImage=function(templateNodeDataUuid,fileUuid){return $http.post(Constant.BACKEND_BASE+"/catalogues/"+templateNodeDataUuid+"/images",{imageFileUuid:fileUuid})}});
angular.module("IOne-Production").service("CBIEmployeeService",function($http,Constant){this.getAll=function(sizePerPage,page,confirm,status,theMax,resUuid){confirm=confirm==0?"":confirm;status=status==0?"":status;var url="/employees?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26confirm\x3d"+confirm+"\x26status\x3d"+status;if(theMax!==undefined&&theMax!==null)url=url+"\x26globalQuery\x3d"+theMax;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+
url)};this.getByNo=function(no){return $http.get(Constant.BACKEND_BASE+"/employees?no\x3d"+no)};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+"/employees/"+uuid)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/employees/"+uuid)};this.modify=function(uuid,EmployeeUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/employees/"+uuid,EmployeeUpdateInput)};this.add=function(EmployeeInput){return $http.post(Constant.BACKEND_BASE+"/employees/",EmployeeInput)};
this.addImage=function(employeeUuid,imageUuid){return $http.post(Constant.BACKEND_BASE+"/employees/"+employeeUuid+"/images",{employeeImageFileUuid:imageUuid})}});
angular.module("IOne-Production").service("CBIOrderTypeService",function($http,Constant){this.getAll=function(sizePerPage,page,confirm,status,no,name,productType,keyWord,resUuid){confirm=confirm==0?"":confirm;status=status==0?"":status;productType=productType==0?"":productType;var url="/orderTypes?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26confirm\x3d"+confirm+"\x26status\x3d"+status;if(no!==undefined&&no!==null&&no!=="")url=url+"\x26no\x3d"+no;if(name!==undefined&&name!==null&&name!=="")url=
url+"\x26name\x3d"+name;if(productType!==undefined&&productType!==null&&productType!=="")url=url+"\x26productType\x3d"+productType;if(keyWord!==undefined&&keyWord!==null&&keyWord!=="")url=url+"\x26keyWord\x3d"+keyWord;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+"/orderTypes/"+uuid)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/orderTypes/"+
uuid)};this.modify=function(uuid,UpdateInput){return $http.patch(Constant.BACKEND_BASE+"/orderTypes/"+uuid,UpdateInput)};this.add=function(AddInput){return $http.post(Constant.BACKEND_BASE+"/orderTypes/",AddInput)}});
angular.module("IOne-Production").service("CBIReturnReasonService",function($http,Constant){this.getAll=function(sizePerPage,page,confirm,status,no,name,keyWord,resUuid){confirm=confirm==0?"":confirm;status=status==0?"":status;var url="/returnReasons?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26confirm\x3d"+confirm+"\x26status\x3d"+status;if(no!==undefined&&no!==null&&no!=="")url=url+"\x26no\x3d"+no;if(name!==undefined&&name!==null&&name!=="")url=url+"\x26name\x3d"+name;if(keyWord!==undefined&&
keyWord!==null&&keyWord!=="")url=url+"\x26keyWord\x3d"+keyWord;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+"/returnReasons/"+uuid)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/returnReasons/"+uuid)};this.modify=function(uuid,UpdateInput){return $http.patch(Constant.BACKEND_BASE+"/returnReasons/"+uuid,UpdateInput)};this.add=function(AddInput){return $http.post(Constant.BACKEND_BASE+
"/returnReasons/",AddInput)}});
angular.module("IOne-Production").service("CBIPayWayService",function($http,Constant){this.getAll=function(sizePerPage,page,confirm,status,no,name,keyWord,resUuid){confirm=confirm==0?"":confirm;status=status==0?"":status;var url="/payWays?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26confirm\x3d"+confirm+"\x26status\x3d"+status;if(no!==undefined&&no!==null&&no!==""){if(typeof no=="string")no=no.replace(/\+/g,"%2B");url=url+"\x26no\x3d"+no}if(name!==undefined&&name!==null&&name!==""){if(typeof name==
"string")name=name.replace(/\+/g,"%2B");url=url+"\x26name\x3d"+name}if(keyWord!==undefined&&keyWord!==null&&keyWord!=="")url=url+"\x26keyWord\x3d"+keyWord;if(resUuid!==undefined)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+"/payWays/"+uuid)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/payWays/"+uuid)};this.modify=function(uuid,payWayUpdateInput){return $http.patch(Constant.BACKEND_BASE+
"/payWays/"+uuid,payWayUpdateInput)};this.add=function(payWayInput){return $http.post(Constant.BACKEND_BASE+"/payWays/",payWayInput)}});
angular.module("IOne-Production").service("CBISaleTypeService",function($http,Constant){this.getAll=function(sizePerPage,page,confirm,status,no,name,keyWord,resUuid){confirm=confirm==0?"":confirm;status=status==0?"":status;var url="/saleTypes?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26confirm\x3d"+confirm+"\x26status\x3d"+status;if(no!==undefined&&no!==null&&no!=="")url=url+"\x26no\x3d"+no;if(name!==undefined&&name!==null&&name!=="")url=url+"\x26name\x3d"+name;if(keyWord!==undefined&&keyWord!==
null&&keyWord!=="")url=url+"\x26keyWord\x3d"+keyWord;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+"/saleTypes/"+uuid)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/saleTypes/"+uuid)};this.modify=function(uuid,UpdateInput){return $http.patch(Constant.BACKEND_BASE+"/saleTypes/"+uuid,UpdateInput)};this.add=function(AddInput){return $http.post(Constant.BACKEND_BASE+
"/saleTypes/",AddInput)}});
angular.module("IOne-Production").service("CBIItemCustomService",function($http,Constant){this.getAll=function(){return $http.get(Constant.BACKEND_BASE+"/itemCustoms")};this.getAll=function(sizePerPage,page,confirm,status,theMax,resUuid){confirm=confirm==0?"":confirm;status=status==0?"":status;var url="/itemCustoms?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26confirm\x3d"+confirm+"\x26status\x3d"+status;if(theMax!==undefined&&theMax!==null)url=url+"\x26globalQuery\x3d"+theMax;if(resUuid!==undefined&&
resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)};this.getCustom=function(uuid){return $http.get(Constant.BACKEND_BASE+"/itemCustoms/"+uuid)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/itemCustoms/"+uuid)};this.modify=function(uuid,UpdateInput){return $http.patch(Constant.BACKEND_BASE+"/itemCustoms/"+uuid,UpdateInput)};this.add=function(AddInput){return $http.post(Constant.BACKEND_BASE+"/itemCustoms/",AddInput)}});
angular.module("IOne-Production").service("CBIItemCustomScopeService",function($http,Constant){this.getAll=function(itemCustomUuid,sizePerPage,page,confirm,status,theMax,resUuid){confirm=confirm==0?"":confirm;status=status==0?"":status;var url="/itemCustoms/"+itemCustomUuid+"/scopes?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26confirm\x3d"+confirm+"\x26status\x3d"+status;if(theMax!==undefined&&theMax!==null)url=url+"\x26globalQuery\x3d"+theMax;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+
resUuid;return $http.get(Constant.BACKEND_BASE+url)};this.getCustom=function(itemCustomUuid,scopeUuid){return $http.get(Constant.BACKEND_BASE+"/itemCustoms/"+itemCustomUuid+"/scopes/"+scopeUuid)};this.delete=function(itemCustomUuid,scopeUuid){return $http.delete(Constant.BACKEND_BASE+"/itemCustoms/"+itemCustomUuid+"/scopes/"+scopeUuid)};this.modify=function(itemCustomUuid,scopeUuid,UpdateInput){return $http.patch(Constant.BACKEND_BASE+"/itemCustoms/"+itemCustomUuid+"/scopes/"+scopeUuid,UpdateInput)};
this.add=function(itemCustomUuid,AddInput){return $http.post(Constant.BACKEND_BASE+"/itemCustoms/"+itemCustomUuid+"/scopes/",AddInput)}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/ocm/channel",{controller:"OCMChannelController",templateUrl:"app/src/app/ocm/channel/channel.html"})}]);
angular.module("IOne-Production").controller("OCMChannelController",function($scope,OCMChannelService,CBIEmployeeService,Constant,$mdDialog,$q){$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={select:{status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value,channelFlag:Constant.CHANNEL_FLAG[0].value},no:"",name:"",keyWord:""};$scope.menuDisplayOption={"switchConfirm":{display:true,name:"审核/取消审核",uuid:"2ce66bf4-6faf-4f77-88e1-3ebd32e2b0f8"},
"switchStatus":{display:true,name:"启用/禁用",uuid:"768a80a9-33e7-4fd4-8feb-cce7165bac1c"},"batchConfirm":{display:true,name:"批量审核",uuid:"2159dc12-09fe-4305-a932-1654fe82ab51"},"batchRevertConfirm":{display:true,name:"批量取审",uuid:"3e8c7ba2-7a2b-44f4-b60f-ededf2e26768"},"batchStatus":{display:true,name:"批量启用",uuid:"728abe8c-181d-42b7-b397-d2fe7f91f991"},"batchRevertStatus":{display:true,name:"批量禁用",uuid:"2224f13c-6ce8-4b20-80d2-abb6a098847e"},"batchDelete":{display:true,name:"批量删除",uuid:"ab0c752e-303c-4eef-98d5-52b6c391c47d"},
"detailConfirm":{display:true,name:"审核",uuid:"5ac88842-52d3-426c-9743-dc4ff241ffb8"},"detailRevertConfirm":{display:true,name:"取审",uuid:"475b62a2-f3da-4925-b080-da5d66bd3ca4"},"detailStatus":{display:true,name:"启用",uuid:"7053c8ef-aab5-477d-a2da-429bda74f8c1"},"detailRevertStatus":{display:true,name:"禁用",uuid:"e3cd29e5-f03a-4b03-a68b-0e470b053241"},"detailDelete":{display:true,name:"删除",uuid:"2e1cd38e-4cf1-44eb-9a79-4ee93bb8a95f"}};$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=
true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true;$scope.sortByField="no";$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.refreshList=function(){OCMChannelService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.select.confirm,$scope.listFilterOption.select.status,$scope.listFilterOption.no,$scope.listFilterOption.name,$scope.listFilterOption.select.channelFlag,
$scope.listFilterOption.keyWord,$scope.RES_UUID_MAP.CBI.CHANNEL.RES_UUID).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;$scope.selectAllFlag=false;$scope.selectedItemSize=0})};$scope.getMenuAuthData($scope.RES_UUID_MAP.CBI.CHANNEL.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)});$scope.$watch("listFilterOption.select",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=
0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()}};$scope.selectAllFlag=false;$scope.selectedItemSize=0;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;item.detailList=$scope.subItemList;$scope.displayAdvancedSearPanel=false};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=
!$scope.displayAdvancedSearPanel;$scope.selectedItem=null};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel)item.detailList=item};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);$scope.refreshList()};$scope.hideItemDetailsAction=function(event){$scope.stopEventPropagation(event);$scope.selectedItem=null;
$scope.refreshList()};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.source.confirm==
"2"&&$scope.source.status=="2"){$scope.showError("不允许状态是已审核又无效,请调整后再保存");return}if($scope.status=="add"){if($scope.domain=="OCM_BASE_CHAN"){console.log($scope.source.no);CBIEmployeeService.getByNo($scope.source.no).success(function(result){if(result.totalElements>0)$scope.showError("渠道商编号不可与于员工编号相同。");else OCMChannelService.add($scope.source).success(function(data){$scope.showInfo("新增数据成功。")}).error(function(data){$scope.showError("新增失败:"+"\x3cbr\x3e"+data.message)})})}}else if($scope.status=="edit")if($scope.domain==
"OCM_BASE_CHAN")CBIEmployeeService.getByNo($scope.source.no).success(function(result){if(result.totalElements>0)$scope.showError("渠道商编号不可与于员工编号相同。");else OCMChannelService.modify($scope.source.uuid,$scope.source).success(function(data){$scope.showInfo("修改数据成功。");$scope.source=data;$scope.selectedItem=data;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)}).error(function(data){$scope.showError("修改失败:"+"\x3cbr\x3e"+data.message);$scope.source=angular.copy($scope.selectedItemBackUp);$scope.selectedItem=
angular.copy($scope.selectedItemBackUp)})})};$scope.deleteDetailAction=function(detail){};$scope.selectItemAction=function(event,item){$scope.stopEventPropagation(event);item.selectedRef=!item.selected;if(item.selected==false||item.selected==undefined||item.selected==null)$scope.selectedItemSize+=1;else{$scope.selectedItemSize-=1;$scope.selectAllFlag=false}$scope.disableBatchMenuButtons()};$scope.confirmSwitchAction=function(event,item){$scope.stopEventPropagation(event);if(item.confirm==Constant.CONFIRM[2].value)$scope.showConfirm("确认取消审核吗？",
"",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};OCMChannelService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("取消审核成功。")})},function(){item.confirm=Constant.CONFIRM[2].value});else{if(item.status==Constant.STATUS[2].value){$scope.showWarn("项目是失效状态,请先启用后再审核");item.confirm=Constant.CONFIRM[2].value;return}$scope.showConfirm("确认审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};
OCMChannelService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("审核成功。")})},function(){item.confirm=Constant.CONFIRM[1].value})}};$scope.statusSwitchAction=function(event,item){$scope.stopEventPropagation(event);if(item.status==Constant.STATUS[2].value)$scope.showConfirm("确认修改启用状态为有效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};OCMChannelService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();
$scope.showInfo("生效成功。")})},function(){item.status=Constant.STATUS[2].value});else $scope.showConfirm("确认修改启用状态为失效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value,confirm:Constant.CONFIRM[1].value};OCMChannelService.modify(UpdateInput.uuid,UpdateInput).success(function(){item.confirm=Constant.CONFIRM[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("失效成功。")})},function(){item.status=Constant.STATUS[1].value})};$scope.confirmClickAction=function(event,item){$scope.stopEventPropagation(event);
if(item.confirm==Constant.CONFIRM[2].value)$scope.showConfirm("确认取消审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};OCMChannelService.modify(item.uuid,UpdateInput).success(function(){item.confirm=Constant.CONFIRM[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("取消审核成功！")}).error(function(response){$scope.showError(response.message)})});else $scope.showConfirm("确认审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};OCMChannelService.modify(item.uuid,
UpdateInput).success(function(){item.confirm=Constant.CONFIRM[2].value;$scope.disableBatchMenuButtons();$scope.showInfo("审核成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.statusClickAction=function(event,item){$scope.stopEventPropagation(event);if(item.status==Constant.STATUS[1].value)$scope.showConfirm("确认改为失效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value,confirm:Constant.CONFIRM[1].value};OCMChannelService.modify(item.uuid,UpdateInput).success(function(){item.status=
Constant.STATUS[2].value;item.confirm=Constant.CONFIRM[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("修改为失效成功！")}).error(function(response){$scope.showError(response.message)})});else $scope.showConfirm("确认改为生效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};OCMChannelService.modify(item.uuid,UpdateInput).success(function(){item.status=Constant.STATUS[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("修改为生效成功！")}).error(function(response){$scope.showError(response.message)})})};
$scope.releaseClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("release...")};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);if(item.status!="1"||item.confirm!="1"){$scope.showWarn("仅当渠道/直营店的状态是有效且未审核时才允许删除!");return}$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){OCMChannelService.delete(item.uuid).success(function(){$scope.selectedItem=null;$scope.refreshList();$scope.showInfo("删除数据成功。")})})};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);
var promises=[];var noDeleteNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.status=="1"&&item.confirm=="1"){var response=OCMChannelService.delete(item.uuid).success(function(){});promises.push(response);count++}else noDeleteNos=noDeleteNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任何状态是有效且未审核的可删除项目，请选择！");return}$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){if(noDeleteNos!=="")$scope.showWarn("以下状态是失效或已审核的的项目将不会删除："+"\x3cbr\x3e"+
noDeleteNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("删除成功！")},function(data){$scope.showError(data.message);$scope.showError(data.data.message)})})};$scope.confirmAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var confirmedNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.confirm!=Constant.CONFIRM[2].value){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};var response=
OCMChannelService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else confirmedNos=confirmedNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任何未审核的项目，请先选择！");return}if(confirmedNos!=="")$scope.showWarn("以下已审核过的项目将不再次审核："+"\x3cbr\x3e"+confirmedNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("审核成功！")},function(data){$scope.showError(data.message);$scope.showError(data.data.message)})};$scope.revertConfirmAllClickAction=
function(event){$scope.stopEventPropagation(event);var promises=[];var unConfirmedNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.confirm==Constant.CONFIRM[2].value){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};var response=OCMChannelService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else unConfirmedNos=unConfirmedNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任已审核的项目，请先选择！");
return}if(unConfirmedNos!=="")$scope.showWarn("以下未审核过的项目将不执行取消审核："+unConfirmedNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("取消审核成功！")},function(data){$scope.showError(data.data.message);$scope.showError(data.message)})};$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var effectiveNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.status!=Constant.STATUS[1].value){var UpdateInput=
{uuid:item.uuid,status:Constant.STATUS[1].value};var response=OCMChannelService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else effectiveNos=effectiveNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任何失效的项目，请先选择！");return}if(effectiveNos!=="")$scope.showWarn("以下已生效的项目将不再次修改："+"\x3cbr\x3e"+effectiveNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("生效成功！")},function(data){$scope.showError(data.message);$scope.showError(data.data.message)})};
$scope.revertStatusAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var uneffectiveNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.status==Constant.STATUS[1].value){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value,confirm:Constant.CONFIRM[1].value};var response=OCMChannelService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else uneffectiveNos=uneffectiveNos+item.no+
"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择生效的项目，请先选择！");return}if(uneffectiveNos!=="")$scope.showWarn("以下失效的项目将不再次修改："+uneffectiveNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("失效成功！")},function(data){$scope.showError(data.data.message);$scope.showError(data.message)})};$scope.releaseAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("release all...")};$scope.selectAllAction=function(){angular.forEach($scope.itemList,function(item){if($scope.selectAllFlag)item.selected=
true;else item.selected=false;item.selectedRef=item.selected});$scope.selectedItemSize=0;$scope.selectedItemAmount=0;if($scope.selectAllFlag)angular.forEach($scope.itemList,function(item){$scope.selectedItemSize++});$scope.disableBatchMenuButtons()};$scope.disableBatchMenuButtons=function(){var selectedCount=0;var confirm="";var status="";var diffConfirm=false;var diffStatus=false;angular.forEach($scope.itemList,function(item,index){if(item.selectedRef){selectedCount++;if(confirm=="")confirm=item.confirm;
else if(confirm!=item.confirm)diffConfirm=true;if(status=="")status=item.status;else if(status!=item.status)diffStatus=true}});if(selectedCount==0){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}else{if(diffConfirm==true){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchDelete=true}else if(confirm=="2"){$scope.disabledBatchConfirm=
true;$scope.disabledBatchCancelConfirm=false;$scope.disabledBatchDelete=true}else{$scope.disabledBatchConfirm=false;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchDelete=false}if(diffStatus==true){$scope.disabledBatchConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}else if(status=="1"){$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=false}else{$scope.disabledBatchConfirm=true;$scope.disabledBatchStatus=
false;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}}}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/channelPrice",{controller:"ChannelPriceController",templateUrl:"app/src/app/ocm/channel_price/channelPrice.html"})}]);
angular.module("IOne-Production").controller("ChannelPriceController",function($scope,$q,OCMParametersService,WarehousesService,ChannelService,ChannelPriceService,CatalogueTemplate,Catalogue,ProductionCatalogueDetails,$mdDialog,$timeout,Constant){$scope.ocmListMenu={selectAll:false,status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value,showQueryBar:true};$scope.formMenuDisplayOption={"100-add":{display:true,name:"新增",uuid:"885E841C-03FE-4DE9-A393-27C5D860C20F"},"101-delete":{display:true,
name:"删除",uuid:"6C46231A-FC5B-4F1E-9325-2DC6A8136BB4"},"102-edit":{display:true,name:"编辑",uuid:"4A7E5038-2319-4089-AE5D-FDCB32C3FFB5"},"109-copy":{display:true,name:"导入",uuid:"C1E09C8F-489B-4E92-AED9-7A185DE3E989"},"200-cancel":{display:true,name:"取消新增",uuid:"8536C6CE-75F0-46F4-9CFA-A3DE2AB371CE"},"201-save":{display:true,name:"保存",uuid:"C03E7689-267F-4A6B-AA7D-88A99C9CEFF0"},"202-continueAdd":{display:true,name:"继续导入商品",uuid:"A9B52AFC-55C3-4AD2-A6CC-2E45EFD8F29C"},"302-save":{display:true,name:"保存",
uuid:"01673539-3C67-4E76-B616-3767B07E6922"},"303-cancel":{display:true,name:"取消修改",uuid:"FD70B726-FF76-45B4-B667-BB778B3C2AA9"},"304-quit":{display:true,name:"退出编辑",uuid:"63367BAD-6D79-4994-B420-EBFAA30D8357"},"611-selectAll":{display:true,name:"全选",uuid:""},"612-audit":{display:true,name:"审核",uuid:"2BC1695C-CF0F-4B01-B88E-6CAED78A2452"},"613-revertAudit":{display:true,name:"取消审核",uuid:"B6C422E7-C211-4C8F-854B-E46A1938B4DA"},"614-valid":{display:true,name:"有效",uuid:"9C3D50A1-4389-412B-9C7E-37B46B61FA52"},
"615-invalid":{display:true,name:"无效",uuid:"12984716-C4B6-4A5C-8C77-D20F3D84951A"}};$scope.ocmListMenuDisplayOption={"600-query":{display:true,name:"查询",uuid:"ABF33FF5-D32C-4E8C-8AF1-6436E00AC244"},"601-selectAll":{display:true,name:"全选",uuid:"AAA16052-5A07-4582-A6FB-D45AE5A7A4A0"},"602-audit":{display:true,name:"审核",uuid:"69C01DDB-8BE3-4920-B757-EB448EF66B9A"},"603-revertAudit":{display:true,name:"取消审核",uuid:"4160BFAF-08DB-4EFE-95D2-642928450A1A"},"604-valid":{display:true,name:"有效",uuid:"0BE2ACF6-90D3-4C16-AE8F-74E5B589B217"},
"605-invalid":{display:true,name:"无效",uuid:"E3951469-7BB5-4786-9A4C-5FF7C785D574"}};$scope.pageOption={sizePerPage:14,currentPage:0,totalPage:100,totalElements:100};$scope.pageOptionOfChannelPrice={sizePerPage:14,currentPage:0,totalPage:100,totalElements:100};$scope.editItem=function(channel){$scope.selectedItem=channel;$scope.changeViewStatus(Constant.UI_STATUS.PRE_EDIT_UI_STATUS,1);$scope.pageOptionOfChannelPrice.currentPage=0;$scope.pageOptionOfChannelPrice.totalPage=0;$scope.pageOptionOfChannelPrice.totalElements=
0;$scope.queryChannelPriceWithPaging();WarehousesService.getAll().success(function(data){$scope.warehouses=data})};$scope.searchChannelPriceWithPaging=function(){$scope.pageOptionOfChannelPrice.currentPage=0;$scope.pageOptionOfChannelPrice.totalPage=0;$scope.pageOptionOfChannelPrice.totalElements=0;$scope.ocmListMenu.selectAll=false;$scope.selected=[];$scope.resetInitialValue();ChannelPriceService.getAllWithPaging($scope.pageOptionOfChannelPrice.sizePerPage,$scope.pageOptionOfChannelPrice.currentPage,
$scope.selectedItem.uuid,$scope.catalogueName,$scope.itemName,$scope.warehouseUuid).success(function(data){$scope.parseCatalogueName(data);$scope.ChannelPriceList=data;$scope.pageOptionOfChannelPrice.totalPage=data.totalPages;$scope.pageOptionOfChannelPrice.totalElements=data.totalElements})};$scope.queryChannelPriceWithPaging=function(){$scope.ocmListMenu.selectAll=false;$scope.selected=[];$scope.resetInitialValue();ChannelPriceService.getAllWithPaging($scope.pageOptionOfChannelPrice.sizePerPage,
$scope.pageOptionOfChannelPrice.currentPage,$scope.selectedItem.uuid,$scope.catalogueName,$scope.itemName).success(function(data){$scope.parseCatalogueName(data);$scope.ChannelPriceList=data;$scope.pageOptionOfChannelPrice.totalPage=data.totalPages;$scope.pageOptionOfChannelPrice.totalElements=data.totalElements})};$scope.queryMenuAction=function(){$scope.resetInitialValue();$scope.selected=[];$scope.ocmListMenu.selectAll=false;if($scope.ocmListMenu.channelName!==undefined)channelName=$scope.ocmListMenu.channelName;
else channelName=null;if($scope.ocmListMenu.channelNo!==undefined)channelNo=$scope.ocmListMenu.channelNo;else channelNo=null;confirm=$scope.ocmListMenu.confirm;status=$scope.ocmListMenu.status;ChannelService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,confirm,status,channelName,channelNo,RES_UUID_MAP.OCM.CHANNEL_PRICE.LIST_PAGE.RES_UUID).success(function(data){$scope.ChannelList=data;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;
var channelUuid="";angular.forEach($scope.ChannelList.content,function(channel){channelUuid=channelUuid+channel.uuid+","});ChannelPriceService.getAllCountByChannelUuid(channelUuid).success(function(data){var map=[];angular.forEach(data,function(channelItemCount){map[channelItemCount.uuid]=channelItemCount.itemCount});angular.forEach($scope.ChannelList.content,function(channel){if(undefined!=map[channel.uuid])channel.channelPriceCount=map[channel.uuid];else channel.channelPriceCount=0})})})};$scope.changeSaleDiscountRate=
function(channelPrice){channelPrice.salePrice=parseFloat((channelPrice.standardPrice*channelPrice.saleDiscountRate).toFixed(2))};$scope.changeSalePrice=function(channelPrice){channelPrice.saleDiscountRate=parseFloat((channelPrice.salePrice/channelPrice.standardPrice).toFixed(4))};$scope.listTabSelected=function(){$scope.ocmListMenu.showQueryBar=true;$scope.queryMenuAction();$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS,0);$scope.selected=[];$scope.ChannelPriceList=[];$scope.selectedItem=
null;$scope.itemName=null;$scope.catalogueName=null;$scope.standardPriceDiscountRate=null;$scope.saleDiscountRate=null;$scope.getMenuAuthData($scope.RES_UUID_MAP.OCM.CHANNEL_PRICE.LIST_PAGE.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)})};$scope.formTabSelected=function(){$scope.ocmListMenu.showQueryBar=false;$scope.selected=[];$scope.getMenuAuthData($scope.RES_UUID_MAP.OCM.CHANNEL_PRICE.FORM_PAGE.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)})};
$scope.selected=[];$scope.toggle=function(item,selected){var idx=selected.indexOf(item);if(idx>-1)selected.splice(idx,1);else selected.push(item);$scope.ocmListMenu.effectiveType=item.status;if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1)$scope.changeButtonStatus()};$scope.resetInitialValue=function(){$scope.revert_audit_button_disabled=0;$scope.audit_button_disabled=0;$scope.valid_status_button_disabled=0;$scope.invalid_status_button_disabled=0};$scope.changeButtonStatus=
function(){$scope.resetInitialValue();var firstLoop=true;angular.forEach($scope.selected,function(channelPrice){$scope.changeButtonStatusByConfirm(channelPrice);$scope.changeButtonStatusByStatus(channelPrice);if(firstLoop){firstLoop=false;$scope.firstLoopStatus=channelPrice.status;$scope.firstLoopConfirm=channelPrice.confirm}else{if($scope.firstLoopStatus!==channelPrice.status){$scope.valid_status_button_disabled=1;$scope.invalid_status_button_disabled=1}if($scope.firstLoopConfirm!==channelPrice.confirm){$scope.audit_button_disabled=
1;$scope.revert_audit_button_disabled=1}}})};$scope.changeButtonStatusByConfirm=function(channelPrice){if(channelPrice.confirm==Constant.CONFIRM[1].value)$scope.revert_audit_button_disabled=1;else $scope.audit_button_disabled=1;if(channelPrice.confirm==Constant.CONFIRM[2].value){$scope.valid_status_button_disabled=1;$scope.invalid_status_button_disabled=1}};$scope.changeButtonStatusByStatus=function(channelPrice){if(channelPrice.status==Constant.STATUS[1].value)$scope.valid_status_button_disabled=
1;else $scope.invalid_status_button_disabled=1;if(channelPrice.status==Constant.STATUS[2].value){$scope.audit_button_disabled=1;$scope.revert_audit_button_disabled=1}};$scope.exists=function(item,list){return list.indexOf(item)>-1};$scope.selectAllMenuAction=function(){if($scope.ocmListMenu.selectAll==true){$scope.selected=[];if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){angular.forEach($scope.ChannelPriceList.content,function(item){$scope.selected.push(item)});
$scope.changeButtonStatus()}else if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0)angular.forEach($scope.ChannelList.content,function(item){$scope.selected.push(item)})}else if($scope.ocmListMenu.selectAll==false)$scope.selected=[]};$scope.validStatusMenuAction=function(){if($scope.selected.length>0)$scope.showConfirm("确认修改启用状态为有效吗？","",function(){if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){var promises=[];angular.forEach($scope.selected,
function(channelPrice){var ChannelPriceUpdateInput={status:Constant.STATUS[1].value};var response=ChannelPriceService.modify(channelPrice.uuid,ChannelPriceUpdateInput).success(function(){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.editItem($scope.selectedItem)})}else if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){var promises=[];angular.forEach($scope.selected,function(channel){var ChannelPriceUpdateInput={channelUuid:channel.uuid,
status:Constant.STATUS[1].value};var response=ChannelPriceService.modifyAll(ChannelPriceUpdateInput).success(function(data){});promises.push(response)});$q.all(promises).then(function(data){$scope.showInfo("修改数据成功。");$scope.queryMenuAction()})}})};$scope.invalidStatusMenuAction=function(){if($scope.selected.length>0)$scope.showConfirm("确认修改启用状态为无效吗？","",function(){if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){var promises=[];angular.forEach($scope.selected,
function(channelPrice){var ChannelPriceUpdateInput={status:Constant.STATUS[2].value};var response=ChannelPriceService.modify(channelPrice.uuid,ChannelPriceUpdateInput).success(function(){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.editItem($scope.selectedItem)})}else if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){var promises=[];angular.forEach($scope.selected,function(channel){var ChannelPriceUpdateInput={channelUuid:channel.uuid,
status:Constant.STATUS[2].value};var response=ChannelPriceService.modifyAll(ChannelPriceUpdateInput).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.queryMenuAction()})}})};$scope.revertAuditMenuAction=function(){if($scope.selected.length>0)$scope.showConfirm("确认取消审核吗？","",function(){if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){var promises=[];angular.forEach($scope.selected,function(channelPrice){var ChannelPriceUpdateInput=
{confirm:Constant.CONFIRM[1].value};var response=ChannelPriceService.modify(channelPrice.uuid,ChannelPriceUpdateInput).success(function(){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.editItem($scope.selectedItem)})}else if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){var promises=[];angular.forEach($scope.selected,function(channel){var ChannelPriceUpdateInput={channelUuid:channel.uuid,confirm:Constant.CONFIRM[1].value};
var response=ChannelPriceService.modifyAll(ChannelPriceUpdateInput).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.queryMenuAction()})}})};$scope.auditMenuAction=function(){if($scope.selected.length>0)$scope.showConfirm("确认审核吗？","",function(){if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){var promises=[];angular.forEach($scope.selected,function(channelPrice){var ChannelPriceUpdateInput=
{confirm:Constant.CONFIRM[2].value};var response=ChannelPriceService.modify(channelPrice.uuid,ChannelPriceUpdateInput).success(function(){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.editItem($scope.selectedItem)})}else if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){var promises=[];angular.forEach($scope.selected,function(channel){var ChannelPriceUpdateInput={channelUuid:channel.uuid,confirm:Constant.CONFIRM[2].value};
var response=ChannelPriceService.modifyAll(ChannelPriceUpdateInput).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.queryMenuAction()})}})};$scope.updateStandardPriceInBatch=function(){if(undefined!=$scope.standardPriceDiscountRate&&null!=$scope.standardPriceDiscountRate){var msg=$scope.createPromptMsg();$scope.showConfirm("确认批量价格维护吗？",msg,function(){$scope.logining=true;ChannelPriceService.updateStandardPriceInBatch($scope.selectedItem.uuid,
$scope.catalogueName,$scope.itemName,$scope.warehouseUuid,$scope.standardPriceDiscountRate).success(function(data){$scope.logining=false;$scope.showInfo("修改数据成功。");$scope.searchChannelPriceWithPaging()}).error(function(data){$scope.logining=false;$scope.showError(data.message)})})}};$scope.updateSalePriceInBatch=function(){if(undefined!=$scope.saleDiscountRate&&null!=$scope.saleDiscountRate){var msg=$scope.createPromptMsg();$scope.showConfirm("确认批量折扣维护吗？",msg,function(){$scope.logining=true;ChannelPriceService.updateSalePriceInBatch($scope.selectedItem.uuid,
$scope.catalogueName,$scope.itemName,$scope.warehouseUuid,$scope.saleDiscountRate).success(function(data){$scope.logining=false;$scope.showInfo("修改数据成功。");$scope.searchChannelPriceWithPaging()}).error(function(data){$scope.showError(data.message)})})}};$scope.updateWarehouseInBatch=function(){if(undefined!=$scope.warehouseUpdatedUuid&&null!=$scope.warehouseUpdatedUuid){var msg=$scope.createPromptMsg();$scope.showConfirm("确认批量仓库维护吗？",msg,function(){$scope.logining=true;ChannelPriceService.updateWarehouseInBatch($scope.selectedItem.uuid,
$scope.catalogueName,$scope.itemName,$scope.warehouseUuid,$scope.warehouseUpdatedUuid).success(function(data){$scope.logining=false;$scope.showInfo("修改数据成功。");$scope.searchChannelPriceWithPaging()}).error(function(data){$scope.showError(data.message)})})}};$scope.createPromptMsg=function(){var msg="";if(undefined!=$scope.catalogueName&&null!=$scope.catalogueName&&$scope.catalogueName.lenth!=0)msg="目录名称:"+$scope.catalogueName;if(undefined!=$scope.itemName&&null!=$scope.itemName&&$scope.itemName.lenth!=
0)msg=msg+" 商品信息:"+$scope.itemName;if(undefined!=$scope.warehouseUuid&&null!=$scope.warehouseUuid&&$scope.warehouseUuid.lenth!=0)angular.forEach($scope.warehouses.content,function(warehouse){if(warehouse.uuid==$scope.warehouseUuid)msg=msg+" 仓库:"+warehouse.name});return msg};$scope.modifyMenuAction=function(){if($scope.ChannelPriceList){var promises=[];angular.forEach($scope.ChannelPriceList.content,function(channelPrice){var response=ChannelPriceService.modify(channelPrice.uuid,channelPrice).success(function(data){});
promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。")})}};$scope.cancelModifyMenuAction=function(){$scope.searchChannelPriceWithPaging()};$scope.exitModifyMenuAction=function(){$scope.cancelModifyMenuAction();$scope.changeViewStatus($scope.UI_STATUS.PRE_EDIT_UI_STATUS,1);$scope.ocmListMenu.selectAll==false};$scope.preAddMenuAction=function(){$scope.ocmListMenu.showQueryBar=false;$scope.selected=[];$scope.ExistedChannelPriceList=$scope.ChannelPriceList;$scope.ChannelPriceList=
{content:[]};$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_ADD,1);$scope.openProductionSelectDlg()};$scope.continueAddMenuAction=function(){$scope.openProductionSelectDlg()};$scope.addMenuAction=function(){if($scope.ChannelPriceList.content!=undefined&&$scope.ChannelPriceList.content.length>0){var promises=[];angular.forEach($scope.ChannelPriceList.content,function(channelPrice){channelPrice.channelUuid=$scope.selectedItem.uuid;channelPrice.catalogueUuid=channelPrice.catalogue.uuid;channelPrice.itemUuid=
channelPrice.item.uuid;var channelPriceResponse=ChannelPriceService.add(channelPrice).error(function(data){$scope.showError(data.message)});promises.push(channelPriceResponse)});$q.all(promises).then(function(data){$scope.showInfo("新增渠道商品定价成功。");$scope.editItem($scope.selectedItem)},function(data){$scope.showInfo("新增渠道商品定价完成。");$scope.editItem($scope.selectedItem)})}else $scope.ChannelPriceList=$scope.ExistedChannelPriceList;$scope.changeViewStatus($scope.UI_STATUS.PRE_EDIT_UI_STATUS,1)};$scope.parseCatalogueName=
function(data){angular.forEach(data.content,function(channelPrice){var catalogue=channelPrice.catalogue;if(null!=catalogue){var catalogueName=catalogue.name;while(catalogue.parentCatalogue!=null){var catalogue=catalogue.parentCatalogue;catalogueName=catalogue.name+"-\x3e"+catalogueName}channelPrice.catalogueName=catalogueName}})};$scope.cancelAddMenuAction=function(){$scope.editItem($scope.selectedItem)};$scope.deleteMenuAction=function(){if($scope.selected.length>0)$scope.showConfirm("确认删除吗？","删除的商品定价不可恢复。",
function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(channelPrice){var response=ChannelPriceService.delete(channelPrice.uuid).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("删除数据成功。");$scope.editItem($scope.selectedItem)})}})};$scope.copyChannelPrice=function(){$mdDialog.show({controller:"OCMChannelSearchController",templateUrl:"app/src/app/ocm/channel_price/selectChannel.html",parent:angular.element(document.body),
targetEvent:event}).then(function(data){$scope.selectedItem.sourceChannel=data;$scope.selectedItem.sourceChannelUuid=data.uuid;ChannelPriceService.copy($scope.selectedItem.sourceChannelUuid,$scope.selectedItem.uuid).success(function(data){if(data.status=="COMPLETED"){$scope.showInfo("拷贝渠道商品定价完成。");$scope.editItem($scope.selectedItem)}else $scope.showError("拷贝渠道商品定价失败。")}).error(function(data){$scope.showError("拷贝渠道商品定价失败。")})})};$scope.openProductionSelectDlg=function(){$mdDialog.show({controller:"ProductionSelectController",
templateUrl:"app/src/app/ocm/channel_price/productionSelectDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{channel:$scope.selectedItem,op:"add"}}).then(function(data){$scope.nodeDataUuid=data.nodeDataUuid;$scope.logining=true;ProductionCatalogueDetails.getByCatalogueAndChannel(data.nodeDataUuid,$scope.selectedItem.uuid,RES_UUID_MAP.OCM.CHANNEL_PRICE.ADD.RES_UUID).success(function(data){$scope.logining=false;if(null!=data&&data.length>50)$scope.showConfirm("当前目录下商品数为"+data.length,
"确认导入当前目录下的所有商品定价吗？",function(){$scope.logining=true;ProductionCatalogueDetails.postByCatalogueAndChannel($scope.nodeDataUuid,$scope.selectedItem.uuid,RES_UUID_MAP.OCM.CHANNEL_PRICE.ADD.RES_UUID).success(function(data){$scope.logining=false;$scope.showInfo("新增渠道商品定价成功。");$scope.editItem($scope.selectedItem)})});else $scope.populateChannelPrice(data)})})};OCMParametersService.getAll().success(function(ocmParameterData){$scope.standardPriceCoefficient=ocmParameterData.content[0].standardPriceCoefficient;
$scope.saleDiscountRateFromServer=ocmParameterData.content[0].saleDiscountRate});$scope.populateChannelPrice=function(data){if(data&&data.length>0){var content=[];angular.forEach(data,function(link){var catalogue=link.catalogue;var catalogueName=catalogue.name;while(catalogue.parentCatalogue!=null){var catalogue=catalogue.parentCatalogue;catalogueName=catalogue.name+"-\x3e"+catalogueName}var standardPriceVar=parseFloat((link.item.suggestPrice*$scope.standardPriceCoefficient).toFixed(0));var salePriceVar=
parseFloat((standardPriceVar*$scope.saleDiscountRateFromServer).toFixed(2));var channelPrice={channel:$scope.selectedItem,catalogue:link.catalogue,item:link.item,saleDiscountRate:.6,standardPrice:standardPriceVar,salePrice:salePriceVar,confirm:1,status:1,catalogueName:catalogueName};content.push(channelPrice)});$scope.ChannelPriceList.content=$scope.ChannelPriceList.content.concat(content);if(content.length==0)$scope.showInfo("当前目录没有商品或者商品已经导入！")}}});
angular.module("IOne-Production").controller("OCMChannelSearchController",function($scope,$mdDialog,ChannelService,Constant){$scope.pageOption={sizePerPage:6,currentPage:0,totalPage:0,totalElements:0,displayModel:0};$scope.RES_UUID_MAP=RES_UUID_MAP;$scope.refreshChannel=function(){ChannelService.getAllGlobalQuery($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,0,0,$scope.searchKeyword,$scope.RES_UUID_MAP.CBI.CHANNEL.RES_UUID).success(function(data){$scope.allChannel=data;$scope.pageOption.totalElements=
data.totalElements;$scope.pageOption.totalPage=data.totalPages})};$scope.refreshChannel();$scope.selectChannel=function(channel){$scope.channel=channel;$mdDialog.hide($scope.channel)};$scope.hideDlg=function(){$mdDialog.hide($scope.channel)};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").controller("ProductionSelectController",function($scope,$mdDialog,CatalogueTemplate,Catalogue,ProductionCatalogueDetails,Constant,channel){$scope.channel=channel;$scope.pageOptionForProd={sizePerPage:1E3,currentPage:0,totalPage:0,totalElements:0};$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={status:Constant.STATUS[1].value,confirm:Constant.CONFIRM[2].value,release:Constant.RELEASE[2].value};$scope.$watch("listFilterOption",
function(){$scope.refreshAllTemplate()},true);$scope.selectedTemplateData={};$scope.nodeDataClickHandler=function($event){if($event&&$event.stopPropagation)$event.stopPropagation();if($event&&$event.preventDefault)$event.preventDefault()};$scope.refreshAllTemplate=function(){CatalogueTemplate.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.status,$scope.listFilterOption.confirm,$scope.listFilterOption.release).success(function(data){$scope.catalogueTemplates=
data;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;var setFirstOpen=false;if(data&&data.content){$scope.selectedTemplateData={};$scope.selectedTemplateNodeDataUI={};angular.forEach(data.content,function(content){if(content&&content.details){content.display=true;content.open=false;content.dataStatus=content.dataStatus==null?2:1;content.dataConfirm=content.dataConfirm==null?1:2;content.dataRelease=content.dataRelease==null?1:2;angular.forEach(content.details,
function(node,index){node.index=index});if(content.details.length>0){if(setFirstOpen==false){content.open=true;setFirstOpen=true}$scope.refreshTemplateData(content,content.details[0])}}})}});$scope.selectedItem=null;$scope.selectedTemplateNode=null;$scope.selectedTemplateNodeData=null;$scope.selectedTemplateNodeDataUuid=null};$scope.refreshTemplateData=function(template,node){if(template&&template.details&&template.details.length>0){var dataHandler=function(template,node,data){angular.forEach(data,
function(item){item.catalogueTemplateDetail.index=node.index});var content=$scope.selectedTemplateData[template.uuid];if(content==undefined||content==null){content=[data];$scope.selectedTemplateData[template.uuid]=content;$scope.refreshUI(template)}};Catalogue.getForRootWithFilter(node.uuid,RES_UUID_MAP.OCM.CHANNEL_PRICE.ADD.RES_UUID).success(function(data){dataHandler(template,node,data.content)})}};$scope.refreshUI=function(template){$scope.selectedTemplateNodeDataUI[template.uuid]={};angular.forEach(template.details,
function(item){$scope.selectedTemplateNodeDataUI[template.uuid][item.index]=item.name;if($scope.selectedTemplateData[template.uuid][item.index])angular.forEach($scope.selectedTemplateData[template.uuid][item.index],function(data){if(angular.isDefined(data.selected)&&data.selected)$scope.selectedTemplateNodeDataUI[template.uuid][item.index]=data.name})})};$scope.refreshProduction=function(catalogueUuid){ProductionCatalogueDetails.getByCatalogueAndChannel(catalogueUuid,$scope.channel.uuid).success(function(data){$scope.linkData=
data})};$scope.nodeDataChangeHandler=function(template,node,nodeDataList,nodeDataUuid){if($scope.isRefreshing)return;$scope.selectedTemplateData[template.uuid].splice(node.index+1);$scope.selectedTemplateNode=node;$scope.selectedTemplateNodeDataUuid=nodeDataUuid;angular.forEach(nodeDataList,function(item){if(item.uuid==nodeDataUuid){item.selected=true;$scope.selectedTemplateNodeData=item}else item.selected=false});$scope.refreshUI(template);$scope.nodeDataUuid=nodeDataUuid;var nextNode=template.details[node.index+
1];if(nextNode==undefined||nextNode==undefined);else{$scope.isRefreshing=true;Catalogue.get(nextNode.uuid,nodeDataUuid,RES_UUID_MAP.OCM.CHANNEL_PRICE.ADD.RES_UUID).success(function(data){if(data&&data.content&&data.content.length>0)$scope.selectedTemplateData[template.uuid].push(data.content);$scope.isRefreshing=false}).error(function(){$scope.isRefreshing=false})}};$scope.nodeDataClickHandler=function($event){if($event&&$event.stopPropagation)$event.stopPropagation();if($event&&$event.preventDefault)$event.preventDefault()};
$scope.openQuickView=function($event,production){$mdDialog.show({controller:"QuickViewController",templateUrl:"app/src/app/production/production/quick_view.html",parent:angular.element(document.body),targetEvent:event,locals:{productionUuid:production.uuid}}).then(function(data){});$event.stopPropagation();$event.preventDefault()};$scope.hideDlg=function(){$mdDialog.hide({"nodeDataUuid":$scope.nodeDataUuid})};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/auth/config",{controller:"AuthConfigController",templateUrl:"app/src/app/auth/config/config.html"})}]);
angular.module("IOne-Production").controller("AuthConfigController",function($scope,$http,Constant,SysCptService,$mdDialog,SysMenusService,UserService,DataBanService,DataPermitService,CptService,MenuService,ResService,RoleService,FunctionService){$scope.userPageOption={sizePerPage:10,currentPage:0,totalPage:0,totalElements:10,displayModel:0};$scope.rolePageOption={sizePerPage:10,currentPage:0,totalPage:0,totalElements:10,displayModel:0};$scope.functionPageOption={sizePerPage:10,currentPage:0,totalPage:0,
totalElements:10,displayModel:0};$scope.formMenuDisplayOption={"100-add":{display:false,name:"新增",uuid:""},"101-delete":{display:false,name:"删除",uuid:""},"102-edit":{display:true,name:"编辑",uuid:"27E2D251-BAC4-41E6-AB0C-B8BA64F58E3A"},"103-copy":{display:false,name:"复制",uuid:"333566DF-308E-43BB-BE05-9B11FA612470"},"104-status":{display:false,name:"启用",uuid:""},"105-confirm":{display:false,name:"审核",uuid:""},"106-release":{display:false,name:"发布",uuid:""},"200-cancel":{display:false,name:"取消新增",uuid:""},
"201-save":{display:false,name:"保存",uuid:""},"300-add":{display:false,name:"新增节点",uuid:""},"301-delete":{display:false,name:"删除节点",uuid:""},"302-save":{display:false,name:"保存",uuid:"5DB55B26-4DEF-421D-B0EF-2D01BAC55595"},"303-cancel":{display:false,name:"取消修改",uuid:""},"304-quit":{display:true,name:"退出编辑",uuid:"D9B1BB56-1320-4BFE-ABC8-CD7ED6751B2B"}};$scope.searchKeyword={func:"",role:"",user:""};SysCptService.getAllAvailableNames().success(function(data){$scope.allSysCptNames=data});$scope.toggleTreeNode=
function(tree,node){$scope.selectedTreeNode=node;if(node&&node.nodes&&node.nodes.length==0){$scope.cptList=null;$scope.menuList=null;$scope.permitDataList=null;$scope.banDataList=null;$scope.detailCpts=null;$scope.detailMenus=null;$scope.selectedSysMenu=null;$scope.selectedSysCpt=null;SysCptService.getAll(node.uuid).success(function(data){$scope.cptList=data;CptService.getAll($scope.entityType,$scope.selectedItem.uuid,"",node.uuid).success(function(data){$scope.detailCpts=data;angular.forEach(data,
function(value,index){angular.forEach($scope.cptList,function(cpt){if(cpt.uuid==value.sysCpt.uuid&&value.displayFlag=="1")cpt.checked=true})})})});SysMenusService.getAll(node.uuid).success(function(data){$scope.menuList=data;MenuService.getAll($scope.entityType,$scope.selectedItem.uuid,"",node.uuid).success(function(data){$scope.detailMenus=data;angular.forEach(data,function(value,index){angular.forEach($scope.menuList.content,function(menu){if(menu.uuid==value.sysMenu.uuid)menu.checked=true})})})})}};
$scope.getResTree=function(){if($scope.isNotValid($scope.resTree))$http.get("sysRess/resTree").success(function(data){$scope.resTree=data})};$scope.iterateResTree=function(tree){angular.forEach(tree,function(data,value){if($scope.isValid($scope.currentEntityResMap[data.uuid]))data.checked=true;else data.checked=false;if(data.nodes.length>0)$scope.iterateResTree(data.nodes)})};$scope.getResTree();$scope.cptClickHandler=function(type,cpt){if($scope.selectedItem==undefined){$scope.showWarn("请从列表中选择一个职能，角色或者账号。");
return}$scope.permitDataList=null;$scope.banDataList=null;$scope.$parent.selectedSysCptObject=null;$scope.selectedSysCpt=cpt;DataPermitService.getAllValues(type,$scope.selectedItem.uuid,cpt.uuid,cpt.sysRes.uuid).success(function(data){$scope.permitDataList=data});DataBanService.getAllValues(type,$scope.selectedItem.uuid,cpt.uuid,cpt.sysRes.uuid).success(function(data){$scope.banDataList=data})};$scope.menuClickHandler=function(type,menu){$scope.selectedSysMenu=menu};$scope.getFunctions=function(){FunctionService.getAll($scope.functionPageOption.sizePerPage,
$scope.functionPageOption.currentPage,"",$scope.searchKeyword.func).success(function(data){$scope.allFunctions=data;$scope.functionPageOption.totalPage=data.totalPages;$scope.functionPageOption.totalElements=data.totalElements})};$scope.getRoles=function(){RoleService.getAll($scope.rolePageOption.sizePerPage,$scope.rolePageOption.currentPage,"",$scope.searchKeyword.role).success(function(data){$scope.allRoles=data;$scope.rolePageOption.totalPage=data.totalPages;$scope.rolePageOption.totalElements=
data.totalElements})};$scope.userType=1;$scope.getUsers=function(){UserService.getAll($scope.userPageOption.sizePerPage,$scope.userPageOption.currentPage,"",$scope.userType,"",$scope.searchKeyword.user).success(function(data){$scope.allUsers=data;$scope.userPageOption.totalPage=data.totalPages;$scope.userPageOption.totalElements=data.totalElements})};$scope.refreshUsers=function(){$scope.getUsers();$scope.selectedItem=null};$scope.getFunctions();$scope.getRoles();$scope.getUsers();$scope.selectEntity=
function(entity,type){$scope.entityType=type;$scope.selectedItem=entity;$scope.selectedEntityTabIndex=type-1;$scope.selectedTreeNode=null;$scope.cptList=null;$scope.menuList=null;$scope.permitDataList=null;$scope.banDataList=null;$scope.detailCpts=null;$scope.detailMenus=null;$scope.detailRes=null;$scope.selectedSysCpt=null;$scope.selectedSysMenu=null;ResService.getAll($scope.entityType,$scope.selectedItem.uuid).success(function(data){$scope.detailRes=data;$scope.currentEntityResMap={};angular.forEach($scope.detailRes,
function(value,index){$scope.currentEntityResMap[value.sysRes.uuid]=value});$scope.iterateResTree($scope.resTree)})};$scope.listTabSelected=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS,0)};$scope.formTabSelected=function(){$scope.getMenuAuthData($scope.RES_UUID_MAP.AUTH.CONFIG.FORM_PAGE.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)})};$scope.editItem=function(item){$scope.selectedItem=item;$scope.changeViewStatus(Constant.UI_STATUS.PRE_EDIT_UI_STATUS,
1)};$scope.resTreeCheckBoxHandler=function(node){if($scope.isEditing&&$scope.entityType&&$scope.selectedItem)if(node.checked==false)ResService.add($scope.entityType,$scope.selectedItem.uuid,node.uuid).success(function(data){$scope.detailRes.push(data)});else angular.forEach($scope.detailRes,function(value,index){if(value.sysRes.uuid==node.uuid)ResService.delete(value.uuid)})};$scope.menuCheckBoxHandler=function(sysMenu){if($scope.isEditing&&$scope.entityType&&$scope.selectedItem)if(sysMenu.checked==
undefined||sysMenu.checked==false)MenuService.add($scope.entityType,$scope.selectedItem.uuid,sysMenu.uuid).success(function(data){$scope.detailMenus.push(data)});else angular.forEach($scope.detailMenus,function(value,index){if(value.sysMenu.uuid==sysMenu.uuid)MenuService.delete(value.uuid)})};$scope.cptCheckBoxHandler=function(sysCpt){if($scope.isEditing&&$scope.entityType&&$scope.selectedItem)if(sysCpt.checked==undefined||sysCpt.checked==false){var currentCpt=null;for(var i=0;i<$scope.detailCpts.length;i++)if($scope.detailCpts[i].sysCpt&&
$scope.detailCpts[i].sysCpt.uuid==sysCpt.uuid){currentCpt=$scope.detailCpts[i];break}if(currentCpt){currentCpt.displayFlag=1;CptService.modify(currentCpt)}else CptService.add($scope.entityType,$scope.selectedItem.uuid,sysCpt.uuid,1).success(function(data){$scope.detailCpts.push(data)})}else angular.forEach($scope.detailCpts,function(value,index){if(value.sysCpt&&value.sysCpt.uuid==sysCpt.uuid){value.displayFlag=2;CptService.modify(value)}})};$scope.exitModifyMenuAction=function(){$scope.changeViewStatus($scope.UI_STATUS.PRE_EDIT_UI_STATUS,
1)};$scope.canAddPermitBanData=function(){if($scope.selectedSysCpt&&$scope.isEditing)return true;else return false};$scope.addPermitData=function(){$mdDialog.show({controller:"DataListController",templateUrl:"app/src/app/auth/config/dataListDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{selectedSysRes:$scope.selectedTreeNode,selectedSysCpt:$scope.selectedSysCpt}}).then(function(data){DataPermitService.add($scope.entityType,$scope.selectedItem.uuid,data.selectedData.valueUuid,
$scope.selectedSysCpt.uuid).success(function(response){if($scope.permitDataList)if(data.selectedObject)$scope.permitDataList.push(data.selectedObject);else $scope.permitDataList.push(response)})})};$scope.deletePermitData=function(data){if($scope.selectedSysCpt.objectFlag=="1")DataPermitService.delete(null,$scope.entityType,$scope.selectedItem.uuid,data.uuid||data.UUID,$scope.selectedSysCpt.uuid).success(function(){$scope.permitDataList.splice($scope.permitDataList.indexOf(data),1)});else DataPermitService.delete(data.uuid).success(function(){$scope.permitDataList.splice($scope.permitDataList.indexOf(data),
1)})};$scope.addBanData=function(){$mdDialog.show({controller:"DataListController",templateUrl:"app/src/app/auth/config/dataListDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{selectedSysRes:$scope.selectedTreeNode,selectedSysCpt:$scope.selectedSysCpt}}).then(function(data){DataBanService.add($scope.entityType,$scope.selectedItem.uuid,data.selectedData.valueUuid,$scope.selectedSysCpt.uuid).success(function(response){if($scope.banDataList)if(data.selectedObject)$scope.banDataList.push(data.selectedObject);
else $scope.banDataList.push(response)})})};$scope.deleteBanData=function(data){if($scope.selectedSysCpt.objectFlag=="1")DataBanService.delete(null,$scope.entityType,$scope.selectedItem.uuid,data.uuid||data.UUID,$scope.selectedSysCpt.uuid).success(function(){$scope.banDataList.splice($scope.banDataList.indexOf(data),1)});else DataBanService.delete(data.uuid).success(function(){$scope.banDataList.splice($scope.banDataList.indexOf(data),1)})};$scope.addSysCpt=function(){$mdDialog.show({controller:"AddSysCptController",
templateUrl:"app/src/app/auth/config/addSysCptDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{allSysCptNames:$scope.allSysCptNames}}).then(function(data){SysCptService.add(data.sysCpt.name,data.sysCpt.value,$scope.selectedTreeNode.uuid,data.sysCpt.objectFlag).success(function(data){$scope.cptList=$scope.cptList||[];$scope.cptList.push(data);CptService.getAll($scope.entityType,$scope.selectedItem.uuid,"",$scope.selectedTreeNode.uuid).success(function(data){$scope.detailCpts=
data;angular.forEach(data,function(value,index){angular.forEach($scope.cptList,function(cpt){if(value.sysCpt&&cpt.uuid==value.sysCpt.uuid&&value.displayFlag=="1")cpt.checked=true})})})})})};$scope.deleteSysCpt=function(sysCpt){$scope.showConfirm("确认删除吗？","允许和禁止数据会被同步删除。",function(){if(sysCpt)SysCptService.delete(sysCpt.uuid).success(function(){$scope.cptList.splice($scope.cptList.indexOf(sysCpt),1);$scope.permitDataList=null;$scope.banDataList=null;$scope.showInfo("删除成功。")})})}});
angular.module("IOne-Production").controller("DataListController",function($mdDialog,$scope,$http,Constant,selectedSysRes,selectedSysCpt){$scope.selectedSysCpt=selectedSysCpt;$scope.selectedSysRes=selectedSysRes;if($scope.selectedSysCpt.objectFlag=="1"){var url=Constant.BACKEND_BASE;if(SYS_CPT_API_MAP[$scope.selectedSysCpt.value])url+=SYS_CPT_API_MAP[$scope.selectedSysCpt.value];else url+=$scope.selectedSysCpt.value+"s";url+="?resUuid\x3d"+selectedSysRes.uuid+"\x26size\x3d1000000";$http.get(url).success(function(data){if(angular.isDefined(data.content))$scope.dataList=
data.content;else $scope.dataList=data})}$scope.selectedData={valueUuid:""};$scope.selectAction=function(item){$scope.searching=false;$scope.selectedData.valueUuid=$scope.selectedSysCpt.objectFlag=="1"?item["uuid"]:item};$scope.$watch("selectedData.valueUuid",function(){angular.forEach($scope.dataList,function(value,index){if(value.uuid==$scope.selectedData.valueUuid)$scope.selectedObject=value})});$scope.hideDlg=function(){$mdDialog.hide({"selectedData":$scope.selectedData,"selectedObject":$scope.selectedObject})};
$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").controller("AddSysCptController",function($mdDialog,$scope,allSysCptNames){$scope.allSysCptNames=allSysCptNames;$scope.sysCpt={name:"",value:"",objectFlag:"1"};$scope.hideDlg=function(){$mdDialog.hide({"sysCpt":$scope.sysCpt})};$scope.selectAction=function(value){$scope.sysCpt.value=value.value;$scope.sysCpt.objectFlag=value.objectFlag;$scope.searching=false};$scope.$watch("sysCpt.value",function(){$scope.sysCpt.objectFlag=$scope.allSysCptNames[$scope.sysCpt.value].objectFlag});
$scope.cancelDlg=function(){$mdDialog.cancel()}});angular.module("IOne-Production").service("CustomerAddress",function($http,Constant){this.getAll=function(sizePerPage,page,customerUuid){return $http.get(Constant.BACKEND_BASE+"/customers/"+customerUuid+"/addresses?"+"size\x3d"+sizePerPage+"\x26page\x3d"+page)}});angular.module("IOne-Production").factory("SysTable",function($resource){return $resource("/sysTables/:uuid",{},{update:{method:"PATCH"}})});
angular.module("IOne-Production").factory("ShareTreeMaster",function($resource){return $resource("/shareTreeMasters/:uuid",{},{update:{method:"PATCH"}})});angular.module("IOne-Production").factory("ShareTreeDetail",function($resource){return $resource("/shareTrees/:shareTreeUuid/details/:uuid",{},{update:{method:"PATCH"}})});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/cbi/deliver-way",{controller:"DeliverWayController",templateUrl:"app/src/app/cbi/deliver_way/deliverWay.html"})}]);
angular.module("IOne-Production").controller("DeliverWayController",function($q,$scope,DeliverWay,Constant){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true;$scope.selectedItemSize=0;$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={select:{status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value},no:"",name:"",
keyWord:""};$scope.menuDisplayOption={"switchConfirm":{display:true,name:"审核/取消审核",uuid:"a31a566c-083e-4246-8eed-aaa67f108d9c"},"switchStatus":{display:true,name:"启用/禁用",uuid:"6b492f90-86b5-4079-b3e3-5d5c358db383"},"batchConfirm":{display:true,name:"批量审核",uuid:"ed8443b3-e835-404d-bbe9-d19d357924c4"},"batchRevertConfirm":{display:true,name:"批量取审",uuid:"01c0299b-2beb-4b93-abe2-0d53ef407fdc"},"batchStatus":{display:true,name:"批量启用",uuid:"cf7e6d2c-f64c-4dce-9c4b-9590dc132384"},"batchRevertStatus":{display:true,
name:"批量禁用",uuid:"e10c7c56-63cc-4647-ae7d-41e97fe9423c"},"batchDelete":{display:true,name:"批量删除",uuid:"92d5b47c-90f3-49df-bdc0-d7c5cfc63bab"},"detailConfirm":{display:true,name:"审核",uuid:"503293be-e7e6-486a-b4bb-be8994251162"},"detailRevertConfirm":{display:true,name:"取审",uuid:"7fbca036-6587-47db-a022-12fe7189a645"},"detailStatus":{display:true,name:"启用",uuid:"a698b75b-35f1-4c45-9c39-ce4d3a4eb922"},"detailRevertStatus":{display:true,name:"禁用",uuid:"5e5010e6-c1ad-4be2-ad12-301537c62014"},"detailDelete":{display:true,
name:"删除",uuid:"ac92076a-d017-45f8-a46f-cfd7a29cb93e"}};$scope.sortByField="no";$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.refreshList=function(){DeliverWay.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements})};$scope.getMenuAuthData($scope.RES_UUID_MAP.CBI.DELIVER_WAY.RES_UUID).success(function(data){$scope.menuAuthDataMap=
$scope.menuDataMap(data)});$scope.$watch("listFilterOption.select",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()}};$scope.subItemList=[{no:"1111111",name:"name1",orderAmount:"100",confirm:"1",release:"1",status:"2"},{no:"2222222",name:"name2",orderAmount:"200",
confirm:"2",release:"1",status:"1"},{no:"3333333",name:"name3",orderAmount:"300",confirm:"1",release:"2",status:"2"}];$scope.selectAllFlag=false;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;item.detailList=$scope.subItemList};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;$scope.selectedItem=null};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel)item.detailList=
$scope.subItemList};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);$scope.refreshList()};$scope.hideItemDetailsAction=function(event){$scope.stopEventPropagation(event);$scope.selectedItem=null;$scope.refreshList()};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;
$scope.source=source;$scope.domain=domain;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.source.confirm=="2"&&$scope.source.status=="2"){$scope.showError("不允许状态是已审核又无效,请调整后再保存");return}if($scope.status=="add"){if($scope.domain=="CBI_BASE_DELIV_WAY"){DeliverWay.add($scope.source).success(function(data){$scope.showInfo("新增送货方式成功。");
$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);$scope.refreshList()}).error(function(response){$scope.showError("新增送货方式失败: "+response.message)});$scope.refreshList()}}else if($scope.status=="edit")if($scope.domain=="CBI_BASE_DELIV_WAY")if($scope.source.status==Constant.STATUS[1].value&&$scope.source.confirm!=Constant.CONFIRM[2].value)DeliverWay.modify($scope.source.uuid,$scope.source).success(function(data){$scope.showInfo("修改送货方式成功。");$scope.source=data;$scope.selectedItem=data;$scope.selectedItemBackUp=
angular.copy($scope.selectedItem)}).error(function(response){$scope.showError("修改送货方式失败。"+response.message);$scope.source=angular.copy($scope.selectedItemBackUp);$scope.selectedItem=angular.copy($scope.selectedItemBackUp)});else $scope.showError($scope.source.no+" 不允许修改：有效且未审核的记录才可以修改！")};$scope.deleteDetailAction=function(detail){};$scope.selectItemAction=function(event,item){$scope.stopEventPropagation(event);item.selectedRef=!item.selected;if(item.selected==false||item.selected==undefined||item.selected==
null)$scope.selectedItemSize+=1;else{$scope.selectedItemSize-=1;$scope.selectAllFlag=false}$scope.disableBatchMenuButtons()};$scope.confirmSwitchAction=function(event,item){$scope.stopEventPropagation(event);if(item.confirm==Constant.CONFIRM[2].value)$scope.showConfirm("确认取消审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};DeliverWay.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("取消审核成功。")})},function(){item.confirm=
Constant.CONFIRM[2].value});else{if(item.status==Constant.STATUS[2].value){$scope.showWarn("项目是失效状态,请先启用后再审核");item.confirm=Constant.CONFIRM[2].value;return}$scope.showConfirm("确认审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};DeliverWay.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("审核成功。")})},function(){item.confirm=Constant.CONFIRM[1].value})}};$scope.statusSwitchAction=function(event,item){$scope.stopEventPropagation(event);
if(item.status==Constant.STATUS[2].value)$scope.showConfirm("确认修改启用状态为有效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};DeliverWay.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("生效成功。")})},function(){item.status=Constant.STATUS[2].value});else $scope.showConfirm("确认修改启用状态为失效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value,confirm:Constant.CONFIRM[1].value};DeliverWay.modify(UpdateInput.uuid,
UpdateInput).success(function(){item.confirm=Constant.CONFIRM[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("失效成功。")})},function(){item.status=Constant.STATUS[1].value})};$scope.confirmClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("confirm...");$scope.stopEventPropagation(event);console.info("status...");var msg="确认取消审核吗？";var input="1";var resultMsg="取消审核成功！";if(item.confirm!="2"){msg="确认审核吗？";input="2";resultMsg="审核成功！"}$scope.showConfirm(msg,"",function(){DeliverWay.modify(item.uuid,
{"confirm":input}).success(function(){item.confirm=input;$scope.showInfo(resultMsg)}).error(function(response){$scope.showError(response.message)})})};$scope.statusClickAction=function(event,item){$scope.stopEventPropagation(event);if(item.status==Constant.STATUS[1].value)$scope.showConfirm("确认改为失效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value,confirm:Constant.CONFIRM[1].value};DeliverWay.modify(item.uuid,UpdateInput).success(function(){item.status=Constant.STATUS[2].value;
item.confirm=Constant.CONFIRM[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("修改为失效成功！")}).error(function(response){$scope.showError(response.message)})});else $scope.showConfirm("确认改为生效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};DeliverWay.modify(item.uuid,UpdateInput).success(function(){item.status=Constant.STATUS[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("修改为生效成功！")}).error(function(response){$scope.showError(response.message)})})};
$scope.releaseClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("release...")};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("delete...")};$scope.confirmAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");return}$scope.showConfirm("确认审核吗","",function(){var promises=[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected){var response=
DeliverWay.modify(item.uuid,{"confirm":"2"}).success(function(){item.confirm="2"}).error(function(response){bError=true;$scope.showError(item.no+" 审核失败："+response.message)});promises.push(response)}});$q.all(promises).then(function(data){if(!bError)$scope.showInfo("审核成功！");$scope.disableBatchMenuButtons()})})};$scope.cancelConfirmAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");return}$scope.showConfirm("确认取消审核吗","",function(){var promises=
[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected){var response=DeliverWay.modify(item.uuid,{"confirm":"1"}).success(function(){item.confirm="1"}).error(function(response){bError=true;$scope.showError(item.no+" 取消审核失败："+response.message)});promises.push(response)}});$q.all(promises).then(function(data){if(!bError){$scope.showInfo("取消审核成功！");$scope.disableBatchMenuButtons()}})})};$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==
0){$scope.showWarn("请先选择记录！");return}$scope.showConfirm("确认启用吗","",function(){var promises=[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected){var response=DeliverWay.modify(item.uuid,{"status":"1"}).success(function(){item.status="1"}).error(function(response){bError=true;$scope.showError(item.no+" 启用失败："+response.message)});promises.push(response)}});$q.all(promises).then(function(data){if(!bError){$scope.showInfo("启用成功！");$scope.disableBatchMenuButtons()}})})};
$scope.cancelStatusAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");return}$scope.showConfirm("确认禁用吗","",function(){var promises=[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected){var response=DeliverWay.modify(item.uuid,{"status":"2","confirm":"1"}).success(function(){item.status="2";item.confirm="1"}).error(function(response){bError=true;$scope.showError(item.no+" 禁用失败："+response.message)});
promises.push(response)}});$q.all(promises).then(function(data){if(!bError){$scope.showInfo("禁用成功！");$scope.disableBatchMenuButtons()}})})};$scope.releaseAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("release all...")};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");return}$scope.showConfirm("确认删除吗","",function(){var promises=[];var bError=false;angular.forEach($scope.itemList,
function(item){if(item.selected)if(item.status==Constant.STATUS[1].value&&item.confirm!=Constant.CONFIRM[2].value){var response=DeliverWay.delete(item.uuid).success(function(){$scope.refreshList()}).error(function(response){bError=true;$scope.showError(item.no+" 删除失败："+response.message)});promises.push(response)}else{bError=true;$scope.showError(item.no+" 不允许删除：有效且未审核的记录才可以删除！")}});$q.all(promises).then(function(data){if(!bError){$scope.showInfo("删除成功！");$scope.disableBatchMenuButtons()}})})};$scope.selectAllAction=
function(){angular.forEach($scope.itemList,function(item){if($scope.selectAllFlag)item.selected=true;else item.selected=false;item.selectedRef=item.selected});$scope.selectedItemSize=0;if($scope.selectAllFlag)angular.forEach($scope.itemList,function(item){$scope.selectedItemSize++});$scope.disableBatchMenuButtons()};$scope.disableBatchMenuButtons=function(){var selectedCount=0;var confirm="";var status="";var diffConfirm=false;var diffStatus=false;angular.forEach($scope.itemList,function(item,index){if(item.selectedRef){selectedCount++;
if(confirm=="")confirm=item.confirm;else if(confirm!=item.confirm)diffConfirm=true;if(status=="")status=item.status;else if(status!=item.status)diffStatus=true}});if(selectedCount==0){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}else{if(diffConfirm==true){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchDelete=true}else if(confirm==
"2"){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=false;$scope.disabledBatchDelete=true}else{$scope.disabledBatchConfirm=false;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchDelete=false}if(diffStatus==true){$scope.disabledBatchConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}else if(status=="1"){$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=false}else{$scope.disabledBatchConfirm=
true;$scope.disabledBatchStatus=false;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}}}});
angular.module("IOne-Production").service("DeliverWay",function($http,Constant){this.getAll=function(sizePerPage,page,filter){var confirm=filter.select.confirm==0?"":filter.select.confirm;var status=filter.select.status==0?"":filter.select.status;var url="deliverWays?size\x3d"+sizePerPage+"\x26page\x3d"+page;if(confirm!=="")url=url+"\x26confirm\x3d"+confirm;if(status!=="")url=url+"\x26status\x3d"+status;if(filter.no!=null)url=url+"\x26no\x3d"+filter.no;if(filter.name!=null)url=url+"\x26name\x3d"+
filter.name;if(filter.keyWord!=null)url=url+"\x26keyWord\x3d"+filter.keyWord;return $http.get(Constant.BACKEND_BASE+url)};this.modify=function(uuid,deliverWayUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/deliverWays/"+uuid,deliverWayUpdateInput)};this.add=function(DeliveryWayInput){return $http.post(Constant.BACKEND_BASE+"/deliverWays/",DeliveryWayInput)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/deliverWays/"+uuid)}});
angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/cbi/department",{controller:"DepartmentController",templateUrl:"app/src/app/cbi/department/departmentList.html"})}]);
angular.module("IOne-Production").controller("DepartmentController",function($q,$mdDialog,$scope,Department,Constant){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.selectedItemSize=0;$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={status:Constant.STATUS[1].value,confirm:Constant.CONFIRM[1].value};$scope.sortByAction=function(field){$scope.sortByField=
field;$scope.sortType=""};$scope.refreshList=function(){Department.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;$scope.selectedItemSize=0})};$scope.$watch("listFilterOption",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);
$scope.subItemList=[];$scope.selectAllFlag=false;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;$scope.initBody(item)};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;$scope.selectedItem=null};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel)item.detailList=$scope.subItemList};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};
$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS)};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.status==
"add"){if($scope.domain=="CBI_BASE_DELIV_WAY"){Department.add($scope.source).success(function(data){$scope.showInfo("新增送货方式成功。");$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);$scope.refreshList()}).error(function(response){$scope.showError("新增送货方式失败: "+response.message)});$scope.refreshList()}}else if($scope.status=="edit")if($scope.domain=="CBI_BASE_DELIV_WAY")if($scope.source.status==Constant.STATUS[1].value&&$scope.source.confirm!=Constant.CONFIRM[2].value)Department.modify($scope.source.uuid,
$scope.source).success(function(data){$scope.showInfo("修改送货方式成功。");$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);$scope.refreshList()}).error(function(response){$scope.showError("修改送货方式失败。"+response.message)});else $scope.showError($scope.source.no+" 不允许修改：有效且未审核的记录才可以修改！")};$scope.deleteDetailAction=function(detail){};$scope.selectItemAction=function(event,item){$scope.stopEventPropagation(event);item.selectedRef=!item.selected;if(item.selected==false||item.selected==undefined||item.selected==
null)$scope.selectedItemSize+=1;else{$scope.selectedItemSize-=1;$scope.selectAllFlag=false}$scope.disableBatchMenuButtons()};$scope.confirmClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("confirm...");$scope.stopEventPropagation(event);console.info("status...");var msg="确认取消审核吗？";var input="1";var resultMsg="取消审核成功！";if(item.confirm!="2"){msg="确认审核吗？";input="2";resultMsg="审核成功！"}$scope.showConfirm(msg,"",function(){Department.modify(item.uuid,{"confirm":input}).success(function(){item.confirm=
input;$scope.showInfo(resultMsg)}).error(function(response){$scope.showError(response.message)})})};$scope.statusClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("status...");var msg="确认禁用吗？";var input="2";var resultMsg="禁用成功！";if(item.status!="1"){msg="确认启用吗？";input="1";resultMsg="启用成功！"}$scope.showConfirm(msg,"",function(){Department.modify(item.uuid,{"status":input}).success(function(){item.status=input;$scope.showInfo(resultMsg)}).error(function(response){$scope.showError(response.message)})})};
$scope.releaseClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("release...")};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("delete...")};$scope.confirmAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");return}$scope.showConfirm("确认审核吗","",function(){var promises=[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected){var response=
Department.modify(item.uuid,{"confirm":"2"}).success(function(){item.confirm="2"}).error(function(response){bError=true;$scope.showError(item.no+" 审核失败："+response.message)});promises.push(response)}});$q.all(promises).then(function(data){if(!bError)$scope.showInfo("审核成功！");$scope.disableBatchMenuButtons()})})};$scope.cancelConfirmAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");return}$scope.showConfirm("确认取消审核吗","",function(){var promises=
[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected){var response=Department.modify(item.uuid,{"confirm":"1"}).success(function(){item.confirm="1"}).error(function(response){bError=true;$scope.showError(item.no+" 取消审核失败："+response.message)});promises.push(response)}});$q.all(promises).then(function(data){if(!bError){$scope.showInfo("取消审核成功！");$scope.disableBatchMenuButtons()}})})};$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==
0){$scope.showWarn("请先选择记录！");return}$scope.showConfirm("确认启用吗","",function(){var promises=[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected){var response=Department.modify(item.uuid,{"status":"1"}).success(function(){item.status="1"}).error(function(response){bError=true;$scope.showError(item.no+" 启用失败："+response.message)});promises.push(response)}});$q.all(promises).then(function(data){if(!bError){$scope.showInfo("启用成功！");$scope.disableBatchMenuButtons()}})})};
$scope.cancelStatusAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");return}$scope.showConfirm("确认禁用吗","",function(){var promises=[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected){var response=Department.modify(item.uuid,{"status":"2"}).success(function(){item.status="2"}).error(function(response){bError=true;$scope.showError(item.no+" 禁用失败："+response.message)});promises.push(response)}});
$q.all(promises).then(function(data){if(!bError){$scope.showInfo("禁用成功！");$scope.disableBatchMenuButtons()}})})};$scope.releaseAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("release all...")};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");return}$scope.showConfirm("确认删除吗","",function(){var promises=[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected)if(item.status==
Constant.STATUS[1].value&&item.confirm!=Constant.CONFIRM[2].value){var response=Department.delete(item.uuid).success(function(){$scope.refreshList()}).error(function(response){bError=true;$scope.showError(item.no+" 删除失败："+response.message)});promises.push(response)}else{bError=true;$scope.showError(item.no+" 不允许删除：有效且未审核的记录才可以删除！")}});$q.all(promises).then(function(data){if(!bError){$scope.showInfo("删除成功！");$scope.disableBatchMenuButtons()}})})};$scope.selectAllAction=function(){angular.forEach($scope.itemList,
function(item){if($scope.selectAllFlag)item.selected=true;else item.selected=false;item.selectedRef=item.selected});$scope.selectedItemSize=0;if($scope.selectAllFlag)angular.forEach($scope.itemList,function(item){$scope.selectedItemSize++});$scope.disableBatchMenuButtons()};$scope.disableBatchMenuButtons=function(){var selectedCount=0;var confirm="";var status="";var diffConfirm=false;var diffStatus=false;angular.forEach($scope.itemList,function(item,index){if(item.selectedRef){selectedCount++;if(confirm==
"")confirm=item.confirm;else if(confirm!=item.confirm)diffConfirm=true;if(status=="")status=item.status;else if(status!=item.status)diffStatus=true}});if(selectedCount==0){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true}else{if(diffConfirm==true){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true}else if(confirm=="2"){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=
false}else{$scope.disabledBatchConfirm=false;$scope.disabledBatchCancelConfirm=true}if(diffStatus==true){$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true}else if(status=="1"){$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=false}else{$scope.disabledBatchStatus=false;$scope.disabledBatchCancelStatus=true}}};$scope.editNodeDisabled=false;$scope.saveNodeDisabled=true;$scope.cancelModifyDisabled=true;$scope.quitDisabled=true;$scope.formMenuDisplayOption={"102-edit":{display:true,
name:"编辑",uuid:"D7C5647E-6604-41563-8CC2-DF5B3EAB5F70"},"302-save":{display:true,name:"保存",uuid:"56F359CF-3FR4-5T4D-B321-D45816621291"},"303-cancel":{display:true,name:"取消修改",uuid:"4B958029-E637-4B22-B30F-94AAE55EA680"},"304-quit":{display:true,name:"退出编辑",uuid:"D7BAA884-3F9C-4165-BF58-C22C2C69259A"}};$scope.initHeaders=function(){$scope.headers=[{"grade":1,"name":"1级"},{"grade":2,"name":"2级"},{"grade":3,"name":"3级"},{"grade":4,"name":"4级"},{"grade":5,"name":"5级"},{"grade":6,"name":"6级"}];$scope.selectedTemplateData=
{}};$scope.initHeaders();$scope.initBody=function(item){$scope.selectedTemplateData={};item.grade=1;$scope.selectedTemplateData[$scope.headers[0].grade]=new Array(item);$scope.refreshAddNodeButtonDisplay();$scope.nodeDataClickHandler($scope.headers[0].grade,item)};$scope.nodeDataClickHandler=function(selectedGrade,selectedNode){angular.forEach($scope.selectedTemplateData[selectedGrade],function(node){node.selected=false});selectedNode.selected=true;$scope.selectedNode=selectedNode;$scope.backupSelectedNode=
$scope.backup(selectedNode);$scope.clearChildren(selectedNode);Department.getForParent(selectedNode.uuid).success(function(data){if(data&&data.content&&data.content.length>0){angular.forEach(data.content,function(item){item.grade=selectedGrade+1});$scope.selectedTemplateData[selectedGrade+1]=data.content}$scope.isRefreshing=false}).error(function(){$scope.isRefreshing=false});$scope.refreshAddNodeButtonDisplay()};$scope.refreshTemplateData=function(template,node){if(template&&template.length>0){var dataHandler=
function(template,node,data){var content=$scope.selectedTemplateData[template.uuid];if(content==undefined||content==null){content=[data];$scope.selectedTemplateData[template.uuid]=content}};dataHandler(template,node,$scope.selectedItem)}};$scope.backup=function(department){return{uuid:department.uuid,no:department.no,name:department.name,status:department.status,confirm:department.confirm,fullPath:department.fullPath,grade:department.grade}};$scope.changeToEditMode=function(){$scope.backupSelectedNode=
$scope.backup($scope.selectedNode);$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS,0)};$scope.quitEditMode=function(){$scope.showConfirm("修改尚未保存，确认退出编辑吗？","",function(){$scope.selectedNode=$scope.backupSelectedNode;$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS,0)})};$scope.cancelModification=function(){if($scope.backupSelectedNode!=null)$scope.selectedNode=$scope.backupSelectedNode};$scope.updateNodeData=function(){$scope.showConfirm("确认修改该节点数据吗？","",function(){if($scope.selectedNode){$scope.selectedNode.belongCbiBaseDeptUuid=
$scope.selectedNode.parentUuid;Department.modify($scope.selectedNode.uuid,$scope.selectedNode).success(function(data){$scope.showInfo("修改节点数据成功。");$scope.selectedNode.no=data.no;$scope.selectedNode.name=data.name;$scope.selectedNode.fullPath=data.fullPath;$scope.selectedNode.parentUuid=data.belongCbiBaseDeptUuid;$scope.selectedNode.belongCbiBaseDeptUuid=data.belongCbiBaseDeptUuid;$scope.backupSelectedNode=$scope.backup($scope.selectedNode)}).error(function(data){$scope.showError("修改节点数据失败: "+data.message);
$scope.selectedNode.no=$scope.backupSelectedNode.no;$scope.selectedNode.name=$scope.backupSelectedNode.name;$scope.selectedNode.fullPath=$scope.backupSelectedNode.fullPath;$scope.selectedNode.parentUuid=$scope.backupSelectedNode.belongCbiBaseDeptUuid;$scope.selectedNode.belongCbiBaseDeptUuid=$scope.backupSelectedNode.belongCbiBaseDeptUuid})}})};$scope.refreshAddNodeButtonDisplay=function(){angular.forEach($scope.headers,function(header){var showAddButton=$scope.selectedTemplateData[header.grade-1]!=
null&&$scope.selectedTemplateData[header.grade-1].length>0||header.grade==1;if($scope.selectedTemplateData[header.grade-1]!=null)angular.forEach($scope.selectedTemplateData[header.grade-1],function(node){if(node.selected)showAddButton=true});header.showAddButton=showAddButton})};$scope.addNodeData=function(grade,bRefreshList){var parentUuid=null;var parentName=null;var fullPath=[];var parentNodes=$scope.selectedTemplateData[grade-1];angular.forEach(parentNodes,function(parentNode){if(parentNode.selected){parentUuid=
parentNode.uuid;parentName=parentNode.name;fullPath=[].concat(parentNode.fullPath)}});$mdDialog.show({controller:"DepartmentDlgController",templateUrl:"app/src/app/cbi/department/addDepartment.html",parent:angular.element(document.body),targetEvent:event,locals:{parentName:parentName}}).then(function(data){var departmentInput={no:data.no,name:data.name,status:data.status,confirm:data.confirm,belongCbiBaseDeptUuid:parentUuid};Department.add(departmentInput).success(function(data){fullPath.push(data.name);
data.fullPath=fullPath;data.selected=true;data.grade=grade;if(bRefreshList)$scope.itemList.push(data);else{if($scope.selectedTemplateData[grade]==null)$scope.selectedTemplateData[grade]=[data];else $scope.selectedTemplateData[grade].push(data);var addItem;angular.forEach($scope.selectedTemplateData[grade],function(v){if(v.uuid==data.uuid)addItem=v});if(addItem!=null)$scope.nodeDataClickHandler(grade,addItem)}$scope.showInfo("新增数据成功。")}).error(function(response){$scope.showError("新增数据失败: "+response.message)})})};
$scope.deleteNodeData=function($event,item){$scope.showConfirm("确认清除该节点数据吗？","节点数据删除后不可恢复。",function(){Department.delete(item.uuid).success(function(){var indexToDelete=-1;angular.forEach($scope.selectedTemplateData[item.grade],function(v,index){if(v.uuid==item.uuid)indexToDelete=index});$scope.selectedTemplateData[item.grade].splice(indexToDelete,1);if(item.selected)$scope.clearChildren(item);$scope.showInfo("删除节点数据成功。")}).error(function(response){$scope.showError("删除节点数据失败: "+response.message)})});
$event.stopPropagation();$event.preventDefault()};$scope.clearChildren=function(item){for(var i=Number(item.grade)+1;i<=$scope.headers[$scope.headers.length-1].grade;i++)if($scope.selectedTemplateData[i]!=null)$scope.selectedTemplateData[i].splice(0)};$scope.openSelectParentDlg=function(){$mdDialog.show({controller:"SelectParentDptDlgController",templateUrl:"app/src/app/cbi/department/selectParentDptDlg.html",parent:angular.element(document.body),targetEvent:event}).then(function(parent){$scope.selectedNode.parentUuid=
parent.uuid;$scope.selectedNode.parentName=parent.name;parent.fullPath.push($scope.selectedNode.name);$scope.selectedNode.fullPath=parent.fullPath})}});angular.module("IOne-Production").controller("DepartmentDlgController",function($scope,$mdDialog,parentName){$scope.parentName=parentName;$scope.hideDlg=function(){$mdDialog.hide($scope.data)};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").controller("SelectParentDptDlgController",function($scope,$mdDialog,Constant,Department){$scope.pageOption={sizePerPage:5,currentPage:0,totalPage:0,totalElements:0,displayModel:0};$scope.filter={confirm:Constant.CONFIRM[2].value,status:Constant.STATUS[1].value};$scope.refreshDepartmentList=function(bResetPage){Department.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.filter).success(function(data){$scope.departmentList=data.content;$scope.pageOption.totalElements=
data.totalElements;$scope.pageOption.totalPage=data.totalPages})};$scope.refreshDepartmentList();$scope.selectDepartment=function(department){$mdDialog.hide(department)};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").service("Department",function($http,Constant){this.getAll=function(sizePerPage,page,filter){var confirm=filter.confirm==0?"":filter.confirm;var status=filter.status==0?"":filter.status;var url="departments?size\x3d"+sizePerPage+"\x26page\x3d"+page;if(confirm!=="")url=url+"\x26confirm\x3d"+confirm;if(status!=="")url=url+"\x26status\x3d"+status;if(filter.no!=null)url=url+"\x26no\x3d"+filter.no;if(filter.name!=null)url=url+"\x26name\x3d"+filter.name;if(filter.searchKeyWord!=
null)url=url+"\x26searchKeyWord\x3d"+filter.searchKeyWord;return $http.get(Constant.BACKEND_BASE+url)};this.modify=function(uuid,departmentUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/departments/"+uuid,departmentUpdateInput)};this.add=function(departmentInput){return $http.post(Constant.BACKEND_BASE+"/departments/",departmentInput)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/departments/"+uuid)};this.getForParent=function(parentUuid){return $http.get(Constant.BACKEND_BASE+
"/departments?parentUuid\x3d"+parentUuid)}});
angular.module("IOne-directives").directive("imageSlider",function(){return{scope:{photos:"\x3d",index:"\x3d"},templateUrl:"app/src/js/directive/slider.html",link:function($scope){$scope._Index=0;$scope.isActive=function(index){return $scope._Index===index};$scope.showPrev=function(){$scope._Index=$scope._Index>0?--$scope._Index:$scope.photos.length-1};$scope.showNext=function(){$scope._Index=$scope._Index<$scope.photos.length-1?++$scope._Index:0};$scope.showPhoto=function(index){$scope._Index=index};
$scope.$watch("_Index",function(){$scope.index.value=$scope._Index})}}});
angular.module("IOne-directives").directive("datePicker",function(){return{restrict:"A",scope:{object:"\x3d",field:"@",viewField:"@",initValue:"@"},link:function(scope,element){var getDateString=function(longValue){var date=new Date(longValue);return date.getFullYear()+"/"+(date.getMonth()+1)+"/"+date.getDate()};$(function(){element.datepicker({dateFormat:"yy/mm/dd",onSelect:function(date){scope.$apply(function(){scope.object[scope.viewField]=date;scope.object[scope.field]=(new Date(date)).getTime()})}});
if(scope.initValue)scope.object[scope.viewField]=getDateString(scope.object[scope.field]);else{scope.object[scope.viewField]=getDateString((new Date).getTime());scope.object[scope.field]=(new Date).getTime()}})}}});
angular.module("IOne-directives").directive("pagination",function(){return{scope:{option:"\x3d",callback:"\x26"},templateUrl:"app/src/js/directive/pagination.html",link:function($scope){$scope.prePage=function(){if($scope.option.currentPage>0){$scope.option.currentPage=$scope.option.currentPage-1;$scope.callback()}};$scope.nextPage=function(){if($scope.option.currentPage<$scope.option.totalPage-1){$scope.option.currentPage=$scope.option.currentPage+1;$scope.callback()}};$scope.firstPage=function(){if($scope.option.currentPage!=
0){$scope.option.currentPage=0;$scope.callback()}};$scope.lastPage=function(){if($scope.option.currentPage!=$scope.option.totalPage-1){$scope.option.currentPage=$scope.option.totalPage-1;$scope.callback()}}}}});
angular.module("IOne-directives").directive("productionList",function(Production,Constant,$mdDialog){return{scope:{buttonName:"@",buttonCallback:"\x26",selectItemCallback:"\x26",param:"\x3d"},templateUrl:"app/src/js/directive/productionList.html",link:function($scope){$scope.PROD_TYPE=Constant.PROD_TYPE;$scope.pageOption={sizePerPage:16,currentPage:0,totalPage:100,totalElements:100};$scope.searchQuery={type:0,no:"",name:""};$scope.param=$scope.param||{confirm:0,release:0,status:0,eshopType:0,assemblingFlag:""};
$scope.queryAction=function(){$scope.pageOption.currentPage=0;$scope.refreshProduction()};$scope.queryEnter=function(e){if(e.keyCode===13)$scope.queryAction()};$scope.refreshProduction=function(){Production.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.param.confirm,$scope.param.release,$scope.param.status,$scope.searchQuery.type,0,$scope.searchQuery.no,$scope.searchQuery.name,"",$scope.param.eshopType,$scope.param.assemblingFlag,"1","1").success(function(data){$scope.allProductionsData=
data;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements})};$scope.refreshProduction();$scope.getImageFullPath=function(path){if(path==null)return Constant.BACKEND_BASE+"/app/img/item.jpeg";else return Constant.BACKEND_BASE+"/app/assets/IMAGE/"+path};$scope.buttonCallbackHandler=function(production){$scope.buttonCallback({production:production})};$scope.selectItemCallbackHandler=function(production){$scope.selectItemCallback({production:production})};$scope.openQuickView=
function($event,production){$mdDialog.show({controller:"QuickViewController",templateUrl:"app/src/app/production/production/quick_view.html",parent:angular.element(document.body),targetEvent:event,locals:{productionUuid:production.uuid}}).then(function(data){});$event.stopPropagation();$event.preventDefault()}}}});
angular.module("IOne-directives").directive("orgChart",function($compile){return{scope:{sourceUpdateFlag:"\x3d",source:"\x3d",callback:"\x26",selectCallback:"\x26"},templateUrl:"app/src/js/directive/orgChart.html",link:function($scope,$element){$scope.opts={chartElement:"#chart",dragAndDrop:true,control:false,rowcolor:false,callback:function(sourceId,targetId){$scope.callback({source:sourceId,dest:targetId});setInterval(function(){$scope.bindClick()},1E3)}};$scope.sourceChangeHandler=function(){$("#in").empty();
$("#chart").empty();$scope.loadjson();$scope.init_tree();$compile($element.contents())($scope)};$scope.$watch("source.length",function(){$scope.sourceChangeHandler()});$scope.$watch("sourceUpdateFlag",function(){$scope.sourceChangeHandler()});$scope.bindClick=function(){$(".node").off("click").on("click",function(event){$(".node").removeClass("highlight-node");$(event.currentTarget).addClass("highlight-node");var allClass=$(event.currentTarget).attr("class").split(/\s+/);$scope.selectCallback({uuid:allClass[1]})});
$(".label_node").off("click").on("click",function(event){$(".node").removeClass("highlight-node");$(event.currentTarget.parentNode).addClass("highlight-node");var allClass=$(event.currentTarget.parentNode).attr("class").split(/\s+/);$scope.selectCallback({uuid:allClass[1]});event.stopPropagation();event.preventDefault()})};$scope.init_tree=function(){$("#org").jOrgChart($scope.opts);$scope.bindClick()};$scope.loadjson=function(){var items=[];var data=TAFFY($scope.source);data({"parent":""}).each(function(record){loops(record)});
function loops(root){if(root.parent=="")if(root.aamFlag=="1")items.push("\x3cli class\x3d'"+root.uuid+" green unic"+root.id+" root' id\x3d'"+root.uuid+"'\x3e\x3cspan class\x3d'label_node'\x3e"+root.name+"\x3c/br\x3e\x3c/span\x3e\x3cspan class\x3d'label_node'\x3e"+root.channel+"\x3c/span\x3e");else{if(root.aamFlag=="2")items.push("\x3cli class\x3d'"+root.uuid+" red unic"+root.id+" root' id\x3d'"+root.uuid+"'\x3e\x3cspan class\x3d'label_node'\x3e"+root.name+"\x3c/br\x3e\x3c/span\x3e\x3cspan class\x3d'label_node'\x3e"+
root.channel+"\x3c/span\x3e")}else if(root.aamFlag=="1")items.push("\x3cli class\x3d'"+root.uuid+" green child unic"+root.id+"' id\x3d'"+root.uuid+"'\x3e\x3cspan class\x3d'label_node'\x3e"+root.name+"\x3c/br\x3e\x3c/span\x3e\x3cspan class\x3d'label_node'\x3e"+root.channel+"\x3c/span\x3e");else if(root.aamFlag=="2")items.push("\x3cli class\x3d'"+root.uuid+" red child unic"+root.id+"' id\x3d'"+root.uuid+"'\x3e\x3cspan class\x3d'label_node'\x3e"+root.name+"\x3c/br\x3e\x3c/span\x3e\x3cspan class\x3d'label_node'\x3e"+
root.channel+"\x3c/span\x3e");var c=data({"parent":root.id}).count();if(c!=0){items.push("\x3cul\x3e");data({"parent":root.id}).each(function(record,recordnumber){loops(record)});items.push("\x3c/ul\x3e\x3c/li\x3e")}else items.push("\x3c/li\x3e")}$("\x3cul/\x3e",{"id":"org","style":"float:right;",html:items.join("")}).appendTo("#in")}}}});
angular.module("IOne-directives").directive("objectEditor",function($http,Constant,$mdDialog){return{scope:{status:"\x3d",source:"\x3d",domain:"\x3d"},templateUrl:"app/src/js/directive/objectEditor.html",link:function($scope){$scope.$watch("source",function(){if($scope.status=="add");else if($scope.status=="edit");if($scope.source)$http.get(Constant.BACKEND_BASE+"/objectInfo/"+$scope.domain).success(function(data){$scope.objectInfo=data;angular.forEach(Object.keys($scope.objectInfo),function(key){if($scope.objectInfo[key].type==
"DATE"&&angular.isDefined($scope.source[key])&&$scope.source[key]!=null)$scope.source[key]=new Date($scope.source[key])})})});$scope.openDlg=function(key,fieldInfo){$mdDialog.show({controller:"SearchController",templateUrl:"app/src/app/search.html",parent:angular.element(document.body),targetEvent:event,locals:{source:$scope.source,key:key,objectInfo:$scope.objectInfo,fieldInfo:fieldInfo,queryInfo:$scope.source.queryInfo}}).then(function(data){$scope.source[key]=data;$scope.source[key+"Uuid"]=data.uuid})}}}});
angular.module("IOne-directives").controller("SearchController",function($scope,$http,$mdDialog,Constant,source,key,objectInfo,fieldInfo,queryInfo){$scope.source=source;$scope.key=key;$scope.objectInfo=objectInfo;$scope.fieldInfo=fieldInfo;$scope.queryInfo=queryInfo;$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.$watch("searchKeyword",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.searchInfo=
{keyWord:$scope.searchKeyword,searchKeyWord:$scope.searchKeyword}},true);$scope.queryAction=function(){var param="";if(!jQuery.isEmptyObject($scope.queryInfo))angular.forEach(Object.keys($scope.queryInfo),function(key){param+="\x26"+key+"\x3d"+$scope.queryInfo[key]});if(!jQuery.isEmptyObject($scope.searchInfo)&&!jQuery.isEmptyObject($scope.searchKeyword))angular.forEach(Object.keys($scope.searchInfo),function(key){param+="\x26"+key+"\x3d"+$scope.searchInfo[key]});var url=Constant.BACKEND_BASE+$scope.fieldInfo.url+
"?page\x3d"+$scope.pageOption.currentPage+"\x26size\x3d"+$scope.pageOption.sizePerPage+param;$http.get(url).success(function(data){if(data)if(data.content){$scope.dataList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements}else $scope.dataList=data})};$scope.queryAction();$scope.select=function(selectedObject){$scope.selectedObject=selectedObject;$mdDialog.hide($scope.selectedObject)};$scope.hideDlg=function(){$mdDialog.hide($scope.selectedObject)};
$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-directives").directive("customerAddressList",function(CustomerAddress,Constant,$mdDialog){return{scope:{buttonName:"@",buttonCallback:"\x26",selectItemCallback:"\x26",param:"\x3d"},templateUrl:"app/src/js/directive/customerAddressList.html",link:function($scope){$scope.PROD_TYPE=Constant.PROD_TYPE;$scope.pageOption={sizePerPage:16,currentPage:0,totalPage:100,totalElements:100};$scope.param=$scope.param||{customerUuid:""};$scope.refreshCustomerAddress=function(){CustomerAddress.getAll($scope.pageOption.sizePerPage,
$scope.pageOption.currentPage,$scope.param.customerUuid).success(function(data){$scope.customerAddressList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements})};$scope.refreshCustomerAddress();$scope.selectAddressCallbackHandler=function(customerAddress){$scope.selectItemCallback({customerAddress:customerAddress})}}}});
angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/fam/discountCard",{controller:"DiscountCardController",templateUrl:"app/src/app/fam/dis_card/discountCard.html"})}]);
angular.module("IOne-Production").controller("DiscountCardController",function($scope,$q,DiscountCardService,DiscountChanService,$mdDialog,Constant){$scope.PROMULGATOR=Constant.PROMULGATOR;$scope.REFUND_TYPE=Constant.REFUND_TYPE;$scope.CARD_CONDITION=Constant.CARD_CONDITION;$scope.localTemp={startTime:new Date,overTime:new Date};$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value,
release:Constant.RELEASE[0].value};$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.menuDisplayOption={"405-delete":{display:true,name:"删除",uuid:"b2915045-fc3c-4b93-993b-b6c8ccb03dbd"},"406-query":{display:true,name:"查询",uuid:"08273e82-b124-4f73-bcae-b445bd9b8a0f"},"415-deleteAll":{display:true,name:"批量删除",uuid:"0aa6bcff-8eb6-43f8-bad8-270aab636eda"}};$scope.refreshList=function(){DiscountCardService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,
$scope.listFilterOption.confirm,$scope.listFilterOption.status,$scope.listFilterOption.no,$scope.listFilterOption.name,$scope.listFilterOption.keyWord,$scope.RES_UUID_MAP.CBI.EMPL.RES_UUID).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;$scope.selectAllFlag=false;if($scope.selectedItem!=null)angular.forEach($scope.itemList,function(item){if(item.uuid==$scope.selectedItem.uuid)$scope.showDetailPanelAction(item)})})};
$scope.$watch("listFilterOption",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()}};$scope.selectAllFlag=false;$scope.selectDetailAllFlag=false;$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);
$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain;if(domain=="FAM_BASE_DISCOUNT_CARD"){$scope.source["promulgator"]="4";$scope.source["costType"]="1";$scope.source["refundType"]="Y";$scope.source["specificCardFlag"]="Y";$scope.source["cardCondition"]="4"}else if(domain=="FAM_BASE_DISCOUNT_CARD_CHAN"){$scope.source["discountCard"]=$scope.selectedItem;$scope.source.discountCardUuid=$scope.selectedItem.uuid}};$scope.showDetailPanelAction=function(item){$scope.selectedItem=
item;$scope.showDisChannel(item)};$scope.returnToListAction=function(event,item){$scope.stopEventPropagation(event);$scope.selectedItem=null};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;$scope.selectedItem=null};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel)item.detailList=item};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=
function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);$scope.refreshList()};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain;if(domain=="FAM_BASE_DISCOUNT_CARD"){$scope.selectedItemBackUp=angular.copy($scope.selectedItem);$scope.selectedItemBackUp.startTime=angular.copy(fixDate($scope.selectedItemBackUp.startTime));$scope.selectedItemBackUp.overtime=
angular.copy(fixDate($scope.selectedItemBackUp.overtime))}else if(domain=="FAM_BASE_DISCOUNT_CARD_CHAN"){$scope.selectedItemDetailBackUp=angular.copy($scope.source);$scope.selectedItemDetailBackUp.startTime=angular.copy(fixDate($scope.selectedItemDetailBackUp.startTime));$scope.selectedItemDetailBackUp.overtime=angular.copy(fixDate($scope.selectedItemDetailBackUp.overtime))}};$scope.saveItemAction=function(){if($scope.status=="add")if($scope.domain=="FAM_BASE_DISCOUNT_CARD"){var checkSave=$scope.checkSaveAction($scope.source.startTime,
$scope.source.overTime);if(checkSave){$scope.localTemp.startTime=$scope.source.startTime;$scope.localTemp.overTime=$scope.source.overTime;$scope.source.startTime=fixDate($scope.source.startTime);$scope.source.overTime=fixDate($scope.source.overTime);DiscountCardService.add($scope.source).success(function(data){$scope.source.startTime=$scope.localTemp.startTime;$scope.source.overTime=$scope.localTemp.overTime;$scope.showInfo("新增数据成功。");$scope.refreshList()}).error(function(){$scope.source.startTime=
$scope.localTemp.startTime;$scope.source.overTime=$scope.localTemp.overTime;$scope.refreshList();$scope.showError("新增失败："+"\x3cbr\x3e"+data.message)})}else $scope.refreshList()}else{if($scope.domain=="FAM_BASE_DISCOUNT_CARD_CHAN"){var discardStartTime=$scope.source.discountCard.startTime;var discardOverTime=$scope.source.discountCard.overTime;var checkSave=$scope.checkChanSaveAction($scope.source.startTime,$scope.source.overTime,discardStartTime,discardOverTime);if(checkSave){$scope.localTemp.startTime=
$scope.source.startTime;$scope.localTemp.overTime=$scope.source.overTime;$scope.source.startTime=fixDate($scope.source.startTime);$scope.source.overTime=fixDate($scope.source.overTime);DiscountChanService.add($scope.source).success(function(data){$scope.source.startTime=$scope.localTemp.startTime;$scope.source.overTime=$scope.localTemp.overTime;$scope.showDisChannel(data.discountCard);$scope.showInfo("新增数据成功。")}).error(function(){$scope.source.startTime=$scope.localTemp.startTime;$scope.source.overTime=
$scope.localTemp.overTime;$scope.refreshList();$scope.showError("新增失败："+"\x3cbr\x3e"+data.message)})}else $scope.showDisChannel($scope.source.discountCard)}}else if($scope.status=="edit")if($scope.domain=="FAM_BASE_DISCOUNT_CARD"){var checkSave=$scope.checkSaveAction($scope.source.startTime,$scope.source.overTime);if(checkSave){$scope.localTemp.startTime=$scope.source.startTime;$scope.localTemp.overTime=$scope.source.overTime;$scope.source.startTime=fixDate($scope.source.startTime);$scope.source.overTime=
fixDate($scope.source.overTime);DiscountCardService.modify($scope.source.uuid,$scope.source).success(function(data){data.startTime=fixDate(data.startTime);data.overTime=fixDate(data.overTime);$scope.source=data;$scope.selectedItem=data;$scope.selectedItemBackUp=angular.copy($scope.selectedItem);$scope.refreshList();$scope.showInfo("修改数据成功。")}).error(function(data){$scope.source=angular.copy($scope.selectedItemBackUp);$scope.selectedItem=angular.copy($scope.selectedItemBackUp);$scope.refreshList();
$scope.showError("修改失败："+"\x3cbr\x3e"+data.message)})}}else if($scope.domain=="FAM_BASE_DISCOUNT_CARD_CHAN"){var discardStartTime=$scope.source.discountCard.startTime;var discardOverTime=$scope.source.discountCard.overTime;var checkSave=$scope.checkChanSaveAction($scope.source.startTime,$scope.source.overTime,discardStartTime,discardOverTime);if(checkSave){$scope.localTemp.startTime=$scope.source.startTime;$scope.localTemp.overTime=$scope.source.overTime;$scope.source.startTime=fixDate($scope.source.startTime);
$scope.source.overTime=fixDate($scope.source.overTime);DiscountChanService.modify($scope.source.uuid,$scope.source).success(function(data){data.startTime=fixDate(data.startTime);data.overTime=fixDate(data.overTime);$scope.source=data;$scope.selectedItemDetailBackUp=angular.copy(data);$scope.showInfo("修改数据成功。");$scope.showDisChannel(data.discountCard)}).error(function(data){$scope.source=angular.copy($scope.selectedItemDetailBackUp);$scope.refreshList();$scope.showError("修改失败："+"\x3cbr\x3e"+data.message)})}else $scope.showDisChannel($scope.source.discountCard)}};
$scope.checkSaveAction=function(startTime,overTime){var breakException={};if(startTime>overTime){$scope.showError("开始时间不得晚於的結束时间。");$scope.refreshList();return false}if($scope.domain=="FAM_BASE_DISCOUNT_CARD")angular.forEach($scope.subItemList,function(subItem){if(!$scope.checkChanSaveAction(subItem.startTime,subItem.overTime,startTime,overTime))throw breakException;});return true};$scope.checkChanSaveAction=function(startTime,overTime,discardStartTime,discardOverTime){startTime=fixDate(startTime);
overTime=fixDate(overTime);discardStartTime=fixDate(discardStartTime);discardOverTime=fixDate(discardOverTime);console.log("startTime["+startTime+"],overTime["+overTime+"],discardOverTime["+discardOverTime+"] ,discardOverTime["+discardOverTime+"]");if(startTime>overTime){$scope.showError("开始时间不得晚於的結束时间。");return false}else if(startTime<discardStartTime){console.log("startTime["+startTime+"],discardStartTime["+discardStartTime+"] --\x3e可用门店开始时间不得早于卡券的开始时间");$scope.showError($scope.domain=="FAM_BASE_DISCOUNT_CARD"?
"已有门店开始时间早于您所设定的卡券时间，请先调整门店开始时间":"可用门店开始时间不得早于卡券的开始时间。");$scope.refreshList();return false}else if(overTime>discardOverTime){console.log("overTime["+overTime+"],discardOverTime["+discardOverTime+"] --\x3e可用门店結束时间不得晚于卡券的結束时间");$scope.showError($scope.domain=="FAM_BASE_DISCOUNT_CARD"?"已有门店结束时间早于您所设定的卡券时间，请先调整门店结束时间":"可用门店結束时间不得晚于卡券的結束时间。");$scope.refreshList();return false}else return true};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认删除吗？",
"删除后不可恢复。",function(){DiscountCardService.delete(item.uuid).success(function(){$scope.selectedItem=null;$scope.refreshList();$scope.showInfo("删除数据成功。");$scope.selectItemCount=0})})};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selected.length>0)$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(item){var response=DiscountCardService.delete(item.uuid).success(function(data){});promises.push(response)});
$q.all(promises).then(function(){$scope.showInfo("删除数据成功。");$scope.refreshList();$scope.selectItemCount=0})}})};$scope.deleteDetailAction=function(item){$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){DiscountChanService.delete(item.uuid).success(function(){$scope.showDisChannel(item.discountCard);$scope.showInfo("删除数据成功。")})})};$scope.selectAllAction=function(){if($scope.selectAllFlag==true)angular.forEach($scope.itemList,function(item){var idx=$scope.selected.indexOf(item);if(idx<0)$scope.selected.push(item)});
else if($scope.selectAllFlag==false)$scope.selected=[];$scope.selectItemCount=$scope.selected.length};$scope.selectDetailAllAction=function(){if($scope.selectDetailAllFlag==true)angular.forEach($scope.subItemList,function(item){var idx=$scope.detailSelected.indexOf(item);if(idx<0)$scope.detailSelected.push(item)});else if($scope.selectDetailAllFlag==false)$scope.detailSelected=[];$scope.selectDetailItemCount=$scope.detailSelected.length};$scope.selectItemAction=function(event,item,selected){$scope.stopEventPropagation(event);
var idx=selected.indexOf(item);if(idx>-1)selected.splice(idx,1);else selected.push(item);$scope.selectItemCount=$scope.selected.length};$scope.selectDetailItemAction=function(event,item,detailSelected){$scope.stopEventPropagation(event);var idx=detailSelected.indexOf(item);if(idx>-1)detailSelected.splice(idx,1);else detailSelected.push(item);$scope.selectDetailItemCount=$scope.detailSelected.length};$scope.exists=function(item,selected){return selected.indexOf(item)>-1};$scope.selected=[];$scope.detailSelected=
[];$scope.showDisChannel=function(discount){if(discount.uuid!=undefined)DiscountChanService.get(discount.uuid).success(function(data){console.log($scope.subItemList);$scope.subItemList=data.content})};var fixDate=function(dt){var confDeliverDate=null;if(dt!=null){var myDate=new Date(dt);confDeliverDate=moment(myDate).format("YYYY-MM-DD")}return confDeliverDate};$scope.openBatchUpdateChan=function(item){$mdDialog.show({controller:"ChanUpdateController",templateUrl:"app/src/app/fam/dis_card/batchUpdateChan.html",
parent:angular.element(document.body),targetEvent:event,locals:{editingItem:item}}).then(function(editingItem){var promises=[];var discardStartTime=confDeliverDate=moment(new Date(editingItem[0].discountCard.startTime)).format("YYYY-MM-DD");var discardOverTime=confDeliverDate=moment(new Date(editingItem[0].discountCard.overTime)).format("YYYY-MM-DD");if(editingItem[0].batStartTime<discardStartTime||editingItem[0].batStartTime>discardOverTime){$scope.showError("开始时间须介於卡券日期");return}if(editingItem[0].batOverTime<
discardStartTime||editingItem[0].batOverTime>discardOverTime){$scope.showError("结束时间须介於卡券日期");return}angular.forEach(editingItem,function(item){var postData={"startTime":item.batStartTime,"overTime":item.batOverTime};var response=DiscountChanService.modify(item.uuid,postData).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.selectDetailAllFlag=false;$scope.showInfo("修改数据成功。");$scope.showDisChannel(item[0].discountCard);$scope.detailSelected=[];$scope.selectDetailItemCount=
0})})}});angular.module("IOne-Production").controller("ChanUpdateController",function($scope,Constant,$mdDialog,editingItem){$scope.editingItem=editingItem;$scope.saveDetail=function(){var batStartTime=moment(new Date($scope.batStartTime)).format("YYYY-MM-DD");var batOverTime=moment(new Date($scope.batOverTime)).format("YYYY-MM-DD");angular.forEach($scope.editingItem,function(item){item.batStartTime=batStartTime;item.batOverTime=batOverTime});$mdDialog.hide($scope.editingItem)};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").service("DiscountCardService",function($http,Constant){this.getAll=function(sizePerPage,page,confirm,status,no,name,keyWord,resUuid){confirm=confirm==0?"":confirm;status=status==0?"":status;var url="/discountCards?size\x3d"+sizePerPage+"\x26page\x3d"+page;if(no!==undefined&&no!==null)url=url+"\x26no\x3d"+no;if(name!==undefined&&name!==null)url=url+"\x26name\x3d"+name;if(keyWord!==undefined&&keyWord!==null&&keyWord!=="")url=url+"\x26keyWord\x3d"+keyWord;if(resUuid!==
undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;console.log(url);return $http.get(Constant.BACKEND_BASE+url)};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+"/discountCards/"+uuid)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/discountCards/"+uuid)};this.modify=function(uuid,UpdateInput){return $http.patch(Constant.BACKEND_BASE+"/discountCards/"+uuid,UpdateInput)};this.add=function(AddInput){return $http.post(Constant.BACKEND_BASE+"/discountCards/",
AddInput)}});
angular.module("IOne-Production").service("DiscountChanService",function($http,Constant){this.get=function(discountCardUuid){var url="?";if(discountCardUuid!==undefined&&discountCardUuid!==null)url=url+"discountCardUuid\x3d"+discountCardUuid;return $http.get(Constant.BACKEND_BASE+"/discountCardChannels"+url)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/discountCardChannels/"+uuid)};this.modify=function(uuid,UpdateInput){return $http.patch(Constant.BACKEND_BASE+"/discountCardChannels/"+
uuid,UpdateInput)};this.add=function(AddInput){return $http.post(Constant.BACKEND_BASE+"/discountCardChannels/",AddInput)}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/fam/discountCartType",{controller:"DiscountCartTypeController",templateUrl:"app/src/app/fam/dis_card_type/discountCartType.html"})}]);
angular.module("IOne-Production").controller("DiscountCartTypeController",function($scope,$q,FAMDiscountCartTypeService,$mdDialog,Constant){$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value,release:Constant.RELEASE[0].value};$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.menuDisplayOption={"405-delete":{display:true,name:"删除",uuid:"0B5593F6-5135-4039-B212-BA2E972E7285"},
"406-query":{display:true,name:"查询",uuid:"89E63AA5-FF0D-4EF4-89EB-AF3A477EAC60"},"415-deleteAll":{display:true,name:"批量删除",uuid:"E6F10493-2448-448F-96FC-D2BE0541A871"}};$scope.refreshList=function(){FAMDiscountCartTypeService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.confirm,$scope.listFilterOption.status,$scope.theMax,$scope.RES_UUID_MAP.CBI.EMPL.RES_UUID).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;
$scope.pageOption.totalElements=data.totalElements;$scope.resetButtonDisabled();$scope.selectAllFlag=false})};$scope.getMenuAuthData($scope.RES_UUID_MAP.CBI.DISCOUNTCART_TYPE.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)});$scope.$watch("listFilterOption",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=
0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()}};$scope.selectAllFlag=false;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;item.detailList=$scope.subItemList;$scope.changeButtonStatusSingle(item)};$scope.returnToListAction=function(event,item){$scope.stopEventPropagation(event);$scope.selectedItem=null;$scope.changeButtonStatusAll()};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;
$scope.selectedItem=null};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel)item.detailList=item};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);$scope.refreshList()};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=
desc;$scope.source=source;$scope.domain=domain;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.status=="add"){if($scope.domain=="FAM_BASE_DIS_CARD_TYPE")FAMDiscountCartTypeService.add($scope.source).success(function(data){$scope.showInfo("新增数据成功。")}).error(function(data){$scope.showError("新增失败:"+
"\x3cbr\x3e"+data.message)})}else if($scope.status=="edit")if($scope.domain=="FAM_BASE_DIS_CARD_TYPE")FAMDiscountCartTypeService.modify($scope.source.uuid,$scope.source).success(function(data){$scope.showInfo("修改数据成功。");$scope.source=data;$scope.selectedItem=data;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)}).error(function(data){$scope.showError("修改失败:"+"\x3cbr\x3e"+data.message);$scope.source=angular.copy($scope.selectedItemBackUp);$scope.selectedItem=angular.copy($scope.selectedItemBackUp)})};
$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){FAMDiscountCartTypeService.delete(item.uuid).success(function(){$scope.selectedItem=null;$scope.refreshList();$scope.showInfo("删除数据成功。")})})};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selected.length>0)$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(item){var response=
FAMDiscountCartTypeService.delete(item.uuid).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("删除数据成功。");$scope.refreshList()})}})};$scope.selectAllAction=function(){if($scope.selectAllFlag==true)angular.forEach($scope.itemList,function(item){var idx=$scope.selected.indexOf(item);if(idx<0)$scope.selected.push(item)});else if($scope.selectAllFlag==false)$scope.selected=[];$scope.selectItemCount=$scope.selected.length;$scope.changeButtonStatusAll()};
$scope.selectItemAction=function(event,item,selected){$scope.stopEventPropagation(event);var idx=selected.indexOf(item);if(idx>-1)selected.splice(idx,1);else selected.push(item);$scope.selectItemCount=$scope.selected.length;$scope.changeButtonStatusAll()};$scope.exists=function(item,selected){return selected.indexOf(item)>-1};$scope.selected=[];$scope.resetButtonDisabled=function(){$scope.deleteAllClickActionStatus=0;$scope.deleteClickActionStatus=0};$scope.changeButtonStatusAll=function(){$scope.resetButtonDisabled();
angular.forEach($scope.selected,function(discountCartType){$scope.changeButtonStatus(discountCartType)})};$scope.changeButtonStatusSingle=function(discountCartType){$scope.resetButtonDisabled();$scope.changeButtonStatus(discountCartType)};$scope.changeButtonStatus=function(discountCartType){if(discountCartType.confirm==2||discountCartType.item==3);}});angular.module("IOne-Production").factory("DsmRuleService",function(Constant,$resource){return $resource("/rules/:uuid",{},{update:{method:"PATCH"}})});
angular.module("IOne-Production").factory("DsmScheduleService",function(Constant,$resource){return $resource("/schedules/:uuid",{},{update:{method:"PATCH"}})});
angular.module("IOne-Production").service("DsmAdaptorsService",function(Constant,$http){this.getAdaptors=function(){return $http.get("/adaptors/")};this.getObjectFromAdaptor=function(adaptor){return $http.get("/adaptors/"+adaptor+"/objects")};this.getFieldsFromObject=function(adaptor,object){return $http.get("/adaptors/"+adaptor+"/objects/"+object+"/fields")}});
angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/ecommerce-change",{controller:"EcommerceChangeController",templateUrl:"app/src/app/taobao_data/ecommerce_change/ecommerceChange.html"})}]);
angular.module("IOne-Production").controller("EcommerceChangeController",function($scope,$q,EcommerceChangeMaster,EcommerceChangeDetail,EcommerceChangeDetailExtend,$mdDialog,$timeout,Constant){$scope.ecommerceChangeListMenu={selectAll:false,effectiveType:"2",confirm:Constant.AUDIT[1].value,status:Constant.STATUS[0].value,transferPsoFlag:Constant.TRANSFER_PSO_FLAG[0].value,showQueryBar:true,buyerNick:"",orderFlag:Constant.ORDER_FLAG[0].value};$scope.ecommerceFormMenuDisplayOption={"107-change":{display:true,
name:"变更",uuid:""},"108-changehistory":{display:true,name:"变更记录查询",uuid:""}};$scope.ecommerceChangeListMenuDisplayOption={"400-selectAll":{display:true,name:"全选",uuid:""},"401-audit":{display:true,name:"审核",uuid:"341666BA-254D-46CB-8D46-B408B363CCE7"},"402-return":{display:false,name:"退回",uuid:""},"403-throw":{display:false,name:"抛转预订单",uuid:""},"404-effective":{display:true,name:"失效作废",uuid:""},"405-query":{display:true,name:"查询",uuid:""},"406-revertAudit":{display:true,name:"取消审核",uuid:"B32D6FAA-2C5E-459C-9EA0-63722D5B0D7D"}};
$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listTabSelected=function(){$scope.ecommerceChangeListMenu.showQueryBar=true;$scope.ecommerceChangeListMenuDisplayOption["400-selectAll"].display=true;$scope.queryMenuAction();$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS,0);$scope.getMenuAuthData($scope.RES_UUID_MAP.EPS.CHANGE.LIST_PAGE.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)})};$scope.formTabSelected=function(){$scope.ecommerceChangeListMenu.showQueryBar=
false;$scope.getMenuAuthData($scope.RES_UUID_MAP.EPS.CHANGE.FORM_PAGE.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)})};$scope.resetInitialValue=function(){$scope.selectedItem=null;$scope.selectedItemsCount=0;$scope.selectedItemsTotalPrice=0;$scope.resetButtonDisabled()};$scope.resetButtonDisabled=function(){$scope.effectiveType_disabled=0;$scope.return_button_disabled=0;$scope.audit_button_disabled=0;$scope.throw_button_disabled=0;$scope.revert_audit_button_disabled=
0};$scope.queryMenuAction=function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=100;$scope.pageOption.totalElements=100;$scope.queryMenuActionWithPaging()};$scope.queryMenuActionWithPaging=function(){$scope.selectedItem=null;$scope.selected=[];$scope.selectedItemsCount=0;$scope.selectedItemsTotalPrice=0;$scope.ecommerceChangeListMenu.selectAll=false;$scope.ecommerceChangeListMenu.effectiveType="2";$scope.resetInitialValue();if($scope.ecommerceChangeListMenu.startDate!==undefined)if($scope.ecommerceChangeListMenu.startDate!==
null){orderDateBegin=new Date($scope.ecommerceChangeListMenu.startDate);orderDateBegin=moment(orderDateBegin).format("YYYY-MM-DD")}else orderDateBegin=null;else orderDateBegin=null;if($scope.ecommerceChangeListMenu.endDate!==undefined)if($scope.ecommerceChangeListMenu.endDate!==null){orderDateEnd=new Date($scope.ecommerceChangeListMenu.endDate);orderDateEnd=moment(orderDateEnd).format("YYYY-MM-DD")}else orderDateEnd=null;else orderDateEnd=null;if($scope.ecommerceChangeListMenu.orderId!==undefined&&
$scope.ecommerceChangeListMenu.orderId!=="")orderMasterNo=$scope.ecommerceChangeListMenu.orderId;else orderMasterNo=null;if($scope.ecommerceChangeListMenu.buyerNick!==undefined&&$scope.ecommerceChangeListMenu.buyerNick!=="")buyerNick=$scope.ecommerceChangeListMenu.buyerNick;else buyerNick=null;confirm=$scope.ecommerceChangeListMenu.confirm;status=$scope.ecommerceChangeListMenu.status;transferPsoFlag=$scope.ecommerceChangeListMenu.transferPsoFlag;orderFlag=$scope.ecommerceChangeListMenu.orderFlag;
EcommerceChangeMaster.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,orderFlag,confirm,status,transferPsoFlag,buyerNick,orderMasterNo,orderDateBegin,orderDateEnd,RES_UUID_MAP.EPS.CHANGE.LIST_PAGE.RES_UUID).success(function(data){$scope.OrderMasterList=data;$scope.updateOrderMasterDate($scope.OrderMasterList);console.info($scope.OrderMasterList);$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements})};$scope.selected=[];$scope.selectedDetail=
[];$scope.selectedItemsCount=0;$scope.selectedItemsTotalPrice=0;$scope.toggle=function(item,selected){var idx=selected.indexOf(item);if(idx>-1)selected.splice(idx,1);else selected.push(item);$scope.ecommerceChangeListMenu.effectiveType=item.status;$scope.resetInitialValue();$scope.changeButtonStatusAndCalTotalPrice();$scope.selectedItemsTotalPrice=$scope.selectedItemsTotalPrice.toFixed(2);$scope.selectedItemsCount=selected.length};$scope.toggleDetail=function(item,selectedDetail){var idx=selectedDetail.indexOf(item);
if(idx>-1)selectedDetail.splice(idx,1);else selectedDetail.push(item);$scope.ecommerceOrderListMenu.effectiveType=item.status;$scope.resetButtonDisabled()};$scope.changeButtonStatusAndCalTotalPrice=function(){var firstLoop=true;angular.forEach($scope.selected,function(orderMaster){$scope.selectedItemsTotalPrice=$scope.selectedItemsTotalPrice+orderMaster.orderAmount;if(firstLoop){firstLoop=false;$scope.ecommerceChangeListMenu.effectiveType=orderMaster.status;$scope.firstOrderMasterStatus=orderMaster.status}else if($scope.firstOrderMasterStatus!==
orderMaster.status)$scope.effectiveType_disabled=1})};$scope.exists=function(item,list){return list.indexOf(item)>-1};$scope.selectAllMenuAction=function(){if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0)if($scope.ecommerceChangeListMenu.selectAll==true){angular.forEach($scope.OrderMasterList.content,function(item){var idx=$scope.selected.indexOf(item);if(idx<0)$scope.selected.push(item)});$scope.resetInitialValue();$scope.changeButtonStatusAndCalTotalPrice();$scope.selectedItemsTotalPrice=
$scope.selectedItemsTotalPrice.toFixed(2);$scope.selectedItemsCount=$scope.selected.length}else if($scope.ecommerceChangeListMenu.selectAll==false){$scope.selected=[];$scope.ecommerceChangeListMenu.effectiveType="1";$scope.resetInitialValue()}};$scope.editItem=function(orderMaster){$scope.selectedDetail=[];$scope.ecommerceChangeListMenu.selectAll=false;$scope.selectedItem=orderMaster;$scope.changeViewStatus(Constant.UI_STATUS.PRE_EDIT_UI_STATUS,1);$scope.resetButtonDisabled();$scope.ecommerceChangeListMenu.effectiveType=
orderMaster.status;EcommerceChangeDetail.getAll(orderMaster.uuid).success(function(data){$scope.OrderDetailList=data;$scope.updateOrderDetailDeliverDate($scope.OrderDetailList);$scope.OrderExtendDetailList=[];angular.forEach($scope.OrderDetailList.content,function(orderDetail,index){EcommerceChangeDetailExtend.getAll(orderMaster.uuid,orderDetail.uuid).success(function(data){$scope.OrderExtendDetailList=$scope.OrderExtendDetailList.concat(data.content)})})})};$scope.effectiveMenuAction=function(){};
$scope.auditMenuAction=function(){$scope.showConfirm("确认审核吗？","",function(){if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){if($scope.selectedItem.confirm=="2"){$scope.showError("该单已经审核完成。");return}EcommerceChangeMaster.modify($scope.selectedItem.uuid,{confirm:"2"}).success(function(){$scope.selectedItem.confirm="2";$scope.showInfo("审核成功。")})}else if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){if(!$scope.selected||$scope.selected.length==
0){$scope.showError("请选择待审核变更单。");return}var promises=[];angular.forEach($scope.selected,function(item){var response=EcommerceChangeMaster.modify(item.uuid,{confirm:"2",modiDate:item.modiDate}).success(function(){});promises.push(response)});$q.all(promises).then(function(data){$scope.queryMenuActionWithPaging();$scope.showInfo("审核成功。")})}})};$scope.revertAuditMenuAction=function(){};$scope.updateOrderMasterDate=function(OrderMasterList){angular.forEach(OrderMasterList.content,function(orderMaster){if(orderMaster.orderDate)orderMaster.orderDate=
new Date(orderMaster.orderDate);if(orderMaster.predictDeliverDate)orderMaster.predictDeliverDate=new Date(orderMaster.predictDeliverDate)})};$scope.updateOrderDetailDeliverDate=function(OrderDetailList){angular.forEach(OrderDetailList.content,function(orderDetail){orderDetail.deliverDate=moment(orderDetail.deliverDate).format("YYYY-MM-DD")})}});
angular.module("IOne-Production").service("EcommerceChangeMaster",function($http,Constant){this.getAll=function(sizePerPage,page,orderFlag,confirm,status,transferPsoFlag,buyerNick,orderMasterNo,orderDateBegin,orderDateEnd,resUuid){orderFlag=orderFlag==0?"":orderFlag;confirm=confirm==0?"":confirm;status=status==0?"":status;transferPsoFlag=transferPsoFlag==0?"":transferPsoFlag;var url="orderChanges?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26confirm\x3d"+confirm+"\x26status\x3d"+status+"\x26transferPsoFlag\x3d"+
transferPsoFlag;if(orderFlag!==null)url=url+"\x26orderFlag\x3d"+orderFlag;if(buyerNick!==null)url=url+"\x26buyerNick\x3d"+buyerNick;if(orderMasterNo!==null)url=url+"\x26no\x3d"+orderMasterNo;if(orderDateBegin!==null)url=url+"\x26orderDateBegin\x3d"+orderDateBegin;if(orderDateEnd!==null)url=url+"\x26orderDateEnd\x3d"+orderDateEnd;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)};this.modify=function(changeOrderUuid,changeOrder){return $http.patch(Constant.BACKEND_BASE+
"/orderChanges/"+changeOrderUuid,changeOrder)}});angular.module("IOne-Production").service("EcommerceChangeDetail",function($http,Constant){this.getAll=function(masterUuid){return $http.get(Constant.BACKEND_BASE+"/orderChanges/"+masterUuid+"/details")};this.get=function(masterUuid,detailUuid){return $http.get(Constant.BACKEND_BASE+"/orderChanges/"+masterUuid+"/details/"+detailUuid)}});
angular.module("IOne-Production").service("EcommerceChangeDetailExtend",function($http,Constant){this.getAll=function(masterUuid,detailUuid){return $http.get(Constant.BACKEND_BASE+"/orderChanges/"+masterUuid+"/details/"+detailUuid+"/extends")};this.modify=function(masterUuid,detailUuid,uuid,OrderExtendDetailUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/orderChanges/"+masterUuid+"/details/"+detailUuid+"/extends/"+uuid,OrderExtendDetailUpdateInput)}});
angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/ecommerce-orders",{controller:"EcommerceOrdersController",templateUrl:"app/src/app/taobao_data/ecommerce_orders/ecommerceOrders.html"})}]);
angular.module("IOne-Production").controller("EcommerceOrdersController",function($scope,$q,$window,EcommerceOrdersMaster,EcommerceOrderDetail,EcommerceOrderDetailExtend,EdelivWayService,SaleTypes,$mdDialog,$timeout,Constant){$scope.ecommerceOrderListMenu={selectAll:false,effectiveType:"2",confirm:Constant.CONFIRM[1].value,status:Constant.STATUS[0].value,transferPsoFlag:Constant.TRANSFER_PSO_FLAG[2].value,showQueryBar:true,buyerNick:"",orderFlag:Constant.ORDER_FLAG[0].value};$scope.formMenuDisplayOption=
{"100-add":{display:true,name:"新增",uuid:"283A96EC-616E-4CD6-B666-97D9EBE689D0"},"101-delete":{display:true,name:"删除",uuid:"AB3E5248-4FD5-4A3B-94AA-5AFF61BCF68E"},"102-edit":{display:true,name:"变更",uuid:"DE283761-5374-4B31-935D-FAFB6AF29881"},"200-cancel":{display:true,name:"取消新增",uuid:"7C7F408E-8A35-4A09-9829-AAEB6BF0FD70"},"201-save":{display:true,name:"保存",uuid:"0F1BE865-1271-432D-B481-6879DE58979A"},"302-save":{display:true,name:"保存",uuid:"10F9A22C-F792-4AA3-975E-88173A33D083"},"303-cancel":{display:true,
name:"取消修改",uuid:"1C4E0C9F-BD78-4454-88A9-BD9CDD517B5A"},"304-quit":{display:true,name:"退出编辑",uuid:"9FAFE39F-A71B-45DD-A773-BE422FBDCEA3"}};$scope.ecommerceOrderListMenuDisplayOption={"400-selectAll":{display:true,name:"全选",uuid:"AC0B75FE-46BB-4BCB-B5AE-1B6DC564E165"},"401-audit":{display:true,name:"审核",uuid:"7C160BC4-CBC5-47CE-8F4E-412295E61E9A"},"403-throw":{display:true,name:"抛转预订单",uuid:"D334B659-2C65-4601-8C06-9EA7924C1830"},"408-cancelthrow":{display:true,name:"取消抛转预订单",uuid:"098F60EE-A590-11E5-BF7F-FEFF819CDC9F"},
"405-query":{display:true,name:"查询",uuid:"D08679EA-E52D-4667-A080-7E6A74523D7F"},"406-revertAudit":{display:true,name:"取消审核",uuid:"CE277D5B-EF09-4648-8706-E4A44766E745"},"407-add":{display:true,name:"新增",uuid:"6A8F9438-C2FF-4BF3-8797-7B680AAA068E"},"408-supervisorAudit":{display:true,name:"主管审核",uuid:"C515BAEB-758F-4265-AD6A-50FBDD614DD3"}};$scope.ecommerceFormMenuDisplayOption={"411-audit":{display:true,name:"审核",uuid:"F34FF037-23D6-4033-8516-67FF51C270FC"},"413-throw":{display:true,name:"抛转预订单",
uuid:"82D08295-F14B-446F-A265-1B3E453F17FD"},"416-revertAudit":{display:true,name:"取消审核",uuid:"543C075A-3E18-491F-9726-F063D589D084"},"417-cancelthrow":{display:true,name:"取消抛转预订单",uuid:"AE4CF2E4-4CCE-40DA-B060-0D00FCDA76C8"},"418-print":{display:true,name:"打印",uuid:"753C7E95-FC29-40DA-8296-DA858325FCF0"},"419-supervisorAudit":{display:true,name:"主管审核",uuid:"F97D8B53-AF71-448F-AB73-63BAFB83F77F"}};$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.printAction=
function(){EcommerceOrdersMaster.print("e_sale_order_reports",$scope.selectedItem.uuid).success(function(data){$window.open(data.content)}).error(function(){$scope.showError("获取打印信息失败。")})};$scope.listTabSelected=function(){$scope.ecommerceOrderListMenu.showQueryBar=true;$scope.queryMenuAction();$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS,0);$scope.getMenuAuthData($scope.RES_UUID_MAP.EPS.ECOMMERCE.LIST_PAGE.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)})};
$scope.formTabSelected=function(){$scope.ecommerceOrderListMenu.showQueryBar=false;$scope.getMenuAuthData($scope.RES_UUID_MAP.EPS.ECOMMERCE.FORM_PAGE.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)})};$scope.resetInitialValue=function(){$scope.selectedItem=null;$scope.selectedItemsCount=0;$scope.selectedItemsTotalPrice=0;$scope.resetButtonDisabled()};$scope.resetButtonDisabled=function(){$scope.throw_button_disabled=0;$scope.revert_throw_button_disabled=0;$scope.audit_button_disabled=
0;$scope.revert_audit_button_disabled=0;$scope.supervisorAudit_button_disabled=0};$scope.queryMenuAction=function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=100;$scope.pageOption.totalElements=100;$scope.queryMenuActionWithPaging()};$scope.queryMenuActionWithPaging=function(){$scope.selectedItem=null;$scope.selected=[];$scope.selectedItemsCount=0;$scope.selectedItemsTotalPrice=0;$scope.ecommerceOrderListMenu.selectAll=false;$scope.resetInitialValue();if($scope.ecommerceOrderListMenu.startDate!==
undefined)if($scope.ecommerceOrderListMenu.startDate!==null){orderDateBegin=new Date($scope.ecommerceOrderListMenu.startDate);orderDateBegin=moment(orderDateBegin).format("YYYY-MM-DD")}else orderDateBegin=null;else orderDateBegin=null;if($scope.ecommerceOrderListMenu.endDate!==undefined)if($scope.ecommerceOrderListMenu.endDate!==null){orderDateEnd=new Date($scope.ecommerceOrderListMenu.endDate);orderDateEnd=moment(orderDateEnd).format("YYYY-MM-DD")}else orderDateEnd=null;else orderDateEnd=null;if($scope.ecommerceOrderListMenu.orderId!==
undefined&&$scope.ecommerceOrderListMenu.orderId!=="")orderMasterNo=$scope.ecommerceOrderListMenu.orderId;else orderMasterNo=null;if($scope.ecommerceOrderListMenu.buyerNick!==undefined&&$scope.ecommerceOrderListMenu.buyerNick!=="")buyerNick=$scope.ecommerceOrderListMenu.buyerNick;else buyerNick=null;confirm=$scope.ecommerceOrderListMenu.confirm;status=$scope.ecommerceOrderListMenu.status;transferPsoFlag=$scope.ecommerceOrderListMenu.transferPsoFlag;orderFlag=$scope.ecommerceOrderListMenu.orderFlag;
EcommerceOrdersMaster.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,orderFlag,confirm,status,transferPsoFlag,buyerNick,orderMasterNo,orderDateBegin,orderDateEnd,RES_UUID_MAP.EPS.ECOMMERCE.LIST_PAGE.RES_UUID).success(function(data){$scope.OrderMasterList=data;$scope.updateOrderMasterDate($scope.OrderMasterList);$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;if($scope.OrderMasterList.content.length>0)angular.forEach($scope.OrderMasterList.content,
function(orderMaster,index){EcommerceOrderDetail.getAll(orderMaster.uuid).success(function(data){$scope.OrderMasterList.content[index].detailList=data.content})})})};$scope.selected=[];$scope.selectedDetail=[];$scope.selectedItemsCount=0;$scope.selectedItemsTotalPrice=0;$scope.toggle=function(item,selected){var idx=selected.indexOf(item);if(idx>-1)selected.splice(idx,1);else selected.push(item);$scope.resetInitialValue();$scope.changeButtonStatusAndCalTotalPrice();$scope.selectedItemsTotalPrice=$scope.selectedItemsTotalPrice.toFixed(2);
$scope.selectedItemsCount=selected.length};$scope.toggleDetail=function(item,selectedDetail){var idx=selectedDetail.indexOf(item);if(idx>-1)selectedDetail.splice(idx,1);else selectedDetail.push(item);$scope.resetButtonDisabled()};$scope.changeButtonStatus=function(orderMaster){if(orderMaster.confirm==2){$scope.audit_button_disabled=1;$scope.supervisorAudit_button_disabled=1}else if(orderMaster.confirm==1)if(orderMaster.orderChangeFlag==1||orderMaster.orderChangeFlag==null)$scope.supervisorAudit_button_disabled=
1;else if(orderMaster.orderChangeFlag==2)$scope.audit_button_disabled=1;if(!(orderMaster.confirm==2&&orderMaster.transferPsoFlag!=1))$scope.revert_audit_button_disabled=1;if(!(orderMaster.confirm==2&&orderMaster.transferPsoFlag!=1))$scope.throw_button_disabled=1;if(!(orderMaster.confirm==2&&orderMaster.transferPsoFlag==1))$scope.revert_throw_button_disabled=1};$scope.changeButtonStatusAndCalTotalPrice=function(){angular.forEach($scope.selected,function(orderMaster){$scope.selectedItemsTotalPrice=
$scope.selectedItemsTotalPrice+orderMaster.orderAmount;$scope.changeButtonStatus(orderMaster)})};$scope.exists=function(item,list){return list.indexOf(item)>-1};$scope.selectAllMenuAction=function(){if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0)if($scope.ecommerceOrderListMenu.selectAll==true){angular.forEach($scope.OrderMasterList.content,function(item){var idx=$scope.selected.indexOf(item);if(idx<0)$scope.selected.push(item)});$scope.resetInitialValue();$scope.changeButtonStatusAndCalTotalPrice();
$scope.selectedItemsTotalPrice=$scope.selectedItemsTotalPrice.toFixed(2);$scope.selectedItemsCount=$scope.selected.length}else{if($scope.ecommerceOrderListMenu.selectAll==false){$scope.selected=[];$scope.resetInitialValue()}}else if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1)if($scope.ecommerceOrderListMenu.selectAll==true){angular.forEach($scope.OrderDetailList.content,function(item){var idx=$scope.selectedDetail.indexOf(item);if(idx<0)$scope.selectedDetail.push(item)});
$scope.resetButtonDisabled()}else if($scope.ecommerceOrderListMenu.selectAll==false){$scope.selectedDetail=[];$scope.resetButtonDisabled()}};$scope.editItem=function(orderMaster){$scope.selectedDetail=[];$scope.ecommerceOrderListMenu.selectAll=false;$scope.selectedItem=orderMaster;$scope.changeViewStatus(Constant.UI_STATUS.PRE_EDIT_UI_STATUS,1);$scope.resetButtonDisabled();$scope.changeButtonStatus(orderMaster);EcommerceOrderDetail.getAll(orderMaster.uuid).success(function(data){$scope.OrderDetailList=
data;$scope.updateOrderDetailDeliverDate($scope.OrderDetailList);$scope.OrderExtendDetailList=[];angular.forEach($scope.OrderDetailList.content,function(orderDetail,index){EcommerceOrderDetailExtend.getAll(orderMaster.uuid,orderDetail.uuid).success(function(data){$scope.OrderExtendDetailList=$scope.OrderExtendDetailList.concat(data.content)})})})};$scope.updateOrderMasterDate=function(OrderMasterList){angular.forEach(OrderMasterList.content,function(orderMaster){if(orderMaster.orderDate)orderMaster.orderDate=
new Date(orderMaster.orderDate);if(orderMaster.predictDeliverDate)orderMaster.predictDeliverDate=new Date(orderMaster.predictDeliverDate)})};$scope.updateOrderDetailDeliverDate=function(OrderDetailList){angular.forEach(OrderDetailList.content,function(orderDetail){if(orderDetail.deliverDate)orderDetail.deliverDate=moment(orderDetail.deliverDate).format("YYYY-MM-DD")})};$scope.getImageFullPath=function(path){if(path==null)return Constant.BACKEND_BASE+"/app/img/item.jpeg";if(path&&path.indexOf("IMAGE")==
0)return Constant.BACKEND_BASE+"/app/assets/"+path;else return Constant.BACKEND_BASE+"/app/assets/IMAGE/"+path};$scope.preAddMenuAction=function(){$scope.selectedItem=EcommerceOrdersMaster.createDefault();EdelivWayService.getAll(1,0,null,"DW02").success(function(data){$scope.selectedItem.deliverWay=data.content[0];$scope.selectedItem.deliverWayUuid=$scope.selectedItem.deliverWay.uuid});$scope.selectedItemDetail=null;$scope.OrderDetailList=null;$scope.OrderExtendDetailList=null;$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_ADD,
1)};$scope.deleteMenuAction=function(){if($scope.selectedItem.confirm==1)$scope.showConfirm("确认删除吗？","删除的订单不可恢复。",function(){if($scope.selectedItem)EcommerceOrdersMaster.delete($scope.selectedItem.uuid).success(function(){$scope.showInfo("删除成功。");$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_DELETE,0)}).error(function(response){$scope.showError($scope.getError(response))})});else $scope.showInfo("已审核订单不可删除。")};$scope.cancelAddMenuAction=function(){$scope.listTabSelected()};$scope.addMenuAction=
function(){if($scope.selectedItem&&(angular.isUndefined($scope.selectedItem.uuid)||$scope.selectedItem.uuid==null)){$scope.selectedItem.orderChangeFlag="2";EcommerceOrdersMaster.add($scope.selectedItem).success(function(data){$scope.selectedItem=data;if($scope.selectedItem.orderDate)$scope.selectedItem.orderDate=new Date($scope.selectedItem.orderDate);if($scope.selectedItem.predictDeliverDate)$scope.selectedItem.predictDeliverDate=new Date($scope.selectedItem.predictDeliverDate);$scope.changeViewStatus($scope.UI_STATUS.PRE_EDIT_UI_STATUS,
1);$scope.resetButtonDisabled();$scope.changeButtonStatus($scope.selectedItem);$scope.showInfo("新增成功")}).error(function(data){$scope.showError($scope.getAllError(data));$scope.showError(data.message)})}};$scope.modifyMenuAction=function(){if($scope.selectedItem){if($scope.selectedItem.transferPsoFlag=="1"){$scope.showError("已抛转的销售单不能修改。");return}if($scope.selectedItem.confirm=="2"||$scope.selectedItem.confirm=="3"){$scope.showError("已审核和正在审核中的销售单不能修改。");return}EcommerceOrdersMaster.modify($scope.selectedItem).success(function(data){console.info(data[0]);
$scope.selectedItem=data[0];EcommerceOrderDetail.getAll($scope.selectedItem.uuid).success(function(data){$scope.selectedItem.detailList=data.content});$scope.changeViewStatus(Constant.UI_STATUS.PRE_EDIT_UI_STATUS,1);$scope.showInfo("修改成功。")}).error(function(data){$scope.showError(data.message);$scope.cancelModifyMenuAction()})}};$scope.cancelModifyMenuAction=function(){EcommerceOrdersMaster.get($scope.selectedItem.uuid).success(function(data){$scope.selectedItem=data;if($scope.selectedItem.orderDate)$scope.selectedItem.orderDate=
new Date($scope.selectedItem.orderDate);if($scope.selectedItem.predictDeliverDate)$scope.selectedItem.predictDeliverDate=new Date($scope.selectedItem.predictDeliverDate);EcommerceOrderDetail.getAll($scope.selectedItem.uuid).success(function(data){$scope.selectedItem.detailList=data.content})})};$scope.exitModifyMenuAction=function(){$scope.cancelModifyMenuAction();$scope.changeViewStatus($scope.UI_STATUS.PRE_EDIT_UI_STATUS,1)};$scope.effectiveMenuAction=function(){};$scope.auditMenuAction=function(){if((!$scope.selected||
$scope.selected.length==0)&&$scope.selectedTabIndex==0){$scope.showError("请选择待审核销售单。");return}if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){var emptyDetails="";angular.forEach($scope.selected,function(item){if(angular.isUndefined(item.detailList)||item.detailList.length==0)emptyDetails=emptyDetails+item.no+","});if(emptyDetails!=""){emptyDetails=emptyDetails.substr(0,emptyDetails.length-1);$scope.showError("存在无单身明细的销售单，不允许审核："+emptyDetails);return}}if($scope.ui_status==
Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){var zeroNos="";angular.forEach($scope.selected,function(item){if(item.orderAmount=="0")zeroNos=zeroNos+item.no+","});if(zeroNos!=""){zeroNos=zeroNos.substr(0,zeroNos.length-1);$scope.showError("存在金额为0的销售单，不允许审核："+zeroNos);return}}if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){var groupUserNos="";var buyerNick="";var deliverWayName="";var receiveDistrictName="";var receiveAddress="";var receiveName=
"";var receivePhone="";var orderNo="";var predictDeliverDate="";angular.forEach($scope.selected,function(head){if(angular.isUndefined(head.groupUser)||head.groupUser==null)groupUserNos=groupUserNos+head.no+"\n\r";if(angular.isUndefined(head.buyerNick)||head.buyerNick==null)buyerNick=buyerNick+head.no+"\n\r";if(angular.isUndefined(head.deliverWay)||head.deliverWay==null)deliverWayName=deliverWayName+head.no+"\n\r";if(angular.isUndefined(head.receiveDistrict)||head.receiveDistrict==null)receiveDistrictName=
receiveDistrictName+head.no+"\n\r";if(angular.isUndefined(head.receiveAddress)||head.receiveAddress==null)receiveAddress=receiveAddress+head.no+"\n\r";if(angular.isUndefined(head.receiveName)||head.receiveName==null)receiveName=receiveName+head.no+"\n\r";if(angular.isUndefined(head.receivePhone)||head.receivePhone==null)receivePhone=receivePhone+head.no+"\n\r";if(angular.isUndefined(head.no)||head.no==null)orderNo=orderNo+head.no+"\n\r";if(angular.isUndefined(head.predictDeliverDate)||head.predictDeliverDate==
null)predictDeliverDate=predictDeliverDate+head.no+"\n\r"});if(groupUserNos!=""){groupUserNos=groupUserNos.substr(0,groupUserNos.length-1);$scope.showError("存在客服人员为空的销售单，不允许审核："+groupUserNos);return}if(buyerNick!=""){buyerNick=buyerNick.substr(0,buyerNick.length-1);$scope.showError("存在客户昵称为为空的销售单，不允许审核："+buyerNick);return}if(deliverWayName!=""){deliverWayName=deliverWayName.substr(0,deliverWayName.length-1);$scope.showError("存在送货方式为空的销售单，不允许审核："+deliverWayName);return}if(receiveDistrictName!=""){receiveDistrictName=
receiveDistrictName.substr(0,receiveDistrictName.length-1);$scope.showError("存在送货区域为空的销售单，不允许审核："+receiveDistrictName);return}if(receiveAddress!=""){receiveAddress=receiveAddress.substr(0,groupUserNos.length-1);$scope.showError("存在送货地址为空的销售单，不允许审核："+receiveAddress);return}if(receiveName!=""){receiveName=receiveName.substr(0,receiveName.length-1);$scope.showError("存在收货人为空的销售单，不允许审核："+receiveName);return}if(receivePhone!=""){receivePhone=receivePhone.substr(0,receivePhone.length-1);$scope.showError("存在联系电话为空的销售单，不允许审核："+
receivePhone);return}if(orderNo!=""){orderNo=orderNo.substr(0,orderNo.length-1);$scope.showError("存在交易订单号为空的销售单，不允许审核："+orderNo);return}if(predictDeliverDate!=""){predictDeliverDate=predictDeliverDate.substr(0,predictDeliverDate.length-1);$scope.showError("存在预计送货日期为空的销售单，不允许审核："+predictDeliverDate);return}}if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){if(angular.isUndefined($scope.selectedItem.detailList)||$scope.selectedItem.detailList==null||$scope.selectedItem.detailList.length==
"0"){$scope.showError("该单无单身明细不能审核。");return}if($scope.selectedItem.confirm=="2"){$scope.showError("该单已经审核完成。");return}if($scope.selectedItem.orderAmount=="0"&&$scope.selectedItem.orderFlag!=Constant.ORDER_FLAG[6].value){$scope.showError("该单单头金额为0不能审核。");return}if(angular.isUndefined($scope.selectedItem.groupUser)||$scope.selectedItem.groupUser==null){$scope.showError("该单客服人员为空不允许审核。");return}}$scope.showConfirm("确认审核吗？","",function(){if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==
1){var OrderMasterUpdateInput={modifyOnly:"1",uuid:$scope.selectedItem.uuid,confirm:"2",userId:$scope.selectedItem.userId,buyerNick:$scope.selectedItem.buyerNick,receiveName:$scope.selectedItem.receiveName,receivePhone:$scope.selectedItem.receivePhone};EcommerceOrdersMaster.modify(OrderMasterUpdateInput).success(function(data){$scope.selectedItem.confirm="2";$scope.selectedItem.userId=data[0].userId;$scope.selectedItem.buyerNick=data[0].buyerNick;$scope.selectedItem.receiveName=data[0].receiveName;
$scope.selectedItem.receivePhone=data[0].receivePhone;$scope.resetButtonDisabled();$scope.changeButtonStatus($scope.selectedItem);$scope.showInfo("审核成功。")}).error(function(data){$scope.showError(data.message)})}else if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){var promises=[];angular.forEach($scope.selected,function(item){var OrderMasterUpdateInput={modifyOnly:"1",uuid:item.uuid,confirm:"2",userId:item.userId,buyerNick:item.buyerNick,receiveName:item.receiveName,
receivePhone:item.receivePhone};var response=EcommerceOrdersMaster.modify(OrderMasterUpdateInput).success(function(){});promises.push(response)});$q.all(promises).then(function(data){$scope.queryMenuActionWithPaging();$scope.showInfo("审核成功。")},function(data){$scope.showError(data.data.message)})}})};$scope.revertAuditMenuAction=function(){if((!$scope.selected||$scope.selected.length==0)&&$scope.selectedTabIndex==0){$scope.showError("请选择待取消审核销售单。");return}if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&
$scope.selectedTabIndex==0){var threwNos="";angular.forEach($scope.selected,function(item){if(item.transferPsoFlag=="1")threwNos=threwNos+item.no+","});if(threwNos!=""){threwNos=threwNos.substr(0,threwNos.length-1);$scope.showError("存在已抛转的销售单，不允许取消审核："+threwNos);return}}if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){if($scope.selectedItem.confirm=="1"){$scope.showError("该单已是未审核。");return}if($scope.selectedItem.transferPsoFlag=="1"){$scope.showError("已抛转的销售单不允许取消审核。");
return}}$scope.showConfirm("确认取消审核吗？","",function(){if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){var OrderMasterUpdateInput={modifyOnly:"1",uuid:$scope.selectedItem.uuid,confirm:"1"};EcommerceOrdersMaster.modify(OrderMasterUpdateInput).success(function(){$scope.selectedItem.confirm="1";$scope.resetButtonDisabled();$scope.changeButtonStatus($scope.selectedItem);$scope.showInfo("取消审核成功。")}).error(function(data){$scope.showError(data.message)})}else if($scope.ui_status==
Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){var promises=[];angular.forEach($scope.selected,function(item){var OrderMasterUpdateInput={modifyOnly:"1",uuid:item.uuid,confirm:"1"};var response=EcommerceOrdersMaster.modify(OrderMasterUpdateInput).success(function(){});promises.push(response)});$q.all(promises).then(function(data){$scope.queryMenuActionWithPaging();$scope.showInfo("取消审核成功。")},function(data){$scope.showError(data.data.message)})}})};$scope.throwMenuAction=function(){if((!$scope.selected||
$scope.selected.length==0)&&$scope.selectedTabIndex==0){$scope.showError("请选择待抛转销售单。");return}if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){var unConfirmNos="";angular.forEach($scope.selected,function(item){if(item.confirm=="1")unConfirmNos=unConfirmNos+item.no+","});if(unConfirmNos!=""){unConfirmNos=unConfirmNos.substr(0,unConfirmNos.length-1);$scope.showError("存在未审核的销售单，不允许抛转："+unConfirmNos);return}}if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==
0){var zcNos="";angular.forEach($scope.selected,function(item){if(item.orderFlag=="1"||item.orderFlag=="2"||item.orderFlag==""||item.orderFlag=="0"||item.orderFlag==null)zcNos=zcNos+item.no+","});if(zcNos!=""){zcNos=zcNos.substr(0,zcNos.length-1);$scope.showError("存在种菜或未定义类型的销售单，不允许抛转："+zcNos);return}}if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){if($scope.selectedItem.confirm=="1"){$scope.showError("该单尚未审核，审核后才允许抛转。");return}if($scope.selectedItem.orderFlag==
"1"||$scope.selectedItem.orderFlag=="2"||$scope.selectedItem.orderFlag==""||$scope.selectedItem.orderFlag=="0"||$scope.selectedItem.orderFlag==null){$scope.showError("该单是种菜或未定义类型的销售单，不允许抛转。");return}if($scope.selectedItem.transferPsoFlag=="1"){$scope.showError("该单已经抛转完成。");return}}$scope.showConfirm("确认抛转吗？","",function(){if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){var orderMasterUuids="";angular.forEach($scope.selected,function(item){orderMasterUuids=orderMasterUuids+
item.uuid+","});orderMasterUuids=orderMasterUuids.substr(0,orderMasterUuids.length-1);var OrderMasterUpdateInput={modifyOnly:"1",uuid:orderMasterUuids,transferPsoFlag:"1"};EcommerceOrdersMaster.modify(OrderMasterUpdateInput).success(function(){$scope.queryMenuActionWithPaging();$scope.showInfo("抛转成功。")}).error(function(data){$scope.showError(data.message)})}else if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){var OrderMasterUpdateInput={modifyOnly:"1",uuid:$scope.selectedItem.uuid,
transferPsoFlag:"1"};EcommerceOrdersMaster.modify(OrderMasterUpdateInput).success(function(){$scope.selectedItem.transferPsoFlag="1";$scope.resetButtonDisabled();$scope.changeButtonStatus($scope.selectedItem);$scope.showInfo("抛转成功。")}).error(function(data){$scope.showError(data.message)})}})};$scope.cancelThrowMenuAction=function(){if((!$scope.selected||$scope.selected.length==0)&&$scope.selectedTabIndex==0){$scope.showError("请选择待抛转销售单。");return}if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&
$scope.selectedTabIndex==0){var unConfirmNos="";angular.forEach($scope.selected,function(item){if(item.transferPsoFlag=="2")unConfirmNos=unConfirmNos+item.no+","});if(unConfirmNos!=""){unConfirmNos=unConfirmNos.substr(0,unConfirmNos.length-1);$scope.showError("存在未抛转的销售单，不允许取消抛转："+unConfirmNos);return}}$scope.showConfirm("确认取消抛转吗？","",function(){if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){var orderMasterUuids="";angular.forEach($scope.selected,function(item){orderMasterUuids=
orderMasterUuids+item.uuid+","});orderMasterUuids=orderMasterUuids.substr(0,orderMasterUuids.length-1);var OrderMasterUpdateInput={modifyOnly:"1",uuid:orderMasterUuids,transferPsoFlag:"2"};EcommerceOrdersMaster.modify(OrderMasterUpdateInput).success(function(){$scope.queryMenuActionWithPaging();$scope.showInfo("取消抛转成功。")}).error(function(data){$scope.showError(data.message)})}else if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){var OrderMasterUpdateInput={modifyOnly:"1",
uuid:$scope.selectedItem.uuid,transferPsoFlag:"2"};EcommerceOrdersMaster.modify(OrderMasterUpdateInput).success(function(){$scope.selectedItem.transferPsoFlag="2";$scope.resetButtonDisabled();$scope.changeButtonStatus($scope.selectedItem);$scope.showInfo("取消抛转成功。")}).error(function(data){$scope.showError(data.message)})}})};SaleTypes.getAll().success(function(data){$scope.saleTypes=data});$scope.orderDetailEditMenuAction=function(orderDetail){if($scope.selectedItem.transferPsoFlag=="1"){$scope.showError("已抛转的销售单不能修改。");
return}$mdDialog.show({controller:"EOrderDetailController",templateUrl:"app/src/app/taobao_data/ecommerce_orders/orderDetailEditDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{selectedOrderDetail:orderDetail,saleTypes:$scope.saleTypes}}).then(function(data){EcommerceOrderDetail.modify($scope.selectedItem.uuid,data.selectedOrderDetail).success(function(){var OrderMasterUpdateInput={uuid:$scope.selectedItem.uuid,orderChangeFlag:"2"};EcommerceOrdersMaster.modify(OrderMasterUpdateInput).success(function(){$scope.selectedItem.orderChangeFlag=
"2";$scope.resetButtonDisabled();$scope.changeButtonStatus($scope.selectedItem);EcommerceOrderDetail.getAll($scope.selectedItem.uuid).success(function(data){$scope.OrderDetailList=data;$scope.updateOrderDetailDeliverDate($scope.OrderDetailList);$scope.OrderExtendDetailList=[];angular.forEach($scope.OrderDetailList.content,function(orderDetail,index){EcommerceOrderDetailExtend.getAll($scope.selectedItem.uuid,orderDetail.uuid).success(function(data){$scope.OrderExtendDetailList=$scope.OrderExtendDetailList.concat(data.content)})})});
$scope.showInfo("修改成功，正在刷新。")})})})};$scope.orderDetailDeleteMenuAction=function(orderDetail){if($scope.selectedItem.transferPsoFlag=="1"){$scope.showError("已抛转的销售单不能再删除。");return}$scope.showConfirm("确认删除吗？","删除的产品不可恢复。",function(){if($scope.selectedItem&&orderDetail)EcommerceOrderDetail.delete($scope.selectedItem.uuid,orderDetail.uuid).success(function(){var OrderMasterUpdateInput={uuid:$scope.selectedItem.uuid,orderChangeFlag:"2"};EcommerceOrdersMaster.modify(OrderMasterUpdateInput).success(function(){$scope.selectedItem.orderChangeFlag=
"2";$scope.resetButtonDisabled();$scope.changeButtonStatus($scope.selectedItem);EcommerceOrderDetail.getAll($scope.selectedItem.uuid).success(function(data){$scope.OrderDetailList=data;$scope.updateOrderDetailDeliverDate($scope.OrderDetailList);$scope.OrderExtendDetailList=[];angular.forEach($scope.OrderDetailList.content,function(orderDetail){EcommerceOrderDetailExtend.getAll($scope.selectedItem.uuid,orderDetail.uuid).success(function(data){$scope.OrderExtendDetailList=$scope.OrderExtendDetailList.concat(data.content)})})});
$scope.showInfo("删除成功,正在刷新。")})}).error(function(response){$scope.showError($scope.getError(response))})})};$scope.openChannelDlg=function(){$mdDialog.show({controller:"EChannelSearchController",templateUrl:"app/src/app/taobao_data/ecommerce_orders/selectChannel.html",parent:angular.element(document.body),targetEvent:event}).then(function(data){$scope.selectedItem.channel=data;$scope.selectedItem.channelUuid=data.uuid;$scope.selectedItem.mallUuid=data.mall.uuid})};$scope.openTaobaoClientDlg=function(){$mdDialog.show({controller:"ETaobaoClientController",
templateUrl:"app/src/app/taobao_data/ecommerce_orders/selectTaobaoClient.html",parent:angular.element(document.body),targetEvent:event}).then(function(data){$scope.selectedItem.taobaoCustomer=data;$scope.selectedItem.taobaoCustomerUuid=data.uuid})};$scope.openDelivWayDlg=function(){$mdDialog.show({controller:"EDelivWaySearchController",templateUrl:"app/src/app/taobao_data/ecommerce_orders/selectDelivWay.html",parent:angular.element(document.body),targetEvent:event}).then(function(data){$scope.selectedItem.deliverWay=
data;$scope.selectedItem.deliverWayUuid=data.uuid})};$scope.openMallDlg=function(){$mdDialog.show({controller:"EMallSearchController",templateUrl:"app/src/app/taobao_data/ecommerce_orders/selectMall.html",parent:angular.element(document.body),targetEvent:event}).then(function(data){console.info($scope.selectedItem);if(angular.isUndefined($scope.selectedItem.channel)||$scope.selectedItem.channel==null)$scope.selectedItem.channel=[];else;$scope.selectedItem.channel.mall=data;$scope.selectedItem.mallUuid=
data.uuid})};$scope.openGroupUserDlg=function(){$mdDialog.show({controller:"EGroupUserSearchController",templateUrl:"app/src/app/taobao_data/ecommerce_orders/selectGroupUser.html",parent:angular.element(document.body),targetEvent:event}).then(function(data){$scope.selectedItem.groupUser=data;$scope.selectedItem.groupUserUuid=data.uuid})};$scope.openAreaDlg=function(){$mdDialog.show({controller:"EAreaSearchController",templateUrl:"app/src/app/taobao_data/ecommerce_orders/selectArea.html",parent:angular.element(document.body),
targetEvent:event}).then(function(data){$scope.selectedItem.receiveDistrict=data;$scope.selectedItem.receiveDistrictUuid=data.uuid})};$scope.openAddDetailDlg=function(){if(angular.isUndefined($scope.selectedItem.uuid)||$scope.selectedItem.uuid==null){$scope.showError("请保存单头后再新增产品单身。");return}$mdDialog.show({controller:"EAddDetailController",templateUrl:"app/src/app/taobao_data/ecommerce_orders/orderDetailAddDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{saleTypes:$scope.saleTypes,
OrderDetailList:$scope.OrderDetailList}}).then(function(data){var orderMasterUuid=$scope.selectedItem.uuid;var orderDetailInput={no:data.addOrderDetail.no,itemUuid:data.addOrderDetail.itemUuid,itemAttribute:data.addOrderDetail.itemAttribute,saleTypeUuid:data.addOrderDetail.saleTypeUuid,orderQuantity:data.addOrderDetail.orderQuantity,orderPrice:data.addOrderDetail.orderPrice,originalOrderAmount:data.addOrderDetail.originalOrderAmount,originalOrderAmountTax:data.addOrderDetail.originalOrderAmountTax,
remark:data.addOrderDetail.remark,itemName:data.addOrderDetail.item.name,standard:data.addOrderDetail.item.standard,suggestPrice:data.addOrderDetail.item.suggestPrice};EcommerceOrderDetail.add(orderMasterUuid,orderDetailInput).success(function(data){var OrderMasterUpdateInput={uuid:$scope.selectedItem.uuid,orderChangeFlag:"2"};EcommerceOrdersMaster.modify(OrderMasterUpdateInput).success(function(){$scope.selectedItem.orderChangeFlag="2";$scope.resetButtonDisabled();$scope.changeButtonStatus($scope.selectedItem);
EcommerceOrderDetail.getAll(orderMasterUuid).success(function(data){$scope.OrderDetailList=data;$scope.updateOrderDetailDeliverDate($scope.OrderDetailList);$scope.OrderExtendDetailList=[];angular.forEach($scope.OrderDetailList.content,function(orderDetail){EcommerceOrderDetailExtend.getAll(orderMasterUuid,orderDetail.uuid).success(function(data){$scope.OrderExtendDetailList=$scope.OrderExtendDetailList.concat(data.content)})})}).error(function(response){$scope.showError($scope.getAllError(response));
$scope.showError(response)});$scope.showInfo("新增成功,正在刷新。")}).error(function(response){$scope.showError($scope.getAllError(response));$scope.showError(response)})}).error(function(response){$scope.showError($scope.getAllError(response));$scope.showError(response.content)})})};$scope.orderExtendDetailEditMenuAction=function(orderDetailExtend){$mdDialog.show({controller:"EeditOrderExtendDetailController",templateUrl:"app/src/app/taobao_data/ecommerce_orders/orderDetailExtendEditDlg.html",parent:angular.element(document.body),
targetEvent:event,locals:{selectedOrderDetailExtend:orderDetailExtend,saleTypes:$scope.saleTypes}}).then(function(data){console.info("准备修改出货子单身-data:");console.info(data.selectedOrderDetailExtend);EcommerceOrderDetailExtend.modify($scope.selectedItem.uuid,data.selectedOrderDetailExtend.epsOrderDetail.uuid,data.selectedOrderDetailExtend.uuid,data.selectedOrderDetailExtend).success(function(){EcommerceOrderDetail.getAll($scope.selectedItem.uuid).success(function(data){$scope.OrderDetailList=data;$scope.updateOrderDetailDeliverDate($scope.OrderDetailList);
$scope.OrderExtendDetailList=[];angular.forEach($scope.OrderDetailList.content,function(orderDetail,index){EcommerceOrderDetailExtend.getAll($scope.selectedItem.uuid,orderDetail.uuid).success(function(data){$scope.OrderExtendDetailList=$scope.OrderExtendDetailList.concat(data.content)})})});$scope.showInfo("修改成功,正在刷新。")})})};$scope.openAddDetailExtendDlg=function(){if(angular.isUndefined($scope.selectedItem.uuid)||$scope.selectedItem.uuid==null){$scope.showError("请保存单头后再新增出货子单身。");return}console.info("$scope.OrderDetailList");
console.info($scope.OrderDetailList);if(angular.isUndefined($scope.OrderDetailList)||$scope.OrderDetailList==null){$scope.showError("请新增产品单身后再新增出货子单身。");return}if($scope.OrderDetailList.content==0){$scope.showError("请新增产品单身后再新增出货子单身。");return}$mdDialog.show({controller:"EaddOrderDetailExtendController",templateUrl:"app/src/app/taobao_data/ecommerce_orders/orderDetailExtendAddDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{saleTypes:$scope.saleTypes,selectedItem:$scope.selectedItem}}).then(function(data){console.info("选择完毕准备新增出货子单身-data:");
console.info(data.addOrderDetailExtend);var orderMasterUuid=$scope.selectedItem.uuid;var orderDetailExtendInput={selectedOrderDetailUuid:data.addOrderDetailExtend.selectedOrderDetailUuid,epsOrderDetailUuid:data.addOrderDetailExtend.epsOrderDetailUuid,parentItemUuid:data.addOrderDetailExtend.parentItemUuid,no:data.addOrderDetailExtend.selectedBom.no,itemUuid:data.addOrderDetailExtend.selectedBomUuid,itemAttribute:data.addOrderDetailExtend.itemAttribute,orderQuantity:data.addOrderDetailExtend.orderQuantity,
orderPrice:data.addOrderDetailExtend.orderPrice,originalOrderAmount:data.addOrderDetailExtend.originalOrderAmount,originalOrderAmountTax:data.addOrderDetailExtend.originalOrderAmountTax,standardAmount:data.addOrderDetailExtend.standardAmount,remark:data.addOrderDetailExtend.remark};EcommerceOrderDetailExtend.add(orderMasterUuid,data.addOrderDetailExtend.selectedOrderDetailUuid,orderDetailExtendInput).success(function(data){EcommerceOrderDetail.getAll($scope.selectedItem.uuid).success(function(data){$scope.OrderDetailList=
data;$scope.updateOrderDetailDeliverDate($scope.OrderDetailList);$scope.OrderExtendDetailList=[];angular.forEach($scope.OrderDetailList.content,function(orderDetail,index){EcommerceOrderDetailExtend.getAll($scope.selectedItem.uuid,orderDetail.uuid).success(function(data){$scope.OrderExtendDetailList=$scope.OrderExtendDetailList.concat(data.content)})})});$scope.showInfo("新增成功,正在刷新。")}).error(function(response){$scope.showError($scope.getAllError(response))})})};$scope.orderDetailExtendDeleteMenuAction=
function(orderDetailExtend){if($scope.selectedItem.transferPsoFlag=="1"){$scope.showError("已抛转的销售单不能再删除。");return}$scope.showConfirm("确认删除吗？","删除的产品不可恢复。",function(){if($scope.selectedItem&&orderDetailExtend)EcommerceOrderDetailExtend.delete($scope.selectedItem.uuid,orderDetailExtend.epsOrderDetail.uuid,orderDetailExtend.uuid).success(function(){EcommerceOrderDetail.getAll($scope.selectedItem.uuid).success(function(data){$scope.OrderDetailList=data;$scope.updateOrderDetailDeliverDate($scope.OrderDetailList);
$scope.OrderExtendDetailList=[];angular.forEach($scope.OrderDetailList.content,function(orderDetail,index){EcommerceOrderDetailExtend.getAll($scope.selectedItem.uuid,orderDetail.uuid).success(function(data){$scope.OrderExtendDetailList=$scope.OrderExtendDetailList.concat(data.content)})})});$scope.showInfo("删除成功,正在刷新。")}).error(function(response){$scope.showError($scope.getError(response))})})}});
angular.module("IOne-Production").controller("EOrderDetailController",function($scope,$mdDialog,selectedOrderDetail,saleTypes){$scope.selectedOrderDetail=angular.copy(selectedOrderDetail);$scope.itemSearchParam={confirm:2,release:2,status:1,eshopType:2,assemblingFlag:1};$scope.saleTypes=angular.copy(saleTypes);var eSaleType=[];var i=0;angular.forEach(saleTypes.content,function(saleType){if(saleType.no=="ST01")eSaleType[i++]=saleType;if(saleType.no=="ST04")eSaleType[i++]=saleType});$scope.saleTypes=
eSaleType;$scope.disableOrderPrice=false;$scope.isChangingProduction=false;$scope.showChangingProductionPanel=function(){$scope.isChangingProduction=true};$scope.hideChangingProductionPanel=function(){$scope.isChangingProduction=false};$scope.setZero=function(saleType){if(saleType.name=="赠送"){$scope.selectedOrderDetail.orderPrice=0;$scope.disableOrderPrice=true}else $scope.disableOrderPrice=false};$scope.selectBom=function(production){if(production){$scope.selectedOrderDetail.item=production;$scope.selectedOrderDetail.itemUuid=
production.uuid;$scope.isChangingProduction=false}};$scope.hideDlg=function(){$mdDialog.hide({"selectedOrderDetail":$scope.selectedOrderDetail})};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").controller("EChannelSearchController",function($scope,$mdDialog,EchannelService){$scope.pageOption={sizePerPage:5,currentPage:0,totalPage:0,totalElements:0,displayModel:0};$scope.queryAction=function(){$scope.pageOption.currentPage=0;$scope.refreshChannel()};$scope.refreshChannel=function(){EchannelService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,0,0,$scope.searchKeyword,5).success(function(data){$scope.allChannel=data;$scope.pageOption.totalElements=
data.totalElements;$scope.pageOption.totalPage=data.totalPages})};$scope.refreshChannel();$scope.selectChannel=function(channel){$scope.channel=channel;$mdDialog.hide($scope.channel)};$scope.hideDlg=function(){$mdDialog.hide($scope.channel)};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").controller("ETaobaoClientController",function($scope,$mdDialog,EtaobaoCustomers){$scope.pageOption={sizePerPage:5,currentPage:0,totalPage:0,totalElements:0,displayModel:0};$scope.refreshData=function(){EtaobaoCustomers.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.searchKeyword).success(function(data){$scope.allData=data;$scope.pageOption.totalElements=data.totalElements;$scope.pageOption.totalPage=data.totalPages})};$scope.refreshData();
$scope.selectData=function(data){$scope.data=data;$mdDialog.hide($scope.data)};$scope.hideDlg=function(){$mdDialog.hide($scope.data)};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").controller("EDelivWaySearchController",function($scope,$mdDialog,EdelivWayService){$scope.pageOption={sizePerPage:5,currentPage:0,totalPage:0,totalElements:0,displayModel:0};$scope.queryAction=function(){$scope.pageOption.currentPage=0;$scope.refreshDelivWay()};$scope.refreshDelivWay=function(){EdelivWayService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.searchKeyword).success(function(data){$scope.allDelivWay=data;$scope.pageOption.totalElements=
data.totalElements;$scope.pageOption.totalPage=data.totalPages})};$scope.refreshDelivWay();$scope.selectDelivWay=function(delivWay){$scope.delivWay=delivWay;$mdDialog.hide($scope.delivWay)};$scope.hideDlg=function(){$mdDialog.hide($scope.delivWay)};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").controller("EGroupUserSearchController",function($scope,$mdDialog,EgroupUserService){$scope.pageOption={sizePerPage:5,currentPage:0,totalPage:0,totalElements:0,displayModel:0};$scope.queryAction=function(){$scope.pageOption.currentPage=0;$scope.refreshGroupUser()};$scope.refreshGroupUser=function(){EgroupUserService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.searchKeyword).success(function(data){$scope.allGroupUser=data;$scope.pageOption.totalElements=
data.totalElements;$scope.pageOption.totalPage=data.totalPages})};$scope.refreshGroupUser();$scope.selectGroupUser=function(groupUser){$scope.groupUser=groupUser;$mdDialog.hide($scope.groupUser)};$scope.hideDlg=function(){$mdDialog.hide($scope.groupUser)};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").controller("EMallSearchController",function($scope,$mdDialog,EmallService){$scope.pageOption={sizePerPage:5,currentPage:0,totalPage:0,totalElements:0,displayModel:0};$scope.refreshMall=function(){EmallService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.searchKeyword).success(function(data){$scope.allMall=data;$scope.pageOption.totalElements=data.totalElements;$scope.pageOption.totalPage=data.totalPages})};$scope.refreshMall();$scope.selectMall=
function(mall){$scope.mall=mall;$mdDialog.hide($scope.mall)};$scope.hideDlg=function(){$mdDialog.hide($scope.mall)};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").controller("EAreaSearchController",function($scope,$mdToast,$mdDialog,EareaService,SYSMapsService){$scope.pageOption={sizePerPage:5,currentPage:0,totalPage:0,totalElements:0,displayModel:0};$scope.queryAction=function(){$scope.pageOption.currentPage=0;$scope.refreshArea()};$scope.refreshArea=function(){EareaService.getAllForEcommerceOrders($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,0,0,$scope.searchKeyword).success(function(data){$scope.allArea=data;
angular.forEach($scope.allArea.content,function(area){if(area.fullPath){area.path="";for(var i=2,l=area.fullPath.length;i<l;i++)area.path=area.path+area.fullPath[i]+"-";area.path=area.path.substr(0,area.path.length-1)}});$scope.pageOption.totalElements=data.totalElements;$scope.pageOption.totalPage=data.totalPages})};$scope.refreshArea();$scope.selectArea=function(area){SYSMapsService.getAll(100,0,"TIPTOP","电商城区编码",area.uuid).success(function(data){if(data.totalElements>0&&data.content.length>0){$scope.area=
area;$mdDialog.hide($scope.area)}else toastr["error"]("该区域没有对应的电商城区编码,请检查或重新选择")})};$scope.hideDlg=function(){$mdDialog.hide($scope.area)};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").controller("EAddDetailController",function($scope,$mdDialog,saleTypes,OrderDetailList){$scope.OrderDetailList=angular.copy(OrderDetailList);$scope.addOrderDetail=[];$scope.itemSearchParam={confirm:2,release:2,status:1,eshopType:2,assemblingFlag:1};$scope.saleTypes=angular.copy(saleTypes);var eSaleType=[];var i=0;angular.forEach(saleTypes.content,function(saleType){if(saleType.no=="ST01"){eSaleType[i++]=saleType;$scope.addOrderDetail.saleTypeUuid=saleType.uuid}if(saleType.no==
"ST04")eSaleType[i++]=saleType});$scope.saleTypes=eSaleType;$scope.disableOrderPrice=false;$scope.isChangingProduction=false;$scope.showChangingProductionPanel=function(){$scope.isChangingProduction=true};$scope.hideChangingProductionPanel=function(){$scope.isChangingProduction=false};var maxNo=0;$scope.findMaxNo=function(OrderDetailList){if($scope.OrderDetailList!==undefined&&$scope.OrderDetailList!==""&&$scope.OrderDetailList!==null){maxNo=0;angular.forEach(OrderDetailList.content,function(orderDetail){if(Number(orderDetail.no)>
Number(maxNo))maxNo=Number(orderDetail.no)})}};$scope.findMaxNo(OrderDetailList);$scope.setZero=function(saleType){if(saleType.name=="赠送"){$scope.addOrderDetail.orderPrice=0;$scope.disableOrderPrice=true}else $scope.disableOrderPrice=false};$scope.selectBom=function(production){if(production){$scope.addOrderDetail.no=Number(maxNo)+Number(1);$scope.addOrderDetail.item=production;$scope.addOrderDetail.itemUuid=production.uuid;$scope.addOrderDetail.orderQuantity=1;$scope.isChangingProduction=false}};
$scope.hideDlg=function(){$mdDialog.hide({"addOrderDetail":$scope.addOrderDetail})};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").controller("EaddOrderDetailExtendController",function($scope,$mdDialog,EcommerceOrderDetail,selectedItem,Constant){$scope.itemSearchParam={confirm:2,release:2,status:1,eshopType:2,assemblingFlag:1};console.info("在EaddOrderDetailExtendController的selectedItem");$scope.selectedItem=angular.copy(selectedItem);console.info($scope.selectedItem);$scope.addOrderDetailExtend=[];$scope.addOrderDetailExtend.selectedOrderDetail=[];$scope.addOrderDetailExtend.selectedBom=[];$scope.isChangingProduction=
false;$scope.showChangingProductionPanel=function(){$scope.isChangingProduction=true};$scope.hideChangingProductionPanel=function(){$scope.isChangingProduction=false};$scope.refreshOrderDetail=function(){EcommerceOrderDetail.getAll($scope.selectedItem.uuid).success(function(data){$scope.allOrderDetail=data})};$scope.refreshOrderDetail();$scope.selectedOrderDetail=function(epsOrderDetailUuid,parentItemUuid){if(epsOrderDetailUuid&&parentItemUuid){$scope.addOrderDetailExtend.epsOrderDetailUuid=epsOrderDetailUuid;
$scope.addOrderDetailExtend.parentItemUuid=parentItemUuid}};$scope.selectBom=function(production){if(production){$scope.addOrderDetailExtend.selectedBom=production;$scope.addOrderDetailExtend.selectedBomUuid=production.uuid;$scope.addOrderDetailExtend.orderQuantity=1;$scope.isChangingProduction=false}};$scope.hideDlg=function(){$mdDialog.hide({"addOrderDetailExtend":$scope.addOrderDetailExtend})};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").controller("EeditOrderExtendDetailController",function($scope,$mdDialog,selectedOrderDetailExtend,saleTypes){$scope.itemSearchParam={confirm:2,release:2,status:1,eshopType:2,assemblingFlag:1};$scope.selectedOrderDetailExtend=angular.copy(selectedOrderDetailExtend);console.info("修改出货子单身，原始值：");console.info($scope.selectedOrderDetailExtend);$scope.isChangingProduction=false;$scope.showChangingProductionPanel=function(){$scope.isChangingProduction=true};$scope.hideChangingProductionPanel=
function(){$scope.isChangingProduction=false};$scope.selectedOrderDetailExtend.parentItemUuid=$scope.selectedOrderDetailExtend.parentItem.uuid;$scope.selectedOrderDetailExtend.epsOrderDetailUuid=$scope.selectedOrderDetailExtend.epsOrderDetail.uuid;$scope.selectedOrderDetailExtend.itemUuid=$scope.selectedOrderDetailExtend.item.uuid;$scope.selectBom=function(production){if(production){$scope.selectedOrderDetailExtend.item=production;$scope.selectedOrderDetailExtend.itemUuid=production.uuid;$scope.isChangingProduction=
false}};$scope.hideDlg=function(){$mdDialog.hide({"selectedOrderDetailExtend":$scope.selectedOrderDetailExtend})};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").service("EcommerceOrdersMaster",function($http,Constant){this.getAll=function(sizePerPage,page,orderFlag,confirm,status,transferPsoFlag,buyerNick,orderMasterNo,orderDateBegin,orderDateEnd,resUuid){orderFlag=orderFlag==0?"":orderFlag;confirm=confirm==0?"":confirm;status=status==0?"":status;transferPsoFlag=transferPsoFlag==0?"":transferPsoFlag;var url="epsOrders?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26confirm\x3d"+confirm+"\x26status\x3d"+status+"\x26transferPsoFlag\x3d"+
transferPsoFlag;if(orderFlag!=null)url=url+"\x26orderFlag\x3d"+orderFlag;if(buyerNick!=null)url=url+"\x26buyerNick\x3d"+buyerNick;if(orderMasterNo!=null)url=url+"\x26no\x3d"+orderMasterNo;if(orderDateBegin!=null)url=url+"\x26orderDateBegin\x3d"+orderDateBegin;if(orderDateEnd!=null)url=url+"\x26orderDateEnd\x3d"+orderDateEnd;if(resUuid!=null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+"/epsOrders/"+uuid)};
this.add=function(order){return $http.post(Constant.BACKEND_BASE+"/epsOrders/",order)};this.modify=function(OrderMasterUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/epsOrders/"+OrderMasterUpdateInput.uuid,OrderMasterUpdateInput)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/epsOrders/"+uuid)};this.print=function(type,uuid){return $http.get(Constant.BACKEND_BASE+"/reports",{params:{type:type,params:uuid}})};this.createDefault=function(){orderDate=new Date;predictDeliverDate=
new Date(orderDate.valueOf()+2*24*60*60*1E3);order={"no":"","userId":"","buyerNick":"","receiveName":"","receivePhone":"","receiveAddress":"","receiveDistrict":"","remark":"","orderFlag":"4","orderAmount":"","assembleAmount":"","orderDate":orderDate,"predictDeliverDate":predictDeliverDate,"channel":"","details":"","deliverWay":""};return order}});
angular.module("IOne-Production").service("EcommerceOrderDetail",function($http,Constant){this.getAll=function(masterUuid){return $http.get(Constant.BACKEND_BASE+"/epsOrders/"+masterUuid+"/details")};this.get=function(masterUuid,detailUuid){return $http.get(Constant.BACKEND_BASE+"/epsOrders/"+masterUuid+"/details/"+detailUuid)};this.modify=function(masterUuid,orderDetailUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/epsOrders/"+masterUuid+"/details/"+orderDetailUpdateInput.uuid,orderDetailUpdateInput)};
this.add=function(masterUuid,detailInput){return $http.post(Constant.BACKEND_BASE+"/epsOrders/"+masterUuid+"/details",detailInput)};this.delete=function(masterUuid,detailUuid){return $http.delete(Constant.BACKEND_BASE+"/epsOrders/"+masterUuid+"/details/"+detailUuid)}});
angular.module("IOne-Production").service("EcommerceOrderDetailExtend",function($http,Constant){this.getAll=function(masterUuid,detailUuid){return $http.get(Constant.BACKEND_BASE+"/epsOrders/"+masterUuid+"/details/"+detailUuid+"/extends")};this.modify=function(masterUuid,detailUuid,uuid,extendUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/epsOrders/"+masterUuid+"/details/"+detailUuid+"/extends/"+uuid,extendUpdateInput)};this.delete=function(masterUuid,detailUuid,uuid){return $http.delete(Constant.BACKEND_BASE+
"/epsOrders/"+masterUuid+"/details/"+detailUuid+"/extends/"+uuid)};this.add=function(masterUuid,detailUuid,extendUpdateInput){return $http.post(Constant.BACKEND_BASE+"/epsOrders/"+masterUuid+"/details/"+detailUuid+"/extends",extendUpdateInput)}});
angular.module("IOne-Production").service("EtaobaoCustomers",function($http,Constant){this.getAll=function(sizePerPage,page,clientName){var url="/taobaoCustomers?size\x3d"+sizePerPage+"\x26page\x3d"+page;if(clientName!==undefined&&clientName!==null)url=url+"\x26name\x3d"+clientName;return $http.get(Constant.BACKEND_BASE+url)}});
angular.module("IOne-Production").service("EmallService",function($http,Constant){this.getAll=function(sizePerPage,page,mallName){var url="/malls?size\x3d"+sizePerPage+"\x26page\x3d"+page;if(mallName!==undefined&&mallName!==null)url=url+"\x26name\x3d"+mallName;return $http.get(Constant.BACKEND_BASE+url)}});
angular.module("IOne-Production").service("EdelivWayService",function($http,Constant){this.getAll=function(sizePerPage,page,delivWayName,delivWayNo){var url="/deliverWays?size\x3d"+sizePerPage+"\x26page\x3d"+page;if(delivWayName!==undefined&&delivWayName!==null)url=url+"\x26name\x3d"+delivWayName;if(delivWayNo!==undefined&&delivWayNo!==null)url=url+"\x26no\x3d"+delivWayNo;return $http.get(Constant.BACKEND_BASE+url)}});
angular.module("IOne-Production").service("EgroupUserService",function($http,Constant){this.getAll=function(sizePerPage,page,no){var url="/groupUsers?size\x3d"+sizePerPage+"\x26page\x3d"+page;if(no!==undefined&&no!==null)url=url+"\x26no\x3d"+no;return $http.get(Constant.BACKEND_BASE+url)}});
angular.module("IOne-Production").service("EchannelService",function($http,Constant){this.getAll=function(sizePerPage,page,confirm,status,channelName,channelFlag,resUuid){confirm=confirm==0?"":confirm;status=status==0?"":status;var url="/channels?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26confirm\x3d"+confirm+"\x26status\x3d"+status;if(channelName!==undefined&&channelName!==null)url=url+"\x26name\x3d"+channelName;if(channelFlag!==undefined&&channelFlag!==null)url=url+"\x26channelFlag\x3d"+channelFlag;
if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)}});
angular.module("IOne-Production").service("EareaService",function($http,Constant){this.getAll=function(sizePerPage,page,confirm,status,name,grade,resUuid){confirm=confirm==0?"":confirm;status=status==0?"":status;var url="/areas?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26confirm\x3d"+confirm+"\x26status\x3d"+status;if(name!==undefined&&name!==null)url=url+"\x26name\x3d"+name;if(grade!==undefined&&grade!==null)url=url+"\x26grade\x3d"+grade;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+
resUuid;return $http.get(Constant.BACKEND_BASE+url)};this.getAllForEcommerceOrders=function(sizePerPage,page,confirm,status,name,grade,resUuid){confirm=confirm==0?"":confirm;status=status==0?"":status;var url="/areas?type\x3decommerceOrder\x26size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26confirm\x3d"+confirm+"\x26status\x3d"+status;if(name!==undefined&&name!==null)url=url+"\x26name\x3d"+name;if(grade!==undefined&&grade!==null)url=url+"\x26grade\x3d"+grade;if(resUuid!==undefined&&resUuid!==null)url=
url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/cbi/employee",{controller:"EmployeeController",templateUrl:"app/src/app/cbi/employee/employee.html"})}]);
angular.module("IOne-Production").controller("EmployeeController",function($scope,$q,CBIEmployeeService,$mdDialog,Constant,UserRoleService,UserService,OCMChannelService,Upload,$timeout){$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value,release:Constant.RELEASE[0].value};$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.menuDisplayOption={"401-confirm":{display:true,
name:"审核",uuid:"7D4C1949-3F26-4D1A-A2F9-3A14EC43477C"},"402-confirmRevert":{display:true,name:"取消审核",uuid:"04CB1CE7-CD5B-46A5-812E-60C873B2571B"},"403-status":{display:true,name:"启用",uuid:"52A51292-D1E1-4084-A87D-0639666E5388"},"404-statusRevert":{display:true,name:"取消启用",uuid:"BBF38AA3-0ED9-4098-BC1F-434271821455"},"405-delete":{display:true,name:"删除",uuid:"0C96DB72-F8B5-4B58-AB6B-04368DCA20EE"},"406-query":{display:true,name:"查询",uuid:"7E4A01CB-7E11-416C-81B0-42703F83ECE9"},"411-confirmAll":{display:true,
name:"批量审核",uuid:"E4ADE57D-2DF6-43CA-AEE1-D7324C1600C1"},"412-confirmRevertAll":{display:true,name:"批量取消审核",uuid:"3046A5DE-DD86-4FF1-8106-C9CD93E6CC37"},"413-statusAll":{display:true,name:"批量启用",uuid:"EAA2BA2A-9ED0-4B68-9ED4-6D857A8AFCC4"},"414-statusRevertAll":{display:true,name:"批量取消启用",uuid:"8009C97B-2EE4-4E14-8EDB-D0068596C260"},"415-deleteAll":{display:true,name:"批量删除",uuid:"1D308CCF-3533-424F-B5F0-ADD1D17971BF"}};$scope.refreshList=function(){CBIEmployeeService.getAll($scope.pageOption.sizePerPage,
$scope.pageOption.currentPage,$scope.listFilterOption.confirm,$scope.listFilterOption.status,$scope.theMax,$scope.RES_UUID_MAP.CBI.EMPL.RES_UUID).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;$scope.resetButtonDisabled();$scope.selectAllFlag=false;$scope.selected=[]})};$scope.getMenuAuthData($scope.RES_UUID_MAP.CBI.EMPL.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)});
$scope.$watch("listFilterOption",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()}};$scope.selectAllFlag=false;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;$scope.selectedItem.employeeImg=$scope.getEmployeeImageFullPath(item.picPath,
item.sex);item.detailList=$scope.subItemList;$scope.changeButtonStatusSingle(item);UserService.getUser(item.uuid,3).success(function(data){item.user=data.content[0];UserRoleService.get(item.user.uuid).success(function(data){item.user.userRoleList=data})})};$scope.returnToListAction=function(event,item){$scope.stopEventPropagation(event);$scope.selectedItem=null;$scope.changeButtonStatusAll();$scope.refreshList()};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;
$scope.selectedItem=null};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel)item.detailList=item};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);$scope.refreshList()};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=
desc;$scope.source=source;$scope.domain=domain;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.source.confirm=="2"&&$scope.source.status=="2"){$scope.showError("不允许状态是已审核又无效,请调整后再保存");return}if($scope.status=="add"){if($scope.domain=="CBI_BASE_EMPL"){if($scope.source.leaveDate!=
null&&$scope.source.arriveDate!=null&&$scope.source.arriveDate>$scope.source.leaveDate){$scope.showError("离职日不能大于到职日,请修改后保存");return}if($scope.source.leaveDate!=null&&$scope.source.leaveDate<new Date&&$scope.source.employeeStatus!="2"){$scope.showError("离职日小于当前时间,若该员工已离职,请将员工状态设为离职后保存");return}OCMChannelService.getByNo($scope.source.no).success(function(result){if(result.totalElements>0)$scope.showError("员工编号不可与渠道商编号相同。");else CBIEmployeeService.add($scope.source).success(function(data){$scope.showInfo("新增数据成功。")}).error(function(response){$scope.showError("新增数据失败: "+
response.message)})})}}else if($scope.status=="edit")if($scope.domain=="CBI_BASE_EMPL"){if($scope.source.leaveDate!=null&&$scope.source.arriveDate!=null&&$scope.source.arriveDate>$scope.source.leaveDate){$scope.showError("离职日不能大于到职日,请修改后保存");return}if($scope.source.leaveDate!=null&&$scope.source.leaveDate<new Date&&$scope.source.employeeStatus!="2"){$scope.showError("离职日小于当前时间,若该员工已离职,请将员工状态设为离职后保存");return}$scope.source.password=null;OCMChannelService.getByNo($scope.source.no).success(function(result){if(result.totalElements>
0)$scope.showError("员工编号不可与渠道商编号相同。");else CBIEmployeeService.modify($scope.source.uuid,$scope.source).success(function(data){$scope.showInfo("修改数据成功。");$scope.source=data;$scope.selectedItem=data;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)}).error(function(response){$scope.showError("修改数据失败: "+response.message);$scope.source=angular.copy($scope.selectedItemBackUp);$scope.selectedItem=angular.copy($scope.selectedItemBackUp)})})}};$scope.confirmClickAction=function(event,item){$scope.stopEventPropagation(event);
$scope.showConfirm("确认审核吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};CBIEmployeeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.selectedItem.confirm=Constant.CONFIRM[2].value;$scope.changeButtonStatusSingle($scope.selectedItem);$scope.showInfo("审核成功。")}).error(function(response){$scope.showError("审核失败: "+response.message)})})};$scope.confirmRevertClickAction=function(event,item){$scope.stopEventPropagation(event);
$scope.showConfirm("确认取消审核吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};CBIEmployeeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.selectedItem.confirm=Constant.CONFIRM[1].value;$scope.changeButtonStatusSingle($scope.selectedItem);$scope.showInfo("取消审核成功。")}).error(function(response){$scope.showError("取消审核失败: "+response.message)})})};$scope.confirmSwitchAction=function(event,item){$scope.stopEventPropagation(event);
if(item.confirm==2)$scope.showConfirm("确认取消审核吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};CBIEmployeeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.changeButtonStatusAll();$scope.showInfo("修改数据成功。")})},function(){item.confirm=Constant.CONFIRM[2].value});else if(item.confirm==1){if(item.status==Constant.STATUS[2].value){$scope.showWarn("项目是失效状态,请先启用后再审核");item.confirm=Constant.CONFIRM[2].value;return}$scope.showConfirm("确认审核吗？",
"",function(){var EmployeeUpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};CBIEmployeeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.changeButtonStatusAll();$scope.showInfo("修改数据成功。")})},function(){item.confirm=Constant.CONFIRM[1].value})}};$scope.statusClickAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认修改启用状态为有效吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};CBIEmployeeService.modify(EmployeeUpdateInput.uuid,
EmployeeUpdateInput).success(function(){$scope.selectedItem.status=Constant.STATUS[1].value;$scope.changeButtonStatusSingle($scope.selectedItem);$scope.showInfo("修改数据成功。")})})};$scope.statusRevertClickAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认修改启用状态为无效吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value,confirm:Constant.CONFIRM[1].value};CBIEmployeeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.selectedItem.status=
Constant.STATUS[2].value;$scope.selectedItem.confirm=Constant.CONFIRM[1].value;$scope.changeButtonStatusSingle($scope.selectedItem);$scope.showInfo("修改数据成功。")})})};$scope.statusSwithAction=function(event,item){$scope.stopEventPropagation(event);if(item.status==2)$scope.showConfirm("确认修改启用状态为有效吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};CBIEmployeeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.changeButtonStatusAll();
$scope.showInfo("修改数据成功。")})},function(){item.status=Constant.STATUS[2].value});else if(item.status==1)$scope.showConfirm("确认修改启用状态为无效吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value,confirm:Constant.CONFIRM[1].value};CBIEmployeeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){item.confirm=Constant.CONFIRM[1].value;$scope.changeButtonStatusAll();$scope.showInfo("修改数据成功。")})},function(){item.status=Constant.STATUS[1].value})};
$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){CBIEmployeeService.delete(item.uuid).success(function(){$scope.selectedItem=null;$scope.refreshList();$scope.showInfo("删除数据成功。")})})};$scope.confirmAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selected.length>0)$scope.showConfirm("确认批量审核吗？","",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(item){var EmployeeUpdateInput=
{uuid:item.uuid,confirm:Constant.CONFIRM[2].value};var response=CBIEmployeeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.refreshList()})}})};$scope.confirmRevertAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selected.length>0)$scope.showConfirm("确认批量取消审核吗？","",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,
function(item){var EmployeeUpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};var response=CBIEmployeeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.refreshList()})}})};$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selected.length>0)$scope.showConfirm("确认批量修改启用状态为有效吗？","",function(){if($scope.selected){var promises=
[];angular.forEach($scope.selected,function(item){var EmployeeUpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};var response=CBIEmployeeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.refreshList()})}})};$scope.statusRevertAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selected.length>0)$scope.showConfirm("确认批量修改启用状态为无效吗？","",function(){if($scope.selected){var promises=
[];angular.forEach($scope.selected,function(item){var EmployeeUpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value,confirm:Constant.CONFIRM[1].value};var response=CBIEmployeeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.refreshList()})}})};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selected.length>0)$scope.showConfirm("确认删除吗？",
"删除后不可恢复。",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(item){var response=CBIEmployeeService.delete(item.uuid).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("删除数据成功。");$scope.refreshList()})}})};$scope.selectAllAction=function(){if($scope.selectAllFlag==true)angular.forEach($scope.itemList,function(item){var idx=$scope.selected.indexOf(item);if(idx<0)$scope.selected.push(item)});else if($scope.selectAllFlag==
false)$scope.selected=[];$scope.selectItemCount=$scope.selected.length;$scope.changeButtonStatusAll()};$scope.selectItemAction=function(event,item,selected){$scope.stopEventPropagation(event);var idx=selected.indexOf(item);if(idx>-1)selected.splice(idx,1);else selected.push(item);$scope.selectItemCount=$scope.selected.length;$scope.changeButtonStatusAll()};$scope.exists=function(item,selected){return selected.indexOf(item)>-1};$scope.selected=[];$scope.resetButtonDisabled=function(){$scope.confirmClick=
0;$scope.confirmRevertClick=0;$scope.statusClick=0;$scope.statusRevertClick=0;$scope.deleteClick=0};$scope.resetButtonDisabledAll=function(){$scope.deleteAllClick=0;$scope.statusRevertAllClick=0;$scope.statusAllClick=0;$scope.confirmRevertAllClick=0;$scope.confirmAllClick=0};$scope.changeButtonStatusAll=function(){$scope.resetButtonDisabledAll();angular.forEach($scope.selected,function(employee){$scope.processChangeButtonStatusAll(employee)})};$scope.changeButtonStatusSingle=function(employee){$scope.resetButtonDisabled();
$scope.processChangeButtonStatus(employee)};$scope.processChangeButtonStatus=function(employee){if(employee.confirm==1||employee.confirm==4)$scope.confirmRevertClick=1;if(employee.confirm==2||employee.confirm==3){$scope.confirmClick=1;$scope.deleteClick=1}if(employee.status==1)$scope.statusClick=1;if(employee.status==2){$scope.statusRevertClick=1;$scope.confirmClick=1;$scope.deleteClick=1}};$scope.processChangeButtonStatusAll=function(employee){if(employee.confirm==1||employee.item==4)$scope.confirmRevertAllClick=
1;if(employee.confirm==2||employee.item==3){$scope.confirmAllClick=1;$scope.deleteAllClick=1}if(employee.status==1)$scope.statusAllClick=1;if(employee.status==2){$scope.statusRevertAllClick=1;$scope.confirmAllClick=1}};$scope.showUserRoles=function(user){if(user.baseUser==undefined)UserService.getUser(user.uuid,3).success(function(data){user.baseUser=data.content[0];UserRoleService.get(user.baseUser.uuid).success(function(data){user.userRoleList=data})})};$scope.addUserRole=function(){$mdDialog.show({controller:"RoleListController",
templateUrl:"app/src/app/auth/user/addRoleDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{}}).then(function(data){UserRoleService.add($scope.selectedItem.user.uuid,data.selectedRole.uuid).success(function(data){$scope.selectedItem.user.userRoleList=$scope.selectedItem.user.userRoleList||[];$scope.selectedItem.user.userRoleList.push(data)}).error(function(){$scope.showError("新增角色失败，该角色可能已存在。")})})};$scope.deleteUserRole=function(userRole){UserRoleService.delete(userRole.uuid).success(function(){$scope.selectedItem.user.userRoleList.splice($scope.selectedItem.user.userRoleList.indexOf(userRole),
1)})};$scope.getEmployeeImageFullPath=function(path,sex){if(path==null||path==undefined)if(sex==1)return Constant.BACKEND_BASE+"/app/img/male.png";else if(sex==2)return Constant.BACKEND_BASE+"/app/img/female.png";else return Constant.BACKEND_BASE+"/app/img/unknown.png";if(path&&path.indexOf("IMAGE")==0)return Constant.BACKEND_BASE+"/app/assets/"+path;else return Constant.BACKEND_BASE+"/app/assets/IMAGE/"+path};$scope.uploadImage=function(files){$scope.progress={value:0};if(files&&files.length)for(var i=
0;i<files.length;i++){var file=files[i];Upload.upload({url:Constant.BACKEND_BASE+"/files",fields:{},file:file}).progress(function(evt){$scope.progress.value=Math.min(100,parseInt(99*evt.loaded/evt.total))}).success(function(data){$timeout(function(){if($scope.selectedItem&&$scope.selectedItem.uuid)CBIEmployeeService.addImage($scope.selectedItem.uuid,data.uuid).success(function(response){$scope.showInfo("上传成功");$scope.selectedItem.employeeImg=$scope.getEmployeeImageFullPath(response.picPath,response.sex)+
"?time\x3d"+(new Date).getTime()})})})}}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/cbi/employee_password",{controller:"EmployeePasswordController",templateUrl:"app/src/app/cbi/employee_password/employeePassword.html"})}]);
angular.module("IOne-Production").controller("EmployeePasswordController",function($scope,$q,CBIEmployeeService,$mdDialog,Constant,UserRoleService,UserService,Upload,$timeout){$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value,release:Constant.RELEASE[0].value};$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.menuDisplayOption={"401-confirm":{display:true,
name:"审核",uuid:"7D4C1949-3F26-4D1A-A2F9-3A14EC43477C"},"402-confirmRevert":{display:true,name:"取消审核",uuid:"04CB1CE7-CD5B-46A5-812E-60C873B2571B"},"403-status":{display:true,name:"启用",uuid:"52A51292-D1E1-4084-A87D-0639666E5388"},"404-statusRevert":{display:true,name:"取消启用",uuid:"BBF38AA3-0ED9-4098-BC1F-434271821455"},"405-delete":{display:true,name:"删除",uuid:"0C96DB72-F8B5-4B58-AB6B-04368DCA20EE"},"406-query":{display:true,name:"查询",uuid:"7E4A01CB-7E11-416C-81B0-42703F83ECE9"},"411-confirmAll":{display:true,
name:"批量审核",uuid:"E4ADE57D-2DF6-43CA-AEE1-D7324C1600C1"},"412-confirmRevertAll":{display:true,name:"批量取消审核",uuid:"3046A5DE-DD86-4FF1-8106-C9CD93E6CC37"},"413-statusAll":{display:true,name:"批量启用",uuid:"EAA2BA2A-9ED0-4B68-9ED4-6D857A8AFCC4"},"414-statusRevertAll":{display:true,name:"批量取消启用",uuid:"8009C97B-2EE4-4E14-8EDB-D0068596C260"},"415-deleteAll":{display:true,name:"批量删除",uuid:"1D308CCF-3533-424F-B5F0-ADD1D17971BF"}};$scope.refreshList=function(){CBIEmployeeService.getAll($scope.pageOption.sizePerPage,
$scope.pageOption.currentPage,$scope.listFilterOption.confirm,$scope.listFilterOption.status,$scope.theMax,$scope.RES_UUID_MAP.CBI.EMPL.RES_UUID).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;$scope.resetButtonDisabled();$scope.selectAllFlag=false;$scope.selected=[]})};$scope.getMenuAuthData($scope.RES_UUID_MAP.CBI.EMPL.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)});
$scope.$watch("listFilterOption",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.selectAllFlag=false;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;item.detailList=$scope.subItemList;$scope.changeButtonStatusSingle(item);UserService.getUser(item.uuid,3).success(function(data){item.user=data.content[0]})};$scope.returnToListAction=function(event,item){$scope.stopEventPropagation(event);
$scope.selectedItem=null;$scope.changeButtonStatusAll()};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;$scope.selectedItem=null};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel)item.detailList=item};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS)};
$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.status=="add"){if($scope.domain=="CBI_BASE_EMPL")CBIEmployeeService.add($scope.source).success(function(data){$scope.showInfo("新增数据成功。")}).error(function(){$scope.showError("新增失败。")})}else if($scope.status==
"edit")if($scope.domain=="CBI_BASE_EMPL")CBIEmployeeService.modify($scope.source.uuid,$scope.source).success(function(data){$scope.showInfo("修改数据成功。")}).error(function(){$scope.showError("修改失败。")})};$scope.confirmClickAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认审核吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};CBIEmployeeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.selectedItem.confirm=
Constant.CONFIRM[2].value;$scope.changeButtonStatusSingle($scope.selectedItem);$scope.showInfo("修改数据成功。")})})};$scope.confirmRevertClickAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认取消审核吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};CBIEmployeeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.selectedItem.confirm=Constant.CONFIRM[1].value;$scope.changeButtonStatusSingle($scope.selectedItem);
$scope.showInfo("修改数据成功。")})})};$scope.confirmSwitchAction=function(event,item){$scope.stopEventPropagation(event);if(item.confirm==2)$scope.showConfirm("确认取消审核吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};CBIEmployeeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.changeButtonStatusAll();$scope.showInfo("修改数据成功。")})});else if(item.confirm==1)$scope.showConfirm("确认审核吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,
confirm:Constant.CONFIRM[2].value};CBIEmployeeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.changeButtonStatusAll();$scope.showInfo("修改数据成功。")})})};$scope.statusClickAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认修改启用状态为有效吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};CBIEmployeeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.selectedItem.status=
Constant.STATUS[1].value;$scope.changeButtonStatusSingle($scope.selectedItem);$scope.showInfo("修改数据成功。")})})};$scope.statusRevertClickAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认修改启用状态为无效吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value};CBIEmployeeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.selectedItem.status=Constant.STATUS[2].value;$scope.changeButtonStatusSingle($scope.selectedItem);
$scope.showInfo("修改数据成功。")})})};$scope.statusSwithAction=function(event,item){$scope.stopEventPropagation(event);if(item.status==2)$scope.showConfirm("确认修改启用状态为有效吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};CBIEmployeeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.changeButtonStatusAll();$scope.showInfo("修改数据成功。")})});else if(item.status==1)$scope.showConfirm("确认修改启用状态为无效吗？","",function(){var EmployeeUpdateInput=
{uuid:item.uuid,status:Constant.STATUS[2].value};CBIEmployeeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.changeButtonStatusAll();$scope.showInfo("修改数据成功。")})})};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){CBIEmployeeService.delete(item.uuid).success(function(){$scope.selectedItem=null;$scope.refreshList();$scope.showInfo("删除数据成功。")})})};$scope.confirmAllClickAction=function(event){$scope.stopEventPropagation(event);
if($scope.selected.length>0)$scope.showConfirm("确认批量审核吗？","",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(item){var EmployeeUpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};var response=CBIEmployeeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.refreshList()})}})};$scope.confirmRevertAllClickAction=function(event){$scope.stopEventPropagation(event);
if($scope.selected.length>0)$scope.showConfirm("确认批量取消审核吗？","",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(item){var EmployeeUpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};var response=CBIEmployeeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.refreshList()})}})};$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);
if($scope.selected.length>0)$scope.showConfirm("确认批量修改启用状态为有效吗？","",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(item){var EmployeeUpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};var response=CBIEmployeeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.refreshList()})}})};$scope.statusRevertAllClickAction=function(event){$scope.stopEventPropagation(event);
if($scope.selected.length>0)$scope.showConfirm("确认批量修改启用状态为无效吗？","",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(item){var EmployeeUpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value};var response=CBIEmployeeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.refreshList()})}})};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);
if($scope.selected.length>0)$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(item){var response=CBIEmployeeService.delete(item.uuid).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("删除数据成功。");$scope.refreshList()})}})};$scope.selectAllAction=function(){if($scope.selectAllFlag==true)angular.forEach($scope.itemList,function(item){var idx=$scope.selected.indexOf(item);if(idx<
0)$scope.selected.push(item)});else if($scope.selectAllFlag==false)$scope.selected=[];$scope.selectItemCount=$scope.selected.length;$scope.changeButtonStatusAll()};$scope.selectItemAction=function(event,item,selected){$scope.stopEventPropagation(event);var idx=selected.indexOf(item);if(idx>-1)selected.splice(idx,1);else selected.push(item);$scope.selectItemCount=$scope.selected.length;$scope.changeButtonStatusAll()};$scope.exists=function(item,selected){return selected.indexOf(item)>-1};$scope.selected=
[];$scope.resetButtonDisabled=function(){$scope.confirmClick=0;$scope.confirmRevertClick=0;$scope.statusClick=0;$scope.statusRevertClick=0;$scope.deleteClick=0};$scope.resetButtonDisabledAll=function(){$scope.deleteAllClick=0;$scope.statusRevertAllClick=0;$scope.statusAllClick=0;$scope.confirmRevertAllClick=0;$scope.confirmAllClick=0};$scope.changeButtonStatusAll=function(){$scope.resetButtonDisabledAll();angular.forEach($scope.selected,function(employee){$scope.processChangeButtonStatusAll(employee)})};
$scope.changeButtonStatusSingle=function(employee){$scope.resetButtonDisabled();$scope.processChangeButtonStatus(employee)};$scope.processChangeButtonStatus=function(employee){if(employee.confirm==1||employee.item==4)$scope.confirmRevertClick=1;if(employee.confirm==2||employee.item==3){$scope.confirmClick=1;$scope.statusRevertClick=1}if(employee.status==1)$scope.statusClick=1;if(employee.status==2){$scope.statusRevertClick=1;$scope.confirmClick=1}};$scope.processChangeButtonStatusAll=function(employee){if(employee.confirm==
1||employee.item==4)$scope.confirmRevertAllClick=1;if(employee.confirm==2||employee.item==3){$scope.confirmAllClick=1;$scope.statusRevertAllClick=1}if(employee.status==1)$scope.statusAllClick=1;if(employee.status==2){$scope.statusRevertAllClick=1;$scope.confirmAllClick=1}};$scope.showUserRoles=function(user){if(user.baseUser==undefined)UserService.getUser(user.uuid,3).success(function(data){user.baseUser=data.content[0];UserRoleService.get(user.baseUser.uuid).success(function(data){user.userRoleList=
data})})};$scope.changeCurrentUserPw=function(selectedItem){$mdDialog.show({controller:"ChangeCurrentUserPwController",templateUrl:"app/src/app/cbi/employee_password/changePassword.html",parent:angular.element(document.body),targetEvent:event}).then(function(data){$scope.userPassword=data;$scope.userPassword.name=selectedItem.no;UserService.modifyPassword($scope.userPassword).success(function(){$scope.showInfo("修改密码成功。")}).error(function(data){$scope.showError(data.message)})})}});
angular.module("IOne-Production").controller("ChangeCurrentUserPwController",function($scope,$mdDialog){$scope.user=null;$scope.hideDlg=function(){if($scope.user==null)toastr["error"]("请输入新密码");else if($scope.user.newPassword==null)toastr["error"]("新密码为空");else $mdDialog.hide($scope.user)};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").service("EmployeeService",function($http,Constant){this.getAll=function(sizePerPage,page,keyword){var url="groupUsers?size\x3d"+sizePerPage+"\x26page\x3d"+page;if(keyword!==null&&keyword!==undefined&&keyword!=="")url=url+"\x26keyword\x3d"+keyword;console.info(Constant.BACKEND_BASE+url);return $http.get(Constant.BACKEND_BASE+url)}});
angular.module("IOne-Production").service("EPSInterfaceConfigService",function($http,Constant){this.getAll=function(sizePerPage,page,confirm,status,no,name,keyWord,resUuid){confirm=confirm==0?"":confirm;status=status==0?"":status;var url="/interfaceConfigs?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26confirm\x3d"+confirm+"\x26status\x3d"+status;if(no!==undefined&&no!==null&&no!=="")url=url+"\x26no\x3d"+no;if(name!==undefined&&name!==null&&name!=="")url=url+"\x26name\x3d"+name;if(keyWord!==undefined&&
keyWord!==null&&keyWord!=="")url=url+"\x26keyWord\x3d"+keyWord;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+"/interfaceConfigs/"+uuid)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/interfaceConfigs/"+uuid)};this.modify=function(uuid,UpdateInput){return $http.patch(Constant.BACKEND_BASE+"/interfaceConfigs/"+uuid,UpdateInput)};this.add=function(AddInput){return $http.post(Constant.BACKEND_BASE+
"/interfaceConfigs/",AddInput)}});
angular.module("IOne-Production").service("EPSWxConfigService",function($http,Constant){this.getAll=function(sizePerPage,page,confirm,status,no,name,keyWord,resUuid){confirm=confirm==0?"":confirm;status=status==0?"":status;var url="/weiXinConfigs?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26confirm\x3d"+confirm+"\x26status\x3d"+status;if(no!==undefined&&no!==null&&no!=="")url=url+"\x26no\x3d"+no;if(name!==undefined&&name!==null&&name!=="")url=url+"\x26name\x3d"+name;if(keyWord!==undefined&&keyWord!==
null&&keyWord!=="")url=url+"\x26keyWord\x3d"+keyWord;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+"/weiXinConfigs/"+uuid)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/weiXinConfigs/"+uuid)};this.modify=function(uuid,UpdateInput){UpdateInput.newdate=moment(UpdateInput.newdate).format("YYYY-MM-DD hh:mm:ss");return $http.patch(Constant.BACKEND_BASE+
"/weiXinConfigs/"+uuid,UpdateInput)};this.add=function(AddInput){AddInput.newdate=moment(AddInput.newdate).format("YYYY-MM-DD hh:mm:ss");return $http.post(Constant.BACKEND_BASE+"/weiXinConfigs/",AddInput)}});
angular.module("IOne-Production").service("EpsOrderChangeMaster",function($http,Constant){this.getAll=function(sizePerPage,page,filter){var confirm=filter.select.confirm==0?"":filter.select.confirm;var transferPsoFlag=filter.select.transferPsoFlag==0?"":filter.select.transferPsoFlag;var status=filter.select.status==0?"":filter.select.status;var url="epsOrderChanges?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26onlyLatest\x3d2";if(confirm!=="")url=url+"\x26confirm\x3d"+confirm;if(transferPsoFlag!==
"")url=url+"\x26transferPsoFlag\x3d"+transferPsoFlag;if(status!=="")url=url+"\x26status\x3d"+status;if(filter.no!=null)url=url+"\x26no\x3d"+filter.no;if(filter.select.startOrderDate!=null){var startOrderDate=new Date(filter.select.startOrderDate);startOrderDate=moment(startOrderDate).format("YYYY-MM-DD 00:00:00");url=url+"\x26startOrderDate\x3d"+startOrderDate}if(filter.select.endOrderDate!=null){var endOrderDate=new Date(filter.select.endOrderDate);endOrderDate=moment(endOrderDate).format("YYYY-MM-DD 23:59:59");
url=url+"\x26endOrderDate\x3d"+endOrderDate}if(filter.channelName!=null)url=url+"\x26channelName\x3d"+filter.channelName;if(filter.buyerNick!=null)url=url+"\x26buyerNick\x3d"+filter.buyerNick;return $http.get(Constant.BACKEND_BASE+url)};this.confirm=function(uuids){return $http.patch(Constant.BACKEND_BASE+"/epsOrderChanges/"+uuids+"?toConfirm\x3dtrue",{})};this.cancelConfirm=function(uuids){return $http.patch(Constant.BACKEND_BASE+"/epsOrderChanges/"+uuids+"?toCancelConfirm\x3dtrue",{})};this.transfer=
function(uuid){return $http.post(Constant.BACKEND_BASE+"/epsOrderChanges/"+uuid+"?toERP\x3dtrue",{})};this.modify=function(uuid,orderChangeUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/epsOrderChanges/"+uuid,orderChangeUpdateInput)};this.add=function(orderUuid,OrderChangeInput){return $http.post(Constant.BACKEND_BASE+"/epsOrderChanges?epsOrderUuid\x3d"+orderUuid,OrderChangeInput)}});
angular.module("IOne-Production").service("EpsOrderChangeDetail",function($http,Constant){this.get=function(masterUuid){return $http.get(Constant.BACKEND_BASE+"/epsOrderChanges/"+masterUuid+"/details")};this.modify=function(masterUuid,uuid,orderChangeDetailUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/epsOrderChanges/"+masterUuid+"/details/"+uuid,orderChangeDetailUpdateInput)};this.close=function(masterUuid,uuid){return $http.patch(Constant.BACKEND_BASE+"/epsOrderChanges/"+masterUuid+"/details/"+
uuid+"?toClose\x3dtrue",{})}});angular.module("IOne-Production").service("EpsOrderChangeExtendDetail",function($http,Constant){this.get=function(detailUuid){return $http.get(Constant.BACKEND_BASE+"/espOrderChangeDetails/"+detailUuid+"/extendDetails")}});
angular.module("IOne-Production").service("EpsOrderChangeChannelService",function($http,Constant){this.getAll=function(sizePerPage,page,confirm,status,channelName,channelFlag,resUuid){confirm=confirm==0?"":confirm;status=status==0?"":status;var url="/channels?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26confirm\x3d"+confirm+"\x26status\x3d"+status;if(channelName!==undefined&&channelName!==null)url=url+"\x26name\x3d"+channelName;if(channelFlag!==undefined&&channelFlag!==null)url=url+"\x26channelFlag\x3d"+
channelFlag;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)}});
angular.module("IOne-Production").service("EPSReceipts",function($http,Constant){this.get=function(masterUuid,scope){var url="/epsOrders/"+masterUuid+"/receipts?";if(scope!=null)url=url+"scope\x3d"+scope;return $http.get(Constant.BACKEND_BASE+url)};this.modify=function(masterUuid,detailUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/epsOrders/"+masterUuid+"/receipts/"+detailUpdateInput.uuid,detailUpdateInput)}});
angular.module("IOne-Production").service("EPSMaster",function($http,Constant){this.getAll=function(sizePerPage,page,orderFlag,confirm,status,transferPsoFlag,buyerNick,orderMasterNo,orderDateBegin,orderDateEnd,resUuid,channelUuid){orderFlag=orderFlag==0?"":orderFlag;confirm=confirm==0?"":confirm;status=status==0?"":status;transferPsoFlag=transferPsoFlag==0?"":transferPsoFlag;var url="epsOrders?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26confirm\x3d"+confirm+"\x26status\x3d"+status+"\x26transferPsoFlag\x3d"+
transferPsoFlag;if(orderFlag!==null)url=url+"\x26orderFlag\x3d"+orderFlag;if(buyerNick!==null)url=url+"\x26buyerNick\x3d"+buyerNick;if(orderMasterNo!==null)url=url+"\x26no\x3d"+orderMasterNo;if(orderDateBegin!==null)url=url+"\x26orderDateBegin\x3d"+orderDateBegin;if(orderDateEnd!==null)url=url+"\x26orderDateEnd\x3d"+orderDateEnd;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;if(channelUuid!==null)url=url+"\x26channelUuid\x3d"+channelUuid;return $http.get(Constant.BACKEND_BASE+
url)};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+"/epsOrders/"+uuid)};this.add=function(order){return $http.post(Constant.BACKEND_BASE+"/epsOrders/",order)};this.modify=function(OrderMasterUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/epsOrders/"+OrderMasterUpdateInput.uuid,OrderMasterUpdateInput)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/epsOrders/"+uuid)};this.print=function(type,uuid){return $http.get(Constant.BACKEND_BASE+"/reports",
{params:{type:type,params:uuid}})};this.createDefault=function(){orderDate=new Date;predictDeliverDate=new Date(orderDate.valueOf()+2*24*60*60*1E3);order={"no":"","userId":"","buyerNick":"","receiveName":"","receivePhone":"","receiveAddress":"","receiveDistrict":"","remark":"","orderFlag":"4","orderAmount":"","assembleAmount":"","orderDate":orderDate,"predictDeliverDate":predictDeliverDate,"channel":"","details":"","deliverWay":""};return order}});
angular.module("IOne-Production").service("FAMDiscountCartTypeService",function($http,Constant){this.getAll=function(sizePerPage,page,confirm,status,theMax,resUuid){confirm=confirm==0?"":confirm;status=status==0?"":status;var url="/discountCartTypes?size\x3d"+sizePerPage+"\x26page\x3d"+page;if(theMax!==undefined&&theMax!==null)url=url+"\x26no\x3d"+theMax;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+
"/discountCartTypes/"+uuid)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/discountCartTypes/"+uuid)};this.modify=function(uuid,UpdateInput){return $http.patch(Constant.BACKEND_BASE+"/discountCartTypes/"+uuid,UpdateInput)};this.add=function(Input){return $http.post(Constant.BACKEND_BASE+"/discountCartTypes/",Input)}});
angular.module("IOne-Production").service("FAMIncomePurposeService",function($http,Constant){this.getAll=function(sizePerPage,page,confirm,status,theMax,resUuid){confirm=confirm==0?"":confirm;status=status==0?"":status;var url="/incomePurposes?size\x3d"+sizePerPage+"\x26page\x3d"+page;if(theMax!==undefined&&theMax!==null)url=url+"\x26no\x3d"+theMax;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+
"/incomePurposes/"+uuid)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/incomePurposes/"+uuid)};this.modify=function(uuid,UpdateInput){return $http.patch(Constant.BACKEND_BASE+"/incomePurposes/"+uuid,UpdateInput)};this.add=function(Input){return $http.post(Constant.BACKEND_BASE+"/incomePurposes/",Input)}});
angular.module("IOne-Production").service("FAMBankCardService",function($http,Constant){this.getAll=function(sizePerPage,page,no,name,keyWord,resUuid){var url="/bankCards?size\x3d"+sizePerPage+"\x26page\x3d"+page;if(no!==undefined&&no!==null&&no!=="")url=url+"\x26no\x3d"+no;if(name!==undefined&&name!==null&&name!=="")url=url+"\x26name\x3d"+name;if(keyWord!==undefined&&keyWord!==null&&keyWord!=="")url=url+"\x26keyWord\x3d"+keyWord;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;
return $http.get(Constant.BACKEND_BASE+url)};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+"/bankCards/"+uuid)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/bankCards/"+uuid)};this.modify=function(uuid,UpdateInput){return $http.patch(Constant.BACKEND_BASE+"/bankCards/"+uuid,UpdateInput)};this.add=function(AddInput){return $http.post(Constant.BACKEND_BASE+"/bankCards/",AddInput)}});
angular.module("IOne-Production").service("FAMBankService",function($http,Constant){this.getAll=function(sizePerPage,page,no,name,keyWord,resUuid){var url="/banks?size\x3d"+sizePerPage+"\x26page\x3d"+page;if(no!==undefined&&no!==null&&no!=="")url=url+"\x26no\x3d"+no;if(name!==undefined&&name!==null&&name!=="")url=url+"\x26name\x3d"+name;if(keyWord!==undefined&&keyWord!==null&&keyWord!=="")url=url+"\x26keyWord\x3d"+keyWord;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+
url)};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+"/banks/"+uuid)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/banks/"+uuid)};this.modify=function(uuid,UpdateInput){return $http.patch(Constant.BACKEND_BASE+"/banks/"+uuid,UpdateInput)};this.add=function(AddInput){return $http.post(Constant.BACKEND_BASE+"/banks/",AddInput)}});
angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/auth/func",{controller:"FuncController",templateUrl:"app/src/app/auth/function/function.html"})}]);
angular.module("IOne-Production").controller("FuncController",function($scope,$http,$mdDialog,Constant,FunctionService,GroupFunctionService){$scope.pageOption={sizePerPage:20,currentPage:0,totalPage:0,totalElements:10};$scope.listFilterOption={status:Constant.STATUS[0].value};$scope.$watch("listFilterOption",function(newValue,oldValue){if(newValue.status!=oldValue.status){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshAllEntities()}},
true);$scope.listFilterDisplayOption={showStatusFilterMenu:true,showConfirmFilterMenu:false,showReleaseFilerMenu:false,showProdTypeFilterMenu:false,showStopProdFilterMenu:false};$scope.formMenuDisplayOption={"100-add":{display:true,name:"新增",uuid:""},"101-delete":{display:true,name:"删除",uuid:""},"102-edit":{display:true,name:"编辑",uuid:""},"103-copy":{display:false,name:"复制",uuid:""},"104-status":{display:true,name:"启用",uuid:""},"105-confirm":{display:false,name:"审核",uuid:""},"106-release":{display:false,
name:"发布",uuid:""},"200-cancel":{display:true,name:"取消新增",uuid:""},"201-save":{display:true,name:"保存",uuid:""},"300-add":{display:false,name:"新增节点",uuid:""},"301-delete":{display:false,name:"删除节点",uuid:""},"302-save":{display:true,name:"保存",uuid:""},"303-cancel":{display:true,name:"取消修改",uuid:""},"304-quit":{display:true,name:"退出编辑",uuid:""}};$scope.refreshAllEntities=function(){FunctionService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.status,$scope.searchKeyword).success(function(data){$scope.allEntities=
data;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements})};$scope.listTabSelected=function(){$scope.refreshAllEntities();$scope.selectedItem=null;$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS,0)};$scope.formTabSelected=function(){};$scope.editItem=function(group){$scope.selectedItem=group;$scope.changeViewStatus(Constant.UI_STATUS.PRE_EDIT_UI_STATUS,1);$scope.showFunctionGroups($scope.selectedItem)};$scope.showFunctionGroups=function(func){GroupFunctionService.get(func.uuid).success(function(data){func.funcGroupList=
data})};$scope.exitModifyMenuAction=function(){$scope.changeViewStatus($scope.UI_STATUS.PRE_EDIT_UI_STATUS,1)};$scope.addFunctionGroup=function(){$mdDialog.show({controller:"GroupListController",templateUrl:"app/src/app/auth/function/addGroupDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{}}).then(function(data){GroupFunctionService.add($scope.selectedItem.uuid,data.selectedGroup.uuid).success(function(data){$scope.selectedItem.funcGroupList=$scope.selectedItem.funcGroupList||
[];$scope.selectedItem.funcGroupList.push(data)}).error(function(){$scope.showError("新增角色失败，该角色可能已存在。")})})};$scope.deleteFunctionGroup=function(functionGroup){GroupFunctionService.delete(functionGroup.uuid).success(function(){$scope.selectedItem.funcGroupList.splice($scope.selectedItem.funcGroupList.indexOf(functionGroup),1)})};$scope.preAddMenuAction=function(){$scope.selectedItem={};$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_ADD,1)};$scope.addMenuAction=function(){FunctionService.add($scope.selectedItem).success(function(data){$scope.selectedItem=
data;$scope.allEntities.content.push(data);$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_MODIFY,1);$scope.showInfo("新增角色信息成功。")}).error(function(){$scope.showError("新增角色信息失败, 该角色可能已存在。")})};$scope.modifyMenuAction=function(){FunctionService.modify($scope.selectedItem).success(function(data){$scope.showInfo("修改角色信息成功。")}).error(function(){$scope.showError("修改角色信息失败。")})};$scope.cancelModifyMenuAction=function(){FunctionService.get($scope.selectedItem.uuid).success(function(data){$scope.selectedItem=
data;$scope.showFunctionGroups($scope.selectedItem)})};$scope.cancelAddMenuAction=function(){$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_DELETE,0)};$scope.deleteMenuAction=function(){$scope.showConfirm("确认删除吗？","删除的职能不可恢复。",function(){FunctionService.delete($scope.selectedItem.uuid).success(function(data){$scope.showInfo("删除职能信息成功。");$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_DELETE,0)}).error(function(){$scope.showError("删除职能信息失败。")})})};$scope.$watchCollection("selectedItem.status",
function(){if($scope.selectedItem)if($scope.selectedItem.status=="1")$scope.formMenuDisplayOption["104-status"].name="禁用";else if($scope.selectedItem.status=="2")$scope.formMenuDisplayOption["104-status"].name="启用"});$scope.statusMenuAction=function(){if($scope.selectedItem.status=="1")$scope.selectedItem.status="2";else $scope.selectedItem.status="1";$scope.modifyMenuAction()}});
angular.module("IOne-Production").controller("GroupListController",function($scope,$mdDialog,GroupService){GroupService.getAll(1E4,0).success(function(data){$scope.allGroups=data.content});$scope.selectedGroup={uuid:""};$scope.hideDlg=function(){$mdDialog.hide({"selectedGroup":$scope.selectedGroup})};$scope.cancelDlg=function(){$mdDialog.cancel()}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/auth/group",{controller:"GroupController",templateUrl:"app/src/app/auth/group/group.html"})}]);
angular.module("IOne-Production").controller("GroupController",function($scope,$http,$mdDialog,Constant,GroupService){$scope.pageOption={sizePerPage:20,currentPage:0,totalPage:0,totalElements:10};$scope.listFilterOption={status:Constant.STATUS[0].value};$scope.$watch("listFilterOption",function(newValue,oldValue){if(newValue.status!=oldValue.status){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshAllEntities()}},true);$scope.listFilterDisplayOption=
{showStatusFilterMenu:true,showConfirmFilterMenu:false,showReleaseFilerMenu:false,showProdTypeFilterMenu:false,showStopProdFilterMenu:false};$scope.formMenuDisplayOption={"100-add":{display:true,name:"新增",uuid:""},"101-delete":{display:true,name:"删除",uuid:""},"102-edit":{display:true,name:"编辑",uuid:""},"103-copy":{display:false,name:"复制",uuid:""},"104-status":{display:true,name:"启用",uuid:""},"105-confirm":{display:false,name:"审核",uuid:""},"106-release":{display:false,name:"发布",uuid:""},"200-cancel":{display:true,
name:"取消新增",uuid:""},"201-save":{display:true,name:"保存",uuid:""},"300-add":{display:false,name:"新增节点",uuid:""},"301-delete":{display:false,name:"删除节点",uuid:""},"302-save":{display:true,name:"保存",uuid:""},"303-cancel":{display:true,name:"取消修改",uuid:""},"304-quit":{display:true,name:"退出编辑",uuid:""}};$scope.refreshAllEntities=function(){GroupService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.status,$scope.searchKeyword).success(function(data){$scope.allEntities=
data;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements})};$scope.listTabSelected=function(){$scope.refreshAllEntities();$scope.selectedItem=null;$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS,0)};$scope.formTabSelected=function(){};$scope.editItem=function(group){$scope.selectedItem=group;$scope.changeViewStatus(Constant.UI_STATUS.PRE_EDIT_UI_STATUS,1)};$scope.exitModifyMenuAction=function(){$scope.changeViewStatus($scope.UI_STATUS.PRE_EDIT_UI_STATUS,
1)};$scope.preAddMenuAction=function(){$scope.selectedItem={};$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_ADD,1)};$scope.addMenuAction=function(){GroupService.add($scope.selectedItem).success(function(data){$scope.selectedItem=data;$scope.allEntities.content.push(data);$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_MODIFY,1);$scope.showInfo("新增群组信息成功。")}).error(function(){$scope.showError("新增群组信息失败, 该群组可能已存在。")})};$scope.modifyMenuAction=function(){GroupService.modify($scope.selectedItem).success(function(data){$scope.showInfo("修改群组信息成功。")}).error(function(){$scope.showError("修改群组信息失败。")})};
$scope.cancelModifyMenuAction=function(){GroupService.get($scope.selectedItem.uuid).success(function(data){$scope.selectedItem=data})};$scope.cancelAddMenuAction=function(){$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_DELETE,0)};$scope.deleteMenuAction=function(){$scope.showConfirm("确认删除吗？","删除的群组不可恢复。",function(){GroupService.delete($scope.selectedItem.uuid).success(function(data){$scope.showInfo("删除群组信息成功。");$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_DELETE,0)}).error(function(){$scope.showError("删除群组信息失败。")})})};
$scope.$watchCollection("selectedItem.status",function(){if($scope.selectedItem)if($scope.selectedItem.status=="1")$scope.formMenuDisplayOption["104-status"].name="禁用";else if($scope.selectedItem.status=="2")$scope.formMenuDisplayOption["104-status"].name="启用"});$scope.statusMenuAction=function(){if($scope.selectedItem.status=="1")$scope.selectedItem.status="2";else $scope.selectedItem.status="1";$scope.modifyMenuAction()}});
angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/fam/incomePurpose",{controller:"IncomePurposeController",templateUrl:"app/src/app/fam/income_purpose/incomePurpose.html"})}]);
angular.module("IOne-Production").controller("IncomePurposeController",function($scope,$q,FAMIncomePurposeService,$mdDialog,Constant){$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value,release:Constant.RELEASE[0].value};$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.menuDisplayOption={"405-delete":{display:true,name:"删除",uuid:"83DF5B02-493C-4AF2-9732-353B35F5053D"},
"406-query":{display:true,name:"查询",uuid:"58BC1519-04B0-4989-BE80-7DDC1D12A7E8"},"415-deleteAll":{display:true,name:"批量删除",uuid:"C700095C-E0FC-440C-91E5-1359E60BFD13"}};$scope.refreshList=function(){FAMIncomePurposeService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.confirm,$scope.listFilterOption.status,$scope.theMax,$scope.RES_UUID_MAP.CBI.EMPL.RES_UUID).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;
$scope.pageOption.totalElements=data.totalElements;$scope.resetButtonDisabled();$scope.selectAllFlag=false})};$scope.getMenuAuthData($scope.RES_UUID_MAP.CBI.INCOME_PURPOSE.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)});$scope.$watch("listFilterOption",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=
0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()}};$scope.selectAllFlag=false;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;item.detailList=$scope.subItemList;$scope.changeButtonStatusSingle(item)};$scope.returnToListAction=function(event,item){$scope.stopEventPropagation(event);$scope.selectedItem=null;$scope.changeButtonStatusAll()};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;
$scope.selectedItem=null};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel)item.detailList=item};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);$scope.refreshList()};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=
desc;$scope.source=source;$scope.domain=domain;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.source.confirm=="2"&&$scope.source.status=="2"){$scope.showError("不允许状态是已审核又无效,请调整后再保存");return}if($scope.status=="add"){if($scope.domain=="FAM_BASE_INCOME_PURPOSE")FAMIncomePurposeService.add($scope.source).success(function(data){$scope.showInfo("新增数据成功。")}).error(function(data){$scope.showError("新增失败:"+
"\x3cbr\x3e"+data.message)})}else if($scope.status=="edit")if($scope.domain=="FAM_BASE_INCOME_PURPOSE")FAMIncomePurposeService.modify($scope.source.uuid,$scope.source).success(function(data){$scope.showInfo("修改数据成功。");$scope.source=data;$scope.selectedItem=data;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)}).error(function(data){$scope.showError("修改失败:"+"\x3cbr\x3e"+data.message);$scope.source=angular.copy($scope.selectedItemBackUp);$scope.selectedItem=angular.copy($scope.selectedItemBackUp)})};
$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){FAMIncomePurposeService.delete(item.uuid).success(function(){$scope.selectedItem=null;$scope.refreshList();$scope.showInfo("删除数据成功。")})})};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selected.length>0)$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(item){var response=
FAMIncomePurposeService.delete(item.uuid).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("删除数据成功。");$scope.refreshList()})}})};$scope.selectAllAction=function(){if($scope.selectAllFlag==true)angular.forEach($scope.itemList,function(item){var idx=$scope.selected.indexOf(item);if(idx<0)$scope.selected.push(item)});else if($scope.selectAllFlag==false)$scope.selected=[];$scope.selectItemCount=$scope.selected.length;$scope.changeButtonStatusAll()};
$scope.selectItemAction=function(event,item,selected){$scope.stopEventPropagation(event);var idx=selected.indexOf(item);if(idx>-1)selected.splice(idx,1);else selected.push(item);$scope.selectItemCount=$scope.selected.length;$scope.changeButtonStatusAll()};$scope.exists=function(item,selected){return selected.indexOf(item)>-1};$scope.selected=[];$scope.resetButtonDisabled=function(){$scope.deleteAllClickActionStatus=0;$scope.deleteClickActionStatus=0};$scope.changeButtonStatusAll=function(){$scope.resetButtonDisabled();
angular.forEach($scope.selected,function(incomePurpose){$scope.changeButtonStatus(incomePurpose)})};$scope.changeButtonStatusSingle=function(incomePurpose){$scope.resetButtonDisabled();$scope.changeButtonStatus(incomePurpose)};$scope.changeButtonStatus=function(discountCartType){if(discountCartType.confirm==2||discountCartType.item==3);}});
angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/eps/interface_config",{controller:"EPSInterfaceConfigController",templateUrl:"app/src/app/taobao_data/interface_config/interfaceConfig.html"})}]);
angular.module("IOne-Production").controller("EPSInterfaceConfigController",function($scope,EPSInterfaceConfigService,Constant,$mdDialog,$q){$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={select:{status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value},no:"",name:"",keyWord:""};$scope.menuDisplayOption={"switchConfirm":{display:true,name:"审核/取消审核",uuid:"A80BE209-A07E-40B9-AD8C-46187F222FB7"},"switchStatus":{display:true,name:"启用/禁用",
uuid:"BCAF039D-986D-4F76-A30E-673758E0DBEA"},"batchConfirm":{display:true,name:"批量审核",uuid:"7E2FA306-EE27-47F2-A515-5BE82945C59D"},"batchRevertConfirm":{display:true,name:"批量取审",uuid:"FF5B0A5B-9941-4CD6-9DDE-AB409C73A0AE"},"batchStatus":{display:true,name:"批量启用",uuid:"EAB309B1-905E-419F-A91F-21E4239821F4"},"batchRevertStatus":{display:true,name:"批量禁用",uuid:"8A9D6D84-EB71-4701-92F7-6C5EE4832AFA"},"batchDelete":{display:true,name:"批量删除",uuid:"D44F7536-A58A-46C4-A0D0-11EFB1F01EEB"},"detailConfirm":{display:true,
name:"审核",uuid:"8EC2932A-B8D1-4B5E-B743-F06D46263104"},"detailRevertConfirm":{display:true,name:"取审",uuid:"B08C5D94-AAF9-443D-B560-55AD95410AA6"},"detailStatus":{display:true,name:"启用",uuid:"3D62CE5E-DF9D-4AD0-ACF4-9A1802999E7B"},"detailRevertStatus":{display:true,name:"禁用",uuid:"55886AC8-6609-4483-AAD4-F3D63860109F"},"detailDelete":{display:true,name:"删除",uuid:"0362DD0E-8804-49FE-89A8-950F6E6F0CF7"}};$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchStatus=
true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true;$scope.sortByField="no";$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.refreshList=function(){EPSInterfaceConfigService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.select.confirm,$scope.listFilterOption.select.status,$scope.listFilterOption.no,$scope.listFilterOption.name,$scope.listFilterOption.keyWord,$scope.RES_UUID_MAP.EPS.INTERFACE_CONFIG.RES_UUID).success(function(data){$scope.itemList=
data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;$scope.selectAllFlag=false;$scope.selectedItemSize=0})};$scope.getMenuAuthData($scope.RES_UUID_MAP.EPS.INTERFACE_CONFIG.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)});$scope.$watch("listFilterOption.select",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.queryEnter=
function(e){if(e.keyCode===13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()}};$scope.selectAllFlag=false;$scope.selectedItemSize=0;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;item.detailList=$scope.subItemList;$scope.displayAdvancedSearPanel=false};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;$scope.selectedItem=null};$scope.toggleMorePanelAction=
function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel)item.detailList=item};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);$scope.refreshList()};$scope.hideItemDetailsAction=function(event){$scope.stopEventPropagation(event);$scope.selectedItem=null;$scope.refreshList()};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);
$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.source.confirm=="2"&&$scope.source.status=="2"){$scope.showError("不允许状态是已审核又无效,请调整后再保存");return}if($scope.status=="add"){if($scope.domain==
"EPS_BASE_INTERFACE_CONF")EPSInterfaceConfigService.add($scope.source).success(function(data){$scope.showInfo("新增数据成功。")}).error(function(data){$scope.showError("新增失败:"+"\x3cbr\x3e"+data.message)})}else if($scope.status=="edit")if($scope.domain=="EPS_BASE_INTERFACE_CONF")EPSInterfaceConfigService.modify($scope.source.uuid,$scope.source).success(function(data){$scope.showInfo("修改数据成功。");$scope.source=data;$scope.selectedItem=data;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)}).error(function(data){$scope.showError("修改失败:"+
"\x3cbr\x3e"+data.message);$scope.source=angular.copy($scope.selectedItemBackUp);$scope.selectedItem=angular.copy($scope.selectedItemBackUp)})};$scope.deleteDetailAction=function(detail){};$scope.selectItemAction=function(event,item){$scope.stopEventPropagation(event);item.selectedRef=!item.selected;if(item.selected==false||item.selected==undefined||item.selected==null)$scope.selectedItemSize+=1;else{$scope.selectedItemSize-=1;$scope.selectAllFlag=false}$scope.disableBatchMenuButtons()};$scope.confirmClickAction=
function(event,item){$scope.stopEventPropagation(event);if(item.confirm==Constant.CONFIRM[2].value)$scope.showConfirm("确认取消审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};EPSInterfaceConfigService.modify(item.uuid,UpdateInput).success(function(){item.confirm=Constant.CONFIRM[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("取消审核成功！")}).error(function(response){$scope.showError(response.message)})});else $scope.showConfirm("确认审核吗？","",function(){var UpdateInput=
{uuid:item.uuid,confirm:Constant.CONFIRM[2].value};EPSInterfaceConfigService.modify(item.uuid,UpdateInput).success(function(){item.confirm=Constant.CONFIRM[2].value;$scope.disableBatchMenuButtons();$scope.showInfo("审核成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.confirmSwitchAction=function(event,item){$scope.stopEventPropagation(event);if(item.confirm==Constant.CONFIRM[2].value)$scope.showConfirm("确认取消审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};
EPSInterfaceConfigService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("修改数据成功。")})},function(){item.confirm=Constant.CONFIRM[2].value});else{if(item.status==Constant.STATUS[2].value){$scope.showWarn("项目是失效状态,请先启用后再审核");item.confirm=Constant.CONFIRM[2].value;return}$scope.showConfirm("确认审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};EPSInterfaceConfigService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();
$scope.showInfo("修改数据成功。")})},function(){item.confirm=Constant.CONFIRM[1].value})}};$scope.statusClickAction=function(event,item){$scope.stopEventPropagation(event);if(item.status==Constant.STATUS[1].value)$scope.showConfirm("确认改为失效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value,confirm:Constant.CONFIRM[1].value};EPSInterfaceConfigService.modify(item.uuid,UpdateInput).success(function(){item.status=Constant.STATUS[2].value;item.confirm=Constant.CONFIRM[1].value;$scope.disableBatchMenuButtons();
$scope.showInfo("修改为失效成功！")}).error(function(response){$scope.showError(response.message)})});else $scope.showConfirm("确认改为生效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};EPSInterfaceConfigService.modify(item.uuid,UpdateInput).success(function(){item.status=Constant.STATUS[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("修改为生效成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.statusSwitchAction=function(event,item){$scope.stopEventPropagation(event);
if(item.status==Constant.STATUS[2].value)$scope.showConfirm("确认修改启用状态为有效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};EPSInterfaceConfigService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("修改数据成功。")})},function(){item.status=Constant.STATUS[2].value});else $scope.showConfirm("确认修改启用状态为无效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value,confirm:Constant.CONFIRM[1].value};
EPSInterfaceConfigService.modify(UpdateInput.uuid,UpdateInput).success(function(){item.confirm=Constant.CONFIRM[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("修改数据成功。")})},function(){item.status=Constant.STATUS[1].value})};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);if(item.status!="1"||item.confirm!="1"){$scope.showWarn("仅当电商平台接口配置的状态是有效且未审核时才允许删除!");return}$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){EPSInterfaceConfigService.delete(item.uuid).success(function(){$scope.selectedItem=
null;$scope.refreshList();$scope.showInfo("删除数据成功。")})})};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var noDeleteNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.status=="1"&&item.confirm=="1"){var response=EPSInterfaceConfigService.delete(item.uuid).success(function(){});promises.push(response);count++}else noDeleteNos=noDeleteNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任何状态是有效且未审核的可删除项目，请选择！");
return}$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){if(noDeleteNos!=="")$scope.showWarn("以下状态是失效或已审核的的项目将不会删除："+"\x3cbr\x3e"+noDeleteNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("删除成功！")},function(data){$scope.showError(data.message);$scope.showError(data.data.message)})})};$scope.confirmAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var confirmedNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===
true)if(item.confirm!=Constant.CONFIRM[2].value){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};var response=EPSInterfaceConfigService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else confirmedNos=confirmedNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任何未审核的项目，请先选择！");return}if(confirmedNos!=="")$scope.showWarn("以下已审核过的项目将不再次审核："+"\x3cbr\x3e"+confirmedNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.disableBatchMenuButtons();
$scope.showInfo("审核成功！")},function(data){$scope.showError(data.message);$scope.showError(data.data.message)})};$scope.revertConfirmAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var unConfirmedNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.confirm==Constant.CONFIRM[2].value){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};var response=EPSInterfaceConfigService.modify(item.uuid,UpdateInput).success(function(){});
promises.push(response);count++}else unConfirmedNos=unConfirmedNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任已审核的项目，请先选择！");return}if(unConfirmedNos!=="")$scope.showWarn("以下未审核过的项目将不执行取消审核："+unConfirmedNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("取消审核成功！")},function(data){$scope.showError(data.data.message);$scope.showError(data.message)})};$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var effectiveNos=
"";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.status!=Constant.STATUS[1].value){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};var response=EPSInterfaceConfigService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else effectiveNos=effectiveNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任何失效的项目，请先选择！");return}if(effectiveNos!=="")$scope.showWarn("以下已生效的项目将不再次修改："+"\x3cbr\x3e"+effectiveNos);
$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("生效成功！")},function(data){$scope.showError(data.message);$scope.showError(data.data.message)})};$scope.revertStatusAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var uneffectiveNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.status==Constant.STATUS[1].value){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value};var response=EPSInterfaceConfigService.modify(item.uuid,
UpdateInput).success(function(){});promises.push(response);count++}else uneffectiveNos=uneffectiveNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择生效的项目，请先选择！");return}if(uneffectiveNos!=="")$scope.showWarn("以下失效的项目将不再次修改："+uneffectiveNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("失效成功！")},function(data){$scope.showError(data.data.message);$scope.showError(data.message)})};$scope.selectAllAction=function(){angular.forEach($scope.itemList,function(item){if($scope.selectAllFlag)item.selected=
true;else item.selected=false;item.selectedRef=item.selected});$scope.selectedItemSize=0;$scope.selectedItemAmount=0;if($scope.selectAllFlag)angular.forEach($scope.itemList,function(){$scope.selectedItemSize++});$scope.disableBatchMenuButtons()};$scope.disableBatchMenuButtons=function(){var selectedCount=0;var confirm="";var status="";var diffConfirm=false;var diffStatus=false;angular.forEach($scope.itemList,function(item,index){if(item.selectedRef){selectedCount++;if(confirm=="")confirm=item.confirm;
else if(confirm!=item.confirm)diffConfirm=true;if(status=="")status=item.status;else if(status!=item.status)diffStatus=true}});if(selectedCount==0){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}else{if(diffConfirm==true){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchDelete=true}else if(confirm=="2"){$scope.disabledBatchConfirm=
true;$scope.disabledBatchCancelConfirm=false;$scope.disabledBatchDelete=true}else{$scope.disabledBatchConfirm=false;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchDelete=false}if(diffStatus==true){$scope.disabledBatchConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}else if(status=="1"){$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=false}else{$scope.disabledBatchConfirm=true;$scope.disabledBatchStatus=
false;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}}}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/cbi/itemCustom",{controller:"ItemCustomController",templateUrl:"app/src/app/cbi/item_custom/itemCustom.html"})}]);
angular.module("IOne-Production").controller("ItemCustomController",function($scope,$q,CBIItemCustomService,$mdDialog,Constant,Upload,$timeout){$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value,release:Constant.RELEASE[0].value};$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.menuDisplayOption={"401-confirm":{display:true,name:"审核",uuid:"1ED5003F-48BD-4CAA-AE75-7F3FAE4797D5"},
"402-confirmRevert":{display:true,name:"取消审核",uuid:"AD238D32-15F1-4E90-B8BB-719C825E53E4"},"403-status":{display:true,name:"启用",uuid:"1C233EAA-47F1-4AA4-9FAB-E79F32C2378F"},"404-statusRevert":{display:true,name:"取消启用",uuid:"CEF02FD7-18D9-47AA-B9B7-BF43D666BAC3"},"405-delete":{display:true,name:"删除",uuid:"8D813249-7229-47F9-8019-DE1F2E9A5580"},"406-query":{display:true,name:"查询",uuid:"D4D582D6-9CA7-4124-9C4D-061ACCE5526E"},"411-confirmAll":{display:true,name:"批量审核",uuid:"5D4A14A0-E569-4A19-A76D-1B85F38664A8"},
"412-confirmRevertAll":{display:true,name:"批量取消审核",uuid:"E69AE9C4-24BD-4F90-8DD7-3ACFD112724F"},"413-statusAll":{display:true,name:"批量启用",uuid:"A3F492E3-954F-4987-A225-9A0EEC60590F"},"414-statusRevertAll":{display:true,name:"批量取消启用",uuid:"2157D57F-04FE-4F43-ADAB-85D7B7DD5DF6"},"415-deleteAll":{display:true,name:"批量删除",uuid:"51DA79C7-2ED7-40C1-9CAF-42069B75E8A8"}};$scope.refreshList=function(){CBIItemCustomService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.confirm,
$scope.listFilterOption.status,$scope.theMax,$scope.RES_UUID_MAP.CBI.ITEM_CUSTOM_SCOPE.RES_UUID).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;$scope.resetButtonDisabled();$scope.selectAllFlag=false;$scope.selected=[]})};$scope.getMenuAuthData($scope.RES_UUID_MAP.CBI.EMPL.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)});$scope.$watch("listFilterOption",function(){$scope.pageOption.currentPage=
0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()}};$scope.selectAllFlag=false;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;item.detailList=$scope.subItemList;$scope.changeButtonStatusSingle(item)};$scope.returnToListAction=function(event,item){$scope.stopEventPropagation(event);
$scope.selectedItem=null;$scope.refreshList();$scope.changeButtonStatusAll()};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;$scope.selectedItem=null};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel)item.detailList=item};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS)};
$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.source.confirm==
"2"&&$scope.source.status=="2"){$scope.showError("不允许状态是已审核又无效,请调整后再保存");return}if($scope.status=="add"){if($scope.domain=="PLM_BASE_CUSTOM_FILE")CBIItemCustomService.add($scope.source).success(function(data){$scope.showInfo("新增数据成功。")}).error(function(){$scope.showError("新增失败。")})}else if($scope.status=="edit")if($scope.domain=="PLM_BASE_CUSTOM_FILE")CBIItemCustomService.modify($scope.source.uuid,$scope.source).success(function(data){$scope.showInfo("修改数据成功。");$scope.source=data;$scope.selectedItem=
data;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)}).error(function(data){$scope.showError("修改失败:"+"\x3cbr\x3e"+data.message);$scope.source=angular.copy($scope.selectedItemBackUp);$scope.selectedItem=angular.copy($scope.selectedItemBackUp)})};$scope.confirmClickAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认审核吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};CBIItemCustomService.modify(EmployeeUpdateInput.uuid,
EmployeeUpdateInput).success(function(){$scope.selectedItem.confirm=Constant.CONFIRM[2].value;$scope.changeButtonStatusSingle($scope.selectedItem);$scope.showInfo("修改数据成功。")})})};$scope.confirmRevertClickAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认取消审核吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};CBIItemCustomService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.selectedItem.confirm=
Constant.CONFIRM[1].value;$scope.changeButtonStatusSingle($scope.selectedItem);$scope.showInfo("修改数据成功。")})})};$scope.confirmSwitchAction=function(event,item){$scope.stopEventPropagation(event);if(item.confirm==2)$scope.showConfirm("确认取消审核吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};CBIItemCustomService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.changeButtonStatusAll();$scope.showInfo("修改数据成功。")})},function(){item.confirm=
Constant.CONFIRM[2].value});else if(item.confirm==1)$scope.showConfirm("确认审核吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};CBIItemCustomService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.changeButtonStatusAll();$scope.showInfo("修改数据成功。")})},function(){item.confirm=Constant.CONFIRM[1].value})};$scope.statusClickAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认修改启用状态为有效吗？","",function(){var EmployeeUpdateInput=
{uuid:item.uuid,status:Constant.STATUS[1].value};CBIItemCustomService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.selectedItem.status=Constant.STATUS[1].value;$scope.changeButtonStatusSingle($scope.selectedItem);$scope.showInfo("修改数据成功。")})})};$scope.statusRevertClickAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认修改启用状态为无效吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value};CBIItemCustomService.modify(EmployeeUpdateInput.uuid,
EmployeeUpdateInput).success(function(){$scope.selectedItem.status=Constant.STATUS[2].value;$scope.changeButtonStatusSingle($scope.selectedItem);$scope.showInfo("修改数据成功。")})})};$scope.statusSwithAction=function(event,item){$scope.stopEventPropagation(event);if(item.status==2)$scope.showConfirm("确认修改启用状态为有效吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};CBIItemCustomService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.changeButtonStatusAll();
$scope.showInfo("修改数据成功。")})},function(){item.status=Constant.STATUS[2].value});else if(item.status==1)$scope.showConfirm("确认修改启用状态为无效吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value};CBIItemCustomService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.changeButtonStatusAll();$scope.showInfo("修改数据成功。")})},function(){item.status=Constant.STATUS[1].value})};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);
$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){CBIItemCustomService.delete(item.uuid).success(function(){$scope.selectedItem=null;$scope.refreshList();$scope.showInfo("删除数据成功。")})})};$scope.confirmAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selected.length>0)$scope.showConfirm("确认批量审核吗？","",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(item){var EmployeeUpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};var response=
CBIItemCustomService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.refreshList()})}})};$scope.confirmRevertAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selected.length>0)$scope.showConfirm("确认批量取消审核吗？","",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(item){var EmployeeUpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};
var response=CBIItemCustomService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.refreshList()})}})};$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selected.length>0)$scope.showConfirm("确认批量修改启用状态为有效吗？","",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(item){var EmployeeUpdateInput={uuid:item.uuid,
status:Constant.STATUS[1].value};var response=CBIItemCustomService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.refreshList()})}})};$scope.statusRevertAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selected.length>0)$scope.showConfirm("确认批量修改启用状态为无效吗？","",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(item){var EmployeeUpdateInput=
{uuid:item.uuid,status:Constant.STATUS[2].value};var response=CBIItemCustomService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.refreshList()})}})};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selected.length>0)$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(item){var response=
CBIItemCustomService.delete(item.uuid).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("删除数据成功。");$scope.refreshList()})}})};$scope.selectAllAction=function(){if($scope.selectAllFlag==true)angular.forEach($scope.itemList,function(item){var idx=$scope.selected.indexOf(item);if(idx<0)$scope.selected.push(item)});else if($scope.selectAllFlag==false)$scope.selected=[];$scope.selectItemCount=$scope.selected.length;$scope.changeButtonStatusAll()};$scope.selectItemAction=
function(event,item,selected){$scope.stopEventPropagation(event);var idx=selected.indexOf(item);if(idx>-1)selected.splice(idx,1);else selected.push(item);$scope.selectItemCount=$scope.selected.length;$scope.changeButtonStatusAll()};$scope.exists=function(item,selected){return selected.indexOf(item)>-1};$scope.selected=[];$scope.resetButtonDisabled=function(){$scope.confirmClick=0;$scope.confirmRevertClick=0;$scope.statusClick=0;$scope.statusRevertClick=0;$scope.deleteClick=0};$scope.resetButtonDisabledAll=
function(){$scope.deleteAllClick=0;$scope.statusRevertAllClick=0;$scope.statusAllClick=0;$scope.confirmRevertAllClick=0;$scope.confirmAllClick=0};$scope.changeButtonStatusAll=function(){$scope.resetButtonDisabledAll();angular.forEach($scope.selected,function(employee){$scope.processChangeButtonStatusAll(employee)})};$scope.changeButtonStatusSingle=function(employee){$scope.resetButtonDisabled();$scope.processChangeButtonStatus(employee)};$scope.processChangeButtonStatus=function(employee){if(employee.confirm==
1||employee.item==4)$scope.confirmRevertClick=1;if(employee.confirm==2||employee.item==3){$scope.confirmClick=1;$scope.statusRevertClick=1;$scope.deleteClick=1}if(employee.status==1)$scope.statusClick=1;if(employee.status==2){$scope.statusRevertClick=1;$scope.confirmClick=1;$scope.deleteClick=1}};$scope.processChangeButtonStatusAll=function(employee){if(employee.confirm==1||employee.confirm==4)$scope.confirmRevertAllClick=1;if(employee.confirm==2||employee.confirm==3){$scope.confirmAllClick=1;$scope.deleteAllClick=
1;$scope.statusRevertAllClick=1}if(employee.status==1)$scope.statusAllClick=1;if(employee.status==2){$scope.statusRevertAllClick=1;$scope.confirmAllClick=1;$scope.deleteAllClick=1}};$scope.showUserRoles=function(user){if(user.baseUser==undefined)UserService.getUser(user.uuid,3).success(function(data){user.baseUser=data.content[0];UserRoleService.get(user.baseUser.uuid).success(function(data){user.userRoleList=data})})};$scope.addUserRole=function(){$mdDialog.show({controller:"RoleListController",
templateUrl:"app/src/app/auth/user/addRoleDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{}}).then(function(data){UserRoleService.add($scope.selectedItem.user.uuid,data.selectedRole.uuid).success(function(data){$scope.selectedItem.user.userRoleList=$scope.selectedItem.user.userRoleList||[];$scope.selectedItem.user.userRoleList.push(data)}).error(function(){$scope.showError("新增角色失败，该角色可能已存在。")})})};$scope.deleteUserRole=function(userRole){UserRoleService.delete(userRole.uuid).success(function(){$scope.selectedItem.user.userRoleList.splice($scope.selectedItem.user.userRoleList.indexOf(userRole),
1)})};$scope.getEmployeeImageFullPath=function(path,sex){if(path==null||path==undefined)if(sex==1)return Constant.BACKEND_BASE+"/app/img/male.png";else if(sex==2)return Constant.BACKEND_BASE+"/app/img/female.png";else return Constant.BACKEND_BASE+"/app/img/unknown.png";if(path&&path.indexOf("IMAGE")==0)return Constant.BACKEND_BASE+"/app/assets/"+path;else return Constant.BACKEND_BASE+"/app/assets/IMAGE/"+path};$scope.uploadImage=function(files){$scope.progress={value:0};if(files&&files.length)for(var i=
0;i<files.length;i++){var file=files[i];Upload.upload({url:Constant.BACKEND_BASE+"/files",fields:{},file:file}).progress(function(evt){$scope.progress.value=Math.min(100,parseInt(99*evt.loaded/evt.total))}).success(function(data){$timeout(function(){if($scope.selectedItem&&$scope.selectedItem.uuid)CBIItemCustomService.addImage($scope.selectedItem.uuid,data.uuid).success(function(response){$scope.showInfo("上传成功");$scope.selectedItem.employeeImg=$scope.getEmployeeImageFullPath(response.picPath,response.sex)+
"?time\x3d"+(new Date).getTime()})})})}}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/cbi/itemCustomScope",{controller:"ItemCustomScopeController",templateUrl:"app/src/app/cbi/item_custom_scope/itemCustomScope.html"})}]);
angular.module("IOne-Production").controller("ItemCustomScopeController",function($scope,$q,CBIItemCustomScopeService,$mdDialog,Constant,Upload,$timeout){$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value,release:Constant.RELEASE[0].value};$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.menuDisplayOption={"401-confirm":{display:true,name:"审核",
uuid:"D914679D-8FCB-40A0-875F-BF5FE52D55E9"},"402-confirmRevert":{display:true,name:"取消审核",uuid:"890FCE84-0537-42B6-8EE7-1B351C2BE8AD"},"403-status":{display:true,name:"启用",uuid:"10BBAA04-FFD8-48AF-96E7-C8CBCA20B569"},"404-statusRevert":{display:true,name:"取消启用",uuid:"FAE72E22-9377-4F2D-B0EF-95CE84F5D4C8"},"405-delete":{display:true,name:"删除",uuid:"647287DC-B213-4F6F-9A3D-AA95E9B94002"},"406-query":{display:true,name:"查询",uuid:"BE725A75-33FD-4D29-928F-89ECF7250215"},"411-confirmAll":{display:true,
name:"批量审核",uuid:"66AB30B3-9FFC-440F-883A-8FE1ADE69163"},"412-confirmRevertAll":{display:true,name:"批量取消审核",uuid:"D870B2FA-00BA-4850-A1E1-88C6C8E2D02C"},"413-statusAll":{display:true,name:"批量启用",uuid:"7521E7E6-CB1A-4352-BF43-B050BB8C9F2F"},"414-statusRevertAll":{display:true,name:"批量取消启用",uuid:"00513382-E7C3-47D7-ACA2-0F4A29F6713A"},"415-deleteAll":{display:true,name:"批量删除",uuid:"517ED2DA-1F21-47F4-B095-C7DFE5EA396D"}};$scope.refreshList=function(){CBIItemCustomScopeService.getAll("null",$scope.pageOption.sizePerPage,
$scope.pageOption.currentPage,$scope.listFilterOption.confirm,$scope.listFilterOption.status,$scope.theMax,$scope.RES_UUID_MAP.CBI.ITEM_CUSTOM_SCOPE.RES_UUID).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;$scope.resetButtonDisabled();$scope.selectAllFlag=false;$scope.selected=[]})};$scope.getMenuAuthData($scope.RES_UUID_MAP.CBI.EMPL.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)});
$scope.$watch("listFilterOption",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()}};$scope.selectAllFlag=false;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;item.detailList=$scope.subItemList;$scope.changeButtonStatusSingle(item)};
$scope.returnToListAction=function(event,item){$scope.stopEventPropagation(event);$scope.selectedItem=null;$scope.changeButtonStatusAll()};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;$scope.selectedItem=null};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel)item.detailList=item};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=
function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);$scope.refreshList()};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=desc;$scope.source=
source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.status=="add"){if($scope.domain=="PLM_BASE_CUSTOM_SCOPE")CBIItemCustomScopeService.add($scope.source.itemCustom.uuid,$scope.source).success(function(data){$scope.showInfo("新增数据成功。")}).error(function(){$scope.showError("新增失败。")})}else if($scope.status=="edit")if($scope.domain=="PLM_BASE_CUSTOM_SCOPE")CBIItemCustomScopeService.modify($scope.source.itemCustom.uuid,$scope.source.uuid,$scope.source).success(function(data){$scope.showInfo("修改数据成功。");
$scope.source=data;$scope.selectedItem=data;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)}).error(function(data){$scope.showError("修改失败:"+"\x3cbr\x3e"+data.message);$scope.source=angular.copy($scope.selectedItemBackUp);$scope.selectedItem=angular.copy($scope.selectedItemBackUp)})};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){CBIItemCustomScopeService.delete(item.itemCustom.uuid,item.uuid).success(function(){$scope.selectedItem=
null;$scope.refreshList();$scope.showInfo("删除数据成功。")})})};$scope.confirmClickAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认审核吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};CBIItemCustomScopeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.selectedItem.confirm=Constant.CONFIRM[2].value;$scope.changeButtonStatusSingle($scope.selectedItem);$scope.showInfo("修改数据成功。")})})};$scope.confirmRevertClickAction=
function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认取消审核吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};CBIItemCustomScopeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.selectedItem.confirm=Constant.CONFIRM[1].value;$scope.changeButtonStatusSingle($scope.selectedItem);$scope.showInfo("修改数据成功。")})})};$scope.confirmSwitchAction=function(event,item){$scope.stopEventPropagation(event);if(item.confirm==
2)$scope.showConfirm("确认取消审核吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};CBIItemCustomScopeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.changeButtonStatusAll();$scope.showInfo("修改数据成功。")})},function(){item.confirm=Constant.CONFIRM[2].value});else if(item.confirm==1)$scope.showConfirm("确认审核吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};CBIItemCustomScopeService.modify(EmployeeUpdateInput.uuid,
EmployeeUpdateInput).success(function(){$scope.changeButtonStatusAll();$scope.showInfo("修改数据成功。")})},function(){item.confirm=Constant.CONFIRM[1].value})};$scope.statusClickAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认修改启用状态为有效吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};CBIItemCustomScopeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.selectedItem.status=Constant.STATUS[1].value;
$scope.changeButtonStatusSingle($scope.selectedItem);$scope.showInfo("修改数据成功。")})})};$scope.statusRevertClickAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认修改启用状态为无效吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value};CBIItemCustomScopeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.selectedItem.status=Constant.STATUS[2].value;$scope.changeButtonStatusSingle($scope.selectedItem);$scope.showInfo("修改数据成功。")})})};
$scope.statusSwithAction=function(event,item){$scope.stopEventPropagation(event);if(item.status==2)$scope.showConfirm("确认修改启用状态为有效吗？","",function(){var EmployeeUpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};CBIItemCustomScopeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.changeButtonStatusAll();$scope.showInfo("修改数据成功。")})},function(){item.status=Constant.STATUS[2].value});else if(item.status==1)$scope.showConfirm("确认修改启用状态为无效吗？","",function(){var EmployeeUpdateInput=
{uuid:item.uuid,status:Constant.STATUS[2].value};CBIItemCustomScopeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(){$scope.changeButtonStatusAll();$scope.showInfo("修改数据成功。")})},function(){item.status=Constant.STATUS[1].value})};$scope.confirmAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selected.length>0)$scope.showConfirm("确认批量审核吗？","",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(item){var EmployeeUpdateInput=
{uuid:item.uuid,confirm:Constant.CONFIRM[2].value};var response=CBIItemCustomScopeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.refreshList()})}})};$scope.confirmRevertAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selected.length>0)$scope.showConfirm("确认批量取消审核吗？","",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,
function(item){var EmployeeUpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};var response=CBIItemCustomScopeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.refreshList()})}})};$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selected.length>0)$scope.showConfirm("确认批量修改启用状态为有效吗？","",function(){if($scope.selected){var promises=
[];angular.forEach($scope.selected,function(item){var EmployeeUpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};var response=CBIItemCustomScopeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.refreshList()})}})};$scope.statusRevertAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selected.length>0)$scope.showConfirm("确认批量修改启用状态为无效吗？",
"",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(item){var EmployeeUpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value};var response=CBIItemCustomScopeService.modify(EmployeeUpdateInput.uuid,EmployeeUpdateInput).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.refreshList()})}})};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selected.length>
0)$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(item){var response=CBIItemCustomScopeService.delete(item.itemCustom.uuid,item.uuid).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("删除数据成功。");$scope.refreshList()})}})};$scope.selectAllAction=function(){if($scope.selectAllFlag==true)angular.forEach($scope.itemList,function(item){var idx=$scope.selected.indexOf(item);
if(idx<0)$scope.selected.push(item)});else if($scope.selectAllFlag==false)$scope.selected=[];$scope.selectItemCount=$scope.selected.length;$scope.changeButtonStatusAll()};$scope.selectItemAction=function(event,item,selected){$scope.stopEventPropagation(event);var idx=selected.indexOf(item);if(idx>-1)selected.splice(idx,1);else selected.push(item);$scope.selectItemCount=$scope.selected.length;$scope.changeButtonStatusAll()};$scope.exists=function(item,selected){return selected.indexOf(item)>-1};$scope.selected=
[];$scope.resetButtonDisabled=function(){$scope.confirmClick=0;$scope.confirmRevertClick=0;$scope.statusClick=0;$scope.statusRevertClick=0;$scope.deleteClick=0};$scope.resetButtonDisabledAll=function(){$scope.deleteAllClick=0;$scope.statusRevertAllClick=0;$scope.statusAllClick=0;$scope.confirmRevertAllClick=0;$scope.confirmAllClick=0};$scope.changeButtonStatusAll=function(){$scope.resetButtonDisabledAll();angular.forEach($scope.selected,function(employee){$scope.processChangeButtonStatusAll(employee)})};
$scope.changeButtonStatusSingle=function(employee){$scope.resetButtonDisabled();$scope.processChangeButtonStatus(employee)};$scope.processChangeButtonStatus=function(employee){if(employee.confirm==1||employee.item==4)$scope.confirmRevertClick=1;if(employee.confirm==2||employee.item==3){$scope.confirmClick=1;$scope.statusRevertClick=1}if(employee.status==1)$scope.statusClick=1;if(employee.status==2){$scope.statusRevertClick=1;$scope.confirmClick=1}};$scope.processChangeButtonStatusAll=function(employee){if(employee.confirm==
1||employee.item==4)$scope.confirmRevertAllClick=1;if(employee.confirm==2||employee.item==3){$scope.confirmAllClick=1;$scope.statusRevertAllClick=1}if(employee.status==1)$scope.statusAllClick=1;if(employee.status==2){$scope.statusRevertAllClick=1;$scope.confirmAllClick=1}}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/channelItemInfo",{controller:"ChannelItemInfoController",templateUrl:"app/src/app/ocm/itemInfo/itemInfo.html"})}]);
angular.module("IOne-Production").controller("ChannelItemInfoController",function($scope,$q,OCMParametersService,ProductionCatalogueDetails,ChannelService,ChannelItemInfoService,CatalogueTemplate,Catalogue,Production,$mdDialog,$timeout,Constant){$scope.STOP_SALE_FLAG=Constant.STOP_SALE_FLAG;$scope.listFilterItem={itemUuids:[]};$scope.ocmListMenu={selectAll:false,status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value,showQueryBar:true};$scope.formMenuDisplayOption={"100-add":{display:true,
name:"新增",uuid:"9002AD3B-6B24-43DF-84B9-286FC005FC40"},"101-delete":{display:true,name:"删除",uuid:"31A2EB81-05F3-471D-8EAD-E1B100B641D4"},"102-edit":{display:true,name:"编辑",uuid:"5ED118EE-99C2-45DB-B4D5-1A80995DFA28"},"200-cancel":{display:true,name:"取消新增",uuid:"bd5bce23-4be1-4489-a303-1e709a4f9332"},"201-save":{display:true,name:"保存",uuid:"2c6e53b7-82db-438a-a8c2-91efbddf5e68"},"302-save":{display:true,name:"保存",uuid:"48263821-da76-44aa-93ea-75bd19835243"},"303-cancel":{display:true,name:"取消修改",uuid:"8c1d59c2-476d-424d-9a9e-099ec3f9ed8a"},
"304-quit":{display:true,name:"退出编辑",uuid:"995679b5-da55-4bb6-8cf7-eecaeefb54d2"},"611-selectAll":{display:true,name:"全选",uuid:""}};$scope.ocmListMenuDisplayOption={"600-query":{display:true,name:"查询",uuid:""},"601-selectAll":{display:true,name:"全选",uuid:""},"602-audit":{display:true,name:"审核",uuid:""},"603-revertAudit":{display:true,name:"取消审核",uuid:""},"604-valid":{display:true,name:"有效",uuid:""},"605-invalid":{display:true,name:"无效",uuid:""}};$scope.pageOption={sizePerPage:14,currentPage:0,totalPage:100,
totalElements:100};$scope.pageOptionOfChannelPrice={sizePerPage:14,currentPage:0,totalPage:100,totalElements:100};$scope.editItem=function(channel){$scope.selectedItem=channel;$scope.changeViewStatus(Constant.UI_STATUS.PRE_EDIT_UI_STATUS,1);$scope.pageOptionOfChannelPrice.currentPage=0;$scope.pageOptionOfChannelPrice.totalPage=0;$scope.pageOptionOfChannelPrice.totalElements=0;$scope.listFilterItem.itemUuids.length=0;$scope.queryChannelPriceWithPaging()};$scope.searchChannelPriceWithPaging=function(){$scope.pageOptionOfChannelPrice.currentPage=
0;$scope.pageOptionOfChannelPrice.totalPage=0;$scope.pageOptionOfChannelPrice.totalElements=0;$scope.ocmListMenu.selectAll=false;$scope.selected=[];$scope.resetInitialValue();ChannelItemInfoService.getAllWithPaging($scope.pageOptionOfChannelPrice.sizePerPage,$scope.pageOptionOfChannelPrice.currentPage,$scope.selectedItem.uuid).success(function(data){$scope.ChannelInfoList=data;$scope.pageOptionOfChannelPrice.totalPage=data.totalPages;$scope.pageOptionOfChannelPrice.totalElements=data.totalElements})};
$scope.queryChannelPriceWithPaging=function(){$scope.ocmListMenu.selectAll=false;$scope.selected=[];$scope.resetInitialValue();ChannelItemInfoService.getAllWithPaging($scope.pageOptionOfChannelPrice.sizePerPage,$scope.pageOptionOfChannelPrice.currentPage,$scope.selectedItem.uuid).success(function(data){$scope.ChannelInfoList=data;$scope.pageOptionOfChannelPrice.totalPage=data.totalPages;$scope.pageOptionOfChannelPrice.totalElements=data.totalElements})};$scope.queryMenuAction=function(){$scope.resetInitialValue();
$scope.selected=[];$scope.ocmListMenu.selectAll=false;if($scope.ocmListMenu.channelName!==undefined)channelName=$scope.ocmListMenu.channelName;else channelName=null;confirm=$scope.ocmListMenu.confirm;status=$scope.ocmListMenu.status;ChannelService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,confirm,status,channelName,RES_UUID_MAP.OCM.CHANNEL_PRICE.LIST_PAGE.RES_UUID).success(function(data){$scope.ChannelList=data;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=
data.totalElements;var channelUuid="";angular.forEach($scope.ChannelList.content,function(channel){channelUuid=channelUuid+channel.uuid+","});ChannelItemInfoService.getAllCountByChannelUuid(channelUuid).success(function(data){var map=[];angular.forEach(data,function(channelItemCount){map[channelItemCount.uuid]=channelItemCount.itemCount});angular.forEach($scope.ChannelList.content,function(channel){if(undefined!=map[channel.uuid])channel.channelPriceCount=map[channel.uuid];else channel.channelPriceCount=
0})})})};$scope.changeSaleDiscountRate=function(channelPrice){channelPrice.salePrice=parseFloat((channelPrice.standardPrice*channelPrice.saleDiscountRate).toFixed(2))};$scope.changeSalePrice=function(channelPrice){channelPrice.saleDiscountRate=parseFloat((channelPrice.salePrice/channelPrice.standardPrice).toFixed(4))};$scope.listTabSelected=function(){$scope.ocmListMenu.showQueryBar=true;$scope.queryMenuAction();$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS,0);$scope.selected=[];$scope.ChannelInfoList=
[];$scope.selectedItem=null;$scope.itemName=null;$scope.catalogueName=null;$scope.stopSaleFlag=null;$scope.saleDiscountRate=null;$scope.getMenuAuthData($scope.RES_UUID_MAP.OCM.CHANNEL_PRICE.LIST_PAGE.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)})};$scope.formTabSelected=function(){$scope.ocmListMenu.showQueryBar=false;$scope.selected=[];$scope.getMenuAuthData($scope.RES_UUID_MAP.OCM.CHANNEL_PRICE.FORM_PAGE.RES_UUID).success(function(data){$scope.menuAuthDataMap=
$scope.menuDataMap(data)})};$scope.selected=[];$scope.toggle=function(item,selected){var idx=selected.indexOf(item);if(idx>-1)selected.splice(idx,1);else selected.push(item);$scope.ocmListMenu.effectiveType=item.status;if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1)$scope.changeButtonStatus()};$scope.resetInitialValue=function(){$scope.revert_audit_button_disabled=0;$scope.audit_button_disabled=0;$scope.valid_status_button_disabled=0;$scope.invalid_status_button_disabled=
0};$scope.changeButtonStatus=function(){$scope.resetInitialValue();var firstLoop=true;angular.forEach($scope.selected,function(channelPrice){$scope.changeButtonStatusByConfirm(channelPrice);$scope.changeButtonStatusByStatus(channelPrice);if(firstLoop){firstLoop=false;$scope.firstLoopStatus=channelPrice.status;$scope.firstLoopConfirm=channelPrice.confirm}else{if($scope.firstLoopStatus!==channelPrice.status){$scope.valid_status_button_disabled=1;$scope.invalid_status_button_disabled=1}if($scope.firstLoopConfirm!==
channelPrice.confirm){$scope.audit_button_disabled=1;$scope.revert_audit_button_disabled=1}}})};$scope.changeButtonStatusByConfirm=function(channelPrice){if(channelPrice.confirm==Constant.CONFIRM[1].value)$scope.revert_audit_button_disabled=1;else $scope.audit_button_disabled=1;if(channelPrice.confirm==Constant.CONFIRM[2].value){$scope.valid_status_button_disabled=1;$scope.invalid_status_button_disabled=1}};$scope.changeButtonStatusByStatus=function(channelPrice){if(channelPrice.status==Constant.STATUS[1].value)$scope.valid_status_button_disabled=
1;else $scope.invalid_status_button_disabled=1;if(channelPrice.status==Constant.STATUS[2].value){$scope.audit_button_disabled=1;$scope.revert_audit_button_disabled=1}};$scope.exists=function(item,list){return list.indexOf(item)>-1};$scope.selectAllMenuAction=function(){if($scope.ocmListMenu.selectAll==true){$scope.selected=[];if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){angular.forEach($scope.ChannelInfoList.content,function(item){$scope.selected.push(item)});
$scope.changeButtonStatus()}else if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0)angular.forEach($scope.ChannelList.content,function(item){$scope.selected.push(item)})}else if($scope.ocmListMenu.selectAll==false)$scope.selected=[]};$scope.validStatusMenuAction=function(){if($scope.selected.length>0)$scope.showConfirm("确认修改启用状态为有效吗？","",function(){if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){var promises=[];angular.forEach($scope.selected,
function(channelPrice){var ChannelPriceUpdateInput={status:Constant.STATUS[1].value};var response=ChannelItemInfoService.modify(channelPrice.uuid,ChannelPriceUpdateInput).success(function(){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.editItem($scope.selectedItem)})}else if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){var promises=[];angular.forEach($scope.selected,function(channel){var ChannelPriceUpdateInput=
{channelUuid:channel.uuid,status:Constant.STATUS[1].value};var response=ChannelItemInfoService.modifyAll(ChannelPriceUpdateInput).success(function(data){});promises.push(response)});$q.all(promises).then(function(data){$scope.showInfo("修改数据成功。");$scope.queryMenuAction()})}})};$scope.invalidStatusMenuAction=function(){if($scope.selected.length>0)$scope.showConfirm("确认修改启用状态为无效吗？","",function(){if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){var promises=[];angular.forEach($scope.selected,
function(channelPrice){var ChannelPriceUpdateInput={status:Constant.STATUS[2].value};var response=ChannelItemInfoService.modify(channelPrice.uuid,ChannelPriceUpdateInput).success(function(){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.editItem($scope.selectedItem)})}else if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){var promises=[];angular.forEach($scope.selected,function(channel){var ChannelPriceUpdateInput=
{channelUuid:channel.uuid,status:Constant.STATUS[2].value};var response=ChannelItemInfoService.modifyAll(ChannelPriceUpdateInput).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.queryMenuAction()})}})};$scope.revertAuditMenuAction=function(){if($scope.selected.length>0)$scope.showConfirm("确认取消审核吗？","",function(){if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){var promises=[];angular.forEach($scope.selected,
function(channelPrice){var ChannelPriceUpdateInput={confirm:Constant.CONFIRM[1].value};var response=ChannelItemInfoService.modify(channelPrice.uuid,ChannelPriceUpdateInput).success(function(){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.editItem($scope.selectedItem)})}else if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){var promises=[];angular.forEach($scope.selected,function(channel){var ChannelPriceUpdateInput=
{channelUuid:channel.uuid,confirm:Constant.CONFIRM[1].value};var response=ChannelItemInfoService.modifyAll(ChannelPriceUpdateInput).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.queryMenuAction()})}})};$scope.auditMenuAction=function(){if($scope.selected.length>0)$scope.showConfirm("确认审核吗？","",function(){if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){var promises=[];angular.forEach($scope.selected,
function(channelPrice){var ChannelPriceUpdateInput={confirm:Constant.CONFIRM[2].value};var response=ChannelItemInfoService.modify(channelPrice.uuid,ChannelPriceUpdateInput).success(function(){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.editItem($scope.selectedItem)})}else if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){var promises=[];angular.forEach($scope.selected,function(channel){var ChannelPriceUpdateInput=
{channelUuid:channel.uuid,confirm:Constant.CONFIRM[2].value};var response=ChannelItemInfoService.modifyAll(ChannelPriceUpdateInput).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.queryMenuAction()})}})};$scope.createPromptMsg=function(){var msg="";if(undefined!=$scope.itemName&&null!=$scope.itemName&&$scope.itemName.lenth!=0)msg=msg+" 商品名称:"+$scope.itemName;return msg};$scope.modifyMenuAction=function(){if($scope.ChannelInfoList){var promises=
[];angular.forEach($scope.ChannelInfoList.content,function(channelInfo){var response=ChannelItemInfoService.modify(channelInfo.uuid,channelInfo).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。")})}};$scope.cancelModifyMenuAction=function(){$scope.searchChannelPriceWithPaging()};$scope.exitModifyMenuAction=function(){$scope.cancelModifyMenuAction();$scope.changeViewStatus($scope.UI_STATUS.PRE_EDIT_UI_STATUS,1);$scope.ocmListMenu.selectAll==
false};$scope.preAddMenuAction=function(){$scope.ocmListMenu.showQueryBar=false;$scope.selected=[];$scope.ExistedChannelInfoList=$scope.ChannelInfoList;$scope.ChannelInfoList={content:[]};$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_ADD,1);$scope.openProductionSelectDlg()};$scope.continueAddMenuAction=function(){$scope.openProductionSelectDlg()};$scope.addMenuAction=function(){if($scope.ChannelInfoList.content!=undefined&&$scope.ChannelInfoList.content.length>0){var promises=[];angular.forEach($scope.ChannelInfoList.content,
function(channelInfo){channelInfo.channelUuid=$scope.selectedItem.uuid;channelInfo.itemUuid=channelInfo.item.uuid;var channelInfoResponse=ChannelItemInfoService.add(channelInfo).error(function(data){$scope.showError(data.message)});promises.push(channelInfoResponse)});$q.all(promises).then(function(data){$scope.showInfo("新增渠道商品定价成功。");$scope.editItem($scope.selectedItem)},function(data){$scope.showInfo("新增渠道商品信息完成。");$scope.editItem($scope.selectedItem)})}else $scope.ChannelInfoList=$scope.ExistedChannelInfoList;
$scope.changeViewStatus($scope.UI_STATUS.PRE_EDIT_UI_STATUS,1)};$scope.cancelAddMenuAction=function(){$scope.editItem($scope.selectedItem)};$scope.deleteMenuAction=function(){if($scope.selected.length>0)$scope.showConfirm("确认删除吗？","删除的渠道商品信息不可恢复。",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(channelItemInfo){var response=ChannelItemInfoService.delete(channelItemInfo.uuid).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("删除数据成功。");
$scope.editItem($scope.selectedItem)})}})};$scope.openProductionSelectDlg=function(){$mdDialog.show({controller:"ProductionSelectItemController",templateUrl:"app/src/app/ocm/itemInfo/productionSelectDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{channel:$scope.selectedItem,listFilterItem:$scope.listFilterItem.itemUuids,op:"add"}}).then(function(data){$scope.logining=true;$scope.populateChannelPrice(data)})};$scope.populateChannelPrice=function(data){var content=[];var channelPrice=
{channel:$scope.selectedItem,item:data,stopSaleFlag:"N",salePrice:0,saleUnit:""};content.push(channelPrice);$scope.ChannelInfoList.content=$scope.ChannelInfoList.content.concat(content);if(content.length==0)$scope.showInfo("当前目录没有商品或者商品已经导入！");$scope.logining=false}});
angular.module("IOne-Production").controller("ProductionSelectItemController",function($scope,$mdDialog,Production,Catalogue,ProductionCatalogueDetails,Constant,channel,listFilterItem){$scope.listFilterItem=listFilterItem;$scope.channel=channel;$scope.pageOptionForProd={sizePerPage:1E3,currentPage:0,totalPage:0,totalElements:0};$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={status:Constant.STATUS[1].value,confirm:Constant.CONFIRM[2].value,
release:Constant.RELEASE[2].value};$scope.$watch("listFilterOption",function(){$scope.refreshAllTemplate()},true);$scope.selectedTemplateData={};$scope.refreshAllTemplate=function(){Production.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.confirm,$scope.listFilterOption.release,$scope.listFilterOption.status,0,0).success(function(data){var dataResult=[];angular.forEach(data.content,function(item){if($scope.listFilterItem.indexOf(item.uuid)==-1)dataResult.push(item)});
$scope.allProductionsData=dataResult;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements});$scope.selectedItem=null;$scope.selectedTemplateNode=null;$scope.selectedTemplateNodeData=null;$scope.selectedTemplateNodeDataUuid=null};$scope.select=function(selectedObject){$scope.selectedTemplateNode=selectedObject;$mdDialog.hide($scope.selectedTemplateNode)};$scope.cancelDlg=function(){$mdDialog.cancel()}});
(function($){var cx=0;$.fn.jOrgChart=function(options){var opts=$.extend({},$.fn.jOrgChart.defaults,options);var $appendTo=$(opts.chartElement);$this=$(this);var $container=$("\x3cdiv class\x3d'"+opts.chartClass+"'/\x3e");if($this.is("ul")){if(opts.rowcolor)$this.find("li").each(function(){classList=$(this).attr("class").split(/\s+/);$.each(classList,function(index,item){if(item!="temp"&&item!="node"&&item!="child"&&item!="ui-draggable"&&item!="ui-droppable"&&!/^unic\d+$/i.test(item))re=item});if(re!=
null)$(this).removeClass(re);var col=$(this).parents("li").length;if(col==0)$(this).addClass("nrow");else if(col==1)$(this).addClass("firow");else if(col==2)$(this).addClass("serow");else if(col==3)$(this).addClass("throw");else if(col==4)$(this).addClass("forow");else if(col==5)$(this).addClass("firow");else if(col==6)$(this).addClass("sirow");else $(this).addClass("norow")});$this.find("li.root").each(function(){buildNode($(this),$container,0,opts)})}else if($this.is("li"))buildNode($this,$container,
0,opts);$appendTo.append($container);if(opts.dragAndDrop){var $divNode=$(".node:not(.temp)").not(".disabled, #org .node");var $nodeParts=$divNode.not(".child");$divNode.draggable({cursor:"move",distance:40,helper:"clone",opacity:.8,revert:"invalid",revertDuration:100,snap:"div.node.expanded",snapMode:"inner",stack:"div.node"});$nodeParts.droppable({accept:".node",activeClass:"drag-active",hoverClass:"drop-hover"});var $nodeCU=$("div.node.child");$nodeCU.droppable({accept:".child",activeClass:"drag-active",
hoverClass:"drop-hover"});$divNode.bind("dragstart",function handleDragStart(event,ui){var start_event=ui.helper;var sourceNode=$(this);if(start_event.is("div"))sourceNode.parentsUntil(".node-container").find("*").filter(".node").droppable({disabled:true});else if(start_event.is("li"))sourceNode.find("*").filter(".node").droppable({disabled:true})});$divNode.bind("dragstop",function handleDragStop(event,ui){var sideLi=$("#upload-chart").html();$("#upload-chart").empty();$("#upload-chart").append(sideLi);
if($("#upload-chart li:last-child").hasClass("ui-draggable-dragging"))$("#upload-chart li:last-child").remove();if(removeside_node!=""){$("#upload-chart #"+removeside_node).remove();removeside_node=""}$(opts.chartElement).children().remove();$this.jOrgChart(opts)});var removeside_node="";$divNode.bind("drop",function handleDropEvent(event,ui){var targetID=$(this).data("tree-node");var targetLi=$this.find("li").filter(function(){return $(this).data("tree-node")===targetID});var targetUl=targetLi.children("ul");
var sourceID=ui.draggable.data("tree-node");if(sourceID==null){var lilength=$this.find("li").length;var sourceLi=ui.draggable.clone().addClass("unic"+(lilength+1));removeside_node=ui.draggable.attr("id");sourceLi.addClass("item")}else{var sourceLi=$this.find("li").filter(function(){return $(this).data("tree-node")===sourceID});var sourceUl=sourceLi.parent("ul");if(sourceUl.children().length===0)sourceUl.remove()}sourceLi.removeClass("node").removeClass("ui-draggable");if(targetUl.length>0)targetUl.append(sourceLi);
else{targetLi.append("\x3cul\x3e\x3c/ul\x3e");targetLi.children("ul").append(sourceLi)}options.sourceId=sourceLi[0].id;options.targetId=targetLi[0].id;options.callback(options.sourceId,options.targetId)})}};$.fn.jOrgChart.defaults={chartElement:"body",depth:-1,chartClass:"jOrgChart",dragAndDrop:false,expand:false,control:false,rowcolor:true};var nodeCount=0;function removeNode($node,opts,$nodeDiv){if($nodeDiv.hasClass("temp"))if(click_flag){$node.remove();click_flag=true;$(opts.chartElement).children().remove();
$this.jOrgChart(opts)}}function buildNode($node,$appendTo,level,opts){var $table=$("\x3ctable cellpadding\x3d'0' cellspacing\x3d'0' border\x3d'0'/\x3e");var $tbody=$("\x3ctbody/\x3e");var $nodeRow=$("\x3ctr/\x3e").addClass("node-cells");var $nodeCell=$("\x3ctd/\x3e").addClass("node-cell").attr("colspan",2);var $childNodes=$node.children("ul:first").children("li");var $nodeDiv;if($childNodes.length>1)$nodeCell.attr("colspan",$childNodes.length*2);var $nodeContent=$node.clone().children("ul,li").remove().end().html();
nodeCount++;$node.data("tree-node",nodeCount);$nodeDiv=$("\x3cdiv\x3e").addClass("node").data("tree-node",nodeCount).append($nodeContent);$nodeDiv.append("\x3cdiv class\x3d'opciones'\x3e"+"\x3c/div\x3e").mouseenter(function(){if($(this).find("\x3e .details \x3e span").length==0){var duplicate=$(this).find("\x3e span.label_node").clone();$(this).find("\x3e .details").prepend(duplicate)}$(this).find(".details").toggle().parent().css("z-index","999")}).mouseleave(function(){$(this).find(".details").toggle().parent().removeAttr("style")});
var append_text="\x3cli class\x3d'temp'\x3e\x3c/li\x3e";var $list_element=$node.clone().children("ul,li").remove().end();if(opts.expand)if($childNodes.length>0){$nodeDiv.find(".opciones:eq(0)").closest(".node").append("\x3cspan class\x3d'exp-col'\x3e\x3c/span\x3e");$nodeDiv.find(".exp-col").click(function(){var $this=$(this);var $tr=$this.closest("tr");if($tr.hasClass("contracted")){$tr.removeClass("contracted").addClass("expanded");$tr.nextAll("tr").css("visibility","");$node.removeClass("collapsed")}else{$tr.removeClass("expanded").addClass("contracted");
$tr.nextAll("tr").css("visibility","hidden");$node.addClass("collapsed")}})}$nodeCell.append($nodeDiv);$nodeRow.append($nodeCell);$tbody.append($nodeRow);if($childNodes.length>0){if(opts.depth==-1||level+1<opts.depth){var $downLineRow=$("\x3ctr/\x3e");var $downLineCell=$("\x3ctd/\x3e").attr("colspan",$childNodes.length*2);$downLineRow.append($downLineCell);$downLine=$("\x3cdiv\x3e\x3c/div\x3e").addClass("line down");$downLineCell.append($downLine);$tbody.append($downLineRow);var $linesRow=$("\x3ctr/\x3e");
$childNodes.each(function(){var $left=$("\x3ctd\x3e\x26nbsp;\x3c/td\x3e").addClass("line left top");var $right=$("\x3ctd\x3e\x26nbsp;\x3c/td\x3e").addClass("line right top");$linesRow.append($left).append($right)});$linesRow.find("td:first").removeClass("top").end().find("td:last").removeClass("top");$tbody.append($linesRow);var $childNodesRow=$("\x3ctr/\x3e");$childNodes.each(function(){var $td=$("\x3ctd class\x3d'node-container'/\x3e");$td.attr("colspan",2);buildNode($(this),$td,level+1,opts);$childNodesRow.append($td)})}$tbody.append($childNodesRow)}if($node.attr("class")!=
undefined){var classList=$node.attr("class").split(/\s+/);$.each(classList,function(index,item){if(item=="collapsed"){$nodeRow.nextAll("tr").css("visibility","hidden");$nodeRow.removeClass("expanded");$nodeRow.addClass("contracted")}else $nodeDiv.addClass(item)})}if(opts.control)if(!$nodeDiv.hasClass("temp")){$nodeDiv.find(".opciones:eq(0)").append("\x3cspan class\x3d'edit' href\x3d'#fancy_edit'\x3e\x3c/span\x3e");$nodeDiv.find(".opciones:eq(0)").append("\x3cspan class\x3d'add' href\x3d'#fancy'\x3e\x3c/span\x3e");
if($nodeDiv.hasClass("child"))$nodeDiv.find(".opciones:eq(0)").append("\x3cspan class\x3d'del'\x3e\x3c/span\x3e")}else $nodeDiv.find(".opciones:eq(0)").append("\x3cspan class\x3d'add' href\x3d'#fancy'\x3e\x3c/span\x3e\x3cspan class\x3d'del'\x3e\x3c/span\x3e");$table.append($tbody);$appendTo.append($table);$nodeDiv.children("a, span").click(function(e){e.stopPropagation()})}})(jQuery);
angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/production-link",{controller:"ProductionLinkController",templateUrl:"app/src/app/production/production_link/link.html"})}]);angular.module("IOne-Production").filter("itemsInCatalogue",function(){return function(linkData){var result=[];angular.forEach(linkData,function(value){})}});
angular.module("IOne-Production").controller("ProductionLinkController",function($scope,Catalogue,CatalogueTemplate,Constant,ProductionCatalogueDetails,$mdDialog,$timeout){$scope.listFilterOption={status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value,release:Constant.RELEASE[0].value,prodType:Constant.PROD_TYPE[0].value};$scope.$watch("listFilterOption",function(){$scope.refreshAllTemplate()},true);$scope.listFilterDisplayOption={showStatusFilterMenu:true,showConfirmFilterMenu:true,showReleaseFilerMenu:true,
showProdTypeFilterMenu:false};$scope.formMenuDisplayOption={"100-add":{display:true,name:"新增",uuid:"5B0C4134-94B9-49AD-9910-857FDE94C1E4"},"101-delete":{display:false,name:"删除",uuid:"2CB9DB1A-C12F-487F-8FD3-B299B8DDE675"},"102-edit":{display:true,name:"编辑",uuid:"E86C6155-8DAC-40C4-90C4-531FE49E23DC"},"103-copy":{display:false,name:"复制",uuid:"5471D690-BF92-44AE-889F-291E7ABE443C"},"104-status":{display:true,name:"启用",uuid:"C4FB55D6-8293-41B8-9A16-CB2BC851E1AC"},"105-confirm":{display:true,name:"审核",
uuid:"AC193DD9-EAC8-4BBE-AD1B-E1DFBB062DD9"},"106-release":{display:true,name:"发布",uuid:"2ACE4698-8EF8-4A55-B668-45601CA95013"},"200-cancel":{display:true,name:"取消新增",uuid:"ADD763EE-0F54-4AB7-B79D-DBA7FA46B0A3"},"201-save":{display:true,name:"保存",uuid:"63235E5A-2240-4631-B876-6774C773F5BE"},"300-add":{display:false,name:"新增数据",uuid:"570DD5D6-2070-4E2C-979F-05DB01744E98"},"301-delete":{display:true,name:"删除数据",uuid:"9CA7007B-9936-4BBC-945B-D98D0DC472F7"},"302-save":{display:false,name:"保存",uuid:"56180CAC-C289-4A3C-A894-E3F35A5E6C81"},
"303-cancel":{display:false,name:"取消修改",uuid:"0E5A36EC-C2BE-4617-988E-BEE2FF7E39C5"},"304-quit":{display:true,name:"退出编辑",uuid:"02BB4D61-A764-4591-912E-5B33EDED7B79"}};$scope.deleteNodeDisabled=true;$scope.pageOption={sizePerPage:1E4,currentPage:0,totalPage:0,totalElements:0};$scope.pageOptionForProd={sizePerPage:36,currentPage:0,totalPage:0,totalElements:0};$scope.itemSearchParam={confirm:0,release:2,status:0,eshopType:0,assemblingFlag:""};$scope.selectedTemplateData={};$scope.nodeDataClickHandler=
function($event){if($event&&$event.stopPropagation)$event.stopPropagation();if($event&&$event.preventDefault)$event.preventDefault()};$scope.nodeDataChangeHandler=function(template,node,nodeDataList,nodeDataUuid){if($scope.isRefreshing)return;$scope.selectedItem=template;$scope.selectedTemplateData[template.uuid].splice(node.index+1);$scope.selectedTemplateNode=node;$scope.selectedTemplateNodeDataUuid=nodeDataUuid;angular.forEach(nodeDataList,function(item){if(item.uuid==nodeDataUuid){item.selected=
true;$scope.selectedTemplateNodeData=item}else item.selected=false});$scope.refreshUI(template);$scope.refreshProduction(nodeDataUuid);var nextNode=template.details[node.index+1];if(nextNode==undefined||nextNode==undefined)return;else{$scope.isRefreshing=true;Catalogue.get(nextNode.uuid,nodeDataUuid).success(function(data){if(data&&data.content&&data.content.length>0)$scope.selectedTemplateData[template.uuid].push(data.content);$scope.isRefreshing=false}).error(function(){$scope.isRefreshing=false})}};
$scope.refreshUI=function(template){$scope.selectedTemplateNodeDataUI[template.uuid]={};angular.forEach(template.details,function(item){$scope.selectedTemplateNodeDataUI[template.uuid][item.index]=item.name;if($scope.selectedTemplateData[template.uuid][item.index])angular.forEach($scope.selectedTemplateData[template.uuid][item.index],function(data){if(angular.isDefined(data.selected)&&data.selected)$scope.selectedTemplateNodeDataUI[template.uuid][item.index]=data.name})})};$scope.searchQuery={no:"",
name:""};$scope.refreshProduction=function(catalogueUuid){ProductionCatalogueDetails.getByCatalogue(catalogueUuid,$scope.pageOptionForProd.sizePerPage,$scope.pageOptionForProd.currentPage,$scope.searchQuery.no,$scope.searchQuery.name,$scope.RES_UUID_MAP.PRODUCTION.PRODUCTION_LINK.LIST_PAGE.RES_UUID).success(function(data){$scope.linkData=data;$scope.pageOptionForProd.totalPage=data.totalPages;$scope.pageOptionForProd.totalElements=data.totalElements})};$scope.refreshTemplateData=function(template,
node){if(template&&template.details&&template.details.length>0){var dataHandler=function(template,node,data){angular.forEach(data,function(item){item.catalogueTemplateDetail.index=node.index});var content=$scope.selectedTemplateData[template.uuid];if(content==undefined||content==null){content=[data];$scope.selectedTemplateData[template.uuid]=content;$scope.refreshUI(template)}};Catalogue.getForRoot(node.uuid).success(function(data){dataHandler(template,node,data.content)})}};$scope.refreshAllTemplate=
function(){CatalogueTemplate.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.status,$scope.listFilterOption.confirm,$scope.listFilterOption.release).success(function(data){$scope.catalogueTemplates=data;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;var setFirstOpen=false;if(data&&data.content){$scope.selectedTemplateData={};$scope.selectedTemplateNodeDataUI={};angular.forEach(data.content,function(content){if(content&&
content.details){content.display=true;content.open=false;content.dataStatus=content.dataStatus==null?2:1;content.dataConfirm=content.dataConfirm==null?1:2;content.dataRelease=content.dataRelease==null?1:2;angular.forEach(content.details,function(node,index){node.index=index});if(content.details.length>0){if(setFirstOpen==false){content.open=true;setFirstOpen=true}$scope.refreshTemplateData(content,content.details[0])}}})}});$scope.selectedItem=null;$scope.selectedTemplateNode=null;$scope.selectedTemplateNodeData=
null;$scope.selectedTemplateNodeDataUuid=null};$scope.listTabSelected=function(){$scope.refreshAllTemplate();$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS,0)};$scope.formTabSelected=function(){$scope.getMenuAuthData($scope.RES_UUID_MAP.PRODUCTION.PRODUCTION_LINK.FORM_PAGE.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)})};$scope.editItem=function($event,item){if($scope.selectedItem&&item.uuid!=$scope.selectedItem.uuid){$scope.linkData=null;$scope.selectedTemplateNode=
null;$scope.selectedTemplateNodeData=null;$scope.selectedTemplateNodeDataUuid=""}$scope.selectedItem=item;$scope.selectedLinkItem=null;$scope.changeViewStatus(Constant.UI_STATUS.PRE_EDIT_UI_STATUS,1)};$scope.addCatalogueDetail=function(production){if(production&&$scope.selectedTemplateNodeData)ProductionCatalogueDetails.addLink($scope.selectedTemplateNodeData.uuid,production.uuid).success(function(data){$scope.showInfo("新增商品关联成功。");if($scope.linkData==null)$scope.linkData={content:[]};$scope.linkData.content.push(data);
production.display=false})};$scope.deleteCatalogueDetail=function(production){$scope.showConfirm("确认删除吗？","删除的数据不可恢复。",function(){if(production)ProductionCatalogueDetails.delete(production.uuid).success(function(){$scope.linkData.content.splice($scope.linkData.content.indexOf(production),1);$scope.pageOptionForProd.totalElements--;$scope.deleteNodeDisabled=true;$scope.showInfo("删除数据成功。")})})};$scope.exitModifyMenuAction=function(){$scope.changeViewStatus($scope.UI_STATUS.PRE_EDIT_UI_STATUS,1)};$scope.selectProductionInLink=
function(production){angular.forEach($scope.linkData.content,function(value,index){value.selected=false});production.selected=true;$scope.selectedLinkItem=production;$scope.deleteNodeDisabled=false};$scope.deleteNodeMenuAction=function(){if($scope.selectedLinkItem)$scope.deleteCatalogueDetail($scope.selectedLinkItem)};$scope.preAddMenuAction=function(){$mdDialog.show({controller:"AddNewController",templateUrl:"app/src/app/production/production_link/addNewDlg.html",parent:angular.element(document.body),
targetEvent:event,locals:{catalogueTemplates:$scope.catalogueTemplates}}).then(function(data){$scope.selectedItem=data;$scope.refreshTemplateData($scope.selectedItem,$scope.selectedItem.details[0]);$scope.refreshUI($scope.selectedItem);$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS_MODIFY,1)})};$scope.$watch("selectedLinkItem",function(){if($scope.selectedLinkItem){if($scope.selectedLinkItem.status=="1")$scope.formMenuDisplayOption["104-status"].name="禁用";else if($scope.selectedLinkItem.status==
"2")$scope.formMenuDisplayOption["104-status"].name="启用";if($scope.selectedLinkItem.confirm=="1")$scope.formMenuDisplayOption["105-confirm"].name="审核";else if($scope.selectedLinkItem.confirm=="2")$scope.formMenuDisplayOption["105-confirm"].name="反审核";if($scope.selectedLinkItem.release=="1")$scope.formMenuDisplayOption["106-release"].name="发布";else if($scope.selectedLinkItem.release=="2")$scope.formMenuDisplayOption["106-release"].name="反发布"}},true);$scope.handler=function(field,value){if($scope.selectedLinkItem&&
$scope.selectedLinkItem[field]){$scope.selectedLinkItem[field]=value;ProductionCatalogueDetails.modify($scope.selectedLinkItem.uuid,$scope.selectedLinkItem).success(function(){$scope.showInfo("修改数据成功。")})}};$scope.statusMenuAction=function(){if($scope.selectedLinkItem)$scope.selectedLinkItem.status=="1"?$scope.handler("status","2"):$scope.handler("status","1");else $scope.showWarn("请选择一个已关联商品。")};$scope.confirmMenuAction=function(){if($scope.selectedLinkItem){if($scope.selectedLinkItem.confirm=="2"&&
$scope.selectedLinkItem.release==2){$scope.showWarn("已发布的数据不能取消审核。");return}$scope.selectedLinkItem.confirm=="1"?$scope.handler("confirm","2"):$scope.handler("confirm","1")}else $scope.showWarn("请选择一个已关联商品。")};$scope.releaseMenuAction=function(){if($scope.selectedLinkItem){if($scope.selectedLinkItem.release=="1"&&$scope.selectedLinkItem.confirm==1){$scope.showWarn("未审核的数据不能发布。");return}$scope.selectedLinkItem.release=="1"?$scope.handler("release","2"):$scope.handler("release","1")}else $scope.showWarn("请选择一个已关联商品。")};
$scope.openQuickView=function($event,production){$mdDialog.show({controller:"QuickViewController",templateUrl:"app/src/app/production/production/quick_view.html",parent:angular.element(document.body),targetEvent:event,locals:{productionUuid:production.uuid}}).then(function(data){});$event.stopPropagation();$event.preventDefault()}});
angular.module("IOne-Production").controller("AddNewController",function($scope,$mdDialog,catalogueTemplates){$scope.catalogueTemplates=catalogueTemplates;$scope.hideDlg=function(index){$mdDialog.hide($scope.catalogueTemplates.content[index])};$scope.cancelDlg=function(){$mdDialog.cancel()}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/logistics_installations",{controller:"LogisticsInstallationsController",templateUrl:"app/src/app/cbi/logistics_installations/logisticsInstallations.html"})}]);
angular.module("IOne-Production").controller("LogisticsInstallationsController",function($scope,WalkThroughMaster,WalkThroughDetail,WalkThroughLogistic,WalkThroughInstallation,Constant,$mdDialog,$q){$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.BUILDING_TYPE=Constant.BUILDING_TYPE;$scope.WALK_THROUGH_CONF_STATUS=Constant.WALK_THROUGH_CONF_STATUS;$scope.selectAllFlag=false;$scope.selectedItemSize=0;$scope.selectedItemAmount=0;$scope.isLoading=false;$scope.listFilterOption=
{select:{confStatus:Constant.WALK_THROUGH_CONF_STATUS[0].value,confirm:Constant.CONFIRM[0].value,transferFlag:Constant.TRANSFER_PSO_FLAG[1].value}};$scope.menuDisplayOption={"maintain":{display:true,name:"维护",uuid:"b6c65ede-36cd-4754-b4c0-0732bda3f9c2"},"detailMaintain":{display:true,name:"维护",uuid:"fa325832-1480-4968-aea3-102d8ad1f3e5"},"batchMaintain":{display:true,name:"批量维护",uuid:"39d59bfc-2fcc-4524-9d04-2161f09a308b"}};$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=
""};$scope.refreshList=function(){WalkThroughMaster.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;if(data.totalElements>0)angular.forEach($scope.itemList,function(item){WalkThroughLogistic.getAll(item.uuid).success(function(data){item.logistic=data.content[0]});WalkThroughInstallation.getAll(item.uuid).success(function(data){item.installation=
data.content[0]})})})};$scope.getMenuAuthData($scope.RES_UUID_MAP.CBI.LOGISTICS_INSTALLATIONS.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)});$scope.$watch("listFilterOption.select",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()}};
$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;WalkThroughDetail.get($scope.selectedItem.uuid).success(function(data){$scope.subItemList=data.content;item.detailList=$scope.subItemList});$scope.displayAdvancedSearPanel=false};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel)WalkThroughDetail.get(item.uuid).success(function(data){$scope.subItemList=
data.content;item.detailList=$scope.subItemList})};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS)};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);
$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.status=="add")if($scope.domain=="PSO_ORDER_MST")console.info("add order mst...");else{if($scope.domain=="PSO_ORDER_DTL")console.info("add order dtl...")}else if($scope.status=="edit")if($scope.domain=="PSO_ORDER_MST")console.info("edit order mst...");else if($scope.domain=="PSO_ORDER_DTL")console.info("edit order dtl...")};$scope.deleteDetailAction=function(detail){};$scope.selectItemAction=
function(event,item){$scope.stopEventPropagation(event);item.selectedRef=!item.selected;if(item.selected==false||item.selected==undefined||item.selected==null){$scope.selectedItemSize+=1;$scope.selectedItemAmount+=item.orderAmount}else{$scope.selectedItemSize-=1;$scope.selectedItemAmount-=item.orderAmount;$scope.selectAllFlag=false}};$scope.confirmClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("confirm...");if(item.confirm==Constant.CONFIRM[2].value){$scope.showError("已成功审核并抛转的预排单不能取消审核，预排单号："+
item.orderId);return false}$scope.showConfirm("确认审核吗？","",function(){WalkThroughMaster.confirm(item.uuid).success(function(){item.confirm=Constant.CONFIRM[2].value;$scope.showInfo("预排单审核成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.transferClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("transfer...");$scope.showConfirm("确认抛转吗？","",function(){WalkThroughMaster.transfer(item.uuid).success(function(){item.transferFlag=Constant.TRANSFER_PSO_FLAG[1].value;
$scope.showInfo("预排单抛转成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.statusClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("status...")};$scope.releaseClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("release...")};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("delete...")};$scope.confirmAllClickAction=function(event){$scope.stopEventPropagation(event);
console.info("confirm all...");var uuids="";var count=0;var failUuids="";angular.forEach($scope.itemList,function(item){if(item.selected===true){uuids+=item.uuid+",";count++;if(item.confirm==Constant.CONFIRM[2].value)failUuids+=item.orderId+", "}});if(count===0){$scope.showError("没有选择任何预排单，请先选择预排单！");return}if(failUuids!==""){$scope.showError("已成功审核并抛转的预排单不能再次审核并抛转，预排单号："+failUuids.substring(0,failUuids.length-2));return false}$scope.showConfirm("确认审核吗？","",function(){WalkThroughMaster.confirm(uuids).success(function(){angular.forEach($scope.itemList,
function(item){if(item.selected===true)item.confirm=Constant.CONFIRM[2].value});$scope.showInfo("预排单审核成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.walkTroughAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("confirm all...");var uuids="";var count=0;var failUuids="";angular.forEach($scope.itemList,function(item){if(item.selected===true){uuids+=item.uuid+",";count++;if(item.confirm==Constant.CONFIRM[2].value)failUuids+=item.orderId+", "}});
if(count===0)$scope.showError("没有选择任何预排单，请先选择预排单！")};$scope.sycClickAction=function(event){$scope.showConfirm("确认获取吗？","",function(){$scope.isLoading=true;WalkThroughMaster.syc().success(function(response){if(response.status=="COMPLETED"){$scope.refreshList();$scope.isLoading=false;$scope.showInfo("预排单获取成功！")}else{var errorMsg="预排单获取失败";$scope.isLoading=false;if(response.message!=null)$scope.showError(errorMsg+"："+response.message);else $scope.showError(errorMsg+"！")}}).error(function(response){$scope.isLoading=
false;$scope.showError(response.message)})})};$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("status all...")};$scope.releaseAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("release all...")};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("delete all...")};$scope.selectAllAction=function(){angular.forEach($scope.itemList,function(item){if($scope.selectAllFlag)item.selected=true;
else item.selected=false;item.selectedRef=item.selected});$scope.selectedItemSize=0;$scope.selectedItemAmount=0;if($scope.selectAllFlag)angular.forEach($scope.itemList,function(item){$scope.selectedItemSize++;$scope.selectedItemAmount+=item.orderAmount})};$scope.openSupplierDlg=function(item){$mdDialog.show({controller:"SupplierEditorController",templateUrl:"app/src/app/cbi/logistics_installations/supplierDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{editingItem:item}}).then(function(editingItem){if(editingItem.isModifyLogistic==
false){if(editingItem.logistic.supplier.uuid){console.info("新增物流订单");var Input={supplierUuid:editingItem.logistic.supplier.uuid,orderDate:moment(new Date).format("YYYY-MM-DD 00:00:00"),receiptDate:editingItem.confDeliverDate,no:"1"};WalkThroughLogistic.add(editingItem.uuid,Input).success(function(data){$scope.showInfo("新增物流订单成功");item.logistic=data}).error(function(response){$scope.showError(response.message)})}}else if(editingItem.isModifyLogistic==true){if(editingItem.installation.confirm=="2"){$scope.showInfo("已有审核的物流订单,不再更新");
return}if(editingItem.logistic.supplier){console.info("更新物流订单");var Input={uuid:editingItem.logistic.uuid,supplierUuid:editingItem.logistic.supplier.uuid,orderDate:moment(new Date).format("YYYY-MM-DD 00:00:00"),receiptDate:editingItem.confDeliverDate,no:"1"};WalkThroughLogistic.modify(editingItem.uuid,Input).success(function(data){$scope.showInfo("更新物流订单成功");item.logistic=data}).error(function(response){$scope.showError(response.message)})}}if(editingItem.isModifyInstallation==false){if(editingItem.installation.supplier.uuid){console.info("新增安装订单");
var Input={supplierUuid:editingItem.installation.supplier.uuid,orderDate:moment(new Date).format("YYYY-MM-DD 00:00:00"),installationDate:moment(editingItem.installation.installationDate).format("YYYY-MM-DD 00:00:00"),no:"1"};WalkThroughInstallation.add(editingItem.uuid,Input).success(function(data){$scope.showInfo("新增安装订单成功");item.installation=data}).error(function(response){$scope.showError(response.message)})}}else if(editingItem.isModifyInstallation==true){if(editingItem.installation.confirm==
"2"){$scope.showInfo("已有审核的安装订单,不再更新");return}if(editingItem.installation.supplier){console.info("更新安装订单");var Input={uuid:editingItem.installation.uuid,supplierUuid:editingItem.installation.supplier.uuid,orderDate:moment(new Date).format("YYYY-MM-DD 00:00:00"),installationDate:moment(editingItem.installation.installationDate).format("YYYY-MM-DD 00:00:00"),no:"1"};WalkThroughInstallation.modify(editingItem.uuid,Input).success(function(data){$scope.showInfo("更新安装订单成功");item.installation=data}).error(function(response){$scope.showError(response.message)})}}})};
$scope.openBatchSupplierDlg=function(){var countSelected=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)countSelected++});if(countSelected===0){$scope.showWarn("请选择要维护的单据！");$scope.isLoading=false;return}$mdDialog.show({controller:"BatchSupplierEditorController",templateUrl:"app/src/app/cbi/logistics_installations/batchSupplierDlg.html",parent:angular.element(document.body),targetEvent:event}).then(function(data){var logisticInput={uuid:"",supplierUuid:data.logistic.uuid,
orderDate:moment(new Date).format("YYYY-MM-DD 00:00:00"),receiptDate:"",no:"1"};var installationInput={uuid:"",supplierUuid:data.installation.uuid,orderDate:moment(new Date).format("YYYY-MM-DD 00:00:00"),installationDate:moment(data.installation.installationDate).format("YYYY-MM-DD 00:00:00"),no:"1"};var promises=[];var ConfirmedLogistic="";var ConfirmedInstallation="";var count=0;$scope.isLoading=true;angular.forEach($scope.itemList,function(item){if(item.selected===true){if(angular.isUndefined(item.logistic)||
item.logistic==null){console.info("新增物流:");var response=WalkThroughLogistic.add(item.uuid,logisticInput).success(function(){});promises.push(response);count++}else if(item.logistic.confirm=="2")ConfirmedLogistic=ConfirmedLogistic+item.orderId+"\x3cbr\x3e";else{logisticInput.receiptDate=item.confDeliverDate;logisticInput.uuid=item.logistic.uuid;console.info("更新物流:");var response=WalkThroughLogistic.modify(item.uuid,logisticInput).success(function(){});promises.push(response);count++}if(angular.isUndefined(item.installation)||
item.installation==null){console.info("新增安装:");var response=WalkThroughInstallation.add(item.uuid,installationInput).success(function(){});promises.push(response);count++}else if(item.installation.confirm=="2")ConfirmedInstallation=ConfirmedInstallation+item.orderId+"\x3cbr\x3e";else{installationInput.uuid=item.installation.uuid;console.info("更新安装:");var response=WalkThroughInstallation.modify(item.uuid,installationInput).success(function(){});promises.push(response);count++}}});if(count==0){$scope.showWarn("请选择要维护的单据！");
$scope.isLoading=false;return}if(ConfirmedLogistic!=="")$scope.showWarn("已审核的物流单将不更新："+ConfirmedLogistic);if(ConfirmedInstallation!=="")$scope.showWarn("已审核的安装单将不更新："+ConfirmedInstallation);$q.all(promises).then(function(data){$scope.isLoading=false;$scope.showInfo("批量维护成功！");$scope.refreshList()},function(data){$scope.isLoading=false;$scope.showError("批量维护失败！"+data.message);$scope.refreshList()})})}});
angular.module("IOne-Production").controller("SupplierEditorController",function($scope,OCMSupplierService,Constant,$mdDialog,editingItem){$scope.editingItem=angular.copy(editingItem);if(angular.isUndefined($scope.editingItem.logistic)||$scope.editingItem.logistic==null){$scope.editingItem.logistic={supplier:{name:null}};$scope.editingItem.isModifyLogistic=false}else $scope.editingItem.isModifyLogistic=true;if(angular.isUndefined($scope.editingItem.installation)||$scope.editingItem.installation==
null){$scope.editingItem.installation={supplier:{name:null}};$scope.editingItem.isModifyInstallation=false}else{$scope.editingItem.isModifyInstallation=true;if($scope.editingItem.installation.installationDate!=null)$scope.editingItem.installation.installationDate=new Date($scope.editingItem.installation.installationDate)}$scope.saveSupplier=function(){$mdDialog.hide($scope.editingItem)};$scope.cancelDlg=function(){$mdDialog.cancel()};$scope.supplyType="";$scope.chosenSupplier="";$scope.showLogisticsPanel=
function(){$scope.chosenSupplier="logistics";$scope.supplyType="2";$scope.queryAction()};$scope.showInstallationsPanel=function(){$scope.chosenSupplier="installations";$scope.supplyType="3";$scope.queryAction()};$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:0,totalElements:0};$scope.queryAction=function(){$scope.pageOption.currentPage=0;$scope.refreshSupplier()};$scope.backAction=function(){$scope.chosenSupplier="";$scope.searchKeyword=""};$scope.refreshSupplier=function(){OCMSupplierService.getAll($scope.pageOption.sizePerPage,
$scope.pageOption.currentPage,"0","0",null,null,$scope.supplyType,$scope.searchKeyword).success(function(data){$scope.allSupplier=data;$scope.pageOption.totalElements=data.totalElements;$scope.pageOption.totalPage=data.totalPages})};$scope.selectSupplier=function(supplier){if(supplier){if($scope.chosenSupplier=="logistics")$scope.editingItem.logistic.supplier=supplier;else if($scope.chosenSupplier=="installations")$scope.editingItem.installation.supplier=supplier;$scope.backAction()}}});
angular.module("IOne-Production").controller("BatchSupplierEditorController",function($scope,OCMSupplierService,Constant,$mdDialog){$scope.supplyType="";$scope.chosenSupplier="";$scope.chosen={logistic:"",installation:""};$scope.showLogisticsPanel=function(){$scope.chosenSupplier="logistics";$scope.supplyType="2";$scope.queryAction()};$scope.showInstallationsPanel=function(){$scope.chosenSupplier="installations";$scope.supplyType="3";$scope.queryAction()};$scope.pageOption={sizePerPage:10,currentPage:0,
totalPage:0,totalElements:0};$scope.refreshSupplier=function(){OCMSupplierService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,"0","0",null,null,$scope.supplyType,$scope.searchKeyword).success(function(data){$scope.allSupplier=data;$scope.pageOption.totalElements=data.totalElements;$scope.pageOption.totalPage=data.totalPages})};$scope.queryAction=function(){$scope.pageOption.currentPage=0;$scope.refreshSupplier()};$scope.backAction=function(){$scope.chosenSupplier="";$scope.searchKeyword=
""};$scope.selectSupplier=function(supplier){if(supplier){if($scope.chosenSupplier=="logistics")$scope.chosen.logistic=supplier;else if($scope.chosenSupplier=="installations")$scope.chosen.installation=supplier;$scope.backAction()}};$scope.saveSupplier=function(){$mdDialog.hide($scope.chosen)};$scope.cancelDlg=function(){$mdDialog.cancel()}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/ocm/mall",{controller:"OCMMallController",templateUrl:"app/src/app/ocm/mall/mall.html"})}]);
angular.module("IOne-Production").controller("OCMMallController",function($scope,OCMMallService,Constant,$mdDialog,$q){$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={select:{status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value,mallFlag:Constant.MALL_FLAG[0].value},no:"",name:"",keyWord:""};$scope.menuDisplayOption={"switchConfirm":{display:true,name:"审核/取消审核",uuid:"de1217da-6895-47d9-8286-625bd5c03ed6"},"switchStatus":{display:true,
name:"启用/禁用",uuid:"a6369863-c9f6-4244-97b9-f1ef5f8997ff"},"batchConfirm":{display:true,name:"批量审核",uuid:"05e22ab7-eccc-4cdc-ac22-72cfa723c018"},"batchRevertConfirm":{display:true,name:"批量取审",uuid:"83706189-5464-46f4-9852-48213429945a"},"batchStatus":{display:true,name:"批量启用",uuid:"798bfd4f-feef-4f28-994c-cea7f975d51d"},"batchRevertStatus":{display:true,name:"批量禁用",uuid:"0833af21-51d0-45cb-b05a-7d8b0144d841"},"batchDelete":{display:true,name:"批量删除",uuid:"7140ac84-6274-4f80-ba75-5a2ea6da1210"},"detailConfirm":{display:true,
name:"审核",uuid:"f2d986fb-ab43-44a0-9389-7f2eb4c099d1"},"detailRevertConfirm":{display:true,name:"取审",uuid:"864de834-da09-4ed7-bcba-10da5237e446"},"detailStatus":{display:true,name:"启用",uuid:"b613a4cd-2186-4e54-90ec-bae72205bf70"},"detailRevertStatus":{display:true,name:"禁用",uuid:"efa9ffa6-25fe-4729-9a36-361aa047b6e5"},"detailDelete":{display:true,name:"删除",uuid:"a7b0c2ef-f102-4ee6-b914-be2fafd4c1ed"}};$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchStatus=
true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true;$scope.sortByField="no";$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.refreshList=function(){OCMMallService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.select.confirm,$scope.listFilterOption.select.status,$scope.listFilterOption.no,$scope.listFilterOption.name,$scope.listFilterOption.select.mallFlag,$scope.listFilterOption.keyWord,$scope.RES_UUID_MAP.CBI.MALL.RES_UUID).success(function(data){$scope.itemList=
data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;$scope.selectAllFlag=false;$scope.selectedItemSize=0})};$scope.getMenuAuthData($scope.RES_UUID_MAP.CBI.MALL.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)});$scope.$watch("listFilterOption.select",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.queryEnter=function(e){if(e.keyCode===
13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()}};$scope.selectAllFlag=false;$scope.selectedItemSize=0;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;item.detailList=$scope.subItemList;$scope.displayAdvancedSearPanel=false};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;$scope.selectedItem=null};$scope.toggleMorePanelAction=function(item){item.showMorePanel=
!item.showMorePanel;if(item.showMorePanel)item.detailList=item};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);$scope.refreshList()};$scope.hideItemDetailsAction=function(event){$scope.stopEventPropagation(event);$scope.selectedItem=null;$scope.refreshList()};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);
$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.source.confirm=="2"&&$scope.source.status=="2"){$scope.showError("不允许状态是已审核又无效,请调整后再保存");return}if($scope.status=="add"){if($scope.domain==
"OCM_BASE_MALL")OCMMallService.add($scope.source).success(function(data){$scope.showInfo("新增数据成功。")}).error(function(data){$scope.showError("新增失败:"+"\x3cbr\x3e"+data.message)})}else if($scope.status=="edit")if($scope.domain=="OCM_BASE_MALL")OCMMallService.modify($scope.source.uuid,$scope.source).success(function(data){$scope.showInfo("修改数据成功。");$scope.source=data;$scope.selectedItem=data;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)}).error(function(data){$scope.showError("修改失败:"+"\x3cbr\x3e"+
data.message);$scope.source=angular.copy($scope.selectedItemBackUp);$scope.selectedItem=angular.copy($scope.selectedItemBackUp)})};$scope.deleteDetailAction=function(detail){};$scope.selectItemAction=function(event,item){$scope.stopEventPropagation(event);item.selectedRef=!item.selected;if(item.selected==false||item.selected==undefined||item.selected==null)$scope.selectedItemSize+=1;else{$scope.selectedItemSize-=1;$scope.selectAllFlag=false}$scope.disableBatchMenuButtons()};$scope.confirmSwitchAction=
function(event,item){$scope.stopEventPropagation(event);if(item.confirm==Constant.CONFIRM[2].value)$scope.showConfirm("确认取消审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};OCMMallService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("取消审核成功。")})},function(){item.confirm=Constant.CONFIRM[2].value});else{if(item.status==Constant.STATUS[2].value){$scope.showWarn("项目是失效状态,请先启用后再审核");item.confirm=Constant.CONFIRM[2].value;
return}$scope.showConfirm("确认审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};OCMMallService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("审核成功。")})},function(){item.confirm=Constant.CONFIRM[1].value})}};$scope.statusSwitchAction=function(event,item){$scope.stopEventPropagation(event);if(item.status==Constant.STATUS[2].value)$scope.showConfirm("确认修改启用状态为有效吗？","",function(){var UpdateInput={uuid:item.uuid,
status:Constant.STATUS[1].value};OCMMallService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("生效成功。")})},function(){item.status=Constant.STATUS[2].value});else $scope.showConfirm("确认修改启用状态为失效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value,confirm:Constant.CONFIRM[1].value};OCMMallService.modify(UpdateInput.uuid,UpdateInput).success(function(){item.confirm=Constant.CONFIRM[1].value;$scope.disableBatchMenuButtons();
$scope.showInfo("失效成功。")})},function(){item.status=Constant.STATUS[1].value})};$scope.confirmClickAction=function(event,item){$scope.stopEventPropagation(event);if(item.confirm==Constant.CONFIRM[2].value)$scope.showConfirm("确认取消审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};OCMMallService.modify(item.uuid,UpdateInput).success(function(){item.confirm=Constant.CONFIRM[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("取消审核成功！")}).error(function(response){$scope.showError(response.message)})});
else $scope.showConfirm("确认审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};OCMMallService.modify(item.uuid,UpdateInput).success(function(){item.confirm=Constant.CONFIRM[2].value;$scope.disableBatchMenuButtons();$scope.showInfo("审核成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.statusClickAction=function(event,item){$scope.stopEventPropagation(event);if(item.status==Constant.STATUS[1].value)$scope.showConfirm("确认改为失效吗？","",function(){var UpdateInput=
{uuid:item.uuid,status:Constant.STATUS[2].value,confirm:Constant.CONFIRM[1].value};OCMMallService.modify(item.uuid,UpdateInput).success(function(){item.status=Constant.STATUS[2].value;item.confirm=Constant.CONFIRM[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("修改为失效成功！")}).error(function(response){$scope.showError(response.message)})});else $scope.showConfirm("确认改为生效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};OCMMallService.modify(item.uuid,UpdateInput).success(function(){item.status=
Constant.STATUS[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("修改为生效成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.releaseClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("release...")};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);if(item.status!="1"||item.confirm!="1"){$scope.showWarn("仅当商场的状态是有效且未审核时才允许删除!");return}$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){OCMMallService.delete(item.uuid).success(function(){$scope.selectedItem=
null;$scope.refreshList();$scope.showInfo("删除数据成功。")})})};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var noDeleteNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.status=="1"&&item.confirm=="1"){var response=OCMMallService.delete(item.uuid).success(function(){});promises.push(response);count++}else noDeleteNos=noDeleteNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任何状态是有效且未审核的可删除项目，请选择！");
return}$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){if(noDeleteNos!=="")$scope.showWarn("以下状态是失效或已审核的的项目将不会删除："+"\x3cbr\x3e"+noDeleteNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("删除成功！")},function(data){$scope.showError(data.message);$scope.showError(data.data.message)})})};$scope.confirmAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var confirmedNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===
true)if(item.confirm!=Constant.CONFIRM[2].value){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};var response=OCMMallService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else confirmedNos=confirmedNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任何未审核的项目，请先选择！");return}if(confirmedNos!=="")$scope.showWarn("以下已审核过的项目将不再次审核："+"\x3cbr\x3e"+confirmedNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("审核成功！")},
function(data){$scope.showError(data.message);$scope.showError(data.data.message)})};$scope.revertConfirmAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var unConfirmedNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.confirm==Constant.CONFIRM[2].value){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};var response=OCMMallService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);
count++}else unConfirmedNos=unConfirmedNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任已审核的项目，请先选择！");return}if(unConfirmedNos!=="")$scope.showWarn("以下未审核过的项目将不执行取消审核："+unConfirmedNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("取消审核成功！")},function(data){$scope.showError(data.data.message);$scope.showError(data.message)})};$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var effectiveNos="";var count=0;angular.forEach($scope.itemList,
function(item){if(item.selected===true)if(item.status!=Constant.STATUS[1].value){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};var response=OCMMallService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else effectiveNos=effectiveNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任何失效的项目，请先选择！");return}if(effectiveNos!=="")$scope.showWarn("以下已生效的项目将不再次修改："+"\x3cbr\x3e"+effectiveNos);$q.all(promises).then(function(data){$scope.refreshList();
$scope.showInfo("生效成功！")},function(data){$scope.showError(data.message);$scope.showError(data.data.message)})};$scope.revertStatusAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var uneffectiveNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.status==Constant.STATUS[1].value){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value,confirm:Constant.CONFIRM[1].value};var response=OCMMallService.modify(item.uuid,
UpdateInput).success(function(){});promises.push(response);count++}else uneffectiveNos=uneffectiveNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择生效的项目，请先选择！");return}if(uneffectiveNos!=="")$scope.showWarn("以下失效的项目将不再次修改："+uneffectiveNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("失效成功！")},function(data){$scope.showError(data.data.message);$scope.showError(data.message)})};$scope.releaseAllClickAction=function(event){$scope.stopEventPropagation(event);
console.info("release all...")};$scope.selectAllAction=function(){angular.forEach($scope.itemList,function(item){if($scope.selectAllFlag)item.selected=true;else item.selected=false;item.selectedRef=item.selected});$scope.selectedItemSize=0;$scope.selectedItemAmount=0;if($scope.selectAllFlag)angular.forEach($scope.itemList,function(item){$scope.selectedItemSize++});$scope.disableBatchMenuButtons()};$scope.disableBatchMenuButtons=function(){var selectedCount=0;var confirm="";var status="";var diffConfirm=
false;var diffStatus=false;angular.forEach($scope.itemList,function(item,index){if(item.selectedRef){selectedCount++;if(confirm=="")confirm=item.confirm;else if(confirm!=item.confirm)diffConfirm=true;if(status=="")status=item.status;else if(status!=item.status)diffStatus=true}});if(selectedCount==0){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}else{if(diffConfirm==true){$scope.disabledBatchConfirm=
true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchDelete=true}else if(confirm=="2"){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=false;$scope.disabledBatchDelete=true}else{$scope.disabledBatchConfirm=false;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchDelete=false}if(diffStatus==true){$scope.disabledBatchConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}else if(status=="1"){$scope.disabledBatchStatus=
true;$scope.disabledBatchCancelStatus=false}else{$scope.disabledBatchConfirm=true;$scope.disabledBatchStatus=false;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}}}});angular.module("IOne-directives").directive("listMenu",function(Constant){return{templateUrl:"app/src/js/directive/listMenu.html",link:function($scope){}}});
angular.module("IOne-directives").directive("formMenu",function(Constant){return{templateUrl:"app/src/js/directive/formMenu.html",link:function($scope){$scope.menuAction=function(menuId,$event){if(menuId==100)$scope.preAddMenuAction();else if(menuId==101)$scope.deleteMenuAction();else if(menuId==102)$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_MODIFY,1);else if(menuId==103)$scope.copyMenuAction();else if(menuId==104)$scope.statusMenuAction();else if(menuId==105)$scope.confirmMenuAction();
else if(menuId==106)$scope.releaseMenuAction();else if(menuId==107)$scope.changeMenuAction();else if(menuId==108)$scope.changeHistoryMenuAction();else if(menuId==109)$scope.copyChannelPrice();if(menuId==200)$scope.cancelAddMenuAction();else if(menuId==201)$scope.addMenuAction();else if(menuId==202)$scope.continueAddMenuAction();if(menuId==300)$scope.addNodeMenuAction($event);else if(menuId==301)$scope.deleteNodeMenuAction($event);else if(menuId==302)$scope.modifyMenuAction();else if(menuId==303)$scope.cancelModifyMenuAction();
else if(menuId==304)$scope.exitModifyMenuAction()}}}});
angular.module("IOne-directives").directive("orderListMenu",function(Constant){return{templateUrl:"app/src/js/directive/orderListMenu.html",link:function($scope){$scope.orderListMenuAction=function(menuId,$event){if(menuId==400)$scope.selectAllMenuAction();else if(menuId==401)$scope.auditMenuAction();else if(menuId==402)$scope.returnMenuAction();else if(menuId==403)$scope.throwMenuAction();else if(menuId==404)$scope.effectiveMenuAction();else if(menuId==405)$scope.queryMenuAction();else if(menuId==
406)$scope.revertAuditMenuAction();else if(menuId==407)$scope.oneOffSync();else if(menuId==408)$scope.preAddMenuAction();else if(menuId==409)$scope.rollbackTransfer()}}}});
angular.module("IOne-directives").directive("orderFormMenu",function(Constant){return{templateUrl:"app/src/js/directive/orderFormMenu.html",link:function($scope){$scope.orderListMenuAction=function(menuId,$event){if(menuId==410)$scope.selectAllMenuAction();else if(menuId==411)$scope.auditMenuAction();else if(menuId==412)$scope.returnMenuAction();else if(menuId==413)$scope.throwMenuAction();else if(menuId==414)$scope.effectiveMenuAction();else if(menuId==416)$scope.revertAuditMenuAction();else if(menuId==
417)$scope.printAction();else if(menuId==418)$scope.oneOffSync();else if(menuId==419)$scope.rollbackTransfer()}}}});angular.module("IOne-directives").directive("itemOperationMenu",function(Constant){return{templateUrl:"app/src/js/directive/itemOperationMenu.html",link:function($scope){$scope.itemOperationMenuAction=function(menuId,$event){if(menuId==500)$scope.itemEditMenuAction();else if(menuId==501)$scope.itemDeleteMenuAction()}}}});
angular.module("IOne-directives").directive("ocmListMenu",function(Constant){return{templateUrl:"app/src/js/directive/ocmListMenu.html",link:function($scope){$scope.ocmListMenuAction=function(menuId,$event){if(menuId==600)$scope.queryMenuAction();else if(menuId==601)$scope.selectAllMenuAction();else if(menuId==602)$scope.auditMenuAction();else if(menuId==603)$scope.revertAuditMenuAction();else if(menuId==604)$scope.validStatusMenuAction();else if(menuId==605)$scope.invalidStatusMenuAction()}}}});
angular.module("IOne-directives").directive("ocmFormMenu",function(Constant){return{templateUrl:"app/src/js/directive/ocmFormMenu.html",link:function($scope){$scope.ocmListMenuAction=function(menuId,$event){if(menuId==611)$scope.selectAllMenuAction();else if(menuId==612)$scope.auditMenuAction();else if(menuId==613)$scope.revertAuditMenuAction();else if(menuId==614)$scope.validStatusMenuAction();else if(menuId==615)$scope.invalidStatusMenuAction()}}}});
angular.module("IOne-directives").directive("taobaoOrderListMenu",function(Constant){return{templateUrl:"app/src/js/directive/taobaoOrderListMenu.html",link:function($scope){$scope.taobaoOrderListMenuAction=function(menuId,$event){if(menuId==400)$scope.selectAllMenuAction();else if(menuId==401)$scope.auditMenuAction();else if(menuId==403)$scope.throwMenuAction();else if(menuId==404)$scope.effectiveMenuAction();else if(menuId==405)$scope.queryMenuAction();else if(menuId==406)$scope.revertAuditMenuAction();
else if(menuId==407)$scope.mergeMenuAuction();else if(menuId==408)$scope.unConfirmMenuAction();else if(menuId==409)$scope.deliveryMenuAction()}}}});
angular.module("IOne-directives").directive("ecommerceOrderListMenu",function(Constant){return{templateUrl:"app/src/js/directive/ecommerceOrderListMenu.html",link:function($scope){$scope.ecommerceOrderListMenuAction=function(menuId,$event){if(menuId==400)$scope.selectAllMenuAction();else if(menuId==401)$scope.auditMenuAction();else if(menuId==403)$scope.throwMenuAction();else if(menuId==404)$scope.effectiveMenuAction();else if(menuId==405)$scope.queryMenuAction();else if(menuId==406)$scope.revertAuditMenuAction();
else if(menuId==407)$scope.preAddMenuAction();else if(menuId==408)$scope.cancelThrowMenuAction()}}}});
angular.module("IOne-directives").directive("ecommerceOrderFormMenu",function(Constant){return{templateUrl:"app/src/js/directive/ecommerceOrderFormMenu.html",link:function($scope){$scope.ecommerceOrderListMenuAction=function(menuId,$event){if(menuId==410)$scope.selectAllMenuAction();else if(menuId==411)$scope.auditMenuAction();else if(menuId==412)$scope.returnMenuAction();else if(menuId==413)$scope.throwMenuAction();else if(menuId==414)$scope.effectiveMenuAction();else if(menuId==416)$scope.revertAuditMenuAction();
else if(menuId==417)$scope.cancelThrowMenuAction();else if(menuId==418)$scope.printAction()}}}});
angular.module("IOne-directives").directive("ecommerceChangeListMenu",function(Constant){return{templateUrl:"app/src/js/directive/ecommerceChangeListMenu.html",link:function($scope){$scope.ecommerceChangeListMenuAction=function(menuId,$event){if(menuId==400)$scope.selectAllMenuAction();else if(menuId==401)$scope.auditMenuAction();else if(menuId==403)$scope.throwMenuAction();else if(menuId==404)$scope.effectiveMenuAction();else if(menuId==405)$scope.queryMenuAction();else if(menuId==406)$scope.revertAuditMenuAction()}}}});
angular.module("IOne-Production").service("ChannelService",function($http,Constant){this.getAll=function(sizePerPage,page,confirm,status,channelName,channelNo,resUuid){confirm=confirm==0?"":confirm;status=status==0?"":status;var url="/channels?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26confirm\x3d"+confirm+"\x26status\x3d"+status;if(channelName!==undefined&&channelName!==null)url=url+"\x26name\x3d"+channelName;if(channelNo!==undefined&&channelNo!==null)url=url+"\x26no\x3d"+channelNo;if(resUuid!==
undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)};this.getAllGlobalQuery=function(sizePerPage,page,confirm,status,searchKeyword,resUuid){confirm=confirm==0?"":confirm;status=status==0?"":status;var url="/channels?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26confirm\x3d"+confirm+"\x26status\x3d"+status;if(searchKeyword!==undefined&&searchKeyword!==null)url=url+"\x26keyWord\x3d"+searchKeyword;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+
resUuid;return $http.get(Constant.BACKEND_BASE+url)};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+"/channels/"+uuid)}});
angular.module("IOne-Production").service("ChannelPriceService",function($http,Constant){this.getAll=function(channelUuid,resUuid){var url="/channelPrices?channelUuid\x3d"+channelUuid+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)};this.getAllWithPaging=function(sizePerPage,page,channelUuid,catalogueName,itemName,warehouseQueryUuid){var url="/channelPrices?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26channelUuid\x3d"+channelUuid;if(catalogueName!==undefined&&catalogueName!==
null)url=url+"\x26catalogueName\x3d"+catalogueName;if(itemName!==undefined&&itemName!==null)url=url+"\x26itemName\x3d"+itemName;if(warehouseQueryUuid!==undefined&&warehouseQueryUuid!==null)url=url+"\x26warehouseUuid\x3d"+warehouseQueryUuid;return $http.get(Constant.BACKEND_BASE+url)};this.getByItemUuid=function(channelUuid,itemUuid){var url="/channelPrices?channelUuid\x3d"+channelUuid+"\x26itemUuid\x3d"+itemUuid;return $http.get(Constant.BACKEND_BASE+url)};this.getAllCount=function(channelUuid){var ChannelPriceQuery=
{channelUuid:channelUuid};var url="channelPrices/"+channelUuid+"/count/";return $http.get(Constant.BACKEND_BASE+url)};this.getAllCountByChannelUuid=function(channelUuid){var ChannelPriceQuery={channelUuid:channelUuid};var url="channels/"+channelUuid+"/count/";return $http.get(Constant.BACKEND_BASE+url)};this.get=function(ChannelPriceUuid){return $http.get(Constant.BACKEND_BASE+"/channelPrices/"+ChannelPriceUuid)};this.add=function(ChannelPriceInput){return $http.post(Constant.BACKEND_BASE+"/channelPrices/",
ChannelPriceInput)};this.modify=function(ChannelPriceUuid,ChannelPriceUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/channelPrices/"+ChannelPriceUuid,ChannelPriceUpdateInput)};this.modifyAll=function(ChannelPriceUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/channelPrices/",ChannelPriceUpdateInput)};this.delete=function(ChannelPriceUuid){return $http.delete(Constant.BACKEND_BASE+"/channelPrices/"+ChannelPriceUuid)};this.copy=function(sourceChannelUuid,destChannelUuid){return $http.post(Constant.BACKEND_BASE+
"/channelPrices/"+sourceChannelUuid+"?replicateTo\x3d"+destChannelUuid)};this.updateStandardPriceInBatch=function(channelUuid,catalogueName,itemName,warehouseUuid,standardPriceDiscountRate){var url="/channelPrices/batch?";var ChannelPriceBatchUpdateInput={channelUuid:channelUuid};if(catalogueName!==undefined&&catalogueName!==null)ChannelPriceBatchUpdateInput.catalogueName=catalogueName;if(itemName!==undefined&&itemName!==null)ChannelPriceBatchUpdateInput.itemName=itemName;if(warehouseUuid!==undefined&&
warehouseUuid!==null)ChannelPriceBatchUpdateInput.warehouseUuid=warehouseUuid;if(standardPriceDiscountRate!==undefined&&standardPriceDiscountRate!==null){ChannelPriceBatchUpdateInput.standardPriceDiscountRate=standardPriceDiscountRate;return $http.patch(Constant.BACKEND_BASE+url,ChannelPriceBatchUpdateInput)}};this.updateSalePriceInBatch=function(channelUuid,catalogueName,itemName,warehouseUuid,saleDiscountRate){var url="/channelPrices/batch?";var ChannelPriceBatchUpdateInput={channelUuid:channelUuid};
if(catalogueName!==undefined&&catalogueName!==null)ChannelPriceBatchUpdateInput.catalogueName=catalogueName;if(itemName!==undefined&&itemName!==null)ChannelPriceBatchUpdateInput.itemName=itemName;if(warehouseUuid!==undefined&&warehouseUuid!==null)ChannelPriceBatchUpdateInput.warehouseUuid=warehouseUuid;if(saleDiscountRate!==undefined&&saleDiscountRate!==null){ChannelPriceBatchUpdateInput.saleDiscountRate=saleDiscountRate;return $http.patch(Constant.BACKEND_BASE+url,ChannelPriceBatchUpdateInput)}};
this.updateWarehouseInBatch=function(channelUuid,catalogueName,itemName,warehouseUuid,warehouseUpdatedUuid){var url="/channelPrices/batch?";var ChannelPriceBatchUpdateInput={channelUuid:channelUuid};if(catalogueName!==undefined&&catalogueName!==null)ChannelPriceBatchUpdateInput.catalogueName=catalogueName;if(itemName!==undefined&&itemName!==null)ChannelPriceBatchUpdateInput.itemName=itemName;if(warehouseUuid!==undefined&&warehouseUuid!==null)ChannelPriceBatchUpdateInput.warehouseUuid=warehouseUuid;
if(warehouseUpdatedUuid!==undefined&&warehouseUpdatedUuid!==null){ChannelPriceBatchUpdateInput.warehouseUpdatedUuid=warehouseUpdatedUuid;return $http.patch(Constant.BACKEND_BASE+url,ChannelPriceBatchUpdateInput)}}});angular.module("IOne-Production").service("WarehousesService",function($http,Constant){this.getAll=function(){return $http.get(Constant.BACKEND_BASE+"/warehouses/")}});
angular.module("IOne-Production").service("OCMParametersService",function($http,Constant){this.getAll=function(){return $http.get(Constant.BACKEND_BASE+"/ocmParameters/")};this.getAllWithPaging=function(sizePerPage,page,coefficient,discount){var url="/ocmParameters?size\x3d"+sizePerPage+"\x26page\x3d"+page;if(!isNaN(parseFloat(coefficient)))url=url+"\x26standardPriceCoefficient\x3d"+coefficient;if(!isNaN(parseFloat(discount)))url=url+"\x26saleDiscountRate\x3d"+discount;return $http.get(Constant.BACKEND_BASE+
url)};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+"/ocmParameters/"+uuid)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/ocmParameters/"+uuid)};this.modify=function(uuid,parametersUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/ocmParameters/"+uuid,parametersUpdateInput)};this.add=function(parametersInput){return $http.post(Constant.BACKEND_BASE+"/ocmParameters/",parametersInput)}});
angular.module("IOne-Production").service("OCMChannelService",function($http,Constant){this.getAll=function(sizePerPage,page,confirm,status,no,name,channelFlag,keyWord,resUuid){confirm=confirm==0?"":confirm;status=status==0?"":status;var url="/channels?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26confirm\x3d"+confirm+"\x26status\x3d"+status;if(no!==undefined&&no!==null&&no!=="")url=url+"\x26no\x3d"+no;if(name!==undefined&&name!==null&&name!=="")url=url+"\x26name\x3d"+name;if(channelFlag!==undefined&&
channelFlag!==null&&channelFlag!==""&&channelFlag!=0)url=url+"\x26channelFlag\x3d"+channelFlag;if(keyWord!==undefined&&keyWord!==null&&keyWord!=="")url=url+"\x26keyWord\x3d"+keyWord;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)};this.getByNo=function(no){return $http.get(Constant.BACKEND_BASE+"/channels?no\x3d"+no)};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+"/channels/"+uuid)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+
"/channels/"+uuid)};this.modify=function(uuid,UpdateInput){return $http.patch(Constant.BACKEND_BASE+"/channels/"+uuid,UpdateInput)};this.add=function(AddInput){return $http.post(Constant.BACKEND_BASE+"/channels",AddInput)}});
angular.module("IOne-Production").service("OCMMallService",function($http,Constant){this.getAll=function(sizePerPage,page,confirm,status,no,name,mallFlag,keyWord,resUuid){confirm=confirm==0?"":confirm;status=status==0?"":status;var url="/malls?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26confirm\x3d"+confirm+"\x26status\x3d"+status;if(no!==undefined&&no!==null&&no!=="")url=url+"\x26no\x3d"+no;if(name!==undefined&&name!==null&&name!=="")url=url+"\x26name\x3d"+name;if(mallFlag!==undefined&&mallFlag!==
null&&mallFlag!==""&&mallFlag!=0)url=url+"\x26mallFlag\x3d"+mallFlag;if(keyWord!==undefined&&keyWord!==null&&keyWord!=="")url=url+"\x26keyWord\x3d"+keyWord;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+"/malls/"+uuid)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/malls/"+uuid)};this.modify=function(uuid,UpdateInput){return $http.patch(Constant.BACKEND_BASE+
"/malls/"+uuid,UpdateInput)};this.add=function(AddInput){return $http.post(Constant.BACKEND_BASE+"/malls",AddInput)}});
angular.module("IOne-Production").service("OCMSupplierService",function($http,Constant){this.getAll=function(sizePerPage,page,confirm,status,no,name,supplyType,keyWord,resUuid){confirm=confirm==0?"":confirm;status=status==0?"":status;var url="/suppliers?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26confirm\x3d"+confirm+"\x26status\x3d"+status;if(no!==undefined&&no!==null&&no!=="")url=url+"\x26no\x3d"+no;if(name!==undefined&&name!==null&&name!=="")url=url+"\x26name\x3d"+name;if(supplyType!==undefined&&
supplyType!==null&&supplyType!==""&&supplyType!=0)url=url+"\x26supplyType\x3d"+supplyType;if(keyWord!==undefined&&keyWord!==null&&keyWord!=="")url=url+"\x26keyWord\x3d"+keyWord;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)};this.get=function(uuid,supplyType){var url="/suppliers?uuid\x3d"+uuid;if(supplyType!==undefined&&supplyType!==null&&supplyType!=="")url=url+"\x26supplyType\x3d"+supplyType;return $http.get(Constant.BACKEND_BASE+
url)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/suppliers/"+uuid)};this.modify=function(uuid,UpdateInput){return $http.patch(Constant.BACKEND_BASE+"/suppliers/"+uuid,UpdateInput)};this.add=function(AddInput){return $http.post(Constant.BACKEND_BASE+"/suppliers",AddInput)}});
angular.module("IOne-Production").service("ChannelItemInfoService",function($http,Constant){this.getAll=function(channelUuid,resUuid){var url="/itemChannelRelations?channelUuid\x3d"+channelUuid+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)};this.getAllWithPaging=function(sizePerPage,page,channelUuid){var url="/itemChannelRelations?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26channelUuid\x3d"+channelUuid;return $http.get(Constant.BACKEND_BASE+url)};this.getAllCountByChannelUuid=
function(channelUuid){var ChannelPriceQuery={channelUuid:channelUuid};var url="channels/"+channelUuid+"/count/";return $http.get(Constant.BACKEND_BASE+url)};this.get=function(ChannelPriceUuid){return $http.get(Constant.BACKEND_BASE+"/itemChannelRelations/"+ChannelPriceUuid)};this.add=function(ChannelPriceInput){return $http.post(Constant.BACKEND_BASE+"/itemChannelRelations/",ChannelPriceInput)};this.modify=function(ChannelPriceUuid,ChannelPriceUpdateInput){return $http.patch(Constant.BACKEND_BASE+
"/itemChannelRelations/"+ChannelPriceUuid,ChannelPriceUpdateInput)};this.modifyAll=function(ChannelPriceUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/itemChannelRelations/",ChannelPriceUpdateInput)};this.delete=function(ChannelPriceUuid){return $http.delete(Constant.BACKEND_BASE+"/itemChannelRelations/"+ChannelPriceUuid)}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/jingdong-orders",{controller:"JdOrderController",templateUrl:"app/src/app/jingdong/order/order.html"})}]);
angular.module("IOne-Production").controller("JdOrderController",function($scope,JdTradeMaster,JdTradeDetail1,JdTradeDetail2,Constant,$mdDialog){$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.MenuDisplayOption={"107-throw":{display:true,name:"审核",uuid:"D566E493-7138-4FB0-9E34-44460A4AEAAB"},"108-cancelThrow":{display:true,name:"取消审核",uuid:"DFEABC92-881A-484E-9C14-D9BD68D06C2E"},"400-throw":{display:true,name:"审核",uuid:"CEBE2D58-4DB9-4350-B048-52BC6D402BD3"},
"401-cancelThrow":{display:true,name:"取审",uuid:"3786e3e5-efd5-43fe-b639-f4fc70ad241f"},"403-batchThrow":{display:true,name:"批量审核",uuid:"1B06DBD4-A1A7-47A3-88C0-15EDB98029CA"},"405-batchSelectThrow":{display:true,name:"批量取审",uuid:"FE5F696F-1C29-4AA1-9410-341BF82EB376"},"407-batchMerge":{display:true,name:"批量合并",uuid:"B98178BC-213F-4D58-8CB3-5AE2131AEEB9"}};$scope.JINGDONG_STATUS=Constant.JINGDONG_STATUS;$scope.disableMergeButton=false;$scope.listFilterOption={orderState:Constant.JINGDONG_STATUS["WAIT_SELLER_STOCK_OUT"].value,
confirm:Constant.CONFIRM[1].value,orderFlag:Constant.ORDER_FLAG[0].value};$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.refreshList=function(){JdTradeMaster.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption,$scope.RES_UUID_MAP.EPS.JINGDONG_ORDERS.RES_UUID).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;$scope.refreshMenuButtons()})};
$scope.getMenuAuthData($scope.RES_UUID_MAP.EPS.JINGDONG_ORDERS.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)});$scope.$watch("listFilterOption",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.selectAllFlag=false;$scope.selectedItemSize=0;$scope.selectedItemAmount=0;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;JdTradeDetail1.get($scope.selectedItem.uuid).success(function(data){$scope.subItemList=
data.content;item.detailList=$scope.subItemList});$scope.displayAdvancedSearPanel=false};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel)JdTradeDetail1.get(item.uuid).success(function(data){$scope.subItemList=data.content;item.detailList=$scope.subItemList})};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};
$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS)};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.status==
"add")if($scope.domain=="PSO_ORDER_MST")console.info("add order mst...");else{if($scope.domain=="PSO_ORDER_DTL")console.info("add order dtl...")}else if($scope.status=="edit")if($scope.domain=="PSO_ORDER_MST")console.info("edit order mst...");else if($scope.domain=="PSO_ORDER_DTL")console.info("edit order dtl...")};$scope.deleteDetailAction=function(detail){};$scope.selectItemAction=function(event,item){$scope.stopEventPropagation(event);item.selectedRef=!item.selected;if(item.selected==false||item.selected==
undefined||item.selected==null){$scope.selectedItemSize+=1;$scope.selectedItemAmount+=item.orderTotalPrice}else{$scope.selectedItemSize-=1;$scope.selectedItemAmount-=item.orderTotalPrice;$scope.selectAllFlag=false}$scope.refreshMenuButtons()};$scope.confirmClickAction=function(event,item){$scope.stopEventPropagation(event);if(item.confirm==Constant.CONFIRM[2].value){$scope.showError("已成功审核并抛转的订单不能取消审核，订单号："+item.orderId);return false}if(angular.isUndefined(item.venderRemark)||item.venderRemark==null){$scope.showError("备注为空，不符合抛转电商销售单规则，订单号："+
item.orderId);return false}else{var orderFlagValid=false;angular.forEach(Constant.ORDER_FLAG,function(orderFlag){if(item.venderRemark.substring(0,1)==orderFlag.value)orderFlagValid=true});if(orderFlagValid===false){$scope.showError("备注不符合抛转电商销售单规则（数字1~6开头），订单号："+item.orderId);return false}}$scope.showConfirm("确认审核吗？","",function(){JdTradeMaster.confirm(item.uuid).success(function(){item.confirm=Constant.CONFIRM[2].value;$scope.refreshMenuButtons();$scope.showInfo("订单审核成功！")}).error(function(response){$scope.showError(response.message)})})};
$scope.cancelConfirmClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("confirm...");$scope.showConfirm("确认取消审核吗？","",function(){JdTradeMaster.cancelConfirm(item.uuid).success(function(data){angular.forEach(data,function(canceledItem){angular.forEach($scope.itemList,function(item){if(item.uuid==canceledItem.uuid)item.confirm=Constant.CONFIRM[1].value})});$scope.refreshMenuButtons();$scope.showInfo("订单取消审核成功！")}).error(function(response){$scope.showError(response.message)})})};
$scope.statusClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("status...")};$scope.releaseClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("release...")};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("delete...")};$scope.confirmAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("confirm all...");var uuids="";var count=0;var failUuids="";angular.forEach($scope.itemList,
function(item){if(item.selected===true){uuids+=item.uuid+",";count++;if(item.confirm==Constant.CONFIRM[2].value)failUuids+=item.orderId+", "}});if(count===0){$scope.showError("没有选择任何订单，请先选择订单！");return}if(failUuids!==""){$scope.showError("已成功审核并抛转的订单不能再次审核并抛转，订单号："+failUuids.substring(0,failUuids.length-2));return false}$scope.showConfirm("确认审核吗？","",function(){JdTradeMaster.confirm(uuids).success(function(){angular.forEach($scope.itemList,function(item){if(item.selected===true)item.confirm=Constant.CONFIRM[2].value});
$scope.refreshMenuButtons();$scope.showInfo("订单审核成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.cancelConfirmAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("cancel confirm all...");var uuids="";var count=0;var failUuids="";angular.forEach($scope.itemList,function(item){if(item.selected===true){uuids+=item.uuid+",";count++}});if(count===0){$scope.showError("没有选择任何订单，请先选择订单！");return}$scope.showConfirm("确认取消审核吗？","",function(){JdTradeMaster.cancelConfirm(uuids).success(function(data){angular.forEach(data,
function(canceledItem){angular.forEach($scope.itemList,function(item){if(item.uuid==canceledItem.uuid)item.confirm=Constant.CONFIRM[1].value})});$scope.refreshMenuButtons();$scope.showInfo("订单取消审核成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.mergeClickAction=function(event){$scope.stopEventPropagation(event);console.info("confirm all...");var uuids="";var count=0;var failUuids="";angular.forEach($scope.itemList,function(item){if(item.selected===true){uuids+=item.uuid+
",";count++}});if(count===0){$scope.showError("没有选择任何订单，请先选择订单！");return}$scope.showConfirm("确认合并吗？","",function(){JdTradeMaster.merge(uuids).success(function(){angular.forEach($scope.itemList,function(item){if(item.selected===true)item.confirm=Constant.CONFIRM[2].value});$scope.refreshMenuButtons();$scope.showInfo("订单合并成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("status all...")};
$scope.releaseAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("release all...")};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("delete all...")};$scope.selectAllAction=function(){angular.forEach($scope.itemList,function(item){if($scope.selectAllFlag)item.selected=true;else item.selected=false;item.selectedRef=item.selected});$scope.selectedItemSize=0;$scope.selectedItemAmount=0;if($scope.selectAllFlag)angular.forEach($scope.itemList,
function(item){$scope.selectedItemSize++;$scope.selectedItemAmount+=item.orderTotalPrice});$scope.refreshMenuButtons()};$scope.openEmployeeDlg=function(){$mdDialog.show({controller:"SelectEmployeeController",templateUrl:"app/src/app/jingdong/order/selectEmployeeDlg.html",parent:angular.element(document.body),targetEvent:event}).then(function(data){$scope.listFilterOption.employeeNo=data.no})};$scope.refreshMenuButtons=function(){$scope.disableMergeButton=false;var count=0;var venderId;var pin;var confirm;
var orderState;angular.forEach($scope.itemList,function(item){if(item.selectedRef){if(count===0){venderId=item.venderId;pin=item.pin;confirm=item.confirm;orderState=item.orderState}else if(venderId!=item.venderId||pin!=item.pin||confirm!=item.confirm||orderState!=item.orderState)$scope.disableMergeButton=true;count++}});if(count<=1||confirm==Constant.CONFIRM[2].value||orderState!=Constant.JINGDONG_STATUS["WAIT_SELLER_STOCK_OUT"].value)$scope.disableMergeButton=true;$scope.disableBatchMenuButtons()};
$scope.disableBatchMenuButtons=function(){var selectedCount=0;var confirm="";var diffConfirm=false;angular.forEach($scope.itemList,function(item,index){if(item.selectedRef){selectedCount++;if(confirm=="")confirm=item.confirm;else if(confirm!=item.confirm)diffConfirm=true}});if(selectedCount==0){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true}else if(diffConfirm==true){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true}else if(confirm=="2"){$scope.disabledBatchConfirm=
true;$scope.disabledBatchCancelConfirm=false}else{$scope.disabledBatchConfirm=false;$scope.disabledBatchCancelConfirm=true}}});
angular.module("IOne-Production").controller("SelectEmployeeController",function($scope,$mdDialog,EmployeeService){$scope.pageOption={sizePerPage:5,currentPage:0,totalPage:0,totalElements:0,displayModel:0};$scope.refreshEmployeeList=function(){EmployeeService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.searchKeyword).success(function(data){$scope.employeeList=data.content;$scope.pageOption.totalElements=data.totalElements;$scope.pageOption.totalPage=data.totalPages})};
$scope.refreshEmployeeList();$scope.selectEmployee=function(employee){$scope.employee=employee;$mdDialog.hide($scope.employee)};$scope.cancelDlg=function(){$mdDialog.cancel()}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/ecommerce-orders-change",{controller:"EpsOrderChangeController",templateUrl:"app/src/app/eps/orderChange/orderChange.html"})}]);
angular.module("IOne-Production").controller("EpsOrderChangeController",function($q,$scope,$mdDialog,EpsOrderChangeMaster,EpsOrderChangeDetail,EpsOrderChangeExtendDetail,Constant,SaleTypes){$scope.selectedItemSize=0;$scope.selectedItemAmount=0;$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={select:{status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value,transferPsoFlag:Constant.TRANSFER_PSO_FLAG[0].value},onlyLatest:"2"};$scope.menuDisplayOption=
{"confirm":{display:true,name:"审核",uuid:"94b40025-f908-40e4-8237-26a816a837db"},"revertConfirm":{display:true,name:"取审",uuid:"f1c87d92-2979-482b-8577-4a94410bd369"},"transfer":{display:true,name:"抛转",uuid:"66586826-5f8d-4645-8db7-7d11c9559887"},"batchConfirm":{display:true,name:"批量审核",uuid:"9fea08e7-1428-48f0-9c5d-0f65de3dfbaa"},"batchRevertConfirm":{display:true,name:"批量取审",uuid:"07f4f819-ff6c-459b-9e9b-679a9491c30b"},"batchTransfer":{display:true,name:"批量拋转",uuid:"66d9553b-2ce6-4f5b-ba6a-78af9d613549"},
"detailConfirm":{display:true,name:"审核",uuid:"4c4f7396-a8bd-4b15-8c93-7491c40e25ad"},"detailRevertConfirm":{display:true,name:"取审",uuid:"15b5713e-9234-4a07-8ce7-2aae0b8929b5"},"detailTransfer":{display:true,name:"抛转",uuid:"d1da8e5d-504c-4dc5-95c8-b9e6834c17f4"}};$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.refreshList=function(){EpsOrderChangeMaster.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption).success(function(data){$scope.itemList=
data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;$scope.disableBatchMenuButtons()}).error(function(response){$scope.showError(response.message)})};$scope.getMenuAuthData($scope.RES_UUID_MAP.PSO.SO_CHANGE.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)});$scope.$watch("listFilterOption.select",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},
true);$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()}};$scope.selectAllFlag=false;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;$scope.selectedItem.orderDate=new Date(item.orderDate);$scope.selectedItem.predictDeliverDate=new Date(item.predictDeliverDate);EpsOrderChangeDetail.get($scope.selectedItem.uuid).success(function(data){$scope.selectedItem.detailList=
data.content}).error(function(response){$scope.showError(response.message)})};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;$scope.selectedItem=null};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;EpsOrderChangeDetail.get(item.uuid).success(function(data){item.detailList=data.content;if(data.content.length===0)$scope.showWarn("未查找到对应的商品信息！")}).error(function(response){$scope.showError(response.message)})};
$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS)};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status=
"add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.status=="add"){$scope.addObjectUuidParameters($scope.selectedItem);EpsOrderChangeMaster.add($scope.selectedItem.uuid,$scope.selectedItem).success(function(data){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);$scope.showInfo("变更单创建成功");$scope.refreshList();$scope.selectedItem=data;EpsOrderChangeDetail.get($scope.selectedItem.uuid).success(function(data){$scope.selectedItem.detailList=
data.content}).error(function(response){$scope.showError("获取变更单单身信息失败，原因："+response.message)})}).error(function(response){$scope.showError("变更单创建失败, 原因: "+response.message)})}else if($scope.status=="edit"){$scope.addObjectUuidParameters($scope.selectedItem);EpsOrderChangeMaster.modify($scope.selectedItem.uuid,$scope.selectedItem).success(function(data){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);$scope.showInfo("变更单修改成功");$scope.refreshList();$scope.selectedItem=data;EpsOrderChangeDetail.get($scope.selectedItem.uuid).success(function(data){$scope.selectedItem.detailList=
data.content}).error(function(response){$scope.showError("获取变更单单身信息失败，原因："+response.message)})}).error(function(response){$scope.showError("变更单修改失败, 原因: "+response.message)})}};$scope.addObjectUuidParameters=function(workingEpsOrderChangeMaster){if(workingEpsOrderChangeMaster.channel!=null)workingEpsOrderChangeMaster.channelUuid=workingEpsOrderChangeMaster.channel.uuid;if(workingEpsOrderChangeMaster.deliverWay!=null)workingEpsOrderChangeMaster.deliverWayUuid=workingEpsOrderChangeMaster.deliverWay.uuid;
if(workingEpsOrderChangeMaster.groupUser!=null)workingEpsOrderChangeMaster.groupUserUuid=workingEpsOrderChangeMaster.groupUser.uuid;if(workingEpsOrderChangeMaster.receiveDistrict!=null)workingEpsOrderChangeMaster.receiveDistrictUuid=workingEpsOrderChangeMaster.receiveDistrict.uuid;if(workingEpsOrderChangeMaster.predictDeliverDate)workingEpsOrderChangeMaster.predictDeliverDate=moment(workingEpsOrderChangeMaster.predictDeliverDate).format("YYYY-MM-DD")};$scope.closeDetailAction=function(detail){EpsOrderChangeDetail.close($scope.selectedItem.uuid,
detail.uuid).success(function(detailRep){detail.status=Constant.STATUS[2].value;$scope.showInfo("变更单单身结案成功！")}).error(function(response){$scope.showError("变更单单身结案失败，原因："+response.message)})};$scope.selectItemAction=function(event,item){$scope.stopEventPropagation(event);item.selectedRef=!item.selected;if(item.selected==false||item.selected==undefined||item.selected==null){$scope.selectedItemSize+=1;$scope.selectedItemAmount+=item.orderAmount}else{$scope.selectedItemSize-=1;$scope.selectedItemAmount-=
item.orderAmount;$scope.selectAllFlag=false}$scope.disableBatchMenuButtons()};$scope.confirmClickAction=function(event,item,confirmVal){$scope.stopEventPropagation(event);console.info("confirm...");var action="审核";var popMessage="审核后变更将会生效，确认审核吗？";if(confirmVal==Constant.CONFIRM[1].value){action="取消审核";popMessage="取消审核后电商销售单将会回退到之前版本，确认取消审核吗？"}$scope.showConfirm(popMessage,"",function(){if(confirmVal==Constant.CONFIRM[1].value)EpsOrderChangeMaster.cancelConfirm(item.uuid).success(function(){item.confirm=
confirmVal;$scope.updateOrderChangeDetailsConfirm(item);$scope.showInfo("电商销售单变更单"+action+"成功！");$scope.disableBatchMenuButtons()}).error(function(response){$scope.showError(response.message)});else EpsOrderChangeMaster.confirm(item.uuid).success(function(){item.confirm=confirmVal;$scope.updateOrderChangeDetailsConfirm(item);$scope.showInfo("电商销售单变更单"+action+"成功！");$scope.disableBatchMenuButtons()}).error(function(response){$scope.showError(response.message)})})};$scope.statusClickAction=function(event,
item){$scope.stopEventPropagation(event);console.info("confirm...");$scope.showConfirm("确认启用吗？","",function(){EpsOrderChangeMaster.modify(item.uuid,{"status":"1"}).success(function(){item.status=Constant.STATUS[1].value;$scope.showInfo("启用成功！");$scope.disableBatchMenuButtons()}).error(function(response){$scope.showError(response.message)})})};$scope.cancelStatusClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("confirm...");$scope.showConfirm("确认禁用吗？","",function(){EpsOrderChangeMaster.modify(item.uuid,
{"status":"2"}).success(function(){item.status=Constant.STATUS[2].value;$scope.showInfo("禁用成功！");$scope.disableBatchMenuButtons()}).error(function(response){$scope.showError(response.message)})})};$scope.transferClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("transfer...");$scope.showConfirm("确认抛转吗？","",function(){var uuids=[];uuids.push(item.uuid);EpsOrderChangeMaster.transfer(uuids).success(function(response){if(response&&response[0].code!=0)$scope.showError("抛转失败："+
response[0].msg);else{item.transferPsoFlag=Constant.TRANSFER_PSO_FLAG[1].value;$scope.updateOrderChangeDetailsTransfer(item);$scope.showInfo("电商销售单变更抛转成功！");$scope.disableBatchMenuButtons()}}).error(function(response){$scope.showError(response.message)})})};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("delete...")};$scope.confirmAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");
return}$scope.showConfirm("确认审核吗","",function(){var promises=[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected){var response=EpsOrderChangeMaster.confirm(item.uuid).success(function(){item.confirm="2";$scope.updateOrderChangeDetailsConfirm(item)}).error(function(response){bError=true;$scope.showError(item.no+" 审核失败："+response.message)});promises.push(response)}});$q.all(promises).then(function(data){if(!bError)$scope.showInfo("审核成功！");$scope.disableBatchMenuButtons()})})};
$scope.cancelConfirmAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");return}$scope.showConfirm("确认取消审核吗","",function(){var promises=[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected){var response=EpsOrderChangeMaster.cancelConfirm(item.uuid).success(function(){item.confirm="1";$scope.updateOrderChangeDetailsConfirm(item)}).error(function(response){bError=true;$scope.showError(item.no+" 取消审核失败："+
response.message)});promises.push(response)}});$q.all(promises).then(function(data){if(!bError)$scope.showInfo("取消审核成功！");$scope.disableBatchMenuButtons()})})};$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");return}$scope.showConfirm("确认启用吗","",function(){var promises=[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected){var response=EpsOrderChangeMaster.modify(item.uuid,{"status":"1"}).success(function(){item.status=
Constant.STATUS[1].value}).error(function(response){bError=true;$scope.showError(item.no+" 启用失败："+response.message)});promises.push(response)}});$q.all(promises).then(function(data){if(!bError)$scope.showInfo("启用成功！");$scope.disableBatchMenuButtons()})})};$scope.cancelStatusAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");return}$scope.showConfirm("确认禁用吗","",function(){var promises=[];var bError=false;angular.forEach($scope.itemList,
function(item){if(item.selected){var response=EpsOrderChangeMaster.modify(item.uuid,{"status":"2"}).success(function(){item.status=Constant.STATUS[2].value}).error(function(response){bError=true;$scope.showError(item.no+" 禁用失败："+response.message)});promises.push(response)}});$q.all(promises).then(function(data){if(!bError)$scope.showInfo("禁用成功！");$scope.disableBatchMenuButtons()})})};$scope.transferAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");
return}$scope.showConfirm("确认抛转吗","",function(){var uuids=[];angular.forEach($scope.itemList,function(item){if(item.selected)uuids.push(item.uuid)});var response=EpsOrderChangeMaster.transfer(uuids).success(function(){angular.forEach($scope.itemList,function(item){if(item.selected){item.transferPsoFlag=Constant.TRANSFER_PSO_FLAG[1].value;$scope.updateOrderChangeDetailsTransfer(item)}});$scope.showInfo("抛转成功！")}).error(function(response){$scope.showError(item.no+" 抛转失败："+response.message)})})};$scope.deleteAllClickAction=
function(event){$scope.stopEventPropagation(event);console.info("delete all...")};$scope.selectAllAction=function(){angular.forEach($scope.itemList,function(item){if($scope.selectAllFlag)item.selected=true;else item.selected=false;item.selectedRef=item.selected});$scope.selectedItemSize=0;$scope.selectedItemAmount=0;if($scope.selectAllFlag)angular.forEach($scope.itemList,function(item){$scope.selectedItemSize++;$scope.selectedItemAmount+=item.orderAmount});$scope.disableBatchMenuButtons()};$scope.refreshExtendDetailTab=
function(selectedItem){$scope.selectedItem.extendDetailList=[];angular.forEach($scope.selectedItem.detailList,function(orderDetail,index){EpsOrderChangeExtendDetail.get(orderDetail.uuid).success(function(data){if(data.totalElements>0)$scope.selectedItem.extendDetailList=$scope.selectedItem.extendDetailList.concat(data.content)}).error(function(response){$scope.showError(response.message)})})};$scope.disableBatchMenuButtons=function(){var selectedCount=0;var confirm="";var status="";var transferFlag=
"";var diffConfirm=false;var diffStatus=false;var diffTransferFlag=false;angular.forEach($scope.itemList,function(item,index){if(item.selectedRef){selectedCount++;if(confirm=="")confirm=item.confirm;else if(confirm!=item.confirm)diffConfirm=true;if(status=="")status=item.status;else if(status!=item.status)diffStatus=true;if(transferFlag=="")transferFlag=item.transferPsoFlag;else if(transferFlag!=item.transferPsoFlag)diffTransferFlag=true}});if(selectedCount==0){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=
true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchTransfer=true}else{if(diffConfirm==true){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true}else if(confirm=="2"){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=false}else{$scope.disabledBatchConfirm=false;$scope.disabledBatchCancelConfirm=true}if(diffStatus==true){$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true}else if(status=="1"){$scope.disabledBatchStatus=
true;$scope.disabledBatchCancelStatus=false}else{$scope.disabledBatchStatus=false;$scope.disabledBatchCancelStatus=true}if(diffTransferFlag==true)$scope.disabledBatchTransfer=true;else if(transferFlag=="1")$scope.disabledBatchTransfer=true;else $scope.disabledBatchTransfer=false}};$scope.updateOrderChangeDetailsConfirm=function(item){if(item.detailList!=null)angular.forEach(item.detailList,function(detail){detail.confirm=item.confirm})};$scope.updateOrderChangeDetailsTransfer=function(item){if(item.detailList!=
null)angular.forEach(item.detailList,function(detail){detail.transferPsoFlag=item.transferPsoFlag})};$scope.openOrderDlg=function(){$mdDialog.show({controller:"SelectEpsOrderController",templateUrl:"app/src/app/eps/orderChange/selectOrderDlg.html",parent:angular.element(document.body),targetEvent:event}).then(function(data){$scope.selectedItem=data;$scope.selectedItem.orderDate=new Date(data.orderDate);$scope.selectedItem.predictDeliverDate=new Date(data.predictDeliverDate);$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);
$scope.status="add"})};SaleTypes.getAll().success(function(data){$scope.saleTypes=data});$scope.openDetailEditorDlg=function(epsOrderChangeDetail){if($scope.selectedItem.transferPsoFlag=="1"){$scope.showError("已抛转的变更单不能修改。");return}$mdDialog.show({controller:"EpsOrderChangeDetailController",templateUrl:"app/src/app/eps/orderChange/detailEditorDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{workingOrderChangeDetail:epsOrderChangeDetail,saleTypes:$scope.saleTypes}}).then(function(data){EpsOrderChangeDetail.modify($scope.selectedItem.uuid,
epsOrderChangeDetail.uuid,data.workingOrderChangeDetail).success(function(detailRep){$scope.selectedItem=detailRep.epsOrderChange;EpsOrderChangeDetail.get($scope.selectedItem.uuid).success(function(data){$scope.selectedItem.detailList=data.content;$scope.selectedItem.extendDetailList=[];angular.forEach($scope.selectedItem.detailList,function(epsOrderChangeDetail,index){EpsOrderChangeExtendDetail.get(epsOrderChangeDetail.uuid).success(function(extDetailData){if(extDetailData.totalElements>0)$scope.selectedItem.extendDetailList=
$scope.selectedItem.extendDetailList.concat(extDetailData.content)}).error(function(response){$scope.showError("刷新子单身数据失败，原因："+response.message)})})}).error(function(response){$scope.showError("刷新单身数据失败，原因："+response.message)});$scope.showInfo("变更单单身修改成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.openChannelDlg=function(){$mdDialog.show({controller:"EChannelSearchController",templateUrl:"app/src/app/taobao_data/ecommerce_orders/selectChannel.html",parent:angular.element(document.body),
targetEvent:event}).then(function(data){$scope.selectedItem.channel=data;$scope.selectedItem.channelUuid=data.uuid;if(data.mall!=null)$scope.selectedItem.mallUuid=data.mall.uuid})};$scope.openDelivWayDlg=function(){$mdDialog.show({controller:"EDelivWaySearchController",templateUrl:"app/src/app/taobao_data/ecommerce_orders/selectDelivWay.html",parent:angular.element(document.body),targetEvent:event}).then(function(data){$scope.selectedItem.deliverWay=data;$scope.selectedItem.deliverWayUuid=data.uuid})};
$scope.openGroupUserDlg=function(){$mdDialog.show({controller:"EGroupUserSearchController",templateUrl:"app/src/app/taobao_data/ecommerce_orders/selectGroupUser.html",parent:angular.element(document.body),targetEvent:event}).then(function(data){$scope.selectedItem.groupUser=data;$scope.selectedItem.groupUserUuid=data.uuid})};$scope.openAreaDlg=function(){$mdDialog.show({controller:"EAreaSearchController",templateUrl:"app/src/app/taobao_data/ecommerce_orders/selectArea.html",parent:angular.element(document.body),
targetEvent:event}).then(function(data){$scope.selectedItem.receiveDistrict=data;$scope.selectedItem.receiveDistrictUuid=data.uuid})}});
angular.module("IOne-Production").controller("EpsOrderChangeDetailController",function($scope,$mdDialog,workingOrderChangeDetail,saleTypes){$scope.workingOrderChangeDetail=angular.copy(workingOrderChangeDetail);$scope.itemSearchParam={confirm:2,release:2,status:1,eshopType:2,assemblingFlag:1};$scope.saleTypes=angular.copy(saleTypes);var eSaleType=[];var i=0;angular.forEach(saleTypes.content,function(saleType){if(saleType.no=="ST01")eSaleType[i++]=saleType;if(saleType.no=="ST04")eSaleType[i++]=saleType});
$scope.saleTypes=eSaleType;$scope.disableOrderPrice=false;$scope.isChangingProduction=false;$scope.showChangingProductionPanel=function(){$scope.isChangingProduction=true};$scope.hideChangingProductionPanel=function(){$scope.isChangingProduction=false};$scope.setZero=function(saleType){if(saleType.name=="赠送"){$scope.workingOrderChangeDetail.orderPrice=0;$scope.disableOrderPrice=true}else $scope.disableOrderPrice=false};$scope.selectBom=function(production){if(production){$scope.workingOrderChangeDetail.item=
production;$scope.workingOrderChangeDetail.itemUuid=production.uuid;$scope.isChangingProduction=false}};$scope.hideDlg=function(){$mdDialog.hide({"workingOrderChangeDetail":$scope.workingOrderChangeDetail})};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").controller("SelectEpsOrderController",function($scope,Constant,$mdDialog,EcommerceOrdersMaster){$scope.STATUS=Constant.STATUS;$scope.CONFIRM=Constant.CONFIRM;$scope.TRANSFER_PSO_FLAG=Constant.TRANSFER_PSO_FLAG;$scope.orderStatus=Constant.STATUS[0].value;$scope.orderConfirm=Constant.CONFIRM[0].value;$scope.orderTransferPsoFlag=Constant.TRANSFER_PSO_FLAG[0].value;$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:0,totalElements:0,displayModel:0};$scope.refreshOrderList=
function(){EcommerceOrdersMaster.getAll(12,$scope.pageOption.currentPage,null,$scope.orderConfirm,$scope.orderStatus,$scope.orderTransferPsoFlag,null,$scope.orderNo).success(function(data){$scope.orderList=data.content;$scope.pageOption.totalElements=data.totalElements;$scope.pageOption.totalPage=data.totalPages})};$scope.refreshOrderList();$scope.selectOrder=function(order){$scope.selectedEpsOrder=order;$mdDialog.hide($scope.selectedEpsOrder)};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").service("JdTradeMaster",function($http,Constant){this.getAll=function(sizePerPage,page,filter,resUuid){var confirm=filter.confirm==0?"":filter.confirm;var orderFlag=filter.orderFlag==0?"":filter.orderFlag;var orderState=filter.orderState==0?"":filter.orderState;var url="jdTrades?size\x3d"+sizePerPage+"\x26page\x3d"+page;if(confirm!=="")url=url+"\x26confirm\x3d"+confirm;if(orderFlag!=="")url=url+"\x26orderFlag\x3d"+orderFlag;if(orderState!=="")url=url+"\x26orderState\x3d"+
orderState;if(filter.orderId!==null&&filter.orderId!==undefined)url=url+"\x26orderId\x3d"+filter.orderId;if(filter.employeeNo!==null&&filter.employeeNo!==undefined)url=url+"\x26employeeNo\x3d"+filter.employeeNo;if(filter.startOrderDate!==null&&filter.startOrderDate!==undefined){var startOrderDate=new Date(filter.startOrderDate);startOrderDate=moment(startOrderDate).format("YYYY-MM-DD 00:00:00");url=url+"\x26startOrderDate\x3d"+startOrderDate}if(filter.endOrderDate!==null&&filter.endOrderDate!==undefined){var endOrderDate=
new Date(filter.endOrderDate);endOrderDate=moment(endOrderDate).format("YYYY-MM-DD 23:59:59");url=url+"\x26endOrderDate\x3d"+endOrderDate}if(filter.startPaymentConfirmDate!==null&&filter.startPaymentConfirmDate!==undefined){var startPaymentConfirmDate=new Date(filter.startPaymentConfirmDate);startPaymentConfirmDate=moment(startPaymentConfirmDate).format("YYYY-MM-DD 00:00:00");url=url+"\x26startPaymentConfirmDate\x3d"+startPaymentConfirmDate}if(filter.endPaymentConfirmDate!==null&&filter.endPaymentConfirmDate!==
undefined){var endPaymentConfirmDate=new Date(filter.endPaymentConfirmDate);endPaymentConfirmDate=moment(endPaymentConfirmDate).format("YYYY-MM-DD 23:59:59");url=url+"\x26endPaymentConfirmDate\x3d"+endPaymentConfirmDate}if(filter.pin!==null&&filter.pin!==undefined)url=url+"\x26pin\x3d"+filter.pin;if(filter.venderRemark!=null)url=url+"\x26venderRemark\x3d"+filter.venderRemark;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;console.info(Constant.BACKEND_BASE+url);return $http.get(Constant.BACKEND_BASE+
url)};this.confirm=function(uuids){return $http.patch(Constant.BACKEND_BASE+"/jdTrades/"+uuids,{"action":"2"})};this.merge=function(uuids){return $http.patch(Constant.BACKEND_BASE+"/jdTrades/"+uuids,{"action":"3"})};this.cancelConfirm=function(uuids){return $http.patch(Constant.BACKEND_BASE+"/jdTrades/"+uuids,{"action":"4"})}});
angular.module("IOne-Production").service("JdTradeDetail1",function($http,Constant){this.get=function(masterUuid){return $http.get(Constant.BACKEND_BASE+"/jdTrades/"+masterUuid+"/details")}});angular.module("IOne-Production").service("JdTradeDetail2",function($http,Constant){this.get=function(masterUuid){return $http.get(Constant.BACKEND_BASE+"/jdTrades/"+masterUuid+"/details2")}});
angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/cbi/order_type",{controller:"CBIOrderTypeController",templateUrl:"app/src/app/cbi/order_type/orderType.html"})}]);
angular.module("IOne-Production").controller("CBIOrderTypeController",function($scope,CBIOrderTypeService,Constant,$mdDialog,$q){$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={select:{status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value,prodType:Constant.PROD_TYPE[0].value},no:"",name:"",keyWord:""};$scope.menuDisplayOption={"switchConfirm":{display:true,name:"审核/取消审核",uuid:"58C4425E-773C-40E5-B1C6-AEB5DA658648"},"switchStatus":{display:true,
name:"启用/禁用",uuid:"9DDA41A4-737B-405C-87CE-584976ADF772"},"batchConfirm":{display:true,name:"批量审核",uuid:"D37FA275-A322-43BB-A8AA-1654B7FEE065"},"batchRevertConfirm":{display:true,name:"批量取审",uuid:"16D4D391-AE40-4D4D-A542-4515B0366FB7"},"batchStatus":{display:true,name:"批量启用",uuid:"C290BC0F-9493-4E0D-B076-293FAF164E77"},"batchRevertStatus":{display:true,name:"批量禁用",uuid:"62FB3C9C-2220-4DAF-8A17-C768174BC5F3"},"batchDelete":{display:true,name:"批量删除",uuid:"E91C6B05-BCBB-49AC-AB0C-9CB9902F9997"},"detailConfirm":{display:true,
name:"审核",uuid:"3ED67CE3-0B40-48E8-9802-036D6A4CFDC4"},"detailRevertConfirm":{display:true,name:"取审",uuid:"2D8338B3-7FB6-4378-9381-59F8E5B8D7EB"},"detailStatus":{display:true,name:"启用",uuid:"805037A9-BA7D-415E-8919-2BED117A1B0F"},"detailRevertStatus":{display:true,name:"禁用",uuid:"98DE89EF-FF40-4DBF-85FC-3CDD2D314063"},"detailDelete":{display:true,name:"删除",uuid:"8296E03D-65F0-4FE1-8E89-89CA82BBC6F1"}};$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchStatus=
true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true;$scope.sortByField="no";$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.refreshList=function(){CBIOrderTypeService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.select.confirm,$scope.listFilterOption.select.status,$scope.listFilterOption.no,$scope.listFilterOption.name,$scope.listFilterOption.select.prodType,$scope.listFilterOption.keyWord,
$scope.RES_UUID_MAP.CBI.ORDER_TYPE.RES_UUID).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;$scope.selectAllFlag=false;$scope.selectedItemSize=0})};$scope.getMenuAuthData($scope.RES_UUID_MAP.CBI.ORDER_TYPE.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data);console.info($scope.menuAuthDataMap)});$scope.$watch("listFilterOption.select",function(){$scope.pageOption.currentPage=
0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()}};$scope.selectAllFlag=false;$scope.selectedItemSize=0;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;item.detailList=$scope.subItemList;$scope.displayAdvancedSearPanel=false};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=
!$scope.displayAdvancedSearPanel;$scope.selectedItem=null};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel)item.detailList=item};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);$scope.refreshList()};$scope.hideItemDetailsAction=function(event){$scope.stopEventPropagation(event);$scope.selectedItem=null;
$scope.refreshList()};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.source.confirm==
"2"&&$scope.source.status=="2"){$scope.showError("不允许状态是已审核又无效,请调整后再保存");return}if($scope.status=="add"){if($scope.domain=="CBI_BASE_ORDER_TYPE")CBIOrderTypeService.add($scope.source).success(function(data){$scope.showInfo("新增数据成功。")}).error(function(data){$scope.showError("新增失败:"+"\x3cbr\x3e"+data.message)})}else if($scope.status=="edit")if($scope.domain=="CBI_BASE_ORDER_TYPE")CBIOrderTypeService.modify($scope.source.uuid,$scope.source).success(function(data){$scope.showInfo("修改数据成功。");$scope.source=
data;$scope.selectedItem=data;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)}).error(function(data){$scope.showError("修改失败:"+"\x3cbr\x3e"+data.message);$scope.source=angular.copy($scope.selectedItemBackUp);$scope.selectedItem=angular.copy($scope.selectedItemBackUp)})};$scope.deleteDetailAction=function(detail){};$scope.selectItemAction=function(event,item){$scope.stopEventPropagation(event);item.selectedRef=!item.selected;if(item.selected==false||item.selected==undefined||item.selected==
null)$scope.selectedItemSize+=1;else{$scope.selectedItemSize-=1;$scope.selectAllFlag=false}$scope.disableBatchMenuButtons()};$scope.confirmClickAction=function(event,item){$scope.stopEventPropagation(event);if(item.confirm==Constant.CONFIRM[2].value)$scope.showConfirm("确认取消审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};CBIOrderTypeService.modify(item.uuid,UpdateInput).success(function(){item.confirm=Constant.CONFIRM[1].value;$scope.disableBatchMenuButtons();
$scope.showInfo("取消审核成功！")}).error(function(response){$scope.showError(response.message)})});else $scope.showConfirm("确认审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};CBIOrderTypeService.modify(item.uuid,UpdateInput).success(function(){item.confirm=Constant.CONFIRM[2].value;$scope.disableBatchMenuButtons();$scope.showInfo("审核成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.confirmSwitchAction=function(event,item){$scope.stopEventPropagation(event);
if(item.confirm==Constant.CONFIRM[2].value)$scope.showConfirm("确认取消审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};CBIOrderTypeService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("修改数据成功。")})},function(){item.confirm=Constant.CONFIRM[2].value});else{if(item.status==Constant.STATUS[2].value){$scope.showWarn("项目是失效状态,请先启用后再审核");item.confirm=Constant.CONFIRM[2].value;return}$scope.showConfirm("确认审核吗？",
"",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};CBIOrderTypeService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("修改数据成功。")})},function(){item.confirm=Constant.CONFIRM[1].value})}};$scope.statusClickAction=function(event,item){$scope.stopEventPropagation(event);if(item.status==Constant.STATUS[1].value)$scope.showConfirm("确认改为失效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value,
confirm:Constant.CONFIRM[1].value};CBIOrderTypeService.modify(item.uuid,UpdateInput).success(function(){item.status=Constant.STATUS[2].value;item.confirm=Constant.CONFIRM[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("修改为失效成功！")}).error(function(response){$scope.showError(response.message)})});else $scope.showConfirm("确认改为生效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};CBIOrderTypeService.modify(item.uuid,UpdateInput).success(function(){item.status=
Constant.STATUS[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("修改为生效成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.statusSwitchAction=function(event,item){$scope.stopEventPropagation(event);if(item.status==Constant.STATUS[2].value)$scope.showConfirm("确认修改启用状态为有效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};CBIOrderTypeService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("修改数据成功。")})},
function(){item.status=Constant.STATUS[2].value});else $scope.showConfirm("确认修改启用状态为无效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value,confirm:Constant.CONFIRM[1].value};CBIOrderTypeService.modify(UpdateInput.uuid,UpdateInput).success(function(){item.confirm=Constant.CONFIRM[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("修改数据成功。")})},function(){item.status=Constant.STATUS[1].value})};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);
if(item.status!="1"||item.confirm!="1"){$scope.showWarn("仅当预订单类型的状态是有效且未审核时才允许删除!");return}$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){CBIOrderTypeService.delete(item.uuid).success(function(){$scope.selectedItem=null;$scope.refreshList();$scope.showInfo("删除数据成功。")})})};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var noDeleteNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.status=="1"&&item.confirm==
"1"){var response=CBIOrderTypeService.delete(item.uuid).success(function(){});promises.push(response);count++}else noDeleteNos=noDeleteNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任何状态是有效且未审核的可删除项目，请选择！");return}$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){if(noDeleteNos!=="")$scope.showWarn("以下状态是失效或已审核的的项目将不会删除："+"\x3cbr\x3e"+noDeleteNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("删除成功！")},function(data){$scope.showError(data.message);$scope.showError(data.data.message)})})};
$scope.confirmAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var confirmedNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.confirm!=Constant.CONFIRM[2].value){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};var response=CBIOrderTypeService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else confirmedNos=confirmedNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任何未审核的项目，请先选择！");
return}if(confirmedNos!=="")$scope.showWarn("以下已审核过的项目将不再次审核："+"\x3cbr\x3e"+confirmedNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("审核成功！")},function(data){$scope.showError(data.message);$scope.showError(data.data.message)})};$scope.revertConfirmAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var unConfirmedNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.confirm==Constant.CONFIRM[2].value){var UpdateInput=
{uuid:item.uuid,confirm:Constant.CONFIRM[1].value};var response=CBIOrderTypeService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else unConfirmedNos=unConfirmedNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任已审核的项目，请先选择！");return}if(unConfirmedNos!=="")$scope.showWarn("以下未审核过的项目将不执行取消审核："+unConfirmedNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("取消审核成功！")},function(data){$scope.showError(data.data.message);$scope.showError(data.message)})};
$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var effectiveNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.status!=Constant.STATUS[1].value){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};var response=CBIOrderTypeService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else effectiveNos=effectiveNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任何失效的项目，请先选择！");
return}if(effectiveNos!=="")$scope.showWarn("以下已生效的项目将不再次修改："+"\x3cbr\x3e"+effectiveNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("生效成功！")},function(data){$scope.showError(data.message);$scope.showError(data.data.message)})};$scope.revertStatusAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var uneffectiveNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.status==Constant.STATUS[1].value){var UpdateInput=
{uuid:item.uuid,status:Constant.STATUS[2].value,confirm:Constant.CONFIRM[1].value};var response=CBIOrderTypeService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else uneffectiveNos=uneffectiveNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择生效的项目，请先选择！");return}if(uneffectiveNos!=="")$scope.showWarn("以下失效的项目将不再次修改："+uneffectiveNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("失效成功！")},function(data){$scope.showError(data.data.message);
$scope.showError(data.message)})};$scope.selectAllAction=function(){angular.forEach($scope.itemList,function(item){if($scope.selectAllFlag)item.selected=true;else item.selected=false;item.selectedRef=item.selected});$scope.selectedItemSize=0;$scope.selectedItemAmount=0;if($scope.selectAllFlag)angular.forEach($scope.itemList,function(){$scope.selectedItemSize++});$scope.disableBatchMenuButtons()};$scope.disableBatchMenuButtons=function(){var selectedCount=0;var confirm="";var status="";var diffConfirm=
false;var diffStatus=false;angular.forEach($scope.itemList,function(item,index){if(item.selectedRef){selectedCount++;if(confirm=="")confirm=item.confirm;else if(confirm!=item.confirm)diffConfirm=true;if(status=="")status=item.status;else if(status!=item.status)diffStatus=true}});if(selectedCount==0){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}else{if(diffConfirm==true){$scope.disabledBatchConfirm=
true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchDelete=true}else if(confirm=="2"){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=false;$scope.disabledBatchDelete=true}else{$scope.disabledBatchConfirm=false;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchDelete=false}if(diffStatus==true){$scope.disabledBatchConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}else if(status=="1"){$scope.disabledBatchStatus=
true;$scope.disabledBatchCancelStatus=false}else{$scope.disabledBatchConfirm=true;$scope.disabledBatchStatus=false;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}}}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/ocm/parameters",{controller:"OCMParametersController",templateUrl:"app/src/app/ocm/parameters/parameters.html"})}]);
angular.module("IOne-Production").controller("OCMParametersController",function($scope,$q,OCMParametersService,Constant){$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:0,totalElements:0};$scope.listFilterOption={coefficient:"",discount:""};$scope.menuDisplayOption={"delete":{display:true,name:"删除",uuid:""},"query":{display:true,name:"查询",uuid:""},"add":{display:true,name:"添加",uuid:""},"edit":{display:true,name:"修改",uuid:""}};$scope.selectedItem=null;$scope.refreshList=function(){OCMParametersService.getAllWithPaging($scope.pageOption.sizePerPage,
$scope.pageOption.currentPage,$scope.listFilterOption.coefficient,$scope.listFilterOption.discount).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements})};$scope.refreshList();$scope.isAuthorized=function(option){if($scope.menuDisplayOption[option].display&&($scope.menuAuthDataMap[$scope.menuDisplayOption[option].uuid]||$scope.isAdmin()||!$scope.menuDisplayOption[option].uuid))return true;return false};
$scope.showDeleteMenuItem=function(){return $scope.isAuthorized("delete")};$scope.showQueryButton=function(){return $scope.isAuthorized("query")};$scope.showAddButton=function(){return $scope.isAuthorized("add")};$scope.showEditButton=function(){return $scope.isAuthorized("edit")};$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.showItemDetailsAction=function(item){$scope.selectedItem=item};$scope.hideItemDetailsAction=function(event,item){$scope.stopEventPropagation(event);
$scope.selectedItem=null};$scope.returnToViewUIAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS)};$scope.queryAction=function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.deleteItemAction=function(event,
item){$scope.stopEventPropagation(event);$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){OCMParametersService.delete(item.uuid).success(function(){$scope.selectedItem=null;$scope.refreshList();$scope.showInfo("删除数据成功。")})})};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)};$scope.saveItemAction=function(){if($scope.status==
"add"){if($scope.domain=="OCM_PARAMETER")OCMParametersService.add($scope.source).success(function(data){$scope.refreshList();$scope.showInfo("新增数据成功。")}).error(function(){$scope.showError("新增失败。")})}else if($scope.status=="edit")if($scope.domain=="OCM_PARAMETER")OCMParametersService.modify($scope.source.uuid,$scope.source).success(function(data){$scope.showInfo("修改数据成功。");$scope.source=data;$scope.selectedItem=data;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)}).error(function(data){$scope.showError("修改失败:"+
"\x3cbr\x3e"+data.message);$scope.source=angular.copy($scope.selectedItemBackUp);$scope.selectedItem=angular.copy($scope.selectedItemBackUp)})}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/cbi/payWay",{controller:"PayWayController",templateUrl:"app/src/app/cbi/pay_way/payWay.html"})}]);
angular.module("IOne-Production").controller("PayWayController",function($scope,$q,CBIPayWayService,Constant){$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:0,totalElements:0};$scope.listFilterOption={select:{status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value},no:"",name:"",keyWord:""};$scope.menuDisplayOption={"101-confirm":{display:true,name:"审核",uuid:"6544965d-6e2d-4182-b9d0-7f3f4bd45dfc"},"102-cancelConfirm":{display:true,name:"取消审核",uuid:"d404d47d-f327-470a-976f-7e9cd76f7db5"},
"103-enableStatus":{display:true,name:"启用",uuid:"fbab3426-bfd4-4375-a104-f6f1e31dca87"},"104-disableStatus":{display:true,name:"取消启用",uuid:"11d28d67-2b6b-4bd5-ad1b-d1308dfcce82"},"105-delete":{display:true,name:"删除",uuid:"8b20088c-8481-4225-95da-2a48a1de5194"},"106-query":{display:true,name:"查询",uuid:"b92c9dc0-6caf-4e83-b642-8c154e979acb"},"107-add":{display:true,name:"添加",uuid:"c27edb09-167c-4912-a521-ce9a553d0948"},"108-edit":{display:true,name:"修改",uuid:"c10fd61a-f86c-4d0f-aabc-dd918be60cc4"},
"201-batchConfirm":{display:true,name:"批量审核",uuid:"182200a3-17cd-42e2-bff3-79caa2cc4987"},"202-batchCancelConfirm":{display:true,name:"批量取消审核",uuid:"6b728f50-8e01-4f9b-abc6-1abe685c37d3"},"203-batchEnableStatus":{display:true,name:"批量启用",uuid:"3c876d1b-6a42-4d4a-91ba-c85c9ba8373e"},"204-batchDisableStatus":{display:true,name:"批量取消启用",uuid:"d2e335ae-6c8d-475f-96db-b69ce62df48f"}};$scope.getMenuAuthData($scope.RES_UUID_MAP.CBI.PAY_WAY.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)});
$scope.selectedItem=null;$scope.selectAllFlag=false;$scope.selected=[];$scope.selectItemCount=0;$scope.refreshList=function(){CBIPayWayService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.select.confirm,$scope.listFilterOption.select.status,$scope.listFilterOption.no,$scope.listFilterOption.name,$scope.listFilterOption.keyWord,$scope.RES_UUID_MAP.CBI.PAY_WAY.RES_UUID).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;
$scope.pageOption.totalElements=data.totalElements;$scope.selectAllFlag=false;$scope.selected=[];$scope.selectItemCount=0})};$scope.refreshList();$scope.$watch("listFilterOption.select",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()}};$scope.isAuthorized=
function(option){if($scope.menuDisplayOption[option].display&&($scope.menuAuthDataMap[$scope.menuDisplayOption[option].uuid]||$scope.isAdmin()||!$scope.menuDisplayOption[option].uuid))return true;return false};$scope.showConfirmMenuItem=function(item){if(item!==null&&item!==undefined)return item.confirm==1&&item.status==1&&$scope.isAuthorized("101-confirm");return false};$scope.showCancelConfirmMenuItem=function(item){if(item!==null&&item!==undefined)return item.confirm==2&&$scope.isAuthorized("102-cancelConfirm");
return false};$scope.showEnableStatusMenuItem=function(item){if(item!==null&&item!==undefined)return item.status==2&&$scope.isAuthorized("103-enableStatus");return false};$scope.showDisableStatusMenuItem=function(item){if(item!==null&&item!==undefined)return item.status==1&&$scope.isAuthorized("104-disableStatus");return false};$scope.showDeleteMenuItem=function(){return $scope.isAuthorized("105-delete")};$scope.showQueryButton=function(){return $scope.isAuthorized("106-query")};$scope.showAddButton=
function(){return $scope.isAuthorized("107-add")};$scope.showEditButton=function(){return $scope.isAuthorized("108-edit")};$scope.showBatchConfirmMenuItem=function(){return $scope.isAuthorized("101-confirm")};$scope.showBatchCancelConfirmMenuItem=function(){return $scope.isAuthorized("102-cancelConfirm")};$scope.showBatchEnableStatusMenuItem=function(){return $scope.isAuthorized("103-enableStatus")};$scope.showBatchDisableStatusMenuItem=function(){return $scope.isAuthorized("104-disableStatus")};
$scope.showBatchMenu=function(){return $scope.showBatchConfirmMenuItem||$scope.showBatchCancelConfirmMenuItem()||$scope.showBatchDisableStatusMenuItem()||$scope.showBatchEnableStatusMenuItem()};$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.showItemDetailsAction=function(item){$scope.selectedItem=item};$scope.hideItemDetailsAction=function(event){$scope.stopEventPropagation(event);$scope.selectedItem=null;$scope.refreshList()};$scope.returnToViewUIAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);
$scope.refreshList()};$scope.selectAllAction=function(){if($scope.selectAllFlag==true)angular.forEach($scope.itemList,function(item){var idx=$scope.selected.indexOf(item);if(idx<0)$scope.selected.push(item)});else if($scope.selectAllFlag==false)$scope.selected=[];$scope.selectItemCount=$scope.selected.length};$scope.selectItemAction=function(event,item,selected){$scope.stopEventPropagation(event);var idx=selected.indexOf(item);if(idx>-1)selected.splice(idx,1);else selected.push(item);$scope.selectItemCount=
$scope.selected.length};$scope.exists=function(item,selected){return selected.indexOf(item)>-1};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.canDeleteItem=function(item){if(item!==null&&item!==undefined)if(item.confirm==1&&item.status==1)return true;return false};$scope.deleteItemAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认删除吗？",
"删除后不可恢复。",function(){CBIPayWayService.delete(item.uuid).success(function(){$scope.selectedItem=null;$scope.refreshList();$scope.showInfo("删除数据成功。")})})};$scope.canEditItem=function(item){if(item!==null&&item!==undefined)if(item.confirm==1&&item.status==1)return true;return false};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)};
$scope.saveItemAction=function(){if($scope.source.confirm=="2"&&$scope.source.status=="2"){$scope.showError("不允许状态是已审核又无效,请调整后再保存");return}if($scope.status=="add"){if($scope.domain=="CBI_BASE_PAY_WAY")CBIPayWayService.add($scope.source).success(function(data){$scope.refreshList();$scope.showInfo("新增数据成功。")}).error(function(){$scope.showError("新增失败。")})}else if($scope.status=="edit")if($scope.domain=="CBI_BASE_PAY_WAY")CBIPayWayService.modify($scope.source.uuid,$scope.source).success(function(data){$scope.showInfo("修改数据成功。");
$scope.source=data;$scope.selectedItem=data;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)}).error(function(data){$scope.showError("修改失败:"+"\x3cbr\x3e"+data.message);$scope.source=angular.copy($scope.selectedItemBackUp);$scope.selectedItem=angular.copy($scope.selectedItemBackUp)})};$scope.confirmSwitchAction=function(event,item){$scope.stopEventPropagation(event);if(item.confirm==2)$scope.showConfirm("确认取消审核吗？","",function(){var payWayUpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};
CBIPayWayService.modify(payWayUpdateInput.uuid,payWayUpdateInput).success(function(){$scope.showInfo("修改数据成功。")})},function(){item.confirm="2"});else{if(item.status==Constant.STATUS[2].value){$scope.showWarn("项目是失效状态,请先启用后再审核");item.confirm=Constant.CONFIRM[2].value;return}$scope.showConfirm("确认审核吗？","",function(){var payWayUpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};CBIPayWayService.modify(payWayUpdateInput.uuid,payWayUpdateInput).success(function(){$scope.showInfo("修改数据成功。")})},
function(){item.confirm="1"})}};$scope.statusSwitchAction=function(event,item){$scope.stopEventPropagation(event);if(item.status==2)$scope.showConfirm("确认修改启用状态为有效吗？","",function(){var payWayUpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};CBIPayWayService.modify(payWayUpdateInput.uuid,payWayUpdateInput).success(function(){$scope.showInfo("修改数据成功。")})},function(){item.status="2"});else if(item.status==1)$scope.showConfirm("确认修改启用状态为无效吗？","",function(){var payWayUpdateInput={uuid:item.uuid,
status:Constant.STATUS[2].value,confirm:Constant.CONFIRM[1].value};CBIPayWayService.modify(payWayUpdateInput.uuid,payWayUpdateInput).success(function(){item.confirm=Constant.CONFIRM[1].value;$scope.showInfo("修改数据成功。")})},function(){item.status="1"})};$scope.confirmAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认审核吗？","",function(){var payWayUpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};CBIPayWayService.modify(payWayUpdateInput.uuid,payWayUpdateInput).success(function(){$scope.selectedItem.confirm=
Constant.CONFIRM[2].value;$scope.showInfo("修改数据成功。")})})};$scope.cancelConfirmAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认取消审核吗？","",function(){var payWayUpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};CBIPayWayService.modify(payWayUpdateInput.uuid,payWayUpdateInput).success(function(){$scope.selectedItem.confirm=Constant.CONFIRM[1].value;$scope.showInfo("修改数据成功。")})})};$scope.enableStatusAction=function(event,item){$scope.stopEventPropagation(event);
$scope.showConfirm("确认修改启用状态为有效吗？","",function(){var payWayUpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};CBIPayWayService.modify(payWayUpdateInput.uuid,payWayUpdateInput).success(function(){$scope.selectedItem.status=Constant.STATUS[1].value;$scope.showInfo("修改数据成功。")})})};$scope.disableStatusAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认修改启用状态为无效吗？","",function(){var payWayUpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value,confirm:Constant.CONFIRM[1].value};
CBIPayWayService.modify(payWayUpdateInput.uuid,payWayUpdateInput).success(function(){$scope.selectedItem.status=Constant.STATUS[2].value;$scope.selectedItem.confirm=Constant.CONFIRM[1].value;$scope.showInfo("修改数据成功。")})})};$scope.canBatchConfirm=function(){if($scope.selected.length>0){for(var i=0;i<$scope.selected.length;i++)if($scope.selected[i].confirm==Constant.CONFIRM[2].value||$scope.selected[i].status==Constant.STATUS[2].value)return false;return true}return false};$scope.batchConfirm=function(event){$scope.stopEventPropagation(event);
if($scope.selected.length>0)$scope.showConfirm("确认批量审核吗？","",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(item){var payWayUpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};var response=CBIPayWayService.modify(payWayUpdateInput.uuid,payWayUpdateInput).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.refreshList()})}})};$scope.canBatchCancelConfirm=function(){if($scope.selected.length>
0){for(var i=0;i<$scope.selected.length;i++)if($scope.selected[i].confirm==Constant.CONFIRM[1].value)return false;return true}return false};$scope.batchCancelConfirm=function(event){$scope.stopEventPropagation(event);if($scope.selected.length>0)$scope.showConfirm("确认批量取消审核吗？","",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(item){var payWayUpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};var response=CBIPayWayService.modify(payWayUpdateInput.uuid,
payWayUpdateInput).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.refreshList()})}})};$scope.canBatchEnableStatus=function(){if($scope.selected.length>0){for(var i=0;i<$scope.selected.length;i++)if($scope.selected[i].status==Constant.STATUS[1].value)return false;return true}return false};$scope.batchEnableStatus=function(event){$scope.stopEventPropagation(event);if($scope.selected.length>0)$scope.showConfirm("确认批量修改启用状态为有效吗？",
"",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(item){var payWayUpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};var response=CBIPayWayService.modify(payWayUpdateInput.uuid,payWayUpdateInput).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.refreshList()})}})};$scope.canBatchDisableStatus=function(){if($scope.selected.length>0){for(var i=0;i<$scope.selected.length;i++)if($scope.selected[i].status==
Constant.STATUS[2].value)return false;return true}return false};$scope.batchDisableStatus=function(event){$scope.stopEventPropagation(event);if($scope.selected.length>0)$scope.showConfirm("确认批量修改启用状态为无效吗？","",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(item){var payWayUpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value,confirm:Constant.CONFIRM[1].value};var response=CBIPayWayService.modify(payWayUpdateInput.uuid,payWayUpdateInput).success(function(data){});
promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("修改数据成功。");$scope.refreshList()})}})}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/pmmOrder",{controller:"PmmOrderController",templateUrl:"app/src/app/pmm/pmmOrder/bookingSlip.html"})}]);
angular.module("IOne-Production").controller("PmmOrderController",function($scope,$q,PmmOrderMaster,PmmOrderDetail,PmmOrderExtendDetail,PmmOrderExtendDetail2,OrderItemCustomDetail,OrderCustomScope,OrderChannelCurrency,OrderChannelTax,SaleTypes,CBIEmployeeService,$mdDialog,$timeout,Constant){$scope.orderListMenu={select:{confirm:Constant.AUDIT[1].value,status:Constant.STATUS[1].value,transferPsoFlag:Constant.TRANSFER_PSO_FLAG[2].value,startDate:null,endDate:null},selectAll:false,effectiveType:"2",
showQueryBar:true,showEmployee:false,showTransferPso:false,"orderMasterNo":{display:true,name:"预订单单号"},showPsoOrderMstNo:true};$scope.formMenuDisplayOption={"100-add":{display:true,name:"新增",uuid:"b02e037f-f78e-4da1-9788-b75fd0548ed2"},"101-delete":{display:true,name:"删除",uuid:"8fd21947-8b89-4527-8685-cf9cc3297d8e"},"102-edit":{display:true,name:"编辑",uuid:"8b091c83-f5c3-422c-92b5-0e819ec95223"},"200-cancel":{display:true,name:"取消新增",uuid:"fc669edb-5dc0-4b33-a7e6-4a2b9e8042d3"},"201-save":{display:true,
name:"保存",uuid:"301107cb-25e4-4971-8684-22e6219cfbbb"},"302-save":{display:true,name:"保存",uuid:"e3b32b44-07fc-44c9-a49d-56e88ffd62b5"},"303-cancel":{display:true,name:"取消修改",uuid:"988b6271-4723-43aa-ab71-441139a0ed13"},"304-quit":{display:true,name:"退出编辑",uuid:"5f0d0f3f-627e-49d2-bffb-5f40bfca491d"},"107-change":{display:false,name:"变更",uuid:"aac96850-da1c-47d6-b0f5-20f80230b2b4"},"108-changehistory":{display:false,name:"变更记录查询",uuid:"e6e97d14-233b-4553-94a7-2117069d0167"},"410-selectAll":{display:false,
name:"全选",uuid:"22f2be57-7bc3-4dfa-85e3-66bafa5c7727"},"411-audit":{display:true,name:"审核",uuid:"a7c7e8bf-0880-441e-9f6e-8d979b736b6e"},"412-return":{display:true,name:"退回",uuid:"5fd6c1ca-021a-4b67-974d-f584c28abee8"},"413-throw":{display:true,name:"抛转后台",uuid:"43562127-3a49-4a6a-89db-dbeb995f04a1"},"414-effective":{display:true,name:"失效作废",uuid:"d73deefc-3d88-4d4b-8f47-24627cce3e54"},"416-revertAudit":{display:true,name:"取消审核",uuid:"eba0caea-4fbf-4eec-8fde-44eafdfba4ac"}};$scope.orderListMenuDisplayOption=
{"400-selectAll":{display:true,name:"全选",uuid:"dfba15d0-55c2-4f32-9f0f-dc7391412b7c"},"401-audit":{display:true,name:"审核",uuid:"a5fd6757-e65a-4adc-af32-d3701f280b36"},"402-return":{display:true,name:"退回",uuid:"eb2036ef-8469-4ee7-b1d0-02c08a28e598"},"403-throw":{display:true,name:"抛转后台",uuid:"0b45d232-28ad-40de-93c1-95636ae6fadc"},"404-effective":{display:true,name:"失效作废",uuid:"1d0983c8-8d11-4a40-8140-d267e03d04a4"},"405-query":{display:true,name:"查询",uuid:"992b0fef-abca-461c-91b7-07036d54d3f4"},"406-revertAudit":{display:true,
name:"取消审核",uuid:"ab4da1cc-be55-4cd3-8a44-afc74d6237dc"},"408-add":{display:true,name:"新增",uuid:"862577df-fa98-4538-acc4-adf0687e787b"}};$scope.itemOperationMenuDisplayOption={"500-item-edit":{display:true,name:""},"501-item-delete":{display:true,name:""}};$scope.orderListMenuAction=function(menuId,$event){if(menuId==400)$scope.selectAllMenuAction();else if(menuId==401)$scope.auditMenuAction();else if(menuId==402)$scope.returnMenuAction();else if(menuId==403)$scope.throwMenuAction();else if(menuId==
404)$scope.effectiveMenuAction();else if(menuId==405)$scope.queryMenuAction();else if(menuId==406)$scope.revertAuditMenuAction();else if(menuId==407)$scope.oneOffSync();else if(menuId==408)$scope.preAddMenuAction();else if(menuId==409)$scope.rollbackTransfer()};$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.$watch("orderListMenu.select",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.queryMenuAction()},
true);$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.queryMenuAction()}};$scope.editItem=function(orderMaster){$scope.selectedDetail=[];$scope.orderListMenu.selectAll=false;$scope.selectedItem=orderMaster;if($scope.selectedItem.orderDate!=null)$scope.selectedItem.orderDate=new Date($scope.selectedItem.orderDate);if($scope.selectedItem.psoTransferDate!=null)$scope.selectedItem.psoTransferDate=new Date($scope.selectedItem.psoTransferDate);
$scope.changeViewStatus(Constant.UI_STATUS.PRE_EDIT_UI_STATUS,1);$scope.resetButtonDisabled();$scope.changeButtonStatus(orderMaster);$scope.orderListMenu.effectiveType=orderMaster.status;$scope.refreshDetail(orderMaster.uuid);OrderChannelCurrency.getAll().success(function(data){$scope.channelCurrencies=data.content});OrderChannelTax.getAll().success(function(data){$scope.channelTaxs=data.content});SaleTypes.getAll().success(function(data){$scope.saleTypes=data.content});if($scope.selectedItem.psoTransferNo!=
undefined&&$scope.selectedItem.psoTransferNo!=null){$scope.formMenuDisplayOption["102-edit"].display=false;$scope.formMenuDisplayOption["101-delete"].display=false}else{$scope.formMenuDisplayOption["102-edit"].display=true;$scope.formMenuDisplayOption["101-delete"].display=true}};$scope.refreshDetail=function(masterUuid){PmmOrderDetail.get(masterUuid).success(function(data){$scope.OrderDetailList=data;$scope.updateOrderDetaiListDate($scope.OrderDetailList);$scope.OrderExtendDetailList=[];angular.forEach($scope.OrderDetailList.content,
function(orderDetail){PmmOrderExtendDetail.get(orderDetail.uuid).success(function(data){$scope.OrderExtendDetailList=$scope.OrderExtendDetailList.concat(data.content)})});$scope.selectedDetail=[];$scope.resetDetailButtonDisabled()})};$scope.listTabSelected=function(){$scope.orderListMenu.showQueryBar=true;$scope.orderListMenuDisplayOption["400-selectAll"].display=true;$scope.queryMenuActionWithPaging();$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS,0);$scope.allCustomsScopes=null;$scope.orderExtendDetail2List=
null;$scope.selectedItemCustoms=null;$scope.changeSubTabIndexs(0);$scope.getMenuAuthData($scope.RES_UUID_MAP.PSO.PMM_ORDER.LIST_PAGE.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)});$scope.selectedDetail=[];$scope.OrderDetailList=null};$scope.formTabSelected=function(){$scope.orderListMenu.showQueryBar=false;$scope.orderListMenuDisplayOption["400-selectAll"].display=false;$scope.getMenuAuthData($scope.RES_UUID_MAP.PSO.PMM_ORDER.FORM_PAGE.RES_UUID).success(function(data){$scope.menuAuthDataMap=
$scope.menuDataMap(data)})};$scope.prodInfoTabSelected=function(){$scope.changeSubTabIndexs(0);$scope.allCustomsScopes=null;$scope.orderExtendDetail2List=null;$scope.selectedItemCustoms=null};$scope.deliverInfoTabSelected=function(){$scope.changeSubTabIndexs(1);$scope.allCustomsScopes=null;$scope.orderExtendDetail2List=null;$scope.selectedItemCustoms=null};$scope.receiptInfoTabSelected=function(){$scope.changeSubTabIndexs(3);$scope.allCustomsScopes=null;$scope.orderExtendDetail2List=null;$scope.selectedItemCustoms=
null;ReceiptDetail.get($scope.selectedItem.uuid).success(function(data){$scope.ReceiptOrderDetailList=data})};$scope.customTabSelected=function(){$scope.changeSubTabIndexs(2)};$scope.selected=[];$scope.selectedItemsCount=0;$scope.selectedItemsTotalPrice=0;$scope.toggle=function(item,selected){var idx=selected.indexOf(item);if(idx>-1)selected.splice(idx,1);else selected.push(item);$scope.orderListMenu.effectiveType=item.status;$scope.resetInitialValue();$scope.changeButtonStatusAndCalTotalPrice();
$scope.selectedItemsTotalPrice=$scope.selectedItemsTotalPrice.toFixed(2);$scope.selectedItemsCount=selected.length};$scope.changeButtonStatusAndCalTotalPrice=function(){var firstLoop=true;angular.forEach($scope.selected,function(orderMaster){$scope.selectedItemsTotalPrice=$scope.selectedItemsTotalPrice+orderMaster.oriPurAmt;if(firstLoop){firstLoop=false;$scope.orderListMenu.effectiveType=orderMaster.status;$scope.firstOrderMasterStatus=orderMaster.status}else if($scope.firstOrderMasterStatus!==orderMaster.status)$scope.effectiveType_disabled=
1;$scope.changeButtonStatus(orderMaster)})};$scope.changeButtonStatus=function(orderMaster){if(orderMaster.confirm==2||orderMaster.confirm==3)$scope.effectiveType_disabled=1;if(orderMaster.confirm==2||orderMaster.confirm==4)$scope.return_button_disabled=1;if(orderMaster.confirm==2||orderMaster.confirm==4)$scope.audit_button_disabled=1;if(!(orderMaster.confirm==2&&orderMaster.transferPsoFlag!=1))$scope.throw_button_disabled=1;if(!(orderMaster.confirm==2&&orderMaster.transferPsoFlag!=1))$scope.revert_audit_button_disabled=
1};$scope.changeDetailButtonStatus=function(){angular.forEach($scope.selectedDetail,function(detail){if(detail.confirm==2||detail.confirm==4)$scope.audit_detail_disabled=1;if(!(detail.confirm==2))$scope.revert_audit_detail_disabled=1})};$scope.exists=function(item,list){return list.indexOf(item)>-1};$scope.selectedDetail=[];$scope.toggleDetail=function(item,selectedDetail){var idx=selectedDetail.indexOf(item);if(idx>-1){selectedDetail.splice(idx,1);$scope.resetDetailButtonDisabled()}else selectedDetail.push(item);
$scope.orderListMenu.effectiveType=item.status;$scope.resetButtonDisabled();$scope.changeButtonStatuOnly();$scope.changeDetailButtonStatus()};$scope.changeButtonStatuOnly=function(){var firstLoop=true;angular.forEach($scope.selectedDetail,function(orderDetail){if(firstLoop){firstLoop=false;$scope.orderListMenu.effectiveType=orderDetail.status;$scope.firstOrderDetailStatus=orderDetail.status}else if($scope.firstOrderDetailStatus!==orderDetail.status)$scope.effectiveType_disabled=1;$scope.changeButtonStatus(orderDetail)})};
$scope.selectAllMenuAction=function(){if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1)if($scope.orderListMenu.selectAll==true){angular.forEach($scope.OrderDetailList.content,function(item){var idx=$scope.selectedDetail.indexOf(item);if(idx<0)$scope.selectedDetail.push(item)});$scope.resetButtonDisabled();$scope.changeButtonStatuOnly()}else{if($scope.orderListMenu.selectAll==false){$scope.selectedDetail=[];$scope.orderListMenu.effectiveType="1";$scope.resetButtonDisabled()}}else if($scope.ui_status==
Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0)if($scope.orderListMenu.selectAll==true){angular.forEach($scope.OrderMasterList.content,function(item){var idx=$scope.selected.indexOf(item);if(idx<0)$scope.selected.push(item)});$scope.resetInitialValue();$scope.changeButtonStatusAndCalTotalPrice();$scope.selectedItemsTotalPrice=$scope.selectedItemsTotalPrice.toFixed(2);$scope.selectedItemsCount=$scope.selected.length}else if($scope.orderListMenu.selectAll==false){$scope.selected=[];$scope.orderListMenu.effectiveType=
"1";$scope.resetInitialValue()}};$scope.refreshMasterAndDetail=function(){PmmOrderMaster.get($scope.selectedItem.uuid).success(function(data){$scope.selectedItem=data;$scope.updateOrderMasterDate($scope.selectedItem);$scope.selectedDetail=[];$scope.orderListMenu.selectAll=false;$scope.resetButtonDisabled();$scope.orderListMenu.effectiveType=data.status;PmmOrderDetail.get($scope.selectedItem.uuid).success(function(data){$scope.OrderDetailList=data;$scope.updateOrderDetaiListDate($scope.OrderDetailList);
$scope.showInfo("修改数据成功。")})})};$scope.effectiveMenuAction=function(){if($scope.selected.length>0||$scope.selectedTabIndex==1)$scope.showConfirm("确认修改启用状态吗？","",function(){if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){var OrderMasterUpdateInput={uuid:$scope.selectedItem.uuid,status:$scope.orderListMenu.effectiveType};PmmOrderMaster.modify(OrderMasterUpdateInput).success(function(){$scope.selectedItem.status=$scope.orderListMenu.effectiveType;$scope.editItem($scope.selectedItem);
PmmOrderMaster.getOrderMasterCount(Constant.AUDIT[1].value,Constant.STATUS[1].value,Constant.TRANSFER_PSO_FLAG[2].value,RES_UUID_MAP.PSO.PMM_ORDER.LIST_PAGE.RES_UUID).success(function(data){$scope.menuList[1].subList[2].suffix=data});$scope.showInfo("修改数据成功。")})}else if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){var promises=[];angular.forEach($scope.selected,function(item){var OrderMasterUpdateInput={uuid:item.uuid,status:$scope.orderListMenu.effectiveType};
var response=PmmOrderMaster.modify(OrderMasterUpdateInput).success(function(){});promises.push(response)});$q.all(promises).then(function(data){$scope.queryMenuActionWithPaging();$scope.showInfo("修改数据成功。")})}})};$scope.auditMenuAction=function(){if($scope.selected.length>0||$scope.selectedTabIndex==1)$scope.showConfirm("确认审核吗？","",function(){if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){var OrderMasterUpdateInput={uuid:$scope.selectedItem.uuid,confirm:"2"};
PmmOrderMaster.modify(OrderMasterUpdateInput).success(function(){$scope.selectedItem.confirm="2";$scope.editItem($scope.selectedItem);PmmOrderMaster.getOrderMasterCount(Constant.AUDIT[1].value,Constant.STATUS[1].value,Constant.TRANSFER_PSO_FLAG[2].value,RES_UUID_MAP.PSO.PMM_ORDER.LIST_PAGE.RES_UUID).success(function(data){$scope.menuList[1].subList[2].suffix=data});$scope.showInfo("修改数据成功。")})}else if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){var promises=[];
angular.forEach($scope.selected,function(item){var OrderMasterUpdateInput={uuid:item.uuid,confirm:"2"};var response=PmmOrderMaster.modify(OrderMasterUpdateInput).success(function(){});promises.push(response)});$q.all(promises).then(function(data){angular.forEach($scope.selected,function(item){item.confirm="2"});$scope.resetInitialValue();$scope.changeButtonStatusAndCalTotalPrice();$scope.selectedItemsTotalPrice=$scope.selectedItemsTotalPrice.toFixed(2);$scope.selectedItemsCount=$scope.selected.length;
$scope.showInfo("修改数据成功。")})}})};$scope.returnMenuAction=function(){if($scope.selected.length>0||$scope.selectedTabIndex==1)$scope.showConfirm("确认退回吗？","",function(){if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){var OrderMasterUpdateInput={uuid:$scope.selectedItem.uuid,confirm:"4"};PmmOrderMaster.modify(OrderMasterUpdateInput).success(function(){$scope.selectedItem.confirm="4";$scope.editItem($scope.selectedItem);PmmOrderMaster.getOrderMasterCount(Constant.AUDIT[1].value,
Constant.STATUS[1].value,Constant.TRANSFER_PSO_FLAG[2].value,RES_UUID_MAP.PSO.PMM_ORDER.LIST_PAGE.RES_UUID).success(function(data){$scope.menuList[1].subList[2].suffix=data});$scope.showInfo("修改数据成功。")})}else if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){var promises=[];angular.forEach($scope.selected,function(item){var OrderMasterUpdateInput={uuid:item.uuid,confirm:"4"};var response=PmmOrderMaster.modify(OrderMasterUpdateInput).success(function(){});promises.push(response)});
$q.all(promises).then(function(data){$scope.queryMenuActionWithPaging();$scope.showInfo("修改数据成功。")})}})};$scope.throwMenuAction=function(){if($scope.selected.length>0||$scope.selectedTabIndex==1)$scope.showConfirm("确认抛转吗？","",function(){if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){var OrderMasterUpdateInput={uuid:$scope.selectedItem.uuid,transferPsoFlag:"1"};PmmOrderMaster.modify(OrderMasterUpdateInput).success(function(){$scope.selectedItem.transferPsoFlag=
"1";$scope.editItem($scope.selectedItem);PmmOrderMaster.getOrderMasterCount(Constant.AUDIT[1].value,Constant.STATUS[1].value,Constant.TRANSFER_PSO_FLAG[2].value,RES_UUID_MAP.PSO.PMM_ORDER.LIST_PAGE.RES_UUID).success(function(data){$scope.menuList[1].subList[2].suffix=data});$scope.showInfo("修改数据成功。")})}else if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){var orderMasterUuids="";angular.forEach($scope.selected,function(item){orderMasterUuids=orderMasterUuids+item.uuid+
","});var OrderMasterUpdateInput={uuid:orderMasterUuids,transferPsoFlag:"1"};var response=PmmOrderMaster.modify(OrderMasterUpdateInput).success(function(){$scope.queryMenuActionWithPaging();$scope.showInfo("修改数据成功。")}).error(function(data){$scope.showError(data.message)})}})};$scope.revertAuditMenuAction=function(){if($scope.selected.length>0||$scope.selectedTabIndex==1)$scope.showConfirm("确认取消审核吗？","",function(){if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==
1){var OrderMasterUpdateInput={uuid:$scope.selectedItem.uuid,confirm:"1"};PmmOrderMaster.modify(OrderMasterUpdateInput).success(function(){$scope.selectedItem.confirm="1";$scope.editItem($scope.selectedItem);PmmOrderMaster.getOrderMasterCount(Constant.AUDIT[1].value,Constant.STATUS[1].value,Constant.TRANSFER_PSO_FLAG[2].value,RES_UUID_MAP.PSO.PMM_ORDER.LIST_PAGE.RES_UUID).success(function(data){$scope.menuList[1].subList[2].suffix=data});$scope.showInfo("修改数据成功。")})}else if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&
$scope.selectedTabIndex==0){var promises=[];angular.forEach($scope.selected,function(item){var OrderMasterUpdateInput={uuid:item.uuid,confirm:"1"};var response=PmmOrderMaster.modify(OrderMasterUpdateInput).success(function(){});promises.push(response)});$q.all(promises).then(function(data){angular.forEach($scope.selected,function(item){item.confirm="1"});$scope.resetInitialValue();$scope.changeButtonStatusAndCalTotalPrice();$scope.selectedItemsTotalPrice=$scope.selectedItemsTotalPrice.toFixed(2);
$scope.selectedItemsCount=$scope.selected.length;$scope.showInfo("修改数据成功。")})}})};$scope.resetInitialValue=function(){$scope.selectedItem=null;$scope.selectedItemsCount=0;$scope.selectedItemsTotalPrice=0;$scope.resetButtonDisabled()};$scope.resetButtonDisabled=function(){$scope.effectiveType_disabled=0;$scope.return_button_disabled=0;$scope.audit_button_disabled=0;$scope.throw_button_disabled=0;$scope.revert_audit_button_disabled=0};$scope.resetDetailButtonDisabled=function(){$scope.audit_detail_disabled=
0;$scope.revert_audit_detail_disabled=0};$scope.queryMenuAction=function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=100;$scope.pageOption.totalElements=100;$scope.queryMenuActionWithPaging()};$scope.queryMenuActionWithPaging=function(){$scope.selectedItem=null;$scope.selected=[];$scope.selectedItemsCount=0;$scope.selectedItemsTotalPrice=0;$scope.orderListMenu.selectAll=false;$scope.orderListMenu.effectiveType="2";$scope.resetInitialValue();if($scope.orderListMenu.select.startDate!==
undefined)if($scope.orderListMenu.select.startDate!==null){orderDateBegin=new Date($scope.orderListMenu.select.startDate);orderDateBegin=moment(orderDateBegin).format("YYYY-MM-DD")}else orderDateBegin=null;else orderDateBegin=null;if($scope.orderListMenu.select.endDate!==undefined)if($scope.orderListMenu.select.endDate!==null){orderDateEnd=new Date($scope.orderListMenu.select.endDate);orderDateEnd=moment(orderDateEnd).format("YYYY-MM-DD")}else orderDateEnd=null;else orderDateEnd=null;if($scope.orderListMenu.no!==
undefined)pmmOrderNo=$scope.orderListMenu.no;else pmmOrderNo=null;if($scope.orderListMenu.salesOrderMasterNo!==undefined)salesOrderMasterNo=$scope.orderListMenu.salesOrderMasterNo;else salesOrderMasterNo=null;confirm=$scope.orderListMenu.select.confirm;status=$scope.orderListMenu.select.status;transferPsoFlag=$scope.orderListMenu.select.transferPsoFlag;PmmOrderMaster.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,confirm,status,transferPsoFlag,pmmOrderNo,salesOrderMasterNo,orderDateBegin,
orderDateEnd,RES_UUID_MAP.PSO.PMM_ORDER.LIST_PAGE.RES_UUID).success(function(data){$scope.OrderMasterList=data;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;angular.forEach($scope.OrderMasterList.content,function(order){if(order.orderDate!=null)order.orderDate=new Date(order.orderDate);if(order.psoTransferDate!=null)order.psoTransferDate=new Date(order.psoTransferDate);PmmOrderDetail.get(order.uuid).success(function(detail){order.orderDetailCount=detail.totalElements})});
PmmOrderMaster.getOrderMasterCount(Constant.AUDIT[1].value,Constant.STATUS[1].value,Constant.TRANSFER_PSO_FLAG[2].value,RES_UUID_MAP.PSO.PMM_ORDER.LIST_PAGE.RES_UUID).success(function(data){$scope.menuList[1].subList[2].suffix=data})})};$scope.getOrderDetailCountByMasterUuid=function(){var orderMasterUuids="";angular.forEach($scope.OrderMasterList.content,function(orderMaster){$scope.updateOrderMasterDate(orderMaster);orderMasterUuids=orderMasterUuids+orderMaster.uuid+","});PmmOrderDetail.getAllCountByMasterUuids(orderMasterUuids).success(function(data){var map=
[];angular.forEach(data,function(orderMasterWithCount){map[orderMasterWithCount.uuid]=orderMasterWithCount.detailCount});angular.forEach($scope.OrderMasterList.content,function(orderMaster){if(undefined!=map[orderMaster.uuid])orderMaster.orderDetailCount=map[orderMaster.uuid];else orderMaster.orderDetailCount=0})})};$scope.modifyMenuAction=function(){if($scope.selectedItem)PmmOrderMaster.modify($scope.selectedItem).success(function(){$scope.showInfo("修改数据成功。")}).error(function(){$scope.showError("修改数据失败。")})};
$scope.cancelModifyMenuAction=function(){PmmOrderMaster.get($scope.selectedItem.uuid).success(function(data){$scope.selectedItem=data;$scope.updateOrderMasterDate($scope.selectedItem)})};$scope.exitModifyMenuAction=function(){$scope.cancelModifyMenuAction();$scope.changeViewStatus($scope.UI_STATUS.PRE_EDIT_UI_STATUS,1)};$scope.preAddMenuAction=function(){$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_ADD,1);CBIEmployeeService.getByNo($scope.currentUser).success(function(data){if(data.content[0]){$scope.selectedItem.employee=
data.content[0];$scope.selectedItem.department=$scope.selectedItem.employee.department}});orderDate=new Date;$scope.selectedItem={confirm:"1",status:"1",transferPsoFlag:"2",orderDate:orderDate};$scope.OrderDetailList={}};$scope.addMenuAction=function(){if($scope.selectedItem){if(!$scope.selectedItem.channel){$scope.showError("请选择经销商!");return}PmmOrderMaster.add($scope.selectedItem).success(function(data){$scope.selectedItem=data;var promises=[];angular.forEach($scope.OrderDetailList.content,function(orderDetail,
index){var response=PmmOrderDetail.add($scope.selectedItem.uuid,orderDetail).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.changeViewStatus($scope.UI_STATUS.PRE_EDIT_UI_STATUS,1);$scope.editItem($scope.selectedItem);$scope.showInfo("新增成功。")},function(){PmmOrderMaster.delete($scope.selectedItem.uuid).success(function(){});$scope.showInfo("新增失败。")})}).error(function(){$scope.showError("新增失败。")})}};$scope.cancelAddMenuAction=function(){$scope.listTabSelected()};
$scope.deleteMenuAction=function(){$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){if($scope.selectedItem)PmmOrderMaster.delete($scope.selectedItem.uuid).success(function(){$scope.showInfo("删除成功。");$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_DELETE,0)})})};$scope.changeMenuAction=function(){};$scope.changeHistoryMenuAction=function(){};$scope.openOrderItemsDlg=function(){if($scope.selectedItem.channel==undefined||$scope.selectedItem.channel==null)$scope.showWarn("请选择经销商。");else $mdDialog.show({controller:"OrderItemsSearchController",
templateUrl:"app/src/app/pmm/pmmOrder/selectItems.html",parent:angular.element(document.body),targetEvent:event,locals:{channelUuid:$scope.selectedItem.channel.uuid,saleTypes:$scope.saleTypes}}).then(function(data){if($scope.selectedItem.uuid!=undefined&&$scope.selectedItem.uuid!=null)PmmOrderDetail.add($scope.selectedItem.uuid,data.addOrderDetail).success(function(data){$scope.editItem(data.pmmOrderMst);$scope.showInfo("新增产品成功。")});else{if($scope.OrderDetailList.content==undefined)$scope.OrderDetailList.content=
[];$scope.OrderDetailList.content.push(data.addOrderDetail);$scope.updateOrderMasterPrice($scope.OrderDetailList.content)}})};$scope.orderDetailDeleteMenuAction=function(orderDetail){$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){if($scope.selectedItem.uuid!=undefined&&$scope.selectedItem.uuid!=null)PmmOrderDetail.delete(orderDetail.pmmOrderMst.uuid,orderDetail.uuid).success(function(){$scope.editItem($scope.selectedItem);$scope.showInfo("删除成功。")});else{$scope.OrderDetailList.content.splice($scope.OrderDetailList.content.indexOf(orderDetail),
1);$scope.updateOrderMasterPrice($scope.OrderDetailList.content)}})};$scope.confirmOrderItem=function(){if($scope.selectedDetail.length>0)$scope.showConfirm("确认审核吗？","",function(){var promises=[];angular.forEach($scope.selectedDetail,function(item){var PmmOrderDetailUpdateInput={uuid:item.uuid,confirm:"2"};var response=PmmOrderDetail.modify(item.pmmOrderMst.uuid,item.uuid,PmmOrderDetailUpdateInput).success(function(){item.confirm="2"});promises.push(response)});$q.all(promises).then(function(data){$scope.refreshDetail($scope.selectedItem.uuid);
var detailConfirmCount=0;angular.forEach($scope.OrderDetailList.content,function(detailItem){if(detailItem.confirm=="2")detailConfirmCount=detailConfirmCount+1});if($scope.OrderDetailList.totalElements==detailConfirmCount){var OrderMasterUpdateInput={uuid:$scope.selectedItem.uuid,confirm:"2"};PmmOrderMaster.modify(OrderMasterUpdateInput).success(function(){$scope.selectedItem.confirm="2";$scope.editItem($scope.selectedItem);PmmOrderMaster.getOrderMasterCount(Constant.AUDIT[1].value,Constant.STATUS[1].value,
Constant.TRANSFER_PSO_FLAG[2].value,RES_UUID_MAP.PSO.PMM_ORDER.LIST_PAGE.RES_UUID).success(function(data){$scope.menuList[1].subList[2].suffix=data});$scope.showInfo("修改数据成功。")})}$scope.showInfo("审核成功。")})})};$scope.unConfirmOrderItem=function(){if($scope.selectedDetail.length>0)$scope.showConfirm("确认取消审核吗？","",function(){var promises=[];angular.forEach($scope.selectedDetail,function(item){var PmmOrderDetailUpdateInput={uuid:item.uuid,confirm:"1"};var response=PmmOrderDetail.modify(item.pmmOrderMst.uuid,
item.uuid,PmmOrderDetailUpdateInput).success(function(){});promises.push(response)});$q.all(promises).then(function(data){angular.forEach($scope.selected,function(item){item.confirm="1"});$scope.showInfo("取消审核成功。");$scope.refreshDetail($scope.selectedItem.uuid);$scope.resetDetailButtonDisabled()})})};$scope.updateOrderMasterPrice=function(orderDetailList){$scope.selectedItemsOriStandardAmt=0;$scope.selectedItemsOriDiscountAmt=0;$scope.selectedItemsOriOrderAmt=0;$scope.selectedItemsDiscountRate=0;
angular.forEach(orderDetailList,function(orderDetail){if(null!=orderDetail.originalStandardAmount&&null!=orderDetail.originalDiscountAmount&&null!=orderDetail.originalOrderAmount){$scope.selectedItemsOriStandardAmt=parseFloat(($scope.selectedItemsOriStandardAmt+orderDetail.originalStandardAmount*orderDetail.orderQuantity).toFixed(2));$scope.selectedItemsOriDiscountAmt=parseFloat(($scope.selectedItemsOriDiscountAmt+orderDetail.originalDiscountAmount*orderDetail.orderQuantity).toFixed(2));$scope.selectedItemsOriOrderAmt=
parseFloat(($scope.selectedItemsOriOrderAmt+orderDetail.originalOrderAmount*orderDetail.orderQuantity).toFixed(2))}});if($scope.selectedItemsOriStandardAmt!=0)$scope.selectedItemsDiscountRate=parseFloat(($scope.selectedItemsOriOrderAmt/$scope.selectedItemsOriStandardAmt).toFixed(4));$scope.selectedItem.originalStandardAmount=$scope.selectedItemsOriStandardAmt;$scope.selectedItem.originalDiscountAmount=$scope.selectedItemsOriDiscountAmt;$scope.selectedItem.originalOrderAmount=$scope.selectedItemsOriOrderAmt;
$scope.selectedItem.discountRate=$scope.selectedItemsDiscountRate};$scope.orderDetailEditMenuAction=function(orderDetail){$mdDialog.show({controller:"PmmOrderDetailController",templateUrl:"app/src/app/pmm/pmmOrder/orderDetailEditDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{selectedOrderDetail:orderDetail,saleTypes:$scope.saleTypes}}).then(function(data){PmmOrderDetail.modify(data.selectedOrderDetail.pmmOrderMst.uuid,data.selectedOrderDetail.uuid,data.selectedOrderDetail).success(function(){PmmOrderDetail.get(data.selectedOrderDetail.pmmOrderMst.uuid).success(function(data){$scope.OrderDetailList=
data;$scope.updateOrderDetaiListDate($scope.OrderDetailList)});$scope.showInfo("修改成功。")})})};$scope.updateOrderDetaiListDate=function(OrderDetailList){angular.forEach(OrderDetailList.content,function(orderDetail){$scope.updateOrderDetailDate(orderDetail)})};$scope.updateOrderDetailDate=function(orderDetail){if(null!=orderDetail.deliverDate)orderDetail.deliverDate=new Date(orderDetail.deliverDate)};$scope.updateOrderMasterDate=function(orderMaster){if(null!=orderMaster.deliverDate)orderMaster.deliverDate=
new Date(orderMaster.deliverDate);if(null!=orderMaster.orderDate)orderMaster.orderDate=new Date(orderMaster.orderDate);if(null!=orderMaster.transferDate)orderMaster.transferDate=new Date(orderMaster.transferDate);if(undefined!=orderMaster.psoOrderMstNo&&null!=orderMaster.psoOrderMstNo){var idx=orderMaster.psoOrderMstNo.indexOf(",");if(idx>0)orderMaster.psoOrderMstNo=null}};$scope.orderExtendDetailEditMenuAction=function(orderExtendDetail){$mdDialog.show({controller:"PmmOrderExtendDetailController",
templateUrl:"app/src/app/pmm/pmmOrder/orderExtendDetailEditDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{selectedOrderExtendDetail:orderExtendDetail}}).then(function(data){PmmOrderExtendDetail.modify(data.selectedOrderExtendDetail.pmmOrderDetail.uuid,data.selectedOrderExtendDetail.uuid,data.selectedOrderExtendDetail).success(function(){PmmOrderDetail.get(data.selectedOrderExtendDetail.pmmOrderDetail.pmmOrderMaster.uuid,data.selectedOrderExtendDetail.pmmOrderDetail.uuid).success(function(data){$scope.OrderDetailList=
data;$scope.updateOrderDetaiListDate($scope.OrderDetailList);$scope.OrderExtendDetailList=[];angular.forEach($scope.OrderDetailList.content,function(orderDetail,index){PmmOrderExtendDetail.get(orderDetail.uuid).success(function(data){$scope.OrderExtendDetailList=$scope.OrderExtendDetailList.concat(data.content)})});$scope.showInfo("修改成功。")})})})};$scope.editItemCustom=function(orderExtendDetail){$scope.selectedOrderExtendDetail=orderExtendDetail;$scope.changeSubTabIndexs(2);OrderItemCustomDetail.getCustomDetail(orderExtendDetail.item.uuid).success(function(data){$scope.allCustomsScopes=
{};$scope.selectedItemCustoms=data;angular.forEach($scope.selectedItemCustoms.content,function(value){value.informationUuids=JSON.parse(value.information)});angular.forEach($scope.selectedItemCustoms.content,function(itemCustomDetail){angular.forEach(itemCustomDetail.informationUuids,function(informationUuid){OrderCustomScope.getCustomScope(itemCustomDetail.itemCustom.uuid,informationUuid).success(function(data){if(data.brand!=null&&orderExtendDetail.item.brand!=null&&orderExtendDetail.item.brand.name!=
data.brand.name);else if($scope.allCustomsScopes[itemCustomDetail.itemCustom.uuid]==undefined){var value={};value[data.uuid]=data;$scope.allCustomsScopes[itemCustomDetail.itemCustom.uuid]=value}else{var value=$scope.allCustomsScopes[itemCustomDetail.itemCustom.uuid];value[data.uuid]=data;$scope.allCustomsScopes[itemCustomDetail.itemCustom.uuid]=value}})})})});var orderExtendDetailUuid=$scope.selectedOrderExtendDetail.uuid;PmmOrderExtendDetail2.get(orderExtendDetailUuid).success(function(data){$scope.orderExtendDetail2List=
data;angular.forEach($scope.orderExtendDetail2List.content,function(value){value.informationUuids=JSON.parse(value.information)})})};$scope.openAddCustomDlg=function(){$mdDialog.show({controller:"PmmOrderExtendDetail2Controller",templateUrl:"app/src/app/pmm/pmmOrder/addCustomDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{allCustomsScopes:$scope.allCustomsScopes,custom:null,allCustoms:$scope.selectedItemCustoms,op:"add"}}).then(function(data){var OrderExtendDetail2Input=
{salesOrderExtendDetailUuid:$scope.selectedOrderExtendDetail.uuid,no:Math.random().toString(36).substring(10),itemUuid:$scope.selectedOrderExtendDetail.item.uuid,itemCustomUuid:data.selectedCustom.itemCustom.uuid,information:data.selectedCustom.information};var masterUuid=$scope.selectedOrderExtendDetail.pmmOrderDetail.pmmOrderMst.uuid;var detailUuid=$scope.selectedOrderExtendDetail.pmmOrderDetail.uuid;var orderExtendDetailUuid=$scope.selectedOrderExtendDetail.uuid;PmmOrderExtendDetail2.add(orderExtendDetailUuid,
OrderExtendDetail2Input).success(function(response){response.informationUuids=data.selectedCustom.informationUuids;$scope.orderExtendDetail2List.content.push(response);$scope.OrderExtendDetailList=[];angular.forEach($scope.OrderDetailList.content,function(orderDetail,index){PmmOrderExtendDetail.get(orderDetail.uuid).success(function(data){$scope.OrderExtendDetailList=$scope.OrderExtendDetailList.concat(data.content)})});$scope.showInfo("新增自定义信息成功。")})})};$scope.openEditCustomDlg=function(custom){$mdDialog.show({controller:"PmmOrderExtendDetail2Controller",
templateUrl:"app/src/app/pmm/pmmOrder/addCustomDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{allCustoms:$scope.selectedItemCustoms,allCustomsScopes:$scope.allCustomsScopes,custom:custom,op:"modify"}}).then(function(data){var masterUuid=$scope.selectedOrderExtendDetail.pmmOrderDetail.pmmOrderMst.uuid;var detailUuid=$scope.selectedOrderExtendDetail.pmmOrderDetail.uuid;var orderExtendDetailUuid=$scope.selectedOrderExtendDetail.uuid;var OrderExtendDetail2UpdateInput={itemCustomUuid:data.selectedCustom.itemCustom.uuid,
information:data.selectedCustom.information};PmmOrderExtendDetail2.modify(orderExtendDetailUuid,custom.uuid,OrderExtendDetail2UpdateInput).success(function(){$scope.OrderExtendDetailList=[];angular.forEach($scope.OrderDetailList.content,function(orderDetail,index){PmmOrderExtendDetail.get(orderDetail.uuid).success(function(data){$scope.OrderExtendDetailList=$scope.OrderExtendDetailList.concat(data.content)})});$scope.showInfo("修改自定义信息成功。")})})};$scope.deleteItemCustom=function(deletedOrderExtendDetail2){$scope.showConfirm("确认删除吗？",
"删除的自定义信息不可恢复。",function(){if(deletedOrderExtendDetail2){var masterUuid=$scope.selectedOrderExtendDetail.pmmOrderDetail.pmmOrderMst.uuid;var detailUuid=$scope.selectedOrderExtendDetail.pmmOrderDetail.uuid;var orderExtendDetailUuid=$scope.selectedOrderExtendDetail.uuid;PmmOrderExtendDetail2.delete(orderExtendDetailUuid,deletedOrderExtendDetail2.uuid).success(function(){angular.forEach($scope.orderExtendDetail2List.content,function(item,index){if(deletedOrderExtendDetail2==item)$scope.orderExtendDetail2List.content.splice(index,
1)});$scope.OrderExtendDetailList=[];angular.forEach($scope.OrderDetailList.content,function(orderDetail,index){PmmOrderExtendDetail.get(orderDetail.uuid).success(function(data){$scope.OrderExtendDetailList=$scope.OrderExtendDetailList.concat(data.content)})});$scope.showInfo("删除成功。")})}})};$scope.openOrderChannelDlg=function(){$mdDialog.show({controller:"OrderChannelSearchController",templateUrl:"app/src/app/pmm/pmmOrder/selectChannel.html",parent:angular.element(document.body),targetEvent:event}).then(function(data){$scope.selectedItem.channel=
data;$scope.selectedItem.channelUuid=data.uuid})};$scope.openOrderCustomerDlg=function(){$mdDialog.show({controller:"OrderCustomerSearchController",templateUrl:"app/src/app/pmm/pmmOrder/selectCustomer.html",parent:angular.element(document.body),targetEvent:event}).then(function(data){$scope.selectedItem.customer=data;$scope.selectedItem.customerUuid=data.uuid})}});
angular.module("IOne-Production").controller("OrderChannelSearchController",function($scope,$mdDialog,ChannelService){$scope.pageOption={sizePerPage:6,currentPage:0,totalPage:0,totalElements:0,displayModel:0};$scope.refreshChannel=function(){ChannelService.getAllGlobalQuery($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,0,0,$scope.searchKeyword).success(function(data){$scope.allChannel=data;$scope.pageOption.totalElements=data.totalElements;$scope.pageOption.totalPage=data.totalPages})};
$scope.refreshChannel();$scope.selectChannel=function(channel){$scope.channel=channel;$mdDialog.hide($scope.channel)};$scope.hideDlg=function(){$mdDialog.hide($scope.channel)};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").controller("OrderCustomerSearchController",function($scope,$mdDialog,OrderCustomers){$scope.pageOption={sizePerPage:6,currentPage:0,totalPage:0,totalElements:0,displayModel:0};$scope.refreshData=function(){OrderCustomers.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.searchKeyword).success(function(data){$scope.allData=data;$scope.pageOption.totalElements=data.totalElements;$scope.pageOption.totalPage=data.totalPages})};$scope.refreshData();
$scope.selectData=function(data){$scope.data=data;$mdDialog.hide($scope.data)};$scope.hideDlg=function(){$mdDialog.hide($scope.data)};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").controller("OrderItemsSearchController",function($scope,$q,$mdDialog,OrderItems,channelUuid,saleTypes){$scope.channelUuid=channelUuid;$scope.saleTypes=saleTypes;$scope.addOrderDetail={};$scope.pageOption={sizePerPage:5,currentPage:0,totalPage:0,totalElements:0,displayModel:0};$scope.refreshData=function(){OrderItems.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,channelUuid,$scope.searchNo,$scope.searchName).success(function(data){$scope.allData=
data;if($scope.allData.content.length<1)$scope.showError("当前经销商没有商品，请检查渠道定价是否设置。");$scope.pageOption.totalElements=data.totalElements;$scope.pageOption.totalPage=data.totalPages})};$scope.refreshData();$scope.selectData=function(data){$scope.addOrderDetail.item=data;$scope.addOrderDetail.itemUuid=data.uuid;$scope.addOrderDetail.oriPurPrice=data.suggestPrice;$scope.addOrderDetail.orderQty=1;$scope.addOrderDetail.oriPurAmt=parseFloat(($scope.addOrderDetail.oriPurPrice*$scope.addOrderDetail.orderQty).toFixed(2));
angular.forEach($scope.saleTypes,function(saleType,index){if(saleType.name=="常规")$scope.addOrderDetail.saleTypeUuid=saleType.uuid});$scope.addOrderDetail.customizeFlag=2;$scope.addOrderDetail.presentFlag=2;$scope.addOrderDetail.itemUuid=data.uuid};$scope.changePurPrice=function(price){$scope.addOrderDetail.oriPurPrice=price;$scope.changePurAmt()};$scope.changePurAmt=function(){$scope.addOrderDetail.oriPurAmt=$scope.addOrderDetail.oriPurPrice*$scope.addOrderDetail.orderQty};$scope.cancelDlg=function(){$mdDialog.cancel()};
$scope.hideDlg=function(){if(null==$scope.addOrderDetail.item)$scope.showError("请选择商品");else if(null==$scope.addOrderDetail.orderQty)$scope.showError("请输入采购数量");else if(null==$scope.addOrderDetail.oriPurPrice)$scope.showError("请输入采购单价");else $mdDialog.hide({"addOrderDetail":$scope.addOrderDetail})};$scope.showError=function(info){toastr["error"](info)};$scope.refreshUI=function(saleTypeUuid){$scope.specialPriceDisplay=false;$scope.promotionDisplay=false;angular.forEach($scope.saleTypes,function(saleType,
index){if(saleType.uuid==saleTypeUuid){if(saleType.no=="ST05")$scope.specialPriceDisplay=true;if(saleType.no=="ST07")$scope.promotionDisplay=true}})}});
angular.module("IOne-Production").controller("PmmOrderExtendDetail2Controller",function($scope,$mdDialog,allCustoms,allCustomsScopes,custom,op){$scope.allCustoms=allCustoms.content;$scope.allCustomsScopes=allCustomsScopes;$scope.selectedCustom=custom;$scope.op=op;if($scope.selectedCustom)angular.forEach($scope.selectedCustom.informationUuids,function(value,index){angular.forEach($scope.allCustomsScopes[$scope.selectedCustom.itemCustom.uuid],function(item){if(item.uuid==value)item.checked=true})});
else $scope.selectedCustom={informationUuids:[],itemCustom:{astrict:2}};$scope.customChangeHandler=function(customUuid){angular.forEach($scope.allCustoms,function(value,index){if(value.itemCustom.uuid==customUuid)$scope.selectedCustom.itemCustom=value.itemCustom});angular.forEach($scope.allCustomsScopes[$scope.selectedCustom.itemCustom.uuid],function(item){item.checked=false});angular.forEach($scope.selectedCustom.informationUuids,function(value,index){angular.forEach($scope.allCustomsScopes[$scope.selectedCustom.itemCustom.uuid],
function(item){if(item.uuid==value)item.checked=true})});if($scope.selectedCustom.itemCustom.scopeUuid!=undefined)$scope.selectedCustom.itemCustom.scopeUuid=null};$scope.checkBoxChangeHandler=function(data,selected){if(selected==true)$scope.selectedCustom.informationUuids.push(data.uuid);else angular.forEach($scope.selectedCustom.informationUuids,function(value,index){if(value==data.uuid)$scope.selectedCustom.informationUuids.splice(index,1)})};$scope.radioChangeHandler=function(){$scope.selectedCustom.informationUuids=
[];$scope.selectedCustom.informationUuids.push($scope.selectedCustom.itemCustom.scopeUuid)};$scope.hideDlg=function(){$scope.selectedCustom.information=JSON.stringify($scope.selectedCustom.informationUuids);$mdDialog.hide({"selectedCustom":$scope.selectedCustom})};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").controller("PmmOrderExtendDetailController",function($scope,$mdDialog,selectedOrderExtendDetail){$scope.selectedOrderExtendDetail=angular.copy(selectedOrderExtendDetail);$scope.hideDlg=function(){$mdDialog.hide({"selectedOrderExtendDetail":$scope.selectedOrderExtendDetail})};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").controller("PmmOrderDetailController",function($scope,$mdDialog,selectedOrderDetail,saleTypes){$scope.selectedOrderDetail=angular.copy(selectedOrderDetail);$scope.saleTypes=saleTypes;$scope.hideDlg=function(){$mdDialog.hide({"selectedOrderDetail":$scope.selectedOrderDetail})};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").service("PmmOrderMaster",function($http,Constant){this.getAll=function(sizePerPage,page,confirm,status,transferFlag,pmmOrderNo,salesOrderMasterNo,orderDateBegin,orderDateEnd,resUuid){confirm=confirm==0?"":confirm;status=status==0?"":status;transferPsoFlag=transferPsoFlag==0?"":transferPsoFlag;var url="/pmmOrders?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26confirm\x3d"+confirm+"\x26status\x3d"+status;if(pmmOrderNo!==null&&pmmOrderNo!=undefined)url=url+"\x26no\x3d"+
pmmOrderNo;if(salesOrderMasterNo!==null&&salesOrderMasterNo!=undefined)url=url+"\x26salesOrderMasterNo\x3d"+salesOrderMasterNo;if(orderDateBegin!==null)url=url+"\x26orderDateBegin\x3d"+orderDateBegin;if(orderDateEnd!==null)url=url+"\x26orderDateEnd\x3d"+orderDateEnd;if(transferFlag!=0)url=url+"\x26transferFlag\x3d"+transferFlag;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;console.log(url);return $http.get(Constant.BACKEND_BASE+url)};this.getOrderMasterCount=function(confirm,
status,transferPsoFlag,resUuid){confirm=confirm==0?"":confirm;status=status==0?"":status;transferPsoFlag=transferPsoFlag==0?"":transferPsoFlag;var url="/pmmOrders/count?confirm\x3d"+confirm+"\x26status\x3d"+status+"\x26transferPsoFlag\x3d"+transferPsoFlag;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;console.log(Constant.BACKEND_BASE+url);return $http.get(Constant.BACKEND_BASE+url)};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+"/pmmOrders/"+uuid)};this.modify=
function(OrderMasterUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/pmmOrders/"+OrderMasterUpdateInput.uuid,OrderMasterUpdateInput)};this.add=function(OrderMasterInput){console.log(OrderMasterInput);return $http.post(Constant.BACKEND_BASE+"/pmmOrders/",OrderMasterInput)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/pmmOrders/"+uuid)}});
angular.module("IOne-Production").service("PmmOrderDetail",function($http,Constant){this.get=function(masterUuid){return $http.get(Constant.BACKEND_BASE+"/pmmOrders/"+masterUuid+"/details")};this.modify=function(masterUuid,uuid,OrderDetailUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/pmmOrders/"+masterUuid+"/details/"+uuid,OrderDetailUpdateInput)};this.getAllCountByMasterUuids=function(orderMasterUuids){var url="pmmOrders/"+orderMasterUuids+"/count/";console.log(Constant.BACKEND_BASE+url);
return $http.get(Constant.BACKEND_BASE+url)};this.add=function(masterUuid,OrderDetailInput){return $http.post(Constant.BACKEND_BASE+"/pmmOrders/"+masterUuid+"/details/",OrderDetailInput)};this.delete=function(masterUuid,detailUuid){return $http.delete(Constant.BACKEND_BASE+"/pmmOrders/"+masterUuid+"/details/"+detailUuid)}});
angular.module("IOne-Production").service("PmmOrderExtendDetail",function($http,Constant){this.get=function(detailUuid){return $http.get(Constant.BACKEND_BASE+"/pmmOrderDetails/"+detailUuid+"/extends/")};this.modify=function(detailUuid,uuid,OrderExtendDetailUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/pmmOrderDetails/"+detailUuid+"/extends/"+uuid,OrderExtendDetailUpdateInput)}});
angular.module("IOne-Production").service("PmmOrderExtendDetail2",function($http,Constant){this.get=function(orderExtendDetailUuid){console.log(Constant.BACKEND_BASE+"/pmmOrderExtendDetails/"+orderExtendDetailUuid+"/extend2s/");return $http.get(Constant.BACKEND_BASE+"/pmmOrderExtendDetails/"+orderExtendDetailUuid+"/extend2s/")};this.modify=function(orderExtendDetailUuid,uuid,OrderExtendDetail2UpdateInput){return $http.patch(Constant.BACKEND_BASE+"/pmmOrderExtendDetails/"+orderExtendDetailUuid+"/extend2s/"+
uuid,OrderExtendDetail2UpdateInput)};this.add=function(orderExtendDetailUuid,OrderExtendDetail2Input){return $http.post(Constant.BACKEND_BASE+"/pmmOrderExtendDetails/"+orderExtendDetailUuid+"/extend2s/",OrderExtendDetail2Input)};this.delete=function(orderExtendDetailUuid,uuid){return $http.delete(Constant.BACKEND_BASE+"/pmmOrderExtendDetails/"+orderExtendDetailUuid+"/extend2s/"+uuid)}});
angular.module("IOne-Production").service("OrderCustomers",function($http,Constant){this.getAll=function(sizePerPage,page,name){var url="/customers?size\x3d"+sizePerPage+"\x26page\x3d"+page;if(name!==undefined&&name!==null)url=url+"\x26name\x3d"+name;return $http.get(Constant.BACKEND_BASE+url)}});
angular.module("IOne-Production").service("OrderItems",function($http,Constant){this.getAll=function(sizePerPage,page,channelUuid,no,name){var url="/channelPrices/"+channelUuid+"/items?size\x3d"+sizePerPage+"\x26page\x3d"+page;if(no!==undefined&&no!==null)url=url+"\x26no\x3d"+no;if(name!==undefined&&name!==null)url=url+"\x26name\x3d"+name;return $http.get(Constant.BACKEND_BASE+url)}});
angular.module("IOne-Production").service("OrderChannelCurrency",function($http,Constant){this.getAll=function(){return $http.get(Constant.BACKEND_BASE+"/channelCurrencies/")}});angular.module("IOne-Production").service("OrderChannelTax",function($http,Constant){this.getAll=function(){return $http.get(Constant.BACKEND_BASE+"/channelTaxes/")}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/production",{controller:"ProductionController",templateUrl:"app/src/app/production/production/production.html"})}]);
angular.module("IOne-Production").controller("ProductionController",function($scope,Production,ProductionPic,ProductionBom,ProductionArea,ProductionBrand,ProductionCustom,ProductionItemCustom,ProductionCatalogueDetails,$mdDialog,$timeout,Constant,Upload,ProductionUnit){$scope.listFilterOption={status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value,release:Constant.RELEASE[0].value,prodType:Constant.PROD_TYPE[0].value,stopProd:Constant.STOP_PRODUCTION[0].value};$scope.UNIT_STATUS=Constant.STATUS;
$scope.listFilterDisplayOption={showStatusFilterMenu:true,showConfirmFilterMenu:true,showReleaseFilerMenu:true,showProdTypeFilterMenu:true,showStopProdFilterMenu:true};$scope.formMenuDisplayOption={"100-add":{display:true,name:"新增",uuid:"E27EB9F5-CD9E-4F9D-9EA5-DE0FE901E337"},"101-delete":{display:true,name:"删除",uuid:"15663443-643D-4C85-841B-169F838FC9FE"},"102-edit":{display:true,name:"编辑",uuid:"A160CF71-11AD-451A-9917-C78D26731C1F"},"103-copy":{display:false,name:"复制",uuid:"E2AD5A24-7DF2-4514-BA09-D3FE8D5F9E25"},
"104-status":{display:true,name:"启用",uuid:"98212872-75D3-4DB8-894A-CEFDBFA0630C"},"105-confirm":{display:true,name:"审核",uuid:"ECACA0A5-3B3B-4248-AD00-2A2A6C3F46BE"},"106-release":{display:true,name:"发布",uuid:"8A98B157-9A7A-4982-9A91-A906EF29B5B2"},"200-cancel":{display:true,name:"取消新增",uuid:"6AE5AD61-02B7-4C3B-B820-D4E7581BAC4A"},"201-save":{display:true,name:"保存",uuid:"E22F8EA9-6B3F-47FB-A3C1-E32BAE953161"},"300-add":{display:false,name:"新增节点",uuid:"EB74628F-4354-4E89-BC6B-16AD1D56E494"},"301-delete":{display:false,
name:"删除节点",uuid:"3AA9227E-BDBC-462B-914D-7A95EF1C0BA7"},"302-save":{display:true,name:"保存",uuid:"EB910C25-3CDF-4E71-9D9A-EADA6F289261"},"303-cancel":{display:true,name:"取消修改",uuid:"BEC26D9A-7A75-485C-AB97-69A83B27E2F4"},"304-quit":{display:true,name:"退出编辑",uuid:"889D6CC7-4027-46D9-A2F1-31E26ABB92AE"}};$scope.pageOption={sizePerPage:21,currentPage:0,totalPage:0,totalElements:0,displayModel:0};$scope.searchQuery={no:"",name:""};ProductionArea.getAll().success(function(data){$scope.productionAreas=
data});ProductionBrand.getAll($scope.RES_UUID_MAP.PRODUCTION.PRODUCTION.LIST_PAGE.RES_UUID).success(function(data){$scope.productionBrands=data});$scope.refreshProduction=function(){Production.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.confirm,$scope.listFilterOption.release,$scope.listFilterOption.status,$scope.listFilterOption.prodType,$scope.listFilterOption.stopProd,$scope.searchQuery.no,$scope.searchQuery.name,$scope.RES_UUID_MAP.PRODUCTION.PRODUCTION.LIST_PAGE.RES_UUID).success(function(data){$scope.allProductionsData=
data;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements})};$scope.$watch("listFilterOption",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshProduction()},true);$scope.openQuickView=function($event,production){$mdDialog.show({controller:"QuickViewController",templateUrl:"app/src/app/production/production/quick_view.html",parent:angular.element(document.body),targetEvent:event,locals:{productionUuid:production.uuid}}).then(function(data){});
$event.stopPropagation();$event.preventDefault()};$scope.showStatusConfirmReleaseMenu=function(isShow){$scope.formMenuDisplayOption["104-status"].display=isShow;$scope.formMenuDisplayOption["105-confirm"].display=isShow;$scope.formMenuDisplayOption["106-release"].display=isShow};$scope.listTabSelected=function(){$scope.refreshProduction();$scope.selectedItem=null;$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS,0);$scope.showStatusConfirmReleaseMenu(true)};$scope.editItem=function(production){Production.get(production.uuid,
$scope.RES_UUID_MAP.PRODUCTION.PRODUCTION.FORM_PAGE.RES_UUID).success(function(data){$scope.selectedItem=data;$scope.selectedItem.brandUuid=$scope.selectedItem.brand.uuid;if($scope.selectedItem){ProductionPic.getAll($scope.selectedItem.uuid).success(function(data){$scope.picsData=data;$scope.selectedItemPics=[];$scope.selectedItemPics.push($scope.getImageFullPath($scope.selectedItem.path));angular.forEach($scope.picsData.content,function(item){if(item.path!=null)$scope.selectedItemPics.push($scope.getImageFullPath(item.path))})});
if($scope.selectedItem.type==Constant.PROD_TYPE[1].value)ProductionBom.getAll($scope.selectedItem.uuid).success(function(data){$scope.selectedItemBoms=data;$scope.selectedItemBomsLength=0;angular.forEach($scope.selectedItemBoms.content,function(data){$scope.selectedItemBomsLength+=data.quantity})});ProductionUnit.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.selectedItem.uuid).success(function(data){$scope.selectedItem.unitList=data.content}).error(function(resp){$scope.selectedItem.unitList=
[]});ProductionCustom.getAll().success(function(data){$scope.allCustoms=data;$scope.allCustomsScopes={};angular.forEach($scope.allCustoms.content,function(custom){ProductionCustom.getCustom(custom.uuid).success(function(data){var value={};angular.forEach(data.content,function(item){value[item.uuid]=item});$scope.allCustomsScopes[custom.uuid]=value})});ProductionItemCustom.get($scope.selectedItem.uuid).success(function(data){$scope.selectedItemCustoms=data;angular.forEach($scope.selectedItemCustoms.content,
function(value){value.informationUuids=JSON.parse(value.information)})})});ProductionCatalogueDetails.getByProduction($scope.selectedItem.uuid,1E3,0).success(function(data){$scope.selectedItemCatalogues=data;angular.forEach($scope.selectedItemCatalogues.content,function(eachCatalogue,index){var itemCtgs={};itemCtgs.catalogues=[];var itemCatalogues=eachCatalogue.catalogue;itemCtgs.catalogues[0]=itemCatalogues;var i=1;while(itemCatalogues.parentCatalogue!==null){itemCtgs.catalogues[i]=itemCatalogues.parentCatalogue;
itemCatalogues=itemCatalogues.parentCatalogue;i++}itemCtgs.catalogues=itemCtgs.catalogues.reverse();$scope.selectedItemCatalogues.content[index].itemCtgs=itemCtgs})})}});$scope.changeViewStatus(Constant.UI_STATUS.PRE_EDIT_UI_STATUS,1)};$scope.formTabSelected=function(){if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS)$scope.showStatusConfirmReleaseMenu(true);else $scope.showStatusConfirmReleaseMenu(false);$scope.getMenuAuthData($scope.RES_UUID_MAP.PRODUCTION.PRODUCTION.FORM_PAGE.RES_UUID).success(function(data){$scope.menuAuthDataMap=
$scope.menuDataMap(data)})};$scope.modifyMenuAction=function(){if($scope.selectedItem)Production.modify($scope.selectedItem).success(function(){$scope.showInfo("修改商品数据成功。")}).error(function(data){$scope.showError("修改失败:"+data.message);$scope.cancelModifyMenuAction()})};$scope.cancelModifyMenuAction=function(){Production.get($scope.selectedItem.uuid).success(function(data){$scope.selectedItem=data;$scope.selectedItem.brandUuid=$scope.selectedItem.brand.uuid})};$scope.exitModifyMenuAction=function(){$scope.cancelModifyMenuAction();
$scope.changeViewStatus($scope.UI_STATUS.PRE_EDIT_UI_STATUS,1)};$scope.preAddMenuAction=function(){$scope.selectedItem={stopProductionFlag:"N",eshopType:"1",type:"1",assemblingFlag:"0",customizationFlag:"Y",confirm:"1",status:"1",release:"1"};$scope.selectedItemPics=[];$scope.selectedItemBoms={};$scope.selectedItemBoms.content=[];$scope.selectedItemCustoms={};$scope.selectedItemCustoms.content=[];$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_ADD,1)};$scope.addMenuAction=function(){if($scope.selectedItem)Production.add($scope.selectedItem).success(function(data){$scope.selectedItem=
data;$scope.editItem($scope.selectedItem);$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_MODIFY,1);$scope.showInfo("新增商品成功。")}).error(function(data){if(data.code=="Duplicated")$scope.showError("新增失败:"+Constant.PRODUCT_ERRORS[data.code].message);else $scope.showError("新增失败:"+data.message)})};$scope.cancelAddMenuAction=function(){$scope.listTabSelected()};$scope.deleteMenuAction=function(){$scope.showConfirm("确认删除吗？","删除的商品不可恢复。",function(){if($scope.selectedItem)Production.delete($scope.selectedItem.uuid).success(function(){$scope.showInfo("删除成功。");
$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_DELETE,0)})})};$scope.openBomSelectDlg=function(){$mdDialog.show({controller:"SelectBomController",templateUrl:"app/src/app/production/production/addBomDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{selectedItem:$scope.selectedItem,selectedBom:{}}}).then(function(data){if(data.itemUuid==data.parentItemUuid)$scope.showError("新增BOM失败:不能将商品本身添加到BOM");else ProductionBom.add($scope.selectedItem.uuid,data).success(function(newBom){$scope.selectedItemBoms.content.push(newBom);
$scope.showInfo("新增BOM成功。")}).error(function(data){$scope.showError("新增BOM失败:"+data.message)})})};$scope.openModifyBomDlg=function(bom){$mdDialog.show({controller:"SelectBomController",templateUrl:"app/src/app/production/production/addBomDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{selectedItem:$scope.selectedItem,selectedBom:bom}}).then(function(data){if(data.item.uuid==data.parentItemUuid)$scope.showError("修改BOM失败:不能将商品本身添加到BOM");else ProductionBom.modify($scope.selectedItem.uuid,
bom).success(function(){$scope.showInfo("修改BOM成功。")}).error(function(data){$scope.showError("修改BOM失败:"+data.message)})})};$scope.openAddCustomDlg=function(){$mdDialog.show({controller:"CustomController",templateUrl:"app/src/app/production/production/addCustomDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{selectedItem:$scope.selectedItem,allCustoms:$scope.allCustoms,allCustomsScopes:$scope.allCustomsScopes,custom:null,op:"add"}}).then(function(data){var itemCustom={itemCustomUuid:data.selectedCustom.itemCustom.uuid,
information:data.selectedCustom.information,itemUuid:$scope.selectedItem.uuid,no:Math.random().toString(36).substring(10),astrict:data.selectedCustom.astrict};ProductionItemCustom.add($scope.selectedItem.uuid,itemCustom).success(function(response){response.informationUuids=data.selectedCustom.informationUuids;$scope.selectedItemCustoms.content.push(response);$scope.showInfo("新增自定义信息成功。")})})};$scope.openEditCustomDlg=function(custom){$mdDialog.show({controller:"CustomController",templateUrl:"app/src/app/production/production/addCustomDlg.html",
parent:angular.element(document.body),targetEvent:event,locals:{selectedItem:$scope.selectedItem,allCustoms:$scope.allCustoms,allCustomsScopes:$scope.allCustomsScopes,custom:custom,op:"modify"}}).then(function(data){ProductionItemCustom.modify($scope.selectedItem.uuid,custom.uuid,data.selectedCustom).success(function(){$scope.showInfo("修改自定义信息成功。")})})};$scope.deleteItemCustom=function(itemCustom){$scope.showConfirm("确认删除吗？","删除的自定义信息不可恢复。",function(){if(itemCustom)ProductionItemCustom.delete($scope.selectedItem.uuid,
itemCustom.uuid).success(function(){angular.forEach($scope.selectedItemCustoms.content,function(item,index){if(itemCustom==item)$scope.selectedItemCustoms.content.splice(index,1)});$scope.showInfo("删除成功。")})})};$scope.deleteBom=function(bom){$scope.showConfirm("确认删除吗？","删除的BOM不可恢复。",function(){if(bom)ProductionBom.delete($scope.selectedItem.uuid,bom.uuid).success(function(){$scope.selectedItemBoms.content.splice($scope.selectedItemBoms.content.indexOf(bom),1);$scope.showInfo("删除BOM成功。")})})};$scope.uploadImage=
function(files,type){$scope.progress={value:0};if(files&&files.length)for(var i=0;i<files.length;i++){var file=files[i];Upload.upload({url:Constant.BACKEND_BASE+"/files",fields:{},file:file}).progress(function(evt){$scope.progress.value=Math.min(100,parseInt(99*evt.loaded/evt.total))}).success(function(data){$timeout(function(){if(type==0){if($scope.selectedItem&&$scope.selectedItem.uuid)Production.addImage($scope.selectedItem.uuid,data.uuid).success(function(response){$scope.selectedItemPics[0]=
$scope.getImageFullPath(response.path)+"?time\x3d"+(new Date).getTime()})}else if(type==1)ProductionPic.add($scope.selectedItem).success(function(itemPath){ProductionPic.addImage($scope.selectedItem.uuid,itemPath.uuid,data.uuid).success(function(response){$scope.picsData.content.push(response);$scope.selectedItemPics.push($scope.getImageFullPath(response.path))})})})})}};$scope.currentSmallImageIndex={value:0};$scope.deleteItemImage=function(){if($scope.currentSmallImageIndex.value==0&&!$scope.isDefaultImage($scope.selectedItemPics[0]))Production.deleteImage($scope.selectedItem.uuid,
"item").success(function(){$scope.selectedItem.path=null;$scope.selectedItemPics[0]=$scope.DEFAULT_IMAGE_PATH});else if($scope.currentSmallImageIndex.value>0)ProductionPic.deleteImage($scope.selectedItem.uuid,$scope.picsData.content[$scope.currentSmallImageIndex.value-1].uuid).success(function(){$scope.picsData.content.splice($scope.currentSmallImageIndex.value-1,1);$scope.selectedItemPics.splice($scope.currentSmallImageIndex.value,1)})};$scope.colorProgress={value:0};$scope.uploadColorImage=function(files,
custom){$scope.colorProgress={value:0};if(files&&files.length)for(var i=0;i<files.length;i++){var file=files[i];Upload.upload({url:Constant.BACKEND_BASE+"/files",fields:{},file:file}).progress(function(evt){$scope.colorProgress.value=Math.min(100,parseInt(99*evt.loaded/evt.total))}).success(function(data){$timeout(function(){ProductionColors.addImage(data.uuid).success(function(data){})})})}};$scope.$watchCollection("[selectedItem.status, selectedItem.confirm, selectedItem.release]",function(){if($scope.selectedItem){if($scope.selectedItem.status==
"1")$scope.formMenuDisplayOption["104-status"].name="禁用";else if($scope.selectedItem.status=="2")$scope.formMenuDisplayOption["104-status"].name="启用";if($scope.selectedItem.confirm=="1")$scope.formMenuDisplayOption["105-confirm"].name="审核";else if($scope.selectedItem.confirm=="2")$scope.formMenuDisplayOption["105-confirm"].name="反审核";if($scope.selectedItem.release=="1")$scope.formMenuDisplayOption["106-release"].name="发布";else if($scope.selectedItem.release=="2")$scope.formMenuDisplayOption["106-release"].name=
"反发布"}});$scope.handler=function(field,value){if($scope.selectedItem&&$scope.selectedItem[field]){$scope.selectedItem[field]=value;$scope.modifyMenuAction()}};$scope.statusMenuAction=function(){$scope.selectedItem.status=="1"?$scope.handler("status","2"):$scope.handler("status","1")};$scope.confirmMenuAction=function(){$scope.selectedItem.confirm=="1"?$scope.handler("confirm","2"):$scope.handler("confirm","1")};$scope.releaseMenuAction=function(){$scope.selectedItem.release=="1"?$scope.handler("release",
"2"):$scope.handler("release","1")};$scope.openUnitEditDlg=function(item,selectedUnit){$mdDialog.show({controller:"UnitEditController",templateUrl:"app/src/app/production/production/unitEditDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{selectedItem:item,selectedUnit:selectedUnit==null?null:{"item":selectedUnit.item,"uuid":selectedUnit.uuid,"no":selectedUnit.no,"numerator":selectedUnit.numerator,"unit":selectedUnit.unit,"denominator":selectedUnit.denominator,"status":selectedUnit.status}}}).then(function(workingUnit){if(workingUnit.operation===
"ADD"){workingUnit.itemUuid=$scope.selectedItem.uuid;ProductionUnit.add(workingUnit).success(function(respUnit){$scope.selectedItem.unitList.push(respUnit);$scope.showInfo("新增单位换算率成功。")}).error(function(resp){$scope.showError("新增单位换算率失败:"+resp.message)})}else if(workingUnit.operation==="EDIT")ProductionUnit.modify(workingUnit).success(function(respUnit){ProductionUnit.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.selectedItem.uuid).success(function(data){$scope.selectedItem.unitList=
data.content}).error(function(resp){$scope.showError("获取单位换算率数据失败:"+resp.message)});$scope.showInfo("修改单位换算率成功。")}).error(function(resp){$scope.showError("修改单位换算率失败:"+resp.message)})})};$scope.deleteUnit=function(unit){$scope.showConfirm("确认删除吗？","删除的单位换算率数据不可恢复。",function(){ProductionUnit.delete(unit.uuid).success(function(){$scope.selectedItem.unitList.splice($scope.selectedItem.unitList.indexOf(unit),1);$scope.showInfo("删除单位换算率成功。")}).error(function(resp){$scope.showError("删除单位换算率失败:"+resp.message)})})}});
angular.module("IOne-Production").controller("UnitEditController",function($scope,$mdDialog,Production,selectedItem,selectedUnit){$scope.selectedItem=selectedItem;if(selectedUnit==null){$scope.workingUnit={};$scope.workingUnit.operation="ADD"}else{$scope.workingUnit=selectedUnit;$scope.workingUnit.operation="EDIT"}$scope.hideDlg=function(){$mdDialog.hide($scope.workingUnit)};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").controller("QuickViewController",function($scope,$mdDialog,Production,ProductionBom,ProductionPic,productionUuid,Constant){$scope.getImageFullPath=function(path){if(path==null)return Constant.BACKEND_BASE+"/app/img/item.jpeg";if(path&&path.indexOf("IMAGE")==0)return Constant.BACKEND_BASE+"/app/assets/"+path;else return Constant.BACKEND_BASE+"/app/assets/IMAGE/"+path};Production.get(productionUuid).success(function(data){$scope.production=data;if($scope.production.type==
Constant.PROD_TYPE[1].value)ProductionBom.getAll(productionUuid).success(function(data){$scope.boms=data;$scope.bomsLength=$scope.boms?$scope.boms.content.length:0});ProductionPic.getAll(productionUuid).success(function(data){$scope.picsData=data;$scope.pics=[];$scope.pics.push($scope.getImageFullPath($scope.production.path));angular.forEach($scope.picsData.content,function(item){if($scope.pics.indexOf(Constant.BACKEND_BASE+"/app/assets/"+item.path)==-1)$scope.pics.push(Constant.BACKEND_BASE+"/app/assets/"+
item.path)})})});$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").controller("SelectBomController",function($scope,$mdDialog,Production,selectedItem,selectedBom){$scope.selectedItem=selectedItem;$scope.bom=selectedBom||{};$scope.bomItemSearchParam={confirm:2,release:2,status:1};if($scope.bom.effectiveDate)$scope.bom.effectiveDateUI=new Date($scope.bom.effectiveDate);else $scope.bom.effectiveDateUI=new Date;if($scope.bom.expiredDate)$scope.bom.expiredDateUI=new Date($scope.bom.expiredDate);else $scope.bom.expiredDateUI=new Date;
$scope.selectBom=function(bomProduction){$scope.bom.item=bomProduction;$scope.bom.itemUuid=bomProduction.uuid;$scope.bom.parentItemUuid=selectedItem.uuid};$scope.hideDlg=function(){$scope.bom.effectiveDate=moment($scope.bom.effectiveDateUI).format("YYYY-MM-DD");$scope.bom.expiredDate=moment($scope.bom.expiredDateUI).format("YYYY-MM-DD");$mdDialog.hide($scope.bom)};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").controller("CustomController",function($scope,$mdDialog,Production,ProductionCustom,selectedItem,allCustoms,allCustomsScopes,custom,op){$scope.selectedItem=selectedItem;$scope.allCustoms=allCustoms.content;$scope.allCustomsScopes=allCustomsScopes;$scope.selectedCustom=custom;$scope.op=op;if($scope.selectedCustom)angular.forEach($scope.selectedCustom.informationUuids,function(value,index){angular.forEach($scope.allCustomsScopes[$scope.selectedCustom.itemCustom.uuid],
function(item){if(item.uuid==value)item.checked=true})});else $scope.selectedCustom={informationUuids:[]};$scope.customChangeHandler=function(customUuid){angular.forEach($scope.allCustoms,function(value,index){if(value.uuid==customUuid){$scope.selectedCustom.itemCustom=value;$scope.selectedCustom.astrict=value.astrict}});angular.forEach($scope.allCustomsScopes[$scope.selectedCustom.itemCustom.uuid],function(item){item.checked=false});angular.forEach($scope.selectedCustom.informationUuids,function(value,
index){angular.forEach($scope.allCustomsScopes[$scope.selectedCustom.itemCustom.uuid],function(item){if(item.uuid==value)item.checked=true})})};$scope.checkBoxChangeHandler=function(data,selected){if(selected==true)$scope.selectedCustom.informationUuids.push(data.uuid);else angular.forEach($scope.selectedCustom.informationUuids,function(value,index){if(value==data.uuid)$scope.selectedCustom.informationUuids.splice(index,1)})};$scope.hideDlg=function(){$scope.selectedCustom.information=JSON.stringify($scope.selectedCustom.informationUuids);
$mdDialog.hide({"selectedCustom":$scope.selectedCustom})};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").service("Production",function($http,Constant){this.getAll=function(sizePerPage,page,confirm,release,status,prodType,stopProd,no,name,resUuid,eshopType,assemblingFlag,orderByName){confirm=confirm==0?"":confirm;release=release==0?"":release;status=status==0?"":status;prodType=prodType==0?"":prodType;stopProd=stopProd==0?"":stopProd;if(no==undefined)no="";else no=no.replace(/\+/g,"%2B");if(name==undefined)name="";else name=name.replace(/\+/g,"%2B");if(resUuid==undefined)resUuid=
"";if(assemblingFlag==undefined)assemblingFlag="";if(eshopType==undefined||eshopType==0)eshopType="";if(orderByName==undefined||orderByName==null)orderByName="2";return $http.get(Constant.BACKEND_BASE+"/items?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26confirm\x3d"+confirm+"\x26status\x3d"+status+"\x26release\x3d"+release+"\x26type\x3d"+prodType+"\x26stopProd\x3d"+stopProd+"\x26no\x3d"+no+"\x26name\x3d"+name+"\x26eshopType\x3d"+eshopType+"\x26assemblingFlag\x3d"+assemblingFlag+"\x26resUuid\x3d"+
resUuid+"\x26orderByName\x3d"+orderByName)};this.get=function(productionUuid,resUuid){return $http.get(Constant.BACKEND_BASE+"/items/"+productionUuid+"?resUuid\x3d"+resUuid)};this.modify=function(production){return $http.patch(Constant.BACKEND_BASE+"/items/"+production.uuid,production)};this.add=function(production){return $http.post(Constant.BACKEND_BASE+"/items/",production)};this.delete=function(productionUuid){return $http.delete(Constant.BACKEND_BASE+"/items/"+productionUuid)};this.addImage=
function(productionUuid,imageUuid){return $http.post(Constant.BACKEND_BASE+"/items/"+productionUuid+"/images",{itemImageFileUuid:imageUuid})};this.deleteImage=function(productionUuid,type){return $http.delete(Constant.BACKEND_BASE+"/items/"+productionUuid+"/images?imageTypes\x3d"+type)}});
angular.module("IOne-Production").service("ProductionBom",function($http,Constant){this.getAll=function(productionUuid){return $http.get(Constant.BACKEND_BASE+"/items/"+productionUuid+"/boms")};this.add=function(productionUuid,bom){return $http.post(Constant.BACKEND_BASE+"/items/"+productionUuid+"/boms",bom)};this.modify=function(productionUuid,bom){return $http.patch(Constant.BACKEND_BASE+"/items/"+productionUuid+"/boms/"+bom.uuid,bom)};this.delete=function(productionUuid,bomUuid){return $http.delete(Constant.BACKEND_BASE+
"/items/"+productionUuid+"/boms/"+bomUuid)}});
angular.module("IOne-Production").service("ProductionPic",function($http,Constant){this.getAll=function(productionUuid){return $http.get(Constant.BACKEND_BASE+"/items/"+productionUuid+"/paths")};this.add=function(production){return $http.post(Constant.BACKEND_BASE+"/items/"+production.uuid+"/paths",{itemUuid:production.uuid,no:Math.random().toString(36).substring(10)})};this.addImage=function(productionUuid,itemPathsUuid,fileUuid){return $http.post(Constant.BACKEND_BASE+"/items/"+productionUuid+"/paths/"+
itemPathsUuid+"/images",{imageFileUuid:fileUuid})};this.deleteImage=function(productionUuid,itemPathsUuid){return $http.delete(Constant.BACKEND_BASE+"/items/"+productionUuid+"/paths/"+itemPathsUuid)}});angular.module("IOne-Production").service("ProductionCustom",function($http,Constant){this.getAll=function(){return $http.get(Constant.BACKEND_BASE+"/itemCustoms")};this.getCustom=function(customUuid){return $http.get(Constant.BACKEND_BASE+"/itemCustoms/"+customUuid+"/scopes")}});
angular.module("IOne-Production").service("ProductionItemCustom",function($http,Constant){this.get=function(productionUuid){if(productionUuid==undefined)productionUuid="";return $http.get(Constant.BACKEND_BASE+"/items/"+productionUuid+"/customs?itemUuid\x3d"+productionUuid)};this.add=function(productionUuid,itemCustom){return $http.post(Constant.BACKEND_BASE+"/items/"+productionUuid+"/customs",itemCustom)};this.modify=function(productionUuid,itemCustomUuid,itemCustom){return $http.patch(Constant.BACKEND_BASE+
"/items/"+productionUuid+"/customs/"+itemCustomUuid,itemCustom)};this.delete=function(productionUuid,itemCustomUuid){return $http.delete(Constant.BACKEND_BASE+"/items/"+productionUuid+"/customs/"+itemCustomUuid)}});angular.module("IOne-Production").service("ProductionArea",function($http,Constant){this.getAll=function(){return $http.get(Constant.BACKEND_BASE+"/areas")};this.get=function(productionUuid){return $http.get(Constant.BACKEND_BASE+"/areas?itemUuid\x3d"+productionUuid)}});
angular.module("IOne-Production").service("ProductionBrand",function($http,Constant){this.getAll=function(resUuid){if(resUuid==undefined)resUuid="";return $http.get(Constant.BACKEND_BASE+"/brands?"+"resUuid\x3d"+resUuid)};this.get=function(productionUuid){return $http.get(Constant.BACKEND_BASE+"/areas?itemUuid\x3d"+productionUuid)};this.addImage=function(brandUuid,fileUuid){return $http.patch(Constant.BACKEND_BASE+"/brands/"+brandUuid+"?fileUuid\x3d"+fileUuid,{})}});
angular.module("IOne-Production").service("ProductionCatalogueDetails",function($http,Constant){this.getByCatalogue=function(catalogueUuid,sizePerPage,page,no,name,resUuid){if(no==undefined)no="";else no=no.replace(/\+/g,"%2B");if(name==undefined)name="";else name=name.replace(/\+/g,"%2B");if(resUuid==undefined)resUuid="";return $http.get(Constant.BACKEND_BASE+"/itemCatalogueDetails?catalogueUuid\x3d"+catalogueUuid+"\x26size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26itemNo\x3d"+no+"\x26itemName\x3d"+
name+"\x26resUuid\x3d"+resUuid)};this.getByCatalogueAndChannel=function(catalogueUuid,channelUuid,resUuid){var url="/itemCatalogueDetails/channel/"+channelUuid+"?catalogueUuid\x3d"+catalogueUuid+"\x26filterWithChannelPrice\x3d0";if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)};this.postByCatalogueAndChannel=function(catalogueUuid,channelUuid,resUuid){var url="/itemCatalogueDetails/channel/"+channelUuid+"?catalogueUuid\x3d"+catalogueUuid+
"\x26filterWithChannelPrice\x3d0";if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid+"\x26filterWithChannelPrice\x3d0";return $http.post(Constant.BACKEND_BASE+url)};this.getByProduction=function(productionUuid,sizePerPage,page){return $http.get(Constant.BACKEND_BASE+"/itemCatalogueDetails?itemUuid\x3d"+productionUuid+"\x26size\x3d"+sizePerPage+"\x26page\x3d"+page)};this.addLink=function(catalogueUuid,itemUuid){return $http.post(Constant.BACKEND_BASE+"/itemCatalogueDetails",{catalogueUuid:catalogueUuid,
itemUuid:itemUuid})};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/itemCatalogueDetails/"+uuid)};this.modify=function(uuid,item){return $http.patch(Constant.BACKEND_BASE+"/itemCatalogueDetails/"+uuid,item)}});
angular.module("IOne-Production").service("ProductionUnit",function($http,Constant){this.getAll=function(sizePerPage,page,itemUuid){return $http.get(Constant.BACKEND_BASE+"/plmUnits?itemUuid\x3d"+itemUuid+"\x26size\x3d"+sizePerPage+"\x26page\x3d"+page)};this.add=function(unitInput){return $http.post(Constant.BACKEND_BASE+"/plmUnits",unitInput)};this.modify=function(unitInput){return $http.patch(Constant.BACKEND_BASE+"/plmUnits/"+unitInput.uuid,unitInput)};this.delete=function(unitUuid){return $http.delete(Constant.BACKEND_BASE+
"/plmUnits/"+unitUuid)}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/receipt2s",{controller:"Receipt2sController",templateUrl:"app/src/app/order/receipt2s/receipt2s.html"})}]);
angular.module("IOne-Production").controller("Receipt2sController",function($scope,SalesOrderMaster,Receipt2s,Constant,$mdDialog,$q){$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={select:{receiptSalesOrderDetailStatus:Constant.CONFIRM[0].value,channelUuid:""},no:"",employeeName:"",customerName:""};$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.menuDisplayOption={"confirm1":{display:true,name:"审核",uuid:"5AB3F266-85F7-4660-83C4-BC6448C0F07C"},
"revertConfirm1":{display:true,name:"取审",uuid:"A18833D3-C407-44CF-93BE-B677AA34FF43"},"transfer1":{display:true,name:"抛转",uuid:"94DADF10-9D91-44D8-94AF-902EDCA6C8C6"},"reTransfer1":{display:true,name:"重抛",uuid:"C4C2BCAC-2136-4ED2-B2AB-283256CDD2A4"},"confirm2":{display:true,name:"审核",uuid:"423CAF07-4650-44D8-B7E1-DB7E1D360EA4"},"revertConfirm2":{display:true,name:"取审",uuid:"F12164BB-4F4F-4FE7-A1B2-A6E1CB1E2909"},"transfer2":{display:true,name:"抛转",uuid:"919D4FA4-883C-4A25-B04D-59AE0271C769"},"reTransfer2":{display:true,
name:"重抛",uuid:"56E306C1-612E-435C-BE15-F480EFBC84AB"}};$scope.refreshList=function(){Receipt2s.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.select.channelUuid,$scope.listFilterOption.no,$scope.listFilterOption.select.receiptSalesOrderDetailStatus,$scope.listFilterOption.customerName,$scope.RES_UUID_MAP.PSO.SO_RECEIPT.RES_UUID).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=
data.totalElements;$scope.selectAllFlag=false;$scope.selectedItemSize=0;$scope.selectedItemAmount=0})};$scope.getMenuAuthData($scope.RES_UUID_MAP.PSO.SO_RECEIPT.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)});$scope.$watch("listFilterOption.select",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=
0;$scope.pageOption.totalElements=0;$scope.refreshList()}};$scope.queryClick=function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()};$scope.selectAllFlag=false;$scope.selectedItemSize=0;$scope.selectedItemAmount=0;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;Receipt2s.get(item.uuid).success(function(data){$scope.subItemList=data.content;item.detailList=$scope.subItemList;$scope.setDetailsBgColor(item.detailList)});
$scope.displayAdvancedSearPanel=false};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;$scope.selectedItem=null};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel)Receipt2s.get(item.uuid).success(function(data){$scope.subItemList=data.content;item.detailList=$scope.subItemList;$scope.setDetailsBgColor(item.detailList)})};$scope.setDetailsBgColor=function(detailList){angular.forEach(detailList,
function(detail){if(detail.paidType=="1")detail.bgColor={"background-color":"#76EEC6"};else if(detail.paidType=="2")detail.bgColor={"background-color":"#76EEC6;"};else if(detail.paidType=="3")detail.bgColor={"background-color":"#FFEC8B;"};else if(detail.paidType=="4")detail.bgColor={"background-color":"#FFAEB9;"}})};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS)};
$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.status=="add")if($scope.domain=="PSO_ORDER_MST")console.info("add order mst...");
else{if($scope.domain=="PSO_ORDER_DTL")console.info("add order dtl...")}else if($scope.status=="edit")if($scope.domain=="PSO_ORDER_MST")console.info("edit order mst...");else if($scope.domain=="PSO_ORDER_DTL")console.info("edit order dtl...")};$scope.deleteDetailAction=function(detail){};$scope.selectItemAction=function(event,item){$scope.stopEventPropagation(event);if(item.selected==false||item.selected==undefined||item.selected==null){$scope.selectedItemSize+=1;$scope.selectedItemAmount+=item.originalOrderAmountTax}else{$scope.selectedItemSize-=
1;$scope.selectedItemAmount-=item.originalOrderAmountTax;$scope.selectAllFlag=false}};$scope.confirmClickAction=function(event,item){$scope.stopEventPropagation(event);if(item.confirm==Constant.CONFIRM[2].value)$scope.showConfirm("确认取消审核订单单头吗？","",function(){var OrderMasterUpdateInput={uuid:item.uuid,confirm:"1"};SalesOrderMaster.modify(OrderMasterUpdateInput).success(function(){item.confirm=Constant.CONFIRM[1].value;$scope.showInfo("取消审核成功！")}).error(function(response){$scope.showError($scope.getError(response.message));
$scope.showError(response.message)})});else $scope.showConfirm("确认审核订单单头吗？","",function(){var OrderMasterUpdateInput={uuid:item.uuid,confirm:"2"};SalesOrderMaster.modify(OrderMasterUpdateInput).success(function(){item.confirm=Constant.CONFIRM[2].value;$scope.showInfo("审核成功！")}).error(function(response){$scope.showError($scope.getError(response.message));$scope.showError(response.message)})})};$scope.detailConfirmClickAction=function(event,detail){$scope.stopEventPropagation(event);if(detail.status==
2)$scope.showConfirm("确认取消审核收退款单身吗？","",function(){var UpdateInput={uuid:detail.uuid,status:"1"};Receipt2s.modify(detail.salesOrderMaster.uuid,UpdateInput).success(function(data){detail.status="1";$scope.showInfo("取消审核成功！");$scope.getReturnOrderMasterCount()}).error(function(response){$scope.showError(response.message)})});else $scope.showConfirm("确认审核收退款单身吗？","",function(){var UpdateInput={uuid:detail.uuid,status:"2"};Receipt2s.modify(detail.salesOrderMaster.uuid,UpdateInput).success(function(data){detail.status=
"2";$scope.showInfo("审核成功！");$scope.getReturnOrderMasterCount()}).error(function(response){$scope.showError(response.message)})})};$scope.detailTransferClickAction=function(event,detail){$scope.stopEventPropagation(event);if(detail.transferFlag==2)$scope.showConfirm("确认重新抛转收退款单身吗？","",function(){var UpdateInput={uuid:detail.uuid,transferFlag:"2"};Receipt2s.modify(detail.salesOrderMaster.uuid,UpdateInput).success(function(data){$scope.showInfo("重新抛转成功！")}).error(function(response){$scope.showError(response.message)})});
else $scope.showConfirm("确认抛转收退款单身吗？","",function(){var UpdateInput={uuid:detail.uuid,transferFlag:"2"};Receipt2s.modify(detail.salesOrderMaster.uuid,UpdateInput).success(function(data){detail.transferFlag="2";$scope.showInfo("抛转成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.statusClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("status...")};$scope.releaseClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("release...")};
$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("delete...")};$scope.confirmAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var confirmedNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.confirm!=="2"){var OrderMasterUpdateInput={uuid:item.uuid,confirm:"2"};var response=SalesOrderMaster.modify(OrderMasterUpdateInput).success(function(){});promises.push(response);count++}else confirmedNos=
confirmedNos+item.no+","});if(count==0){$scope.showWarn("没有选择任何未审核的订单，请先选择订单！");return}if(confirmedNos!==""){confirmedNos=confirmedNos.substr(0,confirmedNos.length-1);$scope.showWarn("如下已审核过的订单将不再次审核："+confirmedNos)}$q.all(promises).then(function(data){console.info(data);$scope.refreshList();$scope.showInfo("审核成功！")},function(data){$scope.showError(data.data.message);$scope.showError(data.message)})};$scope.revertConfirmAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=
[];var unConfirmedNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.confirm=="2"){var OrderMasterUpdateInput={uuid:item.uuid,confirm:"1"};var response=SalesOrderMaster.modify(OrderMasterUpdateInput).success(function(){});promises.push(response);count++}else unConfirmedNos=unConfirmedNos+item.no+","});if(count==0){$scope.showWarn("没有选择任已审核的订单，请先选择订单！");return}if(unConfirmedNos!==""){unConfirmedNos=unConfirmedNos.substr(0,unConfirmedNos.length-1);$scope.showWarn("如下未审核过的订单将不执行取消审核："+
unConfirmedNos)}$q.all(promises).then(function(data){console.info(data);$scope.refreshList();$scope.showInfo("取消审核成功！")},function(data){$scope.showError(data.data.message);$scope.showError(data.message)})};$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("status all...")};$scope.releaseAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("release all...")};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);
console.info("delete all...")};$scope.selectAllAction=function(){angular.forEach($scope.itemList,function(item){if($scope.selectAllFlag)item.selected=true;else item.selected=false});$scope.selectedItemSize=0;$scope.selectedItemAmount=0;if($scope.selectAllFlag)angular.forEach($scope.itemList,function(item){$scope.selectedItemSize++;$scope.selectedItemAmount+=item.originalOrderAmountTax})};$scope.openChannelDlg=function(){$mdDialog.show({controller:"selectChannelController",templateUrl:"app/src/app/order/receipts/selectChannel.html",
parent:angular.element(document.body),targetEvent:event}).then(function(data){$scope.listFilterOption.select.channelUuid=data.uuid;$scope.listFilterOption.select.channelName=data.name})};$scope.clearChannel=function(){$scope.listFilterOption.select.channelUuid="";$scope.listFilterOption.select.channelName=""};$scope.getReturnOrderMasterCount=function(){Receipt2s.getReceiptOrderMasterCount(Constant.CONFIRM[1].value,RES_UUID_MAP.PSO.SO_RECEIPT.RES_UUID).success(function(data){$scope.menuList[1].subList[10].suffix=
data})}});
angular.module("IOne-Production").controller("selectChannelController",function($scope,$mdDialog,ChannelService){$scope.pageOption={sizePerPage:5,currentPage:0,totalPage:0,totalElements:0};$scope.queryAction=function(){$scope.pageOption.currentPage=0;$scope.refreshChannel()};$scope.refreshChannel=function(){ChannelService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,0,0,$scope.searchKeyword).success(function(data){$scope.allChannel=data;$scope.pageOption.totalElements=data.totalElements;
$scope.pageOption.totalPage=data.totalPages})};$scope.refreshChannel();$scope.selectChannel=function(channel){$scope.channel=channel;$mdDialog.hide($scope.channel)};$scope.hideDlg=function(){$mdDialog.hide($scope.channel)};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").service("Receipt2s",function($http,Constant){this.getAll=function(sizePerPage,page,channelUuid,no,receiptSalesOrderDetailStatus,customerName,resUuid){var receiptSalesOrderDetailStatus=receiptSalesOrderDetailStatus==0?"":receiptSalesOrderDetailStatus;var url="/salesOrders?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26onlyReceipt\x3d1";if(receiptSalesOrderDetailStatus!=="")url=url+"\x26receiptSalesOrderDetailStatus\x3d"+receiptSalesOrderDetailStatus;if(no!==null&&
no!=undefined)url=url+"\x26no\x3d"+no;if(channelUuid!=null&&channelUuid!=undefined)url=url+"\x26channelUuid\x3d"+channelUuid;if(customerName!==null)url=url+"\x26customerName\x3d"+customerName;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)};this.getReceiptOrderMasterCount=function(receiptSalesOrderDetailStatus,resUuid){var receiptSalesOrderDetailStatus=receiptSalesOrderDetailStatus==0?"":receiptSalesOrderDetailStatus;var url="/salesOrders/count?"+
"\x26onlyReceipt\x3d1"+"\x26receiptSalesOrderDetailStatus\x3d"+receiptSalesOrderDetailStatus;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)};this.get=function(masterUuid,scope){var url="/salesOrders/"+masterUuid+"/receipts?";if(scope!=null)url=url+"scope\x3d"+scope;return $http.get(Constant.BACKEND_BASE+url)};this.modify=function(masterUuid,detailUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/salesOrders/"+masterUuid+"/receipts/"+
detailUpdateInput.uuid,detailUpdateInput)}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/eps-receipts",{controller:"EPSReceiptsController",templateUrl:"app/src/app/eps/receipts/receipts.html"})}]);
angular.module("IOne-Production").controller("EPSReceiptsController",function($scope,EPSMaster,EPSReceipts,Constant,$mdDialog,$q){$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={confirm:Constant.CONFIRM[0].value,no:"",channelUuid:"",orderAmount:"",paidAmount:"",unpaidAmount:""};$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.menuDisplayOption={"confirm1":{display:true,name:"审核",uuid:"D3945D68-1D4B-49C3-A15C-A02C65E967EC"},
"revertConfirm1":{display:true,name:"取审",uuid:"89285E70-F415-4119-9417-71E7BF1C310D"},"transfer1":{display:true,name:"抛转",uuid:"50FC0723-84F0-4F29-81CB-732AEF6EE050"},"reTransfer1":{display:true,name:"重抛",uuid:"C08D943E-8882-43B9-9720-0C9B57F9DAA2"},"confirm2":{display:true,name:"审核",uuid:"FFD5D3AB-8015-43D4-8D37-72898CC435A9"},"revertConfirm2":{display:true,name:"取审",uuid:"E5F3C551-0EFE-4595-9B77-007E1424A0F0"},"transfer2":{display:true,name:"抛转",uuid:"36C1D06A-498F-4B55-BD99-25A8F84D6A32"},"reTransfer2":{display:true,
name:"重抛",uuid:"407D5987-4B3C-4441-80C3-3CA5F82E1930"}};$scope.refreshList=function(){EPSMaster.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,"",$scope.listFilterOption.confirm,"","","",$scope.listFilterOption.no,"","",$scope.RES_UUID_MAP.PSO.ORDER_RECEIPT.RES_UUID,$scope.listFilterOption.channelUuid).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;angular.forEach($scope.itemList,
function(item){item.unPaidAmount=item.orderAmount-item.paidAmount});$scope.selectAllFlag=false;$scope.selectedItemSize=0;$scope.selectedItemAmount=0})};$scope.getMenuAuthData($scope.RES_UUID_MAP.PSO.ORDER_RECEIPT.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data);console.info($scope.menuAuthDataMap)});$scope.$watch("listFilterOption",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);
$scope.selectAllFlag=false;$scope.selectedItemSize=0;$scope.selectedItemAmount=0;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;EPSReceipts.get(item.uuid).success(function(data){$scope.subItemList=data.content;item.detailList=$scope.subItemList;$scope.setDetailsBgColor(item.detailList)});$scope.displayAdvancedSearPanel=false};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;$scope.selectedItem=null};$scope.toggleMorePanelAction=
function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel)EPSReceipts.get(item.uuid).success(function(data){$scope.subItemList=data.content;item.detailList=$scope.subItemList;$scope.setDetailsBgColor(item.detailList)})};$scope.setDetailsBgColor=function(detailList){angular.forEach(detailList,function(detail){if(detail.paidType=="1")detail.bgColor={"background-color":"#76EEC6"};else if(detail.paidType=="2")detail.bgColor={"background-color":"#76EEC6;"};else if(detail.paidType=="3")detail.bgColor=
{"background-color":"#FFEC8B;"};else if(detail.paidType=="4")detail.bgColor={"background-color":"#FFAEB9;"}})};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS)};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.preAddItemAction=
function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.status=="add")if($scope.domain=="PSO_ORDER_MST")console.info("add order mst...");else{if($scope.domain=="PSO_ORDER_DTL")console.info("add order dtl...")}else if($scope.status=="edit")if($scope.domain=="PSO_ORDER_MST")console.info("edit order mst...");else if($scope.domain=="PSO_ORDER_DTL")console.info("edit order dtl...")};
$scope.deleteDetailAction=function(detail){};$scope.selectItemAction=function(event,item){$scope.stopEventPropagation(event);if(item.selected==false||item.selected==undefined||item.selected==null){$scope.selectedItemSize+=1;$scope.selectedItemAmount+=item.orderAmount}else{$scope.selectedItemSize-=1;$scope.selectedItemAmount-=item.orderAmount;$scope.selectAllFlag=false}};$scope.confirmClickAction=function(event,item){$scope.stopEventPropagation(event);if(item.confirm==Constant.CONFIRM[2].value)$scope.showConfirm("确认取消审核订单单头吗？",
"",function(){var OrderMasterUpdateInput={uuid:item.uuid,confirm:"1"};EPSMaster.modify(OrderMasterUpdateInput).success(function(){item.confirm=Constant.CONFIRM[1].value;$scope.showInfo("取消审核成功！")}).error(function(response){$scope.showError(response.message)})});else $scope.showConfirm("确认审核订单单头吗？","",function(){var OrderMasterUpdateInput={uuid:item.uuid,confirm:"2"};EPSMaster.modify(OrderMasterUpdateInput).success(function(){item.confirm=Constant.CONFIRM[2].value;$scope.showInfo("审核成功！")}).error(function(response){$scope.showError(response.message)})})};
$scope.detailConfirmClickAction=function(event,detail){$scope.stopEventPropagation(event);if(detail.status==2)$scope.showConfirm("确认取消审核收退银单身吗？","",function(){var UpdateInput={uuid:detail.uuid,status:"1"};EPSReceipts.modify(detail.epsOrder.uuid,UpdateInput).success(function(data){detail.status="1";$scope.showInfo("取消审核成功！")}).error(function(response){$scope.showError(response.message)})});else $scope.showConfirm("确认审核收退银单身吗？","",function(){var UpdateInput={uuid:detail.uuid,status:"2"};EPSReceipts.modify(detail.epsOrder.uuid,
UpdateInput).success(function(data){detail.status="2";$scope.showInfo("审核成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.detailTransferClickAction=function(event,detail){$scope.stopEventPropagation(event);if(detail.transferFlag==2)$scope.showConfirm("确认重新抛转收退银单身吗？","",function(){var UpdateInput={uuid:detail.uuid,transferFlag:"2",transferAgain:"2"};EPSReceipts.modify(detail.epsOrder.uuid,UpdateInput).success(function(data){$scope.showInfo("重新抛转成功！")}).error(function(response){$scope.showError(response.message)})});
else $scope.showConfirm("确认抛转收退银单身吗？","",function(){var UpdateInput={uuid:detail.uuid,transferFlag:"2"};EPSReceipts.modify(detail.epsOrder.uuid,UpdateInput).success(function(data){detail.transferFlag="2";$scope.showInfo("抛转成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.statusClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("status...")};$scope.releaseClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("release...")};
$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("delete...")};$scope.confirmAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var confirmedNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.confirm!="2"){var OrderMasterUpdateInput={uuid:item.uuid,confirm:"2"};var response=EPSMaster.modify(OrderMasterUpdateInput).success(function(){});promises.push(response);count++}else confirmedNos=
confirmedNos+item.no+","});if(count==0){$scope.showWarn("没有选择任何未审核的订单，请先选择订单！");return}if(confirmedNos!==""){confirmedNos=confirmedNos.substr(0,confirmedNos.length-1);$scope.showWarn("如下已审核过的订单将不再次审核："+confirmedNos)}$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("审核成功！")},function(data){$scope.showError(data.data.message);$scope.showError(data.message)})};$scope.revertConfirmAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var unConfirmedNos=
"";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.confirm=="2"){var OrderMasterUpdateInput={uuid:item.uuid,confirm:"1"};var response=EPSMaster.modify(OrderMasterUpdateInput).success(function(){});promises.push(response);count++}else unConfirmedNos=unConfirmedNos+item.no+","});if(count==0){$scope.showWarn("没有选择任已审核的订单，请先选择订单！");return}if(unConfirmedNos!==""){unConfirmedNos=unConfirmedNos.substr(0,unConfirmedNos.length-1);$scope.showWarn("如下未审核过的订单将不执行取消审核："+
unConfirmedNos)}$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("取消审核成功！")},function(data){$scope.showError(data.data.message);$scope.showError(data.message)})};$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("status all...")};$scope.releaseAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("release all...")};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("delete all...")};
$scope.selectAllAction=function(){angular.forEach($scope.itemList,function(item){if($scope.selectAllFlag)item.selected=true;else item.selected=false});$scope.selectedItemSize=0;$scope.selectedItemAmount=0;if($scope.selectAllFlag)angular.forEach($scope.itemList,function(item){$scope.selectedItemSize++;$scope.selectedItemAmount+=item.orderAmount})};$scope.openChannelDlg=function(){$mdDialog.show({controller:"selectChannelController",templateUrl:"app/src/app/eps/receipts/selectChannel.html",parent:angular.element(document.body),
targetEvent:event}).then(function(data){$scope.listFilterOption.channelUuid=data.uuid;$scope.listFilterOption.channelName=data.name})};$scope.clearChannel=function(){$scope.listFilterOption.channelUuid="";$scope.listFilterOption.channelName=""}});
angular.module("IOne-Production").controller("selectChannelController",function($scope,$mdDialog,ChannelService){$scope.pageOption={sizePerPage:5,currentPage:0,totalPage:0,totalElements:0};$scope.queryAction=function(){$scope.pageOption.currentPage=0;$scope.refreshChannel()};$scope.refreshChannel=function(){ChannelService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,0,0,$scope.searchKeyword).success(function(data){$scope.allChannel=data;$scope.pageOption.totalElements=data.totalElements;
$scope.pageOption.totalPage=data.totalPages})};$scope.refreshChannel();$scope.selectChannel=function(channel){$scope.channel=channel;$mdDialog.hide($scope.channel)};$scope.hideDlg=function(){$mdDialog.hide($scope.channel)};$scope.cancelDlg=function(){$mdDialog.cancel()}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/receipts",{controller:"ReceiptsController",templateUrl:"app/src/app/order/receipts/receipts.html"})}]);
angular.module("IOne-Production").controller("ReceiptsController",function($scope,OrderMaster,Receipts,Constant,$mdDialog,$q){$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={select:{orderReceiptDetailStatus:Constant.CONFIRM[0].value,channelUuid:""},no:"",orderAmount:"",paidAmount:"",unpaidAmount:""};$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.menuDisplayOption={"confirm1":{display:true,name:"审核",
uuid:"AF475D01-1DCA-4D2B-A78C-62EB9B8B6DCB"},"revertConfirm1":{display:true,name:"取审",uuid:"EF97A1B9-CAB2-438E-90B7-6A0B18384B3B"},"transfer1":{display:true,name:"抛转",uuid:"F9EBFCBB-3322-4931-A8A9-550610D15AD6"},"reTransfer1":{display:true,name:"重抛",uuid:"2F33B1DD-D2A1-4DEF-80B4-4043D52548F1"},"confirm2":{display:true,name:"审核",uuid:"37339D36-5572-4794-85D8-BD8137B167C4"},"revertConfirm2":{display:true,name:"取审",uuid:"7CC43966-9B22-406D-9776-36AAEEF71457"},"transfer2":{display:true,name:"抛转",uuid:"E3BDFCD2-7A73-4931-B3C5-8FFD702A8FAC"},
"reTransfer2":{display:true,name:"重抛",uuid:"F37B3561-83AA-43CB-9BDB-F7AFF42277A8"},"oneOffSync":{display:true,name:"一键抛转",uuid:"1A99B73F-7B6A-4FD6-A8BF-9324F19A4510"}};$scope.refreshList=function(){Receipts.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.select.channelUuid,$scope.listFilterOption.no,$scope.listFilterOption.select.orderReceiptDetailStatus,$scope.listFilterOption.orderAmount,$scope.listFilterOption.paidAmount,$scope.listFilterOption.unpaidAmount,
$scope.RES_UUID_MAP.PSO.ORDER_RECEIPT.RES_UUID).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;angular.forEach($scope.itemList,function(item){item.unPaidAmount=item.orderAmount-item.paidAmount});$scope.selectAllFlag=false;$scope.selectedItemSize=0;$scope.selectedItemAmount=0})};$scope.getMenuAuthData($scope.RES_UUID_MAP.PSO.ORDER_RECEIPT.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data);
console.info($scope.menuAuthDataMap)});$scope.$watch("listFilterOption.select",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()}};$scope.queryClick=function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=
0;$scope.refreshList()};$scope.selectAllFlag=false;$scope.selectedItemSize=0;$scope.selectedItemAmount=0;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;Receipts.get(item.uuid).success(function(data){$scope.subItemList=data.content;item.detailList=$scope.subItemList;$scope.setDetailsBgColor(item.detailList)});$scope.displayAdvancedSearPanel=false};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;$scope.selectedItem=null};
$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel)Receipts.get(item.uuid).success(function(data){$scope.subItemList=data.content;item.detailList=$scope.subItemList;$scope.setDetailsBgColor(item.detailList)})};$scope.setDetailsBgColor=function(detailList){angular.forEach(detailList,function(detail){if(detail.paidType=="1")detail.bgColor={"background-color":"#76EEC6"};else if(detail.paidType=="2")detail.bgColor={"background-color":"#76EEC6;"};else if(detail.paidType==
"3")detail.bgColor={"background-color":"#FFEC8B;"};else if(detail.paidType=="4")detail.bgColor={"background-color":"#FFAEB9;"}})};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS)};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=
domain};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.status=="add")if($scope.domain=="PSO_ORDER_MST")console.info("add order mst...");else{if($scope.domain=="PSO_ORDER_DTL")console.info("add order dtl...")}else if($scope.status=="edit")if($scope.domain=="PSO_ORDER_MST")console.info("edit order mst...");else if($scope.domain==
"PSO_ORDER_DTL")console.info("edit order dtl...")};$scope.deleteDetailAction=function(detail){};$scope.selectItemAction=function(event,item){$scope.stopEventPropagation(event);if(item.selected==false||item.selected==undefined||item.selected==null){$scope.selectedItemSize+=1;$scope.selectedItemAmount+=item.orderAmount}else{$scope.selectedItemSize-=1;$scope.selectedItemAmount-=item.orderAmount;$scope.selectAllFlag=false}};$scope.confirmClickAction=function(event,item){$scope.stopEventPropagation(event);
if(item.confirm==Constant.CONFIRM[2].value)$scope.showConfirm("确认取消审核订单单头吗？","",function(){var OrderMasterUpdateInput={uuid:item.uuid,confirm:"1"};OrderMaster.modify(OrderMasterUpdateInput).success(function(){item.confirm=Constant.CONFIRM[1].value;$scope.showInfo("取消审核成功！")}).error(function(response){$scope.showError(response.message)})});else $scope.showConfirm("确认审核订单单头吗？","",function(){var OrderMasterUpdateInput={uuid:item.uuid,confirm:"2"};OrderMaster.modify(OrderMasterUpdateInput).success(function(){item.confirm=
Constant.CONFIRM[2].value;$scope.showInfo("审核成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.detailConfirmClickAction=function(event,detail){$scope.stopEventPropagation(event);if(detail.status==2)$scope.showConfirm("确认取消审核收退银单身吗？","",function(){var UpdateInput={uuid:detail.uuid,status:"1"};Receipts.modify(detail.orderMaster.uuid,UpdateInput).success(function(data){detail.status="1";$scope.showInfo("取消审核成功！");$scope.getReturnOrderMasterCount()}).error(function(response){$scope.showError(response.message)})});
else $scope.showConfirm("确认审核收退银单身吗？","",function(){var UpdateInput={uuid:detail.uuid,status:"2"};Receipts.modify(detail.orderMaster.uuid,UpdateInput).success(function(data){detail.status="2";$scope.showInfo("审核成功！");$scope.getReturnOrderMasterCount()}).error(function(response){$scope.showError(response.message)})})};$scope.detailTransferClickAction=function(event,detail){$scope.stopEventPropagation(event);if(detail.transferFlag==2)$scope.showConfirm("确认重新抛转收退银单身吗？","",function(){var UpdateInput=
{uuid:detail.uuid,receiptOrderConversion:"true"};Receipts.modify(detail.orderMaster.uuid,UpdateInput).success(function(data){$scope.showInfo("重新抛转成功！")}).error(function(response){$scope.showError(response.message)})});else $scope.showConfirm("确认抛转收退银单身吗？","",function(){var UpdateInput={uuid:detail.uuid,transferFlag:"2",receiptOrderConversion:"true"};Receipts.modify(detail.orderMaster.uuid,UpdateInput).success(function(data){detail.transferFlag="2";$scope.showInfo("抛转成功！")}).error(function(response){$scope.showError(response.message)})})};
$scope.oneOffSync=function(event,detail){$scope.stopEventPropagation(event);$scope.showConfirm("确认一键抛转收退银单身吗？","",function(){var updateInput={uuid:detail.uuid};Receipts.oneOffSync(detail.orderMaster.uuid,updateInput).success(function(response){detail.transferFlag="2";$scope.showInfo("一键同步成功。")}).error(function(response){$scope.showError(response.message)})})};$scope.statusClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("status...")};$scope.releaseClickAction=function(event,
item){$scope.stopEventPropagation(event);console.info("release...")};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("delete...")};$scope.confirmAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var confirmedNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.confirm!="2"){var OrderMasterUpdateInput={uuid:item.uuid,confirm:"2"};var response=OrderMaster.modify(OrderMasterUpdateInput).success(function(){});
promises.push(response);count++}else confirmedNos=confirmedNos+item.no+","});if(count==0){$scope.showWarn("没有选择任何未审核的订单，请先选择订单！");return}if(confirmedNos!==""){confirmedNos=confirmedNos.substr(0,confirmedNos.length-1);$scope.showWarn("如下已审核过的订单将不再次审核："+confirmedNos)}$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("审核成功！")},function(data){$scope.showError(data.data.message);$scope.showError(data.message)})};$scope.revertConfirmAllClickAction=function(event){$scope.stopEventPropagation(event);
var promises=[];var unConfirmedNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.confirm=="2"){var OrderMasterUpdateInput={uuid:item.uuid,confirm:"1"};var response=OrderMaster.modify(OrderMasterUpdateInput).success(function(){});promises.push(response);count++}else unConfirmedNos=unConfirmedNos+item.no+","});if(count==0){$scope.showWarn("没有选择任已审核的订单，请先选择订单！");return}if(unConfirmedNos!==""){unConfirmedNos=unConfirmedNos.substr(0,unConfirmedNos.length-
1);$scope.showWarn("如下未审核过的订单将不执行取消审核："+unConfirmedNos)}$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("取消审核成功！")},function(data){$scope.showError(data.data.message);$scope.showError(data.message)})};$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("status all...")};$scope.releaseAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("release all...")};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);
console.info("delete all...")};$scope.selectAllAction=function(){angular.forEach($scope.itemList,function(item){if($scope.selectAllFlag)item.selected=true;else item.selected=false});$scope.selectedItemSize=0;$scope.selectedItemAmount=0;if($scope.selectAllFlag)angular.forEach($scope.itemList,function(item){$scope.selectedItemSize++;$scope.selectedItemAmount+=item.orderAmount})};$scope.openChannelDlg=function(){$mdDialog.show({controller:"selectChannelController",templateUrl:"app/src/app/order/receipts/selectChannel.html",
parent:angular.element(document.body),targetEvent:event}).then(function(data){$scope.listFilterOption.select.channelUuid=data.uuid;$scope.listFilterOption.select.channelName=data.name})};$scope.clearChannel=function(){$scope.listFilterOption.select.channelUuid="";$scope.listFilterOption.select.channelName=""};$scope.getReturnOrderMasterCount=function(){Receipts.getReceiptOrderMasterCount(Constant.CONFIRM[1].value,RES_UUID_MAP.PSO.ORDER_RECEIPT.RES_UUID).success(function(data){$scope.menuList[1].subList[9].suffix=
data})}});
angular.module("IOne-Production").controller("selectChannelController",function($scope,$mdDialog,ChannelService){$scope.pageOption={sizePerPage:5,currentPage:0,totalPage:0,totalElements:0};$scope.queryAction=function(){$scope.pageOption.currentPage=0;$scope.refreshChannel()};$scope.refreshChannel=function(){ChannelService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,0,0,$scope.searchKeyword).success(function(data){$scope.allChannel=data;$scope.pageOption.totalElements=data.totalElements;
$scope.pageOption.totalPage=data.totalPages})};$scope.refreshChannel();$scope.selectChannel=function(channel){$scope.channel=channel;$mdDialog.hide($scope.channel)};$scope.hideDlg=function(){$mdDialog.hide($scope.channel)};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").service("Receipts",function($http,Constant){this.getAll=function(sizePerPage,page,channelUuid,no,orderReceiptDetailStatus,orderAmount,paidAmount,unpaidAmount,resUuid){var orderReceiptDetailStatus=orderReceiptDetailStatus==0?"":orderReceiptDetailStatus;var url="orders?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26paidType\x3d0";if(orderReceiptDetailStatus!=="")url=url+"\x26orderReceiptDetailStatus\x3d"+orderReceiptDetailStatus;if(no!==undefined&&no!==null)url=url+
"\x26orderMasterNo\x3d"+no;if(channelUuid!==undefined&&channelUuid!=null)url=url+"\x26channelUuid\x3d"+channelUuid;if(orderAmount!==undefined&&orderAmount!==null)url=url+"\x26orderAmount\x3d"+orderAmount;if(paidAmount!==undefined&&paidAmount!==null)url=url+"\x26paidAmount\x3d"+paidAmount;if(unpaidAmount!==undefined&&unpaidAmount!==null)url=url+"\x26unpaidAmount\x3d"+unpaidAmount;if(resUuid!=null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)};this.getReceiptOrderMasterCount=
function(orderReceiptDetailStatus,resUuid){var orderReceiptDetailStatus=orderReceiptDetailStatus==0?"":orderReceiptDetailStatus;var url="/orders/count?"+"\x26paidType\x3d0"+"\x26orderReceiptDetailStatus\x3d"+orderReceiptDetailStatus;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)};this.get=function(masterUuid,scope){var url="/orders/"+masterUuid+"/receipts?";if(scope!=null)url=url+"scope\x3d"+scope;return $http.get(Constant.BACKEND_BASE+
url)};this.modify=function(masterUuid,detailUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/orders/"+masterUuid+"/receipts/"+detailUpdateInput.uuid,detailUpdateInput)};this.oneOffSync=function(uuid,detailUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/orders/"+uuid+"/receipts/"+detailUpdateInput.uuid+"/sync",detailUpdateInput)}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/refunds",{controller:"RefundController",templateUrl:"app/src/app/order/refund/refund.html"})}]);
angular.module("IOne-Production").controller("RefundController",function($scope,OrderMaster,Receipts,Constant,$mdDialog,$q){$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={confirm:Constant.CONFIRM[0].value,no:"",channelUuid:"",orderAmount:"",paidAmount:"",unpaidAmount:""};$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.refreshList=function(){OrderMaster.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,
$scope.listFilterOption.confirm,"","",$scope.listFilterOption.no,"","","","","",$scope.listFilterOption.channelUuid,$scope.listFilterOption.orderAmount,$scope.listFilterOption.paidAmount,$scope.listFilterOption.unpaidAmount,"2").success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;angular.forEach($scope.itemList,function(item){item.unPaidAmount=item.orderAmount-item.paidAmount});$scope.selectAllFlag=false;
$scope.selectedItemSize=0;$scope.selectedItemAmount=0})};$scope.$watch("listFilterOption",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.selectAllFlag=false;$scope.selectedItemSize=0;$scope.selectedItemAmount=0;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;Receipts.get(item.uuid,"2").success(function(data){$scope.subItemList=data.content;item.detailList=$scope.subItemList;$scope.setDetailsBgColor(item.detailList)});
$scope.displayAdvancedSearPanel=false};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;$scope.selectedItem=null};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel)Receipts.get(item.uuid,"2").success(function(data){$scope.subItemList=data.content;item.detailList=$scope.subItemList;$scope.setDetailsBgColor(item.detailList)})};$scope.setDetailsBgColor=function(detailList){angular.forEach(detailList,
function(detail){if(detail.paidType=="3")detail.bgColor={"background-color":"#f6e343;"};else if(detail.paidType=="4")detail.bgColor={"background-color":"#fd8e74;"}})};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS)};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;
$scope.source=source;$scope.domain=domain};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.status=="add")if($scope.domain=="PSO_ORDER_MST")console.info("add order mst...");else{if($scope.domain=="PSO_ORDER_DTL")console.info("add order dtl...")}else if($scope.status=="edit")if($scope.domain=="PSO_ORDER_MST")console.info("edit order mst...");
else if($scope.domain=="PSO_ORDER_DTL")console.info("edit order dtl...")};$scope.deleteDetailAction=function(detail){};$scope.selectItemAction=function(event,item){$scope.stopEventPropagation(event);if(item.selected==false||item.selected==undefined||item.selected==null){$scope.selectedItemSize+=1;$scope.selectedItemAmount+=item.orderAmount}else{$scope.selectedItemSize-=1;$scope.selectedItemAmount-=item.orderAmount;$scope.selectAllFlag=false}};$scope.confirmClickAction=function(event,item){$scope.stopEventPropagation(event);
if(item.confirm==Constant.CONFIRM[2].value)$scope.showConfirm("确认取消审核订单单头吗？","",function(){var OrderMasterUpdateInput={uuid:item.uuid,confirm:"1"};OrderMaster.modify(OrderMasterUpdateInput).success(function(){item.confirm=Constant.CONFIRM[1].value;$scope.showInfo("取消审核成功！")}).error(function(response){$scope.showError($scope.getError(response.message));$scope.showError(response.message)})});else $scope.showConfirm("确认审核订单单头吗？","",function(){var OrderMasterUpdateInput={uuid:item.uuid,confirm:"2"};OrderMaster.modify(OrderMasterUpdateInput).success(function(){item.confirm=
Constant.CONFIRM[2].value;$scope.showInfo("审核成功！")}).error(function(response){$scope.showError($scope.getError(response.message));$scope.showError(response.message)})})};$scope.detailConfirmClickAction=function(event,detail){$scope.stopEventPropagation(event);if(detail.status==2)$scope.showConfirm("确认取消审核收银单身吗？","",function(){var UpdateInput={uuid:detail.uuid,status:"1"};Receipts.modify(detail.orderMaster.uuid,UpdateInput).success(function(data){detail.status="1";console.info("取消审核成功返回：");console.info(data);
$scope.showInfo("取消审核成功！")}).error(function(response){$scope.showError($scope.getError(response.message));$scope.showError(response.message)})});else $scope.showConfirm("确认审核收银单身吗？","",function(){var UpdateInput={uuid:detail.uuid,status:"2"};Receipts.modify(detail.orderMaster.uuid,UpdateInput).success(function(data){detail.status="2";console.info("审核成功返回：");console.info(data);$scope.showInfo("审核成功！")}).error(function(response){$scope.showError($scope.getError(response.message));$scope.showError(response.message)})})};
$scope.detailTransferClickAction=function(event,detail){$scope.stopEventPropagation(event);if(detail.transferFlag==2)$scope.showConfirm("确认重新抛转收银单身吗？","",function(){var UpdateInput={uuid:detail.uuid,receiptOrderConversion:"true"};Receipts.modify(detail.orderMaster.uuid,UpdateInput).success(function(data){$scope.showInfo("重新抛转成功！")}).error(function(response){$scope.showError(response.message)})});else $scope.showConfirm("确认抛转收银单身吗？","",function(){var UpdateInput={uuid:detail.uuid,transferFlag:"2",
receiptOrderConversion:"true"};Receipts.modify(detail.orderMaster.uuid,UpdateInput).success(function(data){detail.transferFlag="2";$scope.showInfo("抛转成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.statusClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("status...")};$scope.releaseClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("release...")};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);
console.info("delete...")};$scope.confirmAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var confirmedNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.confirm!=="2"){var OrderMasterUpdateInput={uuid:item.uuid,confirm:"2"};var response=OrderMaster.modify(OrderMasterUpdateInput).success(function(){});promises.push(response);count++}else confirmedNos=confirmedNos+item.no+","});if(count==0){$scope.showWarn("没有选择任何未审核的订单，请先选择订单！");
return}if(confirmedNos!==""){confirmedNos=confirmedNos.substr(0,confirmedNos.length-1);$scope.showWarn("如下已审核过的订单将不再次审核："+confirmedNos)}$q.all(promises).then(function(data){console.info(data);$scope.refreshList();$scope.showInfo("审核成功！")},function(data){$scope.showError(data.data.message);$scope.showError(data.message)})};$scope.revertConfirmAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var unConfirmedNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===
true)if(item.confirm=="2"){var OrderMasterUpdateInput={uuid:item.uuid,confirm:"1"};var response=OrderMaster.modify(OrderMasterUpdateInput).success(function(){});promises.push(response);count++}else unConfirmedNos=unConfirmedNos+item.no+","});if(count==0){$scope.showWarn("没有选择任已审核的订单，请先选择订单！");return}if(unConfirmedNos!==""){unConfirmedNos=unConfirmedNos.substr(0,unConfirmedNos.length-1);$scope.showWarn("如下未审核过的订单将不执行取消审核："+unConfirmedNos)}$q.all(promises).then(function(data){console.info(data);$scope.refreshList();
$scope.showInfo("取消审核成功！")},function(data){$scope.showError(data.data.message);$scope.showError(data.message)})};$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("status all...")};$scope.releaseAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("release all...")};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("delete all...")};$scope.selectAllAction=function(){angular.forEach($scope.itemList,
function(item){if($scope.selectAllFlag)item.selected=true;else item.selected=false});$scope.selectedItemSize=0;$scope.selectedItemAmount=0;if($scope.selectAllFlag)angular.forEach($scope.itemList,function(item){$scope.selectedItemSize++;$scope.selectedItemAmount+=item.orderAmount})};$scope.openChannelDlg=function(){$mdDialog.show({controller:"selectChannelController",templateUrl:"app/src/app/order/receipts/selectChannel.html",parent:angular.element(document.body),targetEvent:event}).then(function(data){$scope.listFilterOption.channelUuid=
data.uuid;$scope.listFilterOption.channelName=data.name})};$scope.clearChannel=function(){$scope.listFilterOption.channelUuid="";$scope.listFilterOption.channelName=""}});
angular.module("IOne-Production").controller("selectChannelController",function($scope,$mdDialog,ChannelService){$scope.pageOption={sizePerPage:5,currentPage:0,totalPage:0,totalElements:0};$scope.queryAction=function(){$scope.pageOption.currentPage=0;$scope.refreshChannel()};$scope.refreshChannel=function(){ChannelService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,0,0,$scope.searchKeyword).success(function(data){$scope.allChannel=data;$scope.pageOption.totalElements=data.totalElements;
$scope.pageOption.totalPage=data.totalPages})};$scope.refreshChannel();$scope.selectChannel=function(channel){$scope.channel=channel;$mdDialog.hide($scope.channel)};$scope.hideDlg=function(){$mdDialog.hide($scope.channel)};$scope.cancelDlg=function(){$mdDialog.cancel()}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/refund2s",{controller:"Refund2sController",templateUrl:"app/src/app/order/refund2/refund2.html"})}]);
angular.module("IOne-Production").controller("Refund2sController",function($scope,OrderMaster,Receipt2s,Constant,$mdDialog,$q){$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={confirm:Constant.CONFIRM[0].value,no:"",channelUuid:"",orderAmount:"",paidAmount:"",unpaidAmount:""};$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.refreshList=function(){OrderMaster.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,
$scope.listFilterOption.confirm,"","",$scope.listFilterOption.no,"","","","","",$scope.listFilterOption.channelUuid,$scope.listFilterOption.orderAmount,$scope.listFilterOption.paidAmount,$scope.listFilterOption.unpaidAmount,null,"2").success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;angular.forEach($scope.itemList,function(item){item.unPaidAmount=item.orderAmount-item.paidAmount});$scope.selectAllFlag=
false;$scope.selectedItemSize=0;$scope.selectedItemAmount=0})};$scope.$watch("listFilterOption",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.selectAllFlag=false;$scope.selectedItemSize=0;$scope.selectedItemAmount=0;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;Receipt2s.get(item.uuid).success(function(data){$scope.subItemList=data.content;item.detailList=$scope.subItemList});$scope.displayAdvancedSearPanel=
false};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;$scope.selectedItem=null};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel)Receipt2s.get(item.uuid).success(function(data){$scope.subItemList=data.content;item.detailList=$scope.subItemList})};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS)};
$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.status=="add")if($scope.domain=="PSO_ORDER_MST")console.info("add order mst...");
else{if($scope.domain=="PSO_ORDER_DTL")console.info("add order dtl...")}else if($scope.status=="edit")if($scope.domain=="PSO_ORDER_MST")console.info("edit order mst...");else if($scope.domain=="PSO_ORDER_DTL")console.info("edit order dtl...")};$scope.deleteDetailAction=function(detail){};$scope.selectItemAction=function(event,item){$scope.stopEventPropagation(event);if(item.selected==false||item.selected==undefined||item.selected==null){$scope.selectedItemSize+=1;$scope.selectedItemAmount+=item.orderAmount}else{$scope.selectedItemSize-=
1;$scope.selectedItemAmount-=item.orderAmount;$scope.selectAllFlag=false}};$scope.confirmClickAction=function(event,item){$scope.stopEventPropagation(event);if(item.confirm==Constant.CONFIRM[2].value)$scope.showConfirm("确认取消审核订单单头吗？","",function(){var OrderMasterUpdateInput={uuid:item.uuid,confirm:"1"};OrderMaster.modify(OrderMasterUpdateInput).success(function(){item.confirm=Constant.CONFIRM[1].value;$scope.showInfo("取消审核成功！")}).error(function(response){$scope.showError($scope.getError(response.message));
$scope.showError(response.message)})});else $scope.showConfirm("确认审核订单单头吗？","",function(){var OrderMasterUpdateInput={uuid:item.uuid,confirm:"2"};OrderMaster.modify(OrderMasterUpdateInput).success(function(){item.confirm=Constant.CONFIRM[2].value;$scope.showInfo("审核成功！")}).error(function(response){$scope.showError($scope.getError(response.message));$scope.showError(response.message)})})};$scope.detailConfirmClickAction=function(event,detail){$scope.stopEventPropagation(event);if(detail.status==2)$scope.showConfirm("确认取消审核退款单身吗？",
"",function(){var UpdateInput={uuid:detail.uuid,status:"1"};Receipt2s.modify(detail.orderMaster.uuid,UpdateInput).success(function(data){detail.status="1";$scope.showInfo("取消审核成功！")}).error(function(response){$scope.showError(response.message)})});else $scope.showConfirm("确认审核退款单身吗？","",function(){var UpdateInput={uuid:detail.uuid,status:"2"};Receipt2s.modify(detail.orderMaster.uuid,UpdateInput).success(function(data){detail.status="2";$scope.showInfo("审核成功！")}).error(function(response){$scope.showError(response.message)})})};
$scope.detailTransferClickAction=function(event,detail){$scope.stopEventPropagation(event);if(detail.transferFlag==2)$scope.showConfirm("确认重新抛转退款单身吗？","",function(){var UpdateInput={uuid:detail.uuid,receiptOrderConversion:"true"};Receipt2s.modify(detail.orderMaster.uuid,UpdateInput).success(function(data){$scope.showInfo("重新抛转成功！")}).error(function(response){$scope.showError(response.message)})});else $scope.showConfirm("确认抛转退款单身吗？","",function(){var UpdateInput={uuid:detail.uuid,transferFlag:"2",
receiptOrderConversion:"true"};Receipt2s.modify(detail.orderMaster.uuid,UpdateInput).success(function(data){detail.transferFlag="2";$scope.showInfo("抛转成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.statusClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("status...")};$scope.releaseClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("release...")};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);
console.info("delete...")};$scope.confirmAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var confirmedNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.confirm!=="2"){var OrderMasterUpdateInput={uuid:item.uuid,confirm:"2"};var response=OrderMaster.modify(OrderMasterUpdateInput).success(function(){});promises.push(response);count++}else confirmedNos=confirmedNos+item.no+","});if(count==0){$scope.showWarn("没有选择任何未审核的订单，请先选择订单！");
return}if(confirmedNos!==""){confirmedNos=confirmedNos.substr(0,confirmedNos.length-1);$scope.showWarn("如下已审核过的订单将不再次审核："+confirmedNos)}$q.all(promises).then(function(data){console.info(data);$scope.refreshList();$scope.showInfo("审核成功！")},function(data){$scope.showError(data.data.message);$scope.showError(data.message)})};$scope.revertConfirmAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var unConfirmedNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===
true)if(item.confirm=="2"){var OrderMasterUpdateInput={uuid:item.uuid,confirm:"1"};var response=OrderMaster.modify(OrderMasterUpdateInput).success(function(){});promises.push(response);count++}else unConfirmedNos=unConfirmedNos+item.no+","});if(count==0){$scope.showWarn("没有选择任已审核的订单，请先选择订单！");return}if(unConfirmedNos!==""){unConfirmedNos=unConfirmedNos.substr(0,unConfirmedNos.length-1);$scope.showWarn("如下未审核过的订单将不执行取消审核："+unConfirmedNos)}$q.all(promises).then(function(data){console.info(data);$scope.refreshList();
$scope.showInfo("取消审核成功！")},function(data){$scope.showError(data.data.message);$scope.showError(data.message)})};$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("status all...")};$scope.releaseAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("release all...")};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("delete all...")};$scope.selectAllAction=function(){angular.forEach($scope.itemList,
function(item){if($scope.selectAllFlag)item.selected=true;else item.selected=false});$scope.selectedItemSize=0;$scope.selectedItemAmount=0;if($scope.selectAllFlag)angular.forEach($scope.itemList,function(item){$scope.selectedItemSize++;$scope.selectedItemAmount+=item.orderAmount})};$scope.openChannelDlg=function(){$mdDialog.show({controller:"selectChannelController",templateUrl:"app/src/app/order/receipts/selectChannel.html",parent:angular.element(document.body),targetEvent:event}).then(function(data){$scope.listFilterOption.channelUuid=
data.uuid;$scope.listFilterOption.channelName=data.name})};$scope.clearChannel=function(){$scope.listFilterOption.channelUuid="";$scope.listFilterOption.channelName=""}});
angular.module("IOne-Production").controller("selectChannelController",function($scope,$mdDialog,ChannelService){$scope.pageOption={sizePerPage:5,currentPage:0,totalPage:0,totalElements:0};$scope.queryAction=function(){$scope.pageOption.currentPage=0;$scope.refreshChannel()};$scope.refreshChannel=function(){ChannelService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,0,0,$scope.searchKeyword).success(function(data){$scope.allChannel=data;$scope.pageOption.totalElements=data.totalElements;
$scope.pageOption.totalPage=data.totalPages})};$scope.refreshChannel();$scope.selectChannel=function(channel){$scope.channel=channel;$mdDialog.hide($scope.channel)};$scope.hideDlg=function(){$mdDialog.hide($scope.channel)};$scope.cancelDlg=function(){$mdDialog.cancel()}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/fam/refundCause",{controller:"RefundCauseController",templateUrl:"app/src/app/fam/refund_cause/refundCause.html"})}]);
angular.module("IOne-Production").controller("RefundCauseController",function($scope,$q,RefundCauseService,Constant){$scope.APPORTION_TYPE=Constant.APPORTION_TYPE;$scope.TURN_FLAG=Constant.TURN_FLAG;$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.objectInfo={type:2};$scope.listFilterOption={status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value,release:Constant.RELEASE[0].value};$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=
""};$scope.refreshList=function(){RefundCauseService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.no,$scope.listFilterOption.name,$scope.listFilterOption.keyWord,"").success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements})};$scope.$watch("listFilterOption",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;
$scope.refreshList()},true);$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()}};$scope.selectAllFlag=false;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;$scope.selectedItem=null};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;
if(item.showMorePanel)item.detailList=$scope.subItemList};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);$scope.refreshList()};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain;$scope.source.queryInfo={type:2};$scope.selectedItemBackUp=angular.copy($scope.selectedItem)};$scope.preAddItemAction=function(source,domain,
desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain;$scope.source.apportionType="Y";$scope.source.turnFlag="N";$scope.source.queryInfo={type:2}};$scope.saveItemAction=function(){if($scope.status=="add")RefundCauseService.add($scope.source).success(function(data){$scope.showInfo("新增数据成功。");$scope.refreshList()}).error(function(data){$scope.showError("新增失败:"+"\x3cbr\x3e"+data.message)});else if($scope.status=
"edit")RefundCauseService.modify($scope.source.uuid,$scope.source).success(function(data){$scope.refreshList();$scope.showInfo("修改数据成功。");$scope.source=data;$scope.selectedItem=data;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)}).error(function(data){$scope.showError("修改失败:"+"\x3cbr\x3e"+data.message);$scope.source=angular.copy($scope.selectedItemBackUp);$scope.selectedItem=angular.copy($scope.selectedItemBackUp)})};$scope.selected=[];$scope.selectItemAction=function(event,item,selected){$scope.stopEventPropagation(event);
var idx=selected.indexOf(item);if(idx>-1)selected.splice(idx,1);else selected.push(item);$scope.selectItemCount=$scope.selected.length;console.log};$scope.exists=function(item,selected){return selected.indexOf(item)>-1};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){RefundCauseService.delete(item.uuid).success(function(){$scope.selectedItem=null;$scope.refreshList();$scope.showInfo("删除数据成功。");$scope.selectItemCount=
0})})};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selected.length>0)$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(item){var response=RefundCauseService.delete(item.uuid).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("删除数据成功。");$scope.refreshList();$scope.selectItemCount=0})}})};$scope.selectAllAction=function(){if($scope.selectAllFlag==
true)angular.forEach($scope.itemList,function(item){var idx=$scope.selected.indexOf(item);if(idx<0)$scope.selected.push(item)});else if($scope.selectAllFlag==false)$scope.selected=[];$scope.selectItemCount=$scope.selected.length}});
angular.module("IOne-Production").service("RefundCauseService",function($http,Constant){this.getAll=function(sizePerPage,page,no,name,keyWord,resUuid){var url="/refundCauses?size\x3d"+sizePerPage+"\x26page\x3d"+page;if(no!==undefined&&no!==null)url=url+"\x26no\x3d"+no;if(name!==undefined&&name!==null)url=url+"\x26name\x3d"+name;if(keyWord!==undefined&&keyWord!==null&&keyWord!=="")url=url+"\x26keyWord\x3d"+keyWord;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;console.log(url);
return $http.get(Constant.BACKEND_BASE+url)};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+"/refundCauses/"+uuid)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/refundCauses/"+uuid)};this.modify=function(uuid,UpdateInput){return $http.patch(Constant.BACKEND_BASE+"/refundCauses/"+uuid,UpdateInput)};this.add=function(AddInput){return $http.post(Constant.BACKEND_BASE+"/refundCauses/",AddInput)}});
angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/fam/refundWay",{controller:"RefundWayController",templateUrl:"app/src/app/fam/refund_way/refundWay.html"})}]);
angular.module("IOne-Production").controller("RefundWayController",function($scope,$q,RefundWayService,DiscountChanService,$mdDialog,Constant){$scope.PAY_TYPE=Constant.PAY_TYPE;$scope.FUND_TYPE=Constant.FUND_TYPE;$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value,release:Constant.RELEASE[0].value};$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};
$scope.refreshList=function(){RefundWayService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.no,$scope.listFilterOption.name,$scope.listFilterOption.keyWord,"").success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements})};$scope.$watch("listFilterOption",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},
true);$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()}};$scope.selectAllFlag=false;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);$scope.refreshList()};$scope.editItemAction=
function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.status=="add")RefundWayService.add($scope.source).success(function(data){$scope.showInfo("新增数据成功。");
$scope.refreshList()}).error(function(data){$scope.showError("新增失败:"+"\x3cbr\x3e"+data.message)});else if($scope.status="edit")RefundWayService.modify($scope.source.uuid,$scope.source).success(function(data){$scope.refreshList();$scope.showInfo("修改数据成功。");$scope.source=data;$scope.selectedItem=data;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)}).error(function(data){$scope.showError("修改失败:"+"\x3cbr\x3e"+data.message);$scope.source=angular.copy($scope.selectedItemBackUp);$scope.selectedItem=
angular.copy($scope.selectedItemBackUp)})};$scope.selected=[];$scope.selectItemAction=function(event,item,selected){$scope.stopEventPropagation(event);var idx=selected.indexOf(item);if(idx>-1)selected.splice(idx,1);else selected.push(item);$scope.selectItemCount=$scope.selected.length};$scope.exists=function(item,selected){return selected.indexOf(item)>-1};$scope.confirmClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("confirm...")};$scope.statusClickAction=function(event,
item){$scope.stopEventPropagation(event);console.info("status...")};$scope.releaseClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("release...")};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){RefundWayService.delete(item.uuid).success(function(){$scope.selectedItem=null;$scope.refreshList();$scope.showInfo("删除数据成功。");$scope.selectItemCount=0})})};$scope.confirmAllClickAction=function(event){$scope.stopEventPropagation(event);
console.info("confirm all...")};$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("status all...")};$scope.releaseAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("release all...")};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selected.length>0)$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(item){var response=
RefundWayService.delete(item.uuid).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("删除数据成功。");$scope.refreshList();$scope.selectItemCount=0})}})};$scope.selectAllAction=function(){if($scope.selectAllFlag==true)angular.forEach($scope.itemList,function(item){var idx=$scope.selected.indexOf(item);if(idx<0)$scope.selected.push(item)});else if($scope.selectAllFlag==false)$scope.selected=[];$scope.selectItemCount=$scope.selected.length}});
angular.module("IOne-Production").service("RefundWayService",function($http,Constant){this.getAll=function(sizePerPage,page,no,name,keyWord,resUuid){confirm=confirm==0?"":confirm;status=status==0?"":status;var url="/refundWays?size\x3d"+sizePerPage+"\x26page\x3d"+page;if(no!==undefined&&no!==null)url=url+"\x26no\x3d"+no;if(name!==undefined&&name!==null)url=url+"\x26name\x3d"+name;if(keyWord!==undefined&&keyWord!==null&&keyWord!=="")url=url+"\x26keyWord\x3d"+keyWord;if(resUuid!==undefined&&resUuid!==
null)url=url+"\x26resUuid\x3d"+resUuid;console.log(url);return $http.get(Constant.BACKEND_BASE+url)};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+"/refundWays/"+uuid)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/refundWays/"+uuid)};this.modify=function(uuid,UpdateInput){return $http.patch(Constant.BACKEND_BASE+"/refundWays/"+uuid,UpdateInput)};this.add=function(AddInput){return $http.post(Constant.BACKEND_BASE+"/refundWays/",AddInput)}});
angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/cbi/return_reason",{controller:"CBIReturnReasonController",templateUrl:"app/src/app/cbi/return_reason/returnReason.html"})}]);
angular.module("IOne-Production").controller("CBIReturnReasonController",function($scope,CBIReturnReasonService,Constant,$mdDialog,$q){$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={select:{status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value},no:"",name:"",keyWord:""};$scope.menuDisplayOption={"switchConfirm":{display:true,name:"审核/取消审核",uuid:"9ffca293-7485-44b5-89a6-bc818e49bbe0"},"switchStatus":{display:true,name:"启用/禁用",uuid:"233499a9-a986-463f-b1ef-a33df56879b7"},
"batchConfirm":{display:true,name:"批量审核",uuid:"2cb63dbd-07c3-46e1-abd2-7f741b947896"},"batchRevertConfirm":{display:true,name:"批量取审",uuid:"a4932f67-48e6-46b9-b976-1337a9cec8be"},"batchStatus":{display:true,name:"批量启用",uuid:"9d7a6148-8476-4351-9c55-976620011b03"},"batchRevertStatus":{display:true,name:"批量禁用",uuid:"89d5667c-a2a4-4b0a-9932-8bff18139c5e"},"batchDelete":{display:true,name:"批量删除",uuid:"d24c7289-7335-41af-b860-306f29ed94f3"},"detailConfirm":{display:true,name:"审核",uuid:"3a4a72a5-0125-4df5-9ede-94b32d0257db"},
"detailRevertConfirm":{display:true,name:"取审",uuid:"43f9b47c-667b-4fce-b191-d981b878dbb7"},"detailStatus":{display:true,name:"启用",uuid:"f40e45c0-3c2d-4cca-abac-614309977290"},"detailRevertStatus":{display:true,name:"禁用",uuid:"f8961bdc-4642-4b71-817f-91b302beebe3"},"detailDelete":{display:true,name:"删除",uuid:"ece21f6d-6c53-4bb0-b4f0-4417cd4179ed"}};$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=
true;$scope.sortByField="no";$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.refreshList=function(){CBIReturnReasonService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.select.confirm,$scope.listFilterOption.select.status,$scope.listFilterOption.no,$scope.listFilterOption.name,$scope.listFilterOption.keyWord,$scope.RES_UUID_MAP.CBI.RETURN_REASON.RES_UUID).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=
data.totalPages;$scope.pageOption.totalElements=data.totalElements;$scope.selectAllFlag=false;$scope.selectedItemSize=0;$scope.selectedItemAmount=0})};$scope.getMenuAuthData($scope.RES_UUID_MAP.CBI.RETURN_REASON.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)});$scope.$watch("listFilterOption.select",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.queryEnter=function(e){if(e.keyCode===
13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()}};$scope.selectAllFlag=false;$scope.selectedItemSize=0;$scope.selectedItemAmount=0;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;item.detailList=$scope.subItemList;$scope.displayAdvancedSearPanel=false};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;$scope.selectedItem=null};$scope.toggleMorePanelAction=
function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel)item.detailList=item};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);$scope.refreshList()};$scope.hideItemDetailsAction=function(event){$scope.stopEventPropagation(event);$scope.selectedItem=null;$scope.refreshList()};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);
$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.source.confirm=="2"&&$scope.source.status=="2"){$scope.showError("不允许状态是已审核又无效,请调整后再保存");return}if($scope.status=="add"){if($scope.domain==
"CBI_BASE_RETURN_REASON")CBIReturnReasonService.add($scope.source).success(function(data){$scope.showInfo("新增数据成功。")}).error(function(data){$scope.showError("新增失败:"+"\x3cbr\x3e"+data.message)})}else if($scope.status=="edit")if($scope.domain=="CBI_BASE_RETURN_REASON")CBIReturnReasonService.modify($scope.source.uuid,$scope.source).success(function(data){$scope.showInfo("修改数据成功。");$scope.source=data;$scope.selectedItem=data;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)}).error(function(data){$scope.showError("修改失败:"+
"\x3cbr\x3e"+data.message);$scope.source=angular.copy($scope.selectedItemBackUp);$scope.selectedItem=angular.copy($scope.selectedItemBackUp)})};$scope.deleteDetailAction=function(detail){};$scope.selectItemAction=function(event,item){$scope.stopEventPropagation(event);item.selectedRef=!item.selected;if(item.selected==false||item.selected==undefined||item.selected==null)$scope.selectedItemSize+=1;else{$scope.selectedItemSize-=1;$scope.selectAllFlag=false}$scope.disableBatchMenuButtons()};$scope.confirmSwitchAction=
function(event,item){$scope.stopEventPropagation(event);if(item.confirm==Constant.CONFIRM[2].value)$scope.showConfirm("确认取消审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};CBIReturnReasonService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("取消审核成功。")})},function(){item.confirm=Constant.CONFIRM[2].value});else{if(item.status==Constant.STATUS[2].value){$scope.showWarn("项目是失效状态,请先启用后再审核");item.confirm=Constant.CONFIRM[2].value;
return}$scope.showConfirm("确认审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};CBIReturnReasonService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("审核成功。")})},function(){item.confirm=Constant.CONFIRM[1].value})}};$scope.statusSwitchAction=function(event,item){$scope.stopEventPropagation(event);if(item.status==Constant.STATUS[2].value)$scope.showConfirm("确认修改启用状态为有效吗？","",function(){var UpdateInput={uuid:item.uuid,
status:Constant.STATUS[1].value};CBIReturnReasonService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("生效成功。")})},function(){item.status=Constant.STATUS[2].value});else $scope.showConfirm("确认修改启用状态为失效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value,confirm:Constant.CONFIRM[1].value};CBIReturnReasonService.modify(UpdateInput.uuid,UpdateInput).success(function(){item.confirm=Constant.CONFIRM[1].value;$scope.disableBatchMenuButtons();
$scope.showInfo("失效成功。")})},function(){item.status=Constant.STATUS[1].value})};$scope.confirmClickAction=function(event,item){$scope.stopEventPropagation(event);if(item.confirm==Constant.CONFIRM[2].value)$scope.showConfirm("确认取消审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};CBIReturnReasonService.modify(item.uuid,UpdateInput).success(function(){item.confirm=Constant.CONFIRM[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("取消审核成功！")}).error(function(response){$scope.showError(response.message)})});
else{if(item.status==Constant.STATUS[2].value){$scope.showWarn("项目是失效状态,请先启用后再审核");item.confirm=Constant.CONFIRM[2].value;return}$scope.showConfirm("确认审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};CBIReturnReasonService.modify(item.uuid,UpdateInput).success(function(){item.confirm=Constant.CONFIRM[2].value;$scope.showInfo("审核成功！");$scope.disableBatchMenuButtons()}).error(function(response){$scope.showError(response.message)})})}};$scope.statusClickAction=function(event,
item){$scope.stopEventPropagation(event);if(item.status==Constant.STATUS[1].value)$scope.showConfirm("确认改为失效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value,confirm:Constant.CONFIRM[1].value};CBIReturnReasonService.modify(item.uuid,UpdateInput).success(function(){item.status=Constant.STATUS[2].value;item.confirm=Constant.CONFIRM[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("修改为失效成功！")}).error(function(response){$scope.showError(response.message)})});else $scope.showConfirm("确认改为生效吗？",
"",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};CBIReturnReasonService.modify(item.uuid,UpdateInput).success(function(){item.status=Constant.STATUS[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("修改为生效成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.releaseClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("release...")};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);
if(item.status!="1"||item.confirm!="1"){$scope.showWarn("仅当销退原因的状态是有效且未审核时才允许删除!");return}$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){CBIReturnReasonService.delete(item.uuid).success(function(){$scope.selectedItem=null;$scope.refreshList();$scope.showInfo("删除数据成功。")})})};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var noDeleteNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.status=="1"&&item.confirm==
"1"){var response=CBIReturnReasonService.delete(item.uuid).success(function(){});promises.push(response);count++}else noDeleteNos=noDeleteNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任何状态是有效且未审核的可删除项目，请选择！");return}$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){if(noDeleteNos!=="")$scope.showWarn("以下状态是失效或已审核的的项目将不会删除："+"\x3cbr\x3e"+noDeleteNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("删除成功！")},function(data){$scope.showError(data.message);$scope.showError(data.data.message)})})};
$scope.confirmAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var confirmedNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.confirm!=Constant.CONFIRM[2].value){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};var response=CBIReturnReasonService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else confirmedNos=confirmedNos+item.no+","});if(count==0){$scope.showWarn("没有选择任何未审核的项目，请先选择！");
return}if(confirmedNos!==""){confirmedNos=confirmedNos.substr(0,confirmedNos.length-1);$scope.showWarn("以下已审核过的项目将不再次审核："+confirmedNos)}$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("审核成功！")},function(data){$scope.showError(data.data.message);$scope.showError(data.message)})};$scope.revertConfirmAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var unConfirmedNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===
true)if(item.confirm==Constant.CONFIRM[2].value){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};var response=CBIReturnReasonService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else unConfirmedNos=unConfirmedNos+item.no+","});if(count==0){$scope.showWarn("没有选择任已审核的项目，请先选择！");return}if(unConfirmedNos!==""){unConfirmedNos=unConfirmedNos.substr(0,unConfirmedNos.length-1);$scope.showWarn("以下未审核过的项目将不执行取消审核："+unConfirmedNos)}$q.all(promises).then(function(data){$scope.refreshList();
$scope.showInfo("取消审核成功！")},function(data){$scope.showError(data.data.message);$scope.showError(data.message)})};$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var effectiveNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.status!=Constant.STATUS[1].value){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};var response=CBIReturnReasonService.modify(item.uuid,UpdateInput).success(function(){});
promises.push(response);count++}else effectiveNos=effectiveNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任何失效的项目，请先选择！");return}if(effectiveNos!=="")$scope.showWarn("以下已生效的项目将不再次修改："+"\x3cbr\x3e"+effectiveNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("生效成功！")},function(data){$scope.showError(data.message);$scope.showError(data.data.message)})};$scope.revertStatusAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var uneffectiveNos=
"";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.status==Constant.STATUS[1].value){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value,confirm:Constant.CONFIRM[1].value};var response=CBIReturnReasonService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else uneffectiveNos=uneffectiveNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择生效的项目，请先选择！");return}if(uneffectiveNos!=="")$scope.showWarn("以下失效的项目将不再次修改："+
uneffectiveNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("失效成功！")},function(data){$scope.showError(data.data.message);$scope.showError(data.message)})};$scope.releaseAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("release all...")};$scope.selectAllAction=function(){angular.forEach($scope.itemList,function(item){if($scope.selectAllFlag)item.selected=true;else item.selected=false;item.selectedRef=item.selected});$scope.selectedItemSize=
0;$scope.selectedItemAmount=0;if($scope.selectAllFlag)angular.forEach($scope.itemList,function(item){$scope.selectedItemSize++});$scope.disableBatchMenuButtons()};$scope.disableBatchMenuButtons=function(){var selectedCount=0;var confirm="";var status="";var diffConfirm=false;var diffStatus=false;angular.forEach($scope.itemList,function(item,index){if(item.selectedRef){selectedCount++;if(confirm=="")confirm=item.confirm;else if(confirm!=item.confirm)diffConfirm=true;if(status=="")status=item.status;
else if(status!=item.status)diffStatus=true}});if(selectedCount==0){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}else{if(diffConfirm==true){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchDelete=true}else if(confirm=="2"){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=false;$scope.disabledBatchDelete=true}else{$scope.disabledBatchConfirm=
false;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchDelete=false}if(diffStatus==true){$scope.disabledBatchConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}else if(status=="1"){$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=false}else{$scope.disabledBatchConfirm=true;$scope.disabledBatchStatus=false;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}}}});
angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/return-sales-orders",{controller:"PSOReturnSalesOrdersController",templateUrl:"app/src/app/order/return_sales_orders/returnSalesOrders.html"})}]);
angular.module("IOne-Production").controller("PSOReturnSalesOrdersController",function($scope,PSOReturnSalesOrdersMasterService,PSOReturnSalesOrdersDetailsService,PSOReturnSalesOrdersExtendsService,Constant,$mdDialog,$q){$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={select:{status:Constant.STATUS[0].value,confirm:Constant.AUDIT[0].value,transferPsoFlag:Constant.TRANSFER_PSO_FLAG[0].value,returnSalesOrderDetailStatus:Constant.STATUS[0].value,
returnSalesOrderDetailConfirm:Constant.AUDIT[0].value,returnSalesOrderDetailTransfer:Constant.TRANSFER_PSO_FLAG[0].value,channelUuid:""},no:"",employeeName:"",customerName:""};$scope.menuDisplayOption={"confirm":{display:true,name:"审核",uuid:"d66f6b86-2c0d-45b5-bef5-042f7810d89a"},"revertConfirm":{display:true,name:"取审",uuid:"d6edbc0b-fe4c-4762-aeef-ea2891a0c85b"},"transfer":{display:true,name:"抛转",uuid:"1406d065-dcbd-488b-96fb-c06ccb744147"},"batchConfirm":{display:true,name:"批量审核",uuid:"dc2117f6-758e-4012-a79a-c1b33cbc4b76"},
"batchRevertConfirm":{display:true,name:"批量取审",uuid:"d87e0dd0-7a30-4656-9aac-303aaf237c7c"},"batchTransfer":{display:true,name:"批量拋转",uuid:"1a938c46-396a-404d-938d-227e847afa17"},"detailConfirm":{display:true,name:"审核",uuid:"5f7cfaa8-4a15-4a06-9a60-b5ff547a61a2"},"detailRevertConfirm":{display:true,name:"取审",uuid:"670abcd7-b800-4f03-b7f6-4fd483d8efd0"},"detailTransfer":{display:true,name:"抛转",uuid:"860a0c43-b13c-476a-a419-33fe75dbcef0"},"detail2Confirm":{display:true,name:"审核",uuid:"145a50fe-1cc6-4db4-87dd-9a58f63100b2"},
"detail2RevertConfirm":{display:true,name:"取审",uuid:"88a04a0a-e3fb-487f-8506-6f43ad47a5c4"},"detail2Transfer":{display:true,name:"抛转",uuid:"7ddbda9a-1a7e-4751-ac98-51e41c029519"}};$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.refreshList=function(){PSOReturnSalesOrdersMasterService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.select.confirm,$scope.listFilterOption.select.status,$scope.listFilterOption.select.transferPsoFlag,
$scope.listFilterOption.no,$scope.listFilterOption.select.startOrderDate,$scope.listFilterOption.select.endOrderDate,$scope.listFilterOption.select.channelUuid,$scope.listFilterOption.customerName,"1",$scope.listFilterOption.select.returnSalesOrderDetailConfirm,$scope.listFilterOption.select.returnSalesOrderDetailStatus,$scope.listFilterOption.select.returnSalesOrderDetailTransfer,$scope.RES_UUID_MAP.PSO.SO_RETURN.RES_UUID).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=
data.totalPages;$scope.pageOption.totalElements=data.totalElements;$scope.selectAllFlag=false;$scope.selectedItemSize=0;$scope.selectedItemAmount=0;$scope.selectedItemReturnAmount=0;angular.forEach($scope.itemList,function(item){PSOReturnSalesOrdersDetailsService.getAll(item.uuid).success(function(data){item.detailList=data.content;item.selectAllDetails=false;$scope.updateMasterStateByReturnDetails(item)}).error(function(response){$scope.showError(response.message)})})}).error(function(response){$scope.showError(response.message)})};
$scope.getMenuAuthData($scope.RES_UUID_MAP.PSO.SO_RETURN.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)});$scope.$watch("listFilterOption.select",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()}};$scope.queryClick=
function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()};$scope.selectAllFlag=false;$scope.selectedItemSize=0;$scope.selectedItemAmount=0;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;$scope.selectedItem.extendDetailList=[];$scope.selectedItem.selectAllDetails=false;angular.forEach(item.detailList,function(returnDetail){PSOReturnSalesOrdersExtendsService.getAll(returnDetail.salesOrderMaster.uuid,returnDetail.uuid).success(function(data){if(data.totalElements>
0)item.extendDetailList=item.extendDetailList.concat(data.content)}).error(function(response){$scope.showError(response.message)})});$scope.displayAdvancedSearPanel=false};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;$scope.selectedItem=null};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel};$scope.setDetailsBgColor=function(detailList){angular.forEach(detailList,function(detail){detail.bgColor={"background-color":"#FFAEB9;"}})};
$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);if($scope.status=="add")$scope.refreshList()};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);
$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.status=="add"){if($scope.domain=="CBI_BASE_ORDER_TYPE")SalesOrderMaster.add($scope.source).success(function(data){$scope.showInfo("新增数据成功。")}).error(function(data){$scope.showError("新增失败:"+"\x3cbr\x3e"+data.message)})}else if($scope.status=="edit")if($scope.domain=="CBI_BASE_ORDER_TYPE")SalesOrderMaster.modify($scope.source.uuid,$scope.source).success(function(data){$scope.showInfo("修改数据成功。")}).error(function(data){$scope.showError("修改失败:"+
"\x3cbr\x3e"+data.message)})};$scope.deleteDetailAction=function(detail){};$scope.selectItemAction=function(event,item){$scope.stopEventPropagation(event);item.selectedRef=!item.selected;if(item.selected==false||item.selected==undefined||item.selected==null){$scope.selectedItemSize+=1;$scope.selectedItemAmount+=item.originalOrderAmount;$scope.selectedItemReturnAmount+=item.returnAmount}else{$scope.selectedItemSize-=1;$scope.selectedItemAmount-=item.originalOrderAmount;$scope.selectedItemReturnAmount-=
item.returnAmount;$scope.selectAllFlag=false}$scope.disableBatchMenuButtons()};$scope.confirmClickAction=function(event,item,confirmVal,bApplyAll){$scope.stopEventPropagation(event);var action="审核";if(confirmVal==1)action="取消审核";$scope.showConfirm("确认"+action+"吗？","",function(){var detailUuids="";angular.forEach(item.detailList,function(detail){if(bApplyAll===true){if(detail.confirm!=confirmVal)detailUuids+=detail.uuid+","}else if(detail.confirm!=confirmVal&&detail.selected==true)detailUuids+=detail.uuid+
","});if(detailUuids!="")PSOReturnSalesOrdersDetailsService.confirm(item.uuid,detailUuids,confirmVal).success(function(data){$scope.updateDetailsConfirmState(item.detailList,data);$scope.updateMasterStateByReturnDetails(item);$scope.showInfo("预订单退货单"+action+"成功！");$scope.disableBatchMenuButtons();$scope.disableDetailMenuButtons();$scope.getReturnOrderMasterCount()}).error(function(response){$scope.showError("预订单退货单"+item.no+response.message)});else $scope.showWarn("请选择需要"+action+"的商品！")})};$scope.transferClickAction=
function(event,item,bApplyAll){$scope.stopEventPropagation(event);$scope.showConfirm("确认抛转吗？","",function(){var detailUuids="";angular.forEach(item.detailList,function(detail){if(bApplyAll===true){if(detail.transferReturnFlag!="1")detailUuids+=detail.uuid+","}else if(detail.transferReturnFlag!="1"&&detail.selected==true)detailUuids+=detail.uuid+","});if(detailUuids!="")detailUuids=detailUuids.substring(0,detailUuids.length-1);if(detailUuids!="")PSOReturnSalesOrdersDetailsService.transfer(item.uuid,
detailUuids).success(function(response){if(response.status=="COMPLETED"){$scope.updateDetailsTransferState(item.detailList,detailUuids);$scope.updateMasterStateByReturnDetails(item);$scope.disableBatchMenuButtons();$scope.disableDetailMenuButtons();$scope.showInfo("预订单退货单抛转成功！");$scope.getReturnOrderMasterCount()}else if(response.message!=undefined)$scope.showError("预订单退货单抛转失败,状态:"+response.status+"\x3cbr\x3e"+response.message);else $scope.showError("预订单退货单抛转失败,状态:"+response.status)}).error(function(response){$scope.showError("预订单退货单抛转失败,状态:"+
response.status+"\x3cbr\x3e"+response.message)});else $scope.showWarn("请选择需要抛转的商品！")})};$scope.statusClickAction=function(event,item){$scope.stopEventPropagation(event);if(item.status==Constant.STATUS[1].value)$scope.showConfirm("确认改为失效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value};SalesOrderMaster.modify(item.uuid,UpdateInput).success(function(){item.status=Constant.STATUS[2].value;$scope.showInfo("修改为失效成功！");$scope.getReturnOrderMasterCount()}).error(function(response){$scope.showError(response.message)})});
else $scope.showConfirm("确认改为生效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};SalesOrderMaster.modify(item.uuid,UpdateInput).success(function(){item.status=Constant.STATUS[1].value;$scope.showInfo("修改为生效成功！");$scope.getReturnOrderMasterCount()}).error(function(response){$scope.showError(response.message)})})};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);if(item.status!="1"||item.confirm!="1"){$scope.showWarn("仅当预订单类型的状态是有效且未审核时才允许删除!");
return}$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){SalesOrderMaster.delete(item.uuid).success(function(){$scope.selectedItem=null;$scope.refreshList();$scope.showInfo("删除数据成功。");$scope.getReturnOrderMasterCount()})})};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var noDeleteNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.status=="1"&&item.confirm=="1"){var response=SalesOrderMaster.delete(item.uuid).success(function(){});
promises.push(response);count++}else noDeleteNos=noDeleteNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任何状态是有效且未审核的可删除项目，请选择！");return}$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){if(noDeleteNos!=="")$scope.showWarn("以下状态是失效或已审核的的项目将不会删除："+"\x3cbr\x3e"+noDeleteNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("删除成功！");$scope.getReturnOrderMasterCount()},function(data){$scope.showError(data.message);$scope.showError(data.data.message)})})};$scope.confirmAllClickAction=
function(event,confirmVal){$scope.stopEventPropagation(event);if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");return}var action="审核";if(confirmVal==1)action="取消审核";$scope.showConfirm("确认"+action+"吗","",function(){var promises=[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected){var detailUuids="";angular.forEach(item.detailList,function(detail){if(detail.confirm!=confirmVal)detailUuids+=detail.uuid+","});if(detailUuids!=""){var response=PSOReturnSalesOrdersDetailsService.confirm(item.uuid,
detailUuids,confirmVal).success(function(data){$scope.updateDetailsConfirmState(item.detailList,data);$scope.updateMasterStateByReturnDetails(item)}).error(function(response){bError=true;$scope.showError("预订单退货单"+item.no+action+"失败："+response.message)});promises.push(response)}else $scope.showWarn("请选择需要"+action+"的预订单退货单！")}});$q.all(promises).then(function(data){if(!bError){$scope.showInfo("预订单退货单"+action+"成功！");$scope.getReturnOrderMasterCount()}$scope.disableBatchMenuButtons()})})};$scope.transferAllClickAction=
function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");return}var action="抛转";$scope.showConfirm("确认"+action+"吗","",function(){var promises=[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected){var detailUuids="";angular.forEach(item.detailList,function(detail){if(detail.transferReturnFlag!="1")detailUuids+=detail.uuid+","});if(detailUuids!="")detailUuids=detailUuids.substring(0,detailUuids.length-1);if(detailUuids!=
""){var response=PSOReturnSalesOrdersDetailsService.transfer(item.uuid,detailUuids).success(function(response){if(response.status=="COMPLETED"){$scope.updateDetailsTransferState(item.detailList,detailUuids);$scope.updateMasterStateByReturnDetails(item);$scope.showInfo("预订单退货单抛转成功！")}else{bError=true;if(response.message!=undefined)$scope.showError("预订单退货单"+item.no+"抛转失败,状态:"+response.status+"\x3cbr\x3e"+response.message);else $scope.showError("预订单退货单"+item.no+"抛转失败,状态:"+response.status)}}).error(function(response){bError=
true;$scope.showError("预订单退货单"+item.no+action+"失败,状态:"+response.status+"\x3cbr\x3e"+response.message)});promises.push(response)}else $scope.showWarn("请选择需要"+action+"的预订单退货单！")}});$q.all(promises).then(function(data){if(!bError){$scope.showInfo("预订单退货单"+action+"成功！");$scope.getReturnOrderMasterCount()}$scope.disableBatchMenuButtons()})})};$scope.selectAllAction=function(){angular.forEach($scope.itemList,function(item){if($scope.selectAllFlag)item.selected=true;else item.selected=false;item.selectedRef=
item.selected});$scope.selectedItemSize=0;$scope.selectedItemAmount=0;$scope.selectedItemReturnAmount=0;if($scope.selectAllFlag)angular.forEach($scope.itemList,function(item){$scope.selectedItemSize++;$scope.selectedItemAmount+=item.originalOrderAmount;$scope.selectedItemReturnAmount+=item.returnAmount});$scope.disableBatchMenuButtons()};$scope.confirmDetailClickAction=function(event,item,confirmVal,detail){$scope.stopEventPropagation(event);var action="审核";if(confirmVal==1)action="取消审核";$scope.showConfirm("确认"+
action+"吗？","",function(){PSOReturnSalesOrdersDetailsService.confirm(item.uuid,detail.uuid,confirmVal).success(function(data){detail.confirm=confirmVal;$scope.updateMasterStateByReturnDetails(item);$scope.disableBatchMenuButtons();$scope.disableDetailMenuButtons();$scope.showInfo("预订单退货单"+action+"成功！");$scope.getReturnOrderMasterCount()}).error(function(response){$scope.showError(response.message)})})};$scope.transferDetailClickAction=function(event,item,detail){$scope.stopEventPropagation(event);
$scope.showConfirm("确认抛转吗？","",function(){PSOReturnSalesOrdersDetailsService.transfer(item.uuid,detail.uuid).success(function(response){if(response.status=="COMPLETED"){detail.transferReturnFlag="1";$scope.updateMasterStateByReturnDetails(item);$scope.disableBatchMenuButtons();$scope.disableDetailMenuButtons();$scope.showInfo("预订单退货单抛转成功！");$scope.getReturnOrderMasterCount()}else if(response.message!=undefined)$scope.showError("预订单退货单抛转失败,状态:"+response.status+"\x3cbr\x3e"+response.message);else $scope.showError("预订单退货单抛转失败,状态:"+
response.status)}).error(function(response){$scope.showError(response.message)})})};$scope.detailConfirmClickAction=function(event,detail){$scope.stopEventPropagation(event);if(detail.confirm==2)$scope.showConfirm("确认取消审核退货单身吗？","",function(){var UpdateInput={uuid:detail.uuid,confirm:"1"};PSOReturnSalesOrdersDetailsService.modify(detail.salesOrderMaster.uuid,UpdateInput).success(function(data){detail.confirm="1";$scope.showInfo("取消审核成功！");$scope.getReturnOrderMasterCount()}).error(function(response){$scope.showError(response.message)})});
else $scope.showConfirm("确认审核退货单身吗？","",function(){var UpdateInput={uuid:detail.uuid,confirm:"2"};PSOReturnSalesOrdersDetailsService.modify(detail.salesOrderMaster.uuid,UpdateInput).success(function(data){detail.confirm="2";$scope.showInfo("审核成功！");$scope.getReturnOrderMasterCount()}).error(function(response){$scope.showError(response.message)})})};$scope.detailStatusClickAction=function(event,detail){$scope.stopEventPropagation(event);if(detail.status==1)$scope.showConfirm("确认将退货单身改为失效吗？","",function(){var UpdateInput=
{uuid:detail.uuid,status:"2"};PSOReturnSalesOrdersDetailsService.modify(detail.salesOrderMaster.uuid,UpdateInput).success(function(data){detail.status="2";$scope.showInfo("设置失效成功！");$scope.getReturnOrderMasterCount()}).error(function(response){$scope.showError(response.message)})});else $scope.showConfirm("确认将退货单身改为生效吗？","",function(){var UpdateInput={uuid:detail.uuid,status:"1"};PSOReturnSalesOrdersDetailsService.modify(detail.salesOrderMaster.uuid,UpdateInput).success(function(data){detail.status=
"1";$scope.showInfo("设置生效成功成功！");$scope.getReturnOrderMasterCount()}).error(function(response){$scope.showError(response.message)})})};$scope.updateDetailsConfirmState=function(details,responseDetails){angular.forEach(details,function(detail){angular.forEach(responseDetails,function(responseDetail){if(detail.uuid==responseDetail.uuid){detail.confirm=responseDetail.confirm;detail.transferReturnFlag=responseDetail.transferReturnFlag}})})};$scope.updateDetailsTransferState=function(details,transferredDetailUuids){if(details!=
null&&transferredDetailUuids!=null)angular.forEach(details,function(detail){angular.forEach(transferredDetailUuids.split(","),function(detailUuid){if(detail.uuid==detailUuid)detail.transferReturnFlag=Constant.TRANSFER_PSO_FLAG[1].value})})};$scope.updateMasterStateByReturnDetails=function(item){var confirm=Constant.CONFIRM[2].value;var transferPsoFlag=Constant.TRANSFER_PSO_FLAG[1].value;var returnAmount=0;var returnAmountTax=0;angular.forEach(item.detailList,function(detail){if(detail.confirm==Constant.CONFIRM[1].value)confirm=
detail.confirm;if(detail.transferReturnFlag==Constant.TRANSFER_PSO_FLAG[2].value||detail.transferReturnFlag=="")transferPsoFlag=detail.transferReturnFlag;returnAmount+=detail.originalReturnOrderAmount;returnAmountTax+=detail.originalReturnOrderAmountTax});item.confirm=confirm;item.transferPsoFlag=transferPsoFlag;item.returnAmount=returnAmount;item.returnAmountTax=returnAmountTax};$scope.selectAllDetails=function(item){angular.forEach(item.detailList,function(detail){if(item.selectAllDetails)detail.selected=
true;else detail.selected=false;detail.selectedRef=detail.selected});$scope.disableDetailMenuButtons()};$scope.selectDetailItemAction=function(event,detail){$scope.stopEventPropagation(event);detail.selectedRef=!detail.selected;$scope.disableDetailMenuButtons()};$scope.disableBatchMenuButtons=function(){var selectedCount=0;var confirm="";var transfer="";var diffConfirm=false;var diffTransfer=false;angular.forEach($scope.itemList,function(item,index){if(item.selectedRef){selectedCount++;if(confirm==
"")confirm=item.confirm;else if(confirm!=item.confirm)diffConfirm=true;if(transfer=="")transfer=item.transferPsoFlag;else if(transfer!=item.transferPsoFlag)diffTransfer=true}});if(selectedCount==0){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchTransfer=true}else{if(diffConfirm==true){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true}else if(confirm=="2"){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=false}else{$scope.disabledBatchConfirm=
false;$scope.disabledBatchCancelConfirm=true}if(diffTransfer==true||diffConfirm==true)$scope.disabledBatchTransfer=true;else if(transfer=="1"||confirm=="1")$scope.disabledBatchTransfer=true;else $scope.disabledBatchTransfer=false}};$scope.disableDetailMenuButtons=function(){var selectedCount=0;var confirm="";var transfer="";var diffConfirm=false;var diffTransfer=false;if($scope.selectedItem!=null)angular.forEach($scope.selectedItem.detailList,function(detail,index){if(detail.selectedRef){selectedCount++;
if(confirm=="")confirm=detail.confirm;else if(confirm!=detail.confirm)diffConfirm=true;if(transfer=="")transfer=detail.transferReturnFlag;else if(transfer!=detail.transferReturnFlag)diffTransfer=true}});if(selectedCount==0){$scope.disabledDetailConfirm=true;$scope.disabledDetailCancelConfirm=true;$scope.disabledDetailTransfer=true}else{if(diffConfirm==true){$scope.disabledDetailConfirm=true;$scope.disabledDetailCancelConfirm=true}else if(confirm=="2"){$scope.disabledDetailConfirm=true;$scope.disabledDetailCancelConfirm=
false}else{$scope.disabledDetailConfirm=false;$scope.disabledDetailCancelConfirm=true}if(diffTransfer==true)$scope.disabledDetailTransfer=true;else if(transfer=="1"||confirm=="1")$scope.disabledDetailTransfer=true;else $scope.disabledDetailTransfer=false}};$scope.openChannelDlg=function(){$mdDialog.show({controller:"selectChannelController",templateUrl:"app/src/app/order/receipts/selectChannel.html",parent:angular.element(document.body),targetEvent:event}).then(function(data){$scope.listFilterOption.select.channelUuid=
data.uuid;$scope.listFilterOption.select.channelName=data.name})};$scope.clearChannel=function(){$scope.listFilterOption.select.channelUuid="";$scope.listFilterOption.select.channelName=""};$scope.getReturnOrderMasterCount=function(){PSOReturnSalesOrdersMasterService.getReturnOrderMasterCount(Constant.AUDIT[1].value,Constant.STATUS[1].value,Constant.TRANSFER_PSO_FLAG[2].value,RES_UUID_MAP.PSO.SO_RETURN.RES_UUID).success(function(data){$scope.menuList[1].subList[8].suffix=data})}});
angular.module("IOne-Production").service("PSOReturnSalesOrdersMasterService",function($http,Constant){this.getAll=function(sizePerPage,page,confirm,status,transferPsoFlag,orderMasterNo,orderDateBegin,orderDateEnd,channelUuid,allNames,onlyReturn,returnSalesOrderDetailConfirm,returnSalesOrderDetailStatus,returnSalesOrderDetailTransfer,resUuid){confirm=confirm==0?"":confirm;status=status==0?"":status;transferPsoFlag=transferPsoFlag==0?"":transferPsoFlag;var url="/salesOrders?size\x3d"+sizePerPage+"\x26page\x3d"+
page+"\x26confirm\x3d"+confirm+"\x26status\x3d"+status+"\x26transferPsoFlag\x3d"+transferPsoFlag;if(orderMasterNo!==null)url=url+"\x26no\x3d"+orderMasterNo;if(orderDateBegin!==null&&orderDateBegin!==undefined){var orderDateBegin=new Date(orderDateBegin);orderDateBegin=moment(orderDateBegin).format("YYYY-MM-DD 00:00:00");url=url+"\x26orderDateBegin\x3d"+orderDateBegin}if(orderDateEnd!==null&&orderDateEnd!==undefined){var orderDateEnd=new Date(orderDateEnd);orderDateEnd=moment(orderDateEnd).format("YYYY-MM-DD 23:59:59");
url=url+"\x26orderDateEnd\x3d"+orderDateEnd}if(allNames!==null&&allNames!==undefined)url=url+"\x26allNames\x3d"+allNames;if(channelUuid!=null&&channelUuid!=undefined)url=url+"\x26channelUuid\x3d"+channelUuid;if(onlyReturn!=null&&onlyReturn!=undefined)url=url+"\x26onlyReturn\x3d"+onlyReturn;if(returnSalesOrderDetailConfirm!==undefined&&returnSalesOrderDetailConfirm!==null&&returnSalesOrderDetailConfirm!=0)url=url+"\x26returnSalesOrderDetailConfirm\x3d"+returnSalesOrderDetailConfirm;if(returnSalesOrderDetailStatus!==
undefined&&returnSalesOrderDetailStatus!==null&&returnSalesOrderDetailStatus!=0)url=url+"\x26returnSalesOrderDetailStatus\x3d"+returnSalesOrderDetailStatus;if(returnSalesOrderDetailTransfer!==undefined&&returnSalesOrderDetailTransfer!==null&&returnSalesOrderDetailTransfer!=0)url=url+"\x26returnSalesOrderDetailTransferPsoFlag\x3d"+returnSalesOrderDetailTransfer;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)};this.getReturnOrderMasterCount=
function(confirm,status,transferPsoFlag,resUuid){confirm=confirm==0?"":confirm;status=status==0?"":status;transferPsoFlag=transferPsoFlag==0?"":transferPsoFlag;var url="/salesOrders/count?"+"\x26returnSalesOrderDetailConfirm\x3d"+confirm+"\x26returnSalesOrderDetailStatus\x3d"+status+"\x26returnSalesOrderDetailTransferPsoFlag\x3d"+transferPsoFlag+"\x26onlyReturn\x3d1";if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)}});
angular.module("IOne-Production").service("PSOReturnSalesOrdersDetailsService",function($http,Constant){this.getAll=function(masterUuid){return $http.get(Constant.BACKEND_BASE+"/salesOrders/"+masterUuid+"/returnSalesOrders")};this.get=function(masterUuid,detailUuid){return $http.get(Constant.BACKEND_BASE+"/salesOrders/"+masterUuid+"/returnSalesOrders/"+detailUuid)};this.modify=function(masterUuid,detailUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/salesOrders/"+masterUuid+"/returnSalesOrders/"+
detailUpdateInput.uuid,detailUpdateInput)};this.confirm=function(masterUuid,uuids,val){return $http.patch(Constant.BACKEND_BASE+"/salesOrders/"+masterUuid+"/returnSalesOrders/"+uuids,{"modifyOnly":"1","confirm":val})};this.transfer=function(masterUuid,uuids){return $http.post(Constant.BACKEND_BASE+"/salesOrders/"+masterUuid+"/returnSalesOrders?toERP\x3dtrue",{"returnSalesOrderDetailUuids":uuids.split(",")})}});
angular.module("IOne-Production").service("PSOReturnSalesOrdersExtendsService",function($http,Constant){this.getAll=function(masterUuid,detailUuid){var url="/salesOrders/"+masterUuid+"/returnSalesOrders/"+detailUuid+"/extends/";return $http.get(Constant.BACKEND_BASE+url)};this.modify=function(masterUuid,detailUuid,extendUuid,extendUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/salesOrders/"+masterUuid+"/returnSalesOrders/"+detailUuid+"/extends/"+extendUuid,extendUpdateInput)}});
angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/auth/role",{controller:"RoleController",templateUrl:"app/src/app/auth/role/role.html"})}]);
angular.module("IOne-Production").controller("RoleController",function($scope,$http,$mdDialog,Constant,RoleService,FunctionRoleService,UserRoleService){$scope.pageOption={sizePerPage:20,currentPage:0,totalPage:0,totalElements:10};$scope.listFilterOption={status:Constant.STATUS[0].value};$scope.$watch("listFilterOption",function(newValue,oldValue){if(newValue.status!=oldValue.status){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshAllEntities()}},
true);$scope.listFilterDisplayOption={showStatusFilterMenu:true,showConfirmFilterMenu:false,showReleaseFilerMenu:false,showProdTypeFilterMenu:false,showStopProdFilterMenu:false};$scope.formMenuDisplayOption={"100-add":{display:true,name:"新增",uuid:""},"101-delete":{display:true,name:"删除",uuid:""},"102-edit":{display:true,name:"编辑",uuid:""},"103-copy":{display:false,name:"复制",uuid:""},"104-status":{display:true,name:"启用",uuid:""},"105-confirm":{display:false,name:"审核",uuid:""},"106-release":{display:false,
name:"发布",uuid:""},"200-cancel":{display:true,name:"取消新增",uuid:""},"201-save":{display:true,name:"保存",uuid:""},"300-add":{display:false,name:"新增节点",uuid:""},"301-delete":{display:false,name:"删除节点",uuid:""},"302-save":{display:true,name:"保存",uuid:""},"303-cancel":{display:true,name:"取消修改",uuid:""},"304-quit":{display:true,name:"退出编辑",uuid:""}};$scope.refreshAllEntities=function(){RoleService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.status,$scope.searchKeyword).success(function(data){$scope.allEntities=
data;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements})};$scope.listTabSelected=function(){$scope.refreshAllEntities();$scope.selectedItem=null;$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS,0)};$scope.formTabSelected=function(){};$scope.editItem=function(role){$scope.selectedItem=role;$scope.changeViewStatus(Constant.UI_STATUS.PRE_EDIT_UI_STATUS,1);$scope.showRoleFunctions($scope.selectedItem)};$scope.showRoleFunctions=function(role){FunctionRoleService.get(role.uuid).success(function(data){role.roleFunctionList=
data})};$scope.exitModifyMenuAction=function(){$scope.changeViewStatus($scope.UI_STATUS.PRE_EDIT_UI_STATUS,1)};$scope.addRoleFunction=function(){$mdDialog.show({controller:"FunctionListController",templateUrl:"app/src/app/auth/role/addFunctionDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{}}).then(function(data){FunctionRoleService.add($scope.selectedItem.uuid,data.selectedFunction.uuid).success(function(data){$scope.selectedItem.roleFunctionList=$scope.selectedItem.roleFunctionList||
[];$scope.selectedItem.roleFunctionList.push(data)}).error(function(){$scope.showError("新增角色失败，该角色可能已存在。")})})};$scope.deleteRoleFunction=function(roleFunction){FunctionRoleService.delete(roleFunction.uuid).success(function(){$scope.selectedItem.roleFunctionList.splice($scope.selectedItem.roleFunctionList.indexOf(roleFunction),1)})};$scope.preAddMenuAction=function(){$scope.selectedItem={};$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_ADD,1)};$scope.addMenuAction=function(){RoleService.add($scope.selectedItem).success(function(data){$scope.selectedItem=
data;$scope.allEntities.content.push(data);$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_MODIFY,1);$scope.showInfo("新增角色信息成功。")}).error(function(){$scope.showError("新增角色信息失败, 该角色可能已存在。")})};$scope.modifyMenuAction=function(){RoleService.modify($scope.selectedItem).success(function(data){$scope.showInfo("修改角色信息成功。")}).error(function(){$scope.showError("修改角色信息失败。")})};$scope.cancelModifyMenuAction=function(){RoleService.get($scope.selectedItem.uuid).success(function(data){$scope.selectedItem=
data;$scope.showRoleFunctions($scope.selectedItem)})};$scope.cancelAddMenuAction=function(){$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_DELETE,0)};$scope.deleteMenuAction=function(){$scope.showConfirm("确认删除吗？","删除的角色不可恢复。",function(){RoleService.delete($scope.selectedItem.uuid).success(function(data){$scope.showInfo("删除角色信息成功。");$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_DELETE,0)}).error(function(){$scope.showError("删除角色信息失败。")})})};$scope.$watchCollection("selectedItem.status",
function(){if($scope.selectedItem)if($scope.selectedItem.status=="1")$scope.formMenuDisplayOption["104-status"].name="禁用";else if($scope.selectedItem.status=="2")$scope.formMenuDisplayOption["104-status"].name="启用"});$scope.statusMenuAction=function(){if($scope.selectedItem.status=="1")$scope.selectedItem.status="2";else $scope.selectedItem.status="1";$scope.modifyMenuAction()}});
angular.module("IOne-Production").controller("FunctionListController",function($scope,$mdDialog,FunctionService){FunctionService.getAll(1E4,0).success(function(data){$scope.allFunctions=data.content});$scope.selectedFunction={uuid:""};$scope.hideDlg=function(){$mdDialog.hide({"selectedFunction":$scope.selectedFunction})};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/dsm/rule",{controller:"DSMRuleController",templateUrl:"app/src/app/dsm/rule/rule.html"})}]);
angular.module("IOne-Production").controller("DSMRuleController",function($scope,Constant,DsmRuleService,DsmAdaptorsService){$scope.listFilterOption={status:Constant.STATUS[0].value};$scope.$watch("listFilterOption",function(newValue,oldValue){if(newValue.status!=oldValue.status){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshAllEntities()}},true);$scope.listFilterDisplayOption={showStatusFilterMenu:true,showConfirmFilterMenu:false,showReleaseFilerMenu:false,
showProdTypeFilterMenu:false,showStopProdFilterMenu:false};$scope.formMenuDisplayOption={"100-add":{display:true,name:"新增",uuid:""},"101-delete":{display:true,name:"删除",uuid:""},"102-edit":{display:true,name:"编辑",uuid:""},"103-copy":{display:false,name:"复制",uuid:""},"104-status":{display:false,name:"启用",uuid:""},"105-confirm":{display:false,name:"审核",uuid:""},"106-release":{display:false,name:"发布",uuid:""},"200-cancel":{display:true,name:"取消新增",uuid:""},"201-save":{display:true,name:"保存",uuid:""},
"300-add":{display:false,name:"新增节点",uuid:""},"301-delete":{display:false,name:"删除节点",uuid:""},"302-save":{display:true,name:"保存",uuid:""},"303-cancel":{display:true,name:"取消修改",uuid:""},"304-quit":{display:true,name:"退出编辑",uuid:""}};$scope.refreshAllEntities=function(){DsmRuleService.query({},function(data){$scope.allEntities=data})};$scope.loadSrcObject=function(){DsmAdaptorsService.getObjectFromAdaptor($scope.selectedItem.srcAdaptor).success(function(data){$scope.srcObjectList=data})};$scope.loadSrcObjectFields=
function(){DsmAdaptorsService.getFieldsFromObject($scope.selectedItem.srcAdaptor).success(function(data){$scope.srcObjectList=data})};$scope.listTabSelected=function(){$scope.refreshAllEntities();$scope.selectedItem=null;$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS,0)};$scope.formTabSelected=function(){DsmAdaptorsService.getAdaptors().success(function(data){$scope.adaptorList=data})};$scope.editItem=function(rule){$scope.selectedItem=rule;$scope.changeViewStatus(Constant.UI_STATUS.PRE_EDIT_UI_STATUS,
1)};$scope.preAddMenuAction=function(){$scope.selectedItem={srcAdaptor:"",dstAdaptor:"",rule:{tables:{src:[],dst:{name:""}},columns:{}}};$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_ADD,1)};$scope.addMenuAction=function(){DsmRuleService.save({},$scope.selectedItem,function(data){$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_MODIFY,1);$scope.showInfo("新增规则成功。")},function(){$scope.showError("新增规则失败。")})}});
angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/sale-order-change",{controller:"SaleOrderChangeController",templateUrl:"app/src/app/order/sale_change/saleChangeList.html"})}]);
angular.module("IOne-Production").controller("SaleOrderChangeController",function($q,$scope,PsoOrderChangeMaster,PsoOrderChangeDetail,PsoOrderChangeExtendDetail,PsoOrderChangeExtendDetail2,ReceiptDetail,Constant,$mdDialog){$scope.selectedItemSize=0;$scope.selectedItemAmount=0;$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={select:{status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value,transferPsoFlag:Constant.TRANSFER_PSO_FLAG[0].value}};
$scope.menuDisplayOption={"confirm":{display:true,name:"审核",uuid:"8cbe8322-dfe7-42d3-8dd7-6b3963cf1fa5"},"revertConfirm":{display:true,name:"取审",uuid:"ca19c1b2-8136-4451-bcf3-192efa193804"},"transfer":{display:true,name:"抛转",uuid:"91f66d12-9e6d-4a4e-920d-227bf1552cc5"},"batchConfirm":{display:true,name:"批量审核",uuid:"d2b7f59b-7b05-40f4-b3ff-4c8699a3a002"},"batchRevertConfirm":{display:true,name:"批量取审",uuid:"1190f67b-834e-4960-b67e-aa6b9ad0f125"},"batchTransfer":{display:true,name:"批量拋转",uuid:"315c8021-249c-426c-b84c-1ac982a1f026"},
"detailConfirm":{display:true,name:"审核",uuid:"32e80f5c-7ae7-4245-8587-5bf6f8e684f3"},"detailRevertConfirm":{display:true,name:"取审",uuid:"a357dff4-683f-4f87-9965-a878c2f5be00"},"detailTransfer":{display:true,name:"抛转",uuid:"ce35a122-4a6c-4a12-875c-3e47d5149925"},"add":{display:true,name:"新增",uuid:"8e4ca13d-37b3-45d2-962c-b9910e89adb7"},"oneOffSync":{display:true,name:"一键抛转",uuid:"6C954DAC-F520-4F5B-8517-2DE425B4C661"}};$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};
$scope.refreshList=function(){PsoOrderChangeMaster.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;$scope.disableBatchMenuButtons()}).error(function(response){$scope.showError(response.message)})};$scope.getMenuAuthData($scope.RES_UUID_MAP.PSO.ORDER_CHANGE.RES_UUID).success(function(data){$scope.menuAuthDataMap=
$scope.menuDataMap(data)});$scope.$watch("listFilterOption.select",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()}};$scope.queryClick=function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()};
$scope.selectAllFlag=false;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;PsoOrderChangeDetail.get($scope.selectedItem.uuid).success(function(data){$scope.selectedItem.detailList=data.content})};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;$scope.selectedItem=null};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;PsoOrderChangeDetail.get(item.uuid).success(function(data){item.detailList=
data.content})};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS)};$scope.showOrderChangeEditor=function(selectedItem){$mdDialog.show({controller:"EditOrderChangeController",templateUrl:"app/src/app/order/sale_change/saleChangeEditDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{parentSelectedItem:selectedItem}}).then(function(data){var postData={"deliverDate":data.deliverDate,"predictDeliverDate":data.predictDeliverDate,"customerAddressUuid":data.customerAddress.uuid};
PsoOrderChangeMaster.modify($scope.selectedItem.uuid,postData).success(function(){$scope.updateSelectedItem(data);$scope.showInfo("修改成功。")}).error(function(response){$scope.showError(response.message)})})};$scope.updateSelectedItem=function(updateSelectedItemInput){$scope.selectedItem.deliverDate=updateSelectedItemInput.deliverDate;$scope.selectedItem.predictDeliverDate=updateSelectedItemInput.predictDeliverDate;$scope.selectedItem.receivePhone=updateSelectedItemInput.receivePhone;$scope.selectedItem.receiveName=
updateSelectedItemInput.receiveName;$scope.selectedItem.receiveAddress=updateSelectedItemInput.receiveAddress;$scope.selectedItem.customerAddress=updateSelectedItemInput.customerAddress;angular.forEach($scope.selectedItem.detailList,function(detail){if(detail.deliverDate!=$scope.selectedItem.deliverDate)detail.deliverDate=$scope.selectedItem.deliverDate;if(detail.originalDeliverDate!=$scope.selectedItem.deliverDate)detail.originalDeliverDate=$scope.selectedItem.deliverDate})};$scope.showDetailEditor=
function(detail){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$mdDialog.show({controller:"EditOrderChangeDetailController",templateUrl:"app/src/app/order/sale_change/detailEditDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{parentDetail:detail}}).then(function(data){var postData={"orderQuantity":data.orderQuantity,"deliverDate":data.deliverDate,"status":data.status};PsoOrderChangeDetail.modify($scope.selectedItem.uuid,detail.uuid,postData).success(function(){$scope.updateDetailUI(data,
detail);$scope.showInfo("修改成功。")}).error(function(response){$scope.showError(response.message)})})};$scope.updateDetailUI=function(source,detail){detail.orderQuantity=source.orderQuantity;detail.deliverDate=source.deliverDate;detail.status=source.status};$scope.openOrderDlg=function(){$mdDialog.show({controller:"SelectOrderController",templateUrl:"app/src/app/order/sale_change/selectOrderDlg.html",parent:angular.element(document.body),targetEvent:event}).then(function(data){$scope.selectedOrder=data;
$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add"})};$scope.openSelectAddressDlg=function(selectedItem){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$mdDialog.show({controller:"SelectCustomerAddressController",templateUrl:"app/src/app/order/sale_change/selectCustomerAddressDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{parentSelectedItem:selectedItem}}).then(function(selectedCustomerAddress){$scope.selectedOrder.receivePhone=
selectedCustomerAddress.receivePhone;$scope.selectedOrder.receiveName=selectedCustomerAddress.receiveName;$scope.selectedOrder.receiveAddress=selectedCustomerAddress.receiveAddress;$scope.selectedOrder.customerAddress=selectedCustomerAddress})};$scope.saveItemAction=function(editItemAction){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);if($scope.status=="add")PsoOrderChangeMaster.add($scope.selectedOrder.uuid,$scope.selectedOrder).success(function(data){$scope.showInfo("保存成功");$scope.refreshList()}).error(function(response){$scope.showError("保存失败, 原因: "+
response.message)});else if($scope.status=="edit")if($scope.domain=="PSO_ORDER_MST")console.info("edit order mst...");else if($scope.domain=="PSO_ORDER_DTL")console.info("edit order dtl...")};$scope.selectItemAction=function(event,item){$scope.stopEventPropagation(event);item.selectedRef=!item.selected;if(item.selected==false||item.selected==undefined||item.selected==null){$scope.selectedItemSize+=1;$scope.selectedItemAmount+=item.orderAmount}else{$scope.selectedItemSize-=1;$scope.selectedItemAmount-=
item.orderAmount;$scope.selectAllFlag=false}$scope.disableBatchMenuButtons()};$scope.confirmClickAction=function(event,item,confirmVal){$scope.stopEventPropagation(event);console.info("confirm...");var action="审核";var popMessage="审核后变更将会生效，确认审核吗？";if(confirmVal==Constant.CONFIRM[1].value){action="取消审核";popMessage="取消审核后产品销售单将会回退到之前版本，确认取消审核吗？"}$scope.showConfirm(popMessage,"",function(){PsoOrderChangeMaster.confirm(item.uuid,confirmVal).success(function(){item.confirm=confirmVal;$scope.updateOrderChangeDetailsConfirm(item);
$scope.showInfo("产品销售变更单"+action+"成功！");$scope.disableBatchMenuButtons();$scope.getOrderMasterCount()}).error(function(response){$scope.showError(response.message)})})};$scope.statusClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("confirm...");$scope.showConfirm("确认启用吗？","",function(){PsoOrderChangeMaster.modify(item.uuid,{"status":"1"}).success(function(){item.status=Constant.STATUS[1].value;$scope.showInfo("启用成功！");$scope.disableBatchMenuButtons();$scope.getOrderMasterCount()}).error(function(response){$scope.showError(response.message)})})};
$scope.cancelStatusClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("confirm...");$scope.showConfirm("确认禁用吗？","",function(){PsoOrderChangeMaster.modify(item.uuid,{"status":"2"}).success(function(){item.status=Constant.STATUS[2].value;$scope.showInfo("禁用成功！");$scope.disableBatchMenuButtons();$scope.getOrderMasterCount()}).error(function(response){$scope.showError(response.message)})})};$scope.transferClickAction=function(event,item){$scope.stopEventPropagation(event);
console.info("transfer...");$scope.showConfirm("抛转后将会生成预订单变更单，确认抛转吗？","",function(){PsoOrderChangeMaster.transfer(item.uuid).success(function(){item.transferPsoFlag=Constant.TRANSFER_PSO_FLAG[1].value;$scope.showInfo("产品销售变更单抛转成功！");$scope.disableBatchMenuButtons();$scope.getOrderMasterCount()}).error(function(response){$scope.showError(response.message)})})};$scope.oneOffSync=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认一键抛转产品销售单变更单吗？","",function(){PsoOrderChangeMaster.oneOffSync(item.uuid).success(function(){item.transferPsoFlag=
Constant.TRANSFER_PSO_FLAG[1].value;$scope.showInfo("产品销售变更单一键同步成功。");$scope.disableBatchMenuButtons();$scope.getOrderMasterCount()}).error(function(response){$scope.showError(response.message)})})};$scope.confirmAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");return}$scope.showConfirm("确认审核吗","",function(){var promises=[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected){var response=PsoOrderChangeMaster.confirm(item.uuid,
Constant.CONFIRM[2].value).success(function(){item.confirm=Constant.CONFIRM[2].value;$scope.updateOrderChangeDetailsConfirm(item)}).error(function(response){bError=true;$scope.showError(item.no+" 审核失败："+response.message)});promises.push(response)}});$q.all(promises).then(function(data){if(!bError){$scope.showInfo("审核成功！");$scope.getOrderMasterCount()}$scope.disableBatchMenuButtons()})})};$scope.cancelConfirmAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==
0){$scope.showWarn("请先选择记录！");return}$scope.showConfirm("确认取消审核吗","",function(){var promises=[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected){var response=PsoOrderChangeMaster.confirm(item.uuid,Constant.CONFIRM[1].value).success(function(){item.confirm=Constant.CONFIRM[1].value;$scope.updateOrderChangeDetailsConfirm(item)}).error(function(response){bError=true;$scope.showError(item.no+" 取消审核失败："+response.message)});promises.push(response)}});$q.all(promises).then(function(data){if(!bError){$scope.showInfo("取消审核成功！");
$scope.getOrderMasterCount()}$scope.disableBatchMenuButtons()})})};$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");return}$scope.showConfirm("确认启用吗","",function(){var promises=[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected){var response=PsoOrderChangeMaster.modify(item.uuid,{"status":"1"}).success(function(){item.status=Constant.STATUS[1].value}).error(function(response){bError=
true;$scope.showError(item.no+" 启用失败："+response.message)});promises.push(response)}});$q.all(promises).then(function(data){if(!bError){$scope.showInfo("启用成功！");$scope.getOrderMasterCount()}$scope.disableBatchMenuButtons()})})};$scope.cancelStatusAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");return}$scope.showConfirm("确认禁用吗","",function(){var promises=[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected){var response=
PsoOrderChangeMaster.modify(item.uuid,{"status":"2"}).success(function(){item.status=Constant.STATUS[2].value}).error(function(response){bError=true;$scope.showError(item.no+" 禁用失败："+response.message)});promises.push(response)}});$q.all(promises).then(function(data){if(!bError){$scope.showInfo("禁用成功！");$scope.getOrderMasterCount()}$scope.disableBatchMenuButtons()})})};$scope.transferAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");
return}$scope.showConfirm("确认抛转吗","",function(){var promises=[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected){var response=PsoOrderChangeMaster.transfer(item.uuid).success(function(){item.transferPsoFlag="1"}).error(function(response){bError=true;$scope.showError(item.no+" 抛转失败："+response.message)});promises.push(response)}});$q.all(promises).then(function(data){if(!bError){$scope.showInfo("抛转成功！");$scope.getOrderMasterCount()}$scope.disableBatchMenuButtons()})})};
$scope.transferAllneOffSyncAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");return}$scope.showConfirm("确认一键抛转吗","",function(){var promises=[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected){var response=PsoOrderChangeMaster.oneOffSync(item.uuid).success(function(){item.transferPsoFlag="1"}).error(function(response){bError=true;$scope.showError(item.no+" 抛转失败："+response.message)});promises.push(response)}});
$q.all(promises).then(function(data){if(!bError){$scope.showInfo("抛转成功！");$scope.getOrderMasterCount()}$scope.disableBatchMenuButtons()})})};$scope.updateOrderChangeDetailsConfirm=function(item){if(item.detailList!=null)angular.forEach(item.detailList,function(detail){detail.confirm=item.confirm})};$scope.selectAllAction=function(){angular.forEach($scope.itemList,function(item){if($scope.selectAllFlag)item.selected=true;else item.selected=false;item.selectedRef=item.selected});$scope.selectedItemSize=
0;$scope.selectedItemAmount=0;if($scope.selectAllFlag)angular.forEach($scope.itemList,function(item){$scope.selectedItemSize++;$scope.selectedItemAmount+=item.orderAmount});$scope.disableBatchMenuButtons()};$scope.refreshExtendDetailTab=function(selectedItem){var byExtendNo=function(){return function(orderChangeExt1,orderChangeExt2){var no1,no2;if(typeof orderChangeExt1==="object"&&typeof orderChangeExt2==="object"&&orderChangeExt1&&orderChangeExt2){no1=orderChangeExt1.orderExtendDetail.no;no2=orderChangeExt2.orderExtendDetail.no;
if(no1===no2)return 0;if(typeof no1===typeof no2)return no1<no2?-1:1;return typeof no1<typeof no2?-1:1}}};$scope.selectedItem.extendDetailList=[];angular.forEach($scope.selectedItem.detailList,function(orderDetail,index){PsoOrderChangeExtendDetail.get(selectedItem.uuid,orderDetail.uuid).success(function(data){if(data.totalElements>0)$scope.selectedItem.extendDetailList=$scope.selectedItem.extendDetailList.concat(data.content);$scope.selectedItem.extendDetailList=$scope.selectedItem.extendDetailList.sort(byExtendNo())})})};
$scope.refreshReceiptInfoTab=function(selectedItem){ReceiptDetail.get($scope.selectedItem.orderMaster.uuid).success(function(data){$scope.receiptOrderDetailList=data;angular.forEach($scope.receiptOrderDetailList.content,function(receiptOrderDetail){if(null!=receiptOrderDetail.payOrder)receiptOrderDetail.payOrder=$scope.getImageFullPath(receiptOrderDetail.payOrder)})})};$scope.showExtendDetail2Viewer=function(extendDetail){$mdDialog.show({controller:"ViewOrderChangeDetail2Controller",templateUrl:"app/src/app/order/sale_change/extendDetail2ViewDlg.html",
parent:angular.element(document.body),targetEvent:event,locals:{parentExtendDetail:extendDetail}}).then(function(data){})};$scope.disableBatchMenuButtons=function(){var selectedCount=0;var confirm="";var status="";var transferReturnFlag="";var diffConfirm=false;var diffStatus=false;var diffTransferReturnFlag=false;angular.forEach($scope.itemList,function(item,index){if(item.selectedRef){selectedCount++;if(confirm=="")confirm=item.confirm;else if(confirm!=item.confirm)diffConfirm=true;if(status=="")status=
item.status;else if(status!=item.status)diffStatus=true;if(transferReturnFlag=="")transferReturnFlag=item.transferPsoFlag;else if(transferReturnFlag!=item.transferPsoFlag)diffTransferReturnFlag=true}});if(selectedCount==0){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchTransfer=true}else{if(diffConfirm==true){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true}else if(confirm==
"2"){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=false}else{$scope.disabledBatchConfirm=false;$scope.disabledBatchCancelConfirm=true}if(diffStatus==true){$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true}else if(status=="1"){$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=false}else{$scope.disabledBatchStatus=false;$scope.disabledBatchCancelStatus=true}if(diffTransferReturnFlag==true)$scope.disabledBatchTransfer=true;else if(transferReturnFlag==
"1")$scope.disabledBatchTransfer=true;else $scope.disabledBatchTransfer=false}};$scope.getOrderMasterCount=function(){PsoOrderChangeMaster.getOrderMasterCount(Constant.CONFIRM[1].value,Constant.STATUS[1].value,Constant.TRANSFER_PSO_FLAG[2].value,RES_UUID_MAP.PSO.ORDER_CHANGE.RES_UUID).success(function(data){$scope.menuList[1].subList[4].suffix=data})}});
angular.module("IOne-Production").controller("EditOrderChangeController",function($scope,$mdDialog,parentSelectedItem){$scope.customerAddressSelectionParam={customerUuid:""};$scope.initCustomerAddressSelectionParam=function(){if(parentSelectedItem.customerAddress!=null&&parentSelectedItem.customerAddress.customer!=null)$scope.customerAddressSelectionParam.customerUuid=parentSelectedItem.customerAddress.customer.uuid};$scope.initCustomerAddressSelectionParam();$scope.selectedItem={"deliverDate":parentSelectedItem.deliverDate,
"predictDeliverDate":parentSelectedItem.predictDeliverDate,"receivePhone":parentSelectedItem.receivePhone,"receiveName":parentSelectedItem.receiveName,"receiveAddress":parentSelectedItem.receiveAddress,"customerAddress":parentSelectedItem.customerAddress};if(parentSelectedItem.deliverDate!=null)$scope.selectedItem.deliverDate=new Date(parentSelectedItem.deliverDate);if(parentSelectedItem.predictDeliverDate!=null)$scope.selectedItem.predictDeliverDate=new Date(parentSelectedItem.predictDeliverDate);
$scope.pageOption={sizePerPage:5,currentPage:0,totalPage:0,totalElements:0,displayModel:0};$scope.saveOrderChange=function(){$mdDialog.hide($scope.selectedItem)};$scope.cancelDlg=function(){$mdDialog.cancel()};$scope.selectCustomerAddressCallback=function(selectedCustomerAddress){$scope.selectedItem.receivePhone=selectedCustomerAddress.receivePhone;$scope.selectedItem.receiveName=selectedCustomerAddress.receiveName;$scope.selectedItem.receiveAddress=selectedCustomerAddress.receiveAddress;$scope.selectedItem.customerAddress=
selectedCustomerAddress}});angular.module("IOne-Production").controller("EditOrderChangeDetailController",function($scope,$mdDialog,parentDetail){$scope.detail={"orderQuantity":parentDetail.orderQuantity,"deliverDate":parentDetail.deliverDate,"status":parentDetail.status};if(parentDetail.deliverDate!=null)$scope.detail.deliverDate=new Date(parentDetail.deliverDate);$scope.saveDetail=function(){$mdDialog.hide($scope.detail)};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").controller("ViewOrderChangeDetail2Controller",function($scope,$mdDialog,parentExtendDetail,OrderCustomScope,OrderItemCustomDetail,PsoOrderChangeExtendDetail2){$scope.extendDetail=parentExtendDetail;$scope.initAllCustomsScopes=function(parentExtendDetail){OrderItemCustomDetail.getCustomDetail(parentExtendDetail.item.uuid).success(function(data){$scope.allCustomsScopes={};$scope.selectedItemCustoms=data;angular.forEach($scope.selectedItemCustoms.content,function(value){value.informationUuids=
JSON.parse(value.information)});angular.forEach($scope.selectedItemCustoms.content,function(itemCustomDetail){angular.forEach(itemCustomDetail.informationUuids,function(informationUuid){OrderCustomScope.getCustomScope(itemCustomDetail.itemCustom.uuid,informationUuid).success(function(data){if(data.brand!=null&&parentExtendDetail.item.brand!=null&&parentExtendDetail.item.brand.name!=data.brand.name);else if($scope.allCustomsScopes[itemCustomDetail.itemCustom.uuid]==undefined){var value={};value[data.uuid]=
data;$scope.allCustomsScopes[itemCustomDetail.itemCustom.uuid]=value}else{var value=$scope.allCustomsScopes[itemCustomDetail.itemCustom.uuid];value[data.uuid]=data;$scope.allCustomsScopes[itemCustomDetail.itemCustom.uuid]=value}})})})})};$scope.getExtendDetail2s=function(parentExtendDetail){$scope.initAllCustomsScopes(parentExtendDetail);PsoOrderChangeExtendDetail2.get(parentExtendDetail.orderChangeDetail.orderChange.uuid,parentExtendDetail.orderChangeDetail.uuid,parentExtendDetail.uuid).success(function(data){$scope.orderExtendDetail2List=
data.content;angular.forEach($scope.orderExtendDetail2List,function(value){value.informationUuids=JSON.parse(value.information)})})};$scope.getExtendDetail2s(parentExtendDetail);$scope.saveDetail=function(){$mdDialog.hide(extendDetail)};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").controller("SelectOrderController",function($scope,Constant,$mdDialog,OrderMaster){$scope.STATUS=Constant.STATUS;$scope.CONFIRM=Constant.CONFIRM;$scope.TRANSFER_PSO_FLAG=Constant.TRANSFER_PSO_FLAG;$scope.orderStatus=Constant.STATUS[0].value;$scope.orderConfirm=Constant.CONFIRM[0].value;$scope.orderTransferPsoFlag=Constant.TRANSFER_PSO_FLAG[0].value;$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:0,totalElements:0,displayModel:0};$scope.refreshOrderList=
function(){OrderMaster.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.orderConfirm,$scope.orderStatus,$scope.orderTransferPsoFlag,$scope.orderNo).success(function(data){$scope.orderList=data.content;$scope.pageOption.totalElements=data.totalElements;$scope.pageOption.totalPage=data.totalPages})};$scope.refreshOrderList();$scope.selectOrder=function(order){$scope.selectedOrder=order;$mdDialog.hide($scope.selectedOrder)};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").controller("SelectCustomerAddressController",function($scope,$mdDialog,parentSelectedItem){$scope.customerAddressSelectionParam={customerUuid:""};$scope.initCustomerAddressSelectionParam=function(){if(parentSelectedItem.customerAddress!=null&&parentSelectedItem.customerAddress.customer!=null)$scope.customerAddressSelectionParam.customerUuid=parentSelectedItem.customerAddress.customer.uuid};$scope.initCustomerAddressSelectionParam();$scope.selectedItem={"customerAddress":parentSelectedItem.customerAddress};
if(parentSelectedItem.deliverDate!=null)$scope.selectedItem.deliverDate=new Date(parentSelectedItem.deliverDate);if(parentSelectedItem.predictDeliverDate!=null)$scope.selectedItem.predictDeliverDate=new Date(parentSelectedItem.predictDeliverDate);$scope.pageOption={sizePerPage:5,currentPage:0,totalPage:0,totalElements:0,displayModel:0};$scope.saveOrderChange=function(){$mdDialog.hide($scope.selectedItem)};$scope.cancelDlg=function(){$mdDialog.cancel()};$scope.selectCustomerAddressCallback=function(selectedCustomerAddress){$mdDialog.hide(selectedCustomerAddress)}});
angular.module("IOne-Production").service("PsoOrderChangeMaster",function($http,Constant){this.getAll=function(sizePerPage,page,filter){var confirm=filter.select.confirm==0?"":filter.select.confirm;var transferPsoFlag=filter.select.transferPsoFlag==0?"":filter.select.transferPsoFlag;var status=filter.select.status==0?"":filter.select.status;var url="orderChanges?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26onlyLatest\x3d2";if(confirm!=="")url=url+"\x26confirm\x3d"+confirm;if(transferPsoFlag!=="")url=
url+"\x26transferPsoFlag\x3d"+transferPsoFlag;if(status!=="")url=url+"\x26status\x3d"+status;if(filter.no!==null&&filter.no!==undefined)url=url+"\x26no\x3d"+filter.no;if(filter.employeeName!==null&&filter.employeeName!==undefined)url=url+"\x26employeeName\x3d"+filter.employeeName;if(filter.employeeNo!==null&&filter.employeeNo!==undefined)url=url+"\x26employeeNo\x3d"+filter.employeeNo;if(filter.customerName!==null&&filter.customerName!==undefined)url=url+"\x26customerName\x3d"+filter.customerName;
if(filter.select.startOrderDate!==null&&filter.select.startOrderDate!==undefined){var startOrderDate=new Date(filter.select.startOrderDate);startOrderDate=moment(startOrderDate).format("YYYY-MM-DD 00:00:00");url=url+"\x26orderDateBegin\x3d"+startOrderDate}if(filter.select.endOrderDate!==null&&filter.select.endOrderDate!==undefined){var endOrderDate=new Date(filter.select.endOrderDate);endOrderDate=moment(endOrderDate).format("YYYY-MM-DD 23:59:59");url=url+"\x26orderDateEnd\x3d"+endOrderDate}return $http.get(Constant.BACKEND_BASE+
url)};this.confirm=function(uuids,confirmVal){return $http.patch(Constant.BACKEND_BASE+"/orderChanges/"+uuids,{"modifyOnly":"1","confirm":confirmVal})};this.transfer=function(uuid){return $http.patch(Constant.BACKEND_BASE+"/orderChanges/"+uuid,{"modifyOnly":"1","transferPsoFlag":"1"})};this.modify=function(uuid,orderChangeUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/orderChanges/"+uuid,orderChangeUpdateInput)};this.add=function(orderUuid,OrderChangeInput){return $http.post(Constant.BACKEND_BASE+
"/orderChanges?orderUuid\x3d"+orderUuid,OrderChangeInput)};this.oneOffSync=function(uuid){return $http.patch(Constant.BACKEND_BASE+"/orderChanges/"+uuid+"/sync")};this.getOrderMasterCount=function(confirm,status,transferPsoFlag,resUuid){confirm=confirm==0?"":confirm;status=status==0?"":status;transferPsoFlag=transferPsoFlag==0?"":transferPsoFlag;var url="/orderChanges/count?confirm\x3d"+confirm+"\x26status\x3d"+status+"\x26transferPsoFlag\x3d"+transferPsoFlag+"\x26onlyLatest\x3d2";if(resUuid!==undefined&&
resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)}});angular.module("IOne-Production").service("PsoOrderChangeDetail",function($http,Constant){this.get=function(masterUuid){return $http.get(Constant.BACKEND_BASE+"/orderChanges/"+masterUuid+"/details")};this.modify=function(masterUuid,uuid,orderChangeDetailUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/orderChanges/"+masterUuid+"/details/"+uuid,orderChangeDetailUpdateInput)}});
angular.module("IOne-Production").service("PsoOrderChangeExtendDetail",function($http,Constant){this.get=function(masterUuid,detailUuid){return $http.get(Constant.BACKEND_BASE+"/orderChanges/"+masterUuid+"/details/"+detailUuid+"/extends")}});
angular.module("IOne-Production").service("PsoOrderChangeExtendDetail2",function($http,Constant){this.get=function(orderChangeUuid,orderChangeDetailUuid,orderChangeExtendUuid){return $http.get(Constant.BACKEND_BASE+"/orderChanges/"+orderChangeUuid+"/details/"+orderChangeDetailUuid+"/extends/"+orderChangeExtendUuid+"/extend2s")}});
angular.module("IOne-Production").service("PsoOrderReturnMaster",function($http,Constant){this.getAll=function(sizePerPage,page,filter){var confirm=filter.select.confirm==0?"":filter.select.confirm;var transferPsoFlag=filter.select.transferPsoFlag==0?"":filter.select.transferPsoFlag;var status=filter.select.status==0?"":filter.select.status;var url="orders?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26onlyReturn\x3d1";if(confirm!=="")url=url+"\x26returnOrderDetailConfirm\x3d"+confirm;if(transferPsoFlag!==
"")url=url+"\x26returnOrderDetailTransferPsoFlag\x3d"+transferPsoFlag;if(status!=="")url=url+"\x26returnOrderDetailStatus\x3d"+status;if(filter.no!==null&&filter.no!==undefined)url=url+"\x26orderMasterNo\x3d"+filter.no;if(filter.employeeName!==null&&filter.employeeName!==undefined)url=url+"\x26employeeName\x3d"+filter.employeeName;if(filter.employeeNo!==null&&filter.employeeNo!==undefined)url=url+"\x26employeeNo\x3d"+filter.employeeNo;if(filter.customerName!==null&&filter.customerName!==undefined)url=
url+"\x26customerName\x3d"+filter.customerName;if(filter.select.startOrderDate!==null&&filter.select.startOrderDate!==undefined){var startOrderDate=new Date(filter.select.startOrderDate);startOrderDate=moment(startOrderDate).format("YYYY-MM-DD 00:00:00");url=url+"\x26orderDateBegin\x3d"+startOrderDate}if(filter.select.endOrderDate!==null&&filter.select.endOrderDate!==undefined){var endOrderDate=new Date(filter.select.endOrderDate);endOrderDate=moment(endOrderDate).format("YYYY-MM-DD 23:59:59");url=
url+"\x26orderDateEnd\x3d"+endOrderDate}return $http.get(Constant.BACKEND_BASE+url)};this.getReturnOrderMasterCount=function(confirm,status,transferPsoFlag,resUuid){confirm=confirm==0?"":confirm;status=status==0?"":status;transferPsoFlag=transferPsoFlag==0?"":transferPsoFlag;var url="/orders/count?"+"\x26returnOrderDetailConfirm\x3d"+confirm+"\x26returnOrderDetailStatus\x3d"+status+"\x26returnOrderDetailTransferPsoFlag\x3d"+transferPsoFlag+"\x26onlyReturn\x3d1";if(resUuid!==undefined&&resUuid!==null)url=
url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)}});
angular.module("IOne-Production").service("PsoOrderReturnDetail",function($http,Constant){this.get=function(masterUuid){return $http.get(Constant.BACKEND_BASE+"/orders/"+masterUuid+"/returnOrders")};this.confirm=function(masterUuid,uuids,val){return $http.patch(Constant.BACKEND_BASE+"/orders/"+masterUuid+"/returnOrders/"+uuids,{"modifyOnly":"1","confirm":val})};this.transfer=function(masterUuid,uuids){return $http.patch(Constant.BACKEND_BASE+"/orders/"+masterUuid+"/returnOrders/"+uuids,{"modifyOnly":"1",
"transferReturnFlag":"1"})}});angular.module("IOne-Production").service("PsoOrderReturnExtendDetail",function($http,Constant){this.get=function(masterUuid,returnDetailUuid){return $http.get(Constant.BACKEND_BASE+"/orders/"+masterUuid+"/returnOrders/"+returnDetailUuid+"/extends")}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/sale-order-return",{controller:"SaleOrderReturnController",templateUrl:"app/src/app/order/sale_return/saleReturnList.html"})}]);
angular.module("IOne-Production").controller("SaleOrderReturnController",function($scope,$q,PsoOrderReturnMaster,PsoOrderReturnDetail,PsoOrderReturnExtendDetail,Constant,$mdDialog){$scope.selectedItemSize=0;$scope.selectedItemAmount=0;$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={select:{status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value,transferPsoFlag:Constant.TRANSFER_PSO_FLAG[0].value}};$scope.menuDisplayOption={"confirm":{display:true,
name:"审核",uuid:"67cf38f3-7f72-4395-af39-ba4eac8c9944"},"revertConfirm":{display:true,name:"取审",uuid:"6f3f8055-1064-4705-8cd9-dc003188352e"},"transfer":{display:true,name:"抛转",uuid:"da09a9b1-18b4-483f-908f-c93c26d3ec73"},"batchConfirm":{display:true,name:"批量审核",uuid:"d9ae13e0-aaf6-4775-a995-837bd3ac7be0"},"batchRevertConfirm":{display:true,name:"批量取审",uuid:"c986aba8-48eb-4975-b22f-8540e85599c8"},"batchTransfer":{display:true,name:"批量拋转",uuid:"dbfdef83-c0cd-46c5-ad97-debc6b5bd7c1"},"detailConfirm":{display:true,
name:"审核",uuid:"b216d2ee-d6ee-4d71-bb66-496249721b6a"},"detailRevertConfirm":{display:true,name:"取审",uuid:"9a71e99f-976e-4dca-8c2e-8e75b88f0a37"},"detailTransfer":{display:true,name:"抛转",uuid:"8fb85cea-8acd-4c57-8777-57107b502ddc"},"detail2Confirm":{display:true,name:"审核",uuid:"3778eacc-323c-4363-bc4e-f9710aaef0cb"},"detail2RevertConfirm":{display:true,name:"取审",uuid:"e02ca1e7-0a89-42fd-b762-5c1fa2f4bbb7"},"detail2Transfer":{display:true,name:"抛转",uuid:"efe0f528-bc80-40b7-b34f-7170ce55a4db"}};$scope.sortByAction=
function(field){$scope.sortByField=field;$scope.sortType=""};$scope.refreshList=function(){PsoOrderReturnMaster.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;angular.forEach($scope.itemList,function(item){item.selectAllDetails=false;item.showMorePanel=true;$scope.attachDetailList(item)})}).error(function(response){$scope.showError(response.message)});
$scope.disableBatchMenuButtons()};$scope.getMenuAuthData($scope.RES_UUID_MAP.PSO.ORDER_RETURN.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)});$scope.$watch("listFilterOption.select",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()}};
$scope.queryClick=function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()};$scope.selectAllFlag=false;$scope.showDetailPanelAction=function(item){item.selectAllDetails=false;$scope.selectedItem=item;PsoOrderReturnDetail.get($scope.selectedItem.uuid).success(function(data){$scope.selectedItem.detailList=data.content;$scope.refreshExtendDetailTab($scope.selectedItem)}).error(function(response){$scope.showError(response.message)});
$scope.disableDetailMenuButtons()};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel};$scope.selectAllDetails=function(item){angular.forEach(item.detailList,function(detail){if(item.selectAllDetails)detail.selected=true;else detail.selected=false;detail.selectedRef=detail.selected});$scope.disableDetailMenuButtons()};$scope.selectDetailItemAction=function(event,detail){$scope.stopEventPropagation(event);detail.selectedRef=!detail.selected;$scope.disableDetailMenuButtons()};
$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;$scope.selectedItem=null};$scope.attachDetailList=function(item){item.showMorePanel=!item.showMorePanel;PsoOrderReturnDetail.get(item.uuid).success(function(data){item.detailList=data.content;$scope.updateMasterStateByReturnDetails(item)})};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS)};$scope.selectItemAction=function(event,item){$scope.stopEventPropagation(event);
item.selectedRef=!item.selected;if(item.selected==false||item.selected==undefined||item.selected==null){$scope.selectedItemSize+=1;$scope.selectedItemAmount+=item.returnAmount}else{$scope.selectedItemSize-=1;$scope.selectedItemAmount-=item.returnAmount;$scope.selectAllFlag=false}$scope.disableBatchMenuButtons()};$scope.confirmAllClickAction=function(event,confirmVal){$scope.stopEventPropagation(event);if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");return}var action="审核";if(confirmVal==
1)action="取消审核";$scope.showConfirm("确认"+action+"吗","",function(){var promises=[];var bError=false;var haveSelectedItems=false;angular.forEach($scope.itemList,function(item){if(item.selected){haveSelectedItems=true;var detailUuids="";angular.forEach(item.detailList,function(detail){if(detail.confirm!=confirmVal)if(!(confirmVal==1&&detail.transferReturnFlag=="1"))detailUuids+=detail.uuid+","});if(detailUuids!=""){var response=PsoOrderReturnDetail.confirm(item.uuid,detailUuids,confirmVal).success(function(data){$scope.updateDetailsConfirmState(item.detailList,
data);$scope.updateMasterStateByReturnDetails(item)}).error(function(response){bError=true;$scope.showError("产品销售退货单"+item.no+action+"失败："+response.message)});promises.push(response)}else{bError=true;$scope.showWarn("产品销售退货单"+item.no+"没有可"+action+"的商品！")}}});if(haveSelectedItems)$q.all(promises).then(function(data){if(!bError)$scope.showInfo("产品销售退货单"+action+"成功！");$scope.disableBatchMenuButtons();$scope.getReturnOrderMasterCount()});else $scope.showWarn("请选择需要"+action+"的产品销售退货单！")})};$scope.confirmClickAction=
function(event,item,confirmVal,bApplyAll){$scope.stopEventPropagation(event);console.info("confirm...");var action="审核";if(confirmVal==1)action="取消审核";$scope.showConfirm("确认"+action+"吗？","",function(){var detailUuids="";angular.forEach(item.detailList,function(detail){if(bApplyAll===true){if(detail.confirm!=confirmVal)if(!(confirmVal==1&&detail.transferReturnFlag=="1"))detailUuids+=detail.uuid+","}else if(detail.confirm!=confirmVal&&detail.selected==true)if(!(confirmVal==1&&detail.transferReturnFlag==
"1"))detailUuids+=detail.uuid+","});if(detailUuids!="")PsoOrderReturnDetail.confirm(item.uuid,detailUuids,confirmVal).success(function(data){$scope.updateDetailsConfirmState(item.detailList,data);$scope.updateMasterStateByReturnDetails(item);$scope.showInfo("产品销售退货单"+action+"成功！");$scope.disableBatchMenuButtons();$scope.disableDetailMenuButtons();$scope.getReturnOrderMasterCount()}).error(function(response){$scope.showError("产品销售退货单"+item.no+response.message)});else $scope.showWarn("请选择需要"+action+
"的商品！")})};$scope.confirmDetailClickAction=function(event,item,confirmVal,detail){$scope.stopEventPropagation(event);console.info("confirm...");var action="审核";if(confirmVal==1)action="取消审核";$scope.showConfirm("确认"+action+"吗？","",function(){PsoOrderReturnDetail.confirm(item.uuid,detail.uuid,confirmVal).success(function(data){detail.confirm=confirmVal;$scope.updateMasterStateByReturnDetails(item);$scope.disableBatchMenuButtons();$scope.disableDetailMenuButtons();$scope.showInfo("产品销售退货单"+action+"成功！");
$scope.getReturnOrderMasterCount()}).error(function(response){$scope.showError(response.message)})})};$scope.updateDetailsConfirmState=function(details,responseDetails){angular.forEach(details,function(detail){angular.forEach(responseDetails,function(responseDetail){if(detail.uuid==responseDetail.uuid){detail.confirm=responseDetail.confirm;detail.transferReturnFlag=responseDetail.transferReturnFlag}})})};$scope.transferAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==
0){$scope.showWarn("请先选择记录！");return}var action="抛转";$scope.showConfirm("确认"+action+"吗?","",function(){var promises=[];var bError=false;var haveSelectedItems=false;angular.forEach($scope.itemList,function(item){if(item.selected){haveSelectedItems=true;var detailUuids="";angular.forEach(item.detailList,function(detail){if(detail.confirm=="2"&&detail.transferReturnFlag!="1")detailUuids+=detail.uuid+","});if(detailUuids!=""){var response=PsoOrderReturnDetail.transfer(item.uuid,detailUuids).success(function(data){$scope.updateDetailsConfirmState(item.detailList,
data);$scope.updateMasterStateByReturnDetails(item)}).error(function(response){bError=true;$scope.showError("产品销售退货单"+item.no+action+"失败："+response.message)});promises.push(response)}else{bError=true;$scope.showWarn("产品销售退货单"+item.no+"没有可"+action+"的商品！")}}});if(haveSelectedItems)$q.all(promises).then(function(data){if(!bError)$scope.showInfo("产品销售退货单"+action+"成功！");$scope.disableBatchMenuButtons();$scope.getReturnOrderMasterCount()});else $scope.showWarn("请选择需要"+action+"的产品销售退货单！")})};$scope.transferClickAction=
function(event,item,bApplyAll){$scope.stopEventPropagation(event);console.info("transfer...");$scope.showConfirm("确认抛转吗？","",function(){var detailUuids="";angular.forEach(item.detailList,function(detail){if(bApplyAll===true){if(detail.confirm=="2"&&detail.transferReturnFlag!="1")detailUuids+=detail.uuid+","}else if(detail.confirm=="2"&&detail.transferReturnFlag!="1"&&detail.selected==true)detailUuids+=detail.uuid+","});if(detailUuids!="")PsoOrderReturnDetail.transfer(item.uuid,detailUuids).success(function(data){$scope.resetDetailCheckBoxes(item);
$scope.updateDetailsConfirmState(item.detailList,data);$scope.updateMasterStateByReturnDetails(item);$scope.disableBatchMenuButtons();$scope.disableDetailMenuButtons();$scope.showInfo("产品销售退货单抛转成功！");$scope.getReturnOrderMasterCount()}).error(function(response){$scope.showError("产品销售退货单"+item.no+response.message)});else $scope.showWarn("没有可抛转的商品！")})};$scope.transferDetailClickAction=function(event,item,detail){$scope.stopEventPropagation(event);console.info("transfer...");$scope.showConfirm("确认抛转吗？",
"",function(){PsoOrderReturnDetail.transfer(item.uuid,detail.uuid).success(function(data){detail.transferReturnFlag="1";detail.selected=false;$scope.updateMasterStateByReturnDetails(item);$scope.disableBatchMenuButtons();$scope.disableDetailMenuButtons();$scope.showInfo("产品销售退货单抛转成功！");$scope.getReturnOrderMasterCount()}).error(function(response){$scope.showError(response.message)})})};$scope.selectAllAction=function(){angular.forEach($scope.itemList,function(item){if($scope.selectAllFlag)item.selected=
true;else item.selected=false;item.selectedRef=item.selected});$scope.selectedItemSize=0;$scope.selectedItemAmount=0;if($scope.selectAllFlag)angular.forEach($scope.itemList,function(item){$scope.selectedItemSize++;$scope.selectedItemAmount+=item.returnAmount});$scope.disableBatchMenuButtons()};$scope.updateMasterStateByReturnDetails=function(item){var confirm=Constant.CONFIRM[2].value;var transferPsoFlag=Constant.TRANSFER_PSO_FLAG[1].value;var returnAmount=0;angular.forEach(item.detailList,function(detail){if(detail.confirm==
Constant.CONFIRM[1].value)confirm=detail.confirm;if(detail.transferReturnFlag==Constant.TRANSFER_PSO_FLAG[2].value)transferPsoFlag=detail.transferReturnFlag;returnAmount+=detail.originalReturnAmount});item.confirm=confirm;item.transferPsoFlag=transferPsoFlag;item.returnAmount=returnAmount};$scope.refreshExtendDetailTab=function(selectedItem){var byNo=function(){return function(ext1,ext2){var no1,no2;if(typeof ext1==="object"&&typeof ext2==="object"&&ext1&&ext2){no1=ext1.no;no2=ext2.no;if(no1===no2)return 0;
if(typeof no1===typeof no2)return no1<no2?-1:1;return typeof no1<typeof no2?-1:1}}};$scope.selectedItem.extendDetailList=[];angular.forEach($scope.selectedItem.detailList,function(orderDetail,index){orderDetail.selected=false;PsoOrderReturnExtendDetail.get(selectedItem.uuid,orderDetail.uuid).success(function(data){if(data.totalElements>0)$scope.selectedItem.extendDetailList=$scope.selectedItem.extendDetailList.concat(data.content).sort(byNo())}).error(function(response){$scope.showError(response.message)})})};
$scope.disableBatchMenuButtons=function(){var selectedCount=0;var confirm="";var transfer="";var diffConfirm=false;var diffTransfer=false;angular.forEach($scope.itemList,function(item,index){if(item.selectedRef){selectedCount++;if(confirm=="")confirm=item.confirm;else if(confirm!=item.confirm)diffConfirm=true;if(transfer=="")transfer=item.transferPsoFlag;else if(transfer!=item.transferPsoFlag)diffTransfer=true}});if(selectedCount==0){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=
true;$scope.disabledBatchTransfer=true}else{if(diffConfirm==true){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true}else if(confirm=="2"){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=false}else{$scope.disabledBatchConfirm=false;$scope.disabledBatchCancelConfirm=true}if(diffTransfer==true)$scope.disabledBatchTransfer=true;else if(transfer=="1")$scope.disabledBatchTransfer=true;else $scope.disabledBatchTransfer=false}};$scope.resetDetailCheckBoxes=function(item){item.selectAllDetails=
false;angular.forEach(item.detailList,function(detail){detail.selected=false})};$scope.disableDetailMenuButtons=function(){var selectedCount=0;var confirm="";var transfer="";var diffConfirm=false;var diffTransfer=false;if($scope.selectedItem!=null)angular.forEach($scope.selectedItem.detailList,function(detail,index){if(detail.selectedRef){selectedCount++;if(confirm=="")confirm=detail.confirm;else if(confirm!=detail.confirm)diffConfirm=true;if(transfer=="")transfer=detail.transferReturnFlag;else if(transfer!=
detail.transferReturnFlag)diffTransfer=true}});if(selectedCount==0){$scope.disabledDetailConfirm=true;$scope.disabledDetailCancelConfirm=true;$scope.disabledDetailTransfer=true}else{if(diffConfirm==true){$scope.disabledDetailConfirm=true;$scope.disabledDetailCancelConfirm=true}else if(confirm=="2"){$scope.disabledDetailConfirm=true;$scope.disabledDetailCancelConfirm=false}else{$scope.disabledDetailConfirm=false;$scope.disabledDetailCancelConfirm=true}if(diffTransfer==true)$scope.disabledDetailTransfer=
true;else if(transfer=="1")$scope.disabledDetailTransfer=true;else $scope.disabledDetailTransfer=$scope.disabledDetailCancelConfirm}};$scope.getReturnOrderMasterCount=function(){PsoOrderReturnMaster.getReturnOrderMasterCount(Constant.CONFIRM[1].value,Constant.STATUS[1].value,Constant.TRANSFER_PSO_FLAG[2].value,RES_UUID_MAP.PSO.ORDER_RETURN.RES_UUID).success(function(data){$scope.menuList[1].subList[7].suffix=data})}});
angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/orders",{controller:"OrdersController",templateUrl:"app/src/app/order/sales_slip/salesSlip.html"})}]);
angular.module("IOne-Production").controller("OrdersController",function($scope,$q,$window,OrderMaster,OrderDetail,OrderExtendDetail,OrderExtendDetail2,ReceiptDetail,OrderItemCustomDetail,OrderCustomScope,$mdDialog,$timeout,Constant,SaleTypes,Parameters){$scope.orderListMenu={select:{confirm:Constant.AUDIT[1].value,status:Constant.STATUS[1].value,transferPsoFlag:Constant.TRANSFER_PSO_FLAG[2].value,startDate:null,endDate:null},selectAll:false,effectiveType:"2",showQueryBar:true,"orderMasterNo":{display:true,
name:"产品销售单单号"},showPsoOrderMstNo:false};$scope.formMenuDisplayOption={"107-change":{display:true,name:"变更",uuid:"5DE0EF4C-B930-4142-A0A0-7F3CB8F613F9"},"108-changehistory":{display:true,name:"变更记录查询",uuid:"2DFA0414-5182-49DA-874E-6E296DA45E38"},"410-selectAll":{display:false,name:"全选",uuid:"B111653E-10C8-4250-98DC-3802752641E0"},"411-audit":{display:true,name:"审核",uuid:"93052560-2E65-4310-8B23-B9749667D5F0"},"412-return":{display:true,name:"退回",uuid:"0621DC29-117D-4366-9E44-E0ADF18B83A6"},"413-throw":{display:true,
name:"抛转预订单",uuid:"A14299FB-B094-4EE2-8D03-6605B532385F"},"414-effective":{display:true,name:"失效作废",uuid:"3AAA3FC1-E0B9-44B1-8E08-F646E15B61DC"},"416-revertAudit":{display:true,name:"取消审核",uuid:"D7CCBC12-4B71-44A4-A269-CC4125458F02"},"417-print":{display:true,name:"打印",uuid:"31964B09-78B1-4C27-A2CD-DC0837E746B8"},"418-oneOffSync":{display:true,name:"一键抛转",uuid:"71E103D7-D859-401F-8F0C-6154234AD4F0"},"419-rollbackTransfer":{display:true,name:"抛转还原",uuid:"D7A760B7-576F-41AD-938A-E4FFAD2D1012"}};$scope.orderListMenuDisplayOption=
{"400-selectAll":{display:true,name:"全选",uuid:"8106C59A-2096-4C5D-AFD0-B6CA49B9DA6D"},"401-audit":{display:true,name:"审核",uuid:"29203E56-301A-4ACC-85D2-A66566839D82"},"402-return":{display:true,name:"退回",uuid:"919BF746-A198-46F5-8B86-113C04B3F674"},"403-throw":{display:true,name:"抛转预订单",uuid:"85425E68-180D-4ED7-A808-A03DE95E3B31"},"404-effective":{display:true,name:"失效作废",uuid:"AA2AC2B0-D88B-4F66-B07F-CCAC1765B034"},"405-query":{display:true,name:"查询",uuid:"30B731D9-180C-4846-BA14-9FB614DD41B9"},
"406-revertAudit":{display:true,name:"取消审核",uuid:"6E7EABF4-69FD-4C37-91C2-7BDDCD7164A6"},"407-oneOffSync":{display:true,name:"一键抛转",uuid:"8ee02864-f13f-4323-bf4c-914720f325aa"},"409-rollbackTransfer":{display:true,name:"抛转还原",uuid:"F00E4D66-111D-457E-AD69-F4B215A4CE5F"}};$scope.itemOperationMenuDisplayOption={"500-item-edit":{display:true,name:""},"501-item-delete":{display:true,name:""}};$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.printAction=function(){Parameters.getAll($scope.selectedItem.channel.uuid).success(function(data){if(data.content&&
data.content.length>0)if($scope.selectedItem.paidRate.substring(0,$scope.selectedItem.paidRate.length-1)/100>=data.content[0].depositRate)OrderMaster.print("sale_order_reports",$scope.selectedItem.uuid).success(function(response){$window.open(response.content)}).error(function(){$scope.showError("获取打印信息失败。")});else $scope.showError("该订单订金不足，无法打印，请继续收款或改为意向单。")})};$scope.oneOffSync=function(){var mstList=[];var uuidList=[];if($scope.selectedItem){if($scope.selectedItem.confirm!=Constant.CONFIRM[2].value){$scope.showWarn("产品销售单"+
$scope.selectedItem.no+"未审核。");return}mstList.push($scope.selectedItem);uuidList.push($scope.selectedItem.uuid)}else angular.forEach($scope.selected,function(orderMaster){if(orderMaster.confirm!=Constant.CONFIRM[2].value){$scope.showWarn("产品销售单"+orderMaster.no+"未审核。");return}mstList.push(orderMaster);uuidList.push(orderMaster.uuid)});if(uuidList.length>0)OrderMaster.oneOffSync(uuidList.join(","),{}).success(function(response){if(response)angular.forEach(response,function(item){if(item.code==0)$scope.showInfo("一键同步成功。");
else if(item.code==1){if(item["lastResult"]&&item["lastResult"]["code"]==0)$scope.showWarn("销售单抛转成功， 预订单已经存在。")}else if(item["lastResult"]&&item["lastResult"]["code"]==0)$scope.showWarn("销售单抛转成功， 预订单抛转失败。");$scope.queryMenuActionWithPaging()})}).error(function(response){$scope.showError(response.message)});else $scope.showWarn("请选择待抛转销售单。")};$scope.editItem=function(orderMaster){$scope.toggle(orderMaster,$scope.selected);$scope.selectedDetail=[];$scope.orderListMenu.selectAll=false;$scope.selectedItem=
orderMaster;$scope.selectedItem.discountRate=(Math.round($scope.selectedItem.discountRate*1E4)/100).toFixed(2)+"%";$scope.selectedItem.orderDiscountRate=(Math.round($scope.selectedItem.orderDiscountRate*1E4)/100).toFixed(2)+"%";$scope.selectedItem.paidRate=(Math.round($scope.selectedItem.paidRate*1E4)/100).toFixed(2)+"%";$scope.changeViewStatus(Constant.UI_STATUS.PRE_EDIT_UI_STATUS,1);$scope.resetButtonDisabled();$scope.item_edit_disabled=0;$scope.orderListMenu.effectiveType=orderMaster.status;if(!(orderMaster.confirm==
1&&orderMaster.status==1))$scope.item_edit_disabled=1;OrderDetail.get(orderMaster.uuid).success(function(data){$scope.OrderDetailList=data;angular.forEach($scope.OrderDetailList.content,function(item){var idx=$scope.selectedDetail.indexOf(item);if(idx<0)$scope.selectedDetail.push(item)});$scope.changeButtonStatuOnly();$scope.updateOrderDetaiDeliverDate($scope.OrderDetailList);$scope.OrderExtendDetailList=[];angular.forEach($scope.OrderDetailList.content,function(orderDetail,index){OrderExtendDetail.get(orderMaster.uuid,
orderDetail.uuid).success(function(data){$scope.OrderExtendDetailList=$scope.OrderExtendDetailList.concat(data.content)})})});SaleTypes.getAll().success(function(data){$scope.saleTypes=data})};$scope.listTabSelected=function(){$scope.orderListMenu.showQueryBar=true;$scope.orderListMenuDisplayOption["400-selectAll"].display=true;$scope.queryMenuActionWithPaging();$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS,0);$scope.allCustomsScopes=null;$scope.orderExtendDetail2List=null;$scope.selectedItemCustoms=
null;$scope.changeSubTabIndexs(0);$scope.getMenuAuthData($scope.RES_UUID_MAP.PSO.ORDER.LIST_PAGE.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)});$scope.selectedDetail=[];$scope.OrderDetailList=null};$scope.formTabSelected=function(){$scope.orderListMenu.showQueryBar=false;$scope.getMenuAuthData($scope.RES_UUID_MAP.PSO.ORDER.FORM_PAGE.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)})};$scope.prodInfoTabSelected=function(){$scope.changeSubTabIndexs(0);
$scope.allCustomsScopes=null;$scope.orderExtendDetail2List=null;$scope.selectedItemCustoms=null;OrderDetail.get($scope.selectedItem.uuid).success(function(data){$scope.OrderDetailList=data;$scope.updateOrderDetaiDeliverDate($scope.OrderDetailList)})};$scope.deliverInfoTabSelected=function(){$scope.changeSubTabIndexs(1);$scope.allCustomsScopes=null;$scope.orderExtendDetail2List=null;$scope.selectedItemCustoms=null};$scope.receiptInfoTabSelected=function(){$scope.changeSubTabIndexs(3);$scope.allCustomsScopes=
null;$scope.orderExtendDetail2List=null;$scope.selectedItemCustoms=null;ReceiptDetail.get($scope.selectedItem.uuid).success(function(data){$scope.ReceiptOrderDetailList=data;angular.forEach($scope.ReceiptOrderDetailList.content,function(receiptOrderDetail){if(null!=receiptOrderDetail.payOrder)receiptOrderDetail.payOrder=$scope.getImageFullPath(receiptOrderDetail.payOrder)})})};$scope.customTabSelected=function(){$scope.changeSubTabIndexs(2)};$scope.selected=[];$scope.selectedItemsCount=0;$scope.selectedItemsTotalPrice=
0;$scope.toggle=function(item,selected){var idx=selected.indexOf(item);if(idx>-1)selected.splice(idx,1);else selected.push(item);$scope.orderListMenu.effectiveType=item.status;$scope.resetInitialValue();$scope.changeButtonStatusAndCalTotalPrice();$scope.selectedItemsTotalPrice=$scope.selectedItemsTotalPrice.toFixed(2);$scope.selectedItemsCount=selected.length};$scope.changeButtonStatusAndCalTotalPrice=function(){var firstLoop=true;angular.forEach($scope.selected,function(orderMaster){$scope.selectedItemsTotalPrice=
$scope.selectedItemsTotalPrice+orderMaster.orderAmount;if(firstLoop){firstLoop=false;$scope.orderListMenu.effectiveType=orderMaster.status;$scope.firstOrderMasterStatus=orderMaster.status}else if($scope.firstOrderMasterStatus!==orderMaster.status)$scope.effectiveType_disabled=1;$scope.changeButtonStatus(orderMaster)})};$scope.changeButtonStatus=function(orderMaster){if(orderMaster.confirm==2||orderMaster.confirm==3)$scope.effectiveType_disabled=1;if(orderMaster.confirm==2||orderMaster.confirm==4)$scope.return_button_disabled=
1;if(orderMaster.confirm==2||orderMaster.confirm==4)$scope.audit_button_disabled=1;if(!(orderMaster.confirm==2&&orderMaster.transferPsoFlag!=1))$scope.throw_button_disabled=1;if(!(orderMaster.confirm==2&&orderMaster.transferPsoFlag!=1))$scope.revert_audit_button_disabled=1;if(!(orderMaster.confirm==2&&orderMaster.transferPsoFlag==1))$scope.rollback_transfer_button_disabled=1};$scope.exists=function(item,list){return list.indexOf(item)>-1};$scope.selectedDetail=[];$scope.toggleDetail=function(item,
selectedDetail){var idx=selectedDetail.indexOf(item);if(idx>-1)selectedDetail.splice(idx,1);else selectedDetail.push(item);$scope.orderListMenu.effectiveType=item.status;$scope.resetButtonDisabled();$scope.changeButtonStatuOnly()};$scope.changeButtonStatuOnly=function(){var firstLoop=true;angular.forEach($scope.selectedDetail,function(orderDetail){if(firstLoop){firstLoop=false;$scope.orderListMenu.effectiveType=orderDetail.status;$scope.firstOrderDetailStatus=orderDetail.status}else if($scope.firstOrderDetailStatus!==
orderDetail.status)$scope.effectiveType_disabled=1;$scope.changeButtonStatus(orderDetail)})};$scope.selectAllMenuAction=function(){if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1)if($scope.orderListMenu.selectAll==true){angular.forEach($scope.OrderDetailList.content,function(item){var idx=$scope.selectedDetail.indexOf(item);if(idx<0)$scope.selectedDetail.push(item)});$scope.resetButtonDisabled();$scope.changeButtonStatuOnly()}else{if($scope.orderListMenu.selectAll==
false){$scope.selectedDetail=[];$scope.orderListMenu.effectiveType="1";$scope.resetButtonDisabled()}}else if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0)if($scope.orderListMenu.selectAll==true){angular.forEach($scope.OrderMasterList.content,function(item){var idx=$scope.selected.indexOf(item);if(idx<0)$scope.selected.push(item)});$scope.resetInitialValue();$scope.changeButtonStatusAndCalTotalPrice();$scope.selectedItemsTotalPrice=$scope.selectedItemsTotalPrice.toFixed(2);
$scope.selectedItemsCount=$scope.selected.length}else if($scope.orderListMenu.selectAll==false){$scope.selected=[];$scope.orderListMenu.effectiveType="1";$scope.resetInitialValue()}};$scope.refreshMasterAndDetail=function(){OrderMaster.get($scope.selectedItem.uuid).success(function(data){$scope.selectedItem=data;$scope.selectedItem.discountRate=(Math.round($scope.selectedItem.discountRate*1E4)/100).toFixed(2)+"%";$scope.selectedItem.orderDiscountRate=(Math.round($scope.selectedItem.orderDiscountRate*
1E4)/100).toFixed(2)+"%";$scope.selectedItem.paidRate=(Math.round($scope.selectedItem.paidRate*1E4)/100).toFixed(2)+"%";$scope.updateOrderMaster($scope.selectedItem);$scope.selectedDetail=[];$scope.orderListMenu.selectAll=false;$scope.resetButtonDisabled();$scope.changeButtonStatus($scope.selectedItem);$scope.orderListMenu.effectiveType=data.status;OrderDetail.get($scope.selectedItem.uuid).success(function(data){$scope.OrderDetailList=data;angular.forEach($scope.OrderDetailList.content,function(item){var idx=
$scope.selectedDetail.indexOf(item);if(idx<0)$scope.selectedDetail.push(item)});$scope.updateOrderDetaiDeliverDate($scope.OrderDetailList)})})};$scope.effectiveMenuAction=function(){if($scope.selected.length>0||$scope.selectedDetail.length>0)$scope.showConfirm("确认修改启用状态吗？","",function(){if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){var promises=[];angular.forEach($scope.selectedDetail,function(item){var OrderDetailUpdateInput={status:$scope.orderListMenu.effectiveType};
var response=OrderDetail.modify($scope.selectedItem.uuid,item.uuid,OrderDetailUpdateInput).success(function(){});promises.push(response)});$q.all(promises).then(function(){$scope.selectedItem.status=$scope.orderListMenu.effectiveType;$scope.refreshMasterAndDetail();OrderMaster.getOrderMasterCount(Constant.AUDIT[1].value,Constant.STATUS[1].value,Constant.TRANSFER_PSO_FLAG[2].value,RES_UUID_MAP.PSO.ORDER.LIST_PAGE.RES_UUID).success(function(data){$scope.menuList[1].subList[1].suffix=data});$scope.showInfo("修改数据成功。")})}else if($scope.ui_status==
Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){var promises=[];angular.forEach($scope.selected,function(item){var OrderMasterUpdateInput={uuid:item.uuid,status:$scope.orderListMenu.effectiveType};var response=OrderMaster.modify(OrderMasterUpdateInput).success(function(){});promises.push(response)});$q.all(promises).then(function(data){$scope.queryMenuActionWithPaging();$scope.showInfo("修改数据成功。")})}})};$scope.auditMenuAction=function(){if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&
$scope.selectedTabIndex==0){var errorNos="";angular.forEach($scope.selected,function(item){if(item.contractNo==""||item.contractNo==null||item.contractNo==undefined)errorNos=errorNos+item.no+"\x3cbr\x3e"});if(errorNos!=""){errorNos=errorNos.substr(0,errorNos.length-1);$scope.showError("以下产品销售单合同号为空："+"\x3cbr\x3e"+errorNos);return}}if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1)if($scope.selectedItem.contractNo==""||$scope.selectedItem.contractNo==null||$scope.selectedItem.contractNo==
undefined){$scope.showError("该产品销售单合同号为空，不允许审核。");return}if($scope.selected.length>0||$scope.selectedDetail.length>0){var mainPromises=[];console.log($scope.selected);if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){var errorInfo="";angular.forEach($scope.selected,function(item){console.log("before paidrate:"+item.paidRate);var response=Parameters.getAll(item.channel.uuid).success(function(data){console.log(data);if(data.content&&data.content.length>0){var itemDepositRate=
data.content[0].depositRate;if(item.paidRate<itemDepositRate)errorInfo=errorInfo+"订单："+item.no+"的收款比率\x3c"+itemDepositRate*100+"%\x3cbr\x3e"}});mainPromises.push(response)})}else if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){var mainPromises=[];var errorInfo="";var paidRate=$scope.selectedItem.paidRate.substring(0,$scope.selectedItem.paidRate.length-1);var response=Parameters.getAll($scope.selectedItem.channel.uuid).success(function(data){var itemDepositRate=
data.content[0].depositRate*100;if(paidRate<itemDepositRate)errorInfo=errorInfo+"订单："+$scope.selectedItem.no+"的收款比率\x3c"+itemDepositRate+"%\x3cbr\x3e"});mainPromises.push(response);console.log(mainPromises)}$q.all(mainPromises).then(function(){$scope.showConfirm("确认审核吗？",errorInfo,function(){if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){var promises=[];angular.forEach($scope.selectedDetail,function(item){var OrderDetailUpdateInput={confirm:"2"};var response=
OrderDetail.modify($scope.selectedItem.uuid,item.uuid,OrderDetailUpdateInput).success(function(){});promises.push(response)});$q.all(promises).then(function(){var OrderMasterUpdateInput={uuid:$scope.selectedItem.uuid,confirm:"2"};var response=OrderMaster.modify(OrderMasterUpdateInput).success(function(){$scope.selectedItem.confirm="2";$scope.refreshMasterAndDetail();OrderMaster.getOrderMasterCount(Constant.AUDIT[1].value,Constant.STATUS[1].value,Constant.TRANSFER_PSO_FLAG[2].value,RES_UUID_MAP.PSO.ORDER.LIST_PAGE.RES_UUID).success(function(data){$scope.menuList[1].subList[1].suffix=
data});$scope.showInfo("修改数据成功。")})})}else if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){var promises=[];angular.forEach($scope.selected,function(item){var OrderMasterUpdateInput={uuid:item.uuid,confirm:"2"};var response=OrderMaster.modify(OrderMasterUpdateInput).success(function(){});promises.push(response)});$q.all(promises).then(function(data){angular.forEach($scope.selected,function(item){item.confirm="2"});$scope.resetInitialValue();$scope.changeButtonStatusAndCalTotalPrice();
$scope.selectedItemsTotalPrice=$scope.selectedItemsTotalPrice.toFixed(2);$scope.selectedItemsCount=$scope.selected.length;$scope.showInfo("修改数据成功。")})}})})}};$scope.returnMenuAction=function(){if($scope.selected.length>0||$scope.selectedDetail.length>0)$scope.showConfirm("确认退回吗？","",function(){if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){var promises=[];angular.forEach($scope.selectedDetail,function(item){var OrderDetailUpdateInput={confirm:"4"};var response=
OrderDetail.modify($scope.selectedItem.uuid,item.uuid,OrderDetailUpdateInput).success(function(){});promises.push(response)});$q.all(promises).then(function(){$scope.selectedItem.confirm="4";$scope.refreshMasterAndDetail();OrderMaster.getOrderMasterCount(Constant.AUDIT[1].value,Constant.STATUS[1].value,Constant.TRANSFER_PSO_FLAG[2].value,RES_UUID_MAP.PSO.ORDER.LIST_PAGE.RES_UUID).success(function(data){$scope.menuList[1].subList[1].suffix=data});$scope.showInfo("修改数据成功。")})}else if($scope.ui_status==
Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){var promises=[];angular.forEach($scope.selected,function(item){var OrderMasterUpdateInput={uuid:item.uuid,confirm:"4"};var response=OrderMaster.modify(OrderMasterUpdateInput).success(function(){});promises.push(response)});$q.all(promises).then(function(data){$scope.queryMenuActionWithPaging();$scope.showInfo("修改数据成功。")})}})};$scope.throwMenuAction=function(){if($scope.selected.length>0||$scope.selectedItem.length>0)$scope.showConfirm("确认抛转吗？",
"",function(){if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){var OrderMasterUpdateInput={uuid:$scope.selectedItem.uuid,transferPsoFlag:"1"};OrderMaster.modifyBatch(OrderMasterUpdateInput).success(function(){$scope.selectedItem.transferPsoFlag=Constant.TRANSFER_PSO_FLAG[1].value;$scope.refreshMasterAndDetail();$scope.showInfo("修改数据成功。")}).error(function(data){$scope.showError(data.message)})}else if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==
0){var orderMasterUuids="";angular.forEach($scope.selected,function(item){orderMasterUuids=orderMasterUuids+item.uuid+","});var OrderMasterUpdateInput={uuid:orderMasterUuids,transferPsoFlag:"1"};var response=OrderMaster.modifyBatch(OrderMasterUpdateInput).success(function(){$scope.queryMenuActionWithPaging();$scope.showInfo("修改数据成功。")}).error(function(data){$scope.showError(data.message)})}})};$scope.rollbackTransfer=function(){if($scope.selected.length>0||$scope.selectedItem.length>0)$scope.showConfirm("确认抛转还原吗？",
"",function(){if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){var OrderMasterUpdateInput={uuid:$scope.selectedItem.uuid,transferPsoFlag:"2"};OrderMaster.modifyBatch(OrderMasterUpdateInput).success(function(){$scope.selectedItem.transferPsoFlag=Constant.TRANSFER_PSO_FLAG[2].value;$scope.refreshMasterAndDetail();$scope.showInfo("修改数据成功。")}).error(function(data){$scope.showError(data.message)})}else if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==
0){var orderMasterUuids="";angular.forEach($scope.selected,function(item){orderMasterUuids=orderMasterUuids+item.uuid+","});var OrderMasterUpdateInput={uuid:orderMasterUuids,transferPsoFlag:"2"};var response=OrderMaster.modifyBatch(OrderMasterUpdateInput).success(function(){$scope.queryMenuActionWithPaging();$scope.showInfo("修改数据成功。")}).error(function(data){$scope.showError(data.message)})}})};$scope.revertAuditMenuAction=function(){if($scope.selected.length>0||$scope.selectedDetail.length>0)$scope.showConfirm("确认取消审核吗？",
"",function(){if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){var promises=[];angular.forEach($scope.selectedDetail,function(item){var OrderDetailUpdateInput={confirm:"1"};var response=OrderDetail.modify($scope.selectedItem.uuid,item.uuid,OrderDetailUpdateInput).success(function(){});promises.push(response)});$q.all(promises).then(function(){$scope.selectedItem.confirm="1";$scope.refreshMasterAndDetail();OrderMaster.getOrderMasterCount(Constant.AUDIT[1].value,
Constant.STATUS[1].value,Constant.TRANSFER_PSO_FLAG[2].value,RES_UUID_MAP.PSO.ORDER.LIST_PAGE.RES_UUID).success(function(data){$scope.menuList[1].subList[1].suffix=data});$scope.showInfo("修改数据成功。")})}else if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){var promises=[];angular.forEach($scope.selected,function(item){var OrderMasterUpdateInput={uuid:item.uuid,confirm:"1"};var response=OrderMaster.modify(OrderMasterUpdateInput).success(function(){});promises.push(response)});
$q.all(promises).then(function(data){angular.forEach($scope.selected,function(item){item.confirm="1"});$scope.resetInitialValue();$scope.changeButtonStatusAndCalTotalPrice();$scope.selectedItemsTotalPrice=$scope.selectedItemsTotalPrice.toFixed(2);$scope.selectedItemsCount=$scope.selected.length;$scope.showInfo("修改数据成功。")})}})};$scope.resetInitialValue=function(){$scope.selectedItem=null;$scope.selectedItemsCount=0;$scope.selectedItemsTotalPrice=0;$scope.resetButtonDisabled()};$scope.resetButtonDisabled=
function(){$scope.effectiveType_disabled=0;$scope.return_button_disabled=0;$scope.audit_button_disabled=0;$scope.throw_button_disabled=0;$scope.revert_audit_button_disabled=0;$scope.rollback_transfer_button_disabled=0};$scope.queryMenuAction=function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=100;$scope.pageOption.totalElements=100;$scope.queryMenuActionWithPaging()};$scope.queryMenuActionWithPaging=function(){$scope.selectedItem=null;$scope.selected=[];$scope.selectedItemsCount=
0;$scope.selectedItemsTotalPrice=0;$scope.orderListMenu.selectAll=false;$scope.orderListMenu.effectiveType="2";$scope.resetInitialValue();if($scope.orderListMenu.select.startDate!==undefined)if($scope.orderListMenu.select.startDate!==null){orderDateBegin=new Date($scope.orderListMenu.select.startDate);orderDateBegin=moment(orderDateBegin).format("YYYY-MM-DD")}else orderDateBegin=null;else orderDateBegin=null;if($scope.orderListMenu.select.endDate!==undefined)if($scope.orderListMenu.select.endDate!==
null){orderDateEnd=new Date($scope.orderListMenu.select.endDate);orderDateEnd=moment(orderDateEnd).format("YYYY-MM-DD")}else orderDateEnd=null;else orderDateEnd=null;if($scope.orderListMenu.orderId!==undefined)orderMasterNo=$scope.orderListMenu.orderId;else orderMasterNo=null;if($scope.orderListMenu.clientName!==undefined)customerName=$scope.orderListMenu.clientName;else customerName=null;if($scope.orderListMenu.employeeName!==undefined)employeeName=$scope.orderListMenu.employeeName;else employeeName=
null;if($scope.orderListMenu.contractNo!==undefined)contractNo=$scope.orderListMenu.contractNo;else contractNo=null;confirm=$scope.orderListMenu.select.confirm;status=$scope.orderListMenu.select.status;transferPsoFlag=$scope.orderListMenu.select.transferPsoFlag;OrderMaster.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,confirm,status,transferPsoFlag,orderMasterNo,customerName,employeeName,orderDateBegin,orderDateEnd,RES_UUID_MAP.PSO.ORDER.LIST_PAGE.RES_UUID,null,null,null,null,
null,null,contractNo).success(function(data){$scope.OrderMasterList=data;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;$scope.getOrderDetailCountByMasterUuid();OrderMaster.getOrderMasterCount(Constant.AUDIT[1].value,Constant.STATUS[1].value,Constant.TRANSFER_PSO_FLAG[2].value,RES_UUID_MAP.PSO.ORDER.LIST_PAGE.RES_UUID).success(function(data){$scope.menuList[1].subList[1].suffix=data})})};$scope.$watch("orderListMenu.select",function(){$scope.pageOption.currentPage=
0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.queryMenuAction()},true);$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.queryMenuAction()}};$scope.getOrderDetailCountByMasterUuid=function(){var orderMasterUuids="";angular.forEach($scope.OrderMasterList.content,function(orderMaster){$scope.updateOrderMaster(orderMaster);orderMasterUuids=orderMasterUuids+orderMaster.uuid+
","});OrderDetail.getAllCountByMasterUuids(orderMasterUuids).success(function(data){var map=[];angular.forEach(data,function(orderMasterWithCount){map[orderMasterWithCount.uuid]=orderMasterWithCount.detailCount});angular.forEach($scope.OrderMasterList.content,function(orderMaster){if(undefined!=map[orderMaster.uuid])orderMaster.orderDetailCount=map[orderMaster.uuid];else orderMaster.orderDetailCount=0})})};$scope.modifyMenuAction=function(){if($scope.selectedItem)OrderMaster.modify($scope.selectedItem).success(function(){$scope.showInfo("修改商品数据成功。")})};
$scope.cancelModifyMenuAction=function(){OrderMaster.get($scope.selectedItem.uuid).success(function(data){$scope.selectedItem=data})};$scope.exitModifyMenuAction=function(){$scope.cancelModifyMenuAction();$scope.changeViewStatus($scope.UI_STATUS.PRE_EDIT_UI_STATUS,1)};$scope.preAddMenuAction=function(){$scope.selectedItem={stopProductionFlag:"N",type:"1"};$scope.selectedItemPics=[];$scope.selectedItemBoms={};$scope.selectedItemCustoms={};$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_ADD,
1)};$scope.addMenuAction=function(){if($scope.selectedItem)OrderMaster.add($scope.selectedItem).success(function(data){$scope.selectedItem=data;$scope.changeViewStatus($scope.UI_STATUS.PRE_EDIT_UI_STATUS,1);$scope.showInfo("新增商品成功。")})};$scope.cancelAddMenuAction=function(){$scope.listTabSelected()};$scope.deleteMenuAction=function(){$scope.showConfirm("确认删除吗？","删除的商品不可恢复。",function(){if($scope.selectedItem)OrderMaster.delete($scope.selectedItem.uuid).success(function(){$scope.showInfo("删除成功。");$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_DELETE,
0)})})};$scope.itemDeleteMenuAction=function(item){$scope.showConfirm("确认删除吗？","删除的商品不可恢复。",function(){if($scope.item)OrderMaster.delete($scope.item.uuid1).success(function(){$scope.showInfo("删除成功。");$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_DELETE,0)})})};$scope.changeMenuAction=function(){};$scope.changeHistoryMenuAction=function(){};$scope.orderDetailEditMenuAction=function(orderDetail){$mdDialog.show({controller:"OrderDetailController",templateUrl:"app/src/app/order/sales_slip/orderDetailEditDlg.html",
parent:angular.element(document.body),targetEvent:event,locals:{selectedOrderDetail:orderDetail,saleTypes:$scope.saleTypes}}).then(function(data){OrderDetail.modify(data.selectedOrderDetail.orderMaster.uuid,data.selectedOrderDetail.uuid,data.selectedOrderDetail).success(function(){OrderDetail.get(data.selectedOrderDetail.orderMaster.uuid).success(function(data){$scope.OrderDetailList=data;$scope.updateOrderDetaiDeliverDate($scope.OrderDetailList)});$scope.showInfo("修改成功。")})})};$scope.updateOrderDetaiDeliverDate=
function(OrderDetailList){angular.forEach(OrderDetailList.content,function(orderDetail){if(orderDetail.deliverDate!=null)orderDetail.deliverDate=moment(orderDetail.deliverDate).format("YYYY-MM-DD");if(orderDetail.originalDeliverDate!=null)orderDetail.originalDeliverDate=moment(orderDetail.originalDeliverDate).format("YYYY-MM-DD")})};$scope.updateOrderMaster=function(orderMaster){if(orderMaster.deliverDate!=null)orderMaster.deliverDate=moment(orderMaster.deliverDate).format("YYYY-MM-DD")};$scope.orderExtendDetailEditMenuAction=
function(orderExtendDetail){$mdDialog.show({controller:"OrderExtendDetailController",templateUrl:"app/src/app/order/sales_slip/orderExtendDetailEditDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{selectedOrderExtendDetail:orderExtendDetail}}).then(function(data){OrderExtendDetail.modify(data.selectedOrderExtendDetail.orderDetail.orderMaster.uuid,data.selectedOrderExtendDetail.orderDetail.uuid,data.selectedOrderExtendDetail.uuid,data.selectedOrderExtendDetail).success(function(){OrderDetail.get(data.selectedOrderExtendDetail.orderDetail.orderMaster.uuid,
data.selectedOrderExtendDetail.orderDetail.uuid).success(function(data){$scope.OrderDetailList=data;$scope.updateOrderDetaiDeliverDate($scope.OrderDetailList);$scope.OrderExtendDetailList=[];angular.forEach($scope.OrderDetailList.content,function(orderDetail,index){OrderExtendDetail.get(orderDetail.orderMaster.uuid,orderDetail.uuid).success(function(data){$scope.OrderExtendDetailList=$scope.OrderExtendDetailList.concat(data.content)})});$scope.showInfo("修改成功。")})})})};$scope.editItemCustom=function(orderExtendDetail){$scope.selectedOrderExtendDetail=
orderExtendDetail;$scope.changeSubTabIndexs(2);OrderItemCustomDetail.getCustomDetail(orderExtendDetail.item.uuid).success(function(data){$scope.allCustomsScopes={};$scope.selectedItemCustoms=data;angular.forEach($scope.selectedItemCustoms.content,function(value){value.informationUuids=JSON.parse(value.information)});angular.forEach($scope.selectedItemCustoms.content,function(itemCustomDetail){angular.forEach(itemCustomDetail.informationUuids,function(informationUuid){OrderCustomScope.getCustomScope(itemCustomDetail.itemCustom.uuid,
informationUuid).success(function(data){if(data.brand!=null&&orderExtendDetail.item.brand!=null&&orderExtendDetail.item.brand.name!=data.brand.name);else if($scope.allCustomsScopes[itemCustomDetail.itemCustom.uuid]==undefined){var value={};value[data.uuid]=data;$scope.allCustomsScopes[itemCustomDetail.itemCustom.uuid]=value}else{var value=$scope.allCustomsScopes[itemCustomDetail.itemCustom.uuid];value[data.uuid]=data;$scope.allCustomsScopes[itemCustomDetail.itemCustom.uuid]=value}})})})});var masterUuid=
$scope.selectedOrderExtendDetail.orderDetail.orderMaster.uuid;var detailUuid=$scope.selectedOrderExtendDetail.orderDetail.uuid;var orderExtendDetailUuid=$scope.selectedOrderExtendDetail.uuid;OrderExtendDetail2.get(masterUuid,detailUuid,orderExtendDetailUuid).success(function(data){$scope.orderExtendDetail2List=data;angular.forEach($scope.orderExtendDetail2List.content,function(value){value.informationUuids=JSON.parse(value.information)})})};$scope.openAddCustomDlg=function(){$mdDialog.show({controller:"OrderExtendDetail2Controller",
templateUrl:"app/src/app/order/sales_slip/addCustomDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{allCustomsScopes:$scope.allCustomsScopes,custom:null,allCustoms:$scope.selectedItemCustoms,op:"add"}}).then(function(data){var OrderExtendDetail2Input={orderExtendDetailUuid:$scope.selectedOrderExtendDetail.uuid,no:Math.random().toString(36).substring(10),itemUuid:$scope.selectedOrderExtendDetail.item.uuid,itemCustomUuid:data.selectedCustom.itemCustom.uuid,information:data.selectedCustom.information};
var masterUuid=$scope.selectedOrderExtendDetail.orderDetail.orderMaster.uuid;var detailUuid=$scope.selectedOrderExtendDetail.orderDetail.uuid;var orderExtendDetailUuid=$scope.selectedOrderExtendDetail.uuid;OrderExtendDetail2.add(masterUuid,detailUuid,orderExtendDetailUuid,OrderExtendDetail2Input).success(function(response){response.informationUuids=data.selectedCustom.informationUuids;$scope.orderExtendDetail2List.content.push(response);$scope.OrderExtendDetailList=[];angular.forEach($scope.OrderDetailList.content,
function(orderDetail,index){OrderExtendDetail.get(orderDetail.orderMaster.uuid,orderDetail.uuid).success(function(data){$scope.OrderExtendDetailList=$scope.OrderExtendDetailList.concat(data.content)})});$scope.showInfo("新增自定义信息成功。")})})};$scope.openEditCustomDlg=function(custom){$mdDialog.show({controller:"OrderExtendDetail2Controller",templateUrl:"app/src/app/order/sales_slip/addCustomDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{allCustoms:$scope.selectedItemCustoms,
allCustomsScopes:$scope.allCustomsScopes,custom:custom,op:"modify"}}).then(function(data){var masterUuid=$scope.selectedOrderExtendDetail.orderDetail.orderMaster.uuid;var detailUuid=$scope.selectedOrderExtendDetail.orderDetail.uuid;var orderExtendDetailUuid=$scope.selectedOrderExtendDetail.uuid;var OrderExtendDetail2UpdateInput={itemCustomUuid:data.selectedCustom.itemCustom.uuid,information:data.selectedCustom.information};OrderExtendDetail2.modify(masterUuid,detailUuid,orderExtendDetailUuid,custom.uuid,
OrderExtendDetail2UpdateInput).success(function(){$scope.OrderExtendDetailList=[];angular.forEach($scope.OrderDetailList.content,function(orderDetail,index){OrderExtendDetail.get(orderDetail.orderMaster.uuid,orderDetail.uuid).success(function(data){$scope.OrderExtendDetailList=$scope.OrderExtendDetailList.concat(data.content)})});$scope.showInfo("修改自定义信息成功。")})})};$scope.deleteItemCustom=function(deletedOrderExtendDetail2){$scope.showConfirm("确认删除吗？","删除的自定义信息不可恢复。",function(){if(deletedOrderExtendDetail2){var masterUuid=
$scope.selectedOrderExtendDetail.orderDetail.orderMaster.uuid;var detailUuid=$scope.selectedOrderExtendDetail.orderDetail.uuid;var orderExtendDetailUuid=$scope.selectedOrderExtendDetail.uuid;OrderExtendDetail2.delete(masterUuid,detailUuid,orderExtendDetailUuid,deletedOrderExtendDetail2.uuid).success(function(){angular.forEach($scope.orderExtendDetail2List.content,function(item,index){if(deletedOrderExtendDetail2==item)$scope.orderExtendDetail2List.content.splice(index,1)});$scope.OrderExtendDetailList=
[];angular.forEach($scope.OrderDetailList.content,function(orderDetail,index){OrderExtendDetail.get(orderDetail.orderMaster.uuid,orderDetail.uuid).success(function(data){$scope.OrderExtendDetailList=$scope.OrderExtendDetailList.concat(data.content)})});$scope.showInfo("删除成功。")})}})}});
angular.module("IOne-Production").controller("OrderExtendDetail2Controller",function($scope,$mdDialog,allCustoms,allCustomsScopes,custom,op){$scope.allCustoms=allCustoms.content;$scope.allCustomsScopes=allCustomsScopes;$scope.selectedCustom=custom;$scope.op=op;if($scope.selectedCustom)angular.forEach($scope.selectedCustom.informationUuids,function(value,index){angular.forEach($scope.allCustomsScopes[$scope.selectedCustom.itemCustom.uuid],function(item){if(item.uuid==value)item.checked=true})});else $scope.selectedCustom=
{informationUuids:[],itemCustom:{astrict:2}};$scope.backUpCustomScopes=function(custom){$scope.backUpInformationUuids=[];if(custom!=null&&custom.informationUuids!=null)angular.forEach(custom.informationUuids,function(value,index){$scope.backUpInformationUuids.push(value)})};$scope.backUpCustomScopes(custom);$scope.customChangeHandler=function(customUuid){angular.forEach($scope.allCustoms,function(value,index){if(value.itemCustom.uuid==customUuid)$scope.selectedCustom.itemCustom=value.itemCustom});
angular.forEach($scope.allCustomsScopes[$scope.selectedCustom.itemCustom.uuid],function(item){item.checked=false});angular.forEach($scope.selectedCustom.informationUuids,function(value,index){angular.forEach($scope.allCustomsScopes[$scope.selectedCustom.itemCustom.uuid],function(item){if(item.uuid==value)item.checked=true})});if($scope.selectedCustom.itemCustom.scopeUuid!=undefined)$scope.selectedCustom.itemCustom.scopeUuid=null};$scope.checkBoxChangeHandler=function(data,selected){if(selected==true)$scope.selectedCustom.informationUuids.push(data.uuid);
else angular.forEach($scope.selectedCustom.informationUuids,function(value,index){if(value==data.uuid)$scope.selectedCustom.informationUuids.splice(index,1)})};$scope.selectCustomScopeHandler=function(data,selected){$scope.selectedCustom.informationUuids.push(data.uuid)};$scope.clearCustomScope=function(){$scope.selectedCustom.informationUuids=[]};$scope.radioChangeHandler=function(){$scope.selectedCustom.informationUuids=[];$scope.selectedCustom.informationUuids.push($scope.selectedCustom.itemCustom.scopeUuid)};
$scope.hideDlg=function(){$scope.selectedCustom.information=JSON.stringify($scope.selectedCustom.informationUuids);$mdDialog.hide({"selectedCustom":$scope.selectedCustom})};$scope.cancelDlg=function(){$scope.selectedCustom.informationUuids=$scope.backUpInformationUuids;$mdDialog.cancel()}});
angular.module("IOne-Production").controller("OrderExtendDetailController",function($scope,$mdDialog,selectedOrderExtendDetail){$scope.selectedOrderExtendDetail=angular.copy(selectedOrderExtendDetail);$scope.hideDlg=function(){$mdDialog.hide({"selectedOrderExtendDetail":$scope.selectedOrderExtendDetail})};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").controller("OrderDetailController",function($scope,$mdDialog,selectedOrderDetail,saleTypes){$scope.selectedOrderDetail=angular.copy(selectedOrderDetail);$scope.saleTypes=saleTypes.content;$scope.hideDlg=function(){$mdDialog.hide({"selectedOrderDetail":$scope.selectedOrderDetail})};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").service("OrderMaster",function($http,Constant){this.getAll=function(sizePerPage,page,confirm,status,transferPsoFlag,orderMasterNo,customerName,employeeName,orderDateBegin,orderDateEnd,resUuid,channelUuid,orderAmount,paidAmount,unpaidAmount,paidType,paidType2,contractNo){confirm=confirm==0?"":confirm;status=status==0?"":status;transferPsoFlag=transferPsoFlag==0?"":transferPsoFlag;var url="/orders?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26confirm\x3d"+confirm+
"\x26status\x3d"+status+"\x26transferPsoFlag\x3d"+transferPsoFlag;if(orderMasterNo!=null)url=url+"\x26orderMasterNo\x3d"+orderMasterNo;if(customerName!=null)url=url+"\x26customerName\x3d"+customerName;if(employeeName!=null)url=url+"\x26employeeName\x3d"+employeeName;if(orderDateBegin!=null)url=url+"\x26orderDateBegin\x3d"+orderDateBegin;if(orderDateEnd!=null)url=url+"\x26orderDateEnd\x3d"+orderDateEnd;if(resUuid!=null)url=url+"\x26resUuid\x3d"+resUuid;if(channelUuid!=null)url=url+"\x26channelUuid\x3d"+
channelUuid;if(orderAmount!==undefined&&orderAmount!==null)url=url+"\x26orderAmount\x3d"+orderAmount;if(paidAmount!==undefined&&paidAmount!==null)url=url+"\x26paidAmount\x3d"+paidAmount;if(unpaidAmount!==undefined&&unpaidAmount!==null)url=url+"\x26unpaidAmount\x3d"+unpaidAmount;if(paidType!==undefined&&paidType!==null)url=url+"\x26paidType\x3d"+paidType;if(paidType2!==undefined&&paidType2!==null)url=url+"\x26paidType2\x3d"+paidType2;if(contractNo!==undefined&&contractNo!==null)url=url+"\x26contractNo\x3d"+
contractNo;return $http.get(Constant.BACKEND_BASE+url)};this.getOrderMasterCount=function(confirm,status,transferPsoFlag,resUuid){confirm=confirm==0?"":confirm;status=status==0?"":status;transferPsoFlag=transferPsoFlag==0?"":transferPsoFlag;var url="/orders/count?confirm\x3d"+confirm+"\x26status\x3d"+status+"\x26transferPsoFlag\x3d"+transferPsoFlag;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+
"/orders/"+uuid)};this.modify=function(OrderMasterUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/orders/"+OrderMasterUpdateInput.uuid,OrderMasterUpdateInput)};this.modifyBatch=function(OrderMasterUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/orders/"+OrderMasterUpdateInput.uuid+"/batch/",OrderMasterUpdateInput)};this.print=function(type,uuid){return $http.get(Constant.BACKEND_BASE+"/reports/",{params:{type:type,params:uuid}})};this.oneOffSync=function(uuid,OrderMasterUpdateInput){return $http.patch(Constant.BACKEND_BASE+
"/orders/"+uuid+"/sync",OrderMasterUpdateInput)}});
angular.module("IOne-Production").service("OrderDetail",function($http,Constant){this.get=function(masterUuid){return $http.get(Constant.BACKEND_BASE+"/orders/"+masterUuid+"/details")};this.modify=function(masterUuid,uuid,OrderDetailUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/orders/"+masterUuid+"/details/"+uuid,OrderDetailUpdateInput)};this.getAllCountByMasterUuids=function(orderMasterUuids){var url="orders/"+orderMasterUuids+"/count/";return $http.get(Constant.BACKEND_BASE+url)}});
angular.module("IOne-Production").service("OrderExtendDetail",function($http,Constant){this.get=function(masterUuid,detailUuid){return $http.get(Constant.BACKEND_BASE+"/orders/"+masterUuid+"/details/"+detailUuid+"/extends/")};this.modify=function(masterUuid,detailUuid,uuid,OrderExtendDetailUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/orders/"+masterUuid+"/details/"+detailUuid+"/extends/"+uuid,OrderExtendDetailUpdateInput)}});
angular.module("IOne-Production").service("OrderExtendDetail2",function($http,Constant){this.get=function(masterUuid,detailUuid,orderExtendDetailUuid){return $http.get(Constant.BACKEND_BASE+"/orders/"+masterUuid+"/details/"+detailUuid+"/extends/"+orderExtendDetailUuid+"/extend2s/")};this.modify=function(masterUuid,detailUuid,orderExtendDetailUuid,uuid,OrderExtendDetail2UpdateInput){return $http.patch(Constant.BACKEND_BASE+"/orders/"+masterUuid+"/details/"+detailUuid+"/extends/"+orderExtendDetailUuid+
"/extend2s/"+uuid,OrderExtendDetail2UpdateInput)};this.add=function(masterUuid,detailUuid,orderExtendDetailUuid,OrderExtendDetail2Input){return $http.post(Constant.BACKEND_BASE+"/orders/"+masterUuid+"/details/"+detailUuid+"/extends/"+orderExtendDetailUuid+"/extend2s/",OrderExtendDetail2Input)};this.delete=function(masterUuid,detailUuid,orderExtendDetailUuid,uuid){return $http.delete(Constant.BACKEND_BASE+"/orders/"+masterUuid+"/details/"+detailUuid+"/extends/"+orderExtendDetailUuid+"/extend2s/"+uuid)}});
angular.module("IOne-Production").service("OrderItemCustomDetail",function($http,Constant){this.getCustomDetail=function(itemUuid){return $http.get(Constant.BACKEND_BASE+"/items/"+itemUuid+"/customs")}});
angular.module("IOne-Production").service("OrderCustomScope",function($http,Constant){this.getAll=function(){return $http.get(Constant.BACKEND_BASE+"/itemCustoms")};this.getCustom=function(customUuid){return $http.get(Constant.BACKEND_BASE+"/itemCustoms/"+customUuid+"/scopes")};this.getCustomScope=function(customUuid,scopeUuid){return $http.get(Constant.BACKEND_BASE+"/itemCustoms/"+customUuid+"/scopes/"+scopeUuid)}});
angular.module("IOne-Production").service("ReceiptDetail",function($http,Constant){this.get=function(orderUuid){return $http.get(Constant.BACKEND_BASE+"/orders/"+orderUuid+"/receipts")}});angular.module("IOne-Production").service("SaleTypes",function($http,Constant){this.getAll=function(){return $http.get(Constant.BACKEND_BASE+"/saleTypes/")}});
angular.module("IOne-Production").service("Parameters",function($http,Constant){this.getAll=function(channulUuid){var url="";if(channulUuid!=null)url=url+"?channelUuid\x3d"+channulUuid;return $http.get(Constant.BACKEND_BASE+"/parameters"+url)}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/cbi/sale_type",{controller:"CBISaleTypeController",templateUrl:"app/src/app/cbi/sale_type/saleType.html"})}]);
angular.module("IOne-Production").controller("CBISaleTypeController",function($scope,CBISaleTypeService,Constant,$mdDialog,$q){$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={select:{status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value,prodType:Constant.PROD_TYPE[0].value},no:"",name:"",keyWord:""};$scope.menuDisplayOption={"switchConfirm":{display:true,name:"审核/取消审核",uuid:"1256f5f2-9fbd-45cd-9b85-510d542d8635"},"switchStatus":{display:true,
name:"启用/禁用",uuid:"30681d9d-bdb5-4ffc-8509-81c07d4324c1"},"batchConfirm":{display:true,name:"批量审核",uuid:"8187561d-7cb4-4653-af57-7d2bb0debd86"},"batchRevertConfirm":{display:true,name:"批量取审",uuid:"186587b3-e5cf-439f-adf6-c7cc905a80d5"},"batchStatus":{display:true,name:"批量启用",uuid:"0be02d62-bbb7-4012-8cd3-51cdef01bfa1"},"batchRevertStatus":{display:true,name:"批量禁用",uuid:"ab35e8fb-81bc-4964-bfcd-f857f77fa35f"},"batchDelete":{display:true,name:"批量删除",uuid:"f08c9c62-b96e-4a1d-afa9-0f2d17f3ad70"},"detailConfirm":{display:true,
name:"审核",uuid:"56815654-3eb7-44e6-87a7-ff79d4299d24"},"detailRevertConfirm":{display:true,name:"取审",uuid:"67f8f4b2-d52d-4353-9af7-28119a829bc5"},"detailStatus":{display:true,name:"启用",uuid:"26914510-519a-49c5-a28b-003de55376a3"},"detailRevertStatus":{display:true,name:"禁用",uuid:"4ce982d8-efb3-4164-a5db-f66e749296f0"},"detailDelete":{display:true,name:"删除",uuid:"624e0daa-036a-466a-b829-7967335910c7"}};$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchStatus=
true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true;$scope.sortByField="no";$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.yesOrNo={1:{value:"1",name:"是"},2:{value:"2",name:"否"}};$scope.refreshList=function(){CBISaleTypeService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.select.confirm,$scope.listFilterOption.select.status,$scope.listFilterOption.no,$scope.listFilterOption.name,$scope.listFilterOption.keyWord,
$scope.RES_UUID_MAP.CBI.SALE_TYPE.RES_UUID).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;$scope.selectAllFlag=false;$scope.selectedItemSize=0})};$scope.getMenuAuthData($scope.RES_UUID_MAP.CBI.SALE_TYPE.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)});$scope.$watch("listFilterOption.select",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=
0;$scope.refreshList()},true);$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()}};$scope.selectAllFlag=false;$scope.selectedItemSize=0;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;$scope.selectedItem.discountRatePercentage=(Math.round($scope.selectedItem.discountRate*1E4)/100).toFixed(2)+"%";item.detailList=$scope.subItemList;$scope.displayAdvancedSearPanel=false};
$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;$scope.selectedItem=null};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel)item.detailList=item};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);$scope.refreshList();if($scope.status=="edit")$scope.selectedItem.discountRatePercentage=
(Math.round($scope.selectedItem.discountRate*1E4)/100).toFixed(2)+"%"};$scope.hideItemDetailsAction=function(event){$scope.stopEventPropagation(event);$scope.selectedItem=null;$scope.refreshList()};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);
$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.source.confirm=="2"&&$scope.source.status=="2"){$scope.showError("不允许状态是已审核又无效,请调整后再保存");return}if($scope.status=="add"){if($scope.domain=="CBI_BASE_SALE_TYPE")CBISaleTypeService.add($scope.source).success(function(data){$scope.showInfo("新增数据成功。")}).error(function(data){$scope.showError("新增失败:"+"\x3cbr\x3e"+data.message)})}else if($scope.status=="edit")if($scope.domain=="CBI_BASE_SALE_TYPE")CBISaleTypeService.modify($scope.source.uuid,
$scope.source).success(function(data){$scope.showInfo("修改数据成功。");$scope.source=data;$scope.selectedItem=data;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)}).error(function(data){$scope.showError("修改失败:"+"\x3cbr\x3e"+data.message);$scope.source=angular.copy($scope.selectedItemBackUp);$scope.selectedItem=angular.copy($scope.selectedItemBackUp)})};$scope.deleteDetailAction=function(detail){};$scope.selectItemAction=function(event,item){$scope.stopEventPropagation(event);item.selectedRef=
!item.selected;if(item.selected==false||item.selected==undefined||item.selected==null)$scope.selectedItemSize+=1;else{$scope.selectedItemSize-=1;$scope.selectAllFlag=false}$scope.disableBatchMenuButtons()};$scope.confirmClickAction=function(event,item){$scope.stopEventPropagation(event);if(item.confirm==Constant.CONFIRM[2].value)$scope.showConfirm("确认取消审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};CBISaleTypeService.modify(item.uuid,UpdateInput).success(function(){item.confirm=
Constant.CONFIRM[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("取消审核成功！")}).error(function(response){$scope.showError(response.message)})});else $scope.showConfirm("确认审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};CBISaleTypeService.modify(item.uuid,UpdateInput).success(function(){item.confirm=Constant.CONFIRM[2].value;$scope.disableBatchMenuButtons();$scope.showInfo("审核成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.confirmSwitchAction=
function(event,item){$scope.stopEventPropagation(event);if(item.confirm==Constant.CONFIRM[2].value)$scope.showConfirm("确认取消审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};CBISaleTypeService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("取消审核成功。")})},function(){item.confirm=Constant.CONFIRM[2].value});else{if(item.status==Constant.STATUS[2].value){$scope.showWarn("项目是失效状态,请先启用后再审核");item.confirm=Constant.CONFIRM[2].value;
return}$scope.showConfirm("确认审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};CBISaleTypeService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("审核成功。")})},function(){item.confirm=Constant.CONFIRM[1].value})}};$scope.statusSwitchAction=function(event,item){$scope.stopEventPropagation(event);if(item.status==Constant.STATUS[2].value)$scope.showConfirm("确认修改启用状态为有效吗？","",function(){var UpdateInput={uuid:item.uuid,
status:Constant.STATUS[1].value};CBISaleTypeService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("生效成功。")})},function(){item.status=Constant.STATUS[2].value});else $scope.showConfirm("确认修改启用状态为失效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value,confirm:Constant.CONFIRM[1].value};CBISaleTypeService.modify(UpdateInput.uuid,UpdateInput).success(function(){item.confirm=Constant.CONFIRM[1].value;$scope.disableBatchMenuButtons();
$scope.showInfo("失效成功。")})},function(){item.status=Constant.STATUS[1].value})};$scope.statusClickAction=function(event,item){$scope.stopEventPropagation(event);if(item.status==Constant.STATUS[1].value)$scope.showConfirm("确认改为失效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value,confirm:Constant.CONFIRM[1].value};CBISaleTypeService.modify(item.uuid,UpdateInput).success(function(){item.status=Constant.STATUS[2].value;item.confirm=Constant.CONFIRM[1].value;$scope.disableBatchMenuButtons();
$scope.showInfo("修改为失效成功！")}).error(function(response){$scope.showError(response.message)})});else $scope.showConfirm("确认改为生效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};CBISaleTypeService.modify(item.uuid,UpdateInput).success(function(){item.status=Constant.STATUS[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("修改为生效成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.releaseClickAction=function(event,item){$scope.stopEventPropagation(event);
console.info("release...")};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);if(item.status!="1"||item.confirm!="1"){$scope.showWarn("仅当销售类型的状态是有效且未审核时才允许删除!");return}$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){CBISaleTypeService.delete(item.uuid).success(function(){$scope.selectedItem=null;$scope.refreshList();$scope.showInfo("删除数据成功。")})})};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var noDeleteNos="";var count=
0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.status=="1"&&item.confirm=="1"){var response=CBISaleTypeService.delete(item.uuid).success(function(){});promises.push(response);count++}else noDeleteNos=noDeleteNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任何状态是有效且未审核的可删除项目，请选择！");return}$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){if(noDeleteNos!=="")$scope.showWarn("以下状态是失效或已审核的的项目将不会删除："+"\x3cbr\x3e"+noDeleteNos);$q.all(promises).then(function(data){$scope.refreshList();
$scope.showInfo("删除成功！")},function(data){$scope.showError(data.message)})})};$scope.confirmAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var confirmedNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.confirm!=Constant.CONFIRM[2].value){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};var response=CBISaleTypeService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else confirmedNos=
confirmedNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任何未审核的项目，请先选择！");return}if(confirmedNos!=="")$scope.showWarn("以下已审核过的项目将不再次审核："+"\x3cbr\x3e"+confirmedNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("审核成功！")},function(data){$scope.showError(data.message)})};$scope.revertConfirmAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var unConfirmedNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===
true)if(item.confirm==Constant.CONFIRM[2].value){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};var response=CBISaleTypeService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else unConfirmedNos=unConfirmedNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任已审核的项目，请先选择！");return}if(unConfirmedNos!=="")$scope.showWarn("以下未审核过的项目将不执行取消审核："+unConfirmedNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("取消审核成功！")},
function(data){$scope.showError(data.message)})};$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var effectiveNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.status!=Constant.STATUS[1].value){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};var response=CBISaleTypeService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else effectiveNos=effectiveNos+
item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任何失效的项目，请先选择！");return}if(effectiveNos!=="")$scope.showWarn("以下已生效的项目将不再次修改："+"\x3cbr\x3e"+effectiveNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("生效成功！")},function(data){$scope.showError(data.message)})};$scope.revertStatusAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var uneffectiveNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.status==
Constant.STATUS[1].value){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value,confirm:Constant.CONFIRM[1].value};var response=CBISaleTypeService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else uneffectiveNos=uneffectiveNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择生效的项目，请先选择！");return}if(uneffectiveNos!=="")$scope.showWarn("以下失效的项目将不再次修改："+uneffectiveNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("失效成功！")},
function(data){$scope.showError(data.message)})};$scope.releaseAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("release all...")};$scope.selectAllAction=function(){angular.forEach($scope.itemList,function(item){if($scope.selectAllFlag)item.selected=true;else item.selected=false;item.selectedRef=item.selected});$scope.selectedItemSize=0;$scope.selectedItemAmount=0;if($scope.selectAllFlag)angular.forEach($scope.itemList,function(item){$scope.selectedItemSize++});$scope.disableBatchMenuButtons()};
$scope.disableBatchMenuButtons=function(){var selectedCount=0;var confirm="";var status="";var diffConfirm=false;var diffStatus=false;angular.forEach($scope.itemList,function(item,index){if(item.selectedRef){selectedCount++;if(confirm=="")confirm=item.confirm;else if(confirm!=item.confirm)diffConfirm=true;if(status=="")status=item.status;else if(status!=item.status)diffStatus=true}});if(selectedCount==0){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchStatus=
true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}else{if(diffConfirm==true){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchDelete=true}else if(confirm=="2"){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=false;$scope.disabledBatchDelete=true}else{$scope.disabledBatchConfirm=false;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchDelete=false}if(diffStatus==true){$scope.disabledBatchConfirm=true;$scope.disabledBatchStatus=
true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}else if(status=="1"){$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=false}else{$scope.disabledBatchConfirm=true;$scope.disabledBatchStatus=false;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}}}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/plm/series",{controller:"SeriesController",templateUrl:"app/src/app/plm/series/series.html"})}]);
angular.module("IOne-Production").controller("SeriesController",function($scope,SeriesService,Constant,$mdDialog,$q){$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={no:"",name:""};$scope.sortByAction=function(field){$scope.sortByField=field;$scope.refreshList()};$scope.refreshList=function(){SeriesService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.no,$scope.listFilterOption.name,$scope.listFilterOption.keyWord,
$scope.sortByField,"").success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements})};$scope.$watch("listFilterOption",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()}};
$scope.selectAllFlag=false;$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);$scope.refreshList()};$scope.showDetailPanelAction=function(item){$scope.selectedItem=item};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)};$scope.preAddItemAction=function(source,
domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.status=="add")SeriesService.add($scope.source).success(function(data){$scope.showInfo("新增数据成功。");$scope.refreshList()}).error(function(data){$scope.showError("新增失败:"+"\x3cbr\x3e"+data.message)});else if($scope.status="edit"){console.log($scope.source);SeriesService.modify($scope.source.uuid,$scope.source).success(function(data){$scope.refreshList();
$scope.showInfo("修改数据成功。");$scope.source=data;$scope.selectedItem=data;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)}).error(function(data){$scope.showError("修改失败:"+"\x3cbr\x3e"+data.message);$scope.source=angular.copy($scope.selectedItemBackUp);$scope.selectedItem=angular.copy($scope.selectedItemBackUp)})}};$scope.selected=[];$scope.selectItemAction=function(event,item,selected){$scope.stopEventPropagation(event);var idx=selected.indexOf(item);if(idx>-1)selected.splice(idx,1);else selected.push(item);
$scope.selectItemCount=$scope.selected.length};$scope.exists=function(item,selected){return selected.indexOf(item)>-1};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){SeriesService.delete(item.uuid).success(function(){$scope.selectedItem=null;$scope.refreshList();$scope.showInfo("删除数据成功。");$scope.selectItemCount=0})})};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selected.length>
0)$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){if($scope.selected){var promises=[];angular.forEach($scope.selected,function(item){var response=SeriesService.delete(item.uuid).success(function(data){});promises.push(response)});$q.all(promises).then(function(){$scope.showInfo("删除数据成功。");$scope.refreshList();$scope.selectItemCount=0})}})};$scope.selectAllAction=function(){if($scope.selectAllFlag==true)angular.forEach($scope.itemList,function(item){var idx=$scope.selected.indexOf(item);if(idx<0)$scope.selected.push(item)});
else if($scope.selectAllFlag==false)$scope.selected=[];$scope.selectItemCount=$scope.selected.length}});
angular.module("IOne-Production").service("SeriesService",function($http,Constant){this.getAll=function(sizePerPage,page,no,name,keyWord,sortField,resUuid){var url="/series?size\x3d"+sizePerPage+"\x26page\x3d"+page;if(no!==undefined&&no!==null)url=url+"\x26no\x3d"+no;if(name!==undefined&&name!==null)url=url+"\x26name\x3d"+name;if(keyWord!==undefined&&keyWord!==null&&keyWord!=="")url=url+"\x26keyWord\x3d"+keyWord;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;if(sortField!==
undefined&&sortField!==null)url=url+"\x26sort\x3d"+sortField;return $http.get(Constant.BACKEND_BASE+url)};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+"/series/"+uuid)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/series/"+uuid)};this.modify=function(uuid,UpdateInput){return $http.patch(Constant.BACKEND_BASE+"/series/"+uuid,UpdateInput)};this.add=function(AddInput){return $http.post(Constant.BACKEND_BASE+"/series/",AddInput)}});
angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/auth/share",{controller:"ShareController",templateUrl:"app/src/app/auth/share/share.html"})}]);
angular.module("IOne-Production").controller("ShareController",function($scope,$mdDialog,Constant,SysTable,ShareTreeMaster,ShareTreeDetail,ChannelService){$scope.formMenuDisplayOption={"100-add":{display:true,name:"新增",uuid:""},"101-delete":{display:true,name:"删除",uuid:""},"102-edit":{display:true,name:"编辑",uuid:""},"103-copy":{display:false,name:"复制",uuid:""},"104-status":{display:false,name:"启用",uuid:""},"105-confirm":{display:false,name:"审核",uuid:""},"106-release":{display:false,name:"发布",uuid:""},
"200-cancel":{display:true,name:"取消新增",uuid:""},"201-save":{display:true,name:"保存",uuid:""},"300-add":{display:true,name:"新增节点",uuid:""},"301-delete":{display:true,name:"删除节点",uuid:""},"302-save":{display:true,name:"保存",uuid:""},"303-cancel":{display:true,name:"取消修改",uuid:""},"304-quit":{display:true,name:"退出编辑",uuid:""}};$scope.listFilterOption={status:Constant.STATUS[0].value};$scope.$watch("listFilterOption",function(newValue,oldValue){if(newValue.status!=oldValue.status)$scope.refreshAllEntities()},
true);$scope.listFilterDisplayOption={showStatusFilterMenu:true,showConfirmFilterMenu:false,showReleaseFilerMenu:false,showProdTypeFilterMenu:false,showStopProdFilterMenu:false};$scope.refreshAllEntities=function(){$scope.allSysTable=SysTable.query();$scope.allShareTree=ShareTreeMaster.query({status:$scope.listFilterOption.status==0?"":$scope.listFilterOption.status,keyword:$scope.searchKeyword})};$scope.listTabSelected=function(){$scope.refreshAllEntities();$scope.selectedItem=null;$scope.shareTreeDetails=
null;$scope.source=null;$scope.currentSelectedNode=null;$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS,0)};$scope.formTabSelected=function(){$scope.getMenuAuthData($scope.RES_UUID_MAP.AUTH.SHARE.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)})};$scope.editItem=function(shareTree){$scope.changeViewStatus(Constant.UI_STATUS.PRE_EDIT_UI_STATUS,1);ShareTreeMaster.get({uuid:shareTree.uuid},function(data){$scope.selectedItem=data});ShareTreeDetail.query({shareTreeUuid:shareTree.uuid},
function(data){$scope.shareTreeDetails=data;$scope.refreshTreeModel(data)})};$scope.preAddMenuAction=function(){$scope.selectedItem={};$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_ADD,1)};$scope.addNodeMenuAction=function(){if($scope.displayType=="2"&&(!$scope.shareTreeDetails||$scope.shareTreeDetails.length==0)){$scope.showWarn("资源树未配置当前登录渠道用户，请联系集团用户新增渠道用户到资源树。");return}$mdDialog.show({controller:"AddNodeDialogController",templateUrl:"app/src/app/auth/share/addNode.html",parent:angular.element(document.body),
targetEvent:event}).then(function(data){if($scope.shareTreeDetails)for(var i=0;i<$scope.shareTreeDetails.length;i++)if($scope.shareTreeDetails[i].channel&&data.channel&&$scope.shareTreeDetails[i].channel.uuid==data.channel){$scope.showError("同一个渠道只能关联到一个节点。");return}ShareTreeDetail.save({shareTreeUuid:$scope.selectedItem.uuid},{no:data.name,name:data.name,channelUuid:data.channel||"",parentUuid:$scope.source.length>0?$scope.source[0].id:"",defaultFlag:data.defaultFlag,aamFlag:data.aamFlag},function(data){ShareTreeDetail.query({shareTreeUuid:$scope.selectedItem.uuid},
function(data){$scope.shareTreeDetails=data;$scope.refreshTreeModel(data)})},function(){$scope.showError("新增节点失败。")})})};$scope.deleteMenuAction=function(){$scope.showConfirm("确认删除吗？","删除的数据不可恢复。",function(){if($scope.selectedItem)ShareTreeMaster.delete({uuid:$scope.selectedItem.uuid},{},function(){$scope.showInfo("删除成功。");$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_DELETE,0)})})};$scope.deleteNodeMenuAction=function(){if($scope.displayType=="2"&&$scope.currentSelectedNode&&$scope.currentSelectedNode.parentUuid==
null){$scope.showWarn("渠道用户不能删除自身节点。");return}$scope.showConfirm("确认删除吗？","删除的数据不可恢复。",function(){if($scope.selectedItem&&$scope.currentSelectedNode)ShareTreeDetail.delete({shareTreeUuid:$scope.selectedItem.uuid,uuid:$scope.currentSelectedNode.uuid},{},function(){$scope.currentSelectedNode=null;ShareTreeDetail.query({shareTreeUuid:$scope.selectedItem.uuid},function(data){$scope.shareTreeDetails=data;$scope.refreshTreeModel(data)});$scope.showInfo("删除成功。")},function(response){$scope.showError("删除失败。")})})};
$scope.modifyMenuAction=function(){$scope.selectedItem.sysTableUuid=$scope.selectedItem.sysTable.uuid;ShareTreeMaster.update({uuid:$scope.selectedItem.uuid},$scope.selectedItem,function(){$scope.showInfo("修改数据成功。")},function(){$scope.showError("修改数据失败。")})};$scope.cancelModifyMenuAction=function(){ShareTreeMaster.get({uuid:$scope.selectedItem.uuid},function(data){$scope.selectedItem=data})};$scope.exitModifyMenuAction=function(){$scope.cancelModifyMenuAction();$scope.changeViewStatus($scope.UI_STATUS.PRE_EDIT_UI_STATUS,
1)};$scope.cancelAddMenuAction=function(){$scope.listTabSelected()};$scope.addMenuAction=function(){for(var i=0;i<$scope.allShareTree.length;i++)if($scope.allShareTree[i].sysTable.uuid==$scope.selectedItem.sysTable.uuid){$scope.showError("一个系统资源只能关联一个资源树。");return}$scope.selectedItem.sysTableUuid=$scope.selectedItem.sysTable.uuid;ShareTreeMaster.save({},$scope.selectedItem,function(data){$scope.selectedItem=data;$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_MODIFY,1);$scope.shareTreeDetails=
[];$scope.refreshTreeModel([]);$scope.showInfo("新增数据成功。")},function(){$scope.showError("新增数据失败。")})};$scope.sourceUpdateFlag=new Date;$scope.refreshTreeModel=function(shareTreeDetails){var list=[];angular.forEach(shareTreeDetails,function(item){list.push({id:item.uuid,uuid:item.uuid,name:item.name,channel:item.channel?item.channel.name:"",parent:item.parentUuid||"",aamFlag:item.aamFlag})});$scope.source=list;$scope.sourceUpdateFlag=new Date};$scope.changeTree=function(source,dest){if(source&&dest)ShareTreeDetail.update({shareTreeUuid:$scope.selectedItem.uuid,
uuid:source},{parentUuid:dest})};$scope.selectCallback=function(uuid){angular.forEach($scope.shareTreeDetails,function(data){if(data.uuid==uuid){$scope.currentSelectedNode=data;$scope.$apply()}})};$scope.updateNodeHandler=function(){ShareTreeDetail.update({shareTreeUuid:$scope.selectedItem.uuid,uuid:$scope.currentSelectedNode.uuid},$scope.currentSelectedNode,function(){$scope.showInfo("修改成功。");ShareTreeDetail.query({shareTreeUuid:$scope.selectedItem.uuid},function(data){$scope.shareTreeDetails=data;
$scope.refreshTreeModel(data)})},function(response){$scope.showError($scope.getAllError(response.data))})};$scope.searchChannel=function(){$mdDialog.show({controller:"ChannelSearchController",templateUrl:"app/src/app/auth/share/selectChannel.html",parent:angular.element(document.body),targetEvent:event}).then(function(data){$scope.currentSelectedNode.channel=data;$scope.currentSelectedNode.channelUuid=data.uuid;$scope.updateNodeHandler()})}});
angular.module("IOne-Production").controller("AddNodeDialogController",function($scope,$mdDialog,ChannelService){$scope.pageOption={sizePerPage:21,currentPage:0,totalPage:0,totalElements:0,displayModel:0};$scope.refreshChannel=function(){ChannelService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,0,0,$scope.searchKeyword).success(function(data){$scope.allChannel=data;$scope.pageOption.totalElements=data.totalElements;$scope.pageOption.totalPage=data.totalPages})};$scope.refreshChannel();
$scope.selectChannel=function(channel){$scope.searchChannelFlag=false;$scope.data.channel=channel.uuid};$scope.data={};$scope.hideDlg=function(){$mdDialog.hide($scope.data)};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").controller("ChannelSearchController",function($scope,$mdDialog,ChannelService){$scope.pageOption={sizePerPage:21,currentPage:0,totalPage:0,totalElements:0,displayModel:0};$scope.refreshChannel=function(){ChannelService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,0,0,$scope.searchKeyword).success(function(data){$scope.allChannel=data;$scope.pageOption.totalElements=data.totalElements;$scope.pageOption.totalPage=data.totalPages})};$scope.refreshChannel();
$scope.selectChannel=function(channel){$scope.channel=channel;$mdDialog.hide($scope.channel)};$scope.hideDlg=function(){$mdDialog.hide($scope.channel)};$scope.cancelDlg=function(){$mdDialog.cancel()}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/shopping-cart",{controller:"ShoppingCartController",templateUrl:"app/src/app/order/shopping_cart/shoppingCart.html"})}]);
angular.module("IOne-Production").controller("ShoppingCartController",function($scope,ShoppingCart,ShoppingCartItemPic,$mdDialog,$timeout,Constant,ChannelPriceService){$scope.shoppingCart={employeeName:"",clientName:""};$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.detailLoad=function(){angular.forEach($scope.shoppingCartList,function(item){$scope.dataLoad(item)})};$scope.searchShoppingCartList=function(pageCallback){if(pageCallback||$scope.shoppingCartList==
null){if($scope.shoppingCart.employeeName!==undefined)employeeName=$scope.shoppingCart.employeeName;else employeeName=null;if($scope.shoppingCart.clientName!==undefined)customerName=$scope.shoppingCart.clientName;else customerName=null;ShoppingCart.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,employeeName,customerName,RES_UUID_MAP.PSO.CART.LIST_PAGE.RES_UUID,"/All").success(function(data){$scope.shoppingCartList=data;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=
data.totalElements;$scope.pageOption.totalPage=data.totalPages}).then(function(data){angular.forEach(data.data.content,function(item){$scope.dataLoad(item)})})}};$scope.dataLoad=function(shoppingCartItem){if(shoppingCartItem.itemDetails==null)ShoppingCart.getAll(1E3,0,shoppingCartItem.employeeName,shoppingCartItem.customerName,RES_UUID_MAP.PSO.CART.LIST_PAGE.RES_UUID,"").success(function(data){shoppingCartItem.itemDetails=data.content})};$scope.editItem=function(shoppingCartItem){$scope.selectedItem=
shoppingCartItem;$scope.changeViewStatus(Constant.UI_STATUS.PRE_EDIT_UI_STATUS,1)};$scope.listTabSelected=function(){$scope.searchShoppingCartList(false);$scope.selectedItem=null;$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS,0);$scope.getMenuAuthData($scope.RES_UUID_MAP.PSO.CART.LIST_PAGE.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)})};$scope.formTabSelected=function(){$scope.getMenuAuthData($scope.RES_UUID_MAP.PSO.CART.FORM_PAGE.RES_UUID).success(function(data){$scope.menuAuthDataMap=
$scope.menuDataMap(data)})}});angular.module("IOne-Production").service("ShoppingCart",function($http,Constant){this.getAll=function(sizePerPage,page,employeeName,customerName,resUuid,all){var url="/carts"+all+"?size\x3d"+sizePerPage+"\x26page\x3d"+page;if(customerName!==null)url=url+"\x26customerName\x3d"+customerName;if(employeeName!==null)url=url+"\x26employeeName\x3d"+employeeName;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)}});
angular.module("IOne-Production").service("ShoppingCartItemPic",function($http,Constant){this.get=function(itemUuid){return $http.get(Constant.BACKEND_BASE+"/items/"+itemUuid+"/paths/")}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/ocm/supplier",{controller:"OCMSupplierController",templateUrl:"app/src/app/ocm/supplier/supplier.html"})}]);
angular.module("IOne-Production").controller("OCMSupplierController",function($scope,OCMSupplierService,Constant,$mdDialog,$q){$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={select:{status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value,supplyType:Constant.SUPPLY_TYPE[0].value},no:"",name:"",keyWord:""};$scope.menuDisplayOption={"switchConfirm":{display:true,name:"审核/取消审核",uuid:"dee86c56-92d5-4f3e-8ada-bb40628a88e7"},"switchStatus":{display:true,
name:"启用/禁用",uuid:"0e28b85e-7018-4f80-8bba-3726058f0661"},"batchConfirm":{display:true,name:"批量审核",uuid:"66223f81-e0c4-4a66-824b-2e98aa5c68f1"},"batchRevertConfirm":{display:true,name:"批量取审",uuid:"a07bca7f-53ec-4ca9-af41-5049bce5db74"},"batchStatus":{display:true,name:"批量启用",uuid:"0910dd29-ab78-4924-b653-d4d3d0efaafb"},"batchRevertStatus":{display:true,name:"批量禁用",uuid:"8b1aaae7-b003-45b6-81a2-0d6cd69b1efc"},"batchDelete":{display:true,name:"批量删除",uuid:"a6c47caa-4fe3-423c-a6c1-2033fe08643e"},"detailConfirm":{display:true,
name:"审核",uuid:"b76cab17-dac5-48dd-9f82-ea9661111789"},"detailRevertConfirm":{display:true,name:"取审",uuid:"6e5b7bed-bf3b-42be-8f0b-47333931abe8"},"detailStatus":{display:true,name:"启用",uuid:"3196d695-acf0-4302-92de-d09747593741"},"detailRevertStatus":{display:true,name:"禁用",uuid:"b196ba26-2a63-4033-b940-0669c52b2326"},"detailDelete":{display:true,name:"删除",uuid:"51233338-2854-4be1-8c4f-4a954e44a901"}};$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchStatus=
true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true;$scope.sortByField="no";$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.refreshList=function(){OCMSupplierService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.select.confirm,$scope.listFilterOption.select.status,$scope.listFilterOption.no,$scope.listFilterOption.name,$scope.listFilterOption.select.supplyType,$scope.listFilterOption.keyWord,
$scope.RES_UUID_MAP.CBI.SUPPLIER.RES_UUID).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;$scope.selectAllFlag=false;$scope.selectedItemSize=0})};$scope.getMenuAuthData($scope.RES_UUID_MAP.CBI.SUPPLIER.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)});$scope.$watch("listFilterOption.select",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=
0;$scope.refreshList()},true);$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()}};$scope.selectAllFlag=false;$scope.selectedItemSize=0;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;item.detailList=$scope.subItemList;$scope.displayAdvancedSearPanel=false};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;
$scope.selectedItem=null};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel)item.detailList=item};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);$scope.refreshList()};$scope.hideItemDetailsAction=function(event){$scope.stopEventPropagation(event);$scope.selectedItem=null;$scope.refreshList()};$scope.editItemAction=
function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.source.confirm=="2"&&$scope.source.status==
"2"){$scope.showError("不允许状态是已审核又无效,请调整后再保存");return}if($scope.status=="add"){if($scope.domain=="OCM_BASE_SUPPLIER")OCMSupplierService.add($scope.source).success(function(data){$scope.showInfo("新增数据成功。")}).error(function(data){$scope.showError("新增失败:"+"\x3cbr\x3e"+data.message)})}else if($scope.status=="edit")if($scope.domain=="OCM_BASE_SUPPLIER")OCMSupplierService.modify($scope.source.uuid,$scope.source).success(function(data){$scope.showInfo("修改数据成功。");$scope.source=data;$scope.selectedItem=data;
$scope.selectedItemBackUp=angular.copy($scope.selectedItem)}).error(function(data){$scope.showError("修改失败:"+"\x3cbr\x3e"+data.message);$scope.source=angular.copy($scope.selectedItemBackUp);$scope.selectedItem=angular.copy($scope.selectedItemBackUp)})};$scope.deleteDetailAction=function(detail){};$scope.selectItemAction=function(event,item){$scope.stopEventPropagation(event);item.selectedRef=!item.selected;if(item.selected==false||item.selected==undefined||item.selected==null)$scope.selectedItemSize+=
1;else{$scope.selectedItemSize-=1;$scope.selectAllFlag=false}$scope.disableBatchMenuButtons()};$scope.confirmSwitchAction=function(event,item){$scope.stopEventPropagation(event);if(item.confirm==Constant.CONFIRM[2].value)$scope.showConfirm("确认取消审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};OCMSupplierService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("取消审核成功。")})},function(){item.confirm=Constant.CONFIRM[2].value});
else{if(item.status==Constant.STATUS[2].value){$scope.showWarn("项目是失效状态,请先启用后再审核");item.confirm=Constant.CONFIRM[2].value;return}$scope.showConfirm("确认审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};OCMSupplierService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("审核成功。")})},function(){item.confirm=Constant.CONFIRM[1].value})}};$scope.statusSwitchAction=function(event,item){$scope.stopEventPropagation(event);
if(item.status==Constant.STATUS[2].value)$scope.showConfirm("确认修改启用状态为有效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};OCMSupplierService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("生效成功。")})},function(){item.status=Constant.STATUS[2].value});else $scope.showConfirm("确认修改启用状态为失效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value,confirm:Constant.CONFIRM[1].value};OCMSupplierService.modify(UpdateInput.uuid,
UpdateInput).success(function(){item.confirm=Constant.CONFIRM[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("失效成功。")})},function(){item.status=Constant.STATUS[1].value})};$scope.confirmClickAction=function(event,item){$scope.stopEventPropagation(event);if(item.confirm==Constant.CONFIRM[2].value)$scope.showConfirm("确认取消审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};OCMSupplierService.modify(item.uuid,UpdateInput).success(function(){item.confirm=Constant.CONFIRM[1].value;
$scope.disableBatchMenuButtons();$scope.showInfo("取消审核成功！")}).error(function(response){$scope.showError(response.message)})});else $scope.showConfirm("确认审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};OCMSupplierService.modify(item.uuid,UpdateInput).success(function(){item.confirm=Constant.CONFIRM[2].value;$scope.disableBatchMenuButtons();$scope.showInfo("审核成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.statusClickAction=function(event,
item){$scope.stopEventPropagation(event);if(item.status==Constant.STATUS[1].value)$scope.showConfirm("确认改为失效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value,confirm:Constant.CONFIRM[1].value};OCMSupplierService.modify(item.uuid,UpdateInput).success(function(){item.status=Constant.STATUS[2].value;item.confirm=Constant.CONFIRM[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("修改为失效成功！")}).error(function(response){$scope.showError(response.message)})});else $scope.showConfirm("确认改为生效吗？",
"",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};OCMSupplierService.modify(item.uuid,UpdateInput).success(function(){item.status=Constant.STATUS[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("修改为生效成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.releaseClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("release...")};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);
if(item.status!="1"||item.confirm!="1"){$scope.showWarn("仅当渠道/直营店的状态是有效且未审核时才允许删除!");return}$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){OCMSupplierService.delete(item.uuid).success(function(){$scope.selectedItem=null;$scope.refreshList();$scope.showInfo("删除数据成功。")})})};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var noDeleteNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.status=="1"&&item.confirm==
"1"){var response=OCMSupplierService.delete(item.uuid).success(function(){});promises.push(response);count++}else noDeleteNos=noDeleteNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任何状态是有效且未审核的可删除项目，请选择！");return}$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){if(noDeleteNos!=="")$scope.showWarn("以下状态是失效或已审核的的项目将不会删除："+"\x3cbr\x3e"+noDeleteNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("删除成功！")},function(data){$scope.showError(data.message);$scope.showError(data.data.message)})})};
$scope.confirmAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var confirmedNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.confirm!=Constant.CONFIRM[2].value){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};var response=OCMSupplierService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else confirmedNos=confirmedNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任何未审核的项目，请先选择！");
return}if(confirmedNos!=="")$scope.showWarn("以下已审核过的项目将不再次审核："+"\x3cbr\x3e"+confirmedNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("审核成功！")},function(data){$scope.showError(data.message);$scope.showError(data.data.message)})};$scope.revertConfirmAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var unConfirmedNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.confirm==Constant.CONFIRM[2].value){var UpdateInput=
{uuid:item.uuid,confirm:Constant.CONFIRM[1].value};var response=OCMSupplierService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else unConfirmedNos=unConfirmedNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任已审核的项目，请先选择！");return}if(unConfirmedNos!=="")$scope.showWarn("以下未审核过的项目将不执行取消审核："+unConfirmedNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("取消审核成功！")},function(data){$scope.showError(data.data.message);$scope.showError(data.message)})};
$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var effectiveNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.status!=Constant.STATUS[1].value){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};var response=OCMSupplierService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else effectiveNos=effectiveNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任何失效的项目，请先选择！");
return}if(effectiveNos!=="")$scope.showWarn("以下已生效的项目将不再次修改："+"\x3cbr\x3e"+effectiveNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("生效成功！")},function(data){$scope.showError(data.message);$scope.showError(data.data.message)})};$scope.revertStatusAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var uneffectiveNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.status==Constant.STATUS[1].value){var UpdateInput=
{uuid:item.uuid,status:Constant.STATUS[2].value,confirm:Constant.CONFIRM[1].value};var response=OCMSupplierService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else uneffectiveNos=uneffectiveNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择生效的项目，请先选择！");return}if(uneffectiveNos!=="")$scope.showWarn("以下失效的项目将不再次修改："+uneffectiveNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("失效成功！")},function(data){$scope.showError(data.data.message);
$scope.showError(data.message)})};$scope.releaseAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("release all...")};$scope.selectAllAction=function(){angular.forEach($scope.itemList,function(item){if($scope.selectAllFlag)item.selected=true;else item.selected=false;item.selectedRef=item.selected});$scope.selectedItemSize=0;$scope.selectedItemAmount=0;if($scope.selectAllFlag)angular.forEach($scope.itemList,function(item){$scope.selectedItemSize++});$scope.disableBatchMenuButtons()};
$scope.disableBatchMenuButtons=function(){var selectedCount=0;var confirm="";var status="";var diffConfirm=false;var diffStatus=false;angular.forEach($scope.itemList,function(item,index){if(item.selectedRef){selectedCount++;if(confirm=="")confirm=item.confirm;else if(confirm!=item.confirm)diffConfirm=true;if(status=="")status=item.status;else if(status!=item.status)diffStatus=true}});if(selectedCount==0){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchStatus=
true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}else{if(diffConfirm==true){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchDelete=true}else if(confirm=="2"){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=false;$scope.disabledBatchDelete=true}else{$scope.disabledBatchConfirm=false;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchDelete=false}if(diffStatus==true){$scope.disabledBatchConfirm=true;$scope.disabledBatchStatus=
true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}else if(status=="1"){$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=false}else{$scope.disabledBatchConfirm=true;$scope.disabledBatchStatus=false;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}}}});
angular.module("IOne-Production").service("SYSResService",function($http,Constant){this.getAll=function(){return $http.get(Constant.BACKEND_BASE+"/sysRess")};this.getAllwithParam=function(sizePerPage,page,no,name){var url="/sysRess?size\x3d"+sizePerPage+"\x26page\x3d"+page;if(no!==undefined&&no!==null&&no!=="")url=url+"\x26no\x3d"+no;if(name!==undefined&&name!==null&&name!=="")url=url+"\x26name\x3d"+name;return $http.get(Constant.BACKEND_BASE+url)};this.getForParent=function(parentUuid){return $http.get(Constant.BACKEND_BASE+
"/sysRess?parentUuid\x3d"+parentUuid)};this.getForGrade=function(type){return $http.get(Constant.BACKEND_BASE+"/sysRess?type\x3d"+type)};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+"/sysRess/"+uuid)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/sysRess/"+uuid)};this.modify=function(uuid,UpdateInput){return $http.patch(Constant.BACKEND_BASE+"/sysRess/"+uuid,UpdateInput)};this.add=function(AddInput){return $http.post(Constant.BACKEND_BASE+"/sysRess/",AddInput)}});
angular.module("IOne-Production").service("SYSMenusService",function($http,Constant){this.getAll=function(sizePerPage,page,no,name,keyWord,sysResUuid,resUuid){var url="/sysMenus?size\x3d"+sizePerPage+"\x26page\x3d"+page;if(no!==undefined&&no!==null&&no!=="")url=url+"\x26no\x3d"+no;if(name!==undefined&&name!==null&&name!=="")url=url+"\x26name\x3d"+name;if(keyWord!==undefined&&keyWord!==null&&keyWord!=="")url=url+"\x26keyWord\x3d"+keyWord;if(sysResUuid!==undefined&&sysResUuid!==null&&sysResUuid!=="")url=
url+"\x26sysResUuid\x3d"+sysResUuid;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+"/sysMenus/"+uuid)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/sysMenus/"+uuid)};this.modify=function(uuid,UpdateInput){return $http.patch(Constant.BACKEND_BASE+"/sysMenus/"+uuid,UpdateInput)};this.add=function(AddInput){return $http.post(Constant.BACKEND_BASE+
"/sysMenus/",AddInput)}});
angular.module("IOne-Production").service("SYSMapsService",function($http,Constant){this.getAll=function(sizePerPage,page,sysType,moduleType,sourceValueUuid,resUuid){var url="/sysMaps?size\x3d"+sizePerPage+"\x26page\x3d"+page;if(sysType!==undefined&&sysType!==null&&sysType!=="")url=url+"\x26sysType\x3d"+sysType;if(moduleType!==undefined&&moduleType!==null&&moduleType!=="")url=url+"\x26moduleType\x3d"+moduleType;if(sourceValueUuid!==undefined&&sourceValueUuid!==null&&sourceValueUuid!=="")url=url+"\x26sourceValueUuid\x3d"+
sourceValueUuid;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)};this.get=function(uuid){return $http.get(Constant.BACKEND_BASE+"/sysMaps/"+uuid)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/sysMaps/"+uuid)};this.modify=function(uuid,UpdateInput){return $http.patch(Constant.BACKEND_BASE+"/sysMaps/"+uuid,UpdateInput)};this.add=function(AddInput){return $http.post(Constant.BACKEND_BASE+"/sysMaps/",AddInput)}});
angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/sys/sysMenus",{controller:"SYSMenusController",templateUrl:"app/src/app/sys/sys_menus/sysMenus.html"})}]);
angular.module("IOne-Production").controller("SYSMenusController",function($scope,SYSMenusService,Constant,$mdDialog,$q){$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={select:{status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value},no:"",name:"",keyWord:""};$scope.menuDisplayOption={"batchDelete":{display:true,name:"批量删除",uuid:"2dd28da0-2567-4bfe-ae70-0c85793fc797"},"detailDelete":{display:true,name:"删除",uuid:"5560d703-ea0d-4868-b89b-4e5f5063b570"}};
$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true;$scope.sortByField="no";$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.refreshList=function(){SYSMenusService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.no,$scope.listFilterOption.name,$scope.listFilterOption.keyWord,$scope.listFilterOption.select.sysResUuid,
$scope.RES_UUID_MAP.SYS.SYS_BASE_MENU.RES_UUID).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;$scope.selectAllFlag=false;$scope.selectedItemSize=0})};$scope.getMenuAuthData($scope.RES_UUID_MAP.SYS.SYS_BASE_MENU.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)});$scope.$watch("listFilterOption.select",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=
0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()}};$scope.selectAllFlag=false;$scope.selectedItemSize=0;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;item.detailList=$scope.subItemList;$scope.displayAdvancedSearPanel=false};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=
!$scope.displayAdvancedSearPanel;$scope.selectedItem=null};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel)item.detailList=item};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);$scope.refreshList()};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);
$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.status=="add"){if($scope.domain=="SYS_BASE_MENU_FILE")SYSMenusService.add($scope.source).success(function(data){$scope.showInfo("新增数据成功。")}).error(function(data){$scope.showError("新增失败:"+
"\x3cbr\x3e"+data.message)})}else if($scope.status=="edit")if($scope.domain=="SYS_BASE_MENU_FILE")SYSMenusService.modify($scope.source.uuid,$scope.source).success(function(data){$scope.showInfo("修改数据成功。");$scope.source=data;$scope.selectedItem=data;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)}).error(function(data){$scope.showError("修改失败:"+"\x3cbr\x3e"+data.message);$scope.source=angular.copy($scope.selectedItemBackUp);$scope.selectedItem=angular.copy($scope.selectedItemBackUp)})};
$scope.deleteDetailAction=function(detail){};$scope.selectItemAction=function(event,item){$scope.stopEventPropagation(event);item.selectedRef=!item.selected;if(item.selected==false||item.selected==undefined||item.selected==null)$scope.selectedItemSize+=1;else{$scope.selectedItemSize-=1;$scope.selectAllFlag=false}$scope.disableBatchMenuButtons()};$scope.confirmClickAction=function(event,item){$scope.stopEventPropagation(event);if(item.confirm==Constant.CONFIRM[2].value)$scope.showConfirm("确认取消审核吗？",
"",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};SYSMenusService.modify(item.uuid,UpdateInput).success(function(){item.confirm=Constant.CONFIRM[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("取消审核成功！")}).error(function(response){$scope.showError(response.message)})});else $scope.showConfirm("确认审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};SYSMenusService.modify(item.uuid,UpdateInput).success(function(){item.confirm=
Constant.CONFIRM[2].value;$scope.disableBatchMenuButtons();$scope.showInfo("审核成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.confirmSwitchAction=function(event,item){$scope.stopEventPropagation(event);if(item.confirm==Constant.CONFIRM[2].value)$scope.showConfirm("确认取消审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};SYSMenusService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("修改数据成功。")})},
function(){item.confirm=Constant.CONFIRM[2].value});else $scope.showConfirm("确认审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};SYSMenusService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("修改数据成功。")})},function(){item.confirm=Constant.CONFIRM[1].value})};$scope.statusClickAction=function(event,item){$scope.stopEventPropagation(event);if(item.status==Constant.STATUS[1].value)$scope.showConfirm("确认改为失效吗？",
"",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value};SYSMenusService.modify(item.uuid,UpdateInput).success(function(){item.status=Constant.STATUS[2].value;$scope.disableBatchMenuButtons();$scope.showInfo("修改为失效成功！")}).error(function(response){$scope.showError(response.message)})});else $scope.showConfirm("确认改为生效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};SYSMenusService.modify(item.uuid,UpdateInput).success(function(){item.status=Constant.STATUS[1].value;
$scope.disableBatchMenuButtons();$scope.showInfo("修改为生效成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.statusSwitchAction=function(event,item){$scope.stopEventPropagation(event);if(item.status==Constant.STATUS[2].value)$scope.showConfirm("确认修改启用状态为有效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};SYSMenusService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("修改数据成功。")})},function(){item.status=
Constant.STATUS[2].value});else $scope.showConfirm("确认修改启用状态为无效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value};SYSMenusService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("修改数据成功。")})},function(){item.status=Constant.STATUS[1].value})};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){SYSMenusService.delete(item.uuid).success(function(){$scope.selectedItem=
null;$scope.refreshList();$scope.showInfo("删除数据成功。")})})};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var noDeleteNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true){var response=SYSMenusService.delete(item.uuid).success(function(){});promises.push(response);count++}});if(count==0){$scope.showWarn("没有选择任何可删除项目，请选择！");return}$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){if(noDeleteNos!=="")$scope.showWarn("以下状态是失效或已审核的的项目将不会删除："+
"\x3cbr\x3e"+noDeleteNos);$q.all(promises).then(function(){$scope.refreshList();$scope.showInfo("删除成功！")},function(data){$scope.showError(data.message);$scope.showError(data.data.message)})})};$scope.confirmAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var confirmedNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.confirm!=Constant.CONFIRM[2].value){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};
var response=SYSMenusService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else confirmedNos=confirmedNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任何未审核的项目，请先选择！");return}if(confirmedNos!=="")$scope.showWarn("以下已审核过的项目将不再次审核："+"\x3cbr\x3e"+confirmedNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.disableBatchMenuButtons();$scope.showInfo("审核成功！")},function(data){$scope.showError(data.message);$scope.showError(data.data.message)})};
$scope.revertConfirmAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var unConfirmedNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.confirm==Constant.CONFIRM[2].value){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};var response=SYSMenusService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else unConfirmedNos=unConfirmedNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任已审核的项目，请先选择！");
return}if(unConfirmedNos!=="")$scope.showWarn("以下未审核过的项目将不执行取消审核："+unConfirmedNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("取消审核成功！")},function(data){$scope.showError(data.data.message);$scope.showError(data.message)})};$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var effectiveNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.status!=Constant.STATUS[1].value){var UpdateInput=
{uuid:item.uuid,status:Constant.STATUS[1].value};var response=SYSMenusService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else effectiveNos=effectiveNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任何失效的项目，请先选择！");return}if(effectiveNos!=="")$scope.showWarn("以下已生效的项目将不再次修改："+"\x3cbr\x3e"+effectiveNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("生效成功！")},function(data){$scope.showError(data.message);$scope.showError(data.data.message)})};
$scope.revertStatusAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var uneffectiveNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.status==Constant.STATUS[1].value){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value};var response=SYSMenusService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else uneffectiveNos=uneffectiveNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择生效的项目，请先选择！");
return}if(uneffectiveNos!=="")$scope.showWarn("以下失效的项目将不再次修改："+uneffectiveNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("失效成功！")},function(data){$scope.showError(data.data.message);$scope.showError(data.message)})};$scope.selectAllAction=function(){angular.forEach($scope.itemList,function(item){if($scope.selectAllFlag)item.selected=true;else item.selected=false;item.selectedRef=item.selected});$scope.selectedItemSize=0;$scope.selectedItemAmount=0;if($scope.selectAllFlag)angular.forEach($scope.itemList,
function(){$scope.selectedItemSize++});$scope.disableBatchMenuButtons()};$scope.disableBatchMenuButtons=function(){var selectedCount=0;var confirm="";var status="";var diffConfirm=false;var diffStatus=false;angular.forEach($scope.itemList,function(item,index){if(item.selectedRef){selectedCount++;if(confirm=="")confirm=item.confirm;else if(confirm!=item.confirm)diffConfirm=true;if(status=="")status=item.status;else if(status!=item.status)diffStatus=true}});if(selectedCount==0){$scope.disabledBatchConfirm=
true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}else{if(diffConfirm==true){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchDelete=true}else if(confirm=="2"){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=false;$scope.disabledBatchDelete=true}else{$scope.disabledBatchConfirm=false;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchDelete=
false}if(diffStatus==true){$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}else if(status=="1"){$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=false;$scope.disabledBatchDelete=false}else{$scope.disabledBatchStatus=false;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}}};$scope.openSysResDlg=function(){$mdDialog.show({controller:"selectSysResController",templateUrl:"app/src/app/sys/sys_menus/selectSysRes.html",
parent:angular.element(document.body),targetEvent:event}).then(function(data){$scope.listFilterOption.select.sysResUuid=data.uuid;$scope.listFilterOption.select.sysResName=data.name})};$scope.clearSysRes=function(){$scope.listFilterOption.select.sysResUuid="";$scope.listFilterOption.select.sysResName=""}});
angular.module("IOne-Production").controller("selectSysResController",function($scope,$mdDialog,SYSResService){$scope.pageOption={sizePerPage:6,currentPage:0,totalPage:0,totalElements:0};$scope.queryAction=function(){$scope.pageOption.currentPage=0;$scope.refreshSysRes()};$scope.refreshSysRes=function(){SYSResService.getAllwithParam($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,null,$scope.searchKeyword).success(function(data){$scope.allSysRes=data;$scope.pageOption.totalElements=data.totalElements;
$scope.pageOption.totalPage=data.totalPages})};$scope.refreshSysRes();$scope.selectSysRes=function(sysRes){$scope.sysRes=sysRes;$mdDialog.hide($scope.sysRes)};$scope.hideDlg=function(){$mdDialog.hide($scope.sysRes)};$scope.cancelDlg=function(){$mdDialog.cancel()}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/sys/sysRes",{controller:"SysResController",templateUrl:"app/src/app/sys/sys_res/sysRes.html"})}]);
angular.module("IOne-Production").controller("SysResController",function($scope,SYSResService,Constant,$mdDialog){$scope.editNodeDisabled=false;$scope.saveNodeDisabled=true;$scope.cancelModifyDisabled=true;$scope.quitDisabled=true;$scope.formMenuDisplayOption={"102-edit":{display:true,name:"编辑",uuid:"bb12d0d8-d4d4-4bcc-bdab-1807ff361da5"},"302-save":{display:true,name:"保存",uuid:"7b3fbc38-24de-4e46-a541-db25b2a5360c"},"303-cancel":{display:true,name:"取消修改",uuid:"27a19576-c2ff-4ed6-a719-a50311039e96"},
"304-quit":{display:true,name:"退出编辑",uuid:"32a0dec9-71f5-4982-8c30-f73847db8e7d"}};$scope.initData=function(){$scope.headers=[{"type":1,"name":"1级"},{"type":2,"name":"2级"},{"type":3,"name":"3级"}];$scope.selectedTemplateData={}};$scope.initData();$scope.getMenuAuthData($scope.RES_UUID_MAP.SYS.SYS_BASE_RES.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)});$scope.nodeDataClickHandler=function(selectedGrade,selectedItem){angular.forEach($scope.selectedTemplateData[selectedGrade],
function(node){node.selected=false});selectedItem.selected=true;$scope.selectedItem=selectedItem;$scope.clearChildren(selectedItem);SYSResService.getForParent(selectedItem.uuid).success(function(data){if(data&&data.content&&data.content.length>0)$scope.selectedTemplateData[selectedGrade+1]=data.content;$scope.isRefreshing=false}).error(function(){$scope.isRefreshing=false});$scope.refreshAddNodeButtonDisplay()};$scope.refreshTemplateData=function(template,node){if(template&&template.length>0){var dataHandler=
function(template,node,data){var content=$scope.selectedTemplateData[template.uuid];if(content==undefined||content==null){content=[data];$scope.selectedTemplateData[template.uuid]=content}};SYSResService.getForGrade(node.type).success(function(data){dataHandler(template,node,data.content)})}};$scope.refreshAllTemplate=function(){SYSResService.getForGrade($scope.headers[0].type).success(function(data){var setFirstOpen=false;if(data&&data.content){$scope.selectedTemplateData[$scope.headers[0].type]=
data.content;$scope.refreshAddNodeButtonDisplay()}});$scope.selectedItem=null};$scope.refreshAllTemplate();$scope.backup=function(item){return{uuid:item.uuid,no:item.no,name:item.name,type:item.type,parentUuid:item.parentUuid}};$scope.changeToEditMode=function(){$scope.backupSelectedItem=$scope.backup($scope.selectedItem);$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS,0)};$scope.quitEditMode=function(){$scope.showConfirm("修改尚未保存，确认退出编辑吗？","",function(){$scope.selectedItem=$scope.backupSelectedItem;
$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS,0)})};$scope.cancelModification=function(){$scope.selectedItem=$scope.backupSelectedItem};$scope.updateNodeData=function(){$scope.showConfirm("确认修改该节点数据吗？","",function(){if($scope.selectedItem)SYSResService.modify($scope.selectedItem.uuid,$scope.selectedItem).success(function(){$scope.showInfo("修改节点数据成功。");$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS,0)}).error(function(){$scope.showError("修改节点数据失败: ")})})};$scope.refreshAddNodeButtonDisplay=
function(){angular.forEach($scope.headers,function(header){var showAddButton=$scope.selectedTemplateData[header.type-1]!=null&&$scope.selectedTemplateData[header.type-1].length>0||header.type==1;if($scope.selectedTemplateData[header.type-1]!=null)angular.forEach($scope.selectedTemplateData[header.type-1],function(node){if(node.selected)showAddButton=true});header.showAddButton=showAddButton})};$scope.addNodeData=function(type){var parentUuid=null;var parentNodes=$scope.selectedTemplateData[type-1];
angular.forEach(parentNodes,function(parentNode){if(parentNode.selected)parentUuid=parentNode.uuid});$mdDialog.show({controller:"DialogController",templateUrl:"app/src/app/sys/sys_res/addSysRes.html",parent:angular.element(document.body),targetEvent:event}).then(function(data){var Input={no:data.no,name:data.name,type:type,parentUuid:parentUuid};SYSResService.add(Input).success(function(data){data.selected=true;if($scope.selectedTemplateData[type]==null)$scope.selectedTemplateData[type]=[data];else $scope.selectedTemplateData[type].push(data);
var addItem;angular.forEach($scope.selectedTemplateData[type],function(v){if(v.uuid==data.uuid)addItem=v});if(addItem!=null)$scope.nodeDataClickHandler(type,addItem);$scope.showInfo("新增数据成功。")}).error(function(response){$scope.showError("新增数据失败: "+response.message)})})};$scope.deleteNodeData=function($event,item){$scope.showConfirm("确认清除该节点数据吗？","节点数据删除后不可恢复。",function(){SYSResService.delete(item.uuid).success(function(){var indexToDelete=-1;angular.forEach($scope.selectedTemplateData[item.type],
function(v,index){if(v.uuid==item.uuid)indexToDelete=index});$scope.selectedTemplateData[item.type].splice(indexToDelete,1);if(item.selected)$scope.clearChildren(item);$scope.showInfo("删除节点数据成功。")}).error(function(response){$scope.showError("删除节点数据失败: "+response.message)})});$event.stopPropagation();$event.preventDefault()};$scope.clearChildren=function(item){for(var i=Number(item.type)+1;i<=$scope.headers[$scope.headers.length-1].type;i++)if($scope.selectedTemplateData[i]!=null)$scope.selectedTemplateData[i].splice(0)}});
var TAFFY,exports,T;
(function(){var typeList,makeTest,idx,typeKey,version,TC,idpad,cmax,API,protectJSON,each,eachin,isIndexable,returnFilter,runFilters,numcharsplit,orderByCol,run,intersection,filter,makeCid,safeForJson,isRegexp;if(!TAFFY){version="2.7";TC=1;idpad="000000";cmax=1E3;API={};protectJSON=function(t){if(TAFFY.isArray(t)||TAFFY.isObject(t))return t;else return JSON.parse(t)};intersection=function(array1,array2){return filter(array1,function(item){return array2.indexOf(item)>=0})};filter=function(obj,iterator,
context){var results=[];if(obj==null)return results;if(Array.prototype.filter&&obj.filter===Array.prototype.filter)return obj.filter(iterator,context);each(obj,function(value,index,list){if(iterator.call(context,value,index,list))results[results.length]=value});return results};isRegexp=function(aObj){return Object.prototype.toString.call(aObj)==="[object RegExp]"};safeForJson=function(aObj){var myResult=T.isArray(aObj)?[]:T.isObject(aObj)?{}:null;if(aObj===null)return aObj;for(var i in aObj)myResult[i]=
isRegexp(aObj[i])?aObj[i].toString():T.isArray(aObj[i])||T.isObject(aObj[i])?safeForJson(aObj[i]):aObj[i];return myResult};makeCid=function(aContext){var myCid=JSON.stringify(aContext);if(myCid.match(/regex/)===null)return myCid;return JSON.stringify(safeForJson(aContext))};each=function(a,fun,u){var r,i,x,y;if(a&&(T.isArray(a)&&a.length===1||!T.isArray(a)))fun(T.isArray(a)?a[0]:a,0);else for(r,i,x=0,a=T.isArray(a)?a:[a],y=a.length;x<y;x++){i=a[x];if(!T.isUndefined(i)||(u||false)){r=fun(i,x);if(r===
T.EXIT)break}}};eachin=function(o,fun){var x=0,r,i;for(i in o)if(o.hasOwnProperty(i)){r=fun(o[i],i,x++);if(r===T.EXIT)break}};API.extend=function(m,f){API[m]=function(){return f.apply(this,arguments)}};isIndexable=function(f){var i;if(T.isString(f)&&/[t][0-9]*[r][0-9]*/i.test(f))return true;if(T.isObject(f)&&f.___id&&f.___s)return true;if(T.isArray(f)){i=true;each(f,function(r){if(!isIndexable(r)){i=false;return TAFFY.EXIT}});return i}return false};runFilters=function(r,filter){var match=true;each(filter,
function(mf){switch(T.typeOf(mf)){case "function":if(!mf.apply(r)){match=false;return TAFFY.EXIT}break;case "array":match=mf.length===1?runFilters(r,mf[0]):mf.length===2?runFilters(r,mf[0])||runFilters(r,mf[1]):mf.length===3?runFilters(r,mf[0])||runFilters(r,mf[1])||runFilters(r,mf[2]):mf.length===4?runFilters(r,mf[0])||runFilters(r,mf[1])||runFilters(r,mf[2])||runFilters(r,mf[3]):false;if(mf.length>4)each(mf,function(f){if(runFilters(r,f))match=true});break}});return match};returnFilter=function(f){var nf=
[];if(T.isString(f)&&/[t][0-9]*[r][0-9]*/i.test(f))f={___id:f};if(T.isArray(f)){each(f,function(r){nf.push(returnFilter(r))});f=function(){var that=this,match=false;each(nf,function(f){if(runFilters(that,f))match=true});return match};return f}if(T.isObject(f)){if(T.isObject(f)&&f.___id&&f.___s)f={___id:f.___id};eachin(f,function(v,i){if(!T.isObject(v))v={"is":v};eachin(v,function(mtest,s){var c=[],looper;looper=s==="hasAll"?function(mtest,func){func(mtest)}:each;looper(mtest,function(mtest){var su=
true,f=false,matchFunc;matchFunc=function(){var mvalue=this[i],eqeq="\x3d\x3d",bangeq="!\x3d",eqeqeq="\x3d\x3d\x3d",lt="\x3c",gt="\x3e",lteq="\x3c\x3d",gteq="\x3e\x3d",bangeqeq="!\x3d\x3d",r;if(typeof mvalue==="undefined")return false;if(s.indexOf("!")===0&&s!==bangeq&&s!==bangeqeq){su=false;s=s.substring(1,s.length)}r=s==="regex"?mtest.test(mvalue):s==="lt"||s===lt?mvalue<mtest:s==="gt"||s===gt?mvalue>mtest:s==="lte"||s===lteq?mvalue<=mtest:s==="gte"||s===gteq?mvalue>=mtest:s==="left"?mvalue.indexOf(mtest)===
0:s==="leftnocase"?mvalue.toLowerCase().indexOf(mtest.toLowerCase())===0:s==="right"?mvalue.substring(mvalue.length-mtest.length)===mtest:s==="rightnocase"?mvalue.toLowerCase().substring(mvalue.length-mtest.length)===mtest.toLowerCase():s==="like"?mvalue.indexOf(mtest)>=0:s==="likenocase"?mvalue.toLowerCase().indexOf(mtest.toLowerCase())>=0:s===eqeqeq||s==="is"?mvalue===mtest:s===eqeq?mvalue==mtest:s===bangeqeq?mvalue!==mtest:s===bangeq?mvalue!=mtest:s==="isnocase"?mvalue.toLowerCase?mvalue.toLowerCase()===
mtest.toLowerCase():mvalue===mtest:s==="has"?T.has(mvalue,mtest):s==="hasall"?T.hasAll(mvalue,mtest):s==="contains"?TAFFY.isArray(mvalue)&&mvalue.indexOf(mtest)>-1:s.indexOf("is")===-1&&!TAFFY.isNull(mvalue)&&!TAFFY.isUndefined(mvalue)&&!TAFFY.isObject(mtest)&&!TAFFY.isArray(mtest)?mtest===mvalue[s]:T[s]&&T.isFunction(T[s])&&s.indexOf("is")===0?T[s](mvalue)===mtest:T[s]&&T.isFunction(T[s])?T[s](mvalue,mtest):false;r=r&&!su?false:!r&&!su?true:r;return r};c.push(matchFunc)});if(c.length===1)nf.push(c[0]);
else nf.push(function(){var that=this,match=false;each(c,function(f){if(f.apply(that))match=true});return match})})});f=function(){var that=this,match=true;match=nf.length===1&&!nf[0].apply(that)?false:nf.length===2&&(!nf[0].apply(that)||!nf[1].apply(that))?false:nf.length===3&&(!nf[0].apply(that)||!nf[1].apply(that)||!nf[2].apply(that))?false:nf.length===4&&(!nf[0].apply(that)||!nf[1].apply(that)||!nf[2].apply(that)||!nf[3].apply(that))?false:true;if(nf.length>4)each(nf,function(f){if(!runFilters(that,
f))match=false});return match};return f}if(T.isFunction(f))return f};orderByCol=function(ar,o){var sortFunc=function(a,b){var r=0;T.each(o,function(sd){var o,col,dir,c,d;o=sd.split(" ");col=o[0];dir=o.length===1?"logical":o[1];if(dir==="logical"){c=numcharsplit(a[col]);d=numcharsplit(b[col]);T.each(c.length<=d.length?c:d,function(x,i){if(c[i]<d[i]){r=-1;return TAFFY.EXIT}else if(c[i]>d[i]){r=1;return TAFFY.EXIT}})}else if(dir==="logicaldesc"){c=numcharsplit(a[col]);d=numcharsplit(b[col]);T.each(c.length<=
d.length?c:d,function(x,i){if(c[i]>d[i]){r=-1;return TAFFY.EXIT}else if(c[i]<d[i]){r=1;return TAFFY.EXIT}})}else if(dir==="asec"&&a[col]<b[col]){r=-1;return T.EXIT}else if(dir==="asec"&&a[col]>b[col]){r=1;return T.EXIT}else if(dir==="desc"&&a[col]>b[col]){r=-1;return T.EXIT}else if(dir==="desc"&&a[col]<b[col]){r=1;return T.EXIT}if(r===0&&dir==="logical"&&c.length<d.length)r=-1;else if(r===0&&dir==="logical"&&c.length>d.length)r=1;else if(r===0&&dir==="logicaldesc"&&c.length>d.length)r=-1;else if(r===
0&&dir==="logicaldesc"&&c.length<d.length)r=1;if(r!==0)return T.EXIT});return r};return ar&&ar.push?ar.sort(sortFunc):ar};(function(){var cache={},cachcounter=0;numcharsplit=function(thing){if(cachcounter>cmax){cache={};cachcounter=0}return cache["_"+thing]||function(){var nthing=String(thing),na=[],rv="_",rt="",x,xx,c;for(x=0,xx=nthing.length;x<xx;x++){c=nthing.charCodeAt(x);if(c>=48&&c<=57||c===46){if(rt!=="n"){rt="n";na.push(rv.toLowerCase());rv=""}rv=rv+nthing.charAt(x)}else{if(rt!=="s"){rt="s";
na.push(parseFloat(rv));rv=""}rv=rv+nthing.charAt(x)}}na.push(rt==="n"?parseFloat(rv):rv.toLowerCase());na.shift();cache["_"+thing]=na;cachcounter++;return na}()}})();run=function(){this.context({results:this.getDBI().query(this.context())})};API.extend("filter",function(){var nc=TAFFY.mergeObj(this.context(),{run:null}),nq=[];each(nc.q,function(v){nq.push(v)});nc.q=nq;each(arguments,function(f){nc.q.push(returnFilter(f));nc.filterRaw.push(f)});return this.getroot(nc)});API.extend("order",function(o){o=
o.split(",");var x=[],nc;each(o,function(r){x.push(r.replace(/^\s*/,"").replace(/\s*$/,""))});nc=TAFFY.mergeObj(this.context(),{sort:null});nc.order=x;return this.getroot(nc)});API.extend("limit",function(n){var nc=TAFFY.mergeObj(this.context(),{}),limitedresults;nc.limit=n;if(nc.run&&nc.sort){limitedresults=[];each(nc.results,function(i,x){if(x+1>n)return TAFFY.EXIT;limitedresults.push(i)});nc.results=limitedresults}return this.getroot(nc)});API.extend("start",function(n){var nc=TAFFY.mergeObj(this.context(),
{}),limitedresults;nc.start=n;if(nc.run&&nc.sort&&!nc.limit){limitedresults=[];each(nc.results,function(i,x){if(x+1>n)limitedresults.push(i)});nc.results=limitedresults}else nc=TAFFY.mergeObj(this.context(),{run:null,start:n});return this.getroot(nc)});API.extend("update",function(arg0,arg1,arg2){var runEvent=true,o={},args=arguments,that;if(TAFFY.isString(arg0)&&(arguments.length===2||arguments.length===3)){o[arg0]=arg1;if(arguments.length===3)runEvent=arg2}else{o=arg0;if(args.length===2)runEvent=
arg1}that=this;run.call(this);each(this.context().results,function(r){var c=o;if(TAFFY.isFunction(c))c=c.apply(TAFFY.mergeObj(r,{}));else if(T.isFunction(c))c=c(TAFFY.mergeObj(r,{}));if(TAFFY.isObject(c))that.getDBI().update(r.___id,c,runEvent)});if(this.context().results.length)this.context({run:null});return this});API.extend("remove",function(runEvent){var that=this,c=0;run.call(this);each(this.context().results,function(r){that.getDBI().remove(r.___id);c++});if(this.context().results.length){this.context({run:null});
that.getDBI().removeCommit(runEvent)}return c});API.extend("count",function(){run.call(this);return this.context().results.length});API.extend("callback",function(f,delay){if(f){var that=this;setTimeout(function(){run.call(that);f.call(that.getroot(that.context()))},delay||0)}return null});API.extend("get",function(){run.call(this);return this.context().results});API.extend("stringify",function(){return JSON.stringify(this.get())});API.extend("first",function(){run.call(this);return this.context().results[0]||
false});API.extend("last",function(){run.call(this);return this.context().results[this.context().results.length-1]||false});API.extend("sum",function(){var total=0,that=this;run.call(that);each(arguments,function(c){each(that.context().results,function(r){total=total+(r[c]||0)})});return total});API.extend("min",function(c){var lowest=null;run.call(this);each(this.context().results,function(r){if(lowest===null||r[c]<lowest)lowest=r[c]});return lowest});(function(){var innerJoinFunction=function(){var fnCompareList,
fnCombineRow,fnMain;fnCompareList=function(left_row,right_row,arg_list){var data_lt,data_rt,op_code,error;if(arg_list.length===2){data_lt=left_row[arg_list[0]];op_code="\x3d\x3d\x3d";data_rt=right_row[arg_list[1]]}else{data_lt=left_row[arg_list[0]];op_code=arg_list[1];data_rt=right_row[arg_list[2]]}switch(op_code){case "\x3d\x3d\x3d":return data_lt===data_rt;case "!\x3d\x3d":return data_lt!==data_rt;case "\x3c":return data_lt<data_rt;case "\x3e":return data_lt>data_rt;case "\x3c\x3d":return data_lt<=
data_rt;case "\x3e\x3d":return data_lt>=data_rt;case "\x3d\x3d":return data_lt==data_rt;case "!\x3d":return data_lt!=data_rt;default:throw String(op_code)+" is not supported";}};fnCombineRow=function(left_row,right_row){var out_map={},i,prefix;for(i in left_row)if(left_row.hasOwnProperty(i))out_map[i]=left_row[i];for(i in right_row)if(right_row.hasOwnProperty(i)&&i!=="___id"&&i!=="___s"){prefix=!TAFFY.isUndefined(out_map[i])?"right_":"";out_map[prefix+String(i)]=right_row[i]}return out_map};fnMain=
function(table){var right_table,i,arg_list=arguments,arg_length=arg_list.length,result_list=[];if(typeof table.filter!=="function")if(table.TAFFY)right_table=table();else throw"TAFFY DB or result not supplied";else right_table=table;this.context({results:this.getDBI().query(this.context())});TAFFY.each(this.context().results,function(left_row){right_table.each(function(right_row){var arg_data,is_ok=true;CONDITION:for(i=1;i<arg_length;i++){arg_data=arg_list[i];if(typeof arg_data==="function")is_ok=
arg_data(left_row,right_row);else if(typeof arg_data==="object"&&arg_data.length)is_ok=fnCompareList(left_row,right_row,arg_data);else is_ok=false;if(!is_ok)break CONDITION}if(is_ok)result_list.push(fnCombineRow(left_row,right_row))})});return TAFFY(result_list)()};return fnMain}();API.extend("join",innerJoinFunction)})();API.extend("max",function(c){var highest=null;run.call(this);each(this.context().results,function(r){if(highest===null||r[c]>highest)highest=r[c]});return highest});API.extend("select",
function(){var ra=[],args=arguments;run.call(this);if(arguments.length===1)each(this.context().results,function(r){ra.push(r[args[0]])});else each(this.context().results,function(r){var row=[];each(args,function(c){row.push(r[c])});ra.push(row)});return ra});API.extend("distinct",function(){var ra=[],args=arguments;run.call(this);if(arguments.length===1)each(this.context().results,function(r){var v=r[args[0]],dup=false;each(ra,function(d){if(v===d){dup=true;return TAFFY.EXIT}});if(!dup)ra.push(v)});
else each(this.context().results,function(r){var row=[],dup=false;each(args,function(c){row.push(r[c])});each(ra,function(d){var ldup=true;each(args,function(c,i){if(row[i]!==d[i]){ldup=false;return TAFFY.EXIT}});if(ldup){dup=true;return TAFFY.EXIT}});if(!dup)ra.push(row)});return ra});API.extend("supplant",function(template,returnarray){var ra=[];run.call(this);each(this.context().results,function(r){ra.push(template.replace(/\{([^\{\}]*)\}/g,function(a,b){var v=r[b];return typeof v==="string"||
typeof v==="number"?v:a}))});return!returnarray?ra.join(""):ra});API.extend("each",function(m){run.call(this);each(this.context().results,m);return this});API.extend("map",function(m){var ra=[];run.call(this);each(this.context().results,function(r){ra.push(m(r))});return ra});T=function(d){var TOb=[],ID={},RC=1,settings={template:false,onInsert:false,onUpdate:false,onRemove:false,onDBChange:false,storageName:false,forcePropertyCase:null,cacheSize:100,name:""},dm=new Date,CacheCount=0,CacheClear=0,
Cache={},DBI,runIndexes,root;runIndexes=function(indexes){var records=[],UniqueEnforce=false;if(indexes.length===0)return TOb;each(indexes,function(f){if(T.isString(f)&&/[t][0-9]*[r][0-9]*/i.test(f)&&TOb[ID[f]]){records.push(TOb[ID[f]]);UniqueEnforce=true}if(T.isObject(f)&&f.___id&&f.___s&&TOb[ID[f.___id]]){records.push(TOb[ID[f.___id]]);UniqueEnforce=true}if(T.isArray(f))each(f,function(r){each(runIndexes(r),function(rr){records.push(rr)})})});if(UniqueEnforce&&records.length>1)records=[];return records};
DBI={dm:function(nd){if(nd){dm=nd;Cache={};CacheCount=0;CacheClear=0}if(settings.onDBChange)setTimeout(function(){settings.onDBChange.call(TOb)},0);if(settings.storageName)setTimeout(function(){localStorage.setItem("taffy_"+settings.storageName,JSON.stringify(TOb))});return dm},insert:function(i,runEvent){var columns=[],records=[],input=protectJSON(i);each(input,function(v,i){var nv,o;if(T.isArray(v)&&i===0){each(v,function(av){columns.push(settings.forcePropertyCase==="lower"?av.toLowerCase():settings.forcePropertyCase===
"upper"?av.toUpperCase():av)});return true}else if(T.isArray(v)){nv={};each(v,function(av,ai){nv[columns[ai]]=av});v=nv}else if(T.isObject(v)&&settings.forcePropertyCase){o={};eachin(v,function(av,ai){o[settings.forcePropertyCase==="lower"?ai.toLowerCase():settings.forcePropertyCase==="upper"?ai.toUpperCase():ai]=v[ai]});v=o}RC++;v.___id="T"+String(idpad+TC).slice(-6)+"R"+String(idpad+RC).slice(-6);v.___s=true;records.push(v.___id);if(settings.template)v=T.mergeObj(settings.template,v);TOb.push(v);
ID[v.___id]=TOb.length-1;if(settings.onInsert&&(runEvent||TAFFY.isUndefined(runEvent)))settings.onInsert.call(v);DBI.dm(new Date)});return root(records)},sort:function(o){TOb=orderByCol(TOb,o.split(","));ID={};each(TOb,function(r,i){ID[r.___id]=i});DBI.dm(new Date);return true},update:function(id,changes,runEvent){var nc={},or,nr,tc,hasChange;if(settings.forcePropertyCase){eachin(changes,function(v,p){nc[settings.forcePropertyCase==="lower"?p.toLowerCase():settings.forcePropertyCase==="upper"?p.toUpperCase():
p]=v});changes=nc}or=TOb[ID[id]];nr=T.mergeObj(or,changes);tc={};hasChange=false;eachin(nr,function(v,i){if(TAFFY.isUndefined(or[i])||or[i]!==v){tc[i]=v;hasChange=true}});if(hasChange){if(settings.onUpdate&&(runEvent||TAFFY.isUndefined(runEvent)))settings.onUpdate.call(nr,TOb[ID[id]],tc);TOb[ID[id]]=nr;DBI.dm(new Date)}},remove:function(id){TOb[ID[id]].___s=false},removeCommit:function(runEvent){var x;for(x=TOb.length-1;x>-1;x--)if(!TOb[x].___s){if(settings.onRemove&&(runEvent||TAFFY.isUndefined(runEvent)))settings.onRemove.call(TOb[x]);
ID[TOb[x].___id]=undefined;TOb.splice(x,1)}ID={};each(TOb,function(r,i){ID[r.___id]=i});DBI.dm(new Date)},query:function(context){var returnq,cid,results,indexed,limitq,ni;if(settings.cacheSize){cid="";each(context.filterRaw,function(r){if(T.isFunction(r)){cid="nocache";return TAFFY.EXIT}});if(cid==="")cid=makeCid(T.mergeObj(context,{q:false,run:false,sort:false}))}if(!context.results||!context.run||context.run&&DBI.dm()>context.run){results=[];if(settings.cacheSize&&Cache[cid]){Cache[cid].i=CacheCount++;
return Cache[cid].results}else if(context.q.length===0&&context.index.length===0){each(TOb,function(r){results.push(r)});returnq=results}else{indexed=runIndexes(context.index);each(indexed,function(r){if(context.q.length===0||runFilters(r,context.q))results.push(r)});returnq=results}}else returnq=context.results;if(context.order.length>0&&(!context.run||!context.sort))returnq=orderByCol(returnq,context.order);if(returnq.length&&(context.limit&&context.limit<returnq.length||context.start)){limitq=
[];each(returnq,function(r,i){if(!context.start||context.start&&i+1>=context.start)if(context.limit){ni=context.start?i+1-context.start:i;if(ni<context.limit)limitq.push(r);else if(ni>context.limit)return TAFFY.EXIT}else limitq.push(r)});returnq=limitq}if(settings.cacheSize&&cid!=="nocache"){CacheClear++;setTimeout(function(){var bCounter,nc;if(CacheClear>=settings.cacheSize*2){CacheClear=0;bCounter=CacheCount-settings.cacheSize;nc={};eachin(function(r,k){if(r.i>=bCounter)nc[k]=r});Cache=nc}},0);
Cache[cid]={i:CacheCount++,results:returnq}}return returnq}};root=function(){var iAPI,context;iAPI=TAFFY.mergeObj(TAFFY.mergeObj(API,{insert:undefined}),{getDBI:function(){return DBI},getroot:function(c){return root.call(c)},context:function(n){if(n)context=TAFFY.mergeObj(context,n.hasOwnProperty("results")?TAFFY.mergeObj(n,{run:new Date,sort:new Date}):n);return context},extend:undefined});context=this&&this.q?this:{limit:false,start:false,q:[],filterRaw:[],index:[],order:[],results:false,run:null,
sort:null,settings:settings};each(arguments,function(f){if(isIndexable(f))context.index.push(f);else context.q.push(returnFilter(f));context.filterRaw.push(f)});return iAPI};TC++;if(d)DBI.insert(d);root.insert=DBI.insert;root.merge=function(i,key,runEvent){var search={},finalSearch=[],obj={};runEvent=runEvent||false;key=key||"id";each(i,function(o){var existingObject;search[key]=o[key];finalSearch.push(o[key]);existingObject=root(search).first();if(existingObject)DBI.update(existingObject.___id,o,
runEvent);else DBI.insert(o,runEvent)});obj[key]=finalSearch;return root(obj)};root.TAFFY=true;root.sort=DBI.sort;root.settings=function(n){if(n){settings=TAFFY.mergeObj(settings,n);if(n.template)root().update(n.template)}return settings};root.store=function(n){var r=false,i;if(localStorage){if(n){i=localStorage.getItem("taffy_"+n);if(i&&i.length>0){root.insert(i);r=true}if(TOb.length>0)setTimeout(function(){localStorage.setItem("taffy_"+settings.storageName,JSON.stringify(TOb))})}root.settings({storageName:n})}return root};
return root};TAFFY=T;T.each=each;T.eachin=eachin;T.extend=API.extend;TAFFY.EXIT="TAFFYEXIT";TAFFY.mergeObj=function(ob1,ob2){var c={};eachin(ob1,function(v,n){c[n]=ob1[n]});eachin(ob2,function(v,n){c[n]=ob2[n]});return c};TAFFY.has=function(var1,var2){var re=false,n;if(var1.TAFFY){re=var1(var2);if(re.length>0)return true;else return false}else switch(T.typeOf(var1)){case "object":if(T.isObject(var2))eachin(var2,function(v,n){if(re===true&&!T.isUndefined(var1[n])&&var1.hasOwnProperty(n))re=T.has(var1[n],
var2[n]);else{re=false;return TAFFY.EXIT}});else if(T.isArray(var2))each(var2,function(v,n){re=T.has(var1,var2[n]);if(re)return TAFFY.EXIT});else if(T.isString(var2))if(!TAFFY.isUndefined(var1[var2]))return true;else return false;return re;case "array":if(T.isObject(var2))each(var1,function(v,i){re=T.has(var1[i],var2);if(re===true)return TAFFY.EXIT});else if(T.isArray(var2))each(var2,function(v2,i2){each(var1,function(v1,i1){re=T.has(var1[i1],var2[i2]);if(re===true)return TAFFY.EXIT});if(re===true)return TAFFY.EXIT});
else if(T.isString(var2)||T.isNumber(var2)){re=false;for(n=0;n<var1.length;n++){re=T.has(var1[n],var2);if(re)return true}}return re;case "string":if(T.isString(var2)&&var2===var1)return true;break;default:if(T.typeOf(var1)===T.typeOf(var2)&&var1===var2)return true;break}return false};TAFFY.hasAll=function(var1,var2){var T=TAFFY,ar;if(T.isArray(var2)){ar=true;each(var2,function(v){ar=T.has(var1,v);if(ar===false)return TAFFY.EXIT});return ar}else return T.has(var1,var2)};TAFFY.typeOf=function(v){var s=
typeof v;if(s==="object")if(v){if(typeof v.length==="number"&&!v.propertyIsEnumerable("length"))s="array"}else s="null";return s};TAFFY.getObjectKeys=function(ob){var kA=[];eachin(ob,function(n,h){kA.push(h)});kA.sort();return kA};TAFFY.isSameArray=function(ar1,ar2){return TAFFY.isArray(ar1)&&TAFFY.isArray(ar2)&&ar1.join(",")===ar2.join(",")?true:false};TAFFY.isSameObject=function(ob1,ob2){var T=TAFFY,rv=true;if(T.isObject(ob1)&&T.isObject(ob2))if(T.isSameArray(T.getObjectKeys(ob1),T.getObjectKeys(ob2)))eachin(ob1,
function(v,n){if(!(T.isObject(ob1[n])&&T.isObject(ob2[n])&&T.isSameObject(ob1[n],ob2[n])||T.isArray(ob1[n])&&T.isArray(ob2[n])&&T.isSameArray(ob1[n],ob2[n])||ob1[n]===ob2[n])){rv=false;return TAFFY.EXIT}});else rv=false;else rv=false;return rv};typeList=["String","Number","Object","Array","Boolean","Null","Function","Undefined"];makeTest=function(thisKey){return function(data){return TAFFY.typeOf(data)===thisKey.toLowerCase()?true:false}};for(idx=0;idx<typeList.length;idx++){typeKey=typeList[idx];
TAFFY["is"+typeKey]=makeTest(typeKey)}}})();if(typeof exports==="object")exports.taffy=TAFFY;angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/taobao-orders",{controller:"TaobaoOrdersController",templateUrl:"app/src/app/taobao_data/order/taobaoOrders.html"})}]);
angular.module("IOne-Production").controller("TaobaoOrdersController",function($scope,$q,TaobaoOrders,TaobaoOrderDetail,TaobaoAmountMaster,TaobaoAmountDetail,$mdDialog,$timeout,Constant){$scope.taobaoOrderListMenu={selectAll:false,effectiveType:"2",taobao_status:Constant.TAOBAO_STATUS["WAIT_SELLER_SEND_GOODS"].value,seller_flag:Constant.SELLER_FLAG[0].value,showQueryBar:true,confirm:Constant.CONFIRM[1].value,dateType:"created",employeeID:"",buyerNick:"",orderFlag:Constant.ORDER_FLAG[0].value,orderId:""};
$scope.taobaoFormMenuDisplayOption={"107-change":{display:true,name:"变更",uuid:""},"108-changehistory":{display:true,name:"变更记录查询",uuid:""}};$scope.taobaoOrderListMenuDisplayOption={"400-selectAll":{display:true,name:"全选",uuid:"402B9BF7-665E-4929-B8D8-95775ADAF0E1"},"403-throw":{display:true,name:"审核",uuid:"977D4805-33DD-440A-9E57-5CE9623B6603"},"405-query":{display:true,name:"查询",uuid:"FEB54F9A-D4B3-432B-ACAF-78DBE0D0A49A"},"407-merge":{display:true,name:"合并",uuid:"BC6C29F5-0772-4041-8CAD-EA66C60C533D"},
"408-unConfirm":{display:true,name:"取消审核",uuid:"91E1EB8B-6094-4B75-9937-6DCB9D0ED6D4"},"409-delivery":{display:true,name:"发货",uuid:"91E1EB8B-6094-4B75-9937-6DCB9D0ED6D4"}};$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listTabSelected=function(){$scope.taobaoOrderListMenu.showQueryBar=true;$scope.taobaoOrderListMenuDisplayOption["400-selectAll"].display=true;$scope.queryMenuAction();$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS,0);$scope.getMenuAuthData($scope.RES_UUID_MAP.EPS.ORDERS.LIST_PAGE.RES_UUID).success(function(data){$scope.menuAuthDataMap=
$scope.menuDataMap(data)})};$scope.resetInitialValue=function(){$scope.selectedItem=null;$scope.selectedItemsCount=0;$scope.selectedItemsTotalPrice=0;$scope.resetButtonDisabled()};$scope.resetButtonDisabled=function(){$scope.effectiveType_disabled=0;$scope.return_button_disabled=0;$scope.audit_button_disabled=0;$scope.throw_button_disabled=0;$scope.revert_audit_button_disabled=0;$scope.throw_button_disabled=0};$scope.queryMenuAction=function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=
100;$scope.pageOption.totalElements=100;$scope.queryMenuActionWithPaging()};$scope.queryMenuActionWithPaging=function(){$scope.selectedItem=null;$scope.selected=[];$scope.selectedItemsCount=0;$scope.selectedItemsTotalPrice=0;$scope.taobaoOrderListMenu.selectAll=false;$scope.taobaoOrderListMenu.effectiveType="2";$scope.resetInitialValue();if($scope.taobaoOrderListMenu.startDate!==undefined&&$scope.taobaoOrderListMenu.startDate!==null)if($scope.taobaoOrderListMenu.dateType=="created"){createdBegin=
new Date($scope.taobaoOrderListMenu.startDate);createdBegin=moment(createdBegin).format("YYYY-MM-DD");payTimeBegin=null}else{payTimeBegin=new Date($scope.taobaoOrderListMenu.startDate);payTimeBegin=moment(payTimeBegin).format("YYYY-MM-DD");createdBegin=null}else{createdBegin=null;payTimeBegin=null}if($scope.taobaoOrderListMenu.endDate!==undefined&&$scope.taobaoOrderListMenu.endDate!==null)if($scope.taobaoOrderListMenu.dateType=="created"){createdEnd=new Date($scope.taobaoOrderListMenu.endDate);createdEnd=
moment(createdEnd).format("YYYY-MM-DD");payTimeEnd=null}else{payTimeEnd=new Date($scope.taobaoOrderListMenu.endDate);payTimeEnd=moment(payTimeEnd).format("YYYY-MM-DD");createdEnd=null}else{createdEnd=null;payTimeEnd=null}if($scope.taobaoOrderListMenu.buyerNick!==undefined&&$scope.taobaoOrderListMenu.buyerNick!=="")buyerNick=$scope.taobaoOrderListMenu.buyerNick;else buyerNick=null;if($scope.taobaoOrderListMenu.orderId!==undefined&&$scope.taobaoOrderListMenu.orderId!=="")tid=$scope.taobaoOrderListMenu.orderId;
else tid=null;if($scope.taobaoOrderListMenu.employeeID!==undefined&&$scope.taobaoOrderListMenu.employeeID!=="")employeeID=$scope.taobaoOrderListMenu.employeeID;else employeeID=null;taobaoStatus=$scope.taobaoOrderListMenu.taobao_status;sellerFlag=$scope.taobaoOrderListMenu.seller_flag;confirm=$scope.taobaoOrderListMenu.confirm;orderFlag=$scope.taobaoOrderListMenu.orderFlag;TaobaoOrders.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,employeeID,buyerNick,orderFlag,tid,taobaoStatus,
sellerFlag,confirm,createdBegin,createdEnd,payTimeBegin,payTimeEnd,RES_UUID_MAP.EPS.ORDERS.LIST_PAGE.RES_UUID,$scope.taobaoOrderListMenu.buyerMessage,$scope.taobaoOrderListMenu.sellerMemo).success(function(data){$scope.OrderMasterList=data;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;if($scope.OrderMasterList.content.length>0)angular.forEach($scope.OrderMasterList.content,function(orderMaster,index){TaobaoOrderDetail.get(orderMaster.uuid).success(function(data){$scope.OrderMasterList.content[index].orderDetailList=
data.content});TaobaoAmountMaster.get(orderMaster.uuid).success(function(data){if(data.content.length>0)TaobaoAmountDetail.get(data.content[0].uuid).success(function(data){if(data.content.length>0)$scope.OrderMasterList.content[index].amountDetailList=data.content})})})})};$scope.selected=[];$scope.selectedItemsCount=0;$scope.selectedItemsTotalPrice=0;$scope.toggle=function(item,selected){var idx=selected.indexOf(item);if(idx>-1)selected.splice(idx,1);else selected.push(item);$scope.taobaoOrderListMenu.effectiveType=
item.status;$scope.resetInitialValue();$scope.changeButtonStatusAndCalTotalPrice();$scope.selectedItemsTotalPrice=$scope.selectedItemsTotalPrice.toFixed(2);$scope.selectedItemsCount=selected.length};$scope.changeButtonStatusAndCalTotalPrice=function(){angular.forEach($scope.selected,function(orderMaster){$scope.selectedItemsTotalPrice=$scope.selectedItemsTotalPrice+orderMaster.payment;$scope.changeButtonStatus(orderMaster)})};$scope.changeButtonStatus=function(orderMaster){if(orderMaster.confirm==
2)$scope.audit_button_disabled=1;if(!(orderMaster.confirm==2))$scope.revert_audit_button_disabled=1};$scope.exists=function(item,list){return list.indexOf(item)>-1};$scope.selectAllMenuAction=function(){if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0)if($scope.taobaoOrderListMenu.selectAll==true){angular.forEach($scope.OrderMasterList.content,function(item){var idx=$scope.selected.indexOf(item);if(idx<0)$scope.selected.push(item)});$scope.resetInitialValue();$scope.changeButtonStatusAndCalTotalPrice();
$scope.selectedItemsTotalPrice=$scope.selectedItemsTotalPrice.toFixed(2);$scope.selectedItemsCount=$scope.selected.length}else if($scope.taobaoOrderListMenu.selectAll==false){$scope.selected=[];$scope.taobaoOrderListMenu.effectiveType="1";$scope.resetInitialValue()}};$scope.editItem=function(orderMaster){$scope.selectedDetail=[];$scope.taobaoOrderListMenu.selectAll=false;$scope.selectedItem=orderMaster;$scope.changeViewStatus(Constant.UI_STATUS.PRE_EDIT_UI_STATUS,1);$scope.resetButtonDisabled()};
$scope.effectiveMenuAction=function(){};$scope.auditMenuAction=function(){};$scope.revertAuditMenuAction=function(){};$scope.getOrderDtl=function(){};$scope.mergeMenuAuction=function(){if($scope.selected.length>0){var uuids=[];angular.forEach($scope.selected,function(item){uuids.push(item.uuid)});TaobaoOrders.merge(uuids).success(function(){$scope.queryMenuActionWithPaging();$scope.showInfo("合并订单成功。")}).error(function(){$scope.showError("合并订单失败。")})}else $scope.showWarn("请先选择待合并的订单。")};$scope.throwMenuAction=
function(){if($scope.selected.length==1)$scope.showConfirm("确认审核吗？","",function(){if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){var orderMasterUuids="";var rtn=false;angular.forEach($scope.selected,function(item){if(item.status!="WAIT_SELLER_SEND_GOODS"){$scope.showError("只有买家已付款等待卖家发货的订单才可以审核");rtn=true;return}orderMasterUuids=orderMasterUuids+item.uuid+","});if(rtn==true)return;orderMasterUuids=orderMasterUuids.substr(0,orderMasterUuids.length-1);console.info(orderMasterUuids);
var OrderMasterUpdateInput={uuid:orderMasterUuids,confirm:"2"};var response=TaobaoOrders.modify(OrderMasterUpdateInput).success(function(){$scope.queryMenuActionWithPaging();$scope.showInfo("审核成功，数据已刷新")}).error(function(data){$scope.showError(data.message)})}else $scope.showError("请检查")});else $scope.showError("请选单笔审核。")};$scope.unConfirmMenuAction=function(){if($scope.selected&&$scope.selected.length>0){var uuids=[];var hasConfirmedTrade=false;angular.forEach($scope.selected,function(item){uuids.push(item.uuid);
if(item.confirm=="1")hasConfirmedTrade=true});if(hasConfirmedTrade){$scope.showError("请选择所有已审核的交易。");return}TaobaoOrders.cancelConfirm(uuids).success(function(data){var allSuccess=true;angular.forEach(Object.keys(data),function(item){if(data[item]==false)allSuccess=false});if(allSuccess)$scope.showInfo("取消审核成功，数据已刷新");else if(Object.keys(data).length==1)$scope.showError("取消审核失败.");else $scope.showWarn("部分取消审核成功，数据已刷新.");$scope.queryMenuActionWithPaging()}).error(function(){$scope.showError("取消审核失败。")})}else $scope.showWarn("请选择待取消审核的交易。")};
$scope.deliveryMenuAction=function(){if($scope.selected.length>1)$scope.showWarn("发货操作只允许选择一个订单");else if($scope.selected.length==1)$mdDialog.show({locals:{tid:$scope.selected[0].tid},controller:"TaobaoOrdersDeliveryController",templateUrl:"app/src/app/taobao_data/order/taobaoOrderDelivery.html",parent:angular.element(document.body),targetEvent:event}).then(function(data){$scope.deliveryInput=data;$scope.deliveryInput.uuid=$scope.selected[0].uuid;TaobaoOrders.delivery($scope.deliveryInput).success(function(response){if(response.success)$scope.showInfo("订单发货成功");
else $scope.showError("订单发货失败"+response.message)}).error(function(response){$scope.showError("订单发货失败: "+response.message)})});else $scope.showWarn("请选择一个订单")}});
angular.module("IOne-Production").controller("TaobaoOrdersDeliveryController",function($scope,$mdDialog,tid){$scope.deliveryInput={tid:tid};$scope.hideDlg=function(){if($scope.deliveryInput.companyCode==null)toastr["error"]("物流公司编码为空");else if($scope.deliveryInput.outSid==null)toastr["error"]("物流单号为空");else $mdDialog.hide($scope.deliveryInput)};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").service("TaobaoOrders",function($http,Constant){this.getAll=function(sizePerPage,page,employeeID,buyerNick,orderFlag,tid,taobaoStatus,sellerFlag,confirm,createdBegin,createdEnd,payTimeBegin,payTimeEnd,resUuid,buyerMessage,sellerMemo){taobaoStatus=taobaoStatus==0?"":taobaoStatus;sellerFlag=sellerFlag==0?"":sellerFlag;confirm=confirm==0?"":confirm;orderFlag=orderFlag==0?"":orderFlag;var url="taobaoTrades?size\x3d"+sizePerPage+"\x26page\x3d"+page+"\x26confirm\x3d"+confirm+
"\x26taobaoStatus\x3d"+taobaoStatus+"\x26orderFlag\x3d"+orderFlag+"\x26sellerFlag\x3d"+sellerFlag;if(employeeID!==null&&employeeID!=="")url=url+"\x26employeeNo\x3d"+employeeID;if(buyerNick!==null)url=url+"\x26buyerNick\x3d"+buyerNick;if(tid!==null)url=url+"\x26tid\x3d"+tid;if(createdBegin!==null)url=url+"\x26createdBegin\x3d"+createdBegin;if(createdEnd!==null)url=url+"\x26createdEnd\x3d"+createdEnd;if(payTimeBegin!==null)url=url+"\x26payTimeBegin\x3d"+payTimeBegin;if(payTimeEnd!==null)url=url+"\x26payTimeEnd\x3d"+
payTimeEnd;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;if(buyerMessage!=null)url=url+"\x26buyerMessage\x3d"+buyerMessage;if(sellerMemo!=null)url=url+"\x26sellerMemo\x3d"+sellerMemo;console.info(Constant.BACKEND_BASE+url);return $http.get(Constant.BACKEND_BASE+url)};this.modify=function(OrderMasterUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/taobaoTrades/"+OrderMasterUpdateInput.uuid,OrderMasterUpdateInput)};this.merge=function(uuids){return $http.put(Constant.BACKEND_BASE+
"/taobaoTrades/orderCombine?uuids\x3d"+uuids)};this.cancelConfirm=function(uuids){return $http.put(Constant.BACKEND_BASE+"/taobaoTrades/cancelConfirm?uuids\x3d"+uuids)};this.delivery=function(DeliveryInput){return $http.patch(Constant.BACKEND_BASE+"/taobaoTrades/"+DeliveryInput.uuid+"?type\x3ddelivery",DeliveryInput)}});
angular.module("IOne-Production").service("TaobaoOrderDetail",function($http,Constant){this.get=function(masterUuid){return $http.get(Constant.BACKEND_BASE+"/taobaoTrades/"+masterUuid+"/details")}});angular.module("IOne-Production").service("TaobaoAmountMaster",function($http,Constant){this.get=function(taobaoTradeMasterUuid){return $http.get(Constant.BACKEND_BASE+"/taobaoAmounts?taobaoTradeUuid\x3d"+taobaoTradeMasterUuid)}});
angular.module("IOne-Production").service("TaobaoAmountDetail",function($http,Constant){this.get=function(TaobaoAmountMasterUuid){return $http.get(Constant.BACKEND_BASE+"/taobaoAmounts/"+TaobaoAmountMasterUuid+"/details")}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/temp",{controller:"TempController",templateUrl:"app/src/app/production/temp/temp.html"})}]);
angular.module("IOne-Production").controller("TempController",function($scope,OrderMaster,OrderDetail,OrderExtendDetail,Constant){$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value,release:Constant.RELEASE[0].value};$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.refreshList=function(){OrderMaster.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,
"","","","","","","","").success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements})};$scope.$watch("listFilterOption",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.itemList=[{no:"1111111",name:"name1",orderAmount:"100",confirm:"1",release:"1",status:"2"},{no:"2222222",name:"name2",orderAmount:"200",confirm:"2",release:"1",
status:"1"},{no:"4444444",name:"name0",orderAmount:"400",confirm:"1",release:"1",status:"1"},{no:"3333333",name:"name3",orderAmount:"300",confirm:"1",release:"2",status:"2"}];$scope.subItemList=[{no:"1111111",name:"name1",orderAmount:"100",confirm:"1",release:"1",status:"2"},{no:"2222222",name:"name2",orderAmount:"200",confirm:"2",release:"1",status:"1"},{no:"3333333",name:"name3",orderAmount:"300",confirm:"1",release:"2",status:"2"}];$scope.selectAllFlag=false;$scope.showDetailPanelAction=function(item){$scope.selectedItem=
item;item.detailList=$scope.subItemList};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;$scope.selectedItem=null};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel)item.detailList=$scope.subItemList};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS)};
$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.status=="add")if($scope.domain=="PSO_ORDER_MST")console.info("add order mst...");
else{if($scope.domain=="PSO_ORDER_DTL")console.info("add order dtl...")}else if($scope.status=="edit")if($scope.domain=="PSO_ORDER_MST")console.info("edit order mst...");else if($scope.domain=="PSO_ORDER_DTL")console.info("edit order dtl...")};$scope.deleteDetailAction=function(detail){};$scope.selectItemAction=function(event,item){$scope.stopEventPropagation(event)};$scope.confirmClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("confirm...")};$scope.statusClickAction=
function(event,item){$scope.stopEventPropagation(event);console.info("status...")};$scope.releaseClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("release...")};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("delete...")};$scope.confirmAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("confirm all...")};$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("status all...")};
$scope.releaseAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("release all...")};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("delete all...")};$scope.selectAllAction=function(){angular.forEach($scope.itemList,function(item){if($scope.selectAllFlag)item.selected=true;else item.selected=false})}});
angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/catalogue",{controller:"ProductionSummaryController",templateUrl:"app/src/app/production/template/template.html"})}]);
angular.module("IOne-Production").controller("ProductionSummaryController",function($scope,CatalogueTemplate,Constant,$mdDialog,$timeout){$scope.listFilterOption={status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value,release:Constant.RELEASE[0].value,prodType:Constant.PROD_TYPE[0].value};$scope.listFilterDisplayOption={showStatusFilterMenu:true,showConfirmFilterMenu:true,showReleaseFilerMenu:true,showProdTypeFilterMenu:false};$scope.formMenuDisplayOption={"100-add":{display:true,name:"新增",
uuid:"6D732D25-EB09-43EB-9C6E-37638E3BAAE3"},"101-delete":{display:true,name:"删除",uuid:"02EAB922-634E-44B3-A730-0F198FCB7EC6"},"102-edit":{display:true,name:"编辑",uuid:"77C6275F-5D0B-40C8-BEE4-5256DCC1FE48"},"103-copy":{display:true,name:"复制",uuid:"6D7BF5D4-1816-4F3A-97EE-53A8C7C712A8"},"104-status":{display:true,name:"启用",uuid:"61BCFEAD-E537-4787-9499-C03C94E84A88"},"105-confirm":{display:true,name:"审核",uuid:"393C5A01-EA77-4168-A6BB-9C2B03C53F29"},"106-release":{display:true,name:"发布",uuid:"5BCDC24B-2578-4295-AD6C-0063437C0F70"},
"200-cancel":{display:true,name:"取消新增",uuid:"2C517ACE-3E23-47C8-938C-CE36C5B6576F"},"201-save":{display:true,name:"保存",uuid:"E69D9D85-F22A-4394-A433-246BED5ECBA9"},"300-add":{display:true,name:"新增节点",uuid:"14F52550-42FE-466F-A067-8A46CDA749EF"},"301-delete":{display:true,name:"删除节点",uuid:"30BEA4BA-6C8A-4061-AF05-04681BEBDFA3"},"302-save":{display:true,name:"保存",uuid:"95E9E7C3-F995-4BA8-A4BB-B989D76456A8"},"303-cancel":{display:true,name:"取消修改",uuid:"C36D8E23-BF25-4335-92E8-3CCB45DB11AE"},"304-quit":{display:true,
name:"退出编辑",uuid:"FAC025DE-E9B8-4706-B31C-853AABE172CF"}};$scope.pageOption={sizePerPage:15,currentPage:0,totalPage:100,totalElements:100};$scope.refreshAllTemplate=function(){CatalogueTemplate.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.status,$scope.listFilterOption.confirm,$scope.listFilterOption.release).success(function(data){$scope.catalogueTemplates=data;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;
if(data&&data.content)angular.forEach(data.content,function(content){if(content&&content.details){content.display=true;angular.forEach(content.details,function(node,index){node.index=index})}})});$scope.selectedItem=null;$scope.selectedTemplateNode=null};$scope.listTabSelected=function(){$scope.refreshAllTemplate();$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS,0)};$scope.formTabSelected=function(){$scope.getMenuAuthData($scope.RES_UUID_MAP.PRODUCTION.TEMPLATE.FORM_PAGE.RES_UUID).success(function(data){$scope.menuAuthDataMap=
$scope.menuDataMap(data)})};$scope.$watch("listFilterOption",function(){$scope.refreshAllTemplate()},true);$scope.editItem=function(item){$scope.selectedItem=item;$scope.changeViewStatus(Constant.UI_STATUS.PRE_EDIT_UI_STATUS,1)};$scope.modifyMenuAction=function(){if($scope.selectedItem)CatalogueTemplate.modify($scope.selectedItem).success(function(){$scope.showInfo("修改模板成功。")}).error(function(data){$scope.showError(data.content);$scope.cancelModifyMenuAction()});if($scope.selectedTemplateNode)if($scope.selectedTemplateNode.uuid==
null||$scope.selectedTemplateNode.uuid==undefined)CatalogueTemplate.addNode($scope.selectedItem.uuid,$scope.selectedTemplateNode).success(function(data){$scope.selectedTemplateNode.uuid=data.uuid;$scope.showInfo("新建节点成功。")}).error(function(data){if(data&&data.content)$scope.showError(data.content)});else CatalogueTemplate.modifyNode($scope.selectedItem.uuid,$scope.selectedTemplateNode).success(function(data){$scope.selectedTemplateNode=data;$scope.showInfo("修改节点成功。")})};$scope.deleteMenuAction=function(){$scope.showConfirm("确认删除吗？",
"删除的模板不可恢复。",function(){if($scope.selectedItem)CatalogueTemplate.delete($scope.selectedItem.uuid).success(function(){$scope.showInfo("删除成功。");$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_DELETE,0)}).error(function(response){$scope.showError($scope.getError(response))})})};$scope.cancelAddMenuAction=function(){$scope.listTabSelected()};$scope.preAddMenuAction=function(){$scope.selectedItem=CatalogueTemplate.createDefault();$scope.selectedTemplateNode=null;$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_ADD,
1)};$scope.addMenuAction=function(){if($scope.selectedItem&&(angular.isUndefined($scope.selectedItem.uuid)||$scope.selectedItem.uuid==null))CatalogueTemplate.add($scope.selectedItem).success(function(data){$scope.selectedItem=data;$scope.selectedTemplateNode=null;$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_MODIFY,1);$scope.showInfo("新增模板成功。")})};$scope.copyMenuAction=function(){$mdDialog.show({controller:"DialogController",templateUrl:"app/src/app/production/template/addTemplate.html",
parent:angular.element(document.body),targetEvent:event}).then(function(data){for(var i=0;i<$scope.catalogueTemplates.content.length;i++)if($scope.catalogueTemplates.content[i].no==data.no){$scope.showError("编号已存在，请选择其它编号。");return}CatalogueTemplate.copy($scope.selectedItem,{no:data.no,name:data.name}).success(function(data){$scope.selectedItem=data;$scope.selectedTemplateNode=null;$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_MODIFY,1);$scope.showInfo("模板拷贝成功。")})})};$scope.addNodeMenuAction=
function(event){if($scope.isNotPersistedNode()==true){$scope.showWarn("请先保存当前节点。");return}var newNode=CatalogueTemplate.createDefaultTemplateNode();$mdDialog.show({controller:"DialogController",templateUrl:"app/src/app/production/template/addNode.html",parent:angular.element(document.body),targetEvent:event}).then(function(data){if($scope.selectedItem.details.length==0)$scope.selectedItem.details.push(newNode);else if($scope.selectedItem.details.length>0)if($scope.selectedTemplateNode){newNode.parentUuid=
$scope.selectedTemplateNode.uuid;$scope.selectedItem.details.splice($scope.selectedTemplateNode.index+1,0,newNode)}else{newNode.parentUuid=$scope.selectedItem.details[$scope.selectedItem.details.length-1].uuid;$scope.selectedItem.details.push(newNode)}newNode.no=data.no;newNode.name=data.name;angular.forEach($scope.selectedItem.details,function(value,index){value.index=index});$scope.selectedTemplateNode=newNode})};$scope.selectNodeHandler=function(node){if($scope.isNotPersistedNode()==true){$scope.showWarn("请先保存当前节点。");
return}$scope.selectedTemplateNode=node};$scope.$watch("selectedItem",function(){if($scope.selectedItem){if($scope.selectedItem.status=="1")$scope.formMenuDisplayOption["104-status"].name="禁用";else if($scope.selectedItem.status=="2")$scope.formMenuDisplayOption["104-status"].name="启用";if($scope.selectedItem.confirm=="1")$scope.formMenuDisplayOption["105-confirm"].name="审核";else if($scope.selectedItem.confirm=="2")$scope.formMenuDisplayOption["105-confirm"].name="反审核";if($scope.selectedItem.release==
"1")$scope.formMenuDisplayOption["106-release"].name="发布";else if($scope.selectedItem.release=="2")$scope.formMenuDisplayOption["106-release"].name="反发布"}},true);$scope.handler=function(field,value){if($scope.selectedItem&&$scope.selectedItem[field]){$scope.selectedItem[field]=value;$scope.selectedTemplateNode=null;$scope.modifyMenuAction()}};$scope.statusMenuAction=function(){$scope.selectedItem.status=="1"?$scope.handler("status","2"):$scope.handler("status","1")};$scope.confirmMenuAction=function(){$scope.selectedItem.confirm==
"1"?$scope.handler("confirm","2"):$scope.handler("confirm","1")};$scope.releaseMenuAction=function(){$scope.selectedItem.release=="1"?$scope.handler("release","2"):$scope.handler("release","1")};$scope.isNotPersistedNode=function(){if($scope.selectedTemplateNode&&($scope.selectedTemplateNode.uuid==null&&$scope.selectedTemplateNode.uuid==undefined))return true;else return false};$scope.deleteNodeMenuAction=function(node){$scope.showConfirm("确认删除吗？","删除的模板节点不可恢复。",function(){if(node)$scope.selectedTemplateNode=
node;if($scope.selectedTemplateNode)if(!$scope.isNotPersistedNode())CatalogueTemplate.deleteNode($scope.selectedItem.uuid,$scope.selectedTemplateNode.uuid).success(function(){$scope.showInfo("删除节点成功。");$scope.selectedItem.details.splice($scope.selectedTemplateNode.index,1);$scope.selectedTemplateNode=null});else{$scope.selectedItem.details.splice($scope.selectedTemplateNode.index,1);$scope.selectedTemplateNode=null}else $scope.showWarn("请选择节点。")});$event.stopPropagation();$event.preventDefault()};
$scope.cancelModifyMenuAction=function(){CatalogueTemplate.get($scope.selectedItem.uuid).success(function(data){$scope.selectedItem=data;$scope.selectedTemplateNode=null})};$scope.exitModifyMenuAction=function(){$scope.cancelModifyMenuAction();$scope.changeViewStatus($scope.UI_STATUS.PRE_EDIT_UI_STATUS,1)}});angular.module("IOne-Production").controller("DialogController",function($scope,$mdDialog){$scope.data={};$scope.hideDlg=function(){$mdDialog.hide($scope.data)};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/catalogue-data",{controller:"CatalogueDataController",templateUrl:"app/src/app/production/template_data/templateData.html"})}]);
angular.module("IOne-Production").controller("CatalogueDataController",function($scope,CatalogueTemplate,Catalogue,ProductionCatalogueDetails,Constant,$mdDialog,Upload,$timeout){$scope.listFilterOption={status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value,release:Constant.RELEASE[0].value,prodType:Constant.PROD_TYPE[0].value};$scope.$watch("listFilterOption",function(){$scope.refreshAllTemplate()},true);$scope.listFilterDisplayOption={showStatusFilterMenu:true,showConfirmFilterMenu:true,
showReleaseFilerMenu:true,showProdTypeFilterMenu:false};$scope.formMenuDisplayOption={"100-add":{display:true,name:"新增",uuid:"48C4F8B0-3881-4167-B043-B7D8A9537547"},"101-delete":{display:true,name:"删除",uuid:"F116804B-600C-405F-AEC9-F9667D1845D0"},"102-edit":{display:true,name:"编辑",uuid:"D7C3747E-6604-4113-8CC2-DF5A2EAB5F70"},"103-copy":{display:false,name:"复制",uuid:"73BED5D4-6858-44B9-92EF-D9EE1E9EED89"},"104-status":{display:true,name:"启用",uuid:"5122C79B-DC78-4E1F-8945-35394D1F4200"},"105-confirm":{display:true,
name:"审核",uuid:"303BF9B5-079E-4970-8269-CC5FC2D5222D"},"106-release":{display:true,name:"发布",uuid:"43420AA2-F2FB-4676-A3D3-96A732D076FA"},"200-cancel":{display:true,name:"取消新增",uuid:"A8E3B147-B890-47F7-8131-5DA261A34C1C"},"201-save":{display:true,name:"保存",uuid:"E6051673-5316-4CC4-9208-24A5BE671E8F"},"300-add":{display:true,name:"新增数据",uuid:"82DB999C-0155-40C8-9B96-01C3DD428804"},"301-delete":{display:true,name:"删除数据",uuid:"46F359CF-8331-42DC-8D48-24B631FBB0D4"},"302-save":{display:true,name:"保存",
uuid:"13CFCD62-2FE4-4E3D-A352-F32814B21880"},"303-cancel":{display:true,name:"取消修改",uuid:"4B958029-E637-4B22-B30F-94AAE55EA680"},"304-quit":{display:true,name:"退出编辑",uuid:"D7BAA884-3F9C-4165-BF58-C22C2C69259A"}};$scope.pageOption={sizePerPage:1E4,currentPage:0,totalPage:100,totalElements:100};$scope.$watch("selectedTemplateNodeData",function(){if($scope.selectedTemplateNodeData==null){$scope.addNodeDisabled=true;$scope.deleteNodeDisabled=true}else{$scope.addNodeDisabled=false;$scope.deleteNodeDisabled=
false}});$scope.$watchCollection("[backupNodeData, selectedTemplateNodeData]",function(){if($scope.backupNodeData==null||$scope.selectedTemplateNodeData==null)$scope.cancelModifyDisabled=true;else $scope.cancelModifyDisabled=false});$scope.selectedTemplateData={};$scope.nodeDataClickHandler=function(template,node,nodeDataList,nodeData){if($scope.isRefreshing)return;$scope.selectedTemplateData[template.uuid].splice(node.index+1);angular.forEach(nodeDataList,function(data){data.selected=false});nodeData.selected=
true;$scope.selectedTemplateNode=node;$scope.selectedTemplateNodeData=nodeData;$scope.backupNodeData=Catalogue.backup(nodeData);var nextNode=template.details[node.index+1];if(nextNode==undefined||nextNode==undefined)return;else{$scope.isRefreshing=true;Catalogue.get(nextNode.uuid,nodeData.uuid).success(function(data){if(data&&data.content&&data.content.length>0)$scope.selectedTemplateData[template.uuid].push(data.content);$scope.isRefreshing=false}).error(function(){$scope.isRefreshing=false})}};
$scope.refreshTemplateData=function(template,node){if(template&&template.details&&template.details.length>0){var dataHandler=function(template,node,data){var content=$scope.selectedTemplateData[template.uuid];if(content==undefined||content==null){content=[data];$scope.selectedTemplateData[template.uuid]=content}};Catalogue.getForRoot(node.uuid).success(function(data){dataHandler(template,node,data.content)})}};$scope.refreshAllTemplate=function(){CatalogueTemplate.getAll($scope.pageOption.sizePerPage,
$scope.pageOption.currentPage,$scope.listFilterOption.status,$scope.listFilterOption.confirm,$scope.listFilterOption.release,true).success(function(data){$scope.catalogueTemplates=data;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;var setFirstOpen=false;if(data&&data.content){$scope.selectedTemplateData={};angular.forEach(data.content,function(content){if(content&&content.details){content.display=true;content.open=false;content.dataStatus=content.dataStatus==
null?"2":content.dataStatus;content.dataConfirm=content.dataConfirm==null?"1":content.dataConfirm;content.dataRelease=content.dataRelease==null?"1":content.dataRelease;angular.forEach(content.details,function(node,index){node.index=index});if(content.details.length>0){if(setFirstOpen==false){content.open=true;setFirstOpen=true}$scope.refreshTemplateData(content,content.details[0])}}})}});$scope.selectedItem=null};$scope.addNodeData=function(template,templateNode){$mdDialog.show({controller:"DialogController",
templateUrl:"app/src/app/production/template_data/addNodeData.html",parent:angular.element(document.body),targetEvent:event}).then(function(data){var newTemplateNodeData={no:data.no,name:data.name,templateDetailUuid:templateNode.uuid};if(templateNode.parentUuid)angular.forEach($scope.selectedTemplateData[template.uuid][templateNode.index-1],function(item,index){if(item.selected)newTemplateNodeData.parentUuid=item.uuid});Catalogue.add(newTemplateNodeData).success(function(data){$scope.selectedTemplateData[template.uuid][templateNode.index]=
$scope.selectedTemplateData[template.uuid][templateNode.index]||[];$scope.selectedTemplateData[template.uuid][templateNode.index].push(data);$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_MODIFY,1);$scope.nodeDataClickHandler(template,templateNode,$scope.selectedTemplateData[template.uuid][templateNode.index],data);$scope.showInfo("新增节点数据成功。")})})};$scope.deleteNodeData=function($event,templateNodeDataList,index,templateNodeData,templateNode){ProductionCatalogueDetails.getByCatalogue(templateNodeData.uuid,
1,0).success(function(data){if(data.content.length==0)$scope.showConfirm("确认清除该节点数据吗？","节点数据删除后不可恢复。",function(){Catalogue.delete(templateNodeData.uuid).success(function(){templateNodeDataList.splice(index,1);$scope.selectedTemplateData[$scope.selectedItem.uuid].splice(templateNode.index+1);$scope.selectedTemplateNodeData=null;$scope.backupNodeData=null;$scope.showInfo("删除节点数据成功。")}).error(function(){$scope.showError("删除节点数据失败，请确保该节点下没有关联的商品。")})});else $scope.showWarn("不可以删除存在关联商品的目录。")});$event.stopPropagation();
$event.preventDefault()};$scope.listTabSelected=function(){$scope.refreshAllTemplate();$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS,0)};$scope.formTabSelected=function(){$scope.getMenuAuthData($scope.RES_UUID_MAP.PRODUCTION.TEMPLATE_DATA.FORM_PAGE.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)})};$scope.editItem=function($event,item){$scope.selectedItem=item;$scope.selectedTemplateNode=null;$scope.backupNodeData=null;if($scope.selectedTemplateNodeData){$scope.selectedTemplateNodeData.selected=
false;$scope.selectedTemplateNodeData=null}$scope.changeViewStatus(Constant.UI_STATUS.PRE_EDIT_UI_STATUS,1)};$scope.toggleItem=function($event,template){template.open=!template.open;$event.stopPropagation();$event.preventDefault()};$scope.preAddMenuAction=function(){$mdDialog.show({controller:"TemplateSelectController",templateUrl:"app/src/app/production/template_data/templateList.html",parent:angular.element(document.body),targetEvent:event,locals:{catalogueTemplates:$scope.catalogueTemplates,selectedTemplateData:$scope.selectedTemplateData}}).then(function(data){$scope.selectedItem=
data;$scope.selectedItem.open=true;$scope.refreshTemplateData(data,data.details[0]);$scope.selectedTemplateNode=null;$scope.selectedTemplateNodeData=null;$scope.backupNodeData=null;$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS_MODIFY,1)})};$scope.cancelAddMenuAction=function(){$scope.listTabSelected()};$scope.modifyMenuAction=function(){if($scope.selectedTemplateNodeData)Catalogue.modify($scope.selectedTemplateNodeData).success(function(){$scope.backupNodeData=null;$scope.showInfo("修改节点数据成功。")})};
$scope.$watch("selectedItem",function(){if($scope.selectedItem){if($scope.selectedItem.dataStatus=="1")$scope.formMenuDisplayOption["104-status"].name="禁用";else if($scope.selectedItem.dataStatus=="2")$scope.formMenuDisplayOption["104-status"].name="启用";if($scope.selectedItem.dataConfirm=="1")$scope.formMenuDisplayOption["105-confirm"].name="审核";else if($scope.selectedItem.dataConfirm=="2")$scope.formMenuDisplayOption["105-confirm"].name="反审核";if($scope.selectedItem.dataRelease=="1")$scope.formMenuDisplayOption["106-release"].name=
"发布";else if($scope.selectedItem.dataRelease=="2")$scope.formMenuDisplayOption["106-release"].name="反发布"}},true);$scope.modifyFromPanelHandler=function(){CatalogueTemplate.modify($scope.selectedItem).success(function(){$scope.showInfo("修改模板数据成功。")}).error(function(data){$scope.showError(data.content);$scope.cancelModifyMenuAction()})};$scope.handler=function(field,value){if($scope.selectedItem&&$scope.selectedItem[field]){$scope.selectedItem[field]=value;$scope.modifyFromPanelHandler()}};$scope.statusMenuAction=
function(){$scope.selectedItem.dataStatus=="1"?$scope.handler("dataStatus","2"):$scope.handler("dataStatus","1")};$scope.confirmMenuAction=function(){$scope.selectedItem.dataConfirm=="1"?$scope.handler("dataConfirm","2"):$scope.handler("dataConfirm","1")};$scope.releaseMenuAction=function(){$scope.selectedItem.dataRelease=="1"?$scope.handler("dataRelease","2"):$scope.handler("dataRelease","1")};$scope.cancelModifyMenuAction=function(){$scope.selectedTemplateNodeData=Catalogue.recover($scope.selectedTemplateNodeData,
$scope.backupNodeData)};$scope.exitModifyMenuAction=function(){$scope.cancelModifyMenuAction();$scope.changeViewStatus($scope.UI_STATUS.PRE_EDIT_UI_STATUS,1)};$scope.deleteNodeMenuAction=function($event){if($scope.selectedTemplateNodeData){var selectedTemplateDataList=$scope.selectedTemplateData[$scope.selectedItem.uuid][$scope.selectedTemplateNode.index];var index=-1;angular.forEach(selectedTemplateDataList,function(item,idx){if($scope.selectedTemplateNodeData==item)index=idx});if(index!=-1)$scope.deleteNodeData($event,
$scope.selectedTemplateData[$scope.selectedItem.uuid][$scope.selectedTemplateNode.index],index,$scope.selectedTemplateNodeData,$scope.selectedTemplateNode)}else $scope.showWarn("请先选择一个节点数据。")};$scope.addNodeMenuAction=function($event){$scope.addNodeData($scope.selectedItem,$scope.selectedTemplateNode)};$scope.deleteMenuAction=function(){$scope.showConfirm("确认清除整个模板数据吗？","模板数据删除后不可恢复。",function(){CatalogueTemplate.clearData($scope.selectedItem.uuid).success(function(){$scope.showInfo("清除模板数据成功。")})})};
$scope.uploadImage=function(files){$scope.progress={value:0};if(files&&files.length)for(var i=0;i<files.length;i++){var file=files[i];Upload.upload({url:Constant.BACKEND_BASE+"/files",fields:{},file:file}).progress(function(evt){$scope.progress.value=Math.min(100,parseInt(99*evt.loaded/evt.total))}).success(function(data){$timeout(function(){$scope.progress.value=100;if($scope.selectedTemplateNodeData&&$scope.selectedTemplateNodeData.uuid)Catalogue.addImage($scope.selectedTemplateNodeData.uuid,data.uuid).success(function(response){$scope.selectedTemplateNodeData.path=
response.path+"?time\x3d"+(new Date).getTime()})})})}}});angular.module("IOne-Production").controller("TemplateSelectController",function($scope,$mdDialog,CatalogueTemplate,catalogueTemplates,selectedTemplateData){$scope.catalogueTemplates=catalogueTemplates;$scope.selectedTemplateData=selectedTemplateData;$scope.hideDlg=function(index){$mdDialog.hide($scope.catalogueTemplates.content[index])};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/auth/user",{controller:"UserController",templateUrl:"app/src/app/auth/user/user.html"})}]);
angular.module("IOne-Production").controller("UserController",function($scope,$http,$mdDialog,Constant,UserService,GroupUserService,UserRoleService){$scope.pageOption={sizePerPage:20,currentPage:0,totalPage:0,totalElements:10,displayModel:0};$scope.listFilterOption={status:Constant.STATUS[0].value};$scope.$watch("listFilterOption",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshAllUsers()},true);$scope.listFilterDisplayOption=
{showStatusFilterMenu:true,showConfirmFilterMenu:false,showReleaseFilerMenu:false,showProdTypeFilterMenu:false,showStopProdFilterMenu:false};$scope.formMenuDisplayOption={"100-add":{display:true,name:"新增",uuid:""},"101-delete":{display:true,name:"删除",uuid:""},"102-edit":{display:true,name:"编辑",uuid:""},"103-copy":{display:false,name:"复制",uuid:""},"104-status":{display:true,name:"启用",uuid:""},"105-confirm":{display:false,name:"审核",uuid:""},"106-release":{display:false,name:"发布",uuid:""},"200-cancel":{display:true,
name:"取消新增",uuid:""},"201-save":{display:true,name:"保存",uuid:""},"300-add":{display:false,name:"新增节点",uuid:""},"301-delete":{display:false,name:"删除节点",uuid:""},"302-save":{display:true,name:"保存",uuid:""},"303-cancel":{display:true,name:"取消修改",uuid:""},"304-quit":{display:true,name:"退出编辑",uuid:""}};$scope.userType=1;$scope.refreshAllUsers=function(){GroupUserService.query($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.status,$scope.searchKeyword).success(function(data){$scope.allUsers=
data;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements})};$scope.listTabSelected=function(){$scope.refreshAllUsers();$scope.selectedItem=null;$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS,0)};$scope.formTabSelected=function(){};$scope.editItem=function(data){$scope.selectedItem=data;$scope.changeViewStatus(Constant.UI_STATUS.PRE_EDIT_UI_STATUS,1);$scope.showUserRoles($scope.selectedItem)};$scope.showUserRoles=function(user){if(user.baseUser==
undefined)UserService.getUser(user.uuid,1).success(function(data){user.baseUser=data.content[0];UserRoleService.get(user.baseUser.uuid).success(function(data){user.userRoleList=data})})};$scope.exitModifyMenuAction=function(){$scope.changeViewStatus($scope.UI_STATUS.PRE_EDIT_UI_STATUS,1)};$scope.addUserRole=function(){$mdDialog.show({controller:"RoleListController",templateUrl:"app/src/app/auth/user/addRoleDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{}}).then(function(data){UserRoleService.add($scope.selectedItem.baseUser.uuid,
data.selectedRole.uuid).success(function(data){$scope.selectedItem.userRoleList=$scope.selectedItem.userRoleList||[];$scope.selectedItem.userRoleList.push(data)}).error(function(){$scope.showError("新增角色失败，该角色可能已存在。")})})};$scope.deleteUserRole=function(userRole){UserRoleService.delete(userRole.uuid).success(function(){$scope.selectedItem.userRoleList.splice($scope.selectedItem.userRoleList.indexOf(userRole),1)})};$scope.preAddMenuAction=function(){$scope.selectedItem={};$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_ADD,
1)};$scope.checkPassword=function(){if($scope.selectedItem.password||$scope.selectedItem.confirmPassword)if($scope.selectedItem.password!=$scope.selectedItem.confirmPassword)return false;return true};$scope.addMenuAction=function(){GroupUserService.add($scope.selectedItem).success(function(data){$scope.selectedItem=data;UserService.getUser($scope.selectedItem.uuid,1).success(function(data){$scope.selectedItem.baseUser=data.content[0]});$scope.allUsers.content.push(data);$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_MODIFY,
1);$scope.showInfo("新增用户信息成功。")}).error(function(response){$scope.showError($scope.getAllError(response))})};$scope.modifyMenuAction=function(){GroupUserService.modify($scope.selectedItem).success(function(data){$scope.showInfo("修改用户信息成功。")}).error(function(response){$scope.showError($scope.getAllError(response))})};$scope.cancelModifyMenuAction=function(){GroupUserService.get($scope.selectedItem.uuid).success(function(data){$scope.selectedItem=data;$scope.showUserRoles($scope.selectedItem)})};$scope.cancelAddMenuAction=
function(){$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_DELETE,0)};$scope.deleteMenuAction=function(){$scope.showConfirm("确认删除吗？","删除的用户不可恢复。",function(){GroupUserService.delete($scope.selectedItem.uuid).success(function(data){$scope.showInfo("删除用户信息成功。");$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_DELETE,0)}).error(function(){$scope.showError("删除用户信息失败。")})})};$scope.$watchCollection("selectedItem.status",function(){if($scope.selectedItem)if($scope.selectedItem.status=="1")$scope.formMenuDisplayOption["104-status"].name=
"禁用";else if($scope.selectedItem.status=="2")$scope.formMenuDisplayOption["104-status"].name="启用"});$scope.statusMenuAction=function(){if($scope.selectedItem.status=="1")$scope.selectedItem.status="2";else $scope.selectedItem.status="1";$scope.modifyMenuAction()}});
angular.module("IOne-Production").controller("RoleListController",function($scope,$mdDialog,RoleService){RoleService.getAll(1E4,0).success(function(data){$scope.allRoles=data.content});$scope.selectedRole={uuid:""};$scope.hideDlg=function(){$mdDialog.hide({"selectedRole":$scope.selectedRole})};$scope.cancelDlg=function(){$mdDialog.cancel()}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/walkThrough",{controller:"WalkThroughController",templateUrl:"app/src/app/eps/walkThrough/walkThrough.html"})}]);
angular.module("IOne-Production").controller("WalkThroughController",function($scope,WalkThroughMaster,WalkThroughDetail,Constant,$mdDialog){$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.BUILDING_TYPE=Constant.BUILDING_TYPE;$scope.WALK_THROUGH_CONF_STATUS=Constant.WALK_THROUGH_CONF_STATUS;$scope.EPS_ORDER_TYPE=Constant.EPS_ORDER_TYPE;$scope.selectAllFlag=false;$scope.selectedItemSize=0;$scope.selectedItemAmount=0;$scope.isLoading=false;$scope.listFilterOption=
{select:{confStatus:Constant.WALK_THROUGH_CONF_STATUS[0].value,confirm:Constant.CONFIRM[0].value,transferFlag:Constant.TRANSFER_PSO_FLAG[0].value,orderType:Constant.EPS_ORDER_TYPE[0].value}};$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.refreshList=function(){WalkThroughMaster.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;
$scope.pageOption.totalElements=data.totalElements})};$scope.$watch("listFilterOption.select",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()}};$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;WalkThroughDetail.get($scope.selectedItem.uuid).success(function(data){$scope.subItemList=
data.content;item.detailList=$scope.subItemList});$scope.displayAdvancedSearPanel=false};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel)WalkThroughDetail.get(item.uuid).success(function(data){$scope.subItemList=data.content;item.detailList=$scope.subItemList})};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=
!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS)};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=
function(){if($scope.status=="add")if($scope.domain=="PSO_ORDER_MST")console.info("add order mst...");else{if($scope.domain=="PSO_ORDER_DTL")console.info("add order dtl...")}else if($scope.status=="edit")if($scope.domain=="PSO_ORDER_MST")console.info("edit order mst...");else if($scope.domain=="PSO_ORDER_DTL")console.info("edit order dtl...")};$scope.deleteDetailAction=function(detail){};$scope.selectItemAction=function(event,item){$scope.stopEventPropagation(event);item.selectedRef=!item.selected;
if(item.selected==false||item.selected==undefined||item.selected==null){$scope.selectedItemSize+=1;$scope.selectedItemAmount+=item.orderAmount}else{$scope.selectedItemSize-=1;$scope.selectedItemAmount-=item.orderAmount;$scope.selectAllFlag=false}};$scope.confirmClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("confirm...");if(item.confirm==Constant.CONFIRM[2].value){$scope.showError("已成功审核并抛转的预排单不能取消审核，预排单号："+item.orderId);return false}$scope.showConfirm("确认审核吗？","",
function(){WalkThroughMaster.confirm(item.uuid).success(function(){item.confirm=Constant.CONFIRM[2].value;$scope.showInfo("预排单审核成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.transferClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("transfer...");$scope.showConfirm("确认抛转吗？","",function(){WalkThroughMaster.transfer(item.uuid).success(function(){item.transferFlag=Constant.TRANSFER_PSO_FLAG[1].value;$scope.showInfo("预排单抛转成功！")}).error(function(response){$scope.showError(response.message)})})};
$scope.statusClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("status...")};$scope.releaseClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("release...")};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("delete...")};$scope.confirmAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("confirm all...");var uuids="";var count=0;var failUuids="";angular.forEach($scope.itemList,
function(item){if(item.selected===true){uuids+=item.uuid+",";count++;if(item.confirm==Constant.CONFIRM[2].value)failUuids+=item.orderId+", "}});if(count===0){$scope.showError("没有选择任何预排单，请先选择预排单！");return}if(failUuids!==""){$scope.showError("已成功审核并抛转的预排单不能再次审核并抛转，预排单号："+failUuids.substring(0,failUuids.length-2));return false}$scope.showConfirm("确认审核吗？","",function(){WalkThroughMaster.confirm(uuids).success(function(){angular.forEach($scope.itemList,function(item){if(item.selected===true)item.confirm=
Constant.CONFIRM[2].value});$scope.showInfo("预排单审核成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.walkTroughAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("confirm all...");var uuids="";var count=0;var failUuids="";angular.forEach($scope.itemList,function(item){if(item.selected===true){uuids+=item.uuid+",";count++;if(item.confirm==Constant.CONFIRM[2].value)failUuids+=item.orderId+", "}});if(count===0)$scope.showError("没有选择任何预排单，请先选择预排单！")};
$scope.sycClickAction=function(event){$scope.showConfirm("确认获取吗？","",function(){$scope.isLoading=true;WalkThroughMaster.syc().success(function(response){if(response.status=="COMPLETED"){$scope.refreshList();$scope.isLoading=false;$scope.showInfo("预排单获取成功！")}else{var errorMsg="预排单获取失败";$scope.isLoading=false;if(response.message!=null)$scope.showError(errorMsg+"："+response.message);else $scope.showError(errorMsg+"！")}}).error(function(response){$scope.isLoading=false;$scope.showError(response.message)})})};
$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("status all...")};$scope.releaseAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("release all...")};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("delete all...")};$scope.selectAllAction=function(){angular.forEach($scope.itemList,function(item){if($scope.selectAllFlag)item.selected=true;else item.selected=false;item.selectedRef=item.selected});
$scope.selectedItemSize=0;$scope.selectedItemAmount=0;if($scope.selectAllFlag)angular.forEach($scope.itemList,function(item){$scope.selectedItemSize++;$scope.selectedItemAmount+=item.orderAmount})};$scope.openEditorDlg=function(item){$mdDialog.show({controller:"ItemEditorController",templateUrl:"app/src/app/eps/walkThrough/editorDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{editingItem:item}}).then(function(editingItem){var confDeliverDate=moment(editingItem.confDeliverDate).format("YYYY-MM-DD 00:00:00");
var postData={"buildingType":editingItem.buildingType,"floor":editingItem.floor,"confDeliverDate":confDeliverDate};WalkThroughMaster.modify(item.uuid,postData).success(function(data){item.confStatus=data[0].confStatus;$scope.showInfo("预排回访完结。")}).error(function(response){$scope.showError(response.message)})})}});
angular.module("IOne-Production").controller("ItemEditorController",function($scope,Constant,$mdDialog,editingItem){$scope.editingItem=editingItem;$scope.BUILDING_TYPE=Constant.BUILDING_TYPE;if(editingItem.confDeliverDate!=null)editingItem.confDeliverDate=new Date(editingItem.confDeliverDate);else editingItem.confDeliverDate=new Date(editingItem.deliverDate);$scope.saveDetail=function(){$mdDialog.hide($scope.editingItem)};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").service("WalkThroughMaster",function($http,Constant){this.getAll=function(sizePerPage,page,filter){var confirm=filter.select.confirm==0?"":filter.select.confirm;var confStatus=filter.select.confStatus==0?"":filter.select.confStatus;var transferFlag=filter.select.transferFlag==0?"":filter.select.transferFlag;var orderType=filter.select.orderType==0?"":filter.select.orderType;var url="walkThroughs?size\x3d"+sizePerPage+"\x26page\x3d"+page;if(confirm!=="")url=url+"\x26confirm\x3d"+
confirm;if(confStatus!=="")url=url+"\x26confStatus\x3d"+confStatus;if(transferFlag!=="")url=url+"\x26transferFlag\x3d"+transferFlag;if(orderType!=="")url=url+"\x26orderType\x3d"+orderType;if(filter.select.startWalkThroughDate!=null){var startWalkThroughDate=new Date(filter.select.startWalkThroughDate);startWalkThroughDate=moment(startWalkThroughDate).format("YYYY-MM-DD 00:00:00");url=url+"\x26startWalkThroughDate\x3d"+startWalkThroughDate}if(filter.select.endWalkThroughDate!==null&&filter.select.endWalkThroughDate!==
undefined){var endWalkThroughDate=new Date(filter.select.endWalkThroughDate);endWalkThroughDate=moment(endWalkThroughDate).format("YYYY-MM-DD 23:59:59");url=url+"\x26endWalkThroughDate\x3d"+endWalkThroughDate}if(filter.buyerNick!==null&&filter.buyerNick!==undefined)url=url+"\x26buyerNick\x3d"+filter.buyerNick;if(filter.epsOrderNo!==null&&filter.epsOrderNo!==undefined)url=url+"\x26epsOrderNo\x3d"+filter.epsOrderNo;console.info(Constant.BACKEND_BASE+url);return $http.get(Constant.BACKEND_BASE+url)};
this.confirm=function(uuids){return $http.patch(Constant.BACKEND_BASE+"/walkThroughs/"+uuids,{"action":"2","confirm":"2"})};this.modify=function(uuid,updateInput){return $http.patch(Constant.BACKEND_BASE+"/walkThroughs/"+uuid,updateInput)};this.syc=function(){return $http.post(Constant.BACKEND_BASE+"/walkThroughs?fromERP\x3dtrue")};this.transfer=function(uuids){return $http.post(Constant.BACKEND_BASE+"/walkThroughs?toERP\x3dtrue",{"walkThroughMasterUuids":uuids.split(","),"confirm":"2"})}});
angular.module("IOne-Production").service("WalkThroughDetail",function($http,Constant){this.get=function(masterUuid){return $http.get(Constant.BACKEND_BASE+"/walkThroughs/"+masterUuid+"/details")};this.modify=function(masterUuid,detailUuid,updateInput){return $http.patch(Constant.BACKEND_BASE+"/walkThroughs/"+masterUuid+"/details/"+detailUuid,updateInput)}});
angular.module("IOne-Production").service("WalkThroughLogistic",function($http,Constant){this.getAll=function(masterUuid){return $http.get(Constant.BACKEND_BASE+"/walkThroughs/"+masterUuid+"/logistics")};this.get=function(masterUuid,detailUuid){return $http.get(Constant.BACKEND_BASE+"/walkThroughs/"+masterUuid+"/logistics/"+detailUuid)};this.modify=function(masterUuid,detailUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/walkThroughs/"+masterUuid+"/logistics/"+detailUpdateInput.uuid,detailUpdateInput)};
this.add=function(masterUuid,detailInput){return $http.post(Constant.BACKEND_BASE+"/walkThroughs/"+masterUuid+"/logistics",detailInput)};this.delete=function(masterUuid,detailUuid){return $http.delete(Constant.BACKEND_BASE+"/walkThroughs/"+masterUuid+"/logistics/"+detailUuid)}});
angular.module("IOne-Production").service("WalkThroughInstallation",function($http,Constant){this.getAll=function(masterUuid){return $http.get(Constant.BACKEND_BASE+"/walkThroughs/"+masterUuid+"/installations")};this.get=function(masterUuid,detailUuid){return $http.get(Constant.BACKEND_BASE+"/walkThroughs/"+masterUuid+"/installations/"+detailUuid)};this.modify=function(masterUuid,detailUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/walkThroughs/"+masterUuid+"/installations/"+detailUpdateInput.uuid,
detailUpdateInput)};this.add=function(masterUuid,detailInput){return $http.post(Constant.BACKEND_BASE+"/walkThroughs/"+masterUuid+"/installations",detailInput)};this.delete=function(masterUuid,detailUuid){return $http.delete(Constant.BACKEND_BASE+"/walkThroughs/"+masterUuid+"/installations/"+detailUuid)}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/cbi/warehouse",{controller:"WarehouseController",templateUrl:"app/src/app/cbi/warehouse/warehouse.html"})}]);
angular.module("IOne-Production").controller("WarehouseController",function($q,$scope,Warehouse,Constant){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true;$scope.selectedItemSize=0;$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={select:{status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value},no:"",name:"",
keyWord:""};$scope.menuDisplayOption={"switchConfirm":{display:true,name:"审核/取消审核",uuid:"8b2608f8-b4f3-4d6a-b86c-386f370aaa12"},"switchStatus":{display:true,name:"启用/禁用",uuid:"1dbe0933-19cd-413f-8847-e87d6ac31298"},"batchConfirm":{display:true,name:"批量审核",uuid:"020c94c2-0ee1-4249-b01b-d38cb3ffda3f"},"batchRevertConfirm":{display:true,name:"批量取审",uuid:"761aabab-1999-4404-ac3e-e2bdb85d8508"},"batchStatus":{display:true,name:"批量启用",uuid:"74f0ab8c-bc1a-430c-8b23-82d3fc34b590"},"batchRevertStatus":{display:true,
name:"批量禁用",uuid:"12ad891e-8512-453a-813e-69d668635715"},"batchDelete":{display:true,name:"批量删除",uuid:"ba7383b3-2b75-4535-a3b7-9fe2d0b477e8"},"detailConfirm":{display:true,name:"审核",uuid:"eaee731c-e58b-4187-b46b-bc440b779883"},"detailRevertConfirm":{display:true,name:"取审",uuid:"f0fd8788-ebce-4426-a0e7-62189e08120a"},"detailStatus":{display:true,name:"启用",uuid:"24d090e4-0377-4643-a95a-fc15e01fd8d3"},"detailRevertStatus":{display:true,name:"禁用",uuid:"3ac4c30a-b7c0-4376-9bfa-7e0ca3fab241"},"detailDelete":{display:true,
name:"删除",uuid:"75bd2e16-c9b3-41f0-92c1-394d5e4344bf"}};$scope.sortByField="no";$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.refreshList=function(){Warehouse.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements})};$scope.getMenuAuthData($scope.RES_UUID_MAP.CBI.WAREHOUSE.RES_UUID).success(function(data){$scope.menuAuthDataMap=
$scope.menuDataMap(data)});$scope.$watch("listFilterOption.select",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()}};$scope.subItemList=[{no:"1111111",name:"name1",orderAmount:"100",confirm:"1",release:"1",status:"2"},{no:"2222222",name:"name2",orderAmount:"200",
confirm:"2",release:"1",status:"1"},{no:"3333333",name:"name3",orderAmount:"300",confirm:"1",release:"2",status:"2"}];$scope.selectAllFlag=false;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;item.detailList=$scope.subItemList};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;$scope.selectedItem=null};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel)item.detailList=
$scope.subItemList};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);$scope.refreshList()};$scope.hideItemDetailsAction=function(event){$scope.stopEventPropagation(event);$scope.selectedItem=null;$scope.refreshList()};$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;
$scope.source=source;$scope.domain=domain;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.source.confirm=="2"&&$scope.source.status=="2"){$scope.showError("不允许状态是已审核又无效,请调整后再保存");return}if($scope.status=="add"){if($scope.domain=="CBI_BASE_WAREHOUSE"){Warehouse.add($scope.source).success(function(data){$scope.showInfo("新增仓库成功。");
$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);$scope.refreshList()}).error(function(response){$scope.showError("新增仓库失败: "+response.message)});$scope.refreshList()}}else if($scope.status=="edit")if($scope.domain=="CBI_BASE_WAREHOUSE")if($scope.source.status==Constant.STATUS[1].value&&$scope.source.confirm!=Constant.CONFIRM[2].value)Warehouse.modify($scope.source.uuid,$scope.source).success(function(data){$scope.showInfo("修改仓库成功。");$scope.source=data;$scope.selectedItem=data;$scope.selectedItemBackUp=
angular.copy($scope.selectedItem)}).error(function(response){$scope.showError("修改仓库失败。"+response.message);$scope.source=angular.copy($scope.selectedItemBackUp);$scope.selectedItem=angular.copy($scope.selectedItemBackUp)});else $scope.showError($scope.source.no+" 不允许修改：有效且未审核的记录才可以修改！")};$scope.deleteDetailAction=function(detail){};$scope.selectItemAction=function(event,item){$scope.stopEventPropagation(event);item.selectedRef=!item.selected;if(item.selected==false||item.selected==undefined||item.selected==
null)$scope.selectedItemSize+=1;else{$scope.selectedItemSize-=1;$scope.selectAllFlag=false}$scope.disableBatchMenuButtons()};$scope.confirmSwitchAction=function(event,item){$scope.stopEventPropagation(event);if(item.confirm==Constant.CONFIRM[2].value)$scope.showConfirm("确认取消审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};Warehouse.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("取消审核成功。")})},function(){item.confirm=
Constant.CONFIRM[2].value});else{if(item.status==Constant.STATUS[2].value){$scope.showWarn("项目是失效状态,请先启用后再审核");item.confirm=Constant.CONFIRM[2].value;return}$scope.showConfirm("确认审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};Warehouse.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("审核成功。")})},function(){item.confirm=Constant.CONFIRM[1].value})}};$scope.statusSwitchAction=function(event,item){$scope.stopEventPropagation(event);
if(item.status==Constant.STATUS[2].value)$scope.showConfirm("确认修改启用状态为有效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};Warehouse.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("生效成功。")})},function(){item.status=Constant.STATUS[2].value});else $scope.showConfirm("确认修改启用状态为失效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value,confirm:Constant.CONFIRM[1].value};Warehouse.modify(UpdateInput.uuid,
UpdateInput).success(function(){item.confirm=Constant.CONFIRM[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("失效成功。")})},function(){item.status=Constant.STATUS[1].value})};$scope.confirmClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("confirm...");$scope.stopEventPropagation(event);console.info("status...");var msg="确认取消审核吗？";var input="1";var resultMsg="取消审核成功！";if(item.confirm!="2"){msg="确认审核吗？";input="2";resultMsg="审核成功！"}$scope.showConfirm(msg,"",function(){Warehouse.modify(item.uuid,
{"confirm":input}).success(function(){item.confirm=input;$scope.showInfo(resultMsg)}).error(function(response){$scope.showError(response.message)})})};$scope.statusClickAction=function(event,item){$scope.stopEventPropagation(event);if(item.status==Constant.STATUS[1].value)$scope.showConfirm("确认改为失效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value,confirm:Constant.CONFIRM[1].value};Warehouse.modify(item.uuid,UpdateInput).success(function(){item.status=Constant.STATUS[2].value;
item.confirm=Constant.CONFIRM[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("修改为失效成功！")}).error(function(response){$scope.showError(response.message)})});else $scope.showConfirm("确认改为生效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};Warehouse.modify(item.uuid,UpdateInput).success(function(){item.status=Constant.STATUS[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("修改为生效成功！")}).error(function(response){$scope.showError(response.message)})})};
$scope.releaseClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("release...")};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("delete...")};$scope.confirmAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");return}$scope.showConfirm("确认审核吗","",function(){var promises=[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected){var response=
Warehouse.modify(item.uuid,{"confirm":"2"}).success(function(){item.confirm="2"}).error(function(response){bError=true;$scope.showError(item.no+" 审核失败："+response.message)});promises.push(response)}});$q.all(promises).then(function(data){if(!bError)$scope.showInfo("审核成功！");$scope.disableBatchMenuButtons()})})};$scope.cancelConfirmAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");return}$scope.showConfirm("确认取消审核吗","",function(){var promises=
[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected){var response=Warehouse.modify(item.uuid,{"confirm":"1"}).success(function(){item.confirm="1"}).error(function(response){bError=true;$scope.showError(item.no+" 取消审核失败："+response.message)});promises.push(response)}});$q.all(promises).then(function(data){if(!bError){$scope.showInfo("取消审核成功！");$scope.disableBatchMenuButtons()}})})};$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==
0){$scope.showWarn("请先选择记录！");return}$scope.showConfirm("确认启用吗","",function(){var promises=[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected){var response=Warehouse.modify(item.uuid,{"status":"1"}).success(function(){item.status="1"}).error(function(response){bError=true;$scope.showError(item.no+" 启用失败："+response.message)});promises.push(response)}});$q.all(promises).then(function(data){if(!bError){$scope.showInfo("启用成功！");$scope.disableBatchMenuButtons()}})})};$scope.cancelStatusAllClickAction=
function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");return}$scope.showConfirm("确认禁用吗","",function(){var promises=[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected){var response=Warehouse.modify(item.uuid,{"status":"2","confirm":"1"}).success(function(){item.status="2";item.confirm="1"}).error(function(response){bError=true;$scope.showError(item.no+" 禁用失败："+response.message)});promises.push(response)}});$q.all(promises).then(function(data){if(!bError){$scope.showInfo("禁用成功！");
$scope.disableBatchMenuButtons()}})})};$scope.releaseAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("release all...")};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");return}$scope.showConfirm("确认删除吗","",function(){var promises=[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected)if(item.status==Constant.STATUS[1].value&&item.confirm!=Constant.CONFIRM[2].value){var response=
Warehouse.delete(item.uuid).success(function(){$scope.refreshList()}).error(function(response){bError=true;$scope.showError(item.no+" 删除失败："+response.message)});promises.push(response)}else{bError=true;$scope.showError(item.no+" 不允许删除：有效且未审核的记录才可以删除！")}});$q.all(promises).then(function(data){if(!bError){$scope.showInfo("删除成功！");$scope.disableBatchMenuButtons()}})})};$scope.selectAllAction=function(){angular.forEach($scope.itemList,function(item){if($scope.selectAllFlag)item.selected=true;else item.selected=
false;item.selectedRef=item.selected});$scope.selectedItemSize=0;if($scope.selectAllFlag)angular.forEach($scope.itemList,function(item){$scope.selectedItemSize++});$scope.disableBatchMenuButtons()};$scope.disableBatchMenuButtons=function(){var selectedCount=0;var confirm="";var status="";var diffConfirm=false;var diffStatus=false;angular.forEach($scope.itemList,function(item,index){if(item.selectedRef){selectedCount++;if(confirm=="")confirm=item.confirm;else if(confirm!=item.confirm)diffConfirm=true;
if(status=="")status=item.status;else if(status!=item.status)diffStatus=true}});if(selectedCount==0){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}else{if(diffConfirm==true){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchDelete=true}else if(confirm=="2"){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=false;
$scope.disabledBatchDelete=true}else{$scope.disabledBatchConfirm=false;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchDelete=false}if(diffStatus==true){$scope.disabledBatchConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}else if(status=="1"){$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=false}else{$scope.disabledBatchConfirm=true;$scope.disabledBatchStatus=false;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=
true}}}});
angular.module("IOne-Production").service("Warehouse",function($http,Constant){this.getAll=function(sizePerPage,page,filter){var confirm=filter.select.confirm==0?"":filter.select.confirm;var status=filter.select.status==0?"":filter.select.status;var url="warehouses?size\x3d"+sizePerPage+"\x26page\x3d"+page;if(confirm!=="")url=url+"\x26confirm\x3d"+confirm;if(status!=="")url=url+"\x26status\x3d"+status;if(filter.no!=null)url=url+"\x26no\x3d"+filter.no;if(filter.name!=null)url=url+"\x26name\x3d"+filter.name;
if(filter.keyWord!=null)url=url+"\x26keyWord\x3d"+filter.keyWord;return $http.get(Constant.BACKEND_BASE+url)};this.modify=function(uuid,warehouseUpdateInput){return $http.patch(Constant.BACKEND_BASE+"/warehouses/"+uuid,warehouseUpdateInput)};this.add=function(warehouseInput){return $http.post(Constant.BACKEND_BASE+"/warehouses/",warehouseInput)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/warehouses/"+uuid)}});
angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/ass/workflow",{controller:"WorkflowController",templateUrl:"app/src/app/ass/workflow/workflow.html"})}]);
angular.module("IOne-Production").controller("WorkflowController",function($scope,$http,WorkflowService,WorkflowDetailService,ChannelService,RoleService,CBIEmployeeService,GroupFunctionService,FunctionService,Constant,$mdDialog,$q){$scope.WORKFLOW_TYPE=Constant.WORKFLOW_TYPE;$scope.WORKFLOW_TRANSFER_TYPE=Constant.WORKFLOW_TRANSFER_TYPE;$scope.WORKFLOW_TRANSFER_SOURCE=Constant.WORKFLOW_TRANSFER_SOURCE;$scope.selected=[];$scope.selectedDetail=[];$scope.selectedItemsCount=0;$scope.addTransferSource=
"1";$scope.formMenuDisplayOption={"100-add":{display:true,name:"新增",uuid:"2FFC2D74-4D10-4EEC-9892-4E36AF5FDA46"},"101-delete":{display:true,name:"删除",uuid:"874FC59B-3D7D-4AC9-88AD-342DA232C8E1"},"102-edit":{display:true,name:"变更",uuid:"4D19704A-4F5B-40A0-AD52-131D1472C0CD"},"103-audit":{display:true,name:"审核",uuid:"51822FB5-5EF5-4106-8ACE-21012331E825"},"104-revertAudit":{display:true,name:"取消审核",uuid:"7BEE7F47-2937-4121-B107-2FBA6D894402"},"105-selectAll":{display:true,name:"全选",uuid:"5267329f-62ac-46db-b65c-c9b6ae84a4af"},
"106-query":{display:true,name:"查询",uuid:"5f32bc9a-52e6-488e-ba13-b9ea2aedda0b"},"200-cancel":{display:true,name:"取消新增",uuid:"DE4C5380-C0C2-4FA4-9A68-5B1037A3C850"},"201-save":{display:true,name:"保存",uuid:"06743864-0C5A-40A7-9006-4EE90882D281"},"302-save":{display:true,name:"保存",uuid:"b9cb7031-1f8e-4c82-8434-a8122591e685"},"303-cancel":{display:true,name:"取消修改",uuid:"141cc15b-ff38-41f9-b1ca-be6a7f776a46"},"304-quit":{display:true,name:"退出编辑",uuid:"32c85c89-663d-4d82-ba40-91cd049c3ff0"},"202-add":{display:true,
name:"新增",uuid:"28B4012D-CFC3-4C3F-A62B-83AFF04E273C"},"203-audit":{display:true,name:"审核",uuid:"6F8B6FA5-1193-40D0-95F0-E7113D205BA7"},"204-revertAudit":{display:true,name:"取消审核",uuid:"06178343-E280-46A6-AC54-C6EE2B3E1A9E"}};$scope.formMenuAction=function(menuId,$event){if(menuId==100)$scope.preAddMenuAction();else if(menuId==101)$scope.deleteMenuAction();else if(menuId==102)$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_MODIFY,1);else if(menuId==103)$scope.auditMenuAction();else if(menuId==
104)$scope.revertAuditMenuAction();else if(menuId==105)$scope.selectAllMenuAction;if(menuId==200)$scope.cancelAddMenuAction();else if(menuId==201)$scope.addMenuAction();else if(menuId==202)$scope.preAddMenuAction();else if(menuId==203)$scope.auditMenuAction();else if(menuId==204)$scope.revertAuditMenuAction();if(menuId==302)$scope.modifyMenuAction();else if(menuId==303)$scope.cancelModifyMenuAction();else if(menuId==304)$scope.exitModifyMenuAction()};$scope.pageOption={sizePerPage:10,currentPage:0,
totalPage:100,totalElements:100};$scope.listFilterOption={confirm:Constant.CONFIRM[0].value,status:Constant.STATUS[0].value};$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.refreshList=function(){confirm=$scope.listFilterOption.confirm;WorkflowService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.confirm,$scope.listFilterOption.workflowName,"").success(function(data){$scope.workflowMstList=data;$scope.pageOption.totalPage=
data.totalPages;$scope.pageOption.totalElements=data.totalElements;angular.forEach($scope.workflowMstList.content,function(item){$scope.refreshDetailList(item.uuid,item)})})};$scope.$watch("listFilterOption",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.preAddMenuAction=function(){$scope.selectedItem={workflowName:"",channel:"",channelUuid:"",workflowTemplate:"",workflowTemplateUuid:"",channelUuid:"",workFlowType:"",
detail:[]};$scope.selectedItemDetail=null;$scope.changeViewStatus($scope.UI_STATUS.EDIT_UI_STATUS_ADD,1)};$scope.deleteMenuAction=function(orderDetail){$scope.showConfirm("确认删除吗？","删除的产品不可恢复。",function(){if($scope.selectedItem)WorkflowService.delete($scope.selectedItem.uuid).success(function(){$scope.refreshList();$scope.changeViewStatus(Constant.UI_STATUS.PRE_EDIT_UI_STATUS,0)}).error(function(response){$scope.showError($scope.getError(response))})})};$scope.auditMenuAction=function(){if((!$scope.selected||
$scope.selected.length==0)&&$scope.selectedTabIndex==0){$scope.showError("请选择待审核销售单。");return}if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1)if($scope.selectedItem.confirm=="2"){$scope.showError("该单已经审核完成。");return}$scope.showConfirm("确认审核吗？","",function(){if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){$scope.selectedItem.confirm="2";console.log("123");console.log($scope.selectedItem);$scope.getMasterDataToBindFieldByUuid($scope.selectedItem.uuid);
WorkflowService.modify($scope.selectedItem.uuid,$scope.selectedItem).success(function(data){$scope.getMasterDataToBindFieldByUuid($scope.selectedItem.uuid);$scope.showInfo("审核成功。")}).error(function(data){$scope.showError(data.message)})}else if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){var promises=[];angular.forEach($scope.selected,function(item){item.confirm="2";var response=WorkflowService.modify(item.uuid,item).success(function(){});promises.push(response)});
$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("审核成功。");$scope.selectAllFlag=false},function(data){$scope.showError(data.data.message)})}})};$scope.revertAuditMenuAction=function(){if((!$scope.selected||$scope.selected.length==0)&&$scope.selectedTabIndex==0){$scope.showError("请选择待取消审核销售单。");return}if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){var threwNos="";angular.forEach($scope.selected,function(item){if(item.transferPsoFlag=="1")threwNos=
threwNos+item.no+","});if(threwNos!=""){threwNos=threwNos.substr(0,threwNos.length-1);$scope.showError("存在已抛转的销售单，不允许取消审核："+threwNos);return}}if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1)if($scope.selectedItem.confirm=="1"){$scope.showError("该单已是未审核。");return}$scope.showConfirm("确认取消审核吗？","",function(){if($scope.ui_status==Constant.UI_STATUS.PRE_EDIT_UI_STATUS&&$scope.selectedTabIndex==1){$scope.selectedItem.confirm="1";WorkflowService.modify($scope.selectedItem.uuid,
$scope.selectedItem).success(function(){$scope.selectedItem.confirm="1";$scope.showInfo("取消审核成功。")}).error(function(data){$scope.showError(data.message)})}else if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0){var promises=[];angular.forEach($scope.selected,function(item){item.confirm="1";var response=WorkflowService.modify(item.uuid,item).success(function(){});promises.push(response)});$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("取消审核成功。");
$scope.selectAllFlag=false},function(data){$scope.showError(data.data.message)})}})};$scope.cancelAddMenuAction=function(){$scope.listTabSelected()};$scope.addMenuAction=function(){console.log($scope.selectedItem);if($scope.ui_status==$scope.UI_STATUS.EDIT_UI_STATUS_ADD)WorkflowService.add($scope.selectedItem).success(function(data){$scope.refreshList();$scope.bindSelectItemData(data);$scope.changeViewStatus($scope.UI_STATUS.PRE_EDIT_UI_STATUS,1);$scope.showInfo("新增成功")}).error(function(data){$scope.showError($scope.getAllError(data));
$scope.showError(data.message)})};$scope.modifyMenuAction=function(){console.log($scope.selectedItem.uuid);WorkflowService.modify($scope.selectedItem.uuid,$scope.selectedItem).success(function(data){$scope.getMasterDataToBindFieldByUuid($scope.selectedItem.uuid);$scope.changeViewStatus(Constant.UI_STATUS.PRE_EDIT_UI_STATUS,1);$scope.showInfo("修改成功。")}).error(function(data){$scope.showError(data.message);$scope.cancelModifyMenuAction()})};$scope.cancelModifyMenuAction=function(){WorkflowService.get($scope.selectedItem.uuid).success(function(data){$scope.bindSelectItemData(data);
$scope.changeViewStatus(Constant.UI_STATUS.PRE_EDIT_UI_STATUS,1)})};$scope.exitModifyMenuAction=function(){$scope.cancelModifyMenuAction();$scope.changeViewStatus($scope.UI_STATUS.PRE_EDIT_UI_STATUS,1)};$scope.workflowDeleteMenuAction=function(subItemUuid){$scope.showConfirm("确认删除吗？","",function(){if($scope.selectedItem)WorkflowDetailService.delete($scope.selectedItem.uuid,subItemUuid.uuid).success(function(){$scope.refreshDetailList($scope.selectedItem.uuid,$scope.selectedItem);$scope.showInfo("删除成功。")}).error(function(response){$scope.showError($scope.getError(response))})})};
$scope.listTabSelected=function(){$scope.refreshList();$scope.selectedItem=null;$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS,0)};$scope.getMasterDataToBindFieldByUuid=function(uuid){WorkflowService.get(uuid).success(function(data){$scope.bindSelectItemData(data)})};$scope.editItem=function(item){$scope.bindSelectItemData(item);$scope.changeViewStatus(Constant.UI_STATUS.PRE_EDIT_UI_STATUS,1)};$scope.bindSelectItemData=function(item){$scope.selectedDetail=[];$scope.menuList.selectAll=false;
$scope.selectedItem=item;$scope.selectedItem.channel=item.channel["name"];$scope.selectedItem.channelUuid=item.channel["uuid"];$scope.selectedItem.workflowTemplate=item.workflowTemplate.workflowName;$scope.selectedItem.workflowTemplateUuid=item.workflowTemplate.uuid;$scope.refreshDetailList($scope.selectedItem.uuid,$scope.selectedItem)};$scope.refreshDetailList=function(masterUuid,master){WorkflowDetailService.get(masterUuid).success(function(data){angular.forEach(data.content,function(item){if(item.transferRole!=
""&&item.transferRole!=null)RoleService.get(item.transferRole).success(function(role){item.transferRoleName=role.name});if(item.transferSource=="1")FunctionService.get(item.transferData).success(function(tran){item.transferDataName=tran.name});else if(item.transferSource=="2")ChannelService.get(item.transferData).success(function(tran){item.transferDataName=tran.name});else if(item.transferSource=="3")CBIEmployeeService.get(item.transferData).success(function(tran){item.transferDataName=tran.name})});
master.detail=[];master.detail=data.content})};$scope.selectAllMenuAction=function(){if($scope.ui_status==Constant.UI_STATUS.VIEW_UI_STATUS&&$scope.selectedTabIndex==0)if($scope.menuList.selectAll==true){angular.forEach($scope.workflowMstList.content,function(item){var idx=$scope.selected.indexOf(item);if(idx<0)$scope.selected.push(item)});$scope.selectedItemsCount=$scope.selected.length}else if($scope.menuList.selectAll==false){$scope.selected=[];$scope.selectedItemsCount=0}};$scope.exists=function(item,
list){return list.indexOf(item)>-1};$scope.toggle=function(item,selected){var idx=selected.indexOf(item);if(idx>-1)selected.splice(idx,1);else selected.push(item);$scope.selectedItemsCount=selected.length};$scope.openDlg=function(table,desc,key){var source=[];source.key=key;source.desc=desc;if(table=="OCM_BASE_CHAN")source.srcUrl="channels";else if(table=="ASS_FLOW_TEMPLATE_MST")source.srcUrl="workflowTemplates";$mdDialog.show({controller:"ChannelSelectController",templateUrl:"app/src/app/ass/workflow/workflowSelectList.html",
parent:angular.element(document.body),targetEvent:event,locals:{source:source}}).then(function(data){$scope.selectedItem[key]=data.name;$scope.selectedItem[key+"Uuid"]=data.uuid;console.log("key :"+key+" $scope.selectedItem[key]"+$scope.selectedItem[key]+" $scope.selectedItem[key + 'Uuid'] :"+$scope.selectedItem[key+"Uuid"])})};$scope.openAddDetailDlg=function(selectDetailItem,addTransferSource){console.log("Transfer source;"+addTransferSource);var source={flwoNo:"",flowName:"",transferType:"",transferSource:addTransferSource,
transferData:"",transferDataName:"",transferRole:"",transferCondition:""};$scope.DETAIL_UI_STATUS=selectDetailItem==null?"add":"edit";if(selectDetailItem!=null){source=selectDetailItem;console.log(selectDetailItem)}$mdDialog.show({controller:"AddWorkflowDetailController",templateUrl:"app/src/app/ass/workflow/workflowDetailAddDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{source:source,status:$scope.DETAIL_UI_STATUS}}).then(function(data){console.log("Master Id :"+$scope.selectedItem.uuid);
console.log($scope.DETAIL_UI_STATUS);if($scope.DETAIL_UI_STATUS=="add"){console.log("Master Id :"+$scope.selectedItem.uuid);WorkflowDetailService.add($scope.selectedItem.uuid,data).success(function(){$scope.refreshDetailList($scope.selectedItem.uuid,$scope.selectedItem);$scope.showInfo("新增成功")}).error(function(data){$scope.showError(data.message)})}else if($scope.DETAIL_UI_STATUS=="edit")WorkflowDetailService.modify($scope.selectedItem.uuid,data.uuid,data).success(function(){$scope.refreshDetailList($scope.selectedItem.uuid,
$scope.selectedItem);$scope.showInfo("修改成功")}).error(function(data){$scope.showError(data.message)})})}});
angular.module("IOne-Production").controller("ChannelSelectController",function($scope,$http,$mdDialog,Constant,source){$scope.srcUrl=source.srcUrl;$scope.desc=source.desc;$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.refreshData=function(){var url=Constant.BACKEND_BASE+$scope.srcUrl+"?page\x3d"+$scope.pageOption.currentPage+"\x26size\x3d"+$scope.pageOption.sizePerPage;$http.get(url).success(function(data){if(data)if(data.content){$scope.dataList=data.content;
$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements;if($scope.srcUrl=="workflowTemplates")for(var i=0;i<$scope.dataList.length;i++)for(j=0;j<data.content.length;j++)if($scope.dataList[i].uuid==data.content[j].uuid)$scope.dataList[i].name=data.content[j].workflowName}else $scope.dataList=data})};$scope.refreshData();$scope.queryAction=function(){$scope.refreshData()};$scope.select=function(selectedObject){$scope.selectedObject=selectedObject;$mdDialog.hide($scope.selectedObject)};
$scope.hideDlg=function(){$mdDialog.hide()};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").controller("AddWorkflowDetailController",function($scope,$mdDialog,source,status,Constant,RoleService,CBIEmployeeService,ChannelService,GroupFunctionService){$scope.UI_STATUS=status;$scope.WORKFLOW_CHANNEL_FLAG=Constant.CHANNEL_FLAG;$scope.WORKFLOW_TRANSFER_TYPE=Constant.WORKFLOW_TRANSFER_TYPE;$scope.WORKFLOW_TRANSFER_SOURCE=Constant.WORKFLOW_TRANSFER_SOURCE;$scope.addWorflowDetail=source;$scope.chanPageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};
$scope.empPageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};RoleService.get("").success(function(data){$scope.roleList=data.content});$scope.isShowTranSrcPanel=false;$scope.openTranSrcDlg=function(){$scope.isShowTranSrcPanel=true;if($scope.addWorflowDetail.transferSource=="1")GroupFunctionService.getByStatus().success(function(dataList){$scope.groupFunctionDataList=dataList});else if($scope.addWorflowDetail.transferSource=="2")$scope.refreshChanList();else if($scope.addWorflowDetail.transferSource==
"3")$scope.refreshEmpList()};$scope.refreshChanList=function(){ChannelService.getAll($scope.chanPageOption.sizePerPage,$scope.chanPageOption.currentPage,0,1,"","").success(function(datalist){$scope.chanDataList=datalist.content})};$scope.refreshEmpList=function(){CBIEmployeeService.getAll($scope.empPageOption.sizePerPage,$scope.empPageOption.currentPage,0,0,0,"").success(function(datalist){$scope.empDataList=datalist.content})};$scope.selectSourceItem=function(item){if($scope.addWorflowDetail.transferSource==
"1"){$scope.addWorflowDetail.transferDataName=item.function.name;$scope.addWorflowDetail.transferData=item.function.uuid}else if($scope.addWorflowDetail.transferSource=="2"){$scope.addWorflowDetail.transferDataName=item.name;$scope.addWorflowDetail.transferData=item.uuid}else if($scope.addWorflowDetail.transferSource=="3"){$scope.addWorflowDetail.transferDataName=item.name;$scope.addWorflowDetail.transferData=item.uuid}$scope.hideTranSrcPanel()};$scope.hideTranSrcPanel=function(){$scope.isShowTranSrcPanel=
false};$scope.hideDlg=function(){$mdDialog.hide($scope.addWorflowDetail)};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").service("WorkflowService",function($http,Constant){this.getAll=function(sizePerPage,page,confirm,workflowName,resUuid){var url="/workflows?size\x3d"+sizePerPage+"\x26page\x3d"+page;if(confirm!==undefined&&confirm!=="0")url=url+"\x26confirm\x3d"+confirm;if(workflowName!==undefined&&workflowName!==null)url=url+"\x26workflowName\x3d"+workflowName;if(resUuid!==undefined&&resUuid!==null)url=url+"\x26resUuid\x3d"+resUuid;return $http.get(Constant.BACKEND_BASE+url)};this.get=
function(uuid){return $http.get(Constant.BACKEND_BASE+"/workflows/"+uuid)};this.delete=function(uuid){return $http.delete(Constant.BACKEND_BASE+"/workflows/"+uuid)};this.modify=function(uuid,UpdateInput){return $http.patch(Constant.BACKEND_BASE+"/workflows/"+uuid,UpdateInput)};this.add=function(AddInput){return $http.post(Constant.BACKEND_BASE+"/workflows/",AddInput)};this.getByCurrentUser=function(){return $http.get(Constant.BACKEND_BASE+"/workflows?currentUser\x3dY")}});
angular.module("IOne-Production").service("WorkflowDetailService",function($http,Constant){this.get=function(masterUuid){return $http.get(Constant.BACKEND_BASE+"/workflows/"+masterUuid+"/details?sort\x3dflwoNo")};this.add=function(masterUuid,AddInput){console.log("masterUuid["+masterUuid+"], url:"+Constant.BACKEND_BASE+"/workflows/"+masterUuid+"/details",AddInput);return $http.post(Constant.BACKEND_BASE+"/workflows/"+masterUuid+"/details",AddInput)};this.modify=function(masterUuid,detailUuid,updateInput){return $http.patch(Constant.BACKEND_BASE+
"/workflows/"+masterUuid+"/details/"+detailUuid,updateInput)};this.delete=function(masterUuid,detailUuid){console.log(Constant.BACKEND_BASE+"/workflows/"+masterUuid+"/details/"+detailUuid);return $http.delete(Constant.BACKEND_BASE+"/workflows/"+masterUuid+"/details/"+detailUuid)}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/ass/workflowTemplate",{controller:"WorkflowTemplateController",templateUrl:"app/src/app/ass/workflowTemplate/workflowTemplate.html"})}]);
angular.module("IOne-Production").controller("WorkflowTemplateController",function($q,$scope,WorkflowTemplateMaster,WorkflowTemplateDetail,Constant,RoleService,$mdDialog,GroupFunctionService,ChannelService,CBIEmployeeService){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.selectedItemSize=0;$scope.workingUIStatus=0;$scope.WORKFLOW_TYPES=Constant.WORKFLOW_TYPE;$scope.WORKFLOW_TRANSFER_TYPE=Constant.WORKFLOW_TRANSFER_TYPE;
$scope.WORKFLOW_TRANSFER_SOURCE=Constant.WORKFLOW_TRANSFER_SOURCE;$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.formMenuDisplayOption={"100-add":{display:true,name:"新增",uuid:"417B5F83-1DBF-433D-9FF7-2E599441395C"},"101-audit":{display:true,name:"审核",uuid:"745F718C-0D30-4592-BDB9-9CF87FEABC14"},"102-forbidden":{display:true,name:"禁用",uuid:"B8233C7A-DF65-4A0D-B266-7E2DFA7FFAAB"},"103-batchAudit":{display:true,name:"批量审核",uuid:"6958C223-5340-48CD-83FD-033E2533592E"},
"104-batchSelectedAudit":{display:true,name:"批量取审",uuid:"C842DB84-E176-437F-8172-2E7D15722E62"},"105-batchEnable":{display:true,name:"批量启用",uuid:"8B48FC69-3321-4DC6-9969-A253F5450088"},"106-batchForbidden":{display:true,name:"批量禁用",uuid:"EB22785C-3D52-4B84-A72C-5617E5FBDE37"},"107-batchDelete":{display:true,name:"批量删除",uuid:"362EA8AF-42BE-4C6C-822C-FB8BBF182737"},"108-edit":{display:true,name:"修改",uuid:"0E92D809-B5D4-4678-9106-B91BA592BB54"},"109-subAdd":{display:true,name:"点击新增",uuid:"9CBCA9F0-F0E0-45A7-A3A2-BF820AAC1831"},
"200-audit":{display:true,name:"审核",uuid:"A417128E-24C2-4B74-A82B-55DBBDC0E25B"},"201-enable":{display:true,name:"启用",uuid:"B7EA476B-6568-457E-BE6F-D5B6D7DD8AA1"},"202-forbidden":{display:true,name:"禁用",uuid:"FE7881B9-2BCF-44A9-B133-D918E3E2F892"},"203-delete":{display:true,name:"删除",uuid:"C3BC0AC1-475E-4A59-89FB-16857A529B91"},"204-cancelAudit":{display:true,name:"取消审核",uuid:"027A04EF-A9E7-425F-8B36-9B0E82AE4CAF"}};$scope.listFilterOption={status:Constant.STATUS[1].value,confirm:Constant.CONFIRM[1].value};
$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.refreshList=function(){WorkflowTemplateMaster.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=data.totalPages;$scope.pageOption.totalElements=data.totalElements});$scope.initGroupFunctionList();$scope.initChannelList();$scope.initEmployeeList();$scope.initRoleList()};$scope.$watch("listFilterOption",
function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()},true);$scope.initGroupFunctionList=function(){GroupFunctionService.getByStatus().success(function(dataList){$scope.groupFunctionDataList=dataList})};$scope.initChannelList=function(){ChannelService.getAll(1E8,0,0,1,"","").success(function(datalist){$scope.channelDataList=datalist.content})};$scope.initEmployeeList=function(){CBIEmployeeService.getAll(1E8,0,0,0,0,"").success(function(datalist){$scope.employeeDataList=
datalist.content})};$scope.initRoleList=function(){RoleService.get("").success(function(data){$scope.roleList=data.content})};$scope.setDetailsName=function(detailList){angular.forEach(detailList,function(detail){angular.forEach($scope.roleList,function(role){if(role.uuid==detail.transferRole)detail.transferRoleName=role.name});if(detail.transferSource==Constant.WORKFLOW_TRANSFER_SOURCE[1].value)angular.forEach($scope.groupFunctionDataList,function(groupFunc){if(groupFunc.uuid==detail.transferData)detail.transferDataName=
groupFunc.function.name});else if(detail.transferSource==Constant.WORKFLOW_TRANSFER_SOURCE[2].value)angular.forEach($scope.channelDataList,function(channel){if(channel.uuid==detail.transferData)detail.transferDataName=channel.name});else if(detail.transferSource==Constant.WORKFLOW_TRANSFER_SOURCE[3].value)angular.forEach($scope.employeeDataList,function(employee){if(employee.uuid==detail.transferData)detail.transferDataName=employee.name})})};$scope.selectAllFlag=false;$scope.showDetailPanelAction=
function(item){$scope.selectedItem=item;$scope.refreshDetails(item)};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;$scope.selectedItem=null};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel)$scope.refreshDetails(item)};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS)};
$scope.editItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);if(domain=="ASS_FLOW_TEMPLATE_MST"){$scope.workingUIStatus=0;$scope.editingItem=source}else{$scope.workingUIStatus=1;$scope.editingDetail=source}$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);if(domain=="ASS_FLOW_TEMPLATE_MST"){$scope.workingUIStatus=
0;$scope.editingItem=source}else{$scope.workingUIStatus=1;$scope.editingDetail=source}$scope.status="add";$scope.desc=desc;$scope.domain=domain};$scope.updateWorkingUIStatus=function(domain){if(domain=="ASS_FLOW_TEMPLATE_MST")$scope.workingUIStatus=0;else $scope.workingUIStatus=1};$scope.saveItemAction=function(){if($scope.status=="add")if($scope.domain=="ASS_FLOW_TEMPLATE_MST"){WorkflowTemplateMaster.add($scope.editingItem).success(function(data){$scope.showInfo("新增工作流模板单头成功");$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);
$scope.refreshList()}).error(function(response){$scope.showError("新增工作流模板单头失败: "+response.message)});$scope.refreshList()}else{if($scope.domain=="ASS_FLOW_TEMPLATE_DTL")WorkflowTemplateDetail.add($scope.selectedItem.uuid,$scope.editingDetail).success(function(data){$scope.showInfo("新增工作流模板单身成功");$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);$scope.refreshDetails($scope.selectedItem)}).error(function(response){$scope.showError("新增工作流模板单身成功: "+response.message)})}else if($scope.status==
"edit")if($scope.domain=="ASS_FLOW_TEMPLATE_MST")if($scope.editingItem.status==Constant.STATUS[1].value&&$scope.editingItem.confirm!=Constant.CONFIRM[2].value)WorkflowTemplateMaster.modify($scope.editingItem.uuid,$scope.editingItem).success(function(data){$scope.showInfo("修改工作流模板单成功。");$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS)}).error(function(response){$scope.showError("修改工作流模板单失败。"+response.message)});else $scope.showError($scope.source.no+" 不允许修改：有效且未审核的记录才可以修改！");else if($scope.domain==
"ASS_FLOW_TEMPLATE_DTL")WorkflowTemplateDetail.modify($scope.selectedItem.uuid,$scope.editingDetail.uuid,$scope.editingDetail).success(function(data){$scope.showInfo("修改工作流模板单身成功。");$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);$scope.setDetailsName(new Array($scope.editingDetail))}).error(function(response){$scope.showError("修改工作流模板单身失败。"+response.message)})};$scope.refreshDetails=function(item){WorkflowTemplateDetail.get(item.uuid).success(function(data){item.detailList=data.content;
$scope.setDetailsName(item.detailList)})};$scope.selectItemAction=function(event,item){$scope.stopEventPropagation(event);item.selectedRef=!item.selected;if(item.selected==false||item.selected==undefined||item.selected==null)$scope.selectedItemSize+=1;else{$scope.selectedItemSize-=1;$scope.selectAllFlag=false}$scope.disableBatchMenuButtons()};$scope.confirmClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("confirm...");$scope.stopEventPropagation(event);console.info("status...");
var msg="确认取消审核吗？";var input="1";var resultMsg="取消审核成功！";if(item.confirm!="2"){msg="确认审核吗？";input="2";resultMsg="审核成功！"}$scope.showConfirm(msg,"",function(){WorkflowTemplateMaster.modify(item.uuid,{"confirm":input}).success(function(){item.confirm=input;$scope.showInfo(resultMsg)}).error(function(response){$scope.showError(response.message)})})};$scope.statusClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("status...");var msg="确认禁用吗？";var input="2";var resultMsg="禁用成功！";
if(item.status!="1"){msg="确认启用吗？";input="1";resultMsg="启用成功！"}$scope.showConfirm(msg,"",function(){WorkflowTemplateMaster.modify(item.uuid,{"status":input}).success(function(){item.status=input;$scope.showInfo(resultMsg)}).error(function(response){$scope.showError(response.message)})})};$scope.releaseClickAction=function(event,item){$scope.stopEventPropagation(event);console.info("release...")};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);$scope.showConfirm("确认删除吗",
"",function(){if(item.status==Constant.STATUS[1].value&&item.confirm!=Constant.CONFIRM[2].value)var response=WorkflowTemplateMaster.delete(item.uuid).success(function(){$scope.selectedItem=null;$scope.refreshList()}).error(function(response){$scope.showError("删除失败："+response.message)});else $scope.showError("不允许删除：有效且未审核的记录才可以删除！")})};$scope.deleteDetailAction=function(item,detail){$scope.stopEventPropagation(event);$scope.showConfirm("确认删除吗","",function(){var response=WorkflowTemplateDetail.delete(item.uuid,
detail.uuid).success(function(){WorkflowTemplateDetail.get(item.uuid).success(function(data){item.detailList=data.content;$scope.setDetailsName(item.detailList);$scope.showInfo("删除成功！")}).error(function(response){$scope.showError("删除成功后刷新数据失败："+response.message)})}).error(function(response){$scope.showError("删除失败："+response.message)})})};$scope.confirmAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");return}$scope.showConfirm("确认审核吗",
"",function(){var promises=[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected){var response=WorkflowTemplateMaster.modify(item.uuid,{"confirm":"2"}).success(function(){item.confirm="2"}).error(function(response){bError=true;$scope.showError(item.no+" 审核失败："+response.message)});promises.push(response)}});$q.all(promises).then(function(data){if(!bError)$scope.showInfo("审核成功！");$scope.disableBatchMenuButtons()})})};$scope.cancelConfirmAllClickAction=function(event){$scope.stopEventPropagation(event);
if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");return}$scope.showConfirm("确认取消审核吗","",function(){var promises=[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected){var response=WorkflowTemplateMaster.modify(item.uuid,{"confirm":"1"}).success(function(){item.confirm="1"}).error(function(response){bError=true;$scope.showError(item.no+" 取消审核失败："+response.message)});promises.push(response)}});$q.all(promises).then(function(data){if(!bError){$scope.showInfo("取消审核成功！");
$scope.disableBatchMenuButtons()}})})};$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");return}$scope.showConfirm("确认启用吗","",function(){var promises=[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected){var response=WorkflowTemplateMaster.modify(item.uuid,{"status":"1"}).success(function(){item.status="1"}).error(function(response){bError=true;$scope.showError(item.no+" 启用失败："+response.message)});
promises.push(response)}});$q.all(promises).then(function(data){if(!bError){$scope.showInfo("启用成功！");$scope.disableBatchMenuButtons()}})})};$scope.cancelStatusAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");return}$scope.showConfirm("确认禁用吗","",function(){var promises=[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected){var response=WorkflowTemplateMaster.modify(item.uuid,{"status":"2"}).success(function(){item.status=
"2"}).error(function(response){bError=true;$scope.showError(item.no+" 禁用失败："+response.message)});promises.push(response)}});$q.all(promises).then(function(data){if(!bError){$scope.showInfo("禁用成功！");$scope.disableBatchMenuButtons()}})})};$scope.releaseAllClickAction=function(event){$scope.stopEventPropagation(event);console.info("release all...")};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);if($scope.selectedItemSize==0){$scope.showWarn("请先选择记录！");return}$scope.showConfirm("确认删除吗",
"",function(){var promises=[];var bError=false;angular.forEach($scope.itemList,function(item){if(item.selected)if(item.status==Constant.STATUS[1].value&&item.confirm!=Constant.CONFIRM[2].value){var response=WorkflowTemplateMaster.delete(item.uuid).success(function(){$scope.refreshList()}).error(function(response){bError=true;$scope.showError(item.workflowName+"删除失败："+response.message)});promises.push(response)}else{bError=true;$scope.showError(item.workflowName+" 不允许删除：有效且未审核的记录才可以删除！")}});$q.all(promises).then(function(data){if(!bError){$scope.showInfo("删除成功！");
$scope.disableBatchMenuButtons()}})})};$scope.selectAllAction=function(){angular.forEach($scope.itemList,function(item){if($scope.selectAllFlag)item.selected=true;else item.selected=false;item.selectedRef=item.selected});$scope.selectedItemSize=0;if($scope.selectAllFlag)angular.forEach($scope.itemList,function(item){$scope.selectedItemSize++});$scope.disableBatchMenuButtons()};$scope.disableBatchMenuButtons=function(){var selectedCount=0;var confirm="";var status="";var diffConfirm=false;var diffStatus=
false;angular.forEach($scope.itemList,function(item,index){if(item.selectedRef){selectedCount++;if(confirm=="")confirm=item.confirm;else if(confirm!=item.confirm)diffConfirm=true;if(status=="")status=item.status;else if(status!=item.status)diffStatus=true}});if(selectedCount==0){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true}else{if(diffConfirm==true){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=
true}else if(confirm=="2"){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=false}else{$scope.disabledBatchConfirm=false;$scope.disabledBatchCancelConfirm=true}if(diffStatus==true){$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true}else if(status=="1"){$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=false}else{$scope.disabledBatchStatus=false;$scope.disabledBatchCancelStatus=true}}};$scope.openTransferDataDlg=function(detail){$mdDialog.show({controller:"SelectTransferDataController",
templateUrl:"app/src/app/ass/workflowTemplate/selectTransferDataDlg.html",parent:angular.element(document.body),targetEvent:event,locals:{editingDetail:detail}}).then(function(editedDetail){detail=editedDetail})}});
angular.module("IOne-Production").controller("SelectTransferDataController",function($scope,$mdDialog,Constant,editingDetail,GroupFunctionService,ChannelService,CBIEmployeeService){$scope.WORKFLOW_CHANNEL_FLAG=Constant.CHANNEL_FLAG;$scope.WORKFLOW_TRANSFER_TYPE=Constant.WORKFLOW_TRANSFER_TYPE;$scope.WORKFLOW_TRANSFER_SOURCE=Constant.WORKFLOW_TRANSFER_SOURCE;$scope.workingDetail=editingDetail;$scope.channelPageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.employeePageOption=
{sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.refreshGroupList=function(){GroupFunctionService.getByStatus().success(function(dataList){$scope.groupFunctionDataList=dataList})};$scope.refreshChannelList=function(){ChannelService.getAll($scope.channelPageOption.sizePerPage,$scope.channelPageOption.currentPage,0,1,"","").success(function(datalist){$scope.channelDataList=datalist.content})};$scope.refreshEmployeeList=function(){CBIEmployeeService.getAll($scope.employeePageOption.sizePerPage,
$scope.employeePageOption.currentPage,0,0,0,"").success(function(datalist){$scope.employeeDataList=datalist.content})};if($scope.workingDetail.transferSource==Constant.WORKFLOW_TRANSFER_SOURCE[1].value)$scope.refreshGroupList();else if($scope.workingDetail.transferSource==Constant.WORKFLOW_TRANSFER_SOURCE[2].value)$scope.refreshChannelList();else if($scope.workingDetail.transferSource==Constant.WORKFLOW_TRANSFER_SOURCE[3].value)$scope.refreshEmployeeList();$scope.selectItem=function(item){if($scope.workingDetail.transferSource==
Constant.WORKFLOW_TRANSFER_SOURCE[1].value){$scope.workingDetail.transferDataName=item.function.name;$scope.workingDetail.transferData=item.uuid}else if($scope.workingDetail.transferSource==Constant.WORKFLOW_TRANSFER_SOURCE[2].value){$scope.workingDetail.transferDataName=item.name;$scope.workingDetail.transferData=item.uuid}else if($scope.workingDetail.transferSource==Constant.WORKFLOW_TRANSFER_SOURCE[3].value){$scope.workingDetail.transferDataName=item.name;$scope.workingDetail.transferData=item.uuid}$scope.hideDlg($scope.workingDetail)};
$scope.hideDlg=function(workingDetail){$mdDialog.hide(workingDetail)};$scope.cancelDlg=function(){$mdDialog.cancel()}});
angular.module("IOne-Production").service("WorkflowTemplateMaster",function($http,Constant){this.getAll=function(sizePerPage,page,filter){var confirm=filter.confirm==0?"":filter.confirm;var status=filter.status==0?"":filter.status;var transferFlag=filter.transferFlag==0?"":filter.transferFlag;var url="workflowTemplates?size\x3d"+sizePerPage+"\x26page\x3d"+page;if(confirm!=="")url=url+"\x26confirm\x3d"+confirm;if(status!=="")url=url+"\x26status\x3d"+status;if(filter.workflowName!==null&&filter.workflowName!==
undefined)url=url+"\x26workflowName\x3d"+filter.workflowName;console.info(Constant.BACKEND_BASE+url);return $http.get(Constant.BACKEND_BASE+url)};this.confirm=function(uuids){return $http.patch(Constant.BACKEND_BASE+"/workflowTemplates/"+uuids,{"action":"2","confirm":"2"})};this.modify=function(uuid,updateInput){return $http.patch(Constant.BACKEND_BASE+"/workflowTemplates/"+uuid,updateInput)};this.add=function(addInput){return $http.post(Constant.BACKEND_BASE+"/workflowTemplates",addInput)};this.delete=
function(uuid){return $http.delete(Constant.BACKEND_BASE+"/workflowTemplates/"+uuid)}});
angular.module("IOne-Production").service("WorkflowTemplateDetail",function($http,Constant){this.get=function(masterUuid){return $http.get(Constant.BACKEND_BASE+"/workflowTemplates/"+masterUuid+"/details")};this.modify=function(masterUuid,detailUuid,updateInput){return $http.patch(Constant.BACKEND_BASE+"/workflowTemplates/"+masterUuid+"/details/"+detailUuid,updateInput)};this.add=function(masterUuid,addInput){return $http.post(Constant.BACKEND_BASE+"/workflowTemplates/"+masterUuid+"/details",addInput)};
this.delete=function(masterUuid,detailUuid){return $http.delete(Constant.BACKEND_BASE+"/workflowTemplates/"+masterUuid+"/details/"+detailUuid)}});angular.module("IOne-Production").config(["$routeProvider",function($routeProvider){$routeProvider.when("/eps/wx_config",{controller:"EPSWxConfigController",templateUrl:"app/src/app/taobao_data/wx_config/wxConfig.html"})}]);
angular.module("IOne-Production").controller("EPSWxConfigController",function($scope,EPSWxConfigService,Constant,$mdDialog,$q){$scope.pageOption={sizePerPage:10,currentPage:0,totalPage:100,totalElements:100};$scope.listFilterOption={select:{status:Constant.STATUS[0].value,confirm:Constant.CONFIRM[0].value},no:"",name:"",keyWord:""};$scope.menuDisplayOption={"switchConfirm":{display:true,name:"审核/取消审核",uuid:"ca7d0b8c-eca0-462d-913f-22cc100b2546"},"switchStatus":{display:true,name:"启用/禁用",uuid:"65de5c53-9afa-494d-bee9-cf52afe5e266"},
"batchConfirm":{display:true,name:"批量审核",uuid:"b61ff89f-00d3-46d8-b78b-1fd3bcf3f656"},"batchRevertConfirm":{display:true,name:"批量取审",uuid:"f75a2fa9-9a7e-47c1-bafc-83e027a8c089"},"batchStatus":{display:true,name:"批量启用",uuid:"5c69e830-76db-4b9f-a141-fa68cec42add"},"batchRevertStatus":{display:true,name:"批量禁用",uuid:"9b228d25-eb70-4f56-8c52-595b449a6229"},"batchDelete":{display:true,name:"批量删除",uuid:"838fd0b6-896f-4596-a946-c77626b67c9b"},"detailConfirm":{display:true,name:"审核",uuid:"3f3fc4ad-1c9e-4556-bddc-d94c8328f935"},
"detailRevertConfirm":{display:true,name:"取审",uuid:"4c5ea21c-ea83-4887-b603-bca405d1d7d9"},"detailStatus":{display:true,name:"启用",uuid:"e63a438a-47a9-4794-990b-c7c254fa5d20"},"detailRevertStatus":{display:true,name:"禁用",uuid:"1a4f1c42-eae2-4c90-b056-aac30ee56aa0"},"detailDelete":{display:true,name:"删除",uuid:"a7a942c1-bfcb-4973-8378-46843a722c42"}};$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=
true;$scope.sortByField="no";$scope.sortByAction=function(field){$scope.sortByField=field;$scope.sortType=""};$scope.refreshList=function(){EPSWxConfigService.getAll($scope.pageOption.sizePerPage,$scope.pageOption.currentPage,$scope.listFilterOption.select.confirm,$scope.listFilterOption.select.status,$scope.listFilterOption.no,$scope.listFilterOption.name,$scope.listFilterOption.keyWord,$scope.RES_UUID_MAP.EPS.WX_CONFIG.RES_UUID).success(function(data){$scope.itemList=data.content;$scope.pageOption.totalPage=
data.totalPages;$scope.pageOption.totalElements=data.totalElements;$scope.selectAllFlag=false;$scope.selectedItemSize=0;angular.forEach($scope.itemList,function(item){if(item.newdate)item.newdate=moment(item.newdate).format("YYYY-MM-DD")})})};$scope.getMenuAuthData($scope.RES_UUID_MAP.EPS.WX_CONFIG.RES_UUID).success(function(data){$scope.menuAuthDataMap=$scope.menuDataMap(data)});$scope.$watch("listFilterOption.select",function(){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=
0;$scope.refreshList()},true);$scope.queryEnter=function(e){if(e.keyCode===13){$scope.pageOption.currentPage=0;$scope.pageOption.totalPage=0;$scope.pageOption.totalElements=0;$scope.refreshList()}};$scope.selectAllFlag=false;$scope.selectedItemSize=0;$scope.showDetailPanelAction=function(item){$scope.selectedItem=item;item.detailList=$scope.subItemList;$scope.displayAdvancedSearPanel=false};$scope.showAdvancedSearchAction=function(){$scope.displayAdvancedSearPanel=!$scope.displayAdvancedSearPanel;
$scope.selectedItem=null};$scope.toggleMorePanelAction=function(item){item.showMorePanel=!item.showMorePanel;if(item.showMorePanel)item.detailList=item};$scope.toggleDetailMorePanelAction=function(detail){detail.showMorePanel=!detail.showMorePanel};$scope.listItemAction=function(){$scope.changeViewStatus(Constant.UI_STATUS.VIEW_UI_STATUS);$scope.refreshList()};$scope.hideItemDetailsAction=function(event){$scope.stopEventPropagation(event);$scope.selectedItem=null;$scope.refreshList()};$scope.editItemAction=
function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="edit";$scope.desc=desc;$scope.source=source;$scope.domain=domain;$scope.selectedItemBackUp=angular.copy($scope.selectedItem)};$scope.preAddItemAction=function(source,domain,desc){$scope.changeViewStatus(Constant.UI_STATUS.EDIT_UI_STATUS);$scope.status="add";$scope.desc=desc;$scope.source=source;$scope.domain=domain};$scope.saveItemAction=function(){if($scope.source.confirm=="2"&&$scope.source.status==
"2"){$scope.showError("不允许状态是已审核又无效,请调整后再保存");return}if($scope.status=="add"){if($scope.domain=="EPS_WX_CONFIG")EPSWxConfigService.add($scope.source).success(function(data){$scope.showInfo("新增数据成功。")}).error(function(data){$scope.showError("新增失败:"+"\x3cbr\x3e"+data.message)})}else if($scope.status=="edit")if($scope.domain=="EPS_WX_CONFIG")EPSWxConfigService.modify($scope.source.uuid,$scope.source).success(function(data){$scope.source=data;$scope.selectedItem=data;$scope.selectedItemBackUp=angular.copy($scope.selectedItem);
$scope.showInfo("修改数据成功。")}).error(function(data){$scope.showError("修改失败:"+"\x3cbr\x3e"+data.message);$scope.source=angular.copy($scope.selectedItemBackUp);$scope.selectedItem=angular.copy($scope.selectedItemBackUp)})};$scope.deleteDetailAction=function(detail){};$scope.selectItemAction=function(event,item){$scope.stopEventPropagation(event);item.selectedRef=!item.selected;if(item.selected==false||item.selected==undefined||item.selected==null)$scope.selectedItemSize+=1;else{$scope.selectedItemSize-=
1;$scope.selectAllFlag=false}$scope.disableBatchMenuButtons()};$scope.confirmClickAction=function(event,item){$scope.stopEventPropagation(event);if(item.confirm==Constant.CONFIRM[2].value)$scope.showConfirm("确认取消审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};EPSWxConfigService.modify(item.uuid,UpdateInput).success(function(){item.confirm=Constant.CONFIRM[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("取消审核成功！")}).error(function(response){$scope.showError(response.message)})});
else $scope.showConfirm("确认审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};EPSWxConfigService.modify(item.uuid,UpdateInput).success(function(){item.confirm=Constant.CONFIRM[2].value;$scope.disableBatchMenuButtons();$scope.showInfo("审核成功！")}).error(function(response){$scope.showError(response.message)})})};$scope.confirmSwitchAction=function(event,item){$scope.stopEventPropagation(event);if(item.confirm==Constant.CONFIRM[2].value)$scope.showConfirm("确认取消审核吗？",
"",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[1].value};EPSWxConfigService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("修改数据成功。")})},function(){item.confirm=Constant.CONFIRM[2].value});else{if(item.status==Constant.STATUS[2].value){$scope.showWarn("项目是失效状态,请先启用后再审核");item.confirm=Constant.CONFIRM[2].value;return}$scope.showConfirm("确认审核吗？","",function(){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};
EPSWxConfigService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("修改数据成功。")})},function(){item.confirm=Constant.CONFIRM[1].value})}};$scope.statusClickAction=function(event,item){$scope.stopEventPropagation(event);if(item.status==Constant.STATUS[1].value)$scope.showConfirm("确认改为失效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[2].value,confirm:Constant.CONFIRM[1].value};EPSWxConfigService.modify(item.uuid,UpdateInput).success(function(){item.status=
Constant.STATUS[2].value;item.confirm=Constant.CONFIRM[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("修改为失效成功！")}).error(function(response){$scope.showError(response.message)})});else $scope.showConfirm("确认改为生效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};EPSWxConfigService.modify(item.uuid,UpdateInput).success(function(){item.status=Constant.STATUS[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("修改为生效成功！")}).error(function(response){$scope.showError(response.message)})})};
$scope.statusSwitchAction=function(event,item){$scope.stopEventPropagation(event);if(item.status==Constant.STATUS[2].value)$scope.showConfirm("确认修改启用状态为有效吗？","",function(){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};EPSWxConfigService.modify(UpdateInput.uuid,UpdateInput).success(function(){$scope.disableBatchMenuButtons();$scope.showInfo("修改数据成功。")})},function(){item.status=Constant.STATUS[2].value});else $scope.showConfirm("确认修改启用状态为无效吗？","",function(){var UpdateInput={uuid:item.uuid,
status:Constant.STATUS[2].value,confirm:Constant.CONFIRM[1].value};EPSWxConfigService.modify(UpdateInput.uuid,UpdateInput).success(function(){item.confirm=Constant.CONFIRM[1].value;$scope.disableBatchMenuButtons();$scope.showInfo("修改数据成功。")})},function(){item.status=Constant.STATUS[1].value})};$scope.deleteClickAction=function(event,item){$scope.stopEventPropagation(event);if(item.status!="1"||item.confirm!="1"){$scope.showWarn("仅当微信公众号配置的状态是有效且未审核时才允许删除!");return}$scope.showConfirm("确认删除吗？","删除后不可恢复。",
function(){EPSWxConfigService.delete(item.uuid).success(function(){$scope.selectedItem=null;$scope.refreshList();$scope.showInfo("删除数据成功。")})})};$scope.deleteAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var noDeleteNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.status=="1"&&item.confirm=="1"){var response=EPSWxConfigService.delete(item.uuid).success(function(){});promises.push(response);count++}else noDeleteNos=
noDeleteNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任何状态是有效且未审核的可删除项目，请选择！");return}$scope.showConfirm("确认删除吗？","删除后不可恢复。",function(){if(noDeleteNos!=="")$scope.showWarn("以下状态是失效或已审核的的项目将不会删除："+"\x3cbr\x3e"+noDeleteNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("删除成功！")},function(data){$scope.showError(data.message);$scope.showError(data.data.message)})})};$scope.confirmAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=
[];var confirmedNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.confirm!=Constant.CONFIRM[2].value){var UpdateInput={uuid:item.uuid,confirm:Constant.CONFIRM[2].value};var response=EPSWxConfigService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else confirmedNos=confirmedNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任何未审核的项目，请先选择！");return}if(confirmedNos!=="")$scope.showWarn("以下已审核过的项目将不再次审核："+
"\x3cbr\x3e"+confirmedNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.disableBatchMenuButtons();$scope.showInfo("审核成功！")},function(data){$scope.showError(data.message);$scope.showError(data.data.message)})};$scope.revertConfirmAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var unConfirmedNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.confirm==Constant.CONFIRM[2].value){var UpdateInput={uuid:item.uuid,
confirm:Constant.CONFIRM[1].value};var response=EPSWxConfigService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else unConfirmedNos=unConfirmedNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任已审核的项目，请先选择！");return}if(unConfirmedNos!=="")$scope.showWarn("以下未审核过的项目将不执行取消审核："+unConfirmedNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("取消审核成功！")},function(data){$scope.showError(data.data.message);$scope.showError(data.message)})};
$scope.statusAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var effectiveNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.status!=Constant.STATUS[1].value){var UpdateInput={uuid:item.uuid,status:Constant.STATUS[1].value};var response=EPSWxConfigService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else effectiveNos=effectiveNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择任何失效的项目，请先选择！");
return}if(effectiveNos!=="")$scope.showWarn("以下已生效的项目将不再次修改："+"\x3cbr\x3e"+effectiveNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("生效成功！")},function(data){$scope.showError(data.message);$scope.showError(data.data.message)})};$scope.revertStatusAllClickAction=function(event){$scope.stopEventPropagation(event);var promises=[];var uneffectiveNos="";var count=0;angular.forEach($scope.itemList,function(item){if(item.selected===true)if(item.status==Constant.STATUS[1].value){var UpdateInput=
{uuid:item.uuid,status:Constant.STATUS[2].value};var response=EPSWxConfigService.modify(item.uuid,UpdateInput).success(function(){});promises.push(response);count++}else uneffectiveNos=uneffectiveNos+item.no+"\x3cbr\x3e"});if(count==0){$scope.showWarn("没有选择生效的项目，请先选择！");return}if(uneffectiveNos!=="")$scope.showWarn("以下失效的项目将不再次修改："+uneffectiveNos);$q.all(promises).then(function(data){$scope.refreshList();$scope.showInfo("失效成功！")},function(data){$scope.showError(data.data.message);$scope.showError(data.message)})};
$scope.selectAllAction=function(){angular.forEach($scope.itemList,function(item){if($scope.selectAllFlag)item.selected=true;else item.selected=false;item.selectedRef=item.selected});$scope.selectedItemSize=0;$scope.selectedItemAmount=0;if($scope.selectAllFlag)angular.forEach($scope.itemList,function(){$scope.selectedItemSize++});$scope.disableBatchMenuButtons()};$scope.disableBatchMenuButtons=function(){var selectedCount=0;var confirm="";var status="";var diffConfirm=false;var diffStatus=false;angular.forEach($scope.itemList,
function(item,index){if(item.selectedRef){selectedCount++;if(confirm=="")confirm=item.confirm;else if(confirm!=item.confirm)diffConfirm=true;if(status=="")status=item.status;else if(status!=item.status)diffStatus=true}});if(selectedCount==0){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}else{if(diffConfirm==true){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=
true;$scope.disabledBatchDelete=true}else if(confirm=="2"){$scope.disabledBatchConfirm=true;$scope.disabledBatchCancelConfirm=false;$scope.disabledBatchDelete=true}else{$scope.disabledBatchConfirm=false;$scope.disabledBatchCancelConfirm=true;$scope.disabledBatchDelete=false}if(diffStatus==true){$scope.disabledBatchConfirm=true;$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}else if(status=="1"){$scope.disabledBatchStatus=true;$scope.disabledBatchCancelStatus=
false}else{$scope.disabledBatchConfirm=true;$scope.disabledBatchStatus=false;$scope.disabledBatchCancelStatus=true;$scope.disabledBatchDelete=true}}}});